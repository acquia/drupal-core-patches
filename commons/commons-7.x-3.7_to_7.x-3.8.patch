diff --git a/CHANGELOG.txt b/CHANGELOG.txt
index 00d4d71..9f1bcf1 100644
--- a/CHANGELOG.txt
+++ b/CHANGELOG.txt
@@ -1,4 +1,8 @@
 
+Drupal 7.26, 2014-01-15
+----------------------
+- Fixed security issues (multiple vulnerabilities). See SA-CORE-2014-001.
+
 Drupal 7.25, 2014-01-02
 -----------------------
 - Fixed a bug in node_save() which prevented the saved node from being updated
diff --git a/includes/bootstrap.inc b/includes/bootstrap.inc
index f6ffea5..e5de2d1 100644
--- a/includes/bootstrap.inc
+++ b/includes/bootstrap.inc
@@ -8,7 +8,7 @@
 /**
  * The current system version.
  */
-define('VERSION', '7.25');
+define('VERSION', '7.26');
 
 /**
  * Core API compatibility.
diff --git a/includes/form.inc b/includes/form.inc
index fcfc796..4e467ba 100644
--- a/includes/form.inc
+++ b/includes/form.inc
@@ -235,6 +235,12 @@ function drupal_get_form($form_id) {
  *     likely to occur during Ajax operations.
  *   - programmed: If TRUE, the form was submitted programmatically, usually
  *     invoked via drupal_form_submit(). Defaults to FALSE.
+ *   - programmed_bypass_access_check: If TRUE, programmatic form submissions
+ *     are processed without taking #access into account. Set this to FALSE
+ *     when submitting a form programmatically with values that may have been
+ *     input by the user executing the current request; this will cause #access
+ *     to be respected as it would on a normal form submission. Defaults to
+ *     TRUE.
  *   - process_input: Boolean flag. TRUE signifies correct form submission.
  *     This is always TRUE for programmed forms coming from drupal_form_submit()
  *     (see 'programmed' key), or if the form_id coming from the $_POST data is
@@ -402,6 +408,7 @@ function form_state_defaults() {
     'submitted' => FALSE,
     'executed' => FALSE,
     'programmed' => FALSE,
+    'programmed_bypass_access_check' => TRUE,
     'cache'=> FALSE,
     'method' => 'post',
     'groups' => array(),
@@ -1985,7 +1992,7 @@ function _form_builder_handle_input_element($form_id, &$element, &$form_state) {
   // #access=FALSE on an element usually allow access for some users, so forms
   // submitted with drupal_form_submit() may bypass access restriction and be
   // treated as high-privilege users instead.
-  $process_input = empty($element['#disabled']) && ($form_state['programmed'] || ($form_state['process_input'] && (!isset($element['#access']) || $element['#access'])));
+  $process_input = empty($element['#disabled']) && (($form_state['programmed'] && $form_state['programmed_bypass_access_check']) || ($form_state['process_input'] && (!isset($element['#access']) || $element['#access'])));
 
   // Set the element's #value property.
   if (!isset($element['#value']) && !array_key_exists('#value', $element)) {
diff --git a/modules/aggregator/aggregator.info b/modules/aggregator/aggregator.info
index 2d6df06..17fb2e5 100644
--- a/modules/aggregator/aggregator.info
+++ b/modules/aggregator/aggregator.info
@@ -7,8 +7,8 @@ files[] = aggregator.test
 configure = admin/config/services/aggregator/settings
 stylesheets[all][] = aggregator.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/aggregator/tests/aggregator_test.info b/modules/aggregator/tests/aggregator_test.info
index 79b0aa3..a122ba2 100644
--- a/modules/aggregator/tests/aggregator_test.info
+++ b/modules/aggregator/tests/aggregator_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/block/block.info b/modules/block/block.info
index da40dd4..fd0fce0 100644
--- a/modules/block/block.info
+++ b/modules/block/block.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = block.test
 configure = admin/structure/block
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/block/tests/block_test.info b/modules/block/tests/block_test.info
index db47437..846e067 100644
--- a/modules/block/tests/block_test.info
+++ b/modules/block/tests/block_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/block/tests/themes/block_test_theme/block_test_theme.info b/modules/block/tests/themes/block_test_theme/block_test_theme.info
index eff2b50..3da86d0 100644
--- a/modules/block/tests/themes/block_test_theme/block_test_theme.info
+++ b/modules/block/tests/themes/block_test_theme/block_test_theme.info
@@ -13,8 +13,8 @@ regions[footer] = Footer
 regions[highlighted] = Highlighted
 regions[help] = Help
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/blog/blog.info b/modules/blog/blog.info
index 01bfa8f..fbef8c1 100644
--- a/modules/blog/blog.info
+++ b/modules/blog/blog.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = blog.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/book/book.info b/modules/book/book.info
index f003670..1c2d509 100644
--- a/modules/book/book.info
+++ b/modules/book/book.info
@@ -7,8 +7,8 @@ files[] = book.test
 configure = admin/content/book/settings
 stylesheets[all][] = book.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/color/color.info b/modules/color/color.info
index c14b600..ee776c2 100644
--- a/modules/color/color.info
+++ b/modules/color/color.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = color.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/comment/comment.info b/modules/comment/comment.info
index c2723b6..ed7fdc7 100644
--- a/modules/comment/comment.info
+++ b/modules/comment/comment.info
@@ -9,8 +9,8 @@ files[] = comment.test
 configure = admin/content/comment
 stylesheets[all][] = comment.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/contact/contact.info b/modules/contact/contact.info
index f71ce36..3ac50b6 100644
--- a/modules/contact/contact.info
+++ b/modules/contact/contact.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = contact.test
 configure = admin/structure/contact
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/contextual/contextual.info b/modules/contextual/contextual.info
index 0bfad8c..d7ea011 100644
--- a/modules/contextual/contextual.info
+++ b/modules/contextual/contextual.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = contextual.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/dashboard/dashboard.info b/modules/dashboard/dashboard.info
index e43262d..cfae6df 100644
--- a/modules/dashboard/dashboard.info
+++ b/modules/dashboard/dashboard.info
@@ -7,8 +7,8 @@ files[] = dashboard.test
 dependencies[] = block
 configure = admin/dashboard/customize
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/dblog/dblog.info b/modules/dblog/dblog.info
index e426ff3..b95957c 100644
--- a/modules/dblog/dblog.info
+++ b/modules/dblog/dblog.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = dblog.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field/field.info b/modules/field/field.info
index 3f6da3e..8b6db5e 100644
--- a/modules/field/field.info
+++ b/modules/field/field.info
@@ -11,8 +11,8 @@ dependencies[] = field_sql_storage
 required = TRUE
 stylesheets[all][] = theme/field.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field/modules/field_sql_storage/field_sql_storage.info b/modules/field/modules/field_sql_storage/field_sql_storage.info
index e5bef5f..a5a8eaf 100644
--- a/modules/field/modules/field_sql_storage/field_sql_storage.info
+++ b/modules/field/modules/field_sql_storage/field_sql_storage.info
@@ -7,8 +7,8 @@ dependencies[] = field
 files[] = field_sql_storage.test
 required = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field/modules/list/list.info b/modules/field/modules/list/list.info
index a613d3e..2aef100 100644
--- a/modules/field/modules/list/list.info
+++ b/modules/field/modules/list/list.info
@@ -7,8 +7,8 @@ dependencies[] = field
 dependencies[] = options
 files[] = tests/list.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field/modules/list/tests/list_test.info b/modules/field/modules/list/tests/list_test.info
index 92f4bd0..1861cdc 100644
--- a/modules/field/modules/list/tests/list_test.info
+++ b/modules/field/modules/list/tests/list_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field/modules/number/number.info b/modules/field/modules/number/number.info
index a2b6c97..df198b8 100644
--- a/modules/field/modules/number/number.info
+++ b/modules/field/modules/number/number.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = number.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field/modules/options/options.info b/modules/field/modules/options/options.info
index 3556ec8..571afbd 100644
--- a/modules/field/modules/options/options.info
+++ b/modules/field/modules/options/options.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = options.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field/modules/text/text.info b/modules/field/modules/text/text.info
index 774bd4b..4dd9b00 100644
--- a/modules/field/modules/text/text.info
+++ b/modules/field/modules/text/text.info
@@ -7,8 +7,8 @@ dependencies[] = field
 files[] = text.test
 required = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field/tests/field_test.info b/modules/field/tests/field_test.info
index 68e0cf4..ce4db19 100644
--- a/modules/field/tests/field_test.info
+++ b/modules/field/tests/field_test.info
@@ -6,8 +6,8 @@ files[] = field_test.entity.inc
 version = VERSION
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/field_ui/field_ui.info b/modules/field_ui/field_ui.info
index 7ed26b1..e9dc3c7 100644
--- a/modules/field_ui/field_ui.info
+++ b/modules/field_ui/field_ui.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = field_ui.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/file/file.info b/modules/file/file.info
index 4b364a7..b96e435 100644
--- a/modules/file/file.info
+++ b/modules/file/file.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = field
 files[] = tests/file.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/file/tests/file_module_test.info b/modules/file/tests/file_module_test.info
index 1194c77..4f94acf 100644
--- a/modules/file/tests/file_module_test.info
+++ b/modules/file/tests/file_module_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/filter/filter.info b/modules/filter/filter.info
index 759d926..5c25bbf 100644
--- a/modules/filter/filter.info
+++ b/modules/filter/filter.info
@@ -7,8 +7,8 @@ files[] = filter.test
 required = TRUE
 configure = admin/config/content/formats
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/forum/forum.info b/modules/forum/forum.info
index 25f4f34..610bd7b 100644
--- a/modules/forum/forum.info
+++ b/modules/forum/forum.info
@@ -9,8 +9,8 @@ files[] = forum.test
 configure = admin/structure/forum
 stylesheets[all][] = forum.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/help/help.info b/modules/help/help.info
index 2743a4f..3fac877 100644
--- a/modules/help/help.info
+++ b/modules/help/help.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = help.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/image/image.info b/modules/image/image.info
index 003b93d..a601da7 100644
--- a/modules/image/image.info
+++ b/modules/image/image.info
@@ -7,8 +7,8 @@ dependencies[] = file
 files[] = image.test
 configure = admin/config/media/image-styles
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/image/tests/image_module_test.info b/modules/image/tests/image_module_test.info
index 4afbc58..7bb35f5 100644
--- a/modules/image/tests/image_module_test.info
+++ b/modules/image/tests/image_module_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = image_module_test.module
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/locale/locale.info b/modules/locale/locale.info
index a3ddef4..3a260e2 100644
--- a/modules/locale/locale.info
+++ b/modules/locale/locale.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = locale.test
 configure = admin/config/regional/language
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/locale/tests/locale_test.info b/modules/locale/tests/locale_test.info
index f5a7f2b..7506100 100644
--- a/modules/locale/tests/locale_test.info
+++ b/modules/locale/tests/locale_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/menu/menu.info b/modules/menu/menu.info
index b5b4d2d..f08d9bd 100644
--- a/modules/menu/menu.info
+++ b/modules/menu/menu.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = menu.test
 configure = admin/structure/menu
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/node/node.info b/modules/node/node.info
index 24f8ae9..f3a977d 100644
--- a/modules/node/node.info
+++ b/modules/node/node.info
@@ -9,8 +9,8 @@ required = TRUE
 configure = admin/structure/types
 stylesheets[all][] = node.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/node/tests/node_access_test.info b/modules/node/tests/node_access_test.info
index 73698e5..d17db64 100644
--- a/modules/node/tests/node_access_test.info
+++ b/modules/node/tests/node_access_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/node/tests/node_test.info b/modules/node/tests/node_test.info
index a5db7ea..240a2b7 100644
--- a/modules/node/tests/node_test.info
+++ b/modules/node/tests/node_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/node/tests/node_test_exception.info b/modules/node/tests/node_test_exception.info
index 00f9a9a..b5a0dcd 100644
--- a/modules/node/tests/node_test_exception.info
+++ b/modules/node/tests/node_test_exception.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/openid/openid.info b/modules/openid/openid.info
index 172f0f7..b0ed8c0 100644
--- a/modules/openid/openid.info
+++ b/modules/openid/openid.info
@@ -5,8 +5,8 @@ package = Core
 core = 7.x
 files[] = openid.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/openid/openid.install b/modules/openid/openid.install
index 4b77b71..e382d86 100644
--- a/modules/openid/openid.install
+++ b/modules/openid/openid.install
@@ -15,13 +15,14 @@ function openid_schema() {
       'idp_endpoint_uri' => array(
         'type' => 'varchar',
         'length' => 255,
-        'description' => 'URI of the OpenID Provider endpoint.',
+        'not null' => TRUE,
+        'description' => 'Primary Key: URI of the OpenID Provider endpoint.',
       ),
       'assoc_handle' => array(
         'type' => 'varchar',
         'length' => 255,
         'not null' => TRUE,
-        'description' => 'Primary Key: Used to refer to this association in subsequent messages.',
+        'description' => 'Used to refer to this association in subsequent messages.',
       ),
       'assoc_type' => array(
         'type' => 'varchar',
@@ -51,7 +52,10 @@ function openid_schema() {
         'description' => 'The lifetime, in seconds, of this association.',
       ),
     ),
-    'primary key' => array('assoc_handle'),
+    'primary key' => array('idp_endpoint_uri'),
+    'unique keys' => array(
+      'assoc_handle' => array('assoc_handle'),
+    ),
   );
 
   $schema['openid_nonce'] = array(
@@ -158,3 +162,69 @@ function openid_update_6000() {
 /**
  * @} End of "addtogroup updates-6.x-to-7.x".
  */
+
+/**
+ * @addtogroup updates-7.x-extra
+ * @{
+ */
+
+/**
+ * Bind associations to their providers.
+ */
+function openid_update_7000() {
+  db_drop_table('openid_association');
+
+  $schema = array(
+    'description' => 'Stores temporary shared key association information for OpenID authentication.',
+    'fields' => array(
+      'idp_endpoint_uri' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'description' => 'Primary Key: URI of the OpenID Provider endpoint.',
+      ),
+      'assoc_handle' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'description' => 'Used to refer to this association in subsequent messages.',
+      ),
+      'assoc_type' => array(
+        'type' => 'varchar',
+        'length' => 32,
+        'description' => 'The signature algorithm used: one of HMAC-SHA1 or HMAC-SHA256.',
+      ),
+      'session_type' => array(
+        'type' => 'varchar',
+        'length' => 32,
+        'description' => 'Valid association session types: "no-encryption", "DH-SHA1", and "DH-SHA256".',
+      ),
+      'mac_key' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'description' => 'The MAC key (shared secret) for this association.',
+      ),
+      'created' => array(
+        'type' => 'int',
+        'not null' => TRUE,
+        'default' => 0,
+        'description' => 'UNIX timestamp for when the association was created.',
+      ),
+      'expires_in' => array(
+        'type' => 'int',
+        'not null' => TRUE,
+        'default' => 0,
+        'description' => 'The lifetime, in seconds, of this association.',
+      ),
+    ),
+    'primary key' => array('idp_endpoint_uri'),
+    'unique keys' => array(
+      'assoc_handle' => array('assoc_handle'),
+    ),
+  );
+  db_create_table('openid_association', $schema);
+}
+
+/**
+ * @} End of "addtogroup updates-7.x-extra".
+ */
diff --git a/modules/openid/openid.module b/modules/openid/openid.module
index 1f764e0..a28f452 100644
--- a/modules/openid/openid.module
+++ b/modules/openid/openid.module
@@ -839,7 +839,7 @@ function openid_verify_assertion($service, $response) {
   // direct verification: ignore the openid.assoc_handle, even if present.
   // See http://openid.net/specs/openid-authentication-2_0.html#rfc.section.11.4.1
   if (!empty($response['openid.assoc_handle']) && empty($response['openid.invalidate_handle'])) {
-    $association = db_query("SELECT * FROM {openid_association} WHERE assoc_handle = :assoc_handle", array(':assoc_handle' => $response['openid.assoc_handle']))->fetchObject();
+    $association = db_query("SELECT * FROM {openid_association} WHERE idp_endpoint_uri = :endpoint AND assoc_handle = :assoc_handle", array(':endpoint' => $service['uri'], ':assoc_handle' => $response['openid.assoc_handle']))->fetchObject();
   }
 
   if ($association && isset($association->session_type)) {
@@ -871,6 +871,7 @@ function openid_verify_assertion($service, $response) {
           // database to avoid reusing it again on a subsequent authentication request.
           // See http://openid.net/specs/openid-authentication-2_0.html#rfc.section.11.4.2.2
           db_delete('openid_association')
+            ->condition('idp_endpoint_uri', $service['uri'])
             ->condition('assoc_handle', $response['invalidate_handle'])
             ->execute();
         }
diff --git a/modules/openid/tests/openid_test.info b/modules/openid/tests/openid_test.info
index 9951cd3..f00e97a 100644
--- a/modules/openid/tests/openid_test.info
+++ b/modules/openid/tests/openid_test.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = openid
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/overlay/overlay.info b/modules/overlay/overlay.info
index 1f2ad9b..4646a30 100644
--- a/modules/overlay/overlay.info
+++ b/modules/overlay/overlay.info
@@ -4,8 +4,8 @@ package = Core
 version = VERSION
 core = 7.x
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/path/path.info b/modules/path/path.info
index d4392ed..6ba5114 100644
--- a/modules/path/path.info
+++ b/modules/path/path.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = path.test
 configure = admin/config/search/path
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/php/php.info b/modules/php/php.info
index 1cb7000..c7d78e3 100644
--- a/modules/php/php.info
+++ b/modules/php/php.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = php.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/poll/poll.info b/modules/poll/poll.info
index 9144dc0..312b4fb 100644
--- a/modules/poll/poll.info
+++ b/modules/poll/poll.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = poll.test
 stylesheets[all][] = poll.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/profile/profile.info b/modules/profile/profile.info
index d8dccd1..ae0f6e2 100644
--- a/modules/profile/profile.info
+++ b/modules/profile/profile.info
@@ -11,8 +11,8 @@ configure = admin/config/people/profile
 ; See user_system_info_alter().
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/rdf/rdf.info b/modules/rdf/rdf.info
index 1c8651b..ef16a42 100644
--- a/modules/rdf/rdf.info
+++ b/modules/rdf/rdf.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 files[] = rdf.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/rdf/tests/rdf_test.info b/modules/rdf/tests/rdf_test.info
index e3bc49d..e0fa92d 100644
--- a/modules/rdf/tests/rdf_test.info
+++ b/modules/rdf/tests/rdf_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/search/search.info b/modules/search/search.info
index eff404f..3c0495d 100644
--- a/modules/search/search.info
+++ b/modules/search/search.info
@@ -8,8 +8,8 @@ files[] = search.test
 configure = admin/config/search/settings
 stylesheets[all][] = search.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/search/tests/search_embedded_form.info b/modules/search/tests/search_embedded_form.info
index 7925f7e..6413e94 100644
--- a/modules/search/tests/search_embedded_form.info
+++ b/modules/search/tests/search_embedded_form.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/search/tests/search_extra_type.info b/modules/search/tests/search_extra_type.info
index 5b4fcb5..d4296c8 100644
--- a/modules/search/tests/search_extra_type.info
+++ b/modules/search/tests/search_extra_type.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/shortcut/shortcut.info b/modules/shortcut/shortcut.info
index 35a43ba..4b8f7b5 100644
--- a/modules/shortcut/shortcut.info
+++ b/modules/shortcut/shortcut.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = shortcut.test
 configure = admin/config/user-interface/shortcut
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/simpletest.info b/modules/simpletest/simpletest.info
index 95db08c..7a5fd8c 100644
--- a/modules/simpletest/simpletest.info
+++ b/modules/simpletest/simpletest.info
@@ -55,8 +55,8 @@ files[] = tests/upgrade/update.trigger.test
 files[] = tests/upgrade/update.field.test
 files[] = tests/upgrade/update.user.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/actions_loop_test.info b/modules/simpletest/tests/actions_loop_test.info
index 4483849..dfd6d67 100644
--- a/modules/simpletest/tests/actions_loop_test.info
+++ b/modules/simpletest/tests/actions_loop_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/ajax_forms_test.info b/modules/simpletest/tests/ajax_forms_test.info
index 2af2f30..67c45e2 100644
--- a/modules/simpletest/tests/ajax_forms_test.info
+++ b/modules/simpletest/tests/ajax_forms_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/ajax_test.info b/modules/simpletest/tests/ajax_test.info
index 244e97f..0dab7ed 100644
--- a/modules/simpletest/tests/ajax_test.info
+++ b/modules/simpletest/tests/ajax_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/batch_test.info b/modules/simpletest/tests/batch_test.info
index fcf84c8..c69cd11 100644
--- a/modules/simpletest/tests/batch_test.info
+++ b/modules/simpletest/tests/batch_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/common_test.info b/modules/simpletest/tests/common_test.info
index 1c78293..e44c56e 100644
--- a/modules/simpletest/tests/common_test.info
+++ b/modules/simpletest/tests/common_test.info
@@ -7,8 +7,8 @@ stylesheets[all][] = common_test.css
 stylesheets[print][] = common_test.print.css
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/common_test_cron_helper.info b/modules/simpletest/tests/common_test_cron_helper.info
index 73579f4..2fc8325 100644
--- a/modules/simpletest/tests/common_test_cron_helper.info
+++ b/modules/simpletest/tests/common_test_cron_helper.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/database_test.info b/modules/simpletest/tests/database_test.info
index 9ca44d8..5d0c9c4 100644
--- a/modules/simpletest/tests/database_test.info
+++ b/modules/simpletest/tests/database_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info b/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
index 3ac342b..95acf73 100644
--- a/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
+++ b/modules/simpletest/tests/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info b/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
index b7de887..60bc34f 100644
--- a/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
+++ b/modules/simpletest/tests/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/entity_cache_test.info b/modules/simpletest/tests/entity_cache_test.info
index 504c9aa..d25db8f 100644
--- a/modules/simpletest/tests/entity_cache_test.info
+++ b/modules/simpletest/tests/entity_cache_test.info
@@ -6,8 +6,8 @@ core = 7.x
 dependencies[] = entity_cache_test_dependency
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/entity_cache_test_dependency.info b/modules/simpletest/tests/entity_cache_test_dependency.info
index 30f00fb..41e9d72 100644
--- a/modules/simpletest/tests/entity_cache_test_dependency.info
+++ b/modules/simpletest/tests/entity_cache_test_dependency.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/entity_crud_hook_test.info b/modules/simpletest/tests/entity_crud_hook_test.info
index 80d137f..00ace08 100644
--- a/modules/simpletest/tests/entity_crud_hook_test.info
+++ b/modules/simpletest/tests/entity_crud_hook_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/entity_query_access_test.info b/modules/simpletest/tests/entity_query_access_test.info
index 5a52e08..4abb440 100644
--- a/modules/simpletest/tests/entity_query_access_test.info
+++ b/modules/simpletest/tests/entity_query_access_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/error_test.info b/modules/simpletest/tests/error_test.info
index 41e9248..36e08a1 100644
--- a/modules/simpletest/tests/error_test.info
+++ b/modules/simpletest/tests/error_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/file_test.info b/modules/simpletest/tests/file_test.info
index 51f65a2..b0e2947 100644
--- a/modules/simpletest/tests/file_test.info
+++ b/modules/simpletest/tests/file_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = file_test.module
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/filter_test.info b/modules/simpletest/tests/filter_test.info
index 5946874..88fcb92 100644
--- a/modules/simpletest/tests/filter_test.info
+++ b/modules/simpletest/tests/filter_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/form.test b/modules/simpletest/tests/form.test
index 8b63be4..1d430b5 100644
--- a/modules/simpletest/tests/form.test
+++ b/modules/simpletest/tests/form.test
@@ -1486,6 +1486,16 @@ class FormsProgrammaticTestCase extends DrupalWebTestCase {
     $this->submitForm(array('textfield' => 'dummy value', 'checkboxes' => array(1 => NULL, 2 => 2)), TRUE);
     $this->submitForm(array('textfield' => 'dummy value', 'checkboxes' => array(1 => NULL, 2 => NULL)), TRUE);
 
+    // Test that a programmatic form submission can successfully submit values
+    // even for fields where the #access property is FALSE.
+    $this->submitForm(array('textfield' => 'dummy value', 'textfield_no_access' => 'test value'), TRUE);
+    // Test that #access is respected for programmatic form submissions when
+    // requested to do so.
+    $submitted_values = array('textfield' => 'dummy value', 'textfield_no_access' => 'test value');
+    $expected_values = array('textfield' => 'dummy value', 'textfield_no_access' => 'default value');
+    $form_state = array('programmed_bypass_access_check' => FALSE);
+    $this->submitForm($submitted_values, TRUE, $expected_values, $form_state);
+
     // Test that a programmatic form submission can correctly click a button
     // that limits validation errors based on user input. Since we do not
     // submit any values for "textfield" here and the textfield is required, we
@@ -1508,10 +1518,18 @@ class FormsProgrammaticTestCase extends DrupalWebTestCase {
    * @param $valid_input
    *   A boolean indicating whether or not the form submission is expected to
    *   be valid.
+   * @param $expected_values
+   *   (Optional) An array of field values that are expected to be stored by
+   *   the form submit handler. If not set, the submitted $values are assumed
+   *   to also be the expected stored values.
+   * @param $form_state
+   *   (Optional) A keyed array containing the state of the form, to be sent in
+   *   the call to drupal_form_submit(). The $values parameter is added to
+   *   $form_state['values'] by default, if it is not already set.
    */
-  private function submitForm($values, $valid_input) {
+  private function submitForm($values, $valid_input, $expected_values = NULL, $form_state = array()) {
     // Programmatically submit the given values.
-    $form_state = array('values' => $values);
+    $form_state += array('values' => $values);
     drupal_form_submit('form_test_programmatic_form', $form_state);
 
     // Check that the form returns an error when expected, and vice versa.
@@ -1528,7 +1546,10 @@ class FormsProgrammaticTestCase extends DrupalWebTestCase {
       // By fetching the values from $form_state['storage'] we ensure that the
       // submission handler was properly executed.
       $stored_values = $form_state['storage']['programmatic_form_submit'];
-      foreach ($values as $key => $value) {
+      if (!isset($expected_values)) {
+        $expected_values = $values;
+      }
+      foreach ($expected_values as $key => $value) {
         $this->assertTrue(isset($stored_values[$key]) && $stored_values[$key] == $value, format_string('Submission handler correctly executed: %stored_key is %stored_value', array('%stored_key' => $key, '%stored_value' => print_r($value, TRUE))));
       }
     }
diff --git a/modules/simpletest/tests/form_test.info b/modules/simpletest/tests/form_test.info
index 5d7e83a..860e09a 100644
--- a/modules/simpletest/tests/form_test.info
+++ b/modules/simpletest/tests/form_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/form_test.module b/modules/simpletest/tests/form_test.module
index b4d2f549..c7885d7 100644
--- a/modules/simpletest/tests/form_test.module
+++ b/modules/simpletest/tests/form_test.module
@@ -1548,6 +1548,15 @@ function form_test_programmatic_form($form, &$form_state) {
     '#default_value' => array(1, 2),
   );
 
+  // This is used to test that programmatic form submissions can bypass #access
+  // restrictions.
+  $form['textfield_no_access'] = array(
+    '#type' => 'textfield',
+    '#title' => 'Textfield no access',
+    '#default_value' => 'default value',
+    '#access' => FALSE,
+  );
+
   $form['field_to_validate'] = array(
     '#type' => 'radios',
     '#title' => 'Field to validate (in the case of limited validation)',
diff --git a/modules/simpletest/tests/image_test.info b/modules/simpletest/tests/image_test.info
index e4bd98c..8bfca5a 100644
--- a/modules/simpletest/tests/image_test.info
+++ b/modules/simpletest/tests/image_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/menu_test.info b/modules/simpletest/tests/menu_test.info
index 05fcef2..bdb1cf9 100644
--- a/modules/simpletest/tests/menu_test.info
+++ b/modules/simpletest/tests/menu_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/module_test.info b/modules/simpletest/tests/module_test.info
index ee938df..1d43e12 100644
--- a/modules/simpletest/tests/module_test.info
+++ b/modules/simpletest/tests/module_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/path_test.info b/modules/simpletest/tests/path_test.info
index d10eee6..086ba32 100644
--- a/modules/simpletest/tests/path_test.info
+++ b/modules/simpletest/tests/path_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/psr_0_test/psr_0_test.info b/modules/simpletest/tests/psr_0_test/psr_0_test.info
index 472f2c2..e392562 100644
--- a/modules/simpletest/tests/psr_0_test/psr_0_test.info
+++ b/modules/simpletest/tests/psr_0_test/psr_0_test.info
@@ -5,8 +5,8 @@ core = 7.x
 hidden = TRUE
 package = Testing
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/requirements1_test.info b/modules/simpletest/tests/requirements1_test.info
index 82e6059..611979c 100644
--- a/modules/simpletest/tests/requirements1_test.info
+++ b/modules/simpletest/tests/requirements1_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/requirements2_test.info b/modules/simpletest/tests/requirements2_test.info
index e4aace1..5f5e276 100644
--- a/modules/simpletest/tests/requirements2_test.info
+++ b/modules/simpletest/tests/requirements2_test.info
@@ -7,8 +7,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/session_test.info b/modules/simpletest/tests/session_test.info
index 98897e4..4e21030 100644
--- a/modules/simpletest/tests/session_test.info
+++ b/modules/simpletest/tests/session_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/system_dependencies_test.info b/modules/simpletest/tests/system_dependencies_test.info
index 3b9494c..5826086 100644
--- a/modules/simpletest/tests/system_dependencies_test.info
+++ b/modules/simpletest/tests/system_dependencies_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = _missing_dependency
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info b/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
index a83ef74..0fba52e 100644
--- a/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
+++ b/modules/simpletest/tests/system_incompatible_core_version_dependencies_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = system_incompatible_core_version_test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/system_incompatible_core_version_test.info b/modules/simpletest/tests/system_incompatible_core_version_test.info
index e56e7aa..af42979 100644
--- a/modules/simpletest/tests/system_incompatible_core_version_test.info
+++ b/modules/simpletest/tests/system_incompatible_core_version_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 5.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info b/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
index 3871331..8862a79 100644
--- a/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
+++ b/modules/simpletest/tests/system_incompatible_module_version_dependencies_test.info
@@ -7,8 +7,8 @@ hidden = TRUE
 ; system_incompatible_module_version_test declares version 1.0
 dependencies[] = system_incompatible_module_version_test (>2.0)
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/system_incompatible_module_version_test.info b/modules/simpletest/tests/system_incompatible_module_version_test.info
index f1ca026..48f5eb1 100644
--- a/modules/simpletest/tests/system_incompatible_module_version_test.info
+++ b/modules/simpletest/tests/system_incompatible_module_version_test.info
@@ -5,8 +5,8 @@ version = 1.0
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/system_test.info b/modules/simpletest/tests/system_test.info
index d82a0d2..3e3020c 100644
--- a/modules/simpletest/tests/system_test.info
+++ b/modules/simpletest/tests/system_test.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = system_test.module
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/taxonomy_test.info b/modules/simpletest/tests/taxonomy_test.info
index 0272202..296a2b8 100644
--- a/modules/simpletest/tests/taxonomy_test.info
+++ b/modules/simpletest/tests/taxonomy_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 dependencies[] = taxonomy
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/theme_test.info b/modules/simpletest/tests/theme_test.info
index 027213d..7b4db19 100644
--- a/modules/simpletest/tests/theme_test.info
+++ b/modules/simpletest/tests/theme_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info b/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
index 0b57cc0..2af492c 100644
--- a/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
+++ b/modules/simpletest/tests/themes/test_basetheme/test_basetheme.info
@@ -6,8 +6,8 @@ hidden = TRUE
 settings[basetheme_only] = base theme value
 settings[subtheme_override] = base theme value
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info b/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
index d0b0c33..641c4c7 100644
--- a/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
+++ b/modules/simpletest/tests/themes/test_subtheme/test_subtheme.info
@@ -6,8 +6,8 @@ hidden = TRUE
 
 settings[subtheme_override] = subtheme value
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/themes/test_theme/test_theme.info b/modules/simpletest/tests/themes/test_theme/test_theme.info
index f9ddce3..783e37c 100644
--- a/modules/simpletest/tests/themes/test_theme/test_theme.info
+++ b/modules/simpletest/tests/themes/test_theme/test_theme.info
@@ -17,8 +17,8 @@ stylesheets[all][] = system.base.css
 
 settings[theme_test_setting] = default value
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/update_script_test.info b/modules/simpletest/tests/update_script_test.info
index 18ff254..1a67030 100644
--- a/modules/simpletest/tests/update_script_test.info
+++ b/modules/simpletest/tests/update_script_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/update_test_1.info b/modules/simpletest/tests/update_test_1.info
index a8fb52c..76b4e2f 100644
--- a/modules/simpletest/tests/update_test_1.info
+++ b/modules/simpletest/tests/update_test_1.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/update_test_2.info b/modules/simpletest/tests/update_test_2.info
index a8fb52c..76b4e2f 100644
--- a/modules/simpletest/tests/update_test_2.info
+++ b/modules/simpletest/tests/update_test_2.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/update_test_3.info b/modules/simpletest/tests/update_test_3.info
index a8fb52c..76b4e2f 100644
--- a/modules/simpletest/tests/update_test_3.info
+++ b/modules/simpletest/tests/update_test_3.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/upgrade/upgrade.taxonomy.test b/modules/simpletest/tests/upgrade/upgrade.taxonomy.test
index e0142f4..58a4d5c 100644
--- a/modules/simpletest/tests/upgrade/upgrade.taxonomy.test
+++ b/modules/simpletest/tests/upgrade/upgrade.taxonomy.test
@@ -56,6 +56,11 @@ class UpgradePathTaxonomyTestCase extends UpgradePathTestCase {
     $this->assertFalse(db_table_exists('taxonomy_vocabulary_node_type'), 'taxonomy_vocabulary_node_type has been removed.');
     $this->assertFalse(db_table_exists('taxonomy_term_node'), 'taxonomy_term_node has been removed.');
 
+    // Check that taxonomy_index has not stored nids of unpublished nodes.
+    $nids = db_query('SELECT nid from {node} WHERE status = :status', array(':status' => NODE_NOT_PUBLISHED))->fetchCol();
+    $indexed_nids = db_query('SELECT DISTINCT nid from {taxonomy_index}')->fetchCol();
+    $this->assertFalse(array_intersect($nids, $indexed_nids), 'No unpublished nid present in taxonomy_index');
+
     // Check that the node type 'page' has been associated to a taxonomy
     // reference field for each vocabulary.
     $voc_keys = array();
diff --git a/modules/simpletest/tests/url_alter_test.info b/modules/simpletest/tests/url_alter_test.info
index 927a49c..ae680d8 100644
--- a/modules/simpletest/tests/url_alter_test.info
+++ b/modules/simpletest/tests/url_alter_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/simpletest/tests/xmlrpc_test.info b/modules/simpletest/tests/xmlrpc_test.info
index 4d92224..b61bd6a 100644
--- a/modules/simpletest/tests/xmlrpc_test.info
+++ b/modules/simpletest/tests/xmlrpc_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/statistics/statistics.info b/modules/statistics/statistics.info
index 57f3717..e5629b4 100644
--- a/modules/statistics/statistics.info
+++ b/modules/statistics/statistics.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = statistics.test
 configure = admin/config/system/statistics
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/syslog/syslog.info b/modules/syslog/syslog.info
index 96d967f..fc50ef1 100644
--- a/modules/syslog/syslog.info
+++ b/modules/syslog/syslog.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = syslog.test
 configure = admin/config/development/logging
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/system/system.info b/modules/system/system.info
index 0f4224c..667581a 100644
--- a/modules/system/system.info
+++ b/modules/system/system.info
@@ -12,8 +12,8 @@ files[] = system.test
 required = TRUE
 configure = admin/config/system
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/taxonomy/taxonomy.info b/modules/taxonomy/taxonomy.info
index 8ef9243..81e93f8 100644
--- a/modules/taxonomy/taxonomy.info
+++ b/modules/taxonomy/taxonomy.info
@@ -8,8 +8,8 @@ files[] = taxonomy.module
 files[] = taxonomy.test
 configure = admin/structure/taxonomy
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/taxonomy/taxonomy.install b/modules/taxonomy/taxonomy.install
index 2d44d3d..e3603e1 100644
--- a/modules/taxonomy/taxonomy.install
+++ b/modules/taxonomy/taxonomy.install
@@ -638,6 +638,10 @@ function taxonomy_update_7005(&$sandbox) {
           'type' => 'int',
           'not null' => FALSE,
         ),
+        'status' => array(
+          'type' => 'int',
+          'not null' => FALSE,
+        ),
         'is_current' => array(
           'type' => 'int',
           'unsigned' => TRUE,
@@ -670,6 +674,7 @@ function taxonomy_update_7005(&$sandbox) {
     $query->addField('n', 'type');
     $query->addField('n2', 'created');
     $query->addField('n2', 'sticky');
+    $query->addField('n2', 'status');
     $query->addField('n2', 'nid', 'is_current');
     // This query must return a consistent ordering across multiple calls.
     // We need them ordered by node vid (since we use that to decide when
@@ -698,7 +703,7 @@ function taxonomy_update_7005(&$sandbox) {
     // We do each pass in batches of 1000.
     $batch = 1000;
 
-    $result = db_query_range('SELECT vocab_id, tid, nid, vid, type, created, sticky, is_current FROM {taxonomy_update_7005} ORDER BY n', $sandbox['last'], $batch);
+    $result = db_query_range('SELECT vocab_id, tid, nid, vid, type, created, sticky, status, is_current FROM {taxonomy_update_7005} ORDER BY n', $sandbox['last'], $batch);
     if (isset($sandbox['cursor'])) {
       $values = $sandbox['cursor']['values'];
       $deltas = $sandbox['cursor']['deltas'];
@@ -765,12 +770,14 @@ function taxonomy_update_7005(&$sandbox) {
       // is_current column is a node ID if this revision is also current.
       if ($record->is_current) {
         db_insert($table_name)->fields($columns)->values($values)->execute();
-
-        // Update the {taxonomy_index} table.
-        db_insert('taxonomy_index')
-          ->fields(array('nid', 'tid', 'sticky', 'created',))
-          ->values(array($record->nid, $record->tid, $record->sticky, $record->created))
-          ->execute();
+        // Only insert a record in the taxonomy index if the node is published.
+        if ($record->status) {
+          // Update the {taxonomy_index} table.
+          db_insert('taxonomy_index')
+            ->fields(array('nid', 'tid', 'sticky', 'created',))
+            ->values(array($record->nid, $record->tid, $record->sticky, $record->created))
+            ->execute();
+        }
       }
     }
 
@@ -888,3 +895,23 @@ function taxonomy_update_7010() {
   ));
 }
 
+/**
+ * @addtogroup updates-7.x-extra
+ * @{
+ */
+
+/**
+ * Drop unpublished nodes from the index.
+ */
+function taxonomy_update_7011() {
+  $nids = db_query('SELECT nid from {node} WHERE status = :status', array(':status' => NODE_NOT_PUBLISHED))->fetchCol();
+  if (!empty($nids)) {
+    db_delete('taxonomy_index')
+      ->condition('nid', $nids)
+      ->execute();
+  }
+}
+
+/**
+ * @} End of "addtogroup updates-7.x-extra".
+ */
diff --git a/modules/toolbar/toolbar.info b/modules/toolbar/toolbar.info
index d1fec6b..c8d7d31 100644
--- a/modules/toolbar/toolbar.info
+++ b/modules/toolbar/toolbar.info
@@ -4,8 +4,8 @@ core = 7.x
 package = Core
 version = VERSION
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/tracker/tracker.info b/modules/tracker/tracker.info
index 4fb17fd..6a84fc2 100644
--- a/modules/tracker/tracker.info
+++ b/modules/tracker/tracker.info
@@ -6,8 +6,8 @@ version = VERSION
 core = 7.x
 files[] = tracker.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/translation/tests/translation_test.info b/modules/translation/tests/translation_test.info
index 0adb8ad..4d83254 100644
--- a/modules/translation/tests/translation_test.info
+++ b/modules/translation/tests/translation_test.info
@@ -5,8 +5,8 @@ package = Testing
 version = VERSION
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/translation/translation.info b/modules/translation/translation.info
index a2b8239..7a1c3ce 100644
--- a/modules/translation/translation.info
+++ b/modules/translation/translation.info
@@ -6,8 +6,8 @@ version = VERSION
 core = 7.x
 files[] = translation.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/trigger/tests/trigger_test.info b/modules/trigger/tests/trigger_test.info
index c26fdeb..5656137 100644
--- a/modules/trigger/tests/trigger_test.info
+++ b/modules/trigger/tests/trigger_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/trigger/trigger.info b/modules/trigger/trigger.info
index 2c400e4..aa7c18c 100644
--- a/modules/trigger/trigger.info
+++ b/modules/trigger/trigger.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = trigger.test
 configure = admin/structure/trigger
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/update/tests/aaa_update_test.info b/modules/update/tests/aaa_update_test.info
index 3da5a70..8af9839 100644
--- a/modules/update/tests/aaa_update_test.info
+++ b/modules/update/tests/aaa_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/update/tests/bbb_update_test.info b/modules/update/tests/bbb_update_test.info
index c825b79..928cfbc 100644
--- a/modules/update/tests/bbb_update_test.info
+++ b/modules/update/tests/bbb_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/update/tests/ccc_update_test.info b/modules/update/tests/ccc_update_test.info
index 74bb500..7b4a97a 100644
--- a/modules/update/tests/ccc_update_test.info
+++ b/modules/update/tests/ccc_update_test.info
@@ -4,8 +4,8 @@ package = Testing
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info b/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
index 237a5bb..3d506d7 100644
--- a/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
+++ b/modules/update/tests/themes/update_test_basetheme/update_test_basetheme.info
@@ -3,8 +3,8 @@ description = Test theme which acts as a base theme for other test subthemes.
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info b/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
index e2e1ca9..40c2e44 100644
--- a/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
+++ b/modules/update/tests/themes/update_test_subtheme/update_test_subtheme.info
@@ -4,8 +4,8 @@ core = 7.x
 base theme = update_test_basetheme
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/update/tests/update_test.info b/modules/update/tests/update_test.info
index 5726cea..3964e7f 100644
--- a/modules/update/tests/update_test.info
+++ b/modules/update/tests/update_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/update/update.info b/modules/update/update.info
index 0ac3750..978470b 100644
--- a/modules/update/update.info
+++ b/modules/update/update.info
@@ -6,8 +6,8 @@ core = 7.x
 files[] = update.test
 configure = admin/reports/updates/settings
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/user/tests/user_form_test.info b/modules/user/tests/user_form_test.info
index eef5f52..bc1bc83 100644
--- a/modules/user/tests/user_form_test.info
+++ b/modules/user/tests/user_form_test.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/modules/user/user.info b/modules/user/user.info
index 81987cb..786a092 100644
--- a/modules/user/user.info
+++ b/modules/user/user.info
@@ -9,8 +9,8 @@ required = TRUE
 configure = admin/config/people
 stylesheets[all][] = user.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/profiles/commons/commons.info b/profiles/commons/commons.info
index 687d3ab..8c29bd5 100644
--- a/profiles/commons/commons.info
+++ b/profiles/commons/commons.info
@@ -122,9 +122,9 @@ dependencies[] = commons_wysiwyg
 ; System Requirements.
 php_memory_limit = 128M
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/drupal-org-core.make b/profiles/commons/drupal-org-core.make
index 64fb14e..806c8ff 100644
--- a/profiles/commons/drupal-org-core.make
+++ b/profiles/commons/drupal-org-core.make
@@ -3,7 +3,7 @@ core = 7.x
 
 ; Download Drupal core and apply core patches if needed.
 projects[drupal][type] = "core"
-projects[drupal][version] = 7.25
+projects[drupal][version] = 7.26
 
 ; This patch allows install profile to list requirements on the install page
 ; http://drupal.org/node/1971072
diff --git a/profiles/commons/drupal-org.make b/profiles/commons/drupal-org.make
index 11b4407..b31bbbc 100644
--- a/profiles/commons/drupal-org.make
+++ b/profiles/commons/drupal-org.make
@@ -57,7 +57,10 @@ projects[apachesolr_user][patch][] = "http://drupal.org/files/2077281-apache-sol
 
 projects[breakpoints][type] = "module"
 projects[breakpoints][subdir] = "contrib"
-projects[breakpoints][version] = "1.1"
+projects[breakpoints][download][type] = "git"
+projects[breakpoints][download][url] = "http://git.drupal.org/project/breakpoints.git"
+projects[breakpoints][download][branch] = "7.x-1.x"
+projects[breakpoints][download][revision] = "c4f3665"
 
 projects[connector][type] = "module"
 projects[connector][subdir] = "contrib"
@@ -70,6 +73,10 @@ projects[ckeditor][download][url] = "http://git.drupal.org/project/ckeditor.git"
 projects[ckeditor][download][branch] = "7.x-1.x"
 projects[ckeditor][download][revision] = "b69a9ac"
 
+; Only load CSS when necessary.
+; https://drupal.org/node/1370894
+projects[ckeditor][patch][] = "https://drupal.org/files/issues/attach-ckeditor-css-1370894-4.patch"
+
 ; Accomodate latest Media changes.
 ; https://drupal.org/node/2159403
 projects[ckeditor][patch][] = "https://drupal.org/files/issues/ckeditor-accomodate-latest-media-changes-0.patch"
@@ -266,7 +273,7 @@ projects[mollom][version] = "2.8"
 
 projects[navbar][type] = "module"
 projects[navbar][subdir] = "contrib"
-projects[navbar][version] = "1.2"
+projects[navbar][version] = "1.3"
 
 projects[oauth][type] = "module"
 projects[oauth][subdir] = "contrib"
@@ -286,6 +293,10 @@ projects[oembed][download][url] = "http://git.drupal.org/project/oembed.git"
 projects[oembed][download][branch] = "7.x-1.x"
 projects[oembed][download][revision] = "63898e1"
 
+; Fix PHP fatal error when enabling the module
+; https://drupal.org/comment/7987343#comment-7987343
+projects[oembed][patch][] = "https://drupal.org/files/oembed-2021015-1.patch"
+
 ; Add oEmbed plugins to list of supported media providers
 ; https://drupal.org/comment/8287243#comment-8287243
 projects[oembed][patch][] = "https://drupal.org/files/issues/list-enabled-plugins-2159335-1.patch"
@@ -337,6 +348,33 @@ projects[pathauto][type] = "module"
 projects[pathauto][subdir] = "contrib"
 projects[pathauto][version] = "1.2"
 
+projects[picture][type] = "module"
+projects[picture][subdir] = "contrib"
+projects[picture][download][type] = "git"
+projects[picture][download][url] = "http://git.drupal.org/project/picture.git"
+projects[picture][download][branch] = "7.x-1.x"
+projects[picture][download][revision] = "18b94b9"
+
+; Add ctools as a dependency
+; https://drupal.org/node/2173043
+projects[picture][patch][] = "https://drupal.org/files/issues/add-ctools-dependency-2173043-1.patch"
+
+; Allow filter tips to be translated
+; https://drupal.org/node/2139459
+projects[picture][patch][] = "https://drupal.org/files/issues/translate-filter-tips-2139459-1.patch"
+
+; Move hook_uninstall() to picture.install to fix issues on uninstall.
+; https://drupal.org/node/2173015
+projects[picture][patch][] = "https://drupal.org/files/issues/move-uninstall-hook-implementation-2173015-1.patch"
+
+; Remove implementation of hook_file_formatter_info() to remove duplicate file formatter.
+; https://drupal.org/node/2172841
+projects[picture][patch][] = "https://drupal.org/files/issues/remove-file-formatter-hook-implementation-2172831-1.patch"
+
+; Remove implementation of hook_ctools_plugin_api() to fix issues with features.
+; https://drupal.org/node/2172831
+projects[picture][patch][] = "https://drupal.org/files/issues/remove-ctools-hook-implementation-2172831-1.patch"
+
 projects[pm_existing_pages][type] = "module"
 projects[pm_existing_pages][subdir] = "contrib"
 projects[pm_existing_pages][version] = "1.4"
@@ -417,6 +455,10 @@ projects[sharethis][type] = "module"
 projects[sharethis][subdir] = "contrib"
 projects[sharethis][version] = "2.5"
 
+projects[smartcrop][type] = "module"
+projects[smartcrop][subdir] = "contrib"
+projects[smartcrop][version] = "1.0-beta2"
+
 projects[strongarm][type] = "module"
 projects[strongarm][subdir] = "contrib"
 projects[strongarm][download][type] = "git"
@@ -498,7 +540,7 @@ projects[ember][subdir] = "contrib"
 projects[ember][download][type] = "git"
 projects[ember][download][url] = "http://git.drupal.org/project/ember.git"
 projects[ember][download][branch] = "7.x-2.x"
-projects[ember][download][revision] = "5b8b0f6"
+projects[ember][download][revision] = "1d88894"
 
 projects[sky][type] = "theme"
 projects[sky][subdir] = "contrib"
@@ -515,9 +557,21 @@ libraries[ckeditor][download][type] = "get"
 libraries[ckeditor][download][url] = "http://download.cksource.com/CKEditor/CKEditor/CKEditor%204.3.1/ckeditor_4.3.1_full.zip"
 libraries[ckeditor][type] = "libraries"
 
+libraries[ckeditor_lineutils][download][type] = "get"
+libraries[ckeditor_lineutils][download][url] = "http://download.ckeditor.com/lineutils/releases/lineutils_4.3.1.zip"
+libraries[ckeditor_lineutils][type] = "libraries"
+libraries[ckeditor_lineutils][subdir] = "ckeditor/plugins"
+libraries[ckeditor_lineutils][directory_name] = "lineutils"
+
+libraries[ckeditor_widget][download][type] = "get"
+libraries[ckeditor_widget][download][url] = "http://download.ckeditor.com/widget/releases/widget_4.3.1.zip"
+libraries[ckeditor_widget][type] = "libraries"
+libraries[ckeditor_widget][subdir] = "ckeditor/plugins"
+libraries[ckeditor_widget][directory_name] = "widget"
+
 libraries[modernizr][download][type] = "get"
 libraries[modernizr][type] = "libraries"
-libraries[modernizr][download][url] = "https://github.com/Modernizr/Modernizr/archive/v2.7.0.tar.gz"
+libraries[modernizr][download][url] = "https://github.com/Modernizr/Modernizr/archive/v2.7.1.tar.gz"
 
 libraries[timeago][download][type] = "get"
 libraries[timeago][type] = "libraries"
@@ -525,4 +579,4 @@ libraries[timeago][download][url] = "https://raw.github.com/rmm5t/jquery-timeago
 
 libraries[underscore][download][type] = "get"
 libraries[underscore][type] = "libraries"
-libraries[underscore][download][url] = "https://github.com/jashkenas/underscore/archive/1.4.4.zip"
+libraries[underscore][download][url] = "https://github.com/jashkenas/underscore/archive/1.5.2.zip"
diff --git a/profiles/commons/libraries/ckeditor/plugins/lineutils/dev/dnd.html b/profiles/commons/libraries/ckeditor/plugins/lineutils/dev/dnd.html
new file mode 100644
index 0000000..d1e849c
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/lineutils/dev/dnd.html
@@ -0,0 +1,172 @@
+<!DOCTYPE html>
+<!--
+Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+For licensing, see LICENSE.md or http://ckeditor.com/license
+-->
+<html>
+<head>
+	<title>Widget Drag &amp; Drop with Lineutils &mdash; CKEditor Sample</title>
+	<meta charset="utf-8">
+	<script src="../../../ckeditor.js"></script>
+	<script>
+		if ( CKEDITOR.env.ie && CKEDITOR.env.version < 9 )
+			CKEDITOR.tools.enableHtml5Elements( document );
+	</script>
+	<link href="../../../samples/sample.css" rel="stylesheet">
+	<link href="../../image2/samples/contents.css" rel="stylesheet">
+</head>
+<body>
+	<h1 class="samples">
+		<a href="../../../samples/index.html">CKEditor Samples</a> &raquo; Widget Drag &amp; Drop with Lineutils
+	</h1>
+
+	<h3>Framed</h3>
+
+	<textarea id="editor1" cols="10" rows="10">
+		<h1>Apollo 11</h1>
+
+		<figure class="caption" style="float:right"><img alt="Saturn V" src="../../image2/samples/assets/image1.jpg" width="200" />
+		<figcaption>Roll out of Saturn V on launch pad</figcaption>
+		</figure>
+
+		<p><strong>Apollo 11</strong> was the spaceflight that landed the first humans, Americans <a href="http://en.wikipedia.org/wiki/Neil_Armstrong" title="Neil Armstrong">Neil Armstrong</a> and <a href="http://en.wikipedia.org/wiki/Buzz_Aldrin" title="Buzz Aldrin">Buzz Aldrin</a>, on the Moon on July 20, 1969, at 20:18 UTC. Armstrong became the first to step onto the lunar surface 6 hours later on July 21 at 02:56 UTC.</p>
+
+		<p>Armstrong spent about <s>three and a half</s> two and a half hours outside the spacecraft, Aldrin slightly less; and together they collected 47.5 pounds (21.5&nbsp;kg) of lunar material for return to Earth. A third member of the mission, <a href="http://en.wikipedia.org/wiki/Michael_Collins_(astronaut)" title="Michael Collins (astronaut)">Michael Collins</a>, piloted the <a href="http://en.wikipedia.org/wiki/Apollo_Command/Service_Module" title="Apollo Command/Service Module">command</a> spacecraft alone in lunar orbit until Armstrong and Aldrin returned to it for the trip back to Earth.</p>
+
+		<h2>Broadcasting and <em>quotes</em> <a id="quotes" name="quotes"></a></h2>
+
+		<p>Broadcast on live TV to a world-wide audience, Armstrong stepped onto the lunar surface and described the event as:</p>
+
+		<blockquote>
+		<p>One small step for [a] man, one giant leap for mankind.</p>
+		</blockquote>
+
+		<p>Apollo 11 effectively ended the <a href="http://en.wikipedia.org/wiki/Space_Race" title="Space Race">Space Race</a> and fulfilled a national goal proposed in 1961 by the late U.S. President <a href="http://en.wikipedia.org/wiki/John_F._Kennedy" title="John F. Kennedy">John F. Kennedy</a> in a speech before the United States Congress:</p>
+
+		<div style="text-align:center">
+		<figure class="caption" style="display:inline-block"><img alt="The Eagle" height="123" src="../../image2/samples/assets/image2.jpg" width="136" />
+		<figcaption>The Eagle in lunar orbit</figcaption>
+		</figure>
+		</div>
+
+		<blockquote>
+		<p>[...] before this decade is out, of landing a man on the Moon and returning him safely to the Earth.</p>
+		</blockquote>
+
+		<figure class="caption" style="float:right"><img alt="The Eagle" src="../../image2/samples/assets/image2.jpg" width="200" />
+		<figcaption>The Eagle in lunar orbit</figcaption>
+		</figure>
+
+		<h2>Technical details <a id="tech-details" name="tech-details"></a></h2>
+
+		<p>Launched by a <strong>Saturn V</strong> rocket from <a href="http://en.wikipedia.org/wiki/Kennedy_Space_Center" title="Kennedy Space Center">Kennedy Space Center</a> in Merritt Island, Florida on July 16, Apollo 11 was the fifth manned mission of <a href="http://en.wikipedia.org/wiki/NASA" title="NASA">NASA</a>&#39;s Apollo program. The Apollo spacecraft had three parts:</p>
+
+		<ol>
+			<li><strong>Command Module</strong> with a cabin for the three astronauts which was the only part which landed back on Earth</li>
+			<li><strong>Service Module</strong> which supported the Command Module with propulsion, electrical power, oxygen and water</li>
+			<li><strong>Lunar Module</strong> for landing on the Moon.</li>
+		</ol>
+
+		<p>After being sent to the Moon by the Saturn V&#39;s upper stage, the astronauts separated the spacecraft from it and travelled for three days until they entered into lunar orbit. Armstrong and Aldrin then moved into the Lunar Module and landed in the <a href="http://en.wikipedia.org/wiki/Mare_Tranquillitatis" title="Mare Tranquillitatis">Sea of Tranquility</a>. They stayed a total of about 21 and a half hours on the lunar surface. After lifting off in the upper part of the Lunar Module and rejoining Collins in the Command Module, they returned to Earth and landed in the <a href="http://en.wikipedia.org/wiki/Pacific_Ocean" title="Pacific Ocean">Pacific Ocean</a> on July 24.</p>
+
+		<figure class="caption"><img alt="Saturn V" height="129" src="../../image2/samples/assets/image1.jpg" width="101" />
+		<figcaption>Roll out of Saturn V on launch pad</figcaption>
+		</figure>
+
+		<hr />
+		<p style="text-align:right"><small>Source: <a href="http://en.wikipedia.org/wiki/Apollo_11">Wikipedia.org</a></small></p>
+
+	</textarea>
+
+	<h3>Inline</h3>
+
+	<div id="editor2" contenteditable="true" style="outline: 2px solid #ccc">
+		<table border="0" cellpadding="1" cellspacing="1" style="width: 100%; ">
+			<tbody>
+				<tr>
+					<td>This table</td>
+					<td>is the</td>
+					<td>very first</td>
+					<td>element of the document.</td>
+				</tr>
+				<tr>
+					<td>We are still</td>
+					<td>able to acces</td>
+					<td>the space before it.</td>
+					<td style="padding: 25px">
+					<table border="0" cellpadding="1" cellspacing="1" style="width: 100%; ">
+						<tbody>
+							<tr>
+								<td>This table is inside of a cell of another table.</td>
+							</tr>
+							<tr>
+								<td>We can type&nbsp;either before or after it though.</td>
+							</tr>
+						</tbody>
+					</table>
+					</td>
+				</tr>
+			</tbody>
+		</table>
+
+		<hr />
+		<hr />
+		<ol style="width: 300px">
+			<li>This numbered list...</li>
+			<li>...is a neighbour of a horizontal line...</li>
+			<li style="padding: 20px;">
+				<ol>
+					<li>Nested list!</li>
+				</ol>
+			</li>
+		</ol>
+
+		<figure class="caption"><img alt="Saturn V" src="../../image2/samples/assets/image1.jpg" width="100" />
+			<figcaption>Roll out of Saturn V on launch pad</figcaption>
+		</figure>
+
+		<ul style="width: 450px">
+			<li>We can type between the lists...</li>
+			<li>...thanks to <strong>Magicline</strong>.</li>
+		</ul>
+
+		<p>Lorem ipsum dolor sit amet dui. Morbi vel turpis. Nullam et leo. Etiam rutrum, urna tellus dui vel tincidunt mattis egestas, justo fringilla vel, massa. Phasellus.</p>
+
+		<p>Quisque iaculis, dui lectus varius vitae, tortor. Proin lacus. Pellentesque ac lacus. Aenean nonummy commodo nec, pede. Etiam blandit risus elit.</p>
+
+		<p>Ut pretium. Vestibulum rutrum in, adipiscing elit. Sed in quam in purus sem vitae pede. Pellentesque bibendum, urna sem vel risus. Vivamus posuere metus. Aliquam gravida iaculis nisl. Nam enim. Aliquam erat ac lacus tellus ac felis.</p>
+
+		<div id="last" style="padding: 10px; text-align: center;">
+			<p>This text is wrapped in a&nbsp;<tt>DIV</tt>&nbsp;element. We can type after this element though.</p>
+		</div>
+	</div>
+
+	<script>
+
+		CKEDITOR.replace( 'editor1', {
+			extraPlugins: 'image2',
+			height: 450,
+			removePlugins: 'image,forms',
+			contentsCss: [ '../../../contents.css', '../../image2/samples/contents.css' ]
+		} );
+
+		CKEDITOR.inline( 'editor2', {
+			extraPlugins: 'image2',
+			height: 450,
+			removePlugins: 'image,forms'
+		} );
+
+	</script>
+
+	<div id="footer">
+		<hr>
+		<p>
+			CKEditor - The text editor for the Internet - <a class="samples" href="http://ckeditor.com/">http://ckeditor.com</a>
+		</p>
+		<p id="copy">
+			Copyright &copy; 2003-2013, <a class="samples" href="http://cksource.com/">CKSource</a> - Frederico
+			Knabben. All rights reserved.
+		</p>
+	</div>
+</body>
+</html>
diff --git a/profiles/commons/libraries/ckeditor/plugins/lineutils/dev/magicfinger.html b/profiles/commons/libraries/ckeditor/plugins/lineutils/dev/magicfinger.html
new file mode 100644
index 0000000..c93a48b
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/lineutils/dev/magicfinger.html
@@ -0,0 +1,285 @@
+<!DOCTYPE html>
+<!--
+Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+For licensing, see LICENSE.md or http://ckeditor.com/license
+-->
+<html>
+<head>
+	<title>Lineutils &mdash; CKEditor Sample</title>
+	<meta charset="utf-8">
+	<script src="../../../ckeditor.js"></script>
+	<link href="../../../samples/sample.css" rel="stylesheet">
+</head>
+<body>
+	<h1 class="samples">
+		<a href="../../../samples/index.html">CKEditor Samples</a> &raquo; Lineutils
+	</h1>
+
+	<h3>Framed</h3>
+
+	<textarea id="editor1" cols="10" rows="10">
+		<table border="0" cellpadding="1" cellspacing="1" style="width: 100%; ">
+			<tbody>
+				<tr>
+					<td>This table</td>
+					<td>is the</td>
+					<td>very first</td>
+					<td>element of the document.</td>
+				</tr>
+				<tr>
+					<td>We are still</td>
+					<td>able to acces</td>
+					<td>the space before it.</td>
+					<td style="padding: 25px">
+					<table border="0" cellpadding="1" cellspacing="1" style="width: 100%; ">
+						<tbody>
+							<tr>
+								<td>This table is inside of a cell of another table.</td>
+							</tr>
+							<tr>
+								<td>We can type&nbsp;either before or after it though.</td>
+							</tr>
+						</tbody>
+					</table>
+					</td>
+				</tr>
+			</tbody>
+		</table>
+
+		<p>Two succesive horizontal lines (<tt>HR</tt> tags). We can access the space in between:</p>
+
+		<hr />
+		<hr />
+		<ol style="width: 300px">
+			<li>This numbered list...</li>
+			<li>...is a neighbour of a horizontal line...</li>
+			<li style="padding: 20px;">
+				<ol>
+					<li>Nested list!</li>
+				</ol>
+			</li>
+		</ol>
+
+		<ul style="width: 450px">
+			<li>We can type between the lists...</li>
+			<li>...thanks to <strong>Magicline</strong>.</li>
+		</ul>
+
+		<p>Lorem ipsum dolor sit amet dui. Morbi vel turpis. Nullam et leo. Etiam rutrum, urna tellus dui vel tincidunt mattis egestas, justo fringilla vel, massa. Phasellus.</p>
+
+		<p>Quisque iaculis, dui lectus varius vitae, tortor. Proin lacus. Pellentesque ac lacus. Aenean nonummy commodo nec, pede. Etiam blandit risus elit.</p>
+
+		<p>Ut pretium. Vestibulum rutrum in, adipiscing elit. Sed in quam in purus sem vitae pede. Pellentesque bibendum, urna sem vel risus. Vivamus posuere metus. Aliquam gravida iaculis nisl. Nam enim. Aliquam erat ac lacus tellus ac felis.</p>
+
+		<div id="last" style="padding: 10px; text-align: center;">
+		<p>This text is wrapped in a&nbsp;<tt>DIV</tt>&nbsp;element. We can type after this element though.</p>
+		</div>
+	</textarea>
+
+	<h3>Inline</h3>
+
+	<div id="editor2" contenteditable="true" style="outline: 2px solid #ccc">
+		<table border="0" cellpadding="1" cellspacing="1" style="width: 100%; ">
+			<tbody>
+				<tr>
+					<td>This table</td>
+					<td>is the</td>
+					<td>very first</td>
+					<td>element of the document.</td>
+				</tr>
+				<tr>
+					<td>We are still</td>
+					<td>able to acces</td>
+					<td>the space before it.</td>
+					<td style="padding: 25px">
+					<table border="0" cellpadding="1" cellspacing="1" style="width: 100%; ">
+						<tbody>
+							<tr>
+								<td>This table is inside of a cell of another table.</td>
+							</tr>
+							<tr>
+								<td>We can type&nbsp;either before or after it though.</td>
+							</tr>
+						</tbody>
+					</table>
+					</td>
+				</tr>
+			</tbody>
+		</table>
+
+		<p>Two succesive horizontal lines (<tt>HR</tt> tags). We can access the space in between:</p>
+
+		<hr />
+		<hr />
+		<ol style="width: 300px">
+			<li>This numbered list...</li>
+			<li>...is a neighbour of a horizontal line...</li>
+			<li style="padding: 20px;">
+				<ol>
+					<li>Nested list!</li>
+				</ol>
+			</li>
+		</ol>
+
+		<ul style="width: 450px">
+			<li>We can type between the lists...</li>
+			<li>...thanks to <strong>Magicline</strong>.</li>
+		</ul>
+
+		<p>Lorem ipsum dolor sit amet dui. Morbi vel turpis. Nullam et leo. Etiam rutrum, urna tellus dui vel tincidunt mattis egestas, justo fringilla vel, massa. Phasellus.</p>
+
+		<p>Quisque iaculis, dui lectus varius vitae, tortor. Proin lacus. Pellentesque ac lacus. Aenean nonummy commodo nec, pede. Etiam blandit risus elit.</p>
+
+		<p>Ut pretium. Vestibulum rutrum in, adipiscing elit. Sed in quam in purus sem vitae pede. Pellentesque bibendum, urna sem vel risus. Vivamus posuere metus. Aliquam gravida iaculis nisl. Nam enim. Aliquam erat ac lacus tellus ac felis.</p>
+
+		<div id="last" style="padding: 10px; text-align: center;">
+			<p>This text is wrapped in a&nbsp;<tt>DIV</tt>&nbsp;element. We can type after this element though.</p>
+		</div>
+	</div>
+
+	<h3>Extreme inline</h3>
+
+	<div id="editor3" contenteditable="true" style="left: 123px; outline: 1px solid red; border: 15px solid green; position: relative; top: 30; left: 30px;">
+		<div style="padding: 20px; background: gray; width: 300px" class="1">Lorem ipsum dolor sit amet enim. Etiam ullamcorper. Suspendisse a pellentesque dui, non felis. Maecenas malesuada elit lectus felis, malesuada ultricies. Curabitur et ligula. Ut molestie a, ultricies porta urna. Vestibulum commodo volutpat a, convallis ac, laoreet enim.</div>
+		<div style="background: violet; padding: 30px;" class="static">
+			Position static
+			<div style="background: green; padding: 30px;  border: 14px solid orange">foo</div>
+		</div>
+		<dl class="2">
+			<dt>Key</dt><dd>Value</dd>
+		</dl>
+		<div>Whatever</div>
+		<hr id="hr">
+		<p>Lorem ipsum dolor sit amet enim. Etiam ullamcorper. Suspendisse a pellentesque dui, non felis. Maecenas malesuada elit lectus felis, malesuada ultricies</p>
+		<hr>
+		<hr>
+		<p>Lorem ipsum dolor sit amet enim. Etiam ullamcorper. Suspendisse a pellentesque dui, non felis. Maecenas malesuada elit lectus felis, malesuada ultricies</p>
+		<div style="background: green; padding: 30px; width: 200px">foo</div>
+	</div>
+
+	<h3>Framed, H-scroll</h3>
+
+	<textarea id="editor4" cols="10" rows="10">
+		<hr />
+		<hr />
+		<ol style="width: 1500px">
+			<li>This numbered list...</li>
+			<li>...is a neighbour of a horizontal line...</li>
+			<li style="padding: 20px;">
+				<ol>
+					<li>Nested list!</li>
+				</ol>
+			</li>
+		</ol>
+
+		<ul style="width: 450px">
+			<li>We can type between the lists...</li>
+			<li>...thanks to <strong>Magicline</strong>.</li>
+		</ul>
+
+		<p>Lorem ipsum dolor sit amet dui. Morbi vel turpis. Nullam et leo. Etiam rutrum, urna tellus dui vel tincidunt mattis egestas, justo fringilla vel, massa. Phasellus.</p>
+
+		<p>Quisque iaculis, dui lectus varius vitae, tortor. Proin lacus. Pellentesque ac lacus. Aenean nonummy commodo nec, pede. Etiam blandit risus elit.</p>
+
+		<p>Ut pretium. Vestibulum rutrum in, adipiscing elit. Sed in quam in purus sem vitae pede. Pellentesque bibendum, urna sem vel risus. Vivamus posuere metus. Aliquam gravida iaculis nisl. Nam enim. Aliquam erat ac lacus tellus ac felis.</p>
+
+		<div id="last" style="padding: 10px; text-align: center;">
+		<p>This text is wrapped in a&nbsp;<tt>DIV</tt>&nbsp;element. We can type after this element though.</p>
+		</div>
+	</textarea>
+
+	<script>
+
+		CKEDITOR.addCss(
+			'.cke_editable * { outline: 1px solid #BCEBFF }'
+		);
+
+		function callback() {
+			var helpers = CKEDITOR.plugins.lineutils;
+			var liner = new helpers.liner( this );
+			var locator = new helpers.locator( this );
+			var finder = new helpers.finder( this, {
+				lookups: {
+					'is block and first child': function( el ) {
+						if ( el.is( CKEDITOR.dtd.$listItem ) )
+							return;
+
+						if ( el.is( CKEDITOR.dtd.$block ) )
+							return CKEDITOR.LINEUTILS_BEFORE | CKEDITOR.LINEUTILS_AFTER;
+					}
+				}
+			} ).start( function( relations, x, y ) {
+				locator.locate( relations );
+
+				var locations = locator.locations,
+					uid, type;
+
+				liner.prepare( relations, locations );
+
+				for ( uid in locations ) {
+					for ( type in locations[ uid ] )
+						liner.placeLine( { uid: uid, type: type } );
+				}
+
+				liner.cleanup();
+			} );
+		}
+
+		CKEDITOR.disableAutoInline = true;
+
+		CKEDITOR.replace( 'editor1', {
+			extraPlugins: 'lineutils',
+			height: 450,
+			removePlugins: 'magicline',
+			allowedContent: true,
+			contentsCss: [ '../../../contents.css' ],
+			on: {
+				contentDom: callback
+			}
+		} );
+
+		CKEDITOR.inline( 'editor2', {
+			extraPlugins: 'lineutils',
+			removePlugins: 'magicline',
+			allowedContent: true,
+			contentsCss: [ '../../../contents.css' ],
+			on: {
+				contentDom: callback
+			}
+		} );
+
+		CKEDITOR.inline( 'editor3', {
+			extraPlugins: 'lineutils',
+			removePlugins: 'magicline',
+			allowedContent: true,
+			contentsCss: [ '../../../contents.css' ],
+			on: {
+				contentDom: callback
+			}
+		} );
+
+		CKEDITOR.replace( 'editor4', {
+			extraPlugins: 'lineutils',
+			removePlugins: 'magicline',
+			allowedContent: true,
+			contentsCss: [ '../../../contents.css' ],
+			on: {
+				contentDom: callback
+			}
+		} );
+
+
+	</script>
+
+	<div id="footer">
+		<hr>
+		<p>
+			CKEditor - The text editor for the Internet - <a class="samples" href="http://ckeditor.com/">http://ckeditor.com</a>
+		</p>
+		<p id="copy">
+			Copyright &copy; 2003-2013, <a class="samples" href="http://cksource.com/">CKSource</a> - Frederico
+			Knabben. All rights reserved.
+		</p>
+	</div>
+</body>
+</html>
diff --git a/profiles/commons/libraries/ckeditor/plugins/lineutils/plugin.js b/profiles/commons/libraries/ckeditor/plugins/lineutils/plugin.js
new file mode 100644
index 0000000..edc0645
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/lineutils/plugin.js
@@ -0,0 +1,933 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+
+ /**
+ * @fileOverview A set of utilities to find and make horizontal spaces in edited contents.
+ */
+
+'use strict';
+
+(function() {
+
+	CKEDITOR.plugins.add( 'lineutils' );
+
+	/**
+	 * Determines a position relative to an element in DOM (before).
+	 *
+	 * @readonly
+	 * @property {Number} [=0]
+	 * @member CKEDITOR
+	 */
+	CKEDITOR.LINEUTILS_BEFORE = 1;
+
+	/**
+	 * Determines a position relative to an element in DOM (after).
+	 *
+	 * @readonly
+	 * @property {Number} [=2]
+	 * @member CKEDITOR
+	 */
+	CKEDITOR.LINEUTILS_AFTER = 2;
+
+	/**
+	 * Determines a position relative to an element in DOM (inside).
+	 *
+	 * @readonly
+	 * @property {Number} [=4]
+	 * @member CKEDITOR
+	 */
+	CKEDITOR.LINEUTILS_INSIDE = 4;
+
+	/**
+	 * An utility that traverses DOM tree and discovers elements
+	 * (relations) matching user-defined lookups.
+	 *
+	 * @private
+	 * @class CKEDITOR.plugins.lineutils.finder
+	 * @constructor Creates a Finder class instance.
+	 * @param {CKEDITOR.editor} editor Editor instance that Finder belongs to.
+	 * @param {Object} def Finder's definition.
+	 * @since 4.3
+	 */
+	function Finder( editor, def ) {
+		CKEDITOR.tools.extend( this, {
+			editor: editor,
+			editable: editor.editable(),
+			doc: editor.document,
+			win: editor.window
+		}, def, true );
+
+		this.frame = this.win.getFrame();
+		this.inline = this.editable.isInline();
+		this.target = this[ this.inline ? 'editable' : 'doc' ];
+	}
+
+	Finder.prototype = {
+		/**
+		 * Initializes searching for elements with every mousemove event fired.
+		 * To stop searching use {@link #stop}.
+		 *
+		 * @param {Function} [callback] Function executed on every iteration.
+		 */
+		start: function( callback ) {
+			var that = this,
+				editor = this.editor,
+				doc = this.doc,
+				el, x, y;
+
+			var moveBuffer = CKEDITOR.tools.eventsBuffer( 50, function() {
+					if ( editor.readOnly || editor.mode != 'wysiwyg' )
+						return;
+
+					that.relations = {};
+
+					el = new CKEDITOR.dom.element( doc.$.elementFromPoint( x, y ) );
+
+					that.traverseSearch( el );
+
+					if ( !isNaN( x + y ) )
+						that.pixelSearch( el, x, y );
+
+					callback && callback( that.relations, x, y );
+				} );
+
+			// Searching starting from element from point on mousemove.
+			this.listener = this.editable.attachListener( this.target, 'mousemove', function( evt ) {
+				x = evt.data.$.clientX;
+				y = evt.data.$.clientY;
+
+				moveBuffer.input();
+			} );
+
+			this.editable.attachListener( this.inline ? this.editable : this.frame, 'mouseout', function( evt ) {
+				moveBuffer.reset();
+			} );
+		},
+
+		/**
+		 * Stops observing mouse events attached by {@link #start}.
+		 */
+		stop: function() {
+			if ( this.listener )
+				this.listener.removeListener();
+		},
+
+		/**
+		 * Returns a range representing the relation, according to its element
+		 * and type.
+		 *
+		 * @param {Object} location Location containing unique identifier and type.
+		 * @returns {CKEDITOR.dom.range} Range representing the relation.
+		 */
+		getRange: (function() {
+			var where = {};
+
+			where[ CKEDITOR.LINEUTILS_BEFORE ] = CKEDITOR.POSITION_BEFORE_START;
+			where[ CKEDITOR.LINEUTILS_AFTER ] = CKEDITOR.POSITION_AFTER_END;
+			where[ CKEDITOR.LINEUTILS_INSIDE ] = CKEDITOR.POSITION_AFTER_START;
+
+			return function( location ) {
+				var range = this.editor.createRange();
+
+				range.moveToPosition( this.relations[ location.uid ].element, where[ location.type ] );
+
+				return range;
+			};
+		})(),
+
+		/**
+		 * Stores given relation in {@link #relations} object. Processes the relation
+		 * to normalize and avoid duplicates.
+		 *
+		 * @param {CKEDITOR.dom.element} el Element of the relation.
+		 * @param {Number} type Relation, one of `CKEDITOR.LINEUTILS_AFTER`, `CKEDITOR.LINEUTILS_BEFORE`, `CKEDITOR.LINEUTILS_INSIDE`.
+		 */
+		store: (function() {
+			function merge( el, type, relations ) {
+				var uid = el.getUniqueId();
+
+				if ( uid in relations )
+					relations[ uid ].type |= type;
+				else
+					relations[ uid ] = { element: el, type: type };
+			}
+
+			return function( el, type ) {
+				var alt;
+
+				// Normalization to avoid duplicates:
+				// CKEDITOR.LINEUTILS_AFTER becomes CKEDITOR.LINEUTILS_BEFORE of el.getNext().
+				if ( is( type, CKEDITOR.LINEUTILS_AFTER ) && isStatic( alt = el.getNext() ) && alt.isVisible() ) {
+					merge( alt, CKEDITOR.LINEUTILS_BEFORE, this.relations );
+					type ^= CKEDITOR.LINEUTILS_AFTER;
+				}
+
+				// Normalization to avoid duplicates:
+				// CKEDITOR.LINEUTILS_INSIDE becomes CKEDITOR.LINEUTILS_BEFORE of el.getFirst().
+				if ( is( type, CKEDITOR.LINEUTILS_INSIDE ) && isStatic( alt = el.getFirst() ) && alt.isVisible() ) {
+					merge( alt, CKEDITOR.LINEUTILS_BEFORE, this.relations );
+					type ^= CKEDITOR.LINEUTILS_INSIDE;
+				}
+
+				merge( el, type, this.relations );
+			};
+		})(),
+
+		/**
+		 * Traverses DOM tree towards root, checking all ancestors
+		 * with lookup rules, avoiding duplicates. Stores positive relations
+		 * in {@link #relations} object.
+		 *
+		 * @param {CKEDITOR.dom.element} el Element which is the starting point.
+		 */
+		traverseSearch: function( el ) {
+			var l, type, uid;
+
+			// Go down DOM towards root (or limit).
+			do {
+				uid = el.$[ 'data-cke-expando' ];
+
+				// This element was already visited and checked.
+				if ( uid && uid in this.relations )
+					continue;
+
+				if ( el.equals( this.editable ) )
+					return;
+
+				if ( isStatic( el ) ) {
+					// Collect all addresses yielded by lookups for that element.
+					for ( l in this.lookups ) {
+
+						if ( ( type = this.lookups[ l ]( el ) ) )
+							this.store( el, type );
+					}
+				}
+			} while ( !isLimit( el ) && ( el = el.getParent() ) )
+		},
+
+		/**
+		 * Iterates vertically pixel-by-pixel within given element starting
+		 * from given coordinates, searching for elements in the neighbourhood.
+		 * Once an element is found it is processed by {@link #traverseSearch}.
+		 *
+		 * @param {CKEDITOR.dom.element} el Element which is the starting point.
+		 * @param {Number} [x] Horizontal mouse coordinate relative to the viewport.
+		 * @param {Number} [y] Vertical mouse coordinate relative to the viewport.
+		 */
+		pixelSearch: (function() {
+			var contains = CKEDITOR.env.ie || CKEDITOR.env.webkit ?
+					function( el, found ) {
+						return el.contains( found );
+					}
+				:
+					function( el, found ) {
+						return !!( el.compareDocumentPosition( found ) & 16 );
+					};
+
+			// Iterates pixel-by-pixel from starting coordinates, moving by defined
+			// step and getting elementFromPoint in every iteration. Iteration stops when:
+			//  * A valid element is found.
+			//  * Condition function returns false (i.e. reached boundaries of viewport).
+			//  * No element is found (i.e. coordinates out of viewport).
+			//  * Element found is ascendant of starting element.
+			//
+			// @param {Object} doc Native DOM document.
+			// @param {Object} el Native DOM element.
+			// @param {Number} xStart Horizontal starting coordinate to use.
+			// @param {Number} yStart Vertical starting coordinate to use.
+			// @param {Number} step Step of the algorithm.
+			// @param {Function} condition A condition relative to current vertical coordinate.
+			function iterate( el, xStart, yStart, step, condition ) {
+				var y = yStart,
+					tryouts = 0,
+					found, uid;
+
+				while ( condition( y ) ) {
+					y += step;
+
+					// If we try and we try, and still nothing's found, let's end
+					// that party.
+					if ( ++tryouts == 25 )
+						return;
+
+					found = this.doc.$.elementFromPoint( xStart, y );
+
+					// Nothing found. This is crazy... but...
+					// It might be that a line, which is in different document,
+					// covers that pixel (elementFromPoint is doc-sensitive).
+					// Better let's have another try.
+					if ( !found )
+						continue;
+
+					// Still in the same element.
+					else if ( found == el ) {
+						tryouts = 0;
+						continue;
+					}
+
+					// Reached the edge of an element and found an ancestor or...
+					// A line, that covers that pixel. Better let's have another try.
+					else if ( !contains( el, found ) )
+						continue;
+
+					tryouts = 0;
+
+					// Found a valid element. Stop iterating.
+					if ( isStatic( ( found = new CKEDITOR.dom.element( found ) ) ) )
+						return found;
+				}
+			}
+
+			return function( el, x, y ) {
+				var paneHeight = this.win.getViewPaneSize().height,
+
+					// Try to find an element iterating *up* from the starting point.
+					neg = iterate.call( this, el.$, x, y, -1, function( y ) {
+							return y > 0;
+						} ),
+
+					// Try to find an element iterating *down* from the starting point.
+					pos = iterate.call( this, el.$, x, y, 1, function( y ) {
+							return y < paneHeight;
+						} );
+
+				if ( neg ) {
+					this.traverseSearch( neg );
+
+					// Iterate towards DOM root until neg is a direct child of el.
+					while ( !neg.getParent().equals( el ) )
+						neg = neg.getParent();
+				}
+
+				if ( pos ) {
+					this.traverseSearch( pos );
+
+					// Iterate towards DOM root until pos is a direct child of el.
+					while ( !pos.getParent().equals( el ) )
+						pos = pos.getParent();
+				}
+
+				// Iterate forwards starting from neg and backwards from
+				// pos to harvest all children of el between those elements.
+				// Stop when neg and pos meet each other or there's none of them.
+				// TODO (?) reduce number of hops forwards/backwards.
+				while ( neg || pos ) {
+					if ( neg )
+						neg = neg.getNext( isStatic );
+
+					if ( !neg || neg.equals( pos ) )
+						break;
+
+					this.traverseSearch( neg );
+
+					if ( pos )
+						pos = pos.getPrevious( isStatic );
+
+					if ( !pos || pos.equals( neg ) )
+						break;
+
+					this.traverseSearch( pos );
+				}
+			};
+		})(),
+
+		/**
+		 * Unline {@link #traverseSearch}, it collects **all** elements from editable's DOM tree
+		 * and runs lookups for every one of them, collecting relations.
+		 *
+		 * @returns {Object} {@link #relations}.
+		 */
+		greedySearch: function() {
+			this.relations = {};
+
+			var all = this.editable.getElementsByTag( '*' ),
+				i = 0,
+				el, type, l;
+
+			while ( ( el = all.getItem( i++ ) ) ) {
+				// Don't consider editable, as it might be inline,
+				// and i.e. checking it's siblings is pointless.
+				if ( el.equals( this.editable ) )
+					continue;
+
+				// Don't visit non-editable internals, for example widget's
+				// guts (above wrapper, below nested). Still check editable limits,
+				// as they are siblings with editable contents.
+				if ( !el.hasAttribute( 'contenteditable' ) && el.isReadOnly() )
+					continue;
+
+				if ( isStatic( el ) && el.isVisible() ) {
+					// Collect all addresses yielded by lookups for that element.
+					for ( l in this.lookups ) {
+						if ( ( type = this.lookups[ l ]( el ) ) )
+							this.store( el, type );
+					}
+				}
+			}
+
+			return this.relations;
+		}
+
+		/**
+		 * Relations express elements in DOM that match user-defined {@link #lookups}.
+		 * Every relation has its own `type` that determines whether
+		 * it refers to the space before, after or inside of `element`.
+		 * This object stores relations found by {@link #traverseSearch} or {@link #greedySearch}, structured
+		 * in the following way:
+		 *
+		 *		relations: {
+		 *			// Unique identifier of the element.
+		 *			Number: {
+		 *				// Element of this relation.
+		 *				element: {@link CKEDITOR.dom.element}
+		 *				// Conjunction of CKEDITOR.LINEUTILS_BEFORE, CKEDITOR.LINEUTILS_AFTER and CKEDITOR.LINEUTILS_INSIDE.
+		 *				type: Number
+		 *			},
+		 *			...
+		 *		}
+		 *
+		 * @property {Object} relations
+		 * @readonly
+		 */
+
+		/**
+		 * A set of user-defined functions used by Finder to check if an element
+		 * is a valid relation, belonging to {@link #relations}.
+		 * When the criterion is met, lookup returns a logical conjunction of `CKEDITOR.LINEUTILS_BEFORE`,
+		 * `CKEDITOR.LINEUTILS_AFTER` or `CKEDITOR.LINEUTILS_INSIDE`.
+		 *
+		 * Lookups are passed along with Finder's definition.
+		 *
+		 *		lookups: {
+		 *			'some lookup': function( el ) {
+		 *				if ( someCondition )
+		 *					return CKEDITOR.LINEUTILS_BEFORE;
+		 *			},
+		 *			...
+		 *		}
+		 *
+		 * @property {Object} lookups
+		 */
+	};
+
+
+	/**
+	 * An utility that analyses relations found by
+	 * CKEDITOR.plugins.lineutils.finder and locates them
+	 * in the viewport as horizontal lines of specific coordinates.
+	 *
+	 * @private
+	 * @class CKEDITOR.plugins.lineutils.locator
+	 * @constructor Creates a Locator class instance.
+	 * @param {CKEDITOR.editor} editor Editor instance that Locator belongs to.
+	 * @since 4.3
+	 */
+	function Locator( editor, def ) {
+		CKEDITOR.tools.extend( this, def, {
+			editor: editor
+		}, true );
+	}
+
+	Locator.prototype = {
+		/**
+		 * Localizes Y coordinate for all types of every single relation and stores
+		 * them in the object.
+		 *
+		 * @param {Object} relations {@link CKEDITOR.plugins.lineutils.finder#relations}.
+		 * @returns {Object} {@link #locations}.
+		 */
+		locate: (function() {
+			var rel, uid;
+
+			function locateSibling( rel, type ) {
+				var sib = rel.element[ type === CKEDITOR.LINEUTILS_BEFORE ? 'getPrevious' : 'getNext' ]();
+
+				// Return the middle point between siblings.
+				if ( sib && isStatic( sib ) ) {
+					rel.siblingRect = sib.getClientRect();
+
+					if ( type == CKEDITOR.LINEUTILS_BEFORE )
+						return ( rel.siblingRect.bottom + rel.elementRect.top ) / 2;
+					else
+						return ( rel.elementRect.bottom + rel.siblingRect.top ) / 2;
+				}
+
+				// If there's no sibling, use the edge of an element.
+				else {
+					if ( type == CKEDITOR.LINEUTILS_BEFORE )
+						return rel.elementRect.top;
+					else
+						return rel.elementRect.bottom;
+				}
+			}
+
+			return function( relations ) {
+				this.locations = {};
+
+				for ( uid in relations ) {
+					rel = relations[ uid ];
+					rel.elementRect = rel.element.getClientRect();
+
+					if ( is( rel.type, CKEDITOR.LINEUTILS_BEFORE ) )
+						this.store( uid, CKEDITOR.LINEUTILS_BEFORE, locateSibling( rel, CKEDITOR.LINEUTILS_BEFORE ) );
+
+					if ( is( rel.type, CKEDITOR.LINEUTILS_AFTER ) )
+						this.store( uid, CKEDITOR.LINEUTILS_AFTER, locateSibling( rel, CKEDITOR.LINEUTILS_AFTER ) );
+
+					// The middle point of the element.
+					if ( is( rel.type, CKEDITOR.LINEUTILS_INSIDE ) )
+						this.store( uid, CKEDITOR.LINEUTILS_INSIDE, ( rel.elementRect.top + rel.elementRect.bottom ) / 2 );
+				}
+
+				return this.locations;
+			};
+		})(),
+
+		/**
+		 * Calculates distances from every location to given vertical coordinate
+		 * and sorts locations according to that distance.
+		 *
+		 * @param {Number} y The vertical coordinate used for sorting, used as a reference.
+		 * @param {Number} [howMany] Determines the number "closest locations" to be returned.
+		 * @returns {Array} Sorted, array representation of {@link #locations}.
+		 */
+		sort: (function() {
+			var locations, sorted,
+				dist, uid, type, i;
+
+			function distance( y ) {
+				return Math.abs( y - locations[ uid ][ type ] );
+			}
+
+			return function( y, howMany ) {
+				locations = this.locations;
+				sorted = [];
+
+				for ( uid in locations ) {
+					for ( type in locations[ uid ] ) {
+						dist = distance( y );
+
+						// An array is empty.
+						if ( !sorted.length )
+							sorted.push( { uid: +uid, type: type, dist: dist } );
+						else {
+							// Sort the array on fly when it's populated.
+							for ( i = 0; i < sorted.length; i++ ) {
+								if ( dist < sorted[ i ].dist ) {
+									sorted.splice( i, 0, { uid: +uid, type: type, dist: dist } );
+									break;
+								}
+							}
+
+							// Nothing was inserted, so the distance is bigger than
+							// any of already calculated: push to the end.
+							if ( i == sorted.length )
+								sorted.push( { uid: +uid, type: type, dist: dist } );
+						}
+					}
+				}
+
+				if ( typeof howMany != 'undefined' )
+					return sorted.slice( 0, howMany );
+				else
+					return sorted;
+			};
+		})(),
+
+		/**
+		 * Stores the location in a collection.
+		 *
+		 * @param {Number} uid Unique identifier of the relation.
+		 * @param {Number} type One of `CKEDITOR.LINEUTILS_BEFORE`, `CKEDITOR.LINEUTILS_AFTER` and `CKEDITOR.LINEUTILS_INSIDE`.
+		 * @param {Number} y Vertical position of the relation.
+		 */
+		store: function( uid, type, y ) {
+			if ( !this.locations[ uid ] )
+				this.locations[ uid ] = {};
+
+			this.locations[ uid ][ type ] = y;
+		}
+
+		/**
+		 * @readonly
+		 * @property {Object} locations
+		 */
+	};
+
+	var tipCss = {
+			display: 'block',
+			width: '0px',
+			height: '0px',
+			'border-color': 'transparent',
+			'border-style': 'solid',
+			position: 'absolute',
+			top: '-6px'
+		},
+
+		lineStyle = {
+			height: '0px',
+			'border-top': '1px dashed red',
+			position: 'absolute',
+			'z-index': 9999
+		},
+
+		lineTpl =
+			'<div data-cke-lineutils-line="1" class="cke_reset_all" style="{lineStyle}">' +
+				'<span style="{tipLeftStyle}">&nbsp;</span>' +
+				'<span style="{tipRightStyle}">&nbsp;</span>' +
+			'</div>';
+
+	/**
+	 * An utility that draws horizontal lines in DOM according to locations
+	 * returned by CKEDITOR.plugins.lineutils.locator.
+	 *
+	 * @private
+	 * @class CKEDITOR.plugins.lineutils.liner
+	 * @constructor Creates a Liner class instance.
+	 * @param {CKEDITOR.editor} editor Editor instance that Liner belongs to.
+	 * @param {Object} def Liner's definition.
+	 * @since 4.3
+	 */
+	function Liner( editor, def ) {
+		var editable = editor.editable();
+
+		CKEDITOR.tools.extend( this, {
+			editor: editor,
+			editable: editable,
+			doc: editor.document,
+			win: editor.window,
+			container: CKEDITOR.document.getBody(),
+			winTop: CKEDITOR.document.getWindow()
+		}, def, true );
+
+		this.hidden = {};
+		this.visible = {};
+
+		this.inline = editable.isInline();
+
+		if ( !this.inline )
+			this.frame = this.win.getFrame();
+
+		this.queryViewport();
+
+		// Callbacks must be wrapped. Otherwise they're not attached
+		// to global DOM objects (i.e. topmost window) for every editor
+		// because they're treated as duplicates. They belong to the
+		// same prototype shared among Liner instances.
+		var queryViewport = CKEDITOR.tools.bind( this.queryViewport, this ),
+			hideVisible = CKEDITOR.tools.bind( this.hideVisible, this ),
+			removeAll = CKEDITOR.tools.bind( this.removeAll, this );
+
+		editable.attachListener( this.winTop, 'resize', queryViewport );
+		editable.attachListener( this.winTop, 'scroll', queryViewport );
+
+		editable.attachListener( this.winTop, 'resize', hideVisible );
+		editable.attachListener( this.win, 'scroll', hideVisible );
+
+		editable.attachListener( this.inline ? editable : this.frame, 'mouseout', function( evt ) {
+			var x = evt.data.$.clientX,
+				y = evt.data.$.clientY;
+
+			this.queryViewport();
+
+			// Check if mouse is out of the element (iframe/editable).
+			if ( x <= this.rect.left || x >= this.rect.right || y <= this.rect.top || y >= this.rect.bottom )
+				this.hideVisible();
+
+			// Check if mouse is out of the top-window vieport.
+			if ( x <= 0 || x >= this.winTopPane.width || y <= 0 || y >= this.winTopPane.height )
+				this.hideVisible();
+		}, this );
+
+		editable.attachListener( editor, 'resize', queryViewport );
+		editable.attachListener( editor, 'mode', removeAll );
+		editor.on( 'destroy', removeAll );
+
+		this.lineTpl = new CKEDITOR.template( lineTpl ).output( {
+			lineStyle: CKEDITOR.tools.writeCssText(
+				CKEDITOR.tools.extend( {}, lineStyle, this.lineStyle, true )
+			),
+			tipLeftStyle: CKEDITOR.tools.writeCssText(
+				CKEDITOR.tools.extend( {}, tipCss, {
+					left: '0px',
+					'border-left-color': 'red',
+					'border-width': '6px 0 6px 6px'
+				}, this.tipCss, this.tipLeftStyle, true )
+			),
+			tipRightStyle: CKEDITOR.tools.writeCssText(
+				CKEDITOR.tools.extend( {}, tipCss, {
+					right: '0px',
+					'border-right-color': 'red',
+					'border-width': '6px 6px 6px 0'
+				}, this.tipCss, this.tipRightStyle, true )
+			)
+		} );
+	}
+
+	Liner.prototype = {
+		/**
+		 * Permanently removes all lines (both hidden and visible) from DOM.
+		 */
+		removeAll: function() {
+			var l;
+
+			for ( l in this.hidden ) {
+				this.hidden[ l ].remove();
+				delete this.hidden[ l ];
+			}
+
+			for ( l in this.visible ) {
+				this.visible[ l ].remove();
+				delete this.visible[ l ];
+			}
+		},
+
+		/**
+		 * Hides a given line.
+		 *
+		 * @param {CKEDITOR.dom.element} line The line to be hidden.
+		 */
+		hideLine: function( line ) {
+			var uid = line.getUniqueId();
+
+			line.hide();
+
+			this.hidden[ uid ] = line;
+			delete this.visible[ uid ];
+		},
+
+		/**
+		 * Shows a given line.
+		 *
+		 * @param {CKEDITOR.dom.element} line The line to be shown.
+		 */
+		showLine: function( line ) {
+			var uid = line.getUniqueId();
+
+			line.show();
+
+			this.visible[ uid ] = line;
+			delete this.hidden[ uid ];
+		},
+
+		/**
+		 * Hides all visible lines.
+		 */
+		hideVisible: function() {
+			for ( var l in this.visible )
+				this.hideLine( this.visible[ l ] );
+		},
+
+		/**
+		 * Shows a line at given location.
+		 *
+		 * @param {Object} location Location object containing unique identifier of the relation
+		 * and its type. Usually returned by {@link CKEDITOR.plugins.lineutils.locator#sort}.
+		 * @param {Function} [callback] A callback to be called once the line is shown.
+		 */
+		placeLine: function( location, callback ) {
+			var styles, line, l;
+
+			// No style means that line would be out of viewport.
+			if ( !( styles = this.getStyle( location.uid, location.type ) ) )
+				return;
+
+			// Search for any visible line of a different hash first.
+			// It's faster to re-position visible line than to show it.
+			for ( l in this.visible ) {
+				if ( this.visible[ l ].getCustomData( 'hash' ) !== this.hash ) {
+					line = this.visible[ l ];
+					break;
+				}
+			}
+
+			// Search for any hidden line of a different hash.
+			if ( !line ) {
+				for ( l in this.hidden ) {
+					if ( this.hidden[ l ].getCustomData( 'hash' ) !== this.hash ) {
+						this.showLine( ( line = this.hidden[ l ] ) );
+						break;
+					}
+				}
+			}
+
+			// If no line available, add the new one.
+			if ( !line )
+				this.showLine( ( line = this.addLine() ) );
+
+			// Mark the line with current hash.
+			line.setCustomData( 'hash', this.hash );
+
+			// Mark the line as visible.
+			this.visible[ line.getUniqueId() ] = line;
+
+			line.setStyles( styles );
+
+			callback && callback( line );
+		},
+
+		/**
+		 * Creates style set to be used by the line, representing a particular
+		 * relation (location).
+		 *
+		 * @param {Number} uid Unique identifier of the relation.
+		 * @param {Number} type Type of the relation.
+		 * @returns {Object} An object containing styles.
+		 */
+		getStyle: function( uid, type ) {
+			var rel = this.relations[ uid ],
+				loc = this.locations[ uid ][ type ],
+				styles = {},
+				hdiff;
+
+			// Line should be between two elements.
+			if ( rel.siblingRect )
+				styles.width = Math.max( rel.siblingRect.width, rel.elementRect.width );
+			// Line is relative to a single element.
+			else
+				styles.width = rel.elementRect.width;
+
+			// Let's calculate the vertical position of the line.
+			if ( this.inline )
+				styles.top = loc + this.winTopScroll.y;
+			else
+				styles.top = this.rect.top + this.winTopScroll.y + loc;
+
+			// Check if line would be vertically out of the viewport.
+			if ( styles.top - this.winTopScroll.y < this.rect.top || styles.top - this.winTopScroll.y > this.rect.bottom )
+				return false;
+
+			// Now let's calculate the horizontal alignment (left and width).
+			if ( this.inline )
+				styles.left = rel.elementRect.left;
+			else {
+				if ( rel.elementRect.left > 0 )
+					styles.left = this.rect.left + rel.elementRect.left;
+
+				// H-scroll case. Left edge of element may be out of viewport.
+				else {
+					styles.width += rel.elementRect.left;
+					styles.left = this.rect.left;
+				}
+
+				// H-scroll case. Right edge of element may be out of viewport.
+				if ( ( hdiff = styles.left + styles.width - ( this.rect.left + this.winPane.width ) ) > 0 )
+					styles.width -= hdiff;
+			}
+
+			// Finally include horizontal scroll of the global window.
+			styles.left += this.winTopScroll.x;
+
+			// Append 'px' to style values.
+			for ( var style in styles )
+				styles[ style ] = CKEDITOR.tools.cssLength( styles[ style ] );
+
+			return styles;
+		},
+
+		/**
+		 * Adds a new line to DOM.
+		 *
+		 * @returns {CKEDITOR.dom.element} A brand-new line.
+		 */
+		addLine: function() {
+			var line = CKEDITOR.dom.element.createFromHtml( this.lineTpl );
+
+			line.appendTo( this.container );
+
+			return line;
+		},
+
+		/**
+		 * Assigns an unique hash to the instance that is later utilized
+		 * to tell unwanted lines from new ones. This method **must** be called
+		 * before a new set of relations is to be visualized so {@link #cleanup}
+		 * eventually hides obsolete lines. This is because lines
+		 * are re-used between {@link #placeLine} calls and the number of
+		 * necessary ones may vary according to the number of relations.
+		 *
+		 * @param {Object} relations {@link CKEDITOR.plugins.lineutils.finder#relations}.
+		 * @param {Object} locations {@link CKEDITOR.plugins.lineutils.locator#locations}.
+		 */
+		prepare: function( relations, locations ) {
+			this.relations = relations;
+			this.locations = locations;
+			this.hash = Math.random();
+		},
+
+		/**
+		 * Hides all visible lines that don't belong to current hash
+		 * and no-longer represent relations (locations).
+		 *
+		 * See also: {@link #prepare}.
+		 */
+		cleanup: function() {
+			var line;
+
+			for ( var l in this.visible ) {
+				line = this.visible[ l ];
+
+				if ( line.getCustomData( 'hash' ) !== this.hash )
+					this.hideLine( line );
+			}
+		},
+
+		/**
+		 * Queries dimensions of the viewport, editable, frame etc.
+		 * that are used for correct positioning of the line.
+		 */
+		queryViewport: function() {
+			this.winPane = this.win.getViewPaneSize();
+			this.winTopScroll = this.winTop.getScrollPosition();
+			this.winTopPane = this.winTop.getViewPaneSize();
+
+			if ( this.inline )
+				this.rect = this.editable.getClientRect();
+			else
+				this.rect = this.frame.getClientRect();
+		}
+	};
+
+	function is( type, flag ) {
+		return type & flag;
+	}
+
+	var floats = { left:1,right:1,center:1 },
+		positions = { absolute:1,fixed:1 };
+
+	function isElement( node ) {
+		return node && node.type == CKEDITOR.NODE_ELEMENT;
+	}
+
+	function isFloated( el ) {
+		return !!( floats[ el.getComputedStyle( 'float' ) ] || floats[ el.getAttribute( 'align' ) ] );
+	}
+
+	function isPositioned( el ) {
+		return !!positions[ el.getComputedStyle( 'position' ) ];
+	}
+
+	function isLimit( node ) {
+		return isElement( node ) && node.getAttribute( 'contenteditable' ) == 'true';
+	}
+
+	function isStatic( node ) {
+		return isElement( node ) && !isFloated( node ) && !isPositioned( node );
+	}
+
+	/**
+	 * Global namespace holding definitions and global helpers for the lineutils plugin.
+	 *
+	 * @private
+	 * @class
+	 * @singleton
+	 * @since 4.3
+	 */
+	CKEDITOR.plugins.lineutils = {
+		finder: Finder,
+		locator: Locator,
+		liner: Liner
+	};
+})();
\ No newline at end of file
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/dev/console.js b/profiles/commons/libraries/ckeditor/plugins/widget/dev/console.js
new file mode 100644
index 0000000..1fa5a3a
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/dev/console.js
@@ -0,0 +1,129 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+
+'use strict';
+
+(function() {
+
+	CKCONSOLE.add( 'widget', {
+		panels: [
+			{
+				type: 'box',
+				content: '<ul class="ckconsole_list ckconsole_value" data-value="instances"></ul>',
+
+				refresh: function( editor ) {
+					var instances = obj2Array( editor.widgets.instances );
+
+					return {
+						header: 'Instances (' + instances.length + ')',
+						instances: generateInstancesList( instances )
+					};
+				},
+
+				refreshOn: function( editor, refresh ) {
+					editor.widgets.on( 'instanceCreated', function( evt ) {
+						refresh();
+
+						evt.data.on( 'data', refresh );
+					} );
+
+					editor.widgets.on( 'instanceDestroyed', refresh );
+				}
+			},
+
+			{
+				type: 'box',
+				content:
+					'<ul class="ckconsole_list">' +
+						'<li>focused: <span class="ckconsole_value" data-value="focused"></span></li>' +
+						'<li>selected: <span class="ckconsole_value" data-value="selected"></span></li>' +
+					'</ul>',
+
+				refresh: function( editor ) {
+					var focused = editor.widgets.focused,
+						selected = editor.widgets.selected,
+						selectedIds = [];
+
+					for ( var i = 0; i < selected.length; ++i )
+						selectedIds.push( selected[ i ].id );
+
+					return {
+						header: 'Focus &amp; selection',
+						focused: focused ? 'id: ' + focused.id : '-',
+						selected: selectedIds.length ? 'id: ' + selectedIds.join( ', id: ' ) : '-'
+					};
+				},
+
+				refreshOn: function( editor, refresh ) {
+					editor.on( 'selectionCheck', refresh, null, null, 999 );
+				}
+			},
+
+			{
+				type: 'log',
+
+				on: function( editor, log, logFn ) {
+					// Add all listeners with high priorities to log
+					// messages in the correct order when one event depends on another.
+					// E.g. selectionChange triggers widget selection - if this listener
+					// for selectionChange will be executed later than that one, then order
+					// will be incorrect.
+
+					editor.on( 'selectionChange', function( evt ) {
+						var msg = 'selection change',
+							sel = evt.data.selection,
+							el = sel.getSelectedElement(),
+							widget;
+
+						if ( el && ( widget = editor.widgets.getByElement( el, true ) ) )
+							msg += ' (id: ' + widget.id + ')';
+
+						log( msg );
+					}, null, null, 1 );
+
+					editor.widgets.on( 'instanceDestroyed', function( evt ) {
+						log( 'instance destroyed (id: ' + evt.data.id + ')' );
+					}, null, null, 1 );
+
+					editor.widgets.on( 'instanceCreated', function( evt ) {
+						log( 'instance created (id: ' + evt.data.id + ')' );
+					}, null, null, 1 );
+
+					editor.widgets.on( 'widgetFocused', function( evt ) {
+						log( 'widget focused (id: ' + evt.data.widget.id + ')' );
+					}, null, null, 1 );
+
+					editor.widgets.on( 'widgetBlurred', function( evt ) {
+						log( 'widget blurred (id: ' + evt.data.widget.id + ')' );
+					}, null, null, 1 );
+
+					editor.widgets.on( 'checkWidgets', logFn( 'checking widgets' ), null, null, 1 );
+					editor.widgets.on( 'checkSelection', logFn( 'checking selection' ), null, null, 1 );
+				}
+			}
+		]
+	} );
+
+	function generateInstancesList( instances ) {
+		var html = '',
+			instance;
+
+		for ( var i = 0; i < instances.length; ++i ) {
+			instance = instances[ i ];
+			html += itemTpl.output( { id: instance.id, name: instance.name, data: JSON.stringify( instance.data ) } );
+		}
+		return html;
+	}
+
+	function obj2Array( obj ) {
+		var arr = [];
+		for ( var id in obj )
+			arr.push( obj[ id ] );
+
+		return arr;
+	}
+
+	var itemTpl = new CKEDITOR.template( '<li>id: <code>{id}</code>, name: <code>{name}</code>, data: <code>{data}</code></li>' );
+})();
\ No newline at end of file
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/images/handle.png b/profiles/commons/libraries/ckeditor/plugins/widget/images/handle.png
new file mode 100644
index 0000000..8d1c976
Binary files /dev/null and b/profiles/commons/libraries/ckeditor/plugins/widget/images/handle.png differ
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/ca.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/ca.js
new file mode 100644
index 0000000..5f9c9dc
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/ca.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'ca', {
+	'move': 'Clicar i arrossegar per moure'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/cs.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/cs.js
new file mode 100644
index 0000000..ecdac92
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/cs.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'cs', {
+	'move': 'Klepněte a táhněte pro přesunutí'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/cy.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/cy.js
new file mode 100644
index 0000000..b1059dd
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/cy.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'cy', {
+	'move': 'Clcio a llusgo i symud'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/el.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/el.js
new file mode 100644
index 0000000..2148395
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/el.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'el', {
+	'move': 'Κάνετε κλικ και σύρετε το ποντίκι για να μετακινήστε'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/en-gb.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/en-gb.js
new file mode 100644
index 0000000..75a23fc
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/en-gb.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'en-gb', {
+	'move': 'Click and drag to move'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/en.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/en.js
new file mode 100644
index 0000000..a55fd2a
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/en.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'en', {
+	'move': 'Click and drag to move'
+} );
\ No newline at end of file
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/es.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/es.js
new file mode 100644
index 0000000..71b366b
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/es.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'es', {
+	'move': 'Dar clic y arrastrar para mover'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/fi.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/fi.js
new file mode 100644
index 0000000..be7587b
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/fi.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'fi', {
+	'move': 'Siirrä klikkaamalla ja raahaamalla'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/hu.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/hu.js
new file mode 100644
index 0000000..bbb4513
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/hu.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'hu', {
+	'move': 'Kattints és húzd a mozgatáshoz'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/ja.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/ja.js
new file mode 100644
index 0000000..0b276d7
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/ja.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'ja', {
+	'move': 'ドラッグして移動'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/km.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/km.js
new file mode 100644
index 0000000..5ad0529
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/km.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'km', {
+	'move': 'ចុច​ហើយ​ទាញ​ដើម្បី​ផ្លាស់​ទី'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/nb.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/nb.js
new file mode 100644
index 0000000..8504148
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/nb.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'nb', {
+	'move': 'Klikk og dra for å flytte'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/nl.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/nl.js
new file mode 100644
index 0000000..e09c265
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/nl.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'nl', {
+	'move': 'Klik en sleep om te verplaatsen'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/no.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/no.js
new file mode 100644
index 0000000..a6731aa
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/no.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'no', {
+	'move': 'Klikk og dra for å flytte'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/ru.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/ru.js
new file mode 100644
index 0000000..afc02c7
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/ru.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'ru', {
+	'move': 'Нажмите и перетащите'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/sv.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/sv.js
new file mode 100644
index 0000000..7940805
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/sv.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'sv', {
+	'move': 'Klicka och drag för att flytta'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/uk.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/uk.js
new file mode 100644
index 0000000..83e0a55
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/uk.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'uk', {
+	'move': 'Клікніть і потягніть для переміщення'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/zh-cn.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/zh-cn.js
new file mode 100644
index 0000000..828731c
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/zh-cn.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'zh-cn', {
+	'move': '点击并拖拽以移动'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/lang/zh.js b/profiles/commons/libraries/ckeditor/plugins/widget/lang/zh.js
new file mode 100644
index 0000000..7d4aeec
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/lang/zh.js
@@ -0,0 +1,7 @@
+/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+CKEDITOR.plugins.setLang( 'widget', 'zh', {
+	'move': '拖曳以移動'
+} );
diff --git a/profiles/commons/libraries/ckeditor/plugins/widget/plugin.js b/profiles/commons/libraries/ckeditor/plugins/widget/plugin.js
new file mode 100644
index 0000000..b232444
--- /dev/null
+++ b/profiles/commons/libraries/ckeditor/plugins/widget/plugin.js
@@ -0,0 +1,3096 @@
+﻿/**
+ * @license Copyright (c) 2003-2013, CKSource - Frederico Knabben. All rights reserved.
+ * For licensing, see LICENSE.md or http://ckeditor.com/license
+ */
+
+/**
+ * @fileOverview [Widget](http://ckeditor.com/addon/widget) plugin.
+ */
+
+'use strict';
+
+(function() {
+
+	var DRAG_HANDLER_SIZE = 15;
+
+	CKEDITOR.plugins.add( 'widget', {
+		lang: 'ca,cs,cy,el,en,en-gb,es,fi,hu,ja,km,nb,nl,no,ru,sv,uk,zh,zh-cn', // %REMOVE_LINE_CORE%
+		requires: 'lineutils,clipboard',
+		onLoad: function() {
+			CKEDITOR.addCss(
+				'.cke_widget_wrapper{' +
+					'position:relative;' +
+					'outline:none' +
+				'}' +
+				'.cke_widget_inline{' +
+					'display:inline-block' +
+				'}' +
+				'.cke_widget_wrapper:hover>.cke_widget_element{' +
+					'outline:2px solid yellow;' +
+					'cursor:default' +
+				'}' +
+				'.cke_widget_wrapper:hover .cke_widget_editable{' +
+					'outline:2px solid yellow' +
+				'}' +
+				'.cke_widget_wrapper.cke_widget_focused>.cke_widget_element,' +
+				// We need higher specificity than hover style.
+				'.cke_widget_wrapper .cke_widget_editable.cke_widget_editable_focused{' +
+					'outline:2px solid #ace' +
+				'}' +
+				'.cke_widget_editable{' +
+					'cursor:text' +
+				'}' +
+				'.cke_widget_drag_handler_container{' +
+					'position:absolute;' +
+					'width:' + DRAG_HANDLER_SIZE + 'px;' +
+					'height:0;' +
+					'opacity:0.75;' +
+					'transition:height 0s 0.2s;' + // Delay hiding drag handler.
+					// Prevent drag handler from being misplaced (#11198).
+					'line-height:0' +
+				'}' +
+				'.cke_widget_wrapper:hover>.cke_widget_drag_handler_container{' +
+					'height:' + DRAG_HANDLER_SIZE + 'px;' +
+					'transition:none' +
+				'}' +
+				'.cke_widget_drag_handler_container:hover{' +
+					'opacity:1' +
+				'}'+
+				'img.cke_widget_drag_handler{' +
+					'cursor:move;' +
+					'width:' + DRAG_HANDLER_SIZE + 'px;' +
+					'height:' + DRAG_HANDLER_SIZE + 'px;' +
+					'display:inline-block' +
+				'}' +
+				'.cke_widget_mask{' +
+					'position:absolute;' +
+					'top:0;' +
+					'left:0;' +
+					'width:100%;' +
+					'height:100%;' +
+					'display:block' +
+				'}' +
+				'.cke_editable.cke_widget_dragging, .cke_editable.cke_widget_dragging *{' +
+					'cursor:move !important' +
+				'}'
+			);
+		},
+
+		beforeInit: function( editor ) {
+			/**
+			 * An instance of widget repository. It contains all
+			 * {@link CKEDITOR.plugins.widget.repository#registered registered widget definitions} and
+			 * {@link CKEDITOR.plugins.widget.repository#instances initialized instances}.
+			 *
+			 *		editor.widgets.add( 'someName', {
+			 *			// Widget definition...
+			 *		} );
+			 *
+			 *		editor.widgets.registered.someName; // -> Widget definition
+			 *
+			 * @since 4.3
+			 * @readonly
+			 * @property {CKEDITOR.plugins.widget.repository} widgets
+			 * @member CKEDITOR.editor
+			 */
+			editor.widgets = new Repository( editor );
+		},
+
+		afterInit: function( editor ) {
+			addWidgetButtons( editor );
+			setupContextMenu( editor );
+		}
+	} );
+
+	/**
+	 * Widget repository. It keeps track of all {@link #registered registered widget definitions} and
+	 * {@link #instances initialized instances}. An instance of the repository is available under
+	 * the {@link CKEDITOR.editor#widgets} property.
+	 *
+	 * @class CKEDITOR.plugins.widget.repository
+	 * @mixins CKEDITOR.event
+	 * @constructor Creates a widget repository instance. Note that the widget plugin automatically
+	 * creates a repository instance which is available under the {@link CKEDITOR.editor#widgets} property.
+	 * @param {CKEDITOR.editor} editor The editor instance for which the repository will be created.
+	 */
+	function Repository( editor ) {
+		/**
+		 * The editor instance for which this repository was created.
+		 *
+		 * @readonly
+		 * @property {CKEDITOR.editor} editor
+		 */
+		this.editor = editor;
+
+		/**
+		 * A hash of registered widget definitions (definition name => {@link CKEDITOR.plugins.widget.definition}).
+		 *
+		 * To register a definition use the {@link #add} method.
+		 *
+		 * @readonly
+		 */
+		this.registered = {};
+
+		/**
+		 * An object containing initialized widget instances (widget id => {@link CKEDITOR.plugins.widget}).
+		 *
+		 * @readonly
+		 */
+		this.instances = {};
+
+		/**
+		 * An array of selected widget instances.
+		 *
+		 * @readonly
+		 * @property {CKEDITOR.plugins.widget[]} selected
+		 */
+		this.selected = [];
+
+		/**
+		 * The focused widget instance. See also {@link CKEDITOR.plugins.widget#event-focus}
+		 * and {@link CKEDITOR.plugins.widget#event-blur} events.
+		 *
+		 *		editor.on( 'selectionChange', function() {
+		 *			if ( editor.widgets.focused ) {
+		 *				// Do something when a widget is focused...
+		 *			}
+		 *		} );
+		 *
+		 * @readonly
+		 * @property {CKEDITOR.plugins.widget} focused
+		 */
+		this.focused = null;
+
+		/**
+		 * The widget instance that contains the nested editable which is currently focused.
+		 *
+		 * @readonly
+		 * @property {CKEDITOR.plugins.widget} widgetHoldingFocusedEditable
+		 */
+		this.widgetHoldingFocusedEditable = null;
+
+		this._ = {
+			nextId: 0,
+			upcasts: [],
+			filters: {}
+		};
+
+		setupWidgetsLifecycle( this );
+		setupSelectionObserver( this );
+		setupMouseObserver( this );
+		setupKeyboardObserver( this );
+		setupDragAndDrop( this );
+		setupNativeCutAndCopy( this );
+	}
+
+	Repository.prototype = {
+		/**
+		 * Minimum interval between selection checks.
+		 *
+		 * @private
+		 */
+		MIN_SELECTION_CHECK_INTERVAL: 500,
+
+		/**
+		 * Adds a widget definition to the repository. Fires the {@link CKEDITOR.editor#widgetDefinition} event
+		 * which allows to modify the widget definition which is going to be registered.
+		 *
+		 * @param {String} name The name of the widget definition.
+		 * @param {CKEDITOR.plugins.widget.definition} widgetDef Widget definition.
+		 * @returns {CKEDITOR.plugins.widget.definition}
+		 */
+		add: function( name, widgetDef ) {
+			// Create prototyped copy of original widget definition, so we won't modify it.
+			widgetDef = CKEDITOR.tools.prototypedCopy( widgetDef );
+			widgetDef.name = name;
+
+			widgetDef._ = widgetDef._ || {};
+
+			this.editor.fire( 'widgetDefinition', widgetDef );
+
+			if ( widgetDef.template )
+				widgetDef.template = new CKEDITOR.template( widgetDef.template );
+
+			addWidgetCommand( this.editor, widgetDef );
+			addWidgetProcessors( this, widgetDef );
+
+			// Register widget automatically if it does not have a button.
+			if ( !widgetDef.button )
+				this.editor.addFeature( widgetDef );
+
+			this.registered[ name ] = widgetDef;
+
+			return widgetDef;
+		},
+
+		/**
+		 * Checks the selection to update widget states (selection and focus).
+		 *
+		 * This method is triggered by the {@link #event-checkSelection} event.
+		 */
+		checkSelection: function() {
+			var sel = this.editor.getSelection(),
+				selectedElement = sel.getSelectedElement(),
+				updater = stateUpdater( this ),
+				widget;
+
+			// Widget is focused so commit and finish checking.
+			if ( selectedElement && ( widget = this.getByElement( selectedElement, true ) ) )
+				return updater.focus( widget ).select( widget ).commit();
+
+			var range = sel.getRanges()[ 0 ];
+
+			// No ranges or collapsed range mean that nothing is selected, so commit and finish checking.
+			if ( !range || range.collapsed )
+				return updater.commit();
+
+			// Range is not empty, so create walker checking for wrappers.
+			var walker = new CKEDITOR.dom.walker( range ),
+				wrapper;
+
+			walker.evaluator = isWidgetWrapper2;
+
+			while ( ( wrapper = walker.next() ) )
+				updater.select( this.getByElement( wrapper ) );
+
+			updater.commit();
+		},
+
+		/**
+		 * Checks if all widget instances are still present in the DOM.
+		 * Destroys those instances that are not present.
+		 * Reinitializes widgets on widget wrappers for which widget instances
+		 * cannot be found.
+		 *
+		 * This method triggers the {@link #event-checkWidgets} event whose listeners
+		 * can cancel the method's execution or modify its options.
+		 *
+		 * @param [options] The options object.
+		 * @param {Boolean} [options.initOnlyNew] Initializes widgets only on newly wrapped
+		 * widget elements (those which still have the `cke_widget_new` class). When this option is
+		 * set to `true`, widgets which were invalidated (e.g. by replacing with a cloned DOM structure)
+		 * will not be reinitialized. This makes the check faster.
+		 * @param {Boolean} [options.focusInited] If only one widget is initialized by
+		 * the method, it will be focused.
+		 */
+		checkWidgets: function( options ) {
+			this.fire( 'checkWidgets', CKEDITOR.tools.copy( options || {} ) );
+		},
+
+		/**
+		 * Removes the widget from the editor and moves the selection to the closest
+		 * editable position if the widget was focused before.
+		 *
+		 * @param {CKEDITOR.plugins.widget} widget The widget instance to be deleted.
+		 */
+		del: function( widget ) {
+			if ( this.focused === widget ) {
+				var editor = widget.editor,
+					range = editor.createRange(),
+					found;
+
+				// If haven't found place for caret on the default side,
+				// try to find it on the other side.
+				if ( !( found = range.moveToClosestEditablePosition( widget.wrapper, true ) ) )
+					found = range.moveToClosestEditablePosition( widget.wrapper, false );
+
+				if ( found )
+					editor.getSelection().selectRanges( [ range ] );
+			}
+
+			widget.wrapper.remove();
+			this.destroy( widget, true );
+		},
+
+		/**
+		 * Destroys the widget instance.
+		 *
+		 * @param {CKEDITOR.plugins.widget} widget The widget instance to be destroyed.
+		 * @param {Boolean} [offline] Whether the widget is offline (detached from the DOM tree) &mdash;
+		 * in this case the DOM (attributes, classes, etc.) will not be cleaned up.
+		 */
+		destroy: function( widget, offline ) {
+			if ( this.widgetHoldingFocusedEditable === widget )
+				setFocusedEditable( this, widget, null, offline );
+
+			widget.destroy( offline );
+			delete this.instances[ widget.id ];
+			this.fire( 'instanceDestroyed', widget );
+		},
+
+		/**
+		 * Destroys all widget instances.
+		 *
+		 * @param {Boolean} [offline] Whether the widgets are offline (detached from the DOM tree) &mdash;
+		 * in this case the DOM (attributes, classes, etc.) will not be cleaned up.
+		 */
+		destroyAll: function( offline ) {
+			var instances = this.instances,
+				widget;
+
+			for ( var id in instances ) {
+				widget = instances[ id ];
+				this.destroy( widget, offline );
+			}
+		},
+
+		/**
+		 * Finalizes a process of widget creation. This includes:
+		 *
+		 * * inserting widget element into editor,
+		 * * marking widget instance as ready (see {@link CKEDITOR.plugins.widget#event-ready}),
+		 * * focusing widget instance.
+		 *
+		 * This method is used by the default widget's command and is called
+		 * after widget's dialog (if set) is closed. It may also be used in a
+		 * customized process of widget creation and insertion.
+		 *
+		 *		widget.once( 'edit', function() {
+		 *			// Finalize creation only of not ready widgets.
+		 *			if ( widget.isReady() )
+		 *				return;
+		 *
+		 *			// Cancel edit event to prevent automatic widget insertion.
+		 *			evt.cancel();
+		 *
+		 *			CustomDialog.open( widget.data, function saveCallback( savedData ) {
+		 *				// Cache the container, because widget may be destroyed while saving data,
+		 *				// if this process will require some deep transformations.
+		 *				var container = widget.wrapper.getParent();
+		 *
+		 *				widget.setData( savedData );
+		 *
+		 *				// Widget will be retrieved from container and inserted into editor.
+		 *				editor.widgets.finalizeCreation( container );
+		 *			} );
+		 *		} );
+		 *
+		 * @param {CKEDITOR.dom.element/CKEDITOR.dom.documentFragment} container The element
+		 * or document fragment which contains widget wrapper. The container is used, so before
+		 * finalizing creation the widget can be freely transformed (even destroyed and reinitialized).
+		 */
+		finalizeCreation: function( container ) {
+			var wrapper = container.getFirst();
+			if ( wrapper && isWidgetWrapper2( wrapper ) ) {
+				this.editor.insertElement( wrapper );
+
+				var widget = this.getByElement( wrapper );
+				// Fire postponed #ready event.
+				widget.ready = true;
+				widget.fire( 'ready' );
+				widget.focus();
+			}
+		},
+
+		/**
+		 * Finds a widget instance which contains a given element. The element will be the {@link CKEDITOR.plugins.widget#wrapper wrapper}
+		 * of the returned widget or a descendant of this {@link CKEDITOR.plugins.widget#wrapper wrapper}.
+		 *
+		 *		editor.widgets.getByElement( someWidget.wrapper ); // -> someWidget
+		 *		editor.widgets.getByElement( someWidget.parts.caption ); // -> someWidget
+		 *
+		 *		// Check wrapper only:
+		 *		editor.widgets.getByElement( someWidget.wrapper, true ); // -> someWidget
+		 *		editor.widgets.getByElement( someWidget.parts.caption, true ); // -> null
+		 *
+		 * @param {CKEDITOR.dom.element} element The element to be checked.
+		 * @param {Boolean} [checkWrapperOnly] If set to `true`, the method will not check wrappers' descendants.
+		 * @returns {CKEDITOR.plugins.widget} The widget instance or `null`.
+		 */
+		getByElement: function( element, checkWrapperOnly ) {
+			if ( !element )
+				return null;
+
+			var wrapper;
+
+			for ( var id in this.instances ) {
+				wrapper = this.instances[ id ].wrapper;
+				if ( wrapper.equals( element ) || ( !checkWrapperOnly && wrapper.contains( element ) ) )
+					return this.instances[ id ];
+			}
+
+			return null;
+		},
+
+		/**
+		 * Initializes a widget on a given element if the widget has not been initialized on it yet.
+		 *
+		 * @param {CKEDITOR.dom.element} element The future widget element.
+		 * @param {String/CKEDITOR.plugins.widget.definition} [widgetDef] Name of a widget or a widget definition.
+		 * The widget definition should be previously registered by using the
+		 * {@link CKEDITOR.plugins.widget.repository#add} method.
+		 * @param [startupData] Widget startup data (has precedence over default one).
+		 * @returns {CKEDITOR.plugins.widget} The widget instance or `null` if a widget could not be initialized on
+		 * a given element.
+		 */
+		initOn: function( element, widgetDef, startupData ) {
+			if ( !widgetDef )
+				widgetDef = this.registered[ element.data( 'widget' ) ];
+			else if ( typeof widgetDef == 'string' )
+				widgetDef = this.registered[ widgetDef ];
+
+			if ( !widgetDef )
+				return null;
+
+			// Wrap element if still wasn't wrapped (was added during runtime by method that skips dataProcessor).
+			var wrapper = this.wrapElement( element, widgetDef.name );
+
+			if ( wrapper ) {
+				// Check if widget wrapper is new (widget hasn't been initialized on it yet).
+				// This class will be removed by widget constructor to avoid locking snapshot twice.
+				if ( wrapper.hasClass( 'cke_widget_new' ) ) {
+					var widget = new Widget( this, this._.nextId++, element, widgetDef, startupData );
+
+					// Widget could be destroyed when initializing it.
+					if ( widget.isInited() ) {
+						this.instances[ widget.id ] = widget;
+
+						return widget;
+					} else
+						return null;
+				}
+
+				// Widget already has been initialized, so try to get widget by element.
+				// Note - it may happen that other instance will returned than the one created above,
+				// if for example widget was destroyed and reinitialized.
+				return this.getByElement( element );
+			}
+
+			// No wrapper means that there's no widget for this element.
+			return null;
+		},
+
+		/**
+		 * Initializes widgets on all elements which were wrapped by {@link #wrapElement} and
+		 * have not been initialized yet.
+		 *
+		 * @param {CKEDITOR.dom.element} [container=editor.editable()] The container which will be checked for not
+		 * initialized widgets. Defaults to editor's {@link CKEDITOR.editor#editable editable} element.
+		 * @returns {CKEDITOR.plugins.widget[]} Array of widget instances which have been initialized.
+		 */
+		initOnAll: function( container ) {
+			var newWidgets = ( container || this.editor.editable() ).find( '.cke_widget_new' ),
+				newInstances = [],
+				instance;
+
+			for ( var i = newWidgets.count(); i--; ) {
+				instance = this.initOn( newWidgets.getItem( i ).getFirst( isWidgetElement2 ) );
+				if ( instance )
+					newInstances.push( instance );
+			}
+
+			return newInstances;
+		},
+
+		/**
+		 * Wraps an element with a widget's non-editable container.
+		 *
+		 * If this method is called on an {@link CKEDITOR.htmlParser.element}, then it will
+		 * also take care of fixing the DOM after wrapping (the wrapper may not be allowed in element's parent).
+		 *
+		 * @param {CKEDITOR.dom.element/CKEDITOR.htmlParser.element} element The widget element to be wrapped.
+		 * @param {String} [widgetName] The name of the widget definition. Defaults to element's `data-widget`
+		 * attribute value.
+		 * @returns {CKEDITOR.dom.element/CKEDITOR.htmlParser.element} The wrapper element or `null` if
+		 * the widget definition of this name is not registered.
+		 */
+		wrapElement: function( element, widgetName ) {
+			var wrapper = null,
+				widgetDef,
+				isInline;
+
+			if ( element instanceof CKEDITOR.dom.element ) {
+				widgetDef = this.registered[ widgetName || element.data( 'widget' ) ];
+				if ( !widgetDef )
+					return null;
+
+				// Do not wrap already wrapped element.
+				wrapper = element.getParent();
+				if ( wrapper && wrapper.type == CKEDITOR.NODE_ELEMENT && wrapper.data( 'cke-widget-wrapper' ) )
+					return wrapper;
+
+				// If attribute isn't already set (e.g. for pasted widget), set it.
+				if ( !element.hasAttribute( 'data-cke-widget-keep-attr' ) )
+					element.data( 'cke-widget-keep-attr', element.data( 'widget' ) ? 1 : 0 );
+				if ( widgetName )
+					element.data( 'widget', widgetName );
+
+				isInline = isWidgetInline( widgetDef, element.getName() );
+
+				wrapper = new CKEDITOR.dom.element( isInline ? 'span' : 'div' );
+				wrapper.setAttributes( getWrapperAttributes( isInline ) );
+
+				wrapper.data( 'cke-display-name', widgetDef.pathName ? widgetDef.pathName : element.getName() );
+
+				// Replace element unless it is a detached one.
+				if ( element.getParent( true ) )
+					wrapper.replace( element );
+				element.appendTo( wrapper );
+			}
+			else if ( element instanceof CKEDITOR.htmlParser.element ) {
+				widgetDef = this.registered[ widgetName || element.attributes[ 'data-widget' ] ];
+				if ( !widgetDef )
+					return null;
+
+				wrapper = element.parent;
+				if ( wrapper && wrapper.type == CKEDITOR.NODE_ELEMENT && wrapper.attributes[ 'data-cke-widget-wrapper' ] )
+					return wrapper;
+
+				// If attribute isn't already set (e.g. for pasted widget), set it.
+				if ( !( 'data-cke-widget-keep-attr' in element.attributes ) )
+					element.attributes[ 'data-cke-widget-keep-attr' ] = element.attributes[ 'data-widget' ] ? 1 : 0;
+				if ( widgetName )
+					element.attributes[ 'data-widget' ] = widgetName;
+
+				isInline = isWidgetInline( widgetDef, element.name );
+
+				wrapper = new CKEDITOR.htmlParser.element( isInline ? 'span' : 'div', getWrapperAttributes( isInline ) );
+
+				wrapper.attributes[ 'data-cke-display-name' ] = widgetDef.pathName ? widgetDef.pathName : element.name;
+
+				var parent = element.parent,
+					index;
+
+				// Don't detach already detached element.
+				if ( parent ) {
+					index = element.getIndex();
+					element.remove();
+				}
+
+				wrapper.add( element );
+
+				// Insert wrapper fixing DOM (splitting parents if wrapper is not allowed inside them).
+				parent && insertElement( parent, index, wrapper );
+			}
+
+			return wrapper;
+		},
+
+		// Expose for tests.
+		_tests_getNestedEditable: getNestedEditable,
+		_tests_createEditableFilter: createEditableFilter
+	};
+
+	CKEDITOR.event.implementOn( Repository.prototype );
+
+	/**
+	 * An event fired when a widget instance is created, but before it is fully initialized.
+	 *
+	 * @event instanceCreated
+	 * @param {CKEDITOR.plugins.widget} data The widget instance.
+	 */
+
+	/**
+	 * An event fired when a widget instance was destroyed.
+	 *
+	 * See also {@link CKEDITOR.plugins.widget#event-destroy}.
+	 *
+	 * @event instanceDestroyed
+	 * @param {CKEDITOR.plugins.widget} data The widget instance.
+	 */
+
+	/**
+	 * An event fired to trigger the selection check.
+	 *
+	 * See the {@link #method-checkSelection} method.
+	 *
+	 * @event checkSelection
+	 */
+
+	/**
+	 * An event fired by the the {@link #method-checkWidgets} method.
+	 *
+	 * It can be canceled in order to stop the {@link #method-checkWidgets}
+	 * method execution or the event listener can modify the method's options.
+	 *
+	 * @event checkWidgets
+	 * @param [data]
+	 * @param {Boolean} [data.initOnlyNew] Initialize widgets only on newly wrapped
+	 * widget elements (those which still have the `cke_widget_new` class). When this option is
+	 * set to `true`, widgets which were invalidated (e.g. by replacing with a cloned DOM structure)
+	 * will not be reinitialized. This makes the check faster.
+	 * @param {Boolean} [data.focusInited] If only one widget is initialized by
+	 * the method, it will be focused.
+	 */
+
+
+	/**
+	 * An instance of a widget. Together with {@link CKEDITOR.plugins.widget.repository} these
+	 * two classes constitute the core of the Widget System.
+	 *
+	 * Note that neither the repository nor the widget instances can be created by using their constructors.
+	 * A repository instance is automatically set up by the Widget plugin and is accessible under
+	 * {@link CKEDITOR.editor#widgets}, while widget instances are created and destroyed by the repository.
+	 *
+	 * To create a widget, first you need to {@link CKEDITOR.plugins.widget.repository#add register} its
+	 * {@link CKEDITOR.plugins.widget.definition definition}:
+	 *
+	 *		editor.widgets.add( 'simplebox', {
+	 *			upcast: function( element ) {
+	 *				// Defines which elements will become widgets.
+	 *				if ( element.hasClass( 'simplebox' ) )
+	 *					return true;
+	 *			},
+	 *			init: function() {
+	 *				// ...
+	 *			}
+	 *		} );
+	 *
+	 * Once the widget definition is registered, widgets will be automatically
+	 * created when loading data:
+	 *
+	 *		editor.setData( '<div class="simplebox">foo</div>', function() {
+	 *			console.log( editor.widgets.instances ); // -> An object containing one instance.
+	 *		} );
+	 *
+	 * It is also possible to create instances during runtime by using a command
+	 * (if a {@link CKEDITOR.plugins.widget.definition#template} property was defined):
+	 *
+	 *		// You can execute an automatically defined command to
+	 *		// insert a new simplebox widget or edit the one currently focused.
+	 *		editor.execCommand( 'simplebox' );
+	 *
+	 * Or in a completely custom way:
+	 *
+	 *		var element = editor.createElement( 'div' );
+	 *		editor.insertElement( element );
+	 *		var widget = editor.widgets.initOn( element, 'simplebox' );
+	 *
+	 * @since 4.3
+	 * @class CKEDITOR.plugins.widget
+	 * @mixins CKEDITOR.event
+	 * @extends CKEDITOR.plugins.widget.definition
+	 * @constructor Creates an instance of the widget class. Do not use it directly, but instead initialize widgets
+	 * by using the {@link CKEDITOR.plugins.widget.repository#initOn} method or by the upcasting system.
+	 * @param {CKEDITOR.plugins.widget.repository} widgetsRepo
+	 * @param {Number} id Unique ID of this widget instance.
+	 * @param {CKEDITOR.dom.element} element The widget element.
+	 * @param {CKEDITOR.plugins.widget.definition} widgetDef Widget's registered definition.
+	 * @param [startupData] Initial widget data. This data object will overwrite the default data and
+	 * the data loaded from the DOM.
+	 */
+	function Widget( widgetsRepo, id, element, widgetDef, startupData ) {
+		var editor = widgetsRepo.editor;
+
+		// Extend this widget with widgetDef-specific methods and properties.
+		CKEDITOR.tools.extend( this, widgetDef, {
+			/**
+			 * The editor instance.
+			 *
+			 * @readonly
+			 * @property {CKEDITOR.editor}
+			 */
+			editor: editor,
+
+			/**
+			 * This widget's unique (per editor instance) ID.
+			 *
+			 * @readonly
+			 * @property {Number}
+			 */
+			id: id,
+
+			/**
+			 * Whether this widget is an inline widget (based on an inline element unless
+			 * forced otherwise by {@link CKEDITOR.plugins.widget.definition#inline}).
+			 *
+			 * @readonly
+			 * @property {Boolean}
+			 */
+			inline: element.getParent().getName() == 'span',
+
+			/**
+			 * The widget element &mdash; the element on which the widget was initialized.
+			 *
+			 * @readonly
+			 * @property {CKEDITOR.dom.element} element
+			 */
+			element: element,
+
+			/**
+			 * Widget's data object.
+			 *
+			 * The data can only be set by using the {@link #setData} method.
+			 * Changes made to the data fire the {@link #event-data} event.
+			 *
+			 * @readonly
+			 */
+			data: CKEDITOR.tools.extend( {}, typeof widgetDef.defaults == 'function' ? widgetDef.defaults() : widgetDef.defaults ),
+
+			/**
+			 * Indicates if a widget is data-ready. Set to `true` when data from all sources
+			 * ({@link CKEDITOR.plugins.widget.definition#defaults}, set in the
+			 * {@link #init} method, loaded from the widget's element and startup data coming from the constructor)
+			 * are finally loaded. This is immediately followed by the first {@link #event-data}.
+			 *
+			 * @readonly
+			 */
+			dataReady: false,
+
+			/**
+			 * Whether a widget instance was initialized. This means that:
+			 *
+			 * * An instance was created,
+			 * * Its properties were set,
+			 * * The `init` method was executed.
+			 *
+			 * **Note**: The first {@link #event-data} event could not be fired yet which
+			 * means that the widget's DOM has not been set up yet. Wait for the {@link #event-ready}
+			 * event to be notified when a widget is fully initialized and ready.
+			 *
+			 * **Note**: Use the {@link #isInited} method to check whether a widget is initialized and
+			 * has not been destroyed.
+			 *
+			 * @readonly
+			 */
+			inited: false,
+
+			/**
+			 * Whether a widget instance is ready. This means that the widget is {@link #inited} and
+			 * that its DOM was finally set up.
+			 *
+			 * **Note:** Use the {@link #isReady} method to check whether a widget is ready and
+			 * has not been destroyed.
+			 *
+			 * @readonly
+			 */
+			ready: false,
+
+			// Revert what widgetDef could override (automatic #edit listener).
+			edit: Widget.prototype.edit,
+
+			/**
+			 * The nested editable element which is currently focused.
+			 *
+			 * @readonly
+			 * @property {CKEDITOR.plugins.widget.nestedEditable}
+			 */
+			focusedEditable: null,
+
+			/**
+			 * The widget definition from which this instance was created.
+			 *
+			 * @readonly
+			 * @property {CKEDITOR.plugins.widget.definition} definition
+			 */
+			definition: widgetDef,
+
+			/**
+			 * Link to the widget repository which created this instance.
+			 *
+			 * @readonly
+			 * @property {CKEDITOR.plugins.widget.repository} repository
+			 */
+			repository: widgetsRepo,
+
+			draggable: widgetDef.draggable !== false,
+
+			// WAAARNING: Overwrite widgetDef's priv object, because otherwise violent unicorn's gonna visit you.
+			_: {
+				downcastFn: ( widgetDef.downcast && typeof widgetDef.downcast == 'string' ) ?
+					widgetDef.downcasts[ widgetDef.downcast ] : widgetDef.downcast
+			}
+		}, true );
+
+		/**
+		 * An object of widget component elements.
+		 *
+		 * For every `partName => selector` pair in {@link CKEDITOR.plugins.widget.definition#parts},
+		 * one `partName => element` pair is added to this object during the widget initialization.
+		 *
+		 * @readonly
+		 * @property {Object} parts
+		 */
+
+		/**
+		 * The template which will be used to create a new widget element (when the widget's command is executed).
+		 * It will be populated with {@link #defaults default values}.
+		 *
+		 * @readonly
+		 * @property {CKEDITOR.template} template
+		 */
+
+		/**
+		 * The widget wrapper &mdash; a non-editable `div` or `span` element (depending on {@link #inline})
+		 * which is a parent of the {@link #element} and widget compontents like the drag handler and the {@link #mask}.
+		 * It is the outermost widget element.
+		 *
+		 * @readonly
+		 * @property {CKEDITOR.dom.element} wrapper
+		 */
+
+		// #11074 - IE8 throws exceptions when dragging widget using the native method.
+		if ( this.inline && CKEDITOR.env.ie && CKEDITOR.env.version < 9 )
+			this.draggable = false;
+
+		widgetsRepo.fire( 'instanceCreated', this );
+
+		setupWidget( this, widgetDef );
+
+		this.init && this.init();
+
+		// Finally mark widget as inited.
+		this.inited = true;
+
+		setupWidgetData( this, startupData );
+
+		// If at some point (e.g. in #data listener) widget hasn't been destroyed
+		// and widget is already attached to document then fire #ready.
+		if ( this.isInited() && editor.editable().contains( this.wrapper ) ) {
+			this.ready = true;
+			this.fire( 'ready' );
+		}
+	}
+
+	Widget.prototype = {
+		/**
+		 * Destroys this widget instance.
+		 *
+		 * Use {@link CKEDITOR.plugins.widget.repository#destroy} when possible instead of this method.
+		 *
+		 * This method fires the {#event-destroy} event.
+		 *
+		 * @param {Boolean} [offline] Whether a widget is offline (detached from the DOM tree) &mdash;
+		 * in this case the DOM (attributes, classes, etc.) will not be cleaned up.
+		 */
+		destroy: function( offline ) {
+			var editor = this.editor;
+
+			this.fire( 'destroy' );
+
+			if ( this.editables ) {
+				for ( var name in this.editables )
+					this.destroyEditable( name, offline );
+			}
+
+			if ( !offline ) {
+				if ( this.element.data( 'cke-widget-keep-attr' ) == '0' )
+					this.element.removeAttribute( 'data-widget' );
+				this.element.removeAttributes( [ 'data-cke-widget-data', 'data-cke-widget-keep-attr' ] );
+				this.element.removeClass( 'cke_widget_element' );
+				this.element.replace( this.wrapper );
+			}
+
+			this.wrapper = null;
+		},
+
+		/**
+		 * Destroys a nested editable.
+		 *
+		 * @param {String} editableName Nested editable name.
+		 * @param {Boolean} [offline] See {@link #method-destroy} method.
+		 */
+		destroyEditable: function( editableName, offline ) {
+			var editable = this.editables[ editableName ];
+
+			editable.removeListener( 'focus', onEditableFocus );
+			editable.removeListener( 'blur', onEditableBlur );
+			this.editor.focusManager.remove( editable );
+
+			if ( !offline ) {
+				editable.removeClass( 'cke_widget_editable' );
+				editable.removeClass( 'cke_widget_editable_focused' );
+				editable.removeAttributes( [ 'contenteditable', 'data-cke-widget-editable', 'data-cke-enter-mode' ] );
+			}
+
+			delete this.editables[ editableName ];
+		},
+
+		/**
+		 * Starts widget editing.
+		 *
+		 * This method fires the {@link CKEDITOR.plugins.widget#event-edit} event
+		 * which may be cancelled in order to prevent it from opening a dialog window.
+		 *
+		 * The dialog window name is obtained from the event's data `dialog` property or
+		 * from {@link CKEDITOR.plugins.widget.definition#dialog}.
+		 */
+		edit: function() {
+			var evtData = { dialog: this.dialog },
+				that = this;
+
+			// Edit event was blocked, but there's no dialog to be automatically opened.
+			if ( !this.fire( 'edit', evtData ) || !evtData.dialog )
+				return;
+
+			this.editor.openDialog( evtData.dialog, function( dialog ) {
+				var showListener,
+					okListener;
+
+				// Allow to add a custom dialog handler.
+				if ( !that.fire( 'dialog', dialog ) )
+					return;
+
+				showListener = dialog.on( 'show', function() {
+					dialog.setupContent( that );
+				} );
+
+				okListener = dialog.on( 'ok', function() {
+					// Commit dialog's fields, but prevent from
+					// firing data event for every field. Fire only one,
+					// bulk event at the end.
+					var dataChanged,
+						dataListener = that.on( 'data', function( evt ) {
+							dataChanged = 1;
+							evt.cancel();
+						}, null, null, 0 );
+
+					// Create snapshot preceeding snapshot with changed widget...
+					// TODO it should not be required, but it is and I found similar
+					// code in dialog#ok listener in dialog/plugin.js.
+					that.editor.fire( 'saveSnapshot' );
+					dialog.commitContent( that );
+
+					dataListener.removeListener();
+					if ( dataChanged ) {
+						that.fire( 'data', that.data );
+						that.editor.fire( 'saveSnapshot' );
+					}
+				} );
+
+				dialog.once( 'hide', function() {
+					showListener.removeListener();
+					okListener.removeListener();
+				} );
+			} );
+		},
+
+		/**
+		 * Initializes a nested editable.
+		 *
+		 * **Note**: Only elements from {@link CKEDITOR.dtd#$editable} may become editables.
+		 *
+		 * @param {String} editableName The nested editable name.
+		 * @param {CKEDITOR.plugins.widget.nestedEditable.definition} definition The definition of the nested editable.
+		 * @returns {Boolean} Whether an editable was successfully initialized.
+		 */
+		initEditable: function( editableName, definition ) {
+			var editable = this.wrapper.findOne( definition.selector );
+
+			if ( editable && editable.is( CKEDITOR.dtd.$editable ) ) {
+				editable = new NestedEditable( this.editor, editable, {
+					filter: createEditableFilter.call( this.repository, this.name, editableName, definition )
+				} );
+				this.editables[ editableName ] = editable;
+
+				editable.setAttributes( {
+					contenteditable: 'true',
+					'data-cke-widget-editable': editableName,
+					'data-cke-enter-mode': editable.enterMode
+				} );
+
+				if ( editable.filter )
+					editable.data( 'cke-filter', editable.filter.id );
+
+				editable.addClass( 'cke_widget_editable' );
+				// This class may be left when d&ding widget which
+				// had focused editable. Clean this class here, not in
+				// cleanUpWidgetElement for performance and code size reasons.
+				editable.removeClass( 'cke_widget_editable_focused' );
+
+				if ( definition.pathName )
+					editable.data( 'cke-display-name', definition.pathName );
+
+				this.editor.focusManager.add( editable );
+				editable.on( 'focus', onEditableFocus, this );
+				CKEDITOR.env.ie && editable.on( 'blur', onEditableBlur, this );
+
+				// Finally, process editable's data. This data wasn't processed when loading
+				// editor's data, becuase they need to be processed separately, with its own filters and settings.
+				editable.setData( editable.getHtml() );
+
+				return true;
+			}
+
+			return false;
+		},
+
+		/**
+		 * Checks if a widget has already been initialized and has not been destroyed yet.
+		 *
+		 * See {@link #inited} for more details.
+		 *
+		 * @returns {Boolean}
+		 */
+		isInited: function() {
+			return !!( this.wrapper && this.inited );
+		},
+
+		/**
+		 * Checks if a widget is ready and has not been destroyed yet.
+		 *
+		 * See {@link #property-ready} for more details.
+		 *
+		 * @returns {Boolean}
+		 */
+		isReady: function() {
+			return this.isInited() && this.ready;
+		},
+
+		/**
+		 * Focuses a widget by selecting it.
+		 */
+		focus: function() {
+			var sel = this.editor.getSelection();
+
+			if ( sel )
+				sel.fake( this.wrapper );
+
+			// Always focus editor (not only when focusManger.hasFocus is false) (because of #10483).
+			this.editor.focus();
+		},
+
+		/**
+		 * Sets widget value(s) in the {@link #property-data} object.
+		 * If the given value(s) modifies current ones, the {@link #event-data} event is fired.
+		 *
+		 *		this.setData( 'align', 'left' );
+		 *		this.data.align; // -> 'left'
+		 *
+		 *		this.setData( { align: 'right', opened: false } );
+		 *		this.data.align; // -> 'right'
+		 *		this.data.opened; // -> false
+		 *
+		 * Set values are stored in {@link #element}'s attribute (`data-cke-widget-data`),
+		 * in a JSON string, therefore {@link #property-data} should contain
+		 * only serializable data.
+		 *
+		 * @param {String/Object} keyOrData
+		 * @param {Object} value
+		 * @chainable
+		 */
+		setData: function( key, value ) {
+			var data = this.data,
+				modified = 0;
+
+			if ( typeof key == 'string' ) {
+				if ( data[ key ] !== value ) {
+					data[ key ] = value;
+					modified = 1;
+				}
+			}
+			else {
+				var newData = key;
+
+				for ( key in newData ) {
+					if ( data[ key ] !== newData[ key ] ) {
+						modified = 1;
+						data[ key ] = newData[ key ];
+					}
+				}
+			}
+
+			// Block firing data event and overwriting data element before setupWidgetData is executed.
+			if ( modified && this.dataReady ) {
+				writeDataToElement( this );
+				this.fire( 'data', data );
+			}
+
+			return this;
+		},
+
+		/**
+		 * Changes the widget's focus state. This method is executed automatically after
+		 * a widget has been focused by the {@link #method-focus} method or a selection was moved
+		 * out of the widget.
+		 *
+		 * @param {Boolean} selected Whether to select or deselect this widget.
+		 * @chainable
+		 */
+		setFocused: function( focused ) {
+			this.wrapper[ focused ? 'addClass' : 'removeClass' ]( 'cke_widget_focused' );
+			this.fire( focused ? 'focus' : 'blur' );
+			return this;
+		},
+
+		/**
+		 * Changes the widget's select state. This method is executed automatically after
+		 * a widget has been selected by the {@link #method-focus} method or the selection
+		 * was moved out of widget.
+		 *
+		 * @param {Boolean} selected Whether to select or deselect this widget.
+		 * @chainable
+		 */
+		setSelected: function( selected ) {
+			this.wrapper[ selected ? 'addClass' : 'removeClass' ]( 'cke_widget_selected' );
+			this.fire(  selected ? 'select' : 'deselect' );
+			return this;
+		}
+	};
+
+	CKEDITOR.event.implementOn( Widget.prototype );
+
+	/**
+	 * An event fired when a widget is ready (fully initialized). This event is fired after:
+	 *
+	 * * {@link #init} is called,
+	 * * The first {@link #event-data} event is fired,
+	 * * A widget is attached to the document.
+	 *
+	 * Therefore, in case of widget creation with a command which opens a dialog window, this event
+	 * will be delayed after the dialog window is closed and the widget is finally inserted into the document.
+	 *
+	 * **Note**: If your widget does not use automatic dialog window binding (i.e. you open the dialog window manually)
+	 * or another situation in which the widget wrapper is not attached to document at the time when it is
+	 * initialized occurs, you need to take care of firing {@link #event-ready} yourself.
+	 *
+	 * See also {@link #property-ready} and {@link #property-inited} properties, and
+	 * {@link #isReady} and {@link #isInited} methods.
+	 *
+	 * @event ready
+	 */
+
+	/**
+	 * An event fired when a widget is about to be destroyed, but before it is
+	 * fully torn down.
+	 *
+	 * @event destroy
+	 */
+
+	/**
+	 * An event fired when a widget is focused.
+	 *
+	 * Widget can be focused by executing {@link #method-focus}.
+	 *
+	 * @event focus
+	 */
+
+	/**
+	 * An event fired when a widget is blurred.
+	 *
+	 * @event blur
+	 */
+
+	/**
+	 * An event fired when a widget is selected.
+	 *
+	 * @event select
+	 */
+
+	/**
+	 * An event fired when a widget is deselected.
+	 *
+	 * @event deselect
+	 */
+
+	/**
+	 * An event fired by the {@link #method-edit} method. It can be canceled
+	 * in order to stop the default action (opening a dialog window and/or
+	 * {@link CKEDITOR.plugins.widget.repository#finalizeCreation finalizing widget creation}).
+	 *
+	 * @event edit
+	 * @param data
+	 * @param {String} data.dialog Defaults to {@link CKEDITOR.plugins.widget.definition#dialog}
+	 * and can be changed or set by the listener.
+	 */
+
+	/**
+	 * An event fired when a dialog window for widget editing is opened.
+	 * This event can be cancelled in order to handle the editing dialog in a custom manner.
+	 *
+	 * @event dialog
+	 * @param {CKEDITOR.dialog} data The opened dialog window instance.
+	 */
+
+	/**
+	 * An event fired when a key is pressed on a focused widget.
+	 * This event is forwarded from the {@link CKEDITOR.editor#key} event and
+	 * has the ability to block editor keystrokes if it is cancelled.
+	 *
+	 * @event key
+	 * @param data
+	 * @param {Number} data.keyCode A number representing the key code (or combination).
+	 */
+
+	/**
+	 * An event fired when a widget is double clicked.
+	 *
+	 * @event doubleclick
+	 * @param data
+	 * @param {CKEDITOR.dom.element} data.element The double clicked element.
+	 */
+
+	/**
+	 * An event fired when the context menu is opened for a widget.
+	 *
+	 * @event contextMenu
+	 * @param data The object contaning context menu options to be added
+	 * for this widget. See {@link CKEDITOR.plugins.contextMenu#addListener}.
+	 */
+
+	/**
+	 * An event fired when the widget data changed. See the {@link #setData} method and the {@link #property-data} property.
+	 *
+	 * @event data
+	 */
+
+
+
+	/**
+	 * The wrapper class for editable elements inside widgets.
+	 *
+	 * Do not use directly. Use {@link CKEDITOR.plugins.widget.definition#editables} or
+	 * {@link CKEDITOR.plugins.widget#initEditable}.
+	 *
+	 * @class CKEDITOR.plugins.widget.nestedEditable
+	 * @extends CKEDITOR.dom.element
+	 * @constructor
+	 * @param {CKEDITOR.editor} editor
+	 * @param {CKEDITOR.dom.element} element
+	 * @param config
+	 * @param {CKEDITOR.filter} [config.filter]
+	 */
+	function NestedEditable( editor, element, config ) {
+		// Call the base constructor.
+		CKEDITOR.dom.element.call( this, element.$ );
+		this.editor = editor;
+		var filter = this.filter = config.filter;
+
+		// If blockless editable - always use BR mode.
+		if ( !CKEDITOR.dtd[ this.getName() ].p )
+			this.enterMode = this.shiftEnterMode = CKEDITOR.ENTER_BR;
+		else {
+			this.enterMode = filter ? filter.getAllowedEnterMode( editor.enterMode ) : editor.enterMode;
+			this.shiftEnterMode = filter ? filter.getAllowedEnterMode( editor.shiftEnterMode, true ) : editor.shiftEnterMode;
+		}
+	}
+
+	NestedEditable.prototype = CKEDITOR.tools.extend( CKEDITOR.tools.prototypedCopy( CKEDITOR.dom.element.prototype ), {
+		/**
+		 * Sets the editable data. The data will be passed through the {@link CKEDITOR.editor#dataProcessor}
+		 * and the {@link CKEDITOR.editor#filter}. This ensures that the data was filtered and prepared to be
+		 * edited like the {@link CKEDITOR.editor#method-setData editor data}.
+		 *
+		 * @param {String} data
+		 */
+		setData: function( data ) {
+			data = this.editor.dataProcessor.toHtml( data, {
+				context: this.getName(),
+				filter: this.filter,
+				enterMode: this.enterMode
+			} );
+			this.setHtml( data );
+		},
+
+		/**
+		 * Gets the editable data. Like {@link #setData}, this method will process and filter the data.
+		 *
+		 * @returns {String}
+		 */
+		getData: function() {
+			return this.editor.dataProcessor.toDataFormat( this.getHtml(), {
+				context: this.getName(),
+				filter: this.filter,
+				enterMode: this.enterMode
+			} );
+		}
+	} );
+
+	/**
+	 * The editor instance.
+	 *
+	 * @readonly
+	 * @property {CKEDITOR.editor} editor
+	 */
+
+	/**
+	 * The filter instance if allowed content rules were defined.
+	 *
+	 * @readonly
+	 * @property {CKEDITOR.filter} filter
+	 */
+
+	/**
+	 * The enter mode active in this editable.
+	 * It is determined from editable's name (whether it is a blockless editable),
+	 * its allowed content rules (if defined) and the default editor's mode.
+	 *
+	 * @readonly
+	 * @property {Number} enterMode
+	 */
+
+	/**
+	 * The shift enter move active in this editable.
+	 *
+	 * @readonly
+	 * @property {Number} shiftEnterMode
+	 */
+
+
+	//
+	// REPOSITORY helpers -----------------------------------------------------
+	//
+
+	function addWidgetButtons( editor ) {
+		var widgets = editor.widgets.registered,
+			widget,
+			widgetName,
+			widgetButton;
+
+		for ( widgetName in widgets ) {
+			widget = widgets[ widgetName ];
+
+			// Create button if defined.
+			widgetButton = widget.button;
+			if ( widgetButton && editor.ui.addButton ) {
+				editor.ui.addButton( CKEDITOR.tools.capitalize( widget.name, true ), {
+					label: widgetButton,
+					command: widget.name,
+					toolbar: 'insert,10'
+				} );
+			}
+		}
+	}
+
+	// Create a command creating and editing widget.
+	//
+	// @param editor
+	// @param {CKEDITOR.plugins.widget.definition} widgetDef
+	function addWidgetCommand( editor, widgetDef ) {
+		editor.addCommand( widgetDef.name, {
+			exec: function() {
+				var focused = editor.widgets.focused;
+				// If a widget of the same type is focused, start editing.
+				if ( focused && focused.name == widgetDef.name )
+					focused.edit();
+				// Otherwise...
+				// ... use insert method is was defined.
+				else if ( widgetDef.insert )
+					widgetDef.insert();
+				// ... or create a brand-new widget from template.
+				else if ( widgetDef.template ) {
+					var defaults = typeof widgetDef.defaults == 'function' ? widgetDef.defaults() : widgetDef.defaults,
+						element = CKEDITOR.dom.element.createFromHtml( widgetDef.template.output( defaults ) ),
+						instance,
+						wrapper = editor.widgets.wrapElement( element, widgetDef.name ),
+						temp = new CKEDITOR.dom.documentFragment( wrapper.getDocument() );
+
+					// Append wrapper to a temporary document. This will unify the environment
+					// in which #data listeners work when creating and editing widget.
+					temp.append( wrapper );
+					instance = editor.widgets.initOn( element, widgetDef );
+
+					// Instance could be destroyed during initialization.
+					// In this case finalize creation if some new widget
+					// was left in temporary document fragment.
+					if ( !instance ) {
+						finalizeCreation();
+						return;
+					}
+
+					// Listen on edit to finalize widget insertion.
+					//
+					// * If dialog was set, then insert widget after dialog was successfully saved or destroy this
+					// temporary instance.
+					// * If dialog wasn't set and edit wasn't canceled, insert widget.
+					var editListener = instance.once( 'edit', function( evt ) {
+						if ( evt.data.dialog ) {
+							instance.once( 'dialog', function( evt ) {
+								var dialog = evt.data,
+									okListener,
+									cancelListener;
+
+								// Finalize creation AFTER (20) new data was set.
+								okListener = dialog.once( 'ok', finalizeCreation, null, null, 20 );
+
+								cancelListener = dialog.once( 'cancel', function() {
+									editor.widgets.destroy( instance, true );
+								} );
+
+								dialog.once( 'hide', function() {
+									okListener.removeListener();
+									cancelListener.removeListener();
+								} );
+							} );
+						}
+						// Dialog hasn't been set, so insert widget now.
+						else
+							finalizeCreation();
+					}, null, null, 999 );
+
+					instance.edit();
+
+					// Remove listener in case someone canceled it before this
+					// listener was executed.
+					editListener.removeListener();
+				}
+
+				function finalizeCreation() {
+					editor.widgets.finalizeCreation( temp );
+				}
+			},
+
+			refresh: function( editor, path ) {
+				// Disable widgets' commands inside nested editables -
+				// check if blockLimit is a nested editable or a descendant of any.
+				this.setState( getNestedEditable( editor.editable(), path.blockLimit ) ? CKEDITOR.TRISTATE_DISABLED : CKEDITOR.TRISTATE_OFF );
+			},
+			// A hack to force command refreshing on context change.
+			context: 'div',
+
+			allowedContent: widgetDef.allowedContent,
+			requiredContent: widgetDef.requiredContent,
+			contentForms: widgetDef.contentForms,
+			contentTransformations: widgetDef.contentTransformations
+		} );
+	}
+
+	function addWidgetProcessors( widgetsRepo, widgetDef ) {
+		var upcast = widgetDef.upcast,
+			upcasts;
+
+		if ( !upcast )
+			return;
+
+		// Multiple upcasts defined in string.
+		if ( typeof upcast == 'string' ) {
+			upcasts = upcast.split( ',' );
+			while ( upcasts.length )
+				widgetsRepo._.upcasts.push( [ widgetDef.upcasts[ upcasts.pop() ], widgetDef.name ] );
+		}
+		// Single rule which is automatically activated.
+		else
+			widgetsRepo._.upcasts.push( [ upcast, widgetDef.name ] );
+	}
+
+	function blurWidget( widgetsRepo, widget ) {
+		widgetsRepo.focused = null;
+
+		if ( widget.isInited() ) {
+			// Widget could be destroyed in the meantime - e.g. data could be set.
+			widgetsRepo.fire( 'widgetBlurred', { widget: widget } );
+			widget.setFocused( false );
+		}
+	}
+
+	function checkWidgets( evt ) {
+		var options = evt.data;
+
+		if ( this.editor.mode != 'wysiwyg' )
+			return;
+
+		var editable = this.editor.editable(),
+			instances = this.instances,
+			newInstances, i, count, wrapper;
+
+		if ( !editable )
+			return;
+
+		// Remove widgets which have no corresponding elements in DOM.
+		for ( i in instances ) {
+			if ( !editable.contains( instances[ i ].wrapper ) )
+				this.destroy( instances[ i ], true );
+		}
+
+		// Init on all (new) if initOnlyNew option was passed.
+		if ( options && options.initOnlyNew )
+			newInstances = this.initOnAll();
+		else {
+			var wrappers = editable.find( '.cke_widget_wrapper' );
+			newInstances = [];
+
+			// Create widgets on existing wrappers if they do not exists.
+			for ( i = 0, count = wrappers.count(); i < count; i++ ) {
+				wrapper = wrappers.getItem( i );
+
+				// Check if there's no instance for this widget and that
+				// wrapper is not inside some temporary element like copybin (#11088).
+				if ( !this.getByElement( wrapper, true ) && !findParent( wrapper, isTemp2 ) ) {
+					// Add cke_widget_new class because otherwise
+					// widget will not be created on such wrapper.
+					wrapper.addClass( 'cke_widget_new' );
+					newInstances.push( this.initOn( wrapper.getFirst( isWidgetElement2 ) ) );
+				}
+			}
+		}
+
+		// If only single widget was initialized and focusInited was passed, focus it.
+		if ( options && options.focusInited && newInstances.length == 1 )
+			newInstances[ 0 ].focus();
+	}
+
+	// Unwraps widget element and clean up element.
+	//
+	// This function is used to clean up pasted widgets.
+	// It should have similar result to widget#destroy plus
+	// some additional adjustments, specific for pasting.
+	//
+	// @param {CKEDITOR.htmlParser.element} el
+	function cleanUpWidgetElement( el ) {
+		var parent = el.parent;
+		if ( parent.type == CKEDITOR.NODE_ELEMENT && parent.attributes[ 'data-cke-widget-wrapper' ] )
+			parent.replaceWith( el );
+	}
+
+	// Similar to cleanUpWidgetElement, but works on DOM and finds
+	// widget elements by its own.
+	//
+	// Unlike cleanUpWidgetElement it will wrap element back.
+	//
+	// @param {CKEDITOR.dom.element} container
+	function cleanUpAllWidgetElements( widgetsRepo, container ) {
+		var wrappers = container.find( '.cke_widget_wrapper' ),
+			wrapper, element,
+			i = 0,
+			l = wrappers.count();
+
+		for ( ; i < l; ++i ) {
+			wrapper = wrappers.getItem( i );
+			element = wrapper.getFirst( isWidgetElement2 );
+			// If wrapper contains widget element - unwrap it and wrap again.
+			if ( element.type == CKEDITOR.NODE_ELEMENT && element.data( 'widget' ) ) {
+				element.replace( wrapper );
+				widgetsRepo.wrapElement( element );
+			}
+			// Otherwise - something is wrong... clean this up.
+			else
+				wrapper.remove();
+		}
+	}
+
+	// Creates {@link CKEDITOR.filter} instance for given widget, editable and rules.
+	//
+	// Once filter for widget-editable pair is created it is cached, so the same instance
+	// will be returned when method is executed again.
+	//
+	// @param {String} widgetName
+	// @param {String} editableName
+	// @param {CKEDITOR.plugins.widget.nestedEditableDefinition} editableDefinition The nested editable definition.
+	// @returns {CKEDITOR.filter} Filter instance or `null` if rules are not defined.
+	// @context CKEDITOR.plugins.widget.repository
+	function createEditableFilter( widgetName, editableName, editableDefinition ) {
+		if ( !editableDefinition.allowedContent )
+			return null;
+
+		var editables = this._.filters[ widgetName ];
+
+		if ( !editables )
+			this._.filters[ widgetName ] = editables = {};
+
+		var filter = editables[ editableName ];
+
+		if ( !filter )
+			editables[ editableName ] = filter = new CKEDITOR.filter( editableDefinition.allowedContent );
+
+		return filter;
+	}
+
+	// Creates an iterator function which when executed on all
+	// elements in DOM tree will gather elements that should be wrapped
+	// and initialized as widgets.
+	function createUpcastIterator( widgetsRepo ) {
+		var toBeWrapped = [],
+			upcasts = widgetsRepo._.upcasts;
+
+		return {
+			toBeWrapped: toBeWrapped,
+
+			iterator: function( element ) {
+				// Wrapper found - find widget element, add it to be
+				// cleaned up (unwrapped) and wrapped and stop iterating in this branch.
+				if ( 'data-cke-widget-wrapper' in element.attributes ) {
+					element = element.getFirst( isWidgetElement );
+
+					if ( element )
+						toBeWrapped.push( [ element ] );
+
+					// Do not iterate over descendants.
+					return false;
+				}
+				// Widget element found - add it to be cleaned up (just in case)
+				// and wrapped and stop iterating in this branch.
+				else if ( 'data-widget' in element.attributes ) {
+					toBeWrapped.push( [ element ] );
+
+					// Do not iterate over descendants.
+					return false;
+				}
+				else if ( upcasts.length ) {
+					var upcast, upcasted,
+						data,
+						i = 0,
+						l = upcasts.length;
+
+					for ( ; i < l; ++i ) {
+						upcast = upcasts[ i ];
+						data = {};
+
+						if ( ( upcasted = upcast[ 0 ]( element, data ) ) ) {
+							// If upcast function returned element, upcast this one.
+							// It can be e.g. a new element wrapping the original one.
+							if ( upcasted instanceof CKEDITOR.htmlParser.element )
+								element = upcasted;
+
+							// Set initial data attr with data from upcast method.
+							element.attributes[ 'data-cke-widget-data' ] = JSON.stringify( data );
+
+							toBeWrapped.push( [ element, upcast[ 1 ] ] );
+
+							// Do not iterate over descendants.
+							return false;
+						}
+					}
+				}
+			}
+		};
+	}
+
+	// Finds a first parent that matches query.
+	//
+	// @param {CKEDITOR.dom.element} element
+	// @param {Function} query
+	function findParent( element, query ) {
+		var parent = element;
+
+		while ( ( parent = parent.getParent() ) ) {
+			if ( query( parent ) )
+				return true;
+		}
+		return false;
+	}
+
+	// Gets nested editable if node is its descendant or the editable itself.
+	//
+	// @param {CKEDITOR.dom.element} guard Stop ancestor search on this node (usually editor's editable).
+	// @param {CKEDITOR.dom.node} node Start search from this node.
+	// @returns {CKEDITOR.dom.element} Element or null.
+	function getNestedEditable( guard, node ) {
+		if ( !node || node.equals( guard ) )
+			return null;
+
+		if ( isNestedEditable2( node ) )
+			return node;
+
+		return getNestedEditable( guard, node.getParent() );
+	}
+
+	function getWrapperAttributes( inlineWidget ) {
+		return {
+			// tabindex="-1" means that it can receive focus by code.
+			tabindex: -1,
+			contenteditable: 'false',
+			'data-cke-widget-wrapper': 1,
+			'data-cke-filter': 'off',
+			// Class cke_widget_new marks widgets which haven't been initialized yet.
+			'class': 'cke_widget_wrapper cke_widget_new cke_widget_' +
+				( inlineWidget ? 'inline' : 'block' )
+		};
+	}
+
+	// Inserts element at given index.
+	// It will check DTD and split ancestor elements up to the first
+	// that can contain this element.
+	//
+	// @param {CKEDITOR.htmlParser.element} parent
+	// @param {Number} index
+	// @param {CKEDITOR.htmlParser.element} element
+	function insertElement( parent, index, element ) {
+		// Do not split doc fragment...
+		if ( parent.type == CKEDITOR.NODE_ELEMENT ) {
+			var parentAllows = CKEDITOR.dtd[ parent.name ];
+			// Parent element is known (included in DTD) and cannot contain
+			// this element.
+			if ( parentAllows && !parentAllows[ element.name ] ) {
+				var parent2 = parent.split( index ),
+					parentParent = parent.parent;
+
+				// Element will now be inserted at right parent's index.
+				index = parent2.getIndex();
+
+				// If left part of split is empty - remove it.
+				if ( !parent.children.length ) {
+					index -= 1;
+					parent.remove();
+				}
+
+				// If right part of split is empty - remove it.
+				if ( !parent2.children.length )
+					parent2.remove();
+
+				// Try inserting as grandpas' children.
+				return insertElement( parentParent, index, element );
+			}
+		}
+
+		// Finally we can add this element.
+		parent.add( element, index );
+	}
+
+	// @param {CKEDITOR.htmlParser.element}
+	function isWidgetElement( element ) {
+		return element.type == CKEDITOR.NODE_ELEMENT && !!element.attributes[ 'data-widget' ];
+	}
+
+	// @param {CKEDITOR.dom.element}
+	function isWidgetElement2( element ) {
+		return element.type == CKEDITOR.NODE_ELEMENT && element.hasAttribute( 'data-widget' );
+	}
+
+	// Whether for this definition and element widget should be created in inline or block mode.
+	function isWidgetInline( widgetDef, elementName ) {
+		return typeof widgetDef.inline == 'boolean' ? widgetDef.inline : !!CKEDITOR.dtd.$inline[ elementName ];
+	}
+
+	// @param {CKEDITOR.htmlParser.element}
+	function isWidgetWrapper( element ) {
+		return element.type == CKEDITOR.NODE_ELEMENT && element.attributes[ 'data-cke-widget-wrapper' ];
+	}
+
+	// @param {CKEDITOR.dom.element}
+	function isWidgetWrapper2( element ) {
+		return element.type == CKEDITOR.NODE_ELEMENT && element.hasAttribute( 'data-cke-widget-wrapper' );
+	}
+
+	// @param {CKEDITOR.dom.element}
+	function isNestedEditable2( node ) {
+		return node.type == CKEDITOR.NODE_ELEMENT && node.hasAttribute( 'data-cke-widget-editable' );
+	}
+
+	// @param {CKEDITOR.dom.element}
+	function isTemp2( element ) {
+		return element.hasAttribute( 'data-cke-temp' );
+	}
+
+	function finalizeNativeDrop( editor, sourceWidget, range ) {
+		// Save the snapshot with the state before moving widget.
+		// Focus widget, so when we'll undo the DnD, widget will be focused.
+		sourceWidget.focus();
+		editor.fire( 'saveSnapshot' );
+
+		// Lock snapshot to group all steps of moving widget from the original place to the new one.
+		editor.fire( 'lockSnapshot', { dontUpdate: true } );
+
+		range.select();
+
+		var widgetHtml = sourceWidget.wrapper.getOuterHtml();
+		sourceWidget.wrapper.remove();
+		editor.widgets.destroy( sourceWidget, true );
+		editor.execCommand( 'paste', widgetHtml );
+
+		editor.fire( 'unlockSnapshot' );
+	}
+
+	function getRangeAtDropPosition( editor, dropEvt ) {
+		var $evt = dropEvt.data.$,
+			$range,
+			range = editor.createRange();
+
+		// Make testing possible.
+		if ( dropEvt.data.testRange )
+			return dropEvt.data.testRange;
+
+		// Webkits.
+		if ( document.caretRangeFromPoint ) {
+			$range = editor.document.$.caretRangeFromPoint( $evt.clientX, $evt.clientY );
+			range.setStart( CKEDITOR.dom.node( $range.startContainer ), $range.startOffset );
+			range.collapse( true );
+		}
+		// FF.
+		else if ( $evt.rangeParent ) {
+			range.setStart( CKEDITOR.dom.node( $evt.rangeParent ), $evt.rangeOffset );
+			range.collapse( true );
+		}
+		// IEs.
+		else if ( document.body.createTextRange ) {
+			$range = editor.document.getBody().$.createTextRange();
+			$range.moveToPoint( $evt.clientX, $evt.clientY );
+			var id = 'cke-temp-' + ( new Date() ).getTime();
+			$range.pasteHTML( '<span id="' + id + '">\u200b</span>' );
+
+			var span = editor.document.getById( id );
+			range.moveToPosition( span, CKEDITOR.POSITION_BEFORE_START );
+			span.remove();
+		}
+		else
+			return null;
+
+		return range;
+	}
+
+	function onEditableKey( widget, keyCode ) {
+		var focusedEditable = widget.focusedEditable,
+			range;
+
+		// CTRL+A.
+		if ( keyCode == CKEDITOR.CTRL + 65 ) {
+			var bogus = focusedEditable.getBogus();
+
+			range = widget.editor.createRange();
+			range.selectNodeContents( focusedEditable );
+			// Exclude bogus if exists.
+			if ( bogus )
+				range.setEndAt( bogus, CKEDITOR.POSITION_BEFORE_START );
+
+			range.select();
+			// Cancel event - block default.
+			return false;
+		}
+		// DEL or BACKSPACE.
+		else if ( keyCode == 8 || keyCode == 46 ) {
+			var ranges = widget.editor.getSelection().getRanges();
+
+			range = ranges[ 0 ];
+
+			// Block del or backspace if at editable's boundary.
+			return !( ranges.length == 1 && range.collapsed &&
+				range.checkBoundaryOfElement( focusedEditable, CKEDITOR[ keyCode == 8 ? 'START' : 'END' ] ) );
+		}
+	}
+
+	function setFocusedEditable( widgetsRepo, widget, editableElement, offline ) {
+		var editor = widgetsRepo.editor;
+
+		editor.fire( 'lockSnapshot' );
+
+		if ( editableElement ) {
+			var editableName = editableElement.data( 'cke-widget-editable' ),
+				editableInstance = widget.editables[ editableName ];
+
+			widgetsRepo.widgetHoldingFocusedEditable = widget;
+			widget.focusedEditable = editableInstance;
+			editableElement.addClass( 'cke_widget_editable_focused' );
+
+			if ( editableInstance.filter )
+				editor.setActiveFilter( editableInstance.filter );
+			editor.setActiveEnterMode( editableInstance.enterMode, editableInstance.shiftEnterMode );
+		} else {
+			if ( !offline )
+				widget.focusedEditable.removeClass( 'cke_widget_editable_focused' );
+
+			widget.focusedEditable = null;
+			widgetsRepo.widgetHoldingFocusedEditable = null;
+			editor.setActiveFilter( null );
+			editor.setActiveEnterMode( null, null );
+		}
+
+		editor.fire( 'unlockSnapshot' );
+	}
+
+	function setupContextMenu( editor ) {
+		if ( !editor.contextMenu )
+			return;
+
+		editor.contextMenu.addListener( function( element ) {
+			var widget = editor.widgets.getByElement( element, true );
+
+			if ( widget )
+				return widget.fire( 'contextMenu', {} );
+		} );
+	}
+
+	// And now we've got two problems - original problem and RegExp.
+	// Some softeners:
+	// * FF tends to copy all blocks up to the copybin container.
+	// * IE tends to copy only the copybin, without its container.
+	// * We use spans on IE and blockless editors, but divs in other cases.
+	var pasteReplaceRegex = new RegExp(
+		'^' +
+		'(?:<(?:div|span)(?: data-cke-temp="1")?(?: id="cke_copybin")?(?: data-cke-temp="1")?>)?' +
+			'(?:<(?:div|span)(?: style="[^"]+")?>)?' +
+				'<span [^>]*data-cke-copybin-start="1"[^>]*>.?</span>([\\s\\S]+)<span [^>]*data-cke-copybin-end="1"[^>]*>.?</span>' +
+			'(?:</(?:div|span)>)?' +
+		'(?:</(?:div|span)>)?' +
+		'$'
+	);
+
+	function pasteReplaceFn( match, wrapperHtml ) {
+		// Avoid polluting pasted data with any whitspaces,
+		// what's going to break check whether only one widget was pasted.
+		return CKEDITOR.tools.trim( wrapperHtml );
+	}
+
+	function setupDragAndDrop( widgetsRepo ) {
+		var editor = widgetsRepo.editor,
+			lineutils = CKEDITOR.plugins.lineutils;
+
+		editor.on( 'contentDom', function() {
+			var editable = editor.editable();
+
+			// #11123 Firefox needs to listen on document, because otherwise event won't be fired.
+			editable.attachListener( editable.isInline() ? editable : editor.document, 'drop', function( evt ) {
+				var dataStr = evt.data.$.dataTransfer.getData( 'text' ),
+					dataObj,
+					sourceWidget,
+					range;
+
+				if ( !dataStr )
+					return;
+
+				try {
+					dataObj = JSON.parse( dataStr );
+				} catch ( e ) {
+					// Do nothing - data couldn't be parsed so it's not a CKEditor's data.
+					return;
+				}
+
+				if ( dataObj.type != 'cke-widget' )
+					return;
+
+				evt.data.preventDefault();
+
+				// Something went wrong... maybe someone is dragging widgets between editors/windows/tabs/browsers/frames.
+				if ( dataObj.editor != editor.name || !( sourceWidget = widgetsRepo.instances[ dataObj.id ] ) )
+					return;
+
+				// Try to determine a DOM position at which drop happened. If none of methods
+				// which we support succeeded abort.
+				range = getRangeAtDropPosition( editor, evt );
+				if ( !range )
+					return;
+
+				// #11132 Hack to prevent cursor loss on Firefox. Without timeout widget is
+				// correctly pasted but then cursor is invisible (although it works) and can be restored
+				// only by blurring editable.
+				if ( CKEDITOR.env.gecko )
+					setTimeout( finalizeNativeDrop, 0, editor, sourceWidget, range );
+				else
+					finalizeNativeDrop( editor, sourceWidget, range );
+			} );
+
+			// Register Lineutils's utilities as properties of repo.
+			CKEDITOR.tools.extend( widgetsRepo, {
+				finder: new lineutils.finder( editor, {
+					lookups: {
+						// Element is block but not list item and not in nested editable.
+						'default': function( el ) {
+							if ( el.is( CKEDITOR.dtd.$listItem ) )
+								return;
+
+							if ( !el.is( CKEDITOR.dtd.$block ) )
+								return;
+
+							while ( el ) {
+								if ( isNestedEditable2( el ) )
+									return;
+
+								el = el.getParent();
+							}
+
+							return CKEDITOR.LINEUTILS_BEFORE | CKEDITOR.LINEUTILS_AFTER;
+						}
+					}
+				} ),
+				locator: new lineutils.locator( editor ),
+				liner: new lineutils.liner( editor, {
+					lineStyle: {
+						cursor: 'move !important',
+						'border-top-color': '#666'
+					},
+					tipLeftStyle: {
+						'border-left-color': '#666'
+					},
+					tipRightStyle: {
+						'border-right-color': '#666'
+					}
+				} )
+			}, true );
+		} );
+	}
+
+	// Setup mouse observer which will trigger:
+	// * widget focus on widget click,
+	// * widget#doubleclick forwarded from editor#doubleclick.
+	function setupMouseObserver( widgetsRepo ) {
+		var editor = widgetsRepo.editor;
+
+		editor.on( 'contentDom', function() {
+			var editable = editor.editable(),
+				evtRoot = editable.isInline() ? editable : editor.document,
+				widget,
+				mouseDownOnDragHandler;
+
+			editable.attachListener( evtRoot, 'mousedown', function( evt ) {
+				var target = evt.data.getTarget();
+
+				// #10887 Clicking scrollbar in IE8 will invoke event with empty target object.
+				if ( !target.type )
+					return false;
+
+				widget = widgetsRepo.getByElement( target );
+				mouseDownOnDragHandler = 0; // Reset.
+
+				// Widget was clicked, but not editable nested in it.
+				if ( widget ) {
+					// Ignore mousedown on drag and drop handler if the widget is inline.
+					// Block widgets are handled by Lineutils.
+					if ( widget.inline && target.type == CKEDITOR.NODE_ELEMENT && target.hasAttribute( 'data-cke-widget-drag-handler' ) ) {
+						mouseDownOnDragHandler = 1;
+						return;
+					}
+
+					if ( !getNestedEditable( widget.wrapper, target ) ) {
+						evt.data.preventDefault();
+						if ( !CKEDITOR.env.ie )
+							widget.focus();
+					}
+					// Reset widget so mouseup listener is not confused.
+					else
+						widget = null;
+				}
+			} );
+
+			// Focus widget on mouseup if mousedown was fired on drag handler.
+			// Note: mouseup won't be fired at all if widget was dragged and dropped, so
+			// this code will be executed only when drag handler was clicked.
+			editable.attachListener( evtRoot, 'mouseup', function() {
+				if ( widget && mouseDownOnDragHandler ) {
+					mouseDownOnDragHandler = 0;
+					widget.focus();
+				}
+			} );
+
+			// On IE it is not enough to block mousedown. If widget wrapper (element with
+			// contenteditable=false attribute) is clicked directly (it is a target),
+			// then after mouseup/click IE will select that element.
+			// It is not possible to prevent that default action,
+			// so we force fake selection after everything happened.
+			if ( CKEDITOR.env.ie ) {
+				editable.attachListener( evtRoot, 'mouseup', function( evt ) {
+					if ( widget ) {
+						setTimeout( function() {
+							widget.focus();
+							widget = null;
+						} );
+					}
+				} );
+			}
+		} );
+
+		editor.on( 'doubleclick', function( evt ) {
+			var widget = widgetsRepo.getByElement( evt.data.element );
+
+			// Not in widget or in nested editable.
+			if ( !widget || getNestedEditable( widget.wrapper, evt.data.element ) )
+				return;
+
+			return widget.fire( 'doubleclick', { element: evt.data.element } );
+		}, null, null, 1 );
+	}
+
+	// Setup editor#key observer which will forward it
+	// to focused widget.
+	function setupKeyboardObserver( widgetsRepo ) {
+		var editor = widgetsRepo.editor;
+
+		editor.on( 'key', function( evt ) {
+			var focused = widgetsRepo.focused,
+				widgetHoldingFocusedEditable = widgetsRepo.widgetHoldingFocusedEditable,
+				ret;
+
+			if ( focused )
+				ret = focused.fire( 'key', { keyCode: evt.data.keyCode } );
+			else if ( widgetHoldingFocusedEditable )
+				ret = onEditableKey( widgetHoldingFocusedEditable, evt.data.keyCode );
+
+			return ret;
+		}, null, null, 1 );
+	}
+
+	// Setup copybin on native copy and cut events in order to handle copy and cut commands
+	// if user accepted security alert on IEs.
+	// Note: when copying or cutting using keystroke, copySingleWidget will be first executed
+	// by the keydown listener. Conflict between two calls will be resolved by copy_bin existence check.
+	function setupNativeCutAndCopy( widgetsRepo ) {
+		var editor = widgetsRepo.editor;
+
+		editor.on( 'contentDom', function() {
+			var editable = editor.editable();
+
+			editable.attachListener( editable, 'copy', eventListener );
+			editable.attachListener( editable, 'cut', eventListener );
+		} );
+
+		function eventListener( evt ) {
+			if ( widgetsRepo.focused )
+				copySingleWidget( widgetsRepo.focused, evt.name == 'cut' );
+		}
+	}
+
+	// Setup selection observer which will trigger:
+	// * widget select & focus on selection change,
+	// * nested editable focus (related properites and classes) on selection change,
+	// * deselecting and blurring all widgets on data,
+	// * blurring widget on editor blur.
+	function setupSelectionObserver( widgetsRepo ) {
+		var editor = widgetsRepo.editor;
+
+		editor.on( 'selectionCheck', function() {
+			widgetsRepo.fire( 'checkSelection' );
+		} );
+
+		widgetsRepo.on( 'checkSelection', widgetsRepo.checkSelection, widgetsRepo );
+
+		editor.on( 'selectionChange', function( evt ) {
+			var nestedEditable = getNestedEditable( editor.editable(), evt.data.selection.getStartElement() ),
+				newWidget = nestedEditable && widgetsRepo.getByElement( nestedEditable ),
+				oldWidget = widgetsRepo.widgetHoldingFocusedEditable;
+
+			if ( oldWidget ) {
+				if ( oldWidget !== newWidget || !oldWidget.focusedEditable.equals( nestedEditable ) ) {
+					setFocusedEditable( widgetsRepo, oldWidget, null );
+
+					if ( newWidget && nestedEditable )
+						setFocusedEditable( widgetsRepo, newWidget, nestedEditable );
+				}
+			}
+			// It may happen that there's no widget even if editable was found -
+			// e.g. if selection was automatically set in editable although widget wasn't initialized yet.
+			else if ( newWidget && nestedEditable )
+				setFocusedEditable( widgetsRepo, newWidget, nestedEditable );
+		} );
+
+		// Invalidate old widgets early - immediately on dataReady.
+		editor.on( 'dataReady', function( evt ) {
+			// Deselect and blur all widgets.
+			stateUpdater( widgetsRepo ).commit();
+		} );
+
+		editor.on( 'blur', function() {
+			var widget;
+
+			if ( ( widget = widgetsRepo.focused ) )
+				blurWidget( widgetsRepo, widget );
+
+			if ( ( widget = widgetsRepo.widgetHoldingFocusedEditable ) )
+				setFocusedEditable( widgetsRepo, widget, null );
+		} );
+	}
+
+	// Set up actions like:
+	// * processing in toHtml/toDataFormat,
+	// * pasting handling,
+	// * insertion handling,
+	// * editable reload handling (setData, mode switch, undo/redo),
+	// * DOM invalidation handling,
+	// * widgets checks.
+	function setupWidgetsLifecycle( widgetsRepo ) {
+		setupWidgetsLifecycleStart( widgetsRepo );
+		setupWidgetsLifecycleEnd( widgetsRepo );
+
+		widgetsRepo.on( 'checkWidgets', checkWidgets );
+		widgetsRepo.editor.on( 'contentDomInvalidated', widgetsRepo.checkWidgets, widgetsRepo );
+	}
+
+	function setupWidgetsLifecycleEnd( widgetsRepo ) {
+		var editor = widgetsRepo.editor,
+			downcastingSessions = {},
+			nestedEditableScope = false;
+
+		// Listen before htmlDP#htmlFilter is applied to cache all widgets, because we'll
+		// loose data-cke-* attributes.
+		editor.on( 'toDataFormat', function( evt ) {
+			// To avoid conflicts between htmlDP#toDF calls done at the same time
+			// (e.g. nestedEditable#getData called during downcasting some widget)
+			// mark every toDataFormat event chain with the downcasting session id.
+			var id = CKEDITOR.tools.getNextNumber(),
+				toBeDowncasted = [];
+			evt.data.downcastingSessionId = id;
+			downcastingSessions[ id ] = toBeDowncasted;
+
+			evt.data.dataValue.forEach( function( element ) {
+				var attrs = element.attributes,
+					widget, widgetElement;
+
+				// Wrapper.
+				// Perform first part of downcasting (cleanup) and cache widgets,
+				// because after applying DP's filter all data-cke-* attributes will be gone.
+				if ( 'data-cke-widget-id' in attrs ) {
+					widget = widgetsRepo.instances[ attrs[ 'data-cke-widget-id' ] ];
+					if ( widget ) {
+						widgetElement = element.getFirst( isWidgetElement );
+						toBeDowncasted.push( {
+							wrapper: element,
+							element: widgetElement,
+							widget: widget
+						} );
+
+						// If widget did not have data-cke-widget attribute before upcasting remove it.
+						if ( widgetElement.attributes[ 'data-cke-widget-keep-attr' ] != '1' )
+							delete widgetElement.attributes[ 'data-widget' ];
+					}
+				}
+				// Nested editable.
+				else if ( 'data-cke-widget-editable' in attrs ) {
+					delete attrs[ 'contenteditable' ];
+
+					// Replace nested editable's content with its output data.
+					var editable = toBeDowncasted[ toBeDowncasted.length - 1 ].widget.editables[ attrs[ 'data-cke-widget-editable' ] ];
+					element.setHtml( editable.getData() );
+
+					// Don't check children - there won't be next wrapper or nested editable which we
+					// should process in this session.
+					return false;
+				}
+			}, CKEDITOR.NODE_ELEMENT );
+		}, null, null, 8 );
+
+		// Listen after dataProcessor.htmlFilter and ACF were applied
+		// so wrappers securing widgets' contents are removed after all filtering was done.
+		editor.on( 'toDataFormat', function( evt ) {
+			// Ignore some unmarked sessions.
+			if ( !evt.data.downcastingSessionId )
+				return;
+
+			var toBeDowncasted = downcastingSessions[ evt.data.downcastingSessionId ],
+				toBe, widget, widgetElement, retElement;
+
+			while ( ( toBe = toBeDowncasted.shift() ) ) {
+				widget = toBe.widget;
+				widgetElement = toBe.element;
+				retElement = widget._.downcastFn && widget._.downcastFn.call( widget, widgetElement );
+
+				// Returned element always defaults to widgetElement.
+				if ( !retElement )
+					retElement = widgetElement;
+
+				toBe.wrapper.replaceWith( retElement );
+			}
+		}, null, null, 13 );
+
+
+		editor.on( 'contentDomUnload', function() {
+			widgetsRepo.destroyAll( true );
+		} );
+	}
+
+	function setupWidgetsLifecycleStart( widgetsRepo ) {
+		var editor = widgetsRepo.editor,
+			processedWidgetOnly,
+			snapshotLoaded;
+
+		// Listen after ACF (so data are filtered),
+		// but before dataProcessor.dataFilter was applied (so we can secure widgets' internals).
+		editor.on( 'toHtml', function( evt ) {
+			var upcastIterator = createUpcastIterator( widgetsRepo ),
+				toBeWrapped;
+
+			evt.data.dataValue.forEach( upcastIterator.iterator, CKEDITOR.NODE_ELEMENT );
+
+			// Clean up and wrap all queued elements.
+			while ( ( toBeWrapped = upcastIterator.toBeWrapped.pop() ) ) {
+				cleanUpWidgetElement( toBeWrapped[ 0 ] );
+				widgetsRepo.wrapElement( toBeWrapped[ 0 ], toBeWrapped[ 1 ] );
+			}
+
+			// Used to determine whether only widget was pasted.
+			processedWidgetOnly = evt.data.dataValue.children.length == 1 &&
+				isWidgetWrapper( evt.data.dataValue.children[ 0 ] );
+		}, null, null, 8 );
+
+		editor.on( 'dataReady', function() {
+			// Clean up all widgets loaded from snapshot.
+			if ( snapshotLoaded )
+				cleanUpAllWidgetElements( widgetsRepo, editor.editable() );
+			snapshotLoaded = 0;
+
+			// Some widgets were destroyed on contentDomUnload,
+			// some on loadSnapshot, but that does not include
+			// e.g. setHtml on inline editor or widgets removed just
+			// before setting data.
+			widgetsRepo.destroyAll( true );
+			widgetsRepo.initOnAll();
+		} );
+
+		// Set flag so dataReady will know that additional
+		// cleanup is needed, because snapshot containing widgets was loaded.
+		editor.on( 'loadSnapshot', function( evt ) {
+			// Primitive but sufficient check which will prevent from executing
+			// heavier cleanUpAllWidgetElements if not needed.
+			if ( ( /data-cke-widget/ ).test( evt.data ) )
+				snapshotLoaded = 1;
+
+			widgetsRepo.destroyAll( true );
+		}, null, null, 9 );
+
+		// Handle pasted single widget.
+		editor.on( 'paste', function( evt ) {
+			evt.data.dataValue = evt.data.dataValue.replace( pasteReplaceRegex, pasteReplaceFn );
+		} );
+
+		// Listen with high priority to check widgets after data was inserted.
+		editor.on( 'insertText', checkNewWidgets, null, null, 999 );
+		editor.on( 'insertHtml', checkNewWidgets, null, null, 999 );
+
+		function checkNewWidgets() {
+			editor.fire( 'lockSnapshot' );
+
+			// Init only new for performance reason.
+			// Focus inited if only widget was processed.
+			widgetsRepo.checkWidgets( { initOnlyNew: true, focusInited: processedWidgetOnly } );
+
+			editor.fire( 'unlockSnapshot' );
+		}
+	}
+
+	// Helper for coordinating which widgets should be
+	// selected/deselected and which one should be focused/blurred.
+	function stateUpdater( widgetsRepo ) {
+		var currentlySelected = widgetsRepo.selected,
+			toBeSelected = [],
+			toBeDeselected = currentlySelected.slice( 0 ),
+			focused = null;
+
+		return {
+			select: function( widget ) {
+				if ( CKEDITOR.tools.indexOf( currentlySelected, widget ) < 0 )
+					toBeSelected.push( widget );
+
+				var index = CKEDITOR.tools.indexOf( toBeDeselected, widget );
+				if ( index >= 0 )
+					toBeDeselected.splice( index, 1 );
+
+				return this;
+			},
+
+			focus: function( widget ) {
+				focused = widget;
+				return this;
+			},
+
+			commit: function() {
+				var focusedChanged = widgetsRepo.focused !== focused,
+					widget;
+
+				widgetsRepo.editor.fire( 'lockSnapshot' );
+
+				if ( focusedChanged && ( widget = widgetsRepo.focused ) ) {
+					blurWidget( widgetsRepo, widget );
+				}
+
+				while ( ( widget = toBeDeselected.pop() ) ) {
+					currentlySelected.splice( CKEDITOR.tools.indexOf( currentlySelected, widget ), 1 );
+					// Widget could be destroyed in the meantime - e.g. data could be set.
+					if ( widget.isInited() )
+						widget.setSelected( false );
+				}
+
+				if ( focusedChanged && focused ) {
+					widgetsRepo.focused = focused;
+					widgetsRepo.fire( 'widgetFocused', { widget: focused } );
+					focused.setFocused( true );
+				}
+
+				while ( ( widget = toBeSelected.pop() ) ) {
+					currentlySelected.push( widget );
+					widget.setSelected( true );
+				}
+
+				widgetsRepo.editor.fire( 'unlockSnapshot' );
+			}
+		};
+	}
+
+
+	//
+	// WIDGET helpers ---------------------------------------------------------
+	//
+
+	var transparentImageData = 'data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw%3D%3D',
+		// LEFT, RIGHT, UP, DOWN, DEL, BACKSPACE - unblock default fake sel handlers.
+		keystrokesNotBlockedByWidget = { 37:1,38:1,39:1,40:1,8:1,46:1 };
+
+	function cancel( evt ) {
+		evt.cancel();
+	}
+
+	function copySingleWidget( widget, isCut ) {
+		var editor = widget.editor,
+			doc = editor.document;
+
+		// We're still handling previous copy/cut.
+		// When keystroke is used to copy/cut this will also prevent
+		// conflict with copySingleWidget called again for native copy/cut event.
+		if ( doc.getById( 'cke_copybin' ) )
+			return;
+
+			// [IE] Use span for copybin and its container to avoid bug with expanding editable height by
+			// absolutely positioned element.
+		var copybinName = ( editor.blockless || CKEDITOR.env.ie ) ? 'span' : 'div',
+			copybin = doc.createElement( copybinName ),
+			copybinContainer = doc.createElement( copybinName ),
+			// IE8 always jumps to the end of document.
+			needsScrollHack = CKEDITOR.env.ie && CKEDITOR.env.version < 9;
+
+		copybinContainer.setAttributes( {
+			id: 'cke_copybin',
+			'data-cke-temp': '1'
+		} );
+
+		// Position copybin element outside current viewport.
+		copybin.setStyles( {
+			position: 'absolute',
+			width: '1px',
+			height: '1px',
+			overflow: 'hidden'
+		} );
+
+		copybin.setStyle( editor.config.contentsLangDirection == 'ltr' ? 'left' : 'right', '-5000px' );
+
+		copybin.setHtml( '<span data-cke-copybin-start="1">\u200b</span>' + widget.wrapper.getOuterHtml() + '<span data-cke-copybin-end="1">\u200b</span>' );
+
+		// Save snapshot with the current state.
+		editor.fire( 'saveSnapshot' );
+
+		// Ignore copybin.
+		editor.fire( 'lockSnapshot' );
+
+		copybinContainer.append( copybin );
+		editor.editable().append( copybinContainer );
+
+		var listener1 = editor.on( 'selectionChange', cancel, null, null, 0 ),
+			listener2 = widget.repository.on( 'checkSelection', cancel, null, null, 0 );
+
+		if ( needsScrollHack ) {
+			var docElement = doc.getDocumentElement().$,
+				scrollTop = docElement.scrollTop;
+		}
+
+		// Once the clone of the widget is inside of copybin, select
+		// the entire contents. This selection will be copied by the
+		// native browser's clipboard system.
+		var range = editor.createRange();
+		range.selectNodeContents( copybin );
+		range.select();
+
+		if ( needsScrollHack )
+			docElement.scrollTop = scrollTop;
+
+		setTimeout( function() {
+			// [IE] Focus widget before removing copybin to avoid scroll jump.
+			if ( !isCut )
+				widget.focus();
+
+			copybinContainer.remove();
+
+			listener1.removeListener();
+			listener2.removeListener();
+
+			editor.fire( 'unlockSnapshot' );
+
+			if ( isCut ) {
+				widget.repository.del( widget );
+				editor.fire( 'saveSnapshot' );
+			}
+		}, 100 ); // Use 100ms, so Chrome (@Mac) will be able to grab the content.
+	}
+
+	// [IE] Force keeping focus because IE sometimes forgets to fire focus on main editable
+	// when blurring nested editable.
+	// @context widget
+	function onEditableBlur() {
+		var active = CKEDITOR.document.getActive(),
+			editor = this.editor,
+			editable = editor.editable();
+
+		// If focus stays within editor override blur and set currentActive because it should be
+		// automatically changed to editable on editable#focus but it is not fired.
+		if ( ( editable.isInline() ? editable : editor.document.getWindow().getFrame() ).equals( active ) )
+			editor.focusManager.focus( editable );
+	}
+
+	// Force selectionChange when editable was focused.
+	// Similar to hack in selection.js#~620.
+	// @context widget
+	function onEditableFocus() {
+		// Gecko does not support 'DOMFocusIn' event on which we unlock selection
+		// in selection.js to prevent selection locking when entering nested editables.
+		if ( CKEDITOR.env.gecko )
+			this.editor.unlockSelection();
+
+		// We don't need to force selectionCheck on Webkit, because on Webkit
+		// we do that on DOMFocusIn in selection.js.
+		if ( !CKEDITOR.env.webkit ) {
+			this.editor.forceNextSelectionCheck();
+			this.editor.selectionChange( 1 );
+		}
+	}
+
+	// Position drag handler according to the widget's element position.
+	function positionDragHandler( widget ) {
+		var handler = widget.dragHandlerContainer;
+
+		handler.setStyle( 'top', widget.element.$.offsetTop - DRAG_HANDLER_SIZE + 'px' );
+		handler.setStyle( 'left', widget.element.$.offsetLeft + 'px' );
+	}
+
+	function setupDragHandler( widget ) {
+		if ( !widget.draggable )
+			return;
+
+		var editor = widget.editor,
+			editable = editor.editable(),
+			img = new CKEDITOR.dom.element( 'img', editor.document ),
+			container = new CKEDITOR.dom.element( 'span', editor.document );
+
+		container.setAttributes( {
+			'class': 'cke_reset cke_widget_drag_handler_container',
+			// Split background and background-image for IE8 which will break on rgba().
+			style: 'background:rgba(220,220,220,0.5);background-image:url(' + editor.plugins.widget.path + 'images/handle.png)'
+		} );
+
+		img.setAttributes( {
+			'class': 'cke_reset cke_widget_drag_handler',
+			'data-cke-widget-drag-handler': '1',
+			src: transparentImageData,
+			width: DRAG_HANDLER_SIZE,
+			title: editor.lang.widget.move,
+			height: DRAG_HANDLER_SIZE
+		} );
+
+		if ( widget.inline ) {
+			img.setAttribute( 'draggable', 'true' );
+			img.on( 'dragstart', function( evt ) {
+				evt.data.$.dataTransfer.setData( 'text', JSON.stringify( { type: 'cke-widget', editor: editor.name, id: widget.id } ) );
+			} );
+		} else
+			img.on( 'mousedown', onBlockWidgetDrag, widget );
+
+		container.append( img );
+		widget.wrapper.append( container );
+		widget.dragHandlerContainer = container;
+	}
+
+	function onBlockWidgetDrag() {
+		var finder = this.repository.finder,
+			locator = this.repository.locator,
+			liner = this.repository.liner,
+			editor = this.editor,
+			editable = editor.editable(),
+			listeners = [],
+			sorted = [],
+
+			// Harvest all possible relations and display some closest.
+			relations = finder.greedySearch(),
+
+			buffer = CKEDITOR.tools.eventsBuffer( 50, function() {
+				locations = locator.locate( relations );
+
+				// There's only a single line displayed for D&D.
+				sorted = locator.sort( y, 1 );
+
+				if ( sorted.length ) {
+					liner.prepare( relations, locations );
+					liner.placeLine( sorted[ 0 ] );
+					liner.cleanup();
+				}
+			} ),
+
+			locations, y;
+
+		// Let's have the "dragging cursor" over entire editable.
+		editable.addClass( 'cke_widget_dragging' );
+
+		// Cache mouse position so it is re-used in events buffer.
+		listeners.push( editable.on( 'mousemove', function( evt ) {
+			y = evt.data.$.clientY;
+			buffer.input();
+		} ) );
+
+		function onMouseUp() {
+			var l;
+
+			buffer.reset();
+
+			// Stop observing events.
+			while ( ( l = listeners.pop() ) )
+				l.removeListener();
+
+			onBlockWidgetDrop.call( this, sorted );
+		}
+
+		// Mouseup means "drop". This is when the widget is being detached
+		// from DOM and placed at range determined by the line (location).
+		listeners.push( editor.document.once( 'mouseup', onMouseUp, this ) );
+
+		// Mouseup may occur when user hovers the line, which belongs to
+		// the outer document. This is, of course, a valid listener too.
+		listeners.push( CKEDITOR.document.once( 'mouseup', onMouseUp, this ) );
+	}
+
+	function onBlockWidgetDrop( sorted ) {
+		var finder = this.repository.finder,
+			liner = this.repository.liner,
+			editor = this.editor,
+			editable = this.editor.editable();
+
+		if ( !CKEDITOR.tools.isEmpty( liner.visible ) ) {
+			// Retrieve range for the closest location.
+			var range = finder.getRange( sorted[ 0 ] );
+
+			// Focus widget (it could lost focus after mousedown+mouseup)
+			// and save this state as the one where we want to be taken back when undoing.
+			this.focus();
+			editor.fire( 'saveSnapshot' );
+			// Group all following operations in one snapshot.
+			editor.fire( 'lockSnapshot', { dontUpdate: 1 } );
+
+			// Reset the fake selection, which will be invalidated by insertElementIntoRange.
+			// This avoids a situation when getSelection() still returns a fake selection made
+			// on widget which in the meantime has been moved to other place. That could cause
+			// an error thrown e.g. by saveSnapshot or stateUpdater.
+			editor.getSelection().reset();
+
+			// Attach widget at the place determined by range.
+			editable.insertElementIntoRange( this.wrapper, range );
+
+			// Focus again the dropped widget.
+			this.focus();
+
+			// Unlock snapshot and save new one, which will contain all changes done
+			// in this method.
+			editor.fire( 'unlockSnapshot' );
+			editor.fire( 'saveSnapshot' );
+		}
+
+		// Clean-up custom cursor for editable.
+		editable.removeClass( 'cke_widget_dragging' );
+
+		// Clean-up all remaining lines.
+		liner.hideVisible();
+	}
+
+	function setupEditables( widget ) {
+		var editableName,
+			editableDef,
+			definedEditables = widget.editables;
+
+		widget.editables = {};
+
+		if ( !widget.editables )
+			return;
+
+		for ( editableName in definedEditables ) {
+			editableDef = definedEditables[ editableName ];
+			widget.initEditable( editableName, typeof editableDef == 'string' ? { selector: editableDef } : editableDef );
+		}
+	}
+
+	function setupMask( widget ) {
+		if ( !widget.mask )
+			return;
+
+		var img = new CKEDITOR.dom.element( 'img', widget.editor.document );
+		img.setAttributes( {
+			src: transparentImageData,
+			'class': 'cke_reset cke_widget_mask'
+		} );
+		widget.wrapper.append( img );
+		widget.mask = img;
+	}
+
+	// Replace parts object containing:
+	// partName => selector pairs
+	// with:
+	// partName => element pairs
+	function setupParts( widget ) {
+		if ( widget.parts ) {
+			var parts = {},
+				el, partName;
+
+			for ( partName in widget.parts ) {
+				el = widget.wrapper.findOne( widget.parts[ partName ] );
+				parts[ partName ] = el;
+			}
+			widget.parts = parts;
+		}
+	}
+
+	function setupWidget( widget, widgetDef ) {
+		setupWrapper( widget );
+		setupParts( widget );
+		setupEditables( widget );
+		setupMask( widget );
+		setupDragHandler( widget );
+
+		// #11145: [IE8] Non-editable content of widget is draggable.
+		if ( CKEDITOR.env.ie && CKEDITOR.env.version < 9 ) {
+			widget.wrapper.on( 'dragstart', function( evt ) {
+				// Allow text dragging inside nested editables.
+				if ( !getNestedEditable( widget, evt.data.getTarget() ) )
+					evt.data.preventDefault();
+			} );
+		}
+
+		widget.wrapper.removeClass( 'cke_widget_new' );
+		widget.element.addClass( 'cke_widget_element' );
+
+		widget.on( 'key', function( evt ) {
+			var keyCode = evt.data.keyCode;
+
+			// ENTER.
+			if ( keyCode == 13 )
+				widget.edit();
+			// CTRL+C or CTRL+X.
+			else if ( keyCode == CKEDITOR.CTRL + 67 || keyCode == CKEDITOR.CTRL + 88 ) {
+				copySingleWidget( widget, keyCode == CKEDITOR.CTRL + 88 );
+				return; // Do not preventDefault.
+			}
+			// Pass chosen keystrokes to other plugins or default fake sel handlers.
+			// Pass all CTRL/ALT keystrokes.
+			else if ( keyCode in keystrokesNotBlockedByWidget || ( CKEDITOR.CTRL & keyCode ) || ( CKEDITOR.ALT & keyCode ) )
+				return;
+
+			return false;
+		}, null, null, 999 );
+		// Listen with high priority so it's possible
+		// to overwrite this callback.
+
+		widget.on( 'doubleclick', function( evt ) {
+			widget.edit();
+			evt.cancel();
+		} );
+
+		if ( widgetDef.data )
+			widget.on( 'data', widgetDef.data );
+
+		if ( widgetDef.edit )
+			widget.on( 'edit', widgetDef.edit );
+
+		if ( widget.draggable ) {
+			widget.on( 'data', function() {
+				positionDragHandler( widget );
+			}, null, null, 999 );
+		}
+	}
+
+	function setupWidgetData( widget, startupData ) {
+		var widgetDataAttr = widget.element.data( 'cke-widget-data' );
+
+		if ( widgetDataAttr )
+			widget.setData( JSON.parse( widgetDataAttr ) );
+		if ( startupData )
+			widget.setData( startupData );
+
+		// Unblock data and...
+		widget.dataReady = true;
+
+		// Write data to element because this was blocked when data wasn't ready.
+		writeDataToElement( widget );
+
+		// Fire data event first time, because this was blocked when data wasn't ready.
+		widget.fire( 'data', widget.data );
+	}
+
+	function setupWrapper( widget ) {
+		// Retrieve widget wrapper. Assign an id to it.
+		var wrapper = widget.wrapper = widget.element.getParent();
+		wrapper.setAttribute( 'data-cke-widget-id', widget.id );
+	}
+
+	function writeDataToElement( widget ) {
+		widget.element.data( 'cke-widget-data', JSON.stringify( widget.data ) );
+	}
+
+	//
+	// EXPOSE PUBLIC API ------------------------------------------------------
+	//
+
+	CKEDITOR.plugins.widget = Widget;
+	Widget.repository = Repository;
+	Widget.nestedEditable = NestedEditable;
+})();
+
+/**
+ * An event fired when a widget definition is registered by the {@link CKEDITOR.plugins.widget.repository#add} method.
+ * It is possible to modify the definition being registered.
+ *
+ * @event widgetDefinition
+ * @member CKEDITOR.editor
+ * @param {CKEDITOR.plugins.widget.definition} data Widget definition.
+ */
+
+/**
+ * This is an abstract class that describes the definition of a widget.
+ * It is a type of {@link CKEDITOR.plugins.widget.repository#add} method's second argument.
+ *
+ * Widget instances inherit from registered widget definitions, although not in a prototypal way.
+ * They are simply extended with corresponding widget definitions. Note that not all properties of
+ * the widget definition become properties of a widget. Some, like {@link #data} or {@link #edit}, become
+ * widget's events listeners.
+ *
+ * @class CKEDITOR.plugins.widget.definition
+ * @abstract
+ * @mixins CKEDITOR.feature
+ */
+
+/**
+ * Widget definition name. It is automatically set when the definition is
+ * {@link CKEDITOR.plugins.widget.repository#add registered}.
+ *
+ * @property {String} name
+ */
+
+/**
+ * The method executed while initializing a widget, after a widget instance
+ * is created, but before it is ready. It is executed before the first
+ * {@link CKEDITOR.plugins.widget#event-data} is fired so it is common to
+ * use the `init` method to populate widget data with information loaded from
+ * the DOM, like for exmaple:
+ *
+ *		init: function() {
+ *			this.setData( 'width', this.element.getStyle( 'width' ) );
+ *
+ *			if ( this.parts.caption.getStyle( 'display' ) != 'none' )
+ *				this.setData( 'showCaption', true );
+ *		}
+ *
+ * @property {Function} init
+ */
+
+/**
+ * The function to be used to upcast an element to this widget or a
+ * comma-separated list of upcast methods from the {@link #upcasts} object.
+ *
+ * The upcast function **is not** executed in the widget context (because the widget
+ * does not exist yet) and two arguments are passed:
+ *
+ * * `element` ({@link CKEDITOR.htmlParser.element}) &ndash; The element to be checked.
+ * * `data` (`Object`) &ndash; The object which can be extended with data which will then be passed to the widget.
+ *
+ * An element will be upcasted if a function returned `true` or an instance of
+ * a {@link CKEDITOR.htmlParser.element} if upcasting meant DOM structure changes
+ * (in this case the widget will be initialized on the returned element).
+ *
+ * @property {String/Function} upcast
+ */
+
+/**
+ * The object containing functions which can be used to upcast this widget.
+ * Only those pointed by the {@link #upcast} property will be used.
+ *
+ * In most cases it is appropriate to use {@link #upcast} directly,
+ * because majority of widgets need just one method.
+ * However, in some cases the widget author may want to expose more than one variant
+ * and then this property may be used.
+ *
+ *		upcasts: {
+ *			// This function may upcast only figure elements.
+ *			figure: function() {
+ *				// ...
+ *			},
+ *			// This function may upcast only image elements.
+ *			image: function() {
+ *				// ...
+ *			},
+ *			// More variants...
+ *		}
+ *
+ *		// Then, widget user may choose which upcast methods will be enabled.
+ *		editor.on( 'widgetDefinition', function( evt ) {
+ *			if ( evt.data.name == 'image' )
+ * 				evt.data.upcast = 'figure,image'; // Use both methods.
+ *		} );
+ *
+ * @property {Object} upcasts
+ */
+
+/**
+ * The function to be used to downcast this widget or
+ * a name of the downcast option from the {@link #downcasts} object.
+ *
+ * The downcast funciton will be executed in the {@link CKEDITOR.plugins.widget} context
+ * and with `widgetElement` ({@link CKEDITOR.htmlParser.element}) argument which is
+ * the widget's main element.
+ *
+ * The function may return an instance of the {@link CKEDITOR.htmlParser.node} class if the widget
+ * needs to be downcasted to a different node than the widget's main element.
+ *
+ * @property {String/Function} downcast
+ */
+
+/**
+ * The object containing functions which can be used to downcast this widget.
+ * Only the one pointed by the {@link #downcast} property will be used.
+ *
+ * In most cases it is appropriate to use {@link #downcast} directly,
+ * because majority of widgets have just one variant of downcasting (or none at all).
+ * However, in some cases the widget author may want to expose more than one variant
+ * and then this property may be used.
+ *
+ *		downcasts: {
+ *			// This downcast may transform the widget into the figure element.
+ *			figure: function() {
+ *				// ...
+ *			},
+ *			// This downcast may transform the widget into the image element with data-* attributes.
+ *			image: function() {
+ *				// ...
+ *			}
+ *		}
+ *
+ *		// Then, the widget user may choose one of the downcast options when setting up his editor.
+ *		editor.on( 'widgetDefinition', function( evt ) {
+ *			if ( evt.data.name == 'image' )
+ * 				evt.data.downcast = 'figure';
+ *		} );
+ *
+ * @property downcasts
+ */
+
+/**
+ * If set, it will be added as the {@link CKEDITOR.plugins.widget#event-edit} event listener.
+ * This means that it will be executed when a widget is being edited.
+ * See the {@link CKEDITOR.plugins.widget#method-edit} method.
+ *
+ * @property {Function} edit
+ */
+
+/**
+ * If set, it will be added as the {@link CKEDITOR.plugins.widget#event-data} event listener.
+ * This means that it will be executed every time the {@link CKEDITOR.plugins.widget#property-data widget data} changes.
+ *
+ * @property {Function} data
+ */
+
+/**
+ * The method to be executed when the widget's command is executed in order to insert a new widget
+ * (widget of this type is not focused). If not defined, then the default action will be
+ * performed which means that:
+ *
+ * * An instance of the widget will be created in a detached {@link CKEDITOR.dom.documentFragment document fragment},
+ * * The {@link CKEDITOR.plugins.widget#method-edit} method will be called to trigger widget editing,
+ * * The widget element will be inserted into DOM.
+ *
+ * @property {Function} insert
+ */
+
+/**
+ * The name of a dialog window which will be opened on {@link CKEDITOR.plugins.widget#method-edit}.
+ * If not defined, then the {@link CKEDITOR.plugins.widget#method-edit} method will not perform any action and
+ * widget's command will insert a new widget without opening a dialog window first.
+ *
+ * @property {String} dialog
+ */
+
+/**
+ * The template which will be used to create a new widget element (when the widget's command is executed).
+ * This string is populated with {@link #defaults default values} by using the {@link CKEDITOR.template} format.
+ * Therefore it has to be a valid {@link CKEDITOR.template} argument.
+ *
+ * @property {String} template
+ */
+
+/**
+ * The data object which will be used to populate the data of a newly created widget.
+ * See {@link CKEDITOR.plugins.widget#property-data}.
+ *
+ *		defaults: {
+ *			showCaption: true,
+ *			align: 'none'
+ *		}
+ *
+ * @property defaults
+ */
+
+/**
+ * An object containing definitions of widget components (part name => CSS selector).
+ *
+ *		parts: {
+ *			image: 'img',
+ *			caption: 'div.caption'
+ *		}
+ *
+ * @property parts
+ */
+
+/**
+ * An object containing definitions of nested editables (editable name => {@link CKEDITOR.plugins.widget.nestedEditable.definition}).
+ *
+ *		editables: {
+ *			header: 'h1',
+ *			content: {
+ *				selector: 'div.content',
+ *				allowedContent: 'p strong em; a[!href]'
+ *			}
+ *		}
+ *
+ * @property editables
+ */
+
+/**
+ * Widget name displayed in elements path.
+ *
+ * @property {String} pathName
+ */
+
+/**
+ * If set to `true`, the widget's element will be covered with a transparent mask.
+ * This will prevent its content from being clickable, which matters in case
+ * of special elements like embedded Flash or iframes that generate a separate "context".
+ *
+ * @property {Boolean} mask
+ */
+
+/**
+ * If set to `true/false`, it will force the widget to be either an inline or a block widget.
+ * If not set, the widget type will be determined from the widget element.
+ *
+ * Widget type influences whether a block (`div`) or an inline (`span`) element is used
+ * for the wrapper.
+ *
+ * @property {Boolean} inline
+ */
+
+/**
+ * The label for the widget toolbar button.
+ *
+ *		editor.widgets.add( 'simplebox', {
+ *			button: 'Create a simple box'
+ *		} );
+ *
+ *		editor.widgets.add( 'simplebox', {
+ *			button: editor.lang.simplebox.title
+ *		} );
+ *
+ * @property {String} button
+ */
+
+/**
+ * Whether widget should be draggable. Defaults to `true`.
+ * If set to `false` drag handler will not be displayed when hovering widget.
+ *
+ * @property {Boolean} draggable
+ */
+
+/**
+ * This is an abstract class that describes the definition of a widget's nested editable.
+ * It is a type of values in the {@link CKEDITOR.plugins.widget.definition#editables} object.
+ *
+ * In the simplest case the definition is a string which is a CSS selector used to
+ * find an element that will become a nested editable inside the widget. Note that
+ * the widget element can be a nested editable, too.
+ *
+ * In the more advanced case a definition is an object with a required `selector` property.
+ *
+ *		editables: {
+ *			header: 'h1',
+ *			content: {
+ *				selector: 'div.content',
+ *				allowedContent: 'p strong em; a[!href]'
+ *			}
+ *		}
+ *
+ * @class CKEDITOR.plugins.widget.nestedEditable.definition
+ * @abstract
+ */
+
+/**
+ * The CSS selector used to find an element which will become a nested editable.
+ *
+ * @property {String} selector
+ */
+
+/**
+ * The [Advanced Content Filter](#!/guide/dev_advanced_content_filter) rules
+ * which will be used to limit the content allowed in this nested editable.
+ * This option is similar to {@link CKEDITOR.config#allowedContent} and one can
+ * use it to limit the editor features available in the nested editable.
+ *
+ * @property {CKEDITOR.filter.allowedContentRules} allowedContent
+ */
+
+/**
+ * Nested editable name displayed in elements path.
+ *
+ * @property {String} pathName
+ */
\ No newline at end of file
diff --git a/profiles/commons/libraries/modernizr/feature-detects/contentsecuritypolicy.js b/profiles/commons/libraries/modernizr/feature-detects/contentsecuritypolicy.js
index ee1ddb8..a95e45a 100644
--- a/profiles/commons/libraries/modernizr/feature-detects/contentsecuritypolicy.js
+++ b/profiles/commons/libraries/modernizr/feature-detects/contentsecuritypolicy.js
@@ -7,4 +7,4 @@
 //
 // Editor's Draft: https://dvcs.w3.org/hg/content-security-policy/raw-file/tip/csp-specification.dev.html
 
-Modernizr.addTest('contentsecuritypolicy', 'SecurityPolicy' in document);
+Modernizr.addTest('contentsecuritypolicy', ('securityPolicy' in document || 'SecurityPolicy' in document));
diff --git a/profiles/commons/libraries/modernizr/grunt.js b/profiles/commons/libraries/modernizr/grunt.js
index c512761..68c345d 100644
--- a/profiles/commons/libraries/modernizr/grunt.js
+++ b/profiles/commons/libraries/modernizr/grunt.js
@@ -4,7 +4,7 @@ module.exports = function( grunt ) {
 
     grunt.initConfig({
         meta: {
-          version: '2.7.0',
+          version: '2.7.1',
           banner: '/*!\n' +
             ' * Modernizr v<%= meta.version %>\n' +
             ' * www.modernizr.com\n *\n' +
diff --git a/profiles/commons/libraries/modernizr/modernizr.js b/profiles/commons/libraries/modernizr/modernizr.js
index ebc047c..07ea93f 100644
--- a/profiles/commons/libraries/modernizr/modernizr.js
+++ b/profiles/commons/libraries/modernizr/modernizr.js
@@ -1,5 +1,5 @@
 /*!
- * Modernizr v2.7.0
+ * Modernizr v2.7.1
  * www.modernizr.com
  *
  * Copyright (c) Faruk Ates, Paul Irish, Alex Sexton
@@ -24,7 +24,7 @@
 
 window.Modernizr = (function( window, document, undefined ) {
 
-    var version = '2.7.0',
+    var version = '2.7.1',
 
     Modernizr = {},
 
diff --git a/profiles/commons/libraries/underscore/CONTRIBUTING.md b/profiles/commons/libraries/underscore/CONTRIBUTING.md
index de5d562..e133ebe 100644
--- a/profiles/commons/libraries/underscore/CONTRIBUTING.md
+++ b/profiles/commons/libraries/underscore/CONTRIBUTING.md
@@ -1,9 +1,9 @@
 ## How to contribute to Underscore.js
 
-* Before you open a ticket or send a pull request, [search](https://github.com/documentcloud/underscore/issues) for previous discussions about the same feature or issue. Add to the earlier ticket if you find one.
+* Before you open a ticket or send a pull request, [search](https://github.com/jashkenas/underscore/issues) for previous discussions about the same feature or issue. Add to the earlier ticket if you find one.
 
 * Before sending a pull request for a feature, be sure to have [tests](http://underscorejs.org/test/).
 
-* Use the same coding style as the rest of the [codebase](https://github.com/documentcloud/underscore/blob/master/underscore.js).
+* Use the same coding style as the rest of the [codebase](https://github.com/jashkenas/underscore/blob/master/underscore.js).
 
 * In your pull request, do not add documentation or re-build the minified `underscore-min.js` file. We'll do those things before cutting a new release.
diff --git a/profiles/commons/libraries/underscore/LICENSE b/profiles/commons/libraries/underscore/LICENSE
index 0d8dbe4..3acf908 100644
--- a/profiles/commons/libraries/underscore/LICENSE
+++ b/profiles/commons/libraries/underscore/LICENSE
@@ -1,4 +1,5 @@
-Copyright (c) 2009-2013 Jeremy Ashkenas, DocumentCloud
+Copyright (c) 2009-2013 Jeremy Ashkenas, DocumentCloud and Investigative
+Reporters & Editors
 
 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
diff --git a/profiles/commons/libraries/underscore/README.md b/profiles/commons/libraries/underscore/README.md
index b1f3e50..c2ba259 100644
--- a/profiles/commons/libraries/underscore/README.md
+++ b/profiles/commons/libraries/underscore/README.md
@@ -15,5 +15,8 @@ without extending any core JavaScript objects.
 For Docs, License, Tests, and pre-packed downloads, see:
 http://underscorejs.org
 
+Underscore is an open-sourced component of DocumentCloud:
+https://github.com/documentcloud
+
 Many thanks to our contributors:
-https://github.com/documentcloud/underscore/contributors
+https://github.com/jashkenas/underscore/contributors
diff --git a/profiles/commons/libraries/underscore/Rakefile b/profiles/commons/libraries/underscore/Rakefile
index 3131e7e..6033c15 100644
--- a/profiles/commons/libraries/underscore/Rakefile
+++ b/profiles/commons/libraries/underscore/Rakefile
@@ -1,6 +1,6 @@
 desc "Use Uglify JS to compress Underscore.js"
 task :build do
-  sh "uglifyjs underscore.js -c \"evaluate=false\" -m -o underscore-min.js"
+  sh "uglifyjs underscore.js -c \"evaluate=false\" --comments \"/    .*/\" -m --source-map underscore-min.map -o underscore-min.js"
 end
 
 desc "Build the docco documentation"
diff --git a/profiles/commons/libraries/underscore/docs/docco.css b/profiles/commons/libraries/underscore/docs/docco.css
index 04cc7ec..f690a07 100644
--- a/profiles/commons/libraries/underscore/docs/docco.css
+++ b/profiles/commons/libraries/underscore/docs/docco.css
@@ -1,192 +1,500 @@
-/*--------------------- Layout and Typography ----------------------------*/
+/*--------------------- Typography ----------------------------*/
+
+@font-face {
+    font-family: 'aller-light';
+    src: url('public/fonts/aller-light.eot');
+    src: url('public/fonts/aller-light.eot?#iefix') format('embedded-opentype'),
+         url('public/fonts/aller-light.woff') format('woff'),
+         url('public/fonts/aller-light.ttf') format('truetype');
+    font-weight: normal;
+    font-style: normal;
+}
+
+@font-face {
+    font-family: 'aller-bold';
+    src: url('public/fonts/aller-bold.eot');
+    src: url('public/fonts/aller-bold.eot?#iefix') format('embedded-opentype'),
+         url('public/fonts/aller-bold.woff') format('woff'),
+         url('public/fonts/aller-bold.ttf') format('truetype');
+    font-weight: normal;
+    font-style: normal;
+}
+
+@font-face {
+    font-family: 'novecento-bold';
+    src: url('public/fonts/novecento-bold.eot');
+    src: url('public/fonts/novecento-bold.eot?#iefix') format('embedded-opentype'),
+         url('public/fonts/novecento-bold.woff') format('woff'),
+         url('public/fonts/novecento-bold.ttf') format('truetype');
+    font-weight: normal;
+    font-style: normal;
+}
+
+/*--------------------- Layout ----------------------------*/
+html { height: 100%; }
 body {
-  font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
-  font-size: 15px;
-  line-height: 22px;
-  color: #252519;
+  font-family: "aller-light";
+  font-size: 14px;
+  line-height: 18px;
+  color: #30404f;
   margin: 0; padding: 0;
+  height:100%;
 }
+#container { min-height: 100%; }
+
 a {
-  color: #261a3b;
+  color: #000;
 }
-  a:visited {
-    color: #261a3b;
-  }
-p {
-  margin: 0 0 15px 0;
+
+b, strong {
+  font-weight: normal;
+  font-family: "aller-bold";
 }
+
+p, ul, ol {
+  margin: 15px 0 0px;
+}
+
 h1, h2, h3, h4, h5, h6 {
-  margin: 0px 0 15px 0;
+  color: #112233;
+  line-height: 1em;
+  font-weight: normal;
+  font-family: "novecento-bold";
+  text-transform: uppercase;
+  margin: 30px 0 15px 0;
 }
-  h1 {
-    margin-top: 40px;
-  }
+
+h1 {
+  margin-top: 40px;
+}
+
 hr {
-    border: 0 none;
-    border-top: 1px solid #e5e5ee;
-    height: 1px;
-    margin: 20px 0;
+  border: 0;
+  background: 1px solid #ddd;
+  height: 1px;
+  margin: 20px 0;
 }
-#container {
-  position: relative;
+
+pre, tt, code {
+  font-size: 12px; line-height: 16px;
+  font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
+  margin: 0; padding: 0;
 }
-#background {
-  position: fixed;
-  top: 0; left: 525px; right: 0; bottom: 0;
-  background: #f5f5ff;
-  border-left: 1px solid #e5e5ee;
-  z-index: -1;
+  .annotation pre {
+    display: block;
+    margin: 0;
+    padding: 7px 10px;
+    background: #fcfcfc;
+    -moz-box-shadow:    inset 0 0 10px rgba(0,0,0,0.1);
+    -webkit-box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
+    box-shadow:         inset 0 0 10px rgba(0,0,0,0.1);
+    overflow-x: auto;
+  }
+    .annotation pre code {
+      border: 0;
+      padding: 0;
+      background: transparent;
+    }
+
+
+blockquote {
+  border-left: 5px solid #ccc;
+  margin: 0;
+  padding: 1px 0 1px 1em;
+}
+  .sections blockquote p {
+    font-family: Menlo, Consolas, Monaco, monospace;
+    font-size: 12px; line-height: 16px;
+    color: #999;
+    margin: 10px 0 0;
+    white-space: pre-wrap;
+  }
+
+ul.sections {
+  list-style: none;
+  padding:0 0 5px 0;;
+  margin:0;
+}
+
+/*
+  Force border-box so that % widths fit the parent
+  container without overlap because of margin/padding.
+
+  More Info : http://www.quirksmode.org/css/box.html
+*/
+ul.sections > li > div {
+  -moz-box-sizing: border-box;    /* firefox */
+  -ms-box-sizing: border-box;     /* ie */
+  -webkit-box-sizing: border-box; /* webkit */
+  -khtml-box-sizing: border-box;  /* konqueror */
+  box-sizing: border-box;         /* css3 */
 }
+
+
+/*---------------------- Jump Page -----------------------------*/
 #jump_to, #jump_page {
+  margin: 0;
   background: white;
   -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777;
   -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px;
-  font: 10px Arial;
-  text-transform: uppercase;
+  font: 16px Arial;
   cursor: pointer;
   text-align: right;
+  list-style: none;
+}
+
+#jump_to a {
+  text-decoration: none;
+}
+
+#jump_to a.large {
+  display: none;
+}
+#jump_to a.small {
+  font-size: 22px;
+  font-weight: bold;
+  color: #676767;
 }
+
 #jump_to, #jump_wrapper {
   position: fixed;
   right: 0; top: 0;
-  padding: 5px 10px;
+  padding: 10px 15px;
+  margin:0;
+}
+
+#jump_wrapper {
+  display: none;
+  padding:0;
+}
+
+#jump_to:hover #jump_wrapper {
+  display: block;
+}
+
+#jump_page {
+  padding: 5px 0 3px;
+  margin: 0 0 25px 25px;
+}
+
+#jump_page .source {
+  display: block;
+  padding: 15px;
+  text-decoration: none;
+  border-top: 1px solid #eee;
+}
+
+#jump_page .source:hover {
+  background: #f5f5ff;
+}
+
+#jump_page .source:first-child {
+}
+
+/*---------------------- Low resolutions (> 320px) ---------------------*/
+@media only screen and (min-width: 320px) {
+  .pilwrap { display: none; }
+
+  ul.sections > li > div {
+    display: block;
+    padding:5px 10px 0 10px;
+  }
+
+  ul.sections > li > div.annotation ul, ul.sections > li > div.annotation ol {
+    padding-left: 30px;
+  }
+
+  ul.sections > li > div.content {
+    background: #f5f5ff;
+    overflow-x:auto;
+    -webkit-box-shadow: inset 0 0 5px #e5e5ee;
+    box-shadow: inset 0 0 5px #e5e5ee;
+    border: 1px solid #dedede;
+    margin:5px 10px 5px 10px;
+    padding-bottom: 5px;
+  }
+
+  ul.sections > li > div.annotation pre {
+    margin: 7px 0 7px;
+    padding-left: 15px;
+  }
+
+  ul.sections > li > div.annotation p tt, .annotation code {
+    background: #f8f8ff;
+    border: 1px solid #dedede;
+    font-size: 12px;
+    padding: 0 0.2em;
+  }
 }
+
+/*----------------------  (> 481px) ---------------------*/
+@media only screen and (min-width: 481px) {
+  #container {
+    position: relative;
+  }
+  body {
+    background-color: #F5F5FF;
+    font-size: 15px;
+    line-height: 21px;
+  }
+  pre, tt, code {
+    line-height: 18px;
+  }
+  p, ul, ol {
+    margin: 0 0 15px;
+  }
+
+
+  #jump_to {
+    padding: 5px 10px;
+  }
   #jump_wrapper {
     padding: 0;
+  }
+  #jump_to, #jump_page {
+    font: 10px Arial;
+    text-transform: uppercase;
+  }
+  #jump_page .source {
+    padding: 5px 10px;
+  }
+  #jump_to a.large {
+    display: inline-block;
+  }
+  #jump_to a.small {
     display: none;
   }
-    #jump_to:hover #jump_wrapper {
-      display: block;
-    }
-    #jump_page {
-      padding: 5px 0 3px;
-      margin: 0 0 25px 25px;
-    }
-      #jump_page .source {
-        display: block;
-        padding: 5px 10px;
-        text-decoration: none;
-        border-top: 1px solid #eee;
-      }
-        #jump_page .source:hover {
-          background: #f5f5ff;
-        }
-        #jump_page .source:first-child {
-        }
-table td {
-  border: 0;
-  outline: 0;
-}
-  td.docs, th.docs {
-    max-width: 450px;
-    min-width: 450px;
+
+
+
+  #background {
+    position: absolute;
+    top: 0; bottom: 0;
+    width: 350px;
+    background: #fff;
+    border-right: 1px solid #e5e5ee;
+    z-index: -1;
+  }
+
+  ul.sections > li > div.annotation ul, ul.sections > li > div.annotation ol {
+    padding-left: 40px;
+  }
+
+  ul.sections > li {
+    white-space: nowrap;
+  }
+
+  ul.sections > li > div {
+    display: inline-block;
+  }
+
+  ul.sections > li > div.annotation {
+    max-width: 350px;
+    min-width: 350px;
     min-height: 5px;
-    padding: 10px 25px 1px 50px;
+    padding: 13px;
     overflow-x: hidden;
+    white-space: normal;
     vertical-align: top;
     text-align: left;
   }
-    .docs pre {
-      margin: 15px 0 15px;
-      padding-left: 15px;
-    }
-    .docs p tt, .docs p code {
-      background: #f8f8ff;
-      border: 1px solid #dedede;
-      font-size: 12px;
-      padding: 0 0.2em;
-    }
-    .pilwrap {
-      position: relative;
-    }
-      .pilcrow {
-        font: 12px Arial;
-        text-decoration: none;
-        color: #454545;
-        position: absolute;
-        top: 3px; left: -20px;
-        padding: 1px 2px;
-        opacity: 0;
-        -webkit-transition: opacity 0.2s linear;
-      }
-        td.docs:hover .pilcrow {
-          opacity: 1;
-        }
-  td.code, th.code {
-    padding: 14px 15px 16px 25px;
-    width: 100%;
+  ul.sections > li > div.annotation pre {
+    margin: 15px 0 15px;
+    padding-left: 15px;
+  }
+
+  ul.sections > li > div.content {
+    padding: 13px;
     vertical-align: top;
     background: #f5f5ff;
-    border-left: 1px solid #e5e5ee;
+    border: none;
+    -webkit-box-shadow: none;
+    box-shadow: none;
   }
-    pre, tt, code {
-      font-size: 12px; line-height: 18px;
-      font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
-      margin: 0; padding: 0;
+
+  .pilwrap {
+    position: relative;
+    display: inline;
+  }
+
+  .pilcrow {
+    font: 12px Arial;
+    text-decoration: none;
+    color: #454545;
+    position: absolute;
+    top: 3px; left: -20px;
+    padding: 1px 2px;
+    opacity: 0;
+    -webkit-transition: opacity 0.2s linear;
+  }
+    .for-h1 .pilcrow {
+      top: 47px;
+    }
+    .for-h2 .pilcrow, .for-h3 .pilcrow, .for-h4 .pilcrow {
+      top: 35px;
     }
 
+  ul.sections > li > div.annotation:hover .pilcrow {
+    opacity: 1;
+  }
+}
+
+/*---------------------- (> 1025px) ---------------------*/
+@media only screen and (min-width: 1025px) {
+
+  body {
+    font-size: 16px;
+    line-height: 24px;
+  }
+
+  #background {
+    width: 525px;
+  }
+  ul.sections > li > div.annotation {
+    max-width: 525px;
+    min-width: 525px;
+    padding: 10px 25px 1px 50px;
+  }
+  ul.sections > li > div.content {
+    padding: 9px 15px 16px 25px;
+  }
+}
 
 /*---------------------- Syntax Highlighting -----------------------------*/
+
 td.linenos { background-color: #f0f0f0; padding-right: 10px; }
 span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
-body .hll { background-color: #ffffcc }
-body .c { color: #408080; font-style: italic }  /* Comment */
-body .err { border: 1px solid #FF0000 }         /* Error */
-body .k { color: #954121 }                      /* Keyword */
-body .o { color: #666666 }                      /* Operator */
-body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
-body .cp { color: #BC7A00 }                     /* Comment.Preproc */
-body .c1 { color: #408080; font-style: italic } /* Comment.Single */
-body .cs { color: #408080; font-style: italic } /* Comment.Special */
-body .gd { color: #A00000 }                     /* Generic.Deleted */
-body .ge { font-style: italic }                 /* Generic.Emph */
-body .gr { color: #FF0000 }                     /* Generic.Error */
-body .gh { color: #000080; font-weight: bold }  /* Generic.Heading */
-body .gi { color: #00A000 }                     /* Generic.Inserted */
-body .go { color: #808080 }                     /* Generic.Output */
-body .gp { color: #000080; font-weight: bold }  /* Generic.Prompt */
-body .gs { font-weight: bold }                  /* Generic.Strong */
-body .gu { color: #800080; font-weight: bold }  /* Generic.Subheading */
-body .gt { color: #0040D0 }                     /* Generic.Traceback */
-body .kc { color: #954121 }                     /* Keyword.Constant */
-body .kd { color: #954121; font-weight: bold }  /* Keyword.Declaration */
-body .kn { color: #954121; font-weight: bold }  /* Keyword.Namespace */
-body .kp { color: #954121 }                     /* Keyword.Pseudo */
-body .kr { color: #954121; font-weight: bold }  /* Keyword.Reserved */
-body .kt { color: #B00040 }                     /* Keyword.Type */
-body .m { color: #666666 }                      /* Literal.Number */
-body .s { color: #219161 }                      /* Literal.String */
-body .na { color: #7D9029 }                     /* Name.Attribute */
-body .nb { color: #954121 }                     /* Name.Builtin */
-body .nc { color: #0000FF; font-weight: bold }  /* Name.Class */
-body .no { color: #880000 }                     /* Name.Constant */
-body .nd { color: #AA22FF }                     /* Name.Decorator */
-body .ni { color: #999999; font-weight: bold }  /* Name.Entity */
-body .ne { color: #D2413A; font-weight: bold }  /* Name.Exception */
-body .nf { color: #0000FF }                     /* Name.Function */
-body .nl { color: #A0A000 }                     /* Name.Label */
-body .nn { color: #0000FF; font-weight: bold }  /* Name.Namespace */
-body .nt { color: #954121; font-weight: bold }  /* Name.Tag */
-body .nv { color: #19469D }                     /* Name.Variable */
-body .ow { color: #AA22FF; font-weight: bold }  /* Operator.Word */
-body .w { color: #bbbbbb }                      /* Text.Whitespace */
-body .mf { color: #666666 }                     /* Literal.Number.Float */
-body .mh { color: #666666 }                     /* Literal.Number.Hex */
-body .mi { color: #666666 }                     /* Literal.Number.Integer */
-body .mo { color: #666666 }                     /* Literal.Number.Oct */
-body .sb { color: #219161 }                     /* Literal.String.Backtick */
-body .sc { color: #219161 }                     /* Literal.String.Char */
-body .sd { color: #219161; font-style: italic } /* Literal.String.Doc */
-body .s2 { color: #219161 }                     /* Literal.String.Double */
-body .se { color: #BB6622; font-weight: bold }  /* Literal.String.Escape */
-body .sh { color: #219161 }                     /* Literal.String.Heredoc */
-body .si { color: #BB6688; font-weight: bold }  /* Literal.String.Interpol */
-body .sx { color: #954121 }                     /* Literal.String.Other */
-body .sr { color: #BB6688 }                     /* Literal.String.Regex */
-body .s1 { color: #219161 }                     /* Literal.String.Single */
-body .ss { color: #19469D }                     /* Literal.String.Symbol */
-body .bp { color: #954121 }                     /* Name.Builtin.Pseudo */
-body .vc { color: #19469D }                     /* Name.Variable.Class */
-body .vg { color: #19469D }                     /* Name.Variable.Global */
-body .vi { color: #19469D }                     /* Name.Variable.Instance */
-body .il { color: #666666 }                     /* Literal.Number.Integer.Long */
\ No newline at end of file
+/*
+
+github.com style (c) Vasily Polovnyov <vast@whiteants.net>
+
+*/
+
+pre code {
+  display: block; padding: 0.5em;
+  color: #000;
+  background: #f8f8ff
+}
+
+pre .comment,
+pre .template_comment,
+pre .diff .header,
+pre .javadoc {
+  color: #408080;
+  font-style: italic
+}
+
+pre .keyword,
+pre .assignment,
+pre .literal,
+pre .css .rule .keyword,
+pre .winutils,
+pre .javascript .title,
+pre .lisp .title,
+pre .subst {
+  color: #954121;
+  /*font-weight: bold*/
+}
+
+pre .number,
+pre .hexcolor {
+  color: #40a070
+}
+
+pre .string,
+pre .tag .value,
+pre .phpdoc,
+pre .tex .formula {
+  color: #219161;
+}
+
+pre .title,
+pre .id {
+  color: #19469D;
+}
+pre .params {
+  color: #00F;
+}
+
+pre .javascript .title,
+pre .lisp .title,
+pre .subst {
+  font-weight: normal
+}
+
+pre .class .title,
+pre .haskell .label,
+pre .tex .command {
+  color: #458;
+  font-weight: bold
+}
+
+pre .tag,
+pre .tag .title,
+pre .rules .property,
+pre .django .tag .keyword {
+  color: #000080;
+  font-weight: normal
+}
+
+pre .attribute,
+pre .variable,
+pre .instancevar,
+pre .lisp .body {
+  color: #008080
+}
+
+pre .regexp {
+  color: #B68
+}
+
+pre .class {
+  color: #458;
+  font-weight: bold
+}
+
+pre .symbol,
+pre .ruby .symbol .string,
+pre .ruby .symbol .keyword,
+pre .ruby .symbol .keymethods,
+pre .lisp .keyword,
+pre .tex .special,
+pre .input_number {
+  color: #990073
+}
+
+pre .builtin,
+pre .constructor,
+pre .built_in,
+pre .lisp .title {
+  color: #0086b3
+}
+
+pre .preprocessor,
+pre .pi,
+pre .doctype,
+pre .shebang,
+pre .cdata {
+  color: #999;
+  font-weight: bold
+}
+
+pre .deletion {
+  background: #fdd
+}
+
+pre .addition {
+  background: #dfd
+}
+
+pre .diff .change {
+  background: #0086b3
+}
+
+pre .chunk {
+  color: #aaa
+}
+
+pre .tex .formula {
+  opacity: 0.5;
+}
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.eot b/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.eot
new file mode 100755
index 0000000..1b32532
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.eot differ
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.ttf b/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.ttf
new file mode 100755
index 0000000..dc4cc9c
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.ttf differ
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.woff b/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.woff
new file mode 100755
index 0000000..fa16fd0
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/aller-bold.woff differ
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.eot b/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.eot
new file mode 100755
index 0000000..40bd654
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.eot differ
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.ttf b/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.ttf
new file mode 100755
index 0000000..c2c7290
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.ttf differ
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.woff b/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.woff
new file mode 100755
index 0000000..81a09d1
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/aller-light.woff differ
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.eot b/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.eot
new file mode 100755
index 0000000..98a9a7f
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.eot differ
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.ttf b/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.ttf
new file mode 100755
index 0000000..2af39b0
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.ttf differ
diff --git a/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.woff b/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.woff
new file mode 100755
index 0000000..de558b5
Binary files /dev/null and b/profiles/commons/libraries/underscore/docs/public/fonts/novecento-bold.woff differ
diff --git a/profiles/commons/libraries/underscore/docs/public/stylesheets/normalize.css b/profiles/commons/libraries/underscore/docs/public/stylesheets/normalize.css
new file mode 100644
index 0000000..73abb76
--- /dev/null
+++ b/profiles/commons/libraries/underscore/docs/public/stylesheets/normalize.css
@@ -0,0 +1,375 @@
+/*! normalize.css v2.0.1 | MIT License | git.io/normalize */
+
+/* ==========================================================================
+   HTML5 display definitions
+   ========================================================================== */
+
+/*
+ * Corrects `block` display not defined in IE 8/9.
+ */
+
+article,
+aside,
+details,
+figcaption,
+figure,
+footer,
+header,
+hgroup,
+nav,
+section,
+summary {
+    display: block;
+}
+
+/*
+ * Corrects `inline-block` display not defined in IE 8/9.
+ */
+
+audio,
+canvas,
+video {
+    display: inline-block;
+}
+
+/*
+ * Prevents modern browsers from displaying `audio` without controls.
+ * Remove excess height in iOS 5 devices.
+ */
+
+audio:not([controls]) {
+    display: none;
+    height: 0;
+}
+
+/*
+ * Addresses styling for `hidden` attribute not present in IE 8/9.
+ */
+
+[hidden] {
+    display: none;
+}
+
+/* ==========================================================================
+   Base
+   ========================================================================== */
+
+/*
+ * 1. Sets default font family to sans-serif.
+ * 2. Prevents iOS text size adjust after orientation change, without disabling
+ *    user zoom.
+ */
+
+html {
+    font-family: sans-serif; /* 1 */
+    -webkit-text-size-adjust: 100%; /* 2 */
+    -ms-text-size-adjust: 100%; /* 2 */
+}
+
+/*
+ * Removes default margin.
+ */
+
+body {
+    margin: 0;
+}
+
+/* ==========================================================================
+   Links
+   ========================================================================== */
+
+/*
+ * Addresses `outline` inconsistency between Chrome and other browsers.
+ */
+
+a:focus {
+    outline: thin dotted;
+}
+
+/*
+ * Improves readability when focused and also mouse hovered in all browsers.
+ */
+
+a:active,
+a:hover {
+    outline: 0;
+}
+
+/* ==========================================================================
+   Typography
+   ========================================================================== */
+
+/*
+ * Addresses `h1` font sizes within `section` and `article` in Firefox 4+,
+ * Safari 5, and Chrome.
+ */
+
+h1 {
+    font-size: 2em;
+}
+
+/*
+ * Addresses styling not present in IE 8/9, Safari 5, and Chrome.
+ */
+
+abbr[title] {
+    border-bottom: 1px dotted;
+}
+
+/*
+ * Addresses style set to `bolder` in Firefox 4+, Safari 5, and Chrome.
+ */
+
+b,
+strong {
+    font-weight: bold;
+}
+
+/*
+ * Addresses styling not present in Safari 5 and Chrome.
+ */
+
+dfn {
+    font-style: italic;
+}
+
+/*
+ * Addresses styling not present in IE 8/9.
+ */
+
+mark {
+    background: #ff0;
+    color: #000;
+}
+
+
+/*
+ * Corrects font family set oddly in Safari 5 and Chrome.
+ */
+
+code,
+kbd,
+pre,
+samp {
+    font-family: monospace, serif;
+    font-size: 1em;
+}
+
+/*
+ * Improves readability of pre-formatted text in all browsers.
+ */
+
+pre {
+    white-space: pre;
+    white-space: pre-wrap;
+    word-wrap: break-word;
+}
+
+/*
+ * Sets consistent quote types.
+ */
+
+q {
+    quotes: "\201C" "\201D" "\2018" "\2019";
+}
+
+/*
+ * Addresses inconsistent and variable font size in all browsers.
+ */
+
+small {
+    font-size: 80%;
+}
+
+/*
+ * Prevents `sub` and `sup` affecting `line-height` in all browsers.
+ */
+
+sub,
+sup {
+    font-size: 75%;
+    line-height: 0;
+    position: relative;
+    vertical-align: baseline;
+}
+
+sup {
+    top: -0.5em;
+}
+
+sub {
+    bottom: -0.25em;
+}
+
+/* ==========================================================================
+   Embedded content
+   ========================================================================== */
+
+/*
+ * Removes border when inside `a` element in IE 8/9.
+ */
+
+img {
+    border: 0;
+}
+
+/*
+ * Corrects overflow displayed oddly in IE 9.
+ */
+
+svg:not(:root) {
+    overflow: hidden;
+}
+
+/* ==========================================================================
+   Figures
+   ========================================================================== */
+
+/*
+ * Addresses margin not present in IE 8/9 and Safari 5.
+ */
+
+figure {
+    margin: 0;
+}
+
+/* ==========================================================================
+   Forms
+   ========================================================================== */
+
+/*
+ * Define consistent border, margin, and padding.
+ */
+
+fieldset {
+    border: 1px solid #c0c0c0;
+    margin: 0 2px;
+    padding: 0.35em 0.625em 0.75em;
+}
+
+/*
+ * 1. Corrects color not being inherited in IE 8/9.
+ * 2. Remove padding so people aren't caught out if they zero out fieldsets.
+ */
+
+legend {
+    border: 0; /* 1 */
+    padding: 0; /* 2 */
+}
+
+/*
+ * 1. Corrects font family not being inherited in all browsers.
+ * 2. Corrects font size not being inherited in all browsers.
+ * 3. Addresses margins set differently in Firefox 4+, Safari 5, and Chrome
+ */
+
+button,
+input,
+select,
+textarea {
+    font-family: inherit; /* 1 */
+    font-size: 100%; /* 2 */
+    margin: 0; /* 3 */
+}
+
+/*
+ * Addresses Firefox 4+ setting `line-height` on `input` using `!important` in
+ * the UA stylesheet.
+ */
+
+button,
+input {
+    line-height: normal;
+}
+
+/*
+ * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
+ *    and `video` controls.
+ * 2. Corrects inability to style clickable `input` types in iOS.
+ * 3. Improves usability and consistency of cursor style between image-type
+ *    `input` and others.
+ */
+
+button,
+html input[type="button"], /* 1 */
+input[type="reset"],
+input[type="submit"] {
+    -webkit-appearance: button; /* 2 */
+    cursor: pointer; /* 3 */
+}
+
+/*
+ * Re-set default cursor for disabled elements.
+ */
+
+button[disabled],
+input[disabled] {
+    cursor: default;
+}
+
+/*
+ * 1. Addresses box sizing set to `content-box` in IE 8/9.
+ * 2. Removes excess padding in IE 8/9.
+ */
+
+input[type="checkbox"],
+input[type="radio"] {
+    box-sizing: border-box; /* 1 */
+    padding: 0; /* 2 */
+}
+
+/*
+ * 1. Addresses `appearance` set to `searchfield` in Safari 5 and Chrome.
+ * 2. Addresses `box-sizing` set to `border-box` in Safari 5 and Chrome
+ *    (include `-moz` to future-proof).
+ */
+
+input[type="search"] {
+    -webkit-appearance: textfield; /* 1 */
+    -moz-box-sizing: content-box;
+    -webkit-box-sizing: content-box; /* 2 */
+    box-sizing: content-box;
+}
+
+/*
+ * Removes inner padding and search cancel button in Safari 5 and Chrome
+ * on OS X.
+ */
+
+input[type="search"]::-webkit-search-cancel-button,
+input[type="search"]::-webkit-search-decoration {
+    -webkit-appearance: none;
+}
+
+/*
+ * Removes inner padding and border in Firefox 4+.
+ */
+
+button::-moz-focus-inner,
+input::-moz-focus-inner {
+    border: 0;
+    padding: 0;
+}
+
+/*
+ * 1. Removes default vertical scrollbar in IE 8/9.
+ * 2. Improves readability and alignment in all browsers.
+ */
+
+textarea {
+    overflow: auto; /* 1 */
+    vertical-align: top; /* 2 */
+}
+
+/* ==========================================================================
+   Tables
+   ========================================================================== */
+
+/*
+ * Remove most spacing between table cells.
+ */
+
+table {
+    border-collapse: collapse;
+    border-spacing: 0;
+}
\ No newline at end of file
diff --git a/profiles/commons/libraries/underscore/docs/underscore.html b/profiles/commons/libraries/underscore/docs/underscore.html
index fbe3977..b96d408 100644
--- a/profiles/commons/libraries/underscore/docs/underscore.html
+++ b/profiles/commons/libraries/underscore/docs/underscore.html
@@ -1,823 +1,3061 @@
-<!DOCTYPE html>  <html> <head>   <title>underscore.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               underscore.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>Underscore.js 1.4.4
+<!DOCTYPE html>
+
+<html>
+<head>
+  <title>underscore.js</title>
+  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
+  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
+  <link rel="stylesheet" media="all" href="docco.css" />
+</head>
+<body>
+  <div id="container">
+    <div id="background"></div>
+    
+    <ul class="sections">
+        
+          <li id="title">
+              <div class="annotation">
+                  <h1>underscore.js</h1>
+              </div>
+          </li>
+        
+        
+        
+        <li id="section-1">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-1">&#182;</a>
+              </div>
+              <pre><code>Underscore.js 1.5.2
 http://underscorejs.org
-(c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
-Underscore may be freely distributed under the MIT license.
-</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Baseline setup</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Establish the root object, <code>window</code> in the browser, or <code>global</code> on the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Save the previous value of the <code>_</code> variable.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">previousUnderscore</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">_</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Establish the object that gets returned to break out of a loop iteration.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">breaker</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Save bytes in the minified (but not gzipped) version:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">ArrayProto</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">ObjProto</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">FuncProto</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Create quick reference variables for speed access to core prototypes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">push</span>             <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">push</span><span class="p">,</span>
-      <span class="nx">slice</span>            <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">slice</span><span class="p">,</span>
-      <span class="nx">concat</span>           <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">concat</span><span class="p">,</span>
-      <span class="nx">toString</span>         <span class="o">=</span> <span class="nx">ObjProto</span><span class="p">.</span><span class="nx">toString</span><span class="p">,</span>
-      <span class="nx">hasOwnProperty</span>   <span class="o">=</span> <span class="nx">ObjProto</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>All <strong>ECMAScript 5</strong> native function implementations that we hope to use
-are declared here.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span>
-    <span class="nx">nativeForEach</span>      <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">forEach</span><span class="p">,</span>
-    <span class="nx">nativeMap</span>          <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
-    <span class="nx">nativeReduce</span>       <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">reduce</span><span class="p">,</span>
-    <span class="nx">nativeReduceRight</span>  <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">reduceRight</span><span class="p">,</span>
-    <span class="nx">nativeFilter</span>       <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span>
-    <span class="nx">nativeEvery</span>        <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">every</span><span class="p">,</span>
-    <span class="nx">nativeSome</span>         <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">some</span><span class="p">,</span>
-    <span class="nx">nativeIndexOf</span>      <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">,</span>
-    <span class="nx">nativeLastIndexOf</span>  <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">,</span>
-    <span class="nx">nativeIsArray</span>      <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">,</span>
-    <span class="nx">nativeKeys</span>         <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">,</span>
-    <span class="nx">nativeBind</span>         <span class="o">=</span> <span class="nx">FuncProto</span><span class="p">.</span><span class="nx">bind</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Create a safe reference to the Underscore object for use below.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">_</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">_</span><span class="p">))</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">_</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
-    <span class="k">this</span><span class="p">.</span><span class="nx">_wrapped</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Export the Underscore object for <strong>Node.js</strong>, with
-backwards-compatibility for the old <code>require()</code> API. If we're in
+(c) 2009-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters &amp; Editors
+Underscore may be freely distributed under the MIT license.</code></pre>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>(<span class="keyword">function</span>() {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-2">
+            <div class="annotation">
+              
+              <div class="pilwrap for-h2">
+                <a class="pilcrow" href="#section-2">&#182;</a>
+              </div>
+              <h2>Baseline setup</h2>
+
+            </div>
+            
+        </li>
+        
+        
+        <li id="section-3">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-3">&#182;</a>
+              </div>
+              <p>Establish the root object, <code>window</code> in the browser, or <code>exports</code> on the server.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> root = <span class="keyword">this</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-4">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-4">&#182;</a>
+              </div>
+              <p>Save the previous value of the <code>_</code> variable.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> previousUnderscore = root._;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-5">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-5">&#182;</a>
+              </div>
+              <p>Establish the object that gets returned to break out of a loop iteration.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> breaker = {};</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-6">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-6">&#182;</a>
+              </div>
+              <p>Save bytes in the minified (but not gzipped) version:</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> ArrayProto = Array.prototype, ObjProto = Object.prototype, FuncProto = Function.prototype;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-7">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-7">&#182;</a>
+              </div>
+              <p>Create quick reference variables for speed access to core prototypes.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span>
+    push             = ArrayProto.push,
+    slice            = ArrayProto.slice,
+    concat           = ArrayProto.concat,
+    toString         = ObjProto.toString,
+    hasOwnProperty   = ObjProto.hasOwnProperty;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-8">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-8">&#182;</a>
+              </div>
+              <p>All <strong>ECMAScript 5</strong> native function implementations that we hope to use
+are declared here.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span>
+    nativeForEach      = ArrayProto.forEach,
+    nativeMap          = ArrayProto.map,
+    nativeReduce       = ArrayProto.reduce,
+    nativeReduceRight  = ArrayProto.reduceRight,
+    nativeFilter       = ArrayProto.filter,
+    nativeEvery        = ArrayProto.every,
+    nativeSome         = ArrayProto.some,
+    nativeIndexOf      = ArrayProto.indexOf,
+    nativeLastIndexOf  = ArrayProto.lastIndexOf,
+    nativeIsArray      = Array.isArray,
+    nativeKeys         = Object.keys,
+    nativeBind         = FuncProto.bind;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-9">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-9">&#182;</a>
+              </div>
+              <p>Create a safe reference to the Underscore object for use below.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> _ = <span class="keyword">function</span>(obj) {
+    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;
+    <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);
+    <span class="keyword">this</span>._wrapped = obj;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-10">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-10">&#182;</a>
+              </div>
+              <p>Export the Underscore object for <strong>Node.js</strong>, with
+backwards-compatibility for the old <code>require()</code> API. If we&#39;re in
 the browser, add <code>_</code> as a global object via a string identifier,
-for Closure Compiler "advanced" mode.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">exports</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
-    <span class="p">}</span>
-    <span class="nx">exports</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
-  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
-    <span class="nx">root</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
-  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Current version.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">VERSION</span> <span class="o">=</span> <span class="s1">&#39;1.4.4&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>Collection Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The cornerstone, an <code>each</code> implementation, aka <code>forEach</code>.
+for Closure Compiler &quot;advanced&quot; mode.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">'undefined'</span>) {
+    <span class="keyword">if</span> (<span class="keyword">typeof</span> module !== <span class="string">'undefined'</span> &amp;&amp; module.exports) {
+      exports = module.exports = _;
+    }
+    exports._ = _;
+  } <span class="keyword">else</span> {
+    root._ = _;
+  }</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-11">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-11">&#182;</a>
+              </div>
+              <p>Current version.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.VERSION = <span class="string">'1.5.2'</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-12">
+            <div class="annotation">
+              
+              <div class="pilwrap for-h2">
+                <a class="pilcrow" href="#section-12">&#182;</a>
+              </div>
+              <h2>Collection Functions</h2>
+
+            </div>
+            
+        </li>
+        
+        
+        <li id="section-13">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-13">&#182;</a>
+              </div>
+              <p>The cornerstone, an <code>each</code> implementation, aka <code>forEach</code>.
 Handles objects with the built-in <code>forEach</code>, arrays, and raw objects.
-Delegates to <strong>ECMAScript 5</strong>'s native <code>forEach</code> if available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">each</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">forEach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeForEach</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">forEach</span> <span class="o">===</span> <span class="nx">nativeForEach</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">obj</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
-    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">if</span> <span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="o">===</span> <span class="nx">breaker</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
-      <span class="p">}</span>
-    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
-      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
-          <span class="k">if</span> <span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="o">===</span> <span class="nx">breaker</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
-        <span class="p">}</span>
-      <span class="p">}</span>
-    <span class="p">}</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Return the results of applying the iterator to each element.
-Delegates to <strong>ECMAScript 5</strong>'s native <code>map</code> if available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">collect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeMap</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">map</span> <span class="o">===</span> <span class="nx">nativeMap</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">results</span><span class="p">[</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">);</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
-  <span class="p">};</span>
-
-  <span class="kd">var</span> <span class="nx">reduceError</span> <span class="o">=</span> <span class="s1">&#39;Reduce of empty array with no initial value&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><strong>Reduce</strong> builds up a single result from a list of values, aka <code>inject</code>,
-or <code>foldl</code>. Delegates to <strong>ECMAScript 5</strong>'s native <code>reduce</code> if available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">foldl</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">inject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">initial</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeReduce</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">===</span> <span class="nx">nativeReduce</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
-      <span class="k">return</span> <span class="nx">initial</span> <span class="o">?</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">memo</span><span class="p">)</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">iterator</span><span class="p">);</span>
-    <span class="p">}</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initial</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">memo</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
-        <span class="nx">initial</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
-      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
-        <span class="nx">memo</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">);</span>
-      <span class="p">}</span>
-    <span class="p">});</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initial</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">reduceError</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">memo</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>The right-associative version of reduce, also known as <code>foldr</code>.
-Delegates to <strong>ECMAScript 5</strong>'s native <code>reduceRight</code> if available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">foldr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">initial</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeReduceRight</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="o">===</span> <span class="nx">nativeReduceRight</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
-      <span class="k">return</span> <span class="nx">initial</span> <span class="o">?</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduceRight</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">memo</span><span class="p">)</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">reduceRight</span><span class="p">(</span><span class="nx">iterator</span><span class="p">);</span>
-    <span class="p">}</span>
-    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">!==</span> <span class="o">+</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
-      <span class="nx">length</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
-    <span class="p">}</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">index</span> <span class="o">=</span> <span class="nx">keys</span> <span class="o">?</span> <span class="nx">keys</span><span class="p">[</span><span class="o">--</span><span class="nx">length</span><span class="p">]</span> <span class="o">:</span> <span class="o">--</span><span class="nx">length</span><span class="p">;</span>
-      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initial</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">memo</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
-        <span class="nx">initial</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
-      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
-        <span class="nx">memo</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">);</span>
-      <span class="p">}</span>
-    <span class="p">});</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">initial</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">reduceError</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">memo</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Return the first value which passes a truth test. Aliased as <code>detect</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">detect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
-    <span class="nx">any</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">))</span> <span class="p">{</span>
-        <span class="nx">result</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
-        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
-      <span class="p">}</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Return all the elements that pass a truth test.
-Delegates to <strong>ECMAScript 5</strong>'s native <code>filter</code> if available.
-Aliased as <code>select</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeFilter</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">filter</span> <span class="o">===</span> <span class="nx">nativeFilter</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">))</span> <span class="nx">results</span><span class="p">[</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Return all the elements for which a truth test fails.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">reject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="o">!</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">);</span>
-    <span class="p">},</span> <span class="nx">context</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Determine whether all of the elements match a truth test.
-Delegates to <strong>ECMAScript 5</strong>'s native <code>every</code> if available.
-Aliased as <code>all</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">every</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">all</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">iterator</span> <span class="o">||</span> <span class="p">(</span><span class="nx">iterator</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">identity</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeEvery</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">every</span> <span class="o">===</span> <span class="nx">nativeEvery</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)))</span> <span class="k">return</span> <span class="nx">breaker</span><span class="p">;</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="o">!!</span><span class="nx">result</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Determine if at least one element in the object matches a truth test.
-Delegates to <strong>ECMAScript 5</strong>'s native <code>some</code> if available.
-Aliased as <code>any</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">any</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">some</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">iterator</span> <span class="o">||</span> <span class="p">(</span><span class="nx">iterator</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">identity</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeSome</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">some</span> <span class="o">===</span> <span class="nx">nativeSome</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">||</span> <span class="p">(</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)))</span> <span class="k">return</span> <span class="nx">breaker</span><span class="p">;</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="o">!!</span><span class="nx">result</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Determine if the array or object contains a given value (using <code>===</code>).
-Aliased as <code>include</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">contains</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">include</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeIndexOf</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">===</span> <span class="nx">nativeIndexOf</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
-    <span class="k">return</span> <span class="nx">any</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">value</span> <span class="o">===</span> <span class="nx">target</span><span class="p">;</span>
-    <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Invoke a method (with arguments) on every item in a collection.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">invoke</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">isFunc</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">method</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="p">(</span><span class="nx">isFunc</span> <span class="o">?</span> <span class="nx">method</span> <span class="o">:</span> <span class="nx">value</span><span class="p">[</span><span class="nx">method</span><span class="p">]).</span><span class="nx">apply</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
-    <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Convenience version of a common use case of <code>map</code>: fetching a property.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span> <span class="k">return</span> <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Convenience version of a common use case of <code>filter</code>: selecting only objects
-containing specific <code>key:value</code> pairs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">where</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">first</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">attrs</span><span class="p">))</span> <span class="k">return</span> <span class="nx">first</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="p">[];</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">[</span><span class="nx">first</span> <span class="o">?</span> <span class="s1">&#39;find&#39;</span> <span class="o">:</span> <span class="s1">&#39;filter&#39;</span><span class="p">](</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
-      <span class="p">}</span>
-      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
-    <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Convenience version of a common use case of <code>find</code>: getting the first object
-containing specific <code>key:value</code> pairs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">findWhere</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Return the maximum element or (element-based computation).
-Can't optimize arrays of integers longer than 65,535 elements.
-See: https://bugs.webkit.org/show_bug.cgi?id=80797</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">iterator</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="o">+</span><span class="nx">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nb">Math</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
-    <span class="p">}</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">iterator</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">computed</span> <span class="o">:</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">};</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">computed</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">?</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
-      <span class="nx">computed</span> <span class="o">&gt;=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">computed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">value</span> <span class="o">:</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">computed</span> <span class="o">:</span> <span class="nx">computed</span><span class="p">});</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Return the minimum element (or element-based computation).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">iterator</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="o">+</span><span class="nx">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nb">Math</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
-    <span class="p">}</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">iterator</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="kc">Infinity</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">computed</span> <span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">};</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">computed</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">?</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
-      <span class="nx">computed</span> <span class="o">&lt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">computed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="nx">value</span> <span class="o">:</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">computed</span> <span class="o">:</span> <span class="nx">computed</span><span class="p">});</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Shuffle an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">shuffle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">rand</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">shuffled</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">rand</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">random</span><span class="p">(</span><span class="nx">index</span><span class="o">++</span><span class="p">);</span>
-      <span class="nx">shuffled</span><span class="p">[</span><span class="nx">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">shuffled</span><span class="p">[</span><span class="nx">rand</span><span class="p">];</span>
-      <span class="nx">shuffled</span><span class="p">[</span><span class="nx">rand</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">shuffled</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>An internal function to generate lookup iterators.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">lookupIterator</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">value</span><span class="p">];</span> <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Sort the object's values by a criterion produced by an iterator.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">sortBy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">lookupIterator</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="p">{</span>
-        <span class="nx">value</span> <span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
-        <span class="nx">index</span> <span class="o">:</span> <span class="nx">index</span><span class="p">,</span>
-        <span class="nx">criteria</span> <span class="o">:</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span>
-      <span class="p">};</span>
-    <span class="p">}).</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">left</span><span class="p">.</span><span class="nx">criteria</span><span class="p">;</span>
-      <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">right</span><span class="p">.</span><span class="nx">criteria</span><span class="p">;</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">!==</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span> <span class="o">||</span> <span class="nx">a</span> <span class="o">===</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
-        <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span> <span class="o">||</span> <span class="nx">b</span> <span class="o">===</span> <span class="k">void</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
-      <span class="p">}</span>
-      <span class="k">return</span> <span class="nx">left</span><span class="p">.</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">index</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
-    <span class="p">}),</span> <span class="s1">&#39;value&#39;</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>An internal function used for aggregate "group by" operations.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">behavior</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
-    <span class="kd">var</span> <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">lookupIterator</span><span class="p">(</span><span class="nx">value</span> <span class="o">||</span> <span class="nx">_</span><span class="p">.</span><span class="nx">identity</span><span class="p">);</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
-      <span class="nx">behavior</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Groups the object's values by a criterion. Pass either a string attribute
-to group by, or a function that returns the criterion.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">groupBy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">group</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
-      <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">:</span> <span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[])).</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
-    <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Counts instances of an object that group by a certain criterion. Pass
+Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>forEach</code> if available.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> each = _.each = _.forEach = <span class="keyword">function</span>(obj, iterator, context) {
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span>;
+    <span class="keyword">if</span> (nativeForEach &amp;&amp; obj.forEach === nativeForEach) {
+      obj.forEach(iterator, context);
+    } <span class="keyword">else</span> <span class="keyword">if</span> (obj.length === +obj.length) {
+      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length = obj.length; i &lt; length; i++) {
+        <span class="keyword">if</span> (iterator.call(context, obj[i], i, obj) === breaker) <span class="keyword">return</span>;
+      }
+    } <span class="keyword">else</span> {
+      <span class="keyword">var</span> keys = _.keys(obj);
+      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length = keys.length; i &lt; length; i++) {
+        <span class="keyword">if</span> (iterator.call(context, obj[keys[i]], keys[i], obj) === breaker) <span class="keyword">return</span>;
+      }
+    }
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-14">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-14">&#182;</a>
+              </div>
+              <p>Return the results of applying the iterator to each element.
+Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>map</code> if available.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.map = _.collect = <span class="keyword">function</span>(obj, iterator, context) {
+    <span class="keyword">var</span> results = [];
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> results;
+    <span class="keyword">if</span> (nativeMap &amp;&amp; obj.map === nativeMap) <span class="keyword">return</span> obj.map(iterator, context);
+    each(obj, <span class="keyword">function</span>(value, index, list) {
+      results.push(iterator.call(context, value, index, list));
+    });
+    <span class="keyword">return</span> results;
+  };
+
+  <span class="keyword">var</span> reduceError = <span class="string">'Reduce of empty array with no initial value'</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-15">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-15">&#182;</a>
+              </div>
+              <p><strong>Reduce</strong> builds up a single result from a list of values, aka <code>inject</code>,
+or <code>foldl</code>. Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>reduce</code> if available.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.reduce = _.foldl = _.inject = <span class="keyword">function</span>(obj, iterator, memo, context) {
+    <span class="keyword">var</span> initial = arguments.length &gt; <span class="number">2</span>;
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) obj = [];
+    <span class="keyword">if</span> (nativeReduce &amp;&amp; obj.reduce === nativeReduce) {
+      <span class="keyword">if</span> (context) iterator = _.bind(iterator, context);
+      <span class="keyword">return</span> initial ? obj.reduce(iterator, memo) : obj.reduce(iterator);
+    }
+    each(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">if</span> (!initial) {
+        memo = value;
+        initial = <span class="literal">true</span>;
+      } <span class="keyword">else</span> {
+        memo = iterator.call(context, memo, value, index, list);
+      }
+    });
+    <span class="keyword">if</span> (!initial) <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(reduceError);
+    <span class="keyword">return</span> memo;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-16">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-16">&#182;</a>
+              </div>
+              <p>The right-associative version of reduce, also known as <code>foldr</code>.
+Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>reduceRight</code> if available.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.reduceRight = _.foldr = <span class="keyword">function</span>(obj, iterator, memo, context) {
+    <span class="keyword">var</span> initial = arguments.length &gt; <span class="number">2</span>;
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) obj = [];
+    <span class="keyword">if</span> (nativeReduceRight &amp;&amp; obj.reduceRight === nativeReduceRight) {
+      <span class="keyword">if</span> (context) iterator = _.bind(iterator, context);
+      <span class="keyword">return</span> initial ? obj.reduceRight(iterator, memo) : obj.reduceRight(iterator);
+    }
+    <span class="keyword">var</span> length = obj.length;
+    <span class="keyword">if</span> (length !== +length) {
+      <span class="keyword">var</span> keys = _.keys(obj);
+      length = keys.length;
+    }
+    each(obj, <span class="keyword">function</span>(value, index, list) {
+      index = keys ? keys[--length] : --length;
+      <span class="keyword">if</span> (!initial) {
+        memo = obj[index];
+        initial = <span class="literal">true</span>;
+      } <span class="keyword">else</span> {
+        memo = iterator.call(context, memo, obj[index], index, list);
+      }
+    });
+    <span class="keyword">if</span> (!initial) <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(reduceError);
+    <span class="keyword">return</span> memo;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-17">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-17">&#182;</a>
+              </div>
+              <p>Return the first value which passes a truth test. Aliased as <code>detect</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.find = _.detect = <span class="keyword">function</span>(obj, iterator, context) {
+    <span class="keyword">var</span> result;
+    any(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">if</span> (iterator.call(context, value, index, list)) {
+        result = value;
+        <span class="keyword">return</span> <span class="literal">true</span>;
+      }
+    });
+    <span class="keyword">return</span> result;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-18">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-18">&#182;</a>
+              </div>
+              <p>Return all the elements that pass a truth test.
+Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>filter</code> if available.
+Aliased as <code>select</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.filter = _.select = <span class="keyword">function</span>(obj, iterator, context) {
+    <span class="keyword">var</span> results = [];
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> results;
+    <span class="keyword">if</span> (nativeFilter &amp;&amp; obj.filter === nativeFilter) <span class="keyword">return</span> obj.filter(iterator, context);
+    each(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">if</span> (iterator.call(context, value, index, list)) results.push(value);
+    });
+    <span class="keyword">return</span> results;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-19">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-19">&#182;</a>
+              </div>
+              <p>Return all the elements for which a truth test fails.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.reject = <span class="keyword">function</span>(obj, iterator, context) {
+    <span class="keyword">return</span> _.filter(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">return</span> !iterator.call(context, value, index, list);
+    }, context);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-20">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-20">&#182;</a>
+              </div>
+              <p>Determine whether all of the elements match a truth test.
+Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>every</code> if available.
+Aliased as <code>all</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.every = _.all = <span class="keyword">function</span>(obj, iterator, context) {
+    iterator || (iterator = _.identity);
+    <span class="keyword">var</span> result = <span class="literal">true</span>;
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> result;
+    <span class="keyword">if</span> (nativeEvery &amp;&amp; obj.every === nativeEvery) <span class="keyword">return</span> obj.every(iterator, context);
+    each(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">if</span> (!(result = result &amp;&amp; iterator.call(context, value, index, list))) <span class="keyword">return</span> breaker;
+    });
+    <span class="keyword">return</span> !!result;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-21">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-21">&#182;</a>
+              </div>
+              <p>Determine if at least one element in the object matches a truth test.
+Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>some</code> if available.
+Aliased as <code>any</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> any = _.some = _.any = <span class="keyword">function</span>(obj, iterator, context) {
+    iterator || (iterator = _.identity);
+    <span class="keyword">var</span> result = <span class="literal">false</span>;
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> result;
+    <span class="keyword">if</span> (nativeSome &amp;&amp; obj.some === nativeSome) <span class="keyword">return</span> obj.some(iterator, context);
+    each(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">if</span> (result || (result = iterator.call(context, value, index, list))) <span class="keyword">return</span> breaker;
+    });
+    <span class="keyword">return</span> !!result;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-22">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-22">&#182;</a>
+              </div>
+              <p>Determine if the array or object contains a given value (using <code>===</code>).
+Aliased as <code>include</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.contains = _.include = <span class="keyword">function</span>(obj, target) {
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;
+    <span class="keyword">if</span> (nativeIndexOf &amp;&amp; obj.indexOf === nativeIndexOf) <span class="keyword">return</span> obj.indexOf(target) != -<span class="number">1</span>;
+    <span class="keyword">return</span> any(obj, <span class="keyword">function</span>(value) {
+      <span class="keyword">return</span> value === target;
+    });
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-23">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-23">&#182;</a>
+              </div>
+              <p>Invoke a method (with arguments) on every item in a collection.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.invoke = <span class="keyword">function</span>(obj, method) {
+    <span class="keyword">var</span> args = slice.call(arguments, <span class="number">2</span>);
+    <span class="keyword">var</span> isFunc = _.isFunction(method);
+    <span class="keyword">return</span> _.map(obj, <span class="keyword">function</span>(value) {
+      <span class="keyword">return</span> (isFunc ? method : value[method]).apply(value, args);
+    });
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-24">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-24">&#182;</a>
+              </div>
+              <p>Convenience version of a common use case of <code>map</code>: fetching a property.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.pluck = <span class="keyword">function</span>(obj, key) {
+    <span class="keyword">return</span> _.map(obj, <span class="keyword">function</span>(value){ <span class="keyword">return</span> value[key]; });
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-25">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-25">&#182;</a>
+              </div>
+              <p>Convenience version of a common use case of <code>filter</code>: selecting only objects
+containing specific <code>key:value</code> pairs.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.where = <span class="keyword">function</span>(obj, attrs, first) {
+    <span class="keyword">if</span> (_.isEmpty(attrs)) <span class="keyword">return</span> first ? <span class="keyword">void</span> <span class="number">0</span> : [];
+    <span class="keyword">return</span> _[first ? <span class="string">'find'</span> : <span class="string">'filter'</span>](obj, <span class="keyword">function</span>(value) {
+      <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> attrs) {
+        <span class="keyword">if</span> (attrs[key] !== value[key]) <span class="keyword">return</span> <span class="literal">false</span>;
+      }
+      <span class="keyword">return</span> <span class="literal">true</span>;
+    });
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-26">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-26">&#182;</a>
+              </div>
+              <p>Convenience version of a common use case of <code>find</code>: getting the first object
+containing specific <code>key:value</code> pairs.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.findWhere = <span class="keyword">function</span>(obj, attrs) {
+    <span class="keyword">return</span> _.where(obj, attrs, <span class="literal">true</span>);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-27">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-27">&#182;</a>
+              </div>
+              <p>Return the maximum element or (element-based computation).
+Can&#39;t optimize arrays of integers longer than 65,535 elements.
+See <a href="https://bugs.webkit.org/show_bug.cgi?id=80797">WebKit Bug 80797</a></p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.max = <span class="keyword">function</span>(obj, iterator, context) {
+    <span class="keyword">if</span> (!iterator &amp;&amp; _.isArray(obj) &amp;&amp; obj[<span class="number">0</span>] === +obj[<span class="number">0</span>] &amp;&amp; obj.length &lt; <span class="number">65535</span>) {
+      <span class="keyword">return</span> Math.max.apply(Math, obj);
+    }
+    <span class="keyword">if</span> (!iterator &amp;&amp; _.isEmpty(obj)) <span class="keyword">return</span> -<span class="literal">Infinity</span>;
+    <span class="keyword">var</span> result = {computed : -<span class="literal">Infinity</span>, value: -<span class="literal">Infinity</span>};
+    each(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">var</span> computed = iterator ? iterator.call(context, value, index, list) : value;
+      computed &gt; result.computed &amp;&amp; (result = {value : value, computed : computed});
+    });
+    <span class="keyword">return</span> result.value;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-28">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-28">&#182;</a>
+              </div>
+              <p>Return the minimum element (or element-based computation).</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.min = <span class="keyword">function</span>(obj, iterator, context) {
+    <span class="keyword">if</span> (!iterator &amp;&amp; _.isArray(obj) &amp;&amp; obj[<span class="number">0</span>] === +obj[<span class="number">0</span>] &amp;&amp; obj.length &lt; <span class="number">65535</span>) {
+      <span class="keyword">return</span> Math.min.apply(Math, obj);
+    }
+    <span class="keyword">if</span> (!iterator &amp;&amp; _.isEmpty(obj)) <span class="keyword">return</span> <span class="literal">Infinity</span>;
+    <span class="keyword">var</span> result = {computed : <span class="literal">Infinity</span>, value: <span class="literal">Infinity</span>};
+    each(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">var</span> computed = iterator ? iterator.call(context, value, index, list) : value;
+      computed &lt; result.computed &amp;&amp; (result = {value : value, computed : computed});
+    });
+    <span class="keyword">return</span> result.value;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-29">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-29">&#182;</a>
+              </div>
+              <p>Shuffle an array, using the modern version of the 
+<a href="http://en.wikipedia.org/wiki/Fisher–Yates_shuffle">Fisher-Yates shuffle</a>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.shuffle = <span class="keyword">function</span>(obj) {
+    <span class="keyword">var</span> rand;
+    <span class="keyword">var</span> index = <span class="number">0</span>;
+    <span class="keyword">var</span> shuffled = [];
+    each(obj, <span class="keyword">function</span>(value) {
+      rand = _.random(index++);
+      shuffled[index - <span class="number">1</span>] = shuffled[rand];
+      shuffled[rand] = value;
+    });
+    <span class="keyword">return</span> shuffled;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-30">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-30">&#182;</a>
+              </div>
+              <p>Sample <strong>n</strong> random values from an array.
+If <strong>n</strong> is not specified, returns a single random element from the array.
+The internal <code>guard</code> argument allows it to work with <code>map</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.sample = <span class="keyword">function</span>(obj, n, guard) {
+    <span class="keyword">if</span> (arguments.length &lt; <span class="number">2</span> || guard) {
+      <span class="keyword">return</span> obj[_.random(obj.length - <span class="number">1</span>)];
+    }
+    <span class="keyword">return</span> _.shuffle(obj).slice(<span class="number">0</span>, Math.max(<span class="number">0</span>, n));
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-31">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-31">&#182;</a>
+              </div>
+              <p>An internal function to generate lookup iterators.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> lookupIterator = <span class="keyword">function</span>(value) {
+    <span class="keyword">return</span> _.isFunction(value) ? value : <span class="keyword">function</span>(obj){ <span class="keyword">return</span> obj[value]; };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-32">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-32">&#182;</a>
+              </div>
+              <p>Sort the object&#39;s values by a criterion produced by an iterator.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.sortBy = <span class="keyword">function</span>(obj, value, context) {
+    <span class="keyword">var</span> iterator = lookupIterator(value);
+    <span class="keyword">return</span> _.pluck(_.map(obj, <span class="keyword">function</span>(value, index, list) {
+      <span class="keyword">return</span> {
+        value: value,
+        index: index,
+        criteria: iterator.call(context, value, index, list)
+      };
+    }).sort(<span class="keyword">function</span>(left, right) {
+      <span class="keyword">var</span> a = left.criteria;
+      <span class="keyword">var</span> b = right.criteria;
+      <span class="keyword">if</span> (a !== b) {
+        <span class="keyword">if</span> (a &gt; b || a === <span class="keyword">void</span> <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;
+        <span class="keyword">if</span> (a &lt; b || b === <span class="keyword">void</span> <span class="number">0</span>) <span class="keyword">return</span> -<span class="number">1</span>;
+      }
+      <span class="keyword">return</span> left.index - right.index;
+    }), <span class="string">'value'</span>);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-33">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-33">&#182;</a>
+              </div>
+              <p>An internal function used for aggregate &quot;group by&quot; operations.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> group = <span class="keyword">function</span>(behavior) {
+    <span class="keyword">return</span> <span class="keyword">function</span>(obj, value, context) {
+      <span class="keyword">var</span> result = {};
+      <span class="keyword">var</span> iterator = value == <span class="literal">null</span> ? _.identity : lookupIterator(value);
+      each(obj, <span class="keyword">function</span>(value, index) {
+        <span class="keyword">var</span> key = iterator.call(context, value, index, obj);
+        behavior(result, key, value);
+      });
+      <span class="keyword">return</span> result;
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-34">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-34">&#182;</a>
+              </div>
+              <p>Groups the object&#39;s values by a criterion. Pass either a string attribute
+to group by, or a function that returns the criterion.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.groupBy = group(<span class="keyword">function</span>(result, key, value) {
+    (_.has(result, key) ? result[key] : (result[key] = [])).push(value);
+  });</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-35">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-35">&#182;</a>
+              </div>
+              <p>Indexes the object&#39;s values by a criterion, similar to <code>groupBy</code>, but for
+when you know that your index values will be unique.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.indexBy = group(<span class="keyword">function</span>(result, key, value) {
+    result[key] = value;
+  });</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-36">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-36">&#182;</a>
+              </div>
+              <p>Counts instances of an object that group by a certain criterion. Pass
 either a string attribute to count by, or a function that returns the
-criterion.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">countBy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">group</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
-      <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
-    <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Use a comparator function to figure out the smallest index at which
-an object should be inserted so as to maintain order. Uses binary search.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">sortedIndex</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">_</span><span class="p">.</span><span class="nx">identity</span> <span class="o">:</span> <span class="nx">lookupIterator</span><span class="p">(</span><span class="nx">iterator</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">high</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
-    <span class="k">while</span> <span class="p">(</span><span class="nx">low</span> <span class="o">&lt;</span> <span class="nx">high</span><span class="p">)</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">mid</span> <span class="o">=</span> <span class="p">(</span><span class="nx">low</span> <span class="o">+</span> <span class="nx">high</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
-      <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">mid</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nx">value</span> <span class="o">?</span> <span class="nx">low</span> <span class="o">=</span> <span class="nx">mid</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">high</span> <span class="o">=</span> <span class="nx">mid</span><span class="p">;</span>
-    <span class="p">}</span>
-    <span class="k">return</span> <span class="nx">low</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Safely convert anything iterable into a real, live array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">toArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">identity</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Return the number of elements in an object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="k">return</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">?</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h2>Array Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Get the first element of an array. Passing <strong>n</strong> will return the first N
+criterion.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.countBy = group(<span class="keyword">function</span>(result, key) {
+    _.has(result, key) ? result[key]++ : result[key] = <span class="number">1</span>;
+  });</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-37">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-37">&#182;</a>
+              </div>
+              <p>Use a comparator function to figure out the smallest index at which
+an object should be inserted so as to maintain order. Uses binary search.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.sortedIndex = <span class="keyword">function</span>(array, obj, iterator, context) {
+    iterator = iterator == <span class="literal">null</span> ? _.identity : lookupIterator(iterator);
+    <span class="keyword">var</span> value = iterator.call(context, obj);
+    <span class="keyword">var</span> low = <span class="number">0</span>, high = array.length;
+    <span class="keyword">while</span> (low &lt; high) {
+      <span class="keyword">var</span> mid = (low + high) &gt;&gt;&gt; <span class="number">1</span>;
+      iterator.call(context, array[mid]) &lt; value ? low = mid + <span class="number">1</span> : high = mid;
+    }
+    <span class="keyword">return</span> low;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-38">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-38">&#182;</a>
+              </div>
+              <p>Safely create a real, live array from anything iterable.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.toArray = <span class="keyword">function</span>(obj) {
+    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> [];
+    <span class="keyword">if</span> (_.isArray(obj)) <span class="keyword">return</span> slice.call(obj);
+    <span class="keyword">if</span> (obj.length === +obj.length) <span class="keyword">return</span> _.map(obj, _.identity);
+    <span class="keyword">return</span> _.values(obj);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-39">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-39">&#182;</a>
+              </div>
+              <p>Return the number of elements in an object.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.size = <span class="keyword">function</span>(obj) {
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">0</span>;
+    <span class="keyword">return</span> (obj.length === +obj.length) ? obj.length : _.keys(obj).length;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-40">
+            <div class="annotation">
+              
+              <div class="pilwrap for-h2">
+                <a class="pilcrow" href="#section-40">&#182;</a>
+              </div>
+              <h2>Array Functions</h2>
+
+            </div>
+            
+        </li>
+        
+        
+        <li id="section-41">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-41">&#182;</a>
+              </div>
+              <p>Get the first element of an array. Passing <strong>n</strong> will return the first N
 values in the array. Aliased as <code>head</code> and <code>take</code>. The <strong>guard</strong> check
-allows it to work with <code>_.map</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">take</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">guard</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">array</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="k">return</span> <span class="p">(</span><span class="nx">n</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">guard</span> <span class="o">?</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="o">:</span> <span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Returns everything but the last entry of the array. Especially useful on
+allows it to work with <code>_.map</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.first = _.head = _.take = <span class="keyword">function</span>(array, n, guard) {
+    <span class="keyword">if</span> (array == <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;
+    <span class="keyword">return</span> (n == <span class="literal">null</span>) || guard ? array[<span class="number">0</span>] : slice.call(array, <span class="number">0</span>, n);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-42">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-42">&#182;</a>
+              </div>
+              <p>Returns everything but the last entry of the array. Especially useful on
 the arguments object. Passing <strong>n</strong> will return all the values in
 the array, excluding the last N. The <strong>guard</strong> check allows it to work with
-<code>_.map</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">initial</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">guard</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="p">((</span><span class="nx">n</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span> <span class="nx">guard</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">n</span><span class="p">));</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Get the last element of an array. Passing <strong>n</strong> will return the last N
-values in the array. The <strong>guard</strong> check allows it to work with <code>_.map</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">last</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">guard</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">array</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">((</span><span class="nx">n</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">guard</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
-    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">array</span><span class="p">[</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
-    <span class="p">}</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Returns everything but the first entry of the array. Aliased as <code>tail</code> and <code>drop</code>.
+<code>_.map</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.initial = <span class="keyword">function</span>(array, n, guard) {
+    <span class="keyword">return</span> slice.call(array, <span class="number">0</span>, array.length - ((n == <span class="literal">null</span>) || guard ? <span class="number">1</span> : n));
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-43">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-43">&#182;</a>
+              </div>
+              <p>Get the last element of an array. Passing <strong>n</strong> will return the last N
+values in the array. The <strong>guard</strong> check allows it to work with <code>_.map</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.last = <span class="keyword">function</span>(array, n, guard) {
+    <span class="keyword">if</span> (array == <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;
+    <span class="keyword">if</span> ((n == <span class="literal">null</span>) || guard) {
+      <span class="keyword">return</span> array[array.length - <span class="number">1</span>];
+    } <span class="keyword">else</span> {
+      <span class="keyword">return</span> slice.call(array, Math.max(array.length - n, <span class="number">0</span>));
+    }
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-44">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-44">&#182;</a>
+              </div>
+              <p>Returns everything but the first entry of the array. Aliased as <code>tail</code> and <code>drop</code>.
 Especially useful on the arguments object. Passing an <strong>n</strong> will return
 the rest N values in the array. The <strong>guard</strong>
-check allows it to work with <code>_.map</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">rest</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">tail</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">drop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">guard</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="p">(</span><span class="nx">n</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span> <span class="nx">guard</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">n</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Trim out all falsy values from an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">compact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">identity</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Internal implementation of a recursive <code>flatten</code> function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">flatten</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">shallow</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
-        <span class="nx">shallow</span> <span class="o">?</span> <span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">output</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">:</span> <span class="nx">flatten</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">shallow</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
-      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
-        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
-      <span class="p">}</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Return a completely flattened version of an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">shallow</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">flatten</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">shallow</span><span class="p">,</span> <span class="p">[]);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Return a version of the array that does not contain the specified value(s).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">without</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">difference</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Produce a duplicate-free version of the array. If the array has already
+check allows it to work with <code>_.map</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.rest = _.tail = _.drop = <span class="keyword">function</span>(array, n, guard) {
+    <span class="keyword">return</span> slice.call(array, (n == <span class="literal">null</span>) || guard ? <span class="number">1</span> : n);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-45">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-45">&#182;</a>
+              </div>
+              <p>Trim out all falsy values from an array.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.compact = <span class="keyword">function</span>(array) {
+    <span class="keyword">return</span> _.filter(array, _.identity);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-46">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-46">&#182;</a>
+              </div>
+              <p>Internal implementation of a recursive <code>flatten</code> function.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> flatten = <span class="keyword">function</span>(input, shallow, output) {
+    <span class="keyword">if</span> (shallow &amp;&amp; _.every(input, _.isArray)) {
+      <span class="keyword">return</span> concat.apply(output, input);
+    }
+    each(input, <span class="keyword">function</span>(value) {
+      <span class="keyword">if</span> (_.isArray(value) || _.isArguments(value)) {
+        shallow ? push.apply(output, value) : flatten(value, shallow, output);
+      } <span class="keyword">else</span> {
+        output.push(value);
+      }
+    });
+    <span class="keyword">return</span> output;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-47">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-47">&#182;</a>
+              </div>
+              <p>Flatten out an array, either recursively (by default), or just one level.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.flatten = <span class="keyword">function</span>(array, shallow) {
+    <span class="keyword">return</span> flatten(array, shallow, []);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-48">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-48">&#182;</a>
+              </div>
+              <p>Return a version of the array that does not contain the specified value(s).</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.without = <span class="keyword">function</span>(array) {
+    <span class="keyword">return</span> _.difference(array, slice.call(arguments, <span class="number">1</span>));
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-49">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-49">&#182;</a>
+              </div>
+              <p>Produce a duplicate-free version of the array. If the array has already
 been sorted, you have the option of using a faster algorithm.
-Aliased as <code>unique</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">isSorted</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">isSorted</span><span class="p">))</span> <span class="p">{</span>
-      <span class="nx">context</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">;</span>
-      <span class="nx">iterator</span> <span class="o">=</span> <span class="nx">isSorted</span><span class="p">;</span>
-      <span class="nx">isSorted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
-    <span class="p">}</span>
-    <span class="kd">var</span> <span class="nx">initial</span> <span class="o">=</span> <span class="nx">iterator</span> <span class="o">?</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">:</span> <span class="nx">array</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="kd">var</span> <span class="nx">seen</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">initial</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">isSorted</span> <span class="o">?</span> <span class="p">(</span><span class="o">!</span><span class="nx">index</span> <span class="o">||</span> <span class="nx">seen</span><span class="p">[</span><span class="nx">seen</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">value</span><span class="p">)</span> <span class="o">:</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">seen</span><span class="p">,</span> <span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
-        <span class="nx">seen</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
-        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">]);</span>
-      <span class="p">}</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Produce an array that contains the union: each distinct element from all of
-the passed-in arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">union</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">concat</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ArrayProto</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Produce an array that contains every item shared between all the
-passed-in arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">intersection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">rest</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">array</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">rest</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">other</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
-      <span class="p">});</span>
-    <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Take the difference between one array and a number of other arrays.
-Only the elements present in just the first array will remain.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">difference</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">rest</span> <span class="o">=</span> <span class="nx">concat</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ArrayProto</span><span class="p">,</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span> <span class="k">return</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">rest</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span> <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Zip together multiple lists into a single array -- elements that share
-an index go together.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">zip</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">));</span>
-    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">length</span><span class="p">);</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
-    <span class="p">}</span>
-    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Converts lists into objects. Pass either a single array of <code>[key, value]</code>
+Aliased as <code>unique</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.uniq = _.unique = <span class="keyword">function</span>(array, isSorted, iterator, context) {
+    <span class="keyword">if</span> (_.isFunction(isSorted)) {
+      context = iterator;
+      iterator = isSorted;
+      isSorted = <span class="literal">false</span>;
+    }
+    <span class="keyword">var</span> initial = iterator ? _.map(array, iterator, context) : array;
+    <span class="keyword">var</span> results = [];
+    <span class="keyword">var</span> seen = [];
+    each(initial, <span class="keyword">function</span>(value, index) {
+      <span class="keyword">if</span> (isSorted ? (!index || seen[seen.length - <span class="number">1</span>] !== value) : !_.contains(seen, value)) {
+        seen.push(value);
+        results.push(array[index]);
+      }
+    });
+    <span class="keyword">return</span> results;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-50">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-50">&#182;</a>
+              </div>
+              <p>Produce an array that contains the union: each distinct element from all of
+the passed-in arrays.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.union = <span class="keyword">function</span>() {
+    <span class="keyword">return</span> _.uniq(_.flatten(arguments, <span class="literal">true</span>));
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-51">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-51">&#182;</a>
+              </div>
+              <p>Produce an array that contains every item shared between all the
+passed-in arrays.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.intersection = <span class="keyword">function</span>(array) {
+    <span class="keyword">var</span> rest = slice.call(arguments, <span class="number">1</span>);
+    <span class="keyword">return</span> _.filter(_.uniq(array), <span class="keyword">function</span>(item) {
+      <span class="keyword">return</span> _.every(rest, <span class="keyword">function</span>(other) {
+        <span class="keyword">return</span> _.indexOf(other, item) &gt;= <span class="number">0</span>;
+      });
+    });
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-52">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-52">&#182;</a>
+              </div>
+              <p>Take the difference between one array and a number of other arrays.
+Only the elements present in just the first array will remain.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.difference = <span class="keyword">function</span>(array) {
+    <span class="keyword">var</span> rest = concat.apply(ArrayProto, slice.call(arguments, <span class="number">1</span>));
+    <span class="keyword">return</span> _.filter(array, <span class="keyword">function</span>(value){ <span class="keyword">return</span> !_.contains(rest, value); });
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-53">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-53">&#182;</a>
+              </div>
+              <p>Zip together multiple lists into a single array -- elements that share
+an index go together.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.zip = <span class="keyword">function</span>() {
+    <span class="keyword">var</span> length = _.max(_.pluck(arguments, <span class="string">"length"</span>).concat(<span class="number">0</span>));
+    <span class="keyword">var</span> results = <span class="keyword">new</span> Array(length);
+    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; length; i++) {
+      results[i] = _.pluck(arguments, <span class="string">''</span> + i);
+    }
+    <span class="keyword">return</span> results;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-54">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-54">&#182;</a>
+              </div>
+              <p>Converts lists into objects. Pass either a single array of <code>[key, value]</code>
 pairs, or two parallel arrays of the same length -- one of keys, and one of
-the corresponding values.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">list</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="p">{};</span>
-    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">result</span><span class="p">[</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
-      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
-        <span class="nx">result</span><span class="p">[</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
-      <span class="p">}</span>
-    <span class="p">}</span>
-    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>If the browser doesn't supply us with indexOf (I'm looking at you, <strong>MSIE</strong>),
+the corresponding values.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.object = <span class="keyword">function</span>(list, values) {
+    <span class="keyword">if</span> (list == <span class="literal">null</span>) <span class="keyword">return</span> {};
+    <span class="keyword">var</span> result = {};
+    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length = list.length; i &lt; length; i++) {
+      <span class="keyword">if</span> (values) {
+        result[list[i]] = values[i];
+      } <span class="keyword">else</span> {
+        result[list[i][<span class="number">0</span>]] = list[i][<span class="number">1</span>];
+      }
+    }
+    <span class="keyword">return</span> result;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-55">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-55">&#182;</a>
+              </div>
+              <p>If the browser doesn&#39;t supply us with indexOf (I&#39;m looking at you, <strong>MSIE</strong>),
 we need this function. Return the position of the first occurrence of an
 item in an array, or -1 if the item is not included in the array.
-Delegates to <strong>ECMAScript 5</strong>'s native <code>indexOf</code> if available.
+Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>indexOf</code> if available.
 If the array is large and already in sort order, pass <code>true</code>
-for <strong>isSorted</strong> to use binary search.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">isSorted</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">array</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">isSorted</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">isSorted</span> <span class="o">==</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span><span class="nx">isSorted</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">+</span> <span class="nx">isSorted</span><span class="p">)</span> <span class="o">:</span> <span class="nx">isSorted</span><span class="p">);</span>
-      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
-        <span class="nx">i</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">sortedIndex</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
-        <span class="k">return</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">item</span> <span class="o">?</span> <span class="nx">i</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
-      <span class="p">}</span>
-    <span class="p">}</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeIndexOf</span> <span class="o">&amp;&amp;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">===</span> <span class="nx">nativeIndexOf</span><span class="p">)</span> <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">isSorted</span><span class="p">);</span>
-    <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">item</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
-    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Delegates to <strong>ECMAScript 5</strong>'s native <code>lastIndexOf</code> if available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">lastIndexOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">array</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">hasIndex</span> <span class="o">=</span> <span class="nx">from</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">nativeLastIndexOf</span> <span class="o">&amp;&amp;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">lastIndexOf</span> <span class="o">===</span> <span class="nx">nativeLastIndexOf</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">hasIndex</span> <span class="o">?</span> <span class="nx">array</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="o">:</span> <span class="nx">array</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
-    <span class="p">}</span>
-    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hasIndex</span> <span class="o">?</span> <span class="nx">from</span> <span class="o">:</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
-    <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">item</span><span class="p">)</span> <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
-    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Generate an integer Array containing an arithmetic progression. A port of
+for <strong>isSorted</strong> to use binary search.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.indexOf = <span class="keyword">function</span>(array, item, isSorted) {
+    <span class="keyword">if</span> (array == <span class="literal">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;
+    <span class="keyword">var</span> i = <span class="number">0</span>, length = array.length;
+    <span class="keyword">if</span> (isSorted) {
+      <span class="keyword">if</span> (<span class="keyword">typeof</span> isSorted == <span class="string">'number'</span>) {
+        i = (isSorted &lt; <span class="number">0</span> ? Math.max(<span class="number">0</span>, length + isSorted) : isSorted);
+      } <span class="keyword">else</span> {
+        i = _.sortedIndex(array, item);
+        <span class="keyword">return</span> array[i] === item ? i : -<span class="number">1</span>;
+      }
+    }
+    <span class="keyword">if</span> (nativeIndexOf &amp;&amp; array.indexOf === nativeIndexOf) <span class="keyword">return</span> array.indexOf(item, isSorted);
+    <span class="keyword">for</span> (; i &lt; length; i++) <span class="keyword">if</span> (array[i] === item) <span class="keyword">return</span> i;
+    <span class="keyword">return</span> -<span class="number">1</span>;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-56">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-56">&#182;</a>
+              </div>
+              <p>Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>lastIndexOf</code> if available.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.lastIndexOf = <span class="keyword">function</span>(array, item, from) {
+    <span class="keyword">if</span> (array == <span class="literal">null</span>) <span class="keyword">return</span> -<span class="number">1</span>;
+    <span class="keyword">var</span> hasIndex = from != <span class="literal">null</span>;
+    <span class="keyword">if</span> (nativeLastIndexOf &amp;&amp; array.lastIndexOf === nativeLastIndexOf) {
+      <span class="keyword">return</span> hasIndex ? array.lastIndexOf(item, from) : array.lastIndexOf(item);
+    }
+    <span class="keyword">var</span> i = (hasIndex ? from : array.length);
+    <span class="keyword">while</span> (i--) <span class="keyword">if</span> (array[i] === item) <span class="keyword">return</span> i;
+    <span class="keyword">return</span> -<span class="number">1</span>;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-57">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-57">&#182;</a>
+              </div>
+              <p>Generate an integer Array containing an arithmetic progression. A port of
 the native Python <code>range()</code> function. See
-<a href="http://docs.python.org/library/functions.html#range">the Python documentation</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">stop</span><span class="p">,</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">stop</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
-      <span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="p">}</span>
-    <span class="nx">step</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
-
-    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">((</span><span class="nx">stop</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="nx">step</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>
-
-    <span class="k">while</span><span class="p">(</span><span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">range</span><span class="p">[</span><span class="nx">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
-      <span class="nx">start</span> <span class="o">+=</span> <span class="nx">step</span><span class="p">;</span>
-    <span class="p">}</span>
-
-    <span class="k">return</span> <span class="nx">range</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <h2>Function (ahem) Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Create a function bound to a given object (assigning <code>this</code>, and arguments,
-optionally). Delegates to <strong>ECMAScript 5</strong>'s native <code>Function.bind</code> if
-available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">func</span><span class="p">.</span><span class="nx">bind</span> <span class="o">===</span> <span class="nx">nativeBind</span> <span class="o">&amp;&amp;</span> <span class="nx">nativeBind</span><span class="p">)</span> <span class="k">return</span> <span class="nx">nativeBind</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
-    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Partially apply a function by creating a version that has had some of its
-arguments pre-filled, without changing its dynamic <code>this</code> context.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">partial</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)));</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Bind all of an object's methods to that object. Useful for ensuring that
-all callbacks defined on an object belong to it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">funcs</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">funcs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">funcs</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">functions</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">funcs</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">f</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">f</span><span class="p">],</span> <span class="nx">obj</span><span class="p">);</span> <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Memoize an expensive function by storing its results.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">hasher</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">memo</span> <span class="o">=</span> <span class="p">{};</span>
-    <span class="nx">hasher</span> <span class="o">||</span> <span class="p">(</span><span class="nx">hasher</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">identity</span><span class="p">);</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">hasher</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
-      <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">?</span> <span class="nx">memo</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">:</span> <span class="p">(</span><span class="nx">memo</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Delays a function for the given number of milliseconds, and then calls
-it with the arguments supplied.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">wait</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span> <span class="p">},</span> <span class="nx">wait</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Defers a function, scheduling it to run after the current call stack has
-cleared.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">defer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">[</span><span class="nx">func</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Returns a function, that, when invoked, will only be triggered at most once
-during a given window of time.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">throttle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">wait</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">,</span> <span class="nx">result</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">previous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">later</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="nx">previous</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">;</span>
-      <span class="nx">timeout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
-      <span class="nx">result</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
-    <span class="p">};</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">;</span>
-      <span class="kd">var</span> <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">wait</span> <span class="o">-</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">previous</span><span class="p">);</span>
-      <span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
-      <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">remaining</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
-        <span class="nx">timeout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
-        <span class="nx">previous</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
-        <span class="nx">result</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
-      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">timeout</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">later</span><span class="p">,</span> <span class="nx">remaining</span><span class="p">);</span>
-      <span class="p">}</span>
-      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Returns a function, that, as long as it continues to be invoked, will not
+<a href="http://docs.python.org/library/functions.html#range">the Python documentation</a>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.range = <span class="keyword">function</span>(start, stop, step) {
+    <span class="keyword">if</span> (arguments.length &lt;= <span class="number">1</span>) {
+      stop = start || <span class="number">0</span>;
+      start = <span class="number">0</span>;
+    }
+    step = arguments[<span class="number">2</span>] || <span class="number">1</span>;
+
+    <span class="keyword">var</span> length = Math.max(Math.ceil((stop - start) / step), <span class="number">0</span>);
+    <span class="keyword">var</span> idx = <span class="number">0</span>;
+    <span class="keyword">var</span> range = <span class="keyword">new</span> Array(length);
+
+    <span class="keyword">while</span>(idx &lt; length) {
+      range[idx++] = start;
+      start += step;
+    }
+
+    <span class="keyword">return</span> range;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-58">
+            <div class="annotation">
+              
+              <div class="pilwrap for-h2">
+                <a class="pilcrow" href="#section-58">&#182;</a>
+              </div>
+              <h2>Function (ahem) Functions</h2>
+
+            </div>
+            
+        </li>
+        
+        
+        <li id="section-59">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-59">&#182;</a>
+              </div>
+              <p>Reusable constructor function for prototype setting.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> ctor = <span class="keyword">function</span>(){};</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-60">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-60">&#182;</a>
+              </div>
+              <p>Create a function bound to a given object (assigning <code>this</code>, and arguments,
+optionally). Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>Function.bind</code> if
+available.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.bind = <span class="keyword">function</span>(func, context) {
+    <span class="keyword">var</span> args, bound;
+    <span class="keyword">if</span> (nativeBind &amp;&amp; func.bind === nativeBind) <span class="keyword">return</span> nativeBind.apply(func, slice.call(arguments, <span class="number">1</span>));
+    <span class="keyword">if</span> (!_.isFunction(func)) <span class="keyword">throw</span> <span class="keyword">new</span> TypeError;
+    args = slice.call(arguments, <span class="number">2</span>);
+    <span class="keyword">return</span> bound = <span class="keyword">function</span>() {
+      <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> bound)) <span class="keyword">return</span> func.apply(context, args.concat(slice.call(arguments)));
+      ctor.prototype = func.prototype;
+      <span class="keyword">var</span> self = <span class="keyword">new</span> ctor;
+      ctor.prototype = <span class="literal">null</span>;
+      <span class="keyword">var</span> result = func.apply(self, args.concat(slice.call(arguments)));
+      <span class="keyword">if</span> (Object(result) === result) <span class="keyword">return</span> result;
+      <span class="keyword">return</span> self;
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-61">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-61">&#182;</a>
+              </div>
+              <p>Partially apply a function by creating a version that has had some of its
+arguments pre-filled, without changing its dynamic <code>this</code> context.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.partial = <span class="keyword">function</span>(func) {
+    <span class="keyword">var</span> args = slice.call(arguments, <span class="number">1</span>);
+    <span class="keyword">return</span> <span class="keyword">function</span>() {
+      <span class="keyword">return</span> func.apply(<span class="keyword">this</span>, args.concat(slice.call(arguments)));
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-62">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-62">&#182;</a>
+              </div>
+              <p>Bind all of an object&#39;s methods to that object. Useful for ensuring that
+all callbacks defined on an object belong to it.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.bindAll = <span class="keyword">function</span>(obj) {
+    <span class="keyword">var</span> funcs = slice.call(arguments, <span class="number">1</span>);
+    <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"bindAll must be passed function names"</span>);
+    each(funcs, <span class="keyword">function</span>(f) { obj[f] = _.bind(obj[f], obj); });
+    <span class="keyword">return</span> obj;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-63">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-63">&#182;</a>
+              </div>
+              <p>Memoize an expensive function by storing its results.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.memoize = <span class="keyword">function</span>(func, hasher) {
+    <span class="keyword">var</span> memo = {};
+    hasher || (hasher = _.identity);
+    <span class="keyword">return</span> <span class="keyword">function</span>() {
+      <span class="keyword">var</span> key = hasher.apply(<span class="keyword">this</span>, arguments);
+      <span class="keyword">return</span> _.has(memo, key) ? memo[key] : (memo[key] = func.apply(<span class="keyword">this</span>, arguments));
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-64">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-64">&#182;</a>
+              </div>
+              <p>Delays a function for the given number of milliseconds, and then calls
+it with the arguments supplied.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.delay = <span class="keyword">function</span>(func, wait) {
+    <span class="keyword">var</span> args = slice.call(arguments, <span class="number">2</span>);
+    <span class="keyword">return</span> setTimeout(<span class="keyword">function</span>(){ <span class="keyword">return</span> func.apply(<span class="literal">null</span>, args); }, wait);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-65">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-65">&#182;</a>
+              </div>
+              <p>Defers a function, scheduling it to run after the current call stack has
+cleared.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.defer = <span class="keyword">function</span>(func) {
+    <span class="keyword">return</span> _.delay.apply(_, [func, <span class="number">1</span>].concat(slice.call(arguments, <span class="number">1</span>)));
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-66">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-66">&#182;</a>
+              </div>
+              <p>Returns a function, that, when invoked, will only be triggered at most once
+during a given window of time. Normally, the throttled function will run
+as much as it can, without ever going more than once per <code>wait</code> duration;
+but if you&#39;d like to disable the execution on the leading edge, pass
+<code>{leading: false}</code>. To disable execution on the trailing edge, ditto.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.throttle = <span class="keyword">function</span>(func, wait, options) {
+    <span class="keyword">var</span> context, args, result;
+    <span class="keyword">var</span> timeout = <span class="literal">null</span>;
+    <span class="keyword">var</span> previous = <span class="number">0</span>;
+    options || (options = {});
+    <span class="keyword">var</span> later = <span class="keyword">function</span>() {
+      previous = options.leading === <span class="literal">false</span> ? <span class="number">0</span> : <span class="keyword">new</span> Date;
+      timeout = <span class="literal">null</span>;
+      result = func.apply(context, args);
+    };
+    <span class="keyword">return</span> <span class="keyword">function</span>() {
+      <span class="keyword">var</span> now = <span class="keyword">new</span> Date;
+      <span class="keyword">if</span> (!previous &amp;&amp; options.leading === <span class="literal">false</span>) previous = now;
+      <span class="keyword">var</span> remaining = wait - (now - previous);
+      context = <span class="keyword">this</span>;
+      args = arguments;
+      <span class="keyword">if</span> (remaining &lt;= <span class="number">0</span>) {
+        clearTimeout(timeout);
+        timeout = <span class="literal">null</span>;
+        previous = now;
+        result = func.apply(context, args);
+      } <span class="keyword">else</span> <span class="keyword">if</span> (!timeout &amp;&amp; options.trailing !== <span class="literal">false</span>) {
+        timeout = setTimeout(later, remaining);
+      }
+      <span class="keyword">return</span> result;
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-67">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-67">&#182;</a>
+              </div>
+              <p>Returns a function, that, as long as it continues to be invoked, will not
 be triggered. The function will be called after it stops being called for
 N milliseconds. If <code>immediate</code> is passed, trigger the function on the
-leading edge, instead of the trailing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">debounce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">wait</span><span class="p">,</span> <span class="nx">immediate</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">timeout</span><span class="p">,</span> <span class="nx">result</span><span class="p">;</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
-      <span class="kd">var</span> <span class="nx">later</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-        <span class="nx">timeout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
-        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">immediate</span><span class="p">)</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
-      <span class="p">};</span>
-      <span class="kd">var</span> <span class="nx">callNow</span> <span class="o">=</span> <span class="nx">immediate</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">timeout</span><span class="p">;</span>
-      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
-      <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">later</span><span class="p">,</span> <span class="nx">wait</span><span class="p">);</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">callNow</span><span class="p">)</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
-      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Returns a function that will be executed at most one time, no matter how
-often you call it. Useful for lazy initialization.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">ran</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">memo</span><span class="p">;</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">ran</span><span class="p">)</span> <span class="k">return</span> <span class="nx">memo</span><span class="p">;</span>
-      <span class="nx">ran</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
-      <span class="nx">memo</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
-      <span class="nx">func</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
-      <span class="k">return</span> <span class="nx">memo</span><span class="p">;</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Returns the first function passed as an argument to the second,
+leading edge, instead of the trailing.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.debounce = <span class="keyword">function</span>(func, wait, immediate) {
+    <span class="keyword">var</span> timeout, args, context, timestamp, result;
+    <span class="keyword">return</span> <span class="keyword">function</span>() {
+      context = <span class="keyword">this</span>;
+      args = arguments;
+      timestamp = <span class="keyword">new</span> Date();
+      <span class="keyword">var</span> later = <span class="keyword">function</span>() {
+        <span class="keyword">var</span> last = (<span class="keyword">new</span> Date()) - timestamp;
+        <span class="keyword">if</span> (last &lt; wait) {
+          timeout = setTimeout(later, wait - last);
+        } <span class="keyword">else</span> {
+          timeout = <span class="literal">null</span>;
+          <span class="keyword">if</span> (!immediate) result = func.apply(context, args);
+        }
+      };
+      <span class="keyword">var</span> callNow = immediate &amp;&amp; !timeout;
+      <span class="keyword">if</span> (!timeout) {
+        timeout = setTimeout(later, wait);
+      }
+      <span class="keyword">if</span> (callNow) result = func.apply(context, args);
+      <span class="keyword">return</span> result;
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-68">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-68">&#182;</a>
+              </div>
+              <p>Returns a function that will be executed at most one time, no matter how
+often you call it. Useful for lazy initialization.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.once = <span class="keyword">function</span>(func) {
+    <span class="keyword">var</span> ran = <span class="literal">false</span>, memo;
+    <span class="keyword">return</span> <span class="keyword">function</span>() {
+      <span class="keyword">if</span> (ran) <span class="keyword">return</span> memo;
+      ran = <span class="literal">true</span>;
+      memo = func.apply(<span class="keyword">this</span>, arguments);
+      func = <span class="literal">null</span>;
+      <span class="keyword">return</span> memo;
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-69">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-69">&#182;</a>
+              </div>
+              <p>Returns the first function passed as an argument to the second,
 allowing you to adjust arguments, run code before and after, and
-conditionally execute the original function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">wrapper</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="nx">func</span><span class="p">];</span>
-      <span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
-      <span class="k">return</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Returns a function that is the composition of a list of functions, each
-consuming the return value of the function that follows.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">compose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">funcs</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
-      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">funcs</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="nx">funcs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">)];</span>
-      <span class="p">}</span>
-      <span class="k">return</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Returns a function that will only be executed after being called N times.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">after</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">times</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">times</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">func</span><span class="p">();</span>
-    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="nx">times</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
-      <span class="p">}</span>
-    <span class="p">};</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <h2>Object Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Retrieve the names of an object's properties.
-Delegates to <strong>ECMAScript 5</strong>'s native <code>Object.keys</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="nx">nativeKeys</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">!==</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid object&#39;</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
-    <span class="k">return</span> <span class="nx">keys</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Retrieve the values of an object's properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
-    <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Convert an object into a list of <code>[key, value]</code> pairs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">pairs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">pairs</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">pairs</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]]);</span>
-    <span class="k">return</span> <span class="nx">pairs</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Invert the keys and values of an object. The values must be serializable.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">result</span><span class="p">[</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
-    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Return a sorted list of the function names available on the object.
-Aliased as <code>methods</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">functions</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">methods</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="p">[];</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span> <span class="nx">names</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
-    <span class="p">}</span>
-    <span class="k">return</span> <span class="nx">names</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Extend a given object with all the properties in passed-in object(s).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
-          <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
-        <span class="p">}</span>
-      <span class="p">}</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Return a copy of the object only containing the whitelisted properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="p">{};</span>
-    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">concat</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ArrayProto</span><span class="p">,</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="nx">copy</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">copy</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Return a copy of the object without the blacklisted properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="p">{};</span>
-    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">concat</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">ArrayProto</span><span class="p">,</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="nx">copy</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
-    <span class="p">}</span>
-    <span class="k">return</span> <span class="nx">copy</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Fill in a given object with default properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
-          <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
-        <span class="p">}</span>
-      <span class="p">}</span>
-    <span class="p">});</span>
-    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Create a (shallow-cloned) duplicate of an object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">?</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">slice</span><span class="p">()</span> <span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">obj</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Invokes interceptor with the obj, and then returns obj.
-The primary purpose of this method is to "tap into" a method chain, in
-order to perform operations on intermediate results within the chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">tap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">interceptor</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">interceptor</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Internal recursive comparison function for <code>isEqual</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">eq</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">aStack</span><span class="p">,</span> <span class="nx">bStack</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Identical objects are equal. <code>0 === -0</code>, but they aren't identical.
-See the Harmony <code>egal</code> proposal: http://wiki.ecmascript.org/doku.php?id=harmony:egal.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span><span class="p">)</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">||</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">a</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">b</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>A strict comparison is necessary because <code>null == undefined</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">b</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Unwrap any wrapped objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="k">instanceof</span> <span class="nx">_</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">_wrapped</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="k">instanceof</span> <span class="nx">_</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">_wrapped</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Compare <code>[[Class]]</code> names.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">className</span> <span class="o">=</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">!=</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
-    <span class="k">switch</span> <span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Strings, numbers, dates, and booleans are compared by value.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">case</span> <span class="s1">&#39;[object String]&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Primitives and their corresponding object wrappers are equivalent; thus, <code>"5"</code> is
-equivalent to <code>new String("5")</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">a</span> <span class="o">==</span> <span class="nb">String</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
-      <span class="k">case</span> <span class="s1">&#39;[object Number]&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p><code>NaN</code>s are equivalent, but non-reflexive. An <code>egal</code> comparison is performed for
-other numeric values.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">a</span> <span class="o">!=</span> <span class="o">+</span><span class="nx">a</span> <span class="o">?</span> <span class="nx">b</span> <span class="o">!=</span> <span class="o">+</span><span class="nx">b</span> <span class="o">:</span> <span class="p">(</span><span class="nx">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">a</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">b</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">==</span> <span class="o">+</span><span class="nx">b</span><span class="p">);</span>
-      <span class="k">case</span> <span class="s1">&#39;[object Date]&#39;</span><span class="o">:</span>
-      <span class="k">case</span> <span class="s1">&#39;[object Boolean]&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Coerce dates and booleans to numeric primitive values. Dates are compared by their
+conditionally execute the original function.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.wrap = <span class="keyword">function</span>(func, wrapper) {
+    <span class="keyword">return</span> <span class="keyword">function</span>() {
+      <span class="keyword">var</span> args = [func];
+      push.apply(args, arguments);
+      <span class="keyword">return</span> wrapper.apply(<span class="keyword">this</span>, args);
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-70">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-70">&#182;</a>
+              </div>
+              <p>Returns a function that is the composition of a list of functions, each
+consuming the return value of the function that follows.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.compose = <span class="keyword">function</span>() {
+    <span class="keyword">var</span> funcs = arguments;
+    <span class="keyword">return</span> <span class="keyword">function</span>() {
+      <span class="keyword">var</span> args = arguments;
+      <span class="keyword">for</span> (<span class="keyword">var</span> i = funcs.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {
+        args = [funcs[i].apply(<span class="keyword">this</span>, args)];
+      }
+      <span class="keyword">return</span> args[<span class="number">0</span>];
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-71">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-71">&#182;</a>
+              </div>
+              <p>Returns a function that will only be executed after being called N times.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.after = <span class="keyword">function</span>(times, func) {
+    <span class="keyword">return</span> <span class="keyword">function</span>() {
+      <span class="keyword">if</span> (--times &lt; <span class="number">1</span>) {
+        <span class="keyword">return</span> func.apply(<span class="keyword">this</span>, arguments);
+      }
+    };
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-72">
+            <div class="annotation">
+              
+              <div class="pilwrap for-h2">
+                <a class="pilcrow" href="#section-72">&#182;</a>
+              </div>
+              <h2>Object Functions</h2>
+
+            </div>
+            
+        </li>
+        
+        
+        <li id="section-73">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-73">&#182;</a>
+              </div>
+              <p>Retrieve the names of an object&#39;s properties.
+Delegates to <strong>ECMAScript 5</strong>&#39;s native <code>Object.keys</code></p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.keys = nativeKeys || <span class="keyword">function</span>(obj) {
+    <span class="keyword">if</span> (obj !== Object(obj)) <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Invalid object'</span>);
+    <span class="keyword">var</span> keys = [];
+    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) <span class="keyword">if</span> (_.has(obj, key)) keys.push(key);
+    <span class="keyword">return</span> keys;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-74">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-74">&#182;</a>
+              </div>
+              <p>Retrieve the values of an object&#39;s properties.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.values = <span class="keyword">function</span>(obj) {
+    <span class="keyword">var</span> keys = _.keys(obj);
+    <span class="keyword">var</span> length = keys.length;
+    <span class="keyword">var</span> values = <span class="keyword">new</span> Array(length);
+    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; length; i++) {
+      values[i] = obj[keys[i]];
+    }
+    <span class="keyword">return</span> values;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-75">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-75">&#182;</a>
+              </div>
+              <p>Convert an object into a list of <code>[key, value]</code> pairs.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.pairs = <span class="keyword">function</span>(obj) {
+    <span class="keyword">var</span> keys = _.keys(obj);
+    <span class="keyword">var</span> length = keys.length;
+    <span class="keyword">var</span> pairs = <span class="keyword">new</span> Array(length);
+    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; length; i++) {
+      pairs[i] = [keys[i], obj[keys[i]]];
+    }
+    <span class="keyword">return</span> pairs;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-76">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-76">&#182;</a>
+              </div>
+              <p>Invert the keys and values of an object. The values must be serializable.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.invert = <span class="keyword">function</span>(obj) {
+    <span class="keyword">var</span> result = {};
+    <span class="keyword">var</span> keys = _.keys(obj);
+    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length = keys.length; i &lt; length; i++) {
+      result[obj[keys[i]]] = keys[i];
+    }
+    <span class="keyword">return</span> result;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-77">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-77">&#182;</a>
+              </div>
+              <p>Return a sorted list of the function names available on the object.
+Aliased as <code>methods</code></p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.functions = _.methods = <span class="keyword">function</span>(obj) {
+    <span class="keyword">var</span> names = [];
+    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) {
+      <span class="keyword">if</span> (_.isFunction(obj[key])) names.push(key);
+    }
+    <span class="keyword">return</span> names.sort();
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-78">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-78">&#182;</a>
+              </div>
+              <p>Extend a given object with all the properties in passed-in object(s).</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.extend = <span class="keyword">function</span>(obj) {
+    each(slice.call(arguments, <span class="number">1</span>), <span class="keyword">function</span>(source) {
+      <span class="keyword">if</span> (source) {
+        <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> source) {
+          obj[prop] = source[prop];
+        }
+      }
+    });
+    <span class="keyword">return</span> obj;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-79">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-79">&#182;</a>
+              </div>
+              <p>Return a copy of the object only containing the whitelisted properties.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.pick = <span class="keyword">function</span>(obj) {
+    <span class="keyword">var</span> copy = {};
+    <span class="keyword">var</span> keys = concat.apply(ArrayProto, slice.call(arguments, <span class="number">1</span>));
+    each(keys, <span class="keyword">function</span>(key) {
+      <span class="keyword">if</span> (key <span class="keyword">in</span> obj) copy[key] = obj[key];
+    });
+    <span class="keyword">return</span> copy;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-80">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-80">&#182;</a>
+              </div>
+              <p>Return a copy of the object without the blacklisted properties.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.omit = <span class="keyword">function</span>(obj) {
+    <span class="keyword">var</span> copy = {};
+    <span class="keyword">var</span> keys = concat.apply(ArrayProto, slice.call(arguments, <span class="number">1</span>));
+    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) {
+      <span class="keyword">if</span> (!_.contains(keys, key)) copy[key] = obj[key];
+    }
+    <span class="keyword">return</span> copy;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-81">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-81">&#182;</a>
+              </div>
+              <p>Fill in a given object with default properties.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.defaults = <span class="keyword">function</span>(obj) {
+    each(slice.call(arguments, <span class="number">1</span>), <span class="keyword">function</span>(source) {
+      <span class="keyword">if</span> (source) {
+        <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> source) {
+          <span class="keyword">if</span> (obj[prop] === <span class="keyword">void</span> <span class="number">0</span>) obj[prop] = source[prop];
+        }
+      }
+    });
+    <span class="keyword">return</span> obj;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-82">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-82">&#182;</a>
+              </div>
+              <p>Create a (shallow-cloned) duplicate of an object.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.clone = <span class="keyword">function</span>(obj) {
+    <span class="keyword">if</span> (!_.isObject(obj)) <span class="keyword">return</span> obj;
+    <span class="keyword">return</span> _.isArray(obj) ? obj.slice() : _.extend({}, obj);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-83">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-83">&#182;</a>
+              </div>
+              <p>Invokes interceptor with the obj, and then returns obj.
+The primary purpose of this method is to &quot;tap into&quot; a method chain, in
+order to perform operations on intermediate results within the chain.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.tap = <span class="keyword">function</span>(obj, interceptor) {
+    interceptor(obj);
+    <span class="keyword">return</span> obj;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-84">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-84">&#182;</a>
+              </div>
+              <p>Internal recursive comparison function for <code>isEqual</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> eq = <span class="keyword">function</span>(a, b, aStack, bStack) {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-85">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-85">&#182;</a>
+              </div>
+              <p>Identical objects are equal. <code>0 === -0</code>, but they aren&#39;t identical.
+See the <a href="http://wiki.ecmascript.org/doku.php?id=harmony:egal">Harmony <code>egal</code> proposal</a>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (a === b) <span class="keyword">return</span> a !== <span class="number">0</span> || <span class="number">1</span> / a == <span class="number">1</span> / b;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-86">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-86">&#182;</a>
+              </div>
+              <p>A strict comparison is necessary because <code>null == undefined</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (a == <span class="literal">null</span> || b == <span class="literal">null</span>) <span class="keyword">return</span> a === b;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-87">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-87">&#182;</a>
+              </div>
+              <p>Unwrap any wrapped objects.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (a <span class="keyword">instanceof</span> _) a = a._wrapped;
+    <span class="keyword">if</span> (b <span class="keyword">instanceof</span> _) b = b._wrapped;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-88">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-88">&#182;</a>
+              </div>
+              <p>Compare <code>[[Class]]</code> names.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> className = toString.call(a);
+    <span class="keyword">if</span> (className != toString.call(b)) <span class="keyword">return</span> <span class="literal">false</span>;
+    <span class="keyword">switch</span> (className) {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-89">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-89">&#182;</a>
+              </div>
+              <p>Strings, numbers, dates, and booleans are compared by value.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">case</span> <span class="string">'[object String]'</span>:</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-90">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-90">&#182;</a>
+              </div>
+              <p>Primitives and their corresponding object wrappers are equivalent; thus, <code>&quot;5&quot;</code> is
+equivalent to <code>new String(&quot;5&quot;)</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> a == String(b);
+      <span class="keyword">case</span> <span class="string">'[object Number]'</span>:</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-91">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-91">&#182;</a>
+              </div>
+              <p><code>NaN</code>s are equivalent, but non-reflexive. An <code>egal</code> comparison is performed for
+other numeric values.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> a != +a ? b != +b : (a == <span class="number">0</span> ? <span class="number">1</span> / a == <span class="number">1</span> / b : a == +b);
+      <span class="keyword">case</span> <span class="string">'[object Date]'</span>:
+      <span class="keyword">case</span> <span class="string">'[object Boolean]'</span>:</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-92">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-92">&#182;</a>
+              </div>
+              <p>Coerce dates and booleans to numeric primitive values. Dates are compared by their
 millisecond representations. Note that invalid dates with millisecond representations
-of <code>NaN</code> are not equivalent.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="o">+</span><span class="nx">a</span> <span class="o">==</span> <span class="o">+</span><span class="nx">b</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>RegExps are compared by their source patterns and flags.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">case</span> <span class="s1">&#39;[object RegExp]&#39;</span><span class="o">:</span>
-        <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">source</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">source</span> <span class="o">&amp;&amp;</span>
-               <span class="nx">a</span><span class="p">.</span><span class="nx">global</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">global</span> <span class="o">&amp;&amp;</span>
-               <span class="nx">a</span><span class="p">.</span><span class="nx">multiline</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">multiline</span> <span class="o">&amp;&amp;</span>
-               <span class="nx">a</span><span class="p">.</span><span class="nx">ignoreCase</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ignoreCase</span><span class="p">;</span>
-    <span class="p">}</span>
-    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">a</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">b</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Assume equality for cyclic structures. The algorithm for detecting cyclic
-structures is adapted from ES 5.1 section 15.12.3, abstract operation <code>JO</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">aStack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
-    <span class="k">while</span> <span class="p">(</span><span class="nx">length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Linear search. Performance is inversely proportional to the number of
-unique nested structures.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">aStack</span><span class="p">[</span><span class="nx">length</span><span class="p">]</span> <span class="o">==</span> <span class="nx">a</span><span class="p">)</span> <span class="k">return</span> <span class="nx">bStack</span><span class="p">[</span><span class="nx">length</span><span class="p">]</span> <span class="o">==</span> <span class="nx">b</span><span class="p">;</span>
-    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Add the first object to the stack of traversed objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">aStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
-    <span class="nx">bStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Recursively compare objects and arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">className</span> <span class="o">==</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Compare array lengths to determine if a deep comparison is necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">size</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
-      <span class="nx">result</span> <span class="o">=</span> <span class="nx">size</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Deep compare the contents, ignoring non-numeric properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">while</span> <span class="p">(</span><span class="nx">size</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
-          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">eq</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">size</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">size</span><span class="p">],</span> <span class="nx">aStack</span><span class="p">,</span> <span class="nx">bStack</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
-        <span class="p">}</span>
-      <span class="p">}</span>
-    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Objects with different constructors are not equivalent, but <code>Object</code>s
-from different frames are.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">aCtor</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">constructor</span><span class="p">,</span> <span class="nx">bCtor</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">aCtor</span> <span class="o">!==</span> <span class="nx">bCtor</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">aCtor</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">aCtor</span> <span class="k">instanceof</span> <span class="nx">aCtor</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
-                               <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">bCtor</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">bCtor</span> <span class="k">instanceof</span> <span class="nx">bCtor</span><span class="p">)))</span> <span class="p">{</span>
-        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
-      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Deep compare objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Count the expected number of properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">size</span><span class="o">++</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Deep compare each member.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">eq</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">aStack</span><span class="p">,</span> <span class="nx">bStack</span><span class="p">)))</span> <span class="k">break</span><span class="p">;</span>
-        <span class="p">}</span>
-      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Ensure that both objects contain the same number of properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
-          <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">size</span><span class="o">--</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
-        <span class="p">}</span>
-        <span class="nx">result</span> <span class="o">=</span> <span class="o">!</span><span class="nx">size</span><span class="p">;</span>
-      <span class="p">}</span>
-    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Remove the first object from the stack of traversed objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">aStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
-    <span class="nx">bStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
-    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Perform a deep comparison to check if two objects are equal.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">eq</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Is a given array, string, or object empty?
-An "empty" object has no enumerable own-properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">||</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
-    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Is a given value a DOM element?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">isElement</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Is a given value an array?
-Delegates to ECMA5's native Array.isArray</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">=</span> <span class="nx">nativeIsArray</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Is a given variable an object?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">obj</span> <span class="o">===</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Add some isType methods: isArguments, isFunction, isString, isNumber, isDate, isRegExp.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">each</span><span class="p">([</span><span class="s1">&#39;Arguments&#39;</span><span class="p">,</span> <span class="s1">&#39;Function&#39;</span><span class="p">,</span> <span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="s1">&#39;Number&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;RegExp&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">_</span><span class="p">[</span><span class="s1">&#39;is&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;[object &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
-    <span class="p">};</span>
-  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Define a fallback version of the method in browsers (ahem, IE), where
-there isn't any inspectable "Arguments" type.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArguments</span><span class="p">(</span><span class="nx">arguments</span><span class="p">))</span> <span class="p">{</span>
-    <span class="nx">_</span><span class="p">.</span><span class="nx">isArguments</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="s1">&#39;callee&#39;</span><span class="p">));</span>
-    <span class="p">};</span>
-  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Optimize <code>isFunction</code> if appropriate.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="sr">/./</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">;</span>
-    <span class="p">};</span>
-  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Is a given object a finite number?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nb">isFinite</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nb">isFinite</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Is the given value <code>NaN</code>? (NaN is the only number which does not equal itself).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nb">isNaN</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="o">!=</span> <span class="o">+</span><span class="nx">obj</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Is a given value a boolean?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;[object Boolean]&#39;</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Is a given value equal to null?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">isNull</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">null</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Is a given variable undefined?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">obj</span> <span class="o">===</span> <span class="k">void</span> <span class="mi">0</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Shortcut function for checking if an object has a given property directly
-on itself (in other words, not on a prototype).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">has</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <h2>Utility Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Run Underscore.js in <em>noConflict</em> mode, returning the <code>_</code> variable to its
-previous owner. Returns a reference to the Underscore object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">noConflict</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-    <span class="nx">root</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">previousUnderscore</span><span class="p">;</span>
-    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Keep the identity function around for default iterators.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">identity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Run a function <strong>n</strong> times.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">times</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">accum</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
-    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">accum</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
-    <span class="k">return</span> <span class="nx">accum</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>Return a random integer between min and max (inclusive).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">random</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">max</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">max</span> <span class="o">=</span> <span class="nx">min</span><span class="p">;</span>
-      <span class="nx">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="p">}</span>
-    <span class="k">return</span> <span class="nx">min</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>List of HTML entities for escaping.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">entityMap</span> <span class="o">=</span> <span class="p">{</span>
-    <span class="nx">escape</span><span class="o">:</span> <span class="p">{</span>
-      <span class="s1">&#39;&amp;&#39;</span><span class="o">:</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">,</span>
-      <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span>
-      <span class="s1">&#39;&gt;&#39;</span><span class="o">:</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">,</span>
-      <span class="s1">&#39;&quot;&#39;</span><span class="o">:</span> <span class="s1">&#39;&amp;quot;&#39;</span><span class="p">,</span>
-      <span class="s2">&quot;&#39;&quot;</span><span class="o">:</span> <span class="s1">&#39;&amp;#x27;&#39;</span><span class="p">,</span>
-      <span class="s1">&#39;/&#39;</span><span class="o">:</span> <span class="s1">&#39;&amp;#x2F;&#39;</span>
-    <span class="p">}</span>
-  <span class="p">};</span>
-  <span class="nx">entityMap</span><span class="p">.</span><span class="nx">unescape</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">entityMap</span><span class="p">.</span><span class="nx">escape</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Regexes containing the keys and values listed immediately above.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">entityRegexes</span> <span class="o">=</span> <span class="p">{</span>
-    <span class="nx">escape</span><span class="o">:</span>   <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">entityMap</span><span class="p">.</span><span class="nx">escape</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span>
-    <span class="nx">unescape</span><span class="o">:</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">entityMap</span><span class="p">.</span><span class="nx">unescape</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>Functions for escaping and unescaping strings to/from HTML interpolation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">([</span><span class="s1">&#39;escape&#39;</span><span class="p">,</span> <span class="s1">&#39;unescape&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">_</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">string</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
-      <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">string</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">entityRegexes</span><span class="p">[</span><span class="nx">method</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
-        <span class="k">return</span> <span class="nx">entityMap</span><span class="p">[</span><span class="nx">method</span><span class="p">][</span><span class="nx">match</span><span class="p">];</span>
-      <span class="p">});</span>
-    <span class="p">};</span>
-  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>If the value of the named property is a function then invoke it;
-otherwise, return it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Add your own custom functions to the Underscore object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">mixin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="nx">each</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">functions</span><span class="p">(</span><span class="nx">obj</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
-      <span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="nx">_</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
-      <span class="nx">_</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_wrapped</span><span class="p">];</span>
-        <span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
-        <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">args</span><span class="p">));</span>
-      <span class="p">};</span>
-    <span class="p">});</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Generate a unique integer id (unique within the entire client session).
-Useful for temporary DOM ids.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">idCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
-  <span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="o">++</span><span class="nx">idCounter</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
-    <span class="k">return</span> <span class="nx">prefix</span> <span class="o">?</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">:</span> <span class="nx">id</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>By default, Underscore uses ERB-style template delimiters, change the
-following template settings to use alternative delimiters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">templateSettings</span> <span class="o">=</span> <span class="p">{</span>
-    <span class="nx">evaluate</span>    <span class="o">:</span> <span class="sr">/&lt;%([\s\S]+?)%&gt;/g</span><span class="p">,</span>
-    <span class="nx">interpolate</span> <span class="o">:</span> <span class="sr">/&lt;%=([\s\S]+?)%&gt;/g</span><span class="p">,</span>
-    <span class="nx">escape</span>      <span class="o">:</span> <span class="sr">/&lt;%-([\s\S]+?)%&gt;/g</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>When customizing <code>templateSettings</code>, if you don't want to define an
+of <code>NaN</code> are not equivalent.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> +a == +b;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-93">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-93">&#182;</a>
+              </div>
+              <p>RegExps are compared by their source patterns and flags.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">case</span> <span class="string">'[object RegExp]'</span>:
+        <span class="keyword">return</span> a.source == b.source &amp;&amp;
+               a.global == b.global &amp;&amp;
+               a.multiline == b.multiline &amp;&amp;
+               a.ignoreCase == b.ignoreCase;
+    }
+    <span class="keyword">if</span> (<span class="keyword">typeof</span> a != <span class="string">'object'</span> || <span class="keyword">typeof</span> b != <span class="string">'object'</span>) <span class="keyword">return</span> <span class="literal">false</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-94">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-94">&#182;</a>
+              </div>
+              <p>Assume equality for cyclic structures. The algorithm for detecting cyclic
+structures is adapted from ES 5.1 section 15.12.3, abstract operation <code>JO</code>.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> length = aStack.length;
+    <span class="keyword">while</span> (length--) {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-95">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-95">&#182;</a>
+              </div>
+              <p>Linear search. Performance is inversely proportional to the number of
+unique nested structures.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (aStack[length] == a) <span class="keyword">return</span> bStack[length] == b;
+    }</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-96">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-96">&#182;</a>
+              </div>
+              <p>Objects with different constructors are not equivalent, but <code>Object</code>s
+from different frames are.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> aCtor = a.constructor, bCtor = b.constructor;
+    <span class="keyword">if</span> (aCtor !== bCtor &amp;&amp; !(_.isFunction(aCtor) &amp;&amp; (aCtor <span class="keyword">instanceof</span> aCtor) &amp;&amp;
+                             _.isFunction(bCtor) &amp;&amp; (bCtor <span class="keyword">instanceof</span> bCtor))) {
+      <span class="keyword">return</span> <span class="literal">false</span>;
+    }</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-97">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-97">&#182;</a>
+              </div>
+              <p>Add the first object to the stack of traversed objects.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    aStack.push(a);
+    bStack.push(b);
+    <span class="keyword">var</span> size = <span class="number">0</span>, result = <span class="literal">true</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-98">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-98">&#182;</a>
+              </div>
+              <p>Recursively compare objects and arrays.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (className == <span class="string">'[object Array]'</span>) {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-99">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-99">&#182;</a>
+              </div>
+              <p>Compare array lengths to determine if a deep comparison is necessary.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>      size = a.length;
+      result = size == b.length;
+      <span class="keyword">if</span> (result) {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-100">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-100">&#182;</a>
+              </div>
+              <p>Deep compare the contents, ignoring non-numeric properties.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>        <span class="keyword">while</span> (size--) {
+          <span class="keyword">if</span> (!(result = eq(a[size], b[size], aStack, bStack))) <span class="keyword">break</span>;
+        }
+      }
+    } <span class="keyword">else</span> {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-101">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-101">&#182;</a>
+              </div>
+              <p>Deep compare objects.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> a) {
+        <span class="keyword">if</span> (_.has(a, key)) {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-102">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-102">&#182;</a>
+              </div>
+              <p>Count the expected number of properties.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>          size++;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-103">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-103">&#182;</a>
+              </div>
+              <p>Deep compare each member.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (!(result = _.has(b, key) &amp;&amp; eq(a[key], b[key], aStack, bStack))) <span class="keyword">break</span>;
+        }
+      }</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-104">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-104">&#182;</a>
+              </div>
+              <p>Ensure that both objects contain the same number of properties.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (result) {
+        <span class="keyword">for</span> (key <span class="keyword">in</span> b) {
+          <span class="keyword">if</span> (_.has(b, key) &amp;&amp; !(size--)) <span class="keyword">break</span>;
+        }
+        result = !size;
+      }
+    }</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-105">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-105">&#182;</a>
+              </div>
+              <p>Remove the first object from the stack of traversed objects.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    aStack.pop();
+    bStack.pop();
+    <span class="keyword">return</span> result;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-106">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-106">&#182;</a>
+              </div>
+              <p>Perform a deep comparison to check if two objects are equal.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isEqual = <span class="keyword">function</span>(a, b) {
+    <span class="keyword">return</span> eq(a, b, [], []);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-107">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-107">&#182;</a>
+              </div>
+              <p>Is a given array, string, or object empty?
+An &quot;empty&quot; object has no enumerable own-properties.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isEmpty = <span class="keyword">function</span>(obj) {
+    <span class="keyword">if</span> (obj == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">true</span>;
+    <span class="keyword">if</span> (_.isArray(obj) || _.isString(obj)) <span class="keyword">return</span> obj.length === <span class="number">0</span>;
+    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) <span class="keyword">if</span> (_.has(obj, key)) <span class="keyword">return</span> <span class="literal">false</span>;
+    <span class="keyword">return</span> <span class="literal">true</span>;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-108">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-108">&#182;</a>
+              </div>
+              <p>Is a given value a DOM element?</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isElement = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> !!(obj &amp;&amp; obj.nodeType === <span class="number">1</span>);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-109">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-109">&#182;</a>
+              </div>
+              <p>Is a given value an array?
+Delegates to ECMA5&#39;s native Array.isArray</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isArray = nativeIsArray || <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> toString.call(obj) == <span class="string">'[object Array]'</span>;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-110">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-110">&#182;</a>
+              </div>
+              <p>Is a given variable an object?</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isObject = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> obj === Object(obj);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-111">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-111">&#182;</a>
+              </div>
+              <p>Add some isType methods: isArguments, isFunction, isString, isNumber, isDate, isRegExp.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  each([<span class="string">'Arguments'</span>, <span class="string">'Function'</span>, <span class="string">'String'</span>, <span class="string">'Number'</span>, <span class="string">'Date'</span>, <span class="string">'RegExp'</span>], <span class="keyword">function</span>(name) {
+    _[<span class="string">'is'</span> + name] = <span class="keyword">function</span>(obj) {
+      <span class="keyword">return</span> toString.call(obj) == <span class="string">'[object '</span> + name + <span class="string">']'</span>;
+    };
+  });</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-112">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-112">&#182;</a>
+              </div>
+              <p>Define a fallback version of the method in browsers (ahem, IE), where
+there isn&#39;t any inspectable &quot;Arguments&quot; type.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (!_.isArguments(arguments)) {
+    _.isArguments = <span class="keyword">function</span>(obj) {
+      <span class="keyword">return</span> !!(obj &amp;&amp; _.has(obj, <span class="string">'callee'</span>));
+    };
+  }</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-113">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-113">&#182;</a>
+              </div>
+              <p>Optimize <code>isFunction</code> if appropriate.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (<span class="keyword">typeof</span> (<span class="regexp">/./</span>) !== <span class="string">'function'</span>) {
+    _.isFunction = <span class="keyword">function</span>(obj) {
+      <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">'function'</span>;
+    };
+  }</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-114">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-114">&#182;</a>
+              </div>
+              <p>Is a given object a finite number?</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isFinite = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> isFinite(obj) &amp;&amp; !isNaN(parseFloat(obj));
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-115">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-115">&#182;</a>
+              </div>
+              <p>Is the given value <code>NaN</code>? (NaN is the only number which does not equal itself).</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isNaN = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> _.isNumber(obj) &amp;&amp; obj != +obj;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-116">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-116">&#182;</a>
+              </div>
+              <p>Is a given value a boolean?</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isBoolean = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> obj === <span class="literal">true</span> || obj === <span class="literal">false</span> || toString.call(obj) == <span class="string">'[object Boolean]'</span>;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-117">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-117">&#182;</a>
+              </div>
+              <p>Is a given value equal to null?</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isNull = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> obj === <span class="literal">null</span>;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-118">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-118">&#182;</a>
+              </div>
+              <p>Is a given variable undefined?</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.isUndefined = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> obj === <span class="keyword">void</span> <span class="number">0</span>;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-119">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-119">&#182;</a>
+              </div>
+              <p>Shortcut function for checking if an object has a given property directly
+on itself (in other words, not on a prototype).</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.has = <span class="keyword">function</span>(obj, key) {
+    <span class="keyword">return</span> hasOwnProperty.call(obj, key);
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-120">
+            <div class="annotation">
+              
+              <div class="pilwrap for-h2">
+                <a class="pilcrow" href="#section-120">&#182;</a>
+              </div>
+              <h2>Utility Functions</h2>
+
+            </div>
+            
+        </li>
+        
+        
+        <li id="section-121">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-121">&#182;</a>
+              </div>
+              <p>Run Underscore.js in <em>noConflict</em> mode, returning the <code>_</code> variable to its
+previous owner. Returns a reference to the Underscore object.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.noConflict = <span class="keyword">function</span>() {
+    root._ = previousUnderscore;
+    <span class="keyword">return</span> <span class="keyword">this</span>;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-122">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-122">&#182;</a>
+              </div>
+              <p>Keep the identity function around for default iterators.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.identity = <span class="keyword">function</span>(value) {
+    <span class="keyword">return</span> value;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-123">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-123">&#182;</a>
+              </div>
+              <p>Run a function <strong>n</strong> times.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.times = <span class="keyword">function</span>(n, iterator, context) {
+    <span class="keyword">var</span> accum = Array(Math.max(<span class="number">0</span>, n));
+    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; n; i++) accum[i] = iterator.call(context, i);
+    <span class="keyword">return</span> accum;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-124">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-124">&#182;</a>
+              </div>
+              <p>Return a random integer between min and max (inclusive).</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.random = <span class="keyword">function</span>(min, max) {
+    <span class="keyword">if</span> (max == <span class="literal">null</span>) {
+      max = min;
+      min = <span class="number">0</span>;
+    }
+    <span class="keyword">return</span> min + Math.floor(Math.random() * (max - min + <span class="number">1</span>));
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-125">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-125">&#182;</a>
+              </div>
+              <p>List of HTML entities for escaping.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> entityMap = {
+    escape: {
+      <span class="string">'&amp;'</span>: <span class="string">'&amp;amp;'</span>,
+      <span class="string">'&lt;'</span>: <span class="string">'&amp;lt;'</span>,
+      <span class="string">'&gt;'</span>: <span class="string">'&amp;gt;'</span>,
+      <span class="string">'"'</span>: <span class="string">'&amp;quot;'</span>,
+      <span class="string">"'"</span>: <span class="string">'&amp;#x27;'</span>
+    }
+  };
+  entityMap.unescape = _.invert(entityMap.escape);</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-126">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-126">&#182;</a>
+              </div>
+              <p>Regexes containing the keys and values listed immediately above.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> entityRegexes = {
+    escape:   <span class="keyword">new</span> RegExp(<span class="string">'['</span> + _.keys(entityMap.escape).join(<span class="string">''</span>) + <span class="string">']'</span>, <span class="string">'g'</span>),
+    unescape: <span class="keyword">new</span> RegExp(<span class="string">'('</span> + _.keys(entityMap.unescape).join(<span class="string">'|'</span>) + <span class="string">')'</span>, <span class="string">'g'</span>)
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-127">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-127">&#182;</a>
+              </div>
+              <p>Functions for escaping and unescaping strings to/from HTML interpolation.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.each([<span class="string">'escape'</span>, <span class="string">'unescape'</span>], <span class="keyword">function</span>(method) {
+    _[method] = <span class="keyword">function</span>(string) {
+      <span class="keyword">if</span> (string == <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">''</span>;
+      <span class="keyword">return</span> (<span class="string">''</span> + string).replace(entityRegexes[method], <span class="keyword">function</span>(match) {
+        <span class="keyword">return</span> entityMap[method][match];
+      });
+    };
+  });</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-128">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-128">&#182;</a>
+              </div>
+              <p>If the value of the named <code>property</code> is a function then invoke it with the
+<code>object</code> as context; otherwise, return it.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.result = <span class="keyword">function</span>(object, property) {
+    <span class="keyword">if</span> (object == <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">void</span> <span class="number">0</span>;
+    <span class="keyword">var</span> value = object[property];
+    <span class="keyword">return</span> _.isFunction(value) ? value.call(object) : value;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-129">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-129">&#182;</a>
+              </div>
+              <p>Add your own custom functions to the Underscore object.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.mixin = <span class="keyword">function</span>(obj) {
+    each(_.functions(obj), <span class="keyword">function</span>(name) {
+      <span class="keyword">var</span> func = _[name] = obj[name];
+      _.prototype[name] = <span class="keyword">function</span>() {
+        <span class="keyword">var</span> args = [<span class="keyword">this</span>._wrapped];
+        push.apply(args, arguments);
+        <span class="keyword">return</span> result.call(<span class="keyword">this</span>, func.apply(_, args));
+      };
+    });
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-130">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-130">&#182;</a>
+              </div>
+              <p>Generate a unique integer id (unique within the entire client session).
+Useful for temporary DOM ids.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> idCounter = <span class="number">0</span>;
+  _.uniqueId = <span class="keyword">function</span>(prefix) {
+    <span class="keyword">var</span> id = ++idCounter + <span class="string">''</span>;
+    <span class="keyword">return</span> prefix ? prefix + id : id;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-131">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-131">&#182;</a>
+              </div>
+              <p>By default, Underscore uses ERB-style template delimiters, change the
+following template settings to use alternative delimiters.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.templateSettings = {
+    evaluate    : <span class="regexp">/&lt;%([\s\S]+?)%&gt;/g</span>,
+    interpolate : <span class="regexp">/&lt;%=([\s\S]+?)%&gt;/g</span>,
+    escape      : <span class="regexp">/&lt;%-([\s\S]+?)%&gt;/g</span>
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-132">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-132">&#182;</a>
+              </div>
+              <p>When customizing <code>templateSettings</code>, if you don&#39;t want to define an
 interpolation, evaluation or escaping regex, we need one that is
-guaranteed not to match.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">noMatch</span> <span class="o">=</span> <span class="sr">/(.)^/</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Certain characters need to be escaped so that they can be put into a
-string literal.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">escapes</span> <span class="o">=</span> <span class="p">{</span>
-    <span class="s2">&quot;&#39;&quot;</span><span class="o">:</span>      <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
-    <span class="s1">&#39;\\&#39;</span><span class="o">:</span>     <span class="s1">&#39;\\&#39;</span><span class="p">,</span>
-    <span class="s1">&#39;\r&#39;</span><span class="o">:</span>     <span class="s1">&#39;r&#39;</span><span class="p">,</span>
-    <span class="s1">&#39;\n&#39;</span><span class="o">:</span>     <span class="s1">&#39;n&#39;</span><span class="p">,</span>
-    <span class="s1">&#39;\t&#39;</span><span class="o">:</span>     <span class="s1">&#39;t&#39;</span><span class="p">,</span>
-    <span class="s1">&#39;\u2028&#39;</span><span class="o">:</span> <span class="s1">&#39;u2028&#39;</span><span class="p">,</span>
-    <span class="s1">&#39;\u2029&#39;</span><span class="o">:</span> <span class="s1">&#39;u2029&#39;</span>
-  <span class="p">};</span>
-
-  <span class="kd">var</span> <span class="nx">escaper</span> <span class="o">=</span> <span class="sr">/\\|&#39;|\r|\n|\t|\u2028|\u2029/g</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>JavaScript micro-templating, similar to John Resig's implementation.
+guaranteed not to match.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> noMatch = <span class="regexp">/(.)^/</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-133">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-133">&#182;</a>
+              </div>
+              <p>Certain characters need to be escaped so that they can be put into a
+string literal.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> escapes = {
+    <span class="string">"'"</span>:      <span class="string">"'"</span>,
+    <span class="string">'\\'</span>:     <span class="string">'\\'</span>,
+    <span class="string">'\r'</span>:     <span class="string">'r'</span>,
+    <span class="string">'\n'</span>:     <span class="string">'n'</span>,
+    <span class="string">'\t'</span>:     <span class="string">'t'</span>,
+    <span class="string">'\u2028'</span>: <span class="string">'u2028'</span>,
+    <span class="string">'\u2029'</span>: <span class="string">'u2029'</span>
+  };
+
+  <span class="keyword">var</span> escaper = <span class="regexp">/\\|'|\r|\n|\t|\u2028|\u2029/g</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-134">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-134">&#182;</a>
+              </div>
+              <p>JavaScript micro-templating, similar to John Resig&#39;s implementation.
 Underscore templating handles arbitrary delimiters, preserves whitespace,
-and correctly escapes quotes within interpolated code.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">render</span><span class="p">;</span>
-    <span class="nx">settings</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({},</span> <span class="nx">settings</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">templateSettings</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Combine delimiters into one regular expression via alternation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">matcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">([</span>
-      <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">escape</span> <span class="o">||</span> <span class="nx">noMatch</span><span class="p">).</span><span class="nx">source</span><span class="p">,</span>
-      <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">interpolate</span> <span class="o">||</span> <span class="nx">noMatch</span><span class="p">).</span><span class="nx">source</span><span class="p">,</span>
-      <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">evaluate</span> <span class="o">||</span> <span class="nx">noMatch</span><span class="p">).</span><span class="nx">source</span>
-    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|$&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Compile the template source, escaping string literals appropriately.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
-    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="s2">&quot;__p+=&#39;&quot;</span><span class="p">;</span>
-    <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">matcher</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">escape</span><span class="p">,</span> <span class="nx">interpolate</span><span class="p">,</span> <span class="nx">evaluate</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">source</span> <span class="o">+=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span>
-        <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">escaper</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">&#39;\\&#39;</span> <span class="o">+</span> <span class="nx">escapes</span><span class="p">[</span><span class="nx">match</span><span class="p">];</span> <span class="p">});</span>
-
-      <span class="k">if</span> <span class="p">(</span><span class="nx">escape</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">source</span> <span class="o">+=</span> <span class="s2">&quot;&#39;+\n((__t=(&quot;</span> <span class="o">+</span> <span class="nx">escape</span> <span class="o">+</span> <span class="s2">&quot;))==null?&#39;&#39;:_.escape(__t))+\n&#39;&quot;</span><span class="p">;</span>
-      <span class="p">}</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">interpolate</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">source</span> <span class="o">+=</span> <span class="s2">&quot;&#39;+\n((__t=(&quot;</span> <span class="o">+</span> <span class="nx">interpolate</span> <span class="o">+</span> <span class="s2">&quot;))==null?&#39;&#39;:__t)+\n&#39;&quot;</span><span class="p">;</span>
-      <span class="p">}</span>
-      <span class="k">if</span> <span class="p">(</span><span class="nx">evaluate</span><span class="p">)</span> <span class="p">{</span>
-        <span class="nx">source</span> <span class="o">+=</span> <span class="s2">&quot;&#39;;\n&quot;</span> <span class="o">+</span> <span class="nx">evaluate</span> <span class="o">+</span> <span class="s2">&quot;\n__p+=&#39;&quot;</span><span class="p">;</span>
-      <span class="p">}</span>
-      <span class="nx">index</span> <span class="o">=</span> <span class="nx">offset</span> <span class="o">+</span> <span class="nx">match</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
-      <span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
-    <span class="p">});</span>
-    <span class="nx">source</span> <span class="o">+=</span> <span class="s2">&quot;&#39;;\n&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>If a variable is not specified, place data values in local scope.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">variable</span><span class="p">)</span> <span class="nx">source</span> <span class="o">=</span> <span class="s1">&#39;with(obj||{}){\n&#39;</span> <span class="o">+</span> <span class="nx">source</span> <span class="o">+</span> <span class="s1">&#39;}\n&#39;</span><span class="p">;</span>
-
-    <span class="nx">source</span> <span class="o">=</span> <span class="s2">&quot;var __t,__p=&#39;&#39;,__j=Array.prototype.join,&quot;</span> <span class="o">+</span>
-      <span class="s2">&quot;print=function(){__p+=__j.call(arguments,&#39;&#39;);};\n&quot;</span> <span class="o">+</span>
-      <span class="nx">source</span> <span class="o">+</span> <span class="s2">&quot;return __p;\n&quot;</span><span class="p">;</span>
-
-    <span class="k">try</span> <span class="p">{</span>
-      <span class="nx">render</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">variable</span> <span class="o">||</span> <span class="s1">&#39;obj&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>
-    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
-      <span class="nx">e</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>
-      <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
-    <span class="p">}</span>
-
-    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="nx">render</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">_</span><span class="p">);</span>
-    <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">render</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">_</span><span class="p">);</span>
-    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Provide the compiled function source as a convenience for precompilation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">template</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="s1">&#39;function(&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">variable</span> <span class="o">||</span> <span class="s1">&#39;obj&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;){\n&#39;</span> <span class="o">+</span> <span class="nx">source</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">;</span>
-
-    <span class="k">return</span> <span class="nx">template</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Add a "chain" function, which will delegate to the wrapper.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="nx">_</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">chain</span><span class="p">();</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <h2>OOP</h2>
-
-<p>If Underscore is called as a function, it returns a wrapped object that
+and correctly escapes quotes within interpolated code.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.template = <span class="keyword">function</span>(text, data, settings) {
+    <span class="keyword">var</span> render;
+    settings = _.defaults({}, settings, _.templateSettings);</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-135">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-135">&#182;</a>
+              </div>
+              <p>Combine delimiters into one regular expression via alternation.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> matcher = <span class="keyword">new</span> RegExp([
+      (settings.escape || noMatch).source,
+      (settings.interpolate || noMatch).source,
+      (settings.evaluate || noMatch).source
+    ].join(<span class="string">'|'</span>) + <span class="string">'|$'</span>, <span class="string">'g'</span>);</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-136">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-136">&#182;</a>
+              </div>
+              <p>Compile the template source, escaping string literals appropriately.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> index = <span class="number">0</span>;
+    <span class="keyword">var</span> source = <span class="string">"__p+='"</span>;
+    text.replace(matcher, <span class="keyword">function</span>(match, escape, interpolate, evaluate, offset) {
+      source += text.slice(index, offset)
+        .replace(escaper, <span class="keyword">function</span>(match) { <span class="keyword">return</span> <span class="string">'\\'</span> + escapes[match]; });
+
+      <span class="keyword">if</span> (escape) {
+        source += <span class="string">"'+\n((__t=("</span> + escape + <span class="string">"))==null?'':_.escape(__t))+\n'"</span>;
+      }
+      <span class="keyword">if</span> (interpolate) {
+        source += <span class="string">"'+\n((__t=("</span> + interpolate + <span class="string">"))==null?'':__t)+\n'"</span>;
+      }
+      <span class="keyword">if</span> (evaluate) {
+        source += <span class="string">"';\n"</span> + evaluate + <span class="string">"\n__p+='"</span>;
+      }
+      index = offset + match.length;
+      <span class="keyword">return</span> match;
+    });
+    source += <span class="string">"';\n"</span>;</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-137">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-137">&#182;</a>
+              </div>
+              <p>If a variable is not specified, place data values in local scope.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (!settings.variable) source = <span class="string">'with(obj||{}){\n'</span> + source + <span class="string">'}\n'</span>;
+
+    source = <span class="string">"var __t,__p='',__j=Array.prototype.join,"</span> +
+      <span class="string">"print=function(){__p+=__j.call(arguments,'');};\n"</span> +
+      source + <span class="string">"return __p;\n"</span>;
+
+    <span class="keyword">try</span> {
+      render = <span class="keyword">new</span> Function(settings.variable || <span class="string">'obj'</span>, <span class="string">'_'</span>, source);
+    } <span class="keyword">catch</span> (e) {
+      e.source = source;
+      <span class="keyword">throw</span> e;
+    }
+
+    <span class="keyword">if</span> (data) <span class="keyword">return</span> render(data, _);
+    <span class="keyword">var</span> template = <span class="keyword">function</span>(data) {
+      <span class="keyword">return</span> render.call(<span class="keyword">this</span>, data, _);
+    };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-138">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-138">&#182;</a>
+              </div>
+              <p>Provide the compiled function source as a convenience for precompilation.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    template.source = <span class="string">'function('</span> + (settings.variable || <span class="string">'obj'</span>) + <span class="string">'){\n'</span> + source + <span class="string">'}'</span>;
+
+    <span class="keyword">return</span> template;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-139">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-139">&#182;</a>
+              </div>
+              <p>Add a &quot;chain&quot; function, which will delegate to the wrapper.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.chain = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> _(obj).chain();
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-140">
+            <div class="annotation">
+              
+              <div class="pilwrap for-h2">
+                <a class="pilcrow" href="#section-140">&#182;</a>
+              </div>
+              <h2>OOP</h2>
+
+            </div>
+            
+        </li>
+        
+        
+        <li id="section-141">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-141">&#182;</a>
+              </div>
+              <p>If Underscore is called as a function, it returns a wrapped object that
 can be used OO-style. This wrapper holds altered versions of all the
-underscore functions. Wrapped objects may be chained.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Helper function to continue chaining intermediate results.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
-    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_chain</span> <span class="o">?</span> <span class="nx">_</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">chain</span><span class="p">()</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">;</span>
-  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Add all of the Underscore functions to the wrapper object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">_</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>Add all mutator Array functions to the wrapper.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">each</span><span class="p">([</span><span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="s1">&#39;reverse&#39;</span><span class="p">,</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span> <span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="s1">&#39;splice&#39;</span><span class="p">,</span> <span class="s1">&#39;unshift&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
-    <span class="nx">_</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_wrapped</span><span class="p">;</span>
-      <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
-      <span class="k">if</span> <span class="p">((</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;shift&#39;</span> <span class="o">||</span> <span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;splice&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
-      <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span>
-    <span class="p">};</span>
-  <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>Add all accessor Array functions to the wrapper.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">each</span><span class="p">([</span><span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="s1">&#39;slice&#39;</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
-    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">ArrayProto</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
-    <span class="nx">_</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_wrapped</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
-    <span class="p">};</span>
-  <span class="p">});</span>
-
-  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>Start chaining a wrapped Underscore object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">chain</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="k">this</span><span class="p">.</span><span class="nx">_chain</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
-      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
-    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>Extracts the result from a wrapped and chained object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">value</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
-      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_wrapped</span><span class="p">;</span>
-    <span class="p">}</span>
-
-  <span class="p">});</span>
-
-<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
-
-</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 
\ No newline at end of file
+underscore functions. Wrapped objects may be chained.</p>
+<p>Helper function to continue chaining intermediate results.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> result = <span class="keyword">function</span>(obj) {
+    <span class="keyword">return</span> <span class="keyword">this</span>._chain ? _(obj).chain() : obj;
+  };</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-142">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-142">&#182;</a>
+              </div>
+              <p>Add all of the Underscore functions to the wrapper object.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  _.mixin(_);</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-143">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-143">&#182;</a>
+              </div>
+              <p>Add all mutator Array functions to the wrapper.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  each([<span class="string">'pop'</span>, <span class="string">'push'</span>, <span class="string">'reverse'</span>, <span class="string">'shift'</span>, <span class="string">'sort'</span>, <span class="string">'splice'</span>, <span class="string">'unshift'</span>], <span class="keyword">function</span>(name) {
+    <span class="keyword">var</span> method = ArrayProto[name];
+    _.prototype[name] = <span class="keyword">function</span>() {
+      <span class="keyword">var</span> obj = <span class="keyword">this</span>._wrapped;
+      method.apply(obj, arguments);
+      <span class="keyword">if</span> ((name == <span class="string">'shift'</span> || name == <span class="string">'splice'</span>) &amp;&amp; obj.length === <span class="number">0</span>) <span class="keyword">delete</span> obj[<span class="number">0</span>];
+      <span class="keyword">return</span> result.call(<span class="keyword">this</span>, obj);
+    };
+  });</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-144">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-144">&#182;</a>
+              </div>
+              <p>Add all accessor Array functions to the wrapper.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>  each([<span class="string">'concat'</span>, <span class="string">'join'</span>, <span class="string">'slice'</span>], <span class="keyword">function</span>(name) {
+    <span class="keyword">var</span> method = ArrayProto[name];
+    _.prototype[name] = <span class="keyword">function</span>() {
+      <span class="keyword">return</span> result.call(<span class="keyword">this</span>, method.apply(<span class="keyword">this</span>._wrapped, arguments));
+    };
+  });
+
+  _.extend(_.prototype, {</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-145">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-145">&#182;</a>
+              </div>
+              <p>Start chaining a wrapped Underscore object.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    chain: <span class="keyword">function</span>() {
+      <span class="keyword">this</span>._chain = <span class="literal">true</span>;
+      <span class="keyword">return</span> <span class="keyword">this</span>;
+    },</pre></div></div>
+            
+        </li>
+        
+        
+        <li id="section-146">
+            <div class="annotation">
+              
+              <div class="pilwrap ">
+                <a class="pilcrow" href="#section-146">&#182;</a>
+              </div>
+              <p>Extracts the result from a wrapped and chained object.</p>
+
+            </div>
+            
+            <div class="content"><div class='highlight'><pre>    value: <span class="keyword">function</span>() {
+      <span class="keyword">return</span> <span class="keyword">this</span>._wrapped;
+    }
+
+  });
+
+}).call(<span class="keyword">this</span>);</pre></div></div>
+            
+        </li>
+        
+    </ul>
+  </div>
+</body>
+</html>
diff --git a/profiles/commons/libraries/underscore/index.html b/profiles/commons/libraries/underscore/index.html
index 8c5793a..eddf69f 100644
--- a/profiles/commons/libraries/underscore/index.html
+++ b/profiles/commons/libraries/underscore/index.html
@@ -3,7 +3,9 @@
 <head>
   <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
   <meta http-equiv="X-UA-Compatible" content="chrome=1" />
-  <meta name="viewport" content="width=device-width" />
+  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
+  <meta name="viewport" content="target-densitydpi=device-dpi" />
+  <meta name="HandheldFriendly" content="true"/>
   <link rel="canonical" href="http://underscorejs.org" />
   <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
   <title>Underscore.js</title>
@@ -179,10 +181,10 @@
   <div id="sidebar" class="interface">
 
     <a class="toc_title" href="#">
-      Underscore.js <span class="version">(1.4.4)</span>
+      Underscore.js <span class="version">(1.5.2)</span>
     </a>
     <ul class="toc_section">
-      <li>&raquo; <a href="http://github.com/documentcloud/underscore">GitHub Repository</a></li>
+      <li>&raquo; <a href="http://github.com/jashkenas/underscore">GitHub Repository</a></li>
       <li>&raquo; <a href="docs/underscore.html">Annotated Source</a></li>
     </ul>
 
@@ -212,8 +214,10 @@
       <li>- <a href="#min">min</a></li>
       <li>- <a href="#sortBy">sortBy</a></li>
       <li>- <a href="#groupBy">groupBy</a></li>
+      <li>- <a href="#indexBy">indexBy</a></li>
       <li>- <a href="#countBy">countBy</a></li>
       <li>- <a href="#shuffle">shuffle</a></li>
+      <li>- <a href="#sample">sample</a></li>
       <li>- <a href="#toArray">toArray</a></li>
       <li>- <a href="#size">size</a></li>
     </ul>
@@ -334,13 +338,13 @@
     </p>
 
     <p>
-      <a href="http://github.com/documentcloud/underscore/">Underscore</a> is a
+      <a href="http://github.com/jashkenas/underscore/">Underscore</a> is a
       utility-belt library for JavaScript that provides a lot of the
       functional programming support that you would expect in
       <a href="http://prototypejs.org/doc/latest/">Prototype.js</a>
       (or <a href="http://www.ruby-doc.org/core/classes/Enumerable.html">Ruby</a>),
       but without extending any of the built-in JavaScript objects. It's the
-      tie to go along with <a href="http://docs.jquery.com">jQuery</a>'s tux,
+      tie to go along with <a href="http://jquery.com">jQuery</a>'s tux,
       and <a href="http://backbonejs.org">Backbone.js</a>'s suspenders.
     </p>
 
@@ -365,9 +369,9 @@
 
     <p>
       The project is
-      <a href="http://github.com/documentcloud/underscore/">hosted on GitHub</a>.
+      <a href="http://github.com/jashkenas/underscore/">hosted on GitHub</a>.
       You can report bugs and discuss features on the
-      <a href="http://github.com/documentcloud/underscore/issues">issues page</a>,
+      <a href="http://github.com/jashkenas/underscore/issues">issues page</a>,
       on Freenode in the <tt>#documentcloud</tt> channel,
       or send tweets to <a href="http://twitter.com/documentcloud">@documentcloud</a>.
     </p>
@@ -380,18 +384,21 @@
 
     <table>
       <tr>
-        <td><a href="underscore.js">Development Version (1.4.4)</a></td>
-        <td><i>40kb, Uncompressed with Plentiful Comments</i></td>
+        <td><a href="underscore.js">Development Version (1.5.2)</a></td>
+        <td><i>43kb, Uncompressed with Plentiful Comments</i></td>
       </tr>
       <tr>
-        <td><a href="underscore-min.js">Production Version (1.4.4)</a></td>
-        <td><i>4kb, Minified and Gzipped</i></td>
+        <td><a href="underscore-min.js">Production Version (1.5.2)</a></td>
+        <td>
+          <i>4.9kb, Minified and Gzipped</i>
+          &nbsp;<small>(<a href="underscore-min.map">Source Map</a>)</small>
+        </td>
       </tr>
       <tr>
         <td colspan="2"><div class="rule"></div></td>
       </tr>
       <tr>
-        <td><a href="https://raw.github.com/documentcloud/underscore/master/underscore.js">Edge Version</a></td>
+        <td><a href="https://raw.github.com/jashkenas/underscore/master/underscore.js">Edge Version</a></td>
         <td><i>Unreleased, current <tt>master</tt>, use at your own risk</i></td>
       </tr>
     </table>
@@ -414,9 +421,18 @@
       <pre>
 _.each([1, 2, 3], alert);
 =&gt; alerts each number in turn...
-_.each({one : 1, two : 2, three : 3}, alert);
+_.each({one: 1, two: 2, three: 3}, alert);
 =&gt; alerts each number value in turn...</pre>
 
+      <p>
+        <i>
+          Note: Collection functions work on arrays, objects, and
+          array-like objects such as</i> <tt>arguments</tt>, <tt>NodeList</tt><i>
+          and similar. But it works by duck-typing, so avoid passing objects with
+          a numeric <tt>length</tt> property.
+        </i>
+      </p>
+
       <p id="map">
         <b class="header">map</b><code>_.map(list, iterator, [context])</code>
         <span class="alias">Alias: <b>collect</b></span>
@@ -429,7 +445,7 @@ _.each({one : 1, two : 2, three : 3}, alert);
       <pre>
 _.map([1, 2, 3], function(num){ return num * 3; });
 =&gt; [3, 6, 9]
-_.map({one : 1, two : 2, three : 3}, function(num, key){ return num * 3; });
+_.map({one: 1, two: 2, three: 3}, function(num, key){ return num * 3; });
 =&gt; [3, 6, 9]</pre>
 
       <p id="reduce">
@@ -468,7 +484,8 @@ var flat = _.reduceRight(list, function(a, b) { return a.concat(b); }, []);
         <span class="alias">Alias: <b>detect</b></span>
         <br />
         Looks through each value in the <b>list</b>, returning the first one that
-        passes a truth test (<b>iterator</b>). The function returns as
+        passes a truth test (<b>iterator</b>), or <code>undefined</code> if no value
+        passes the test. The function returns as
         soon as it finds an acceptable element, and doesn't traverse the
         entire list.
       </p>
@@ -508,6 +525,10 @@ _.where(listOfPlays, {author: "Shakespeare", year: 1611});
         Looks through the <b>list</b> and returns the <i>first</i> value that matches
         all of the key-value pairs listed in <b>properties</b>.
       </p>
+      <p>
+        If no match is found, or if <b>list</b> is empty, <i>undefined</i> will be
+        returned.
+      </p>
       <pre>
 _.findWhere(publicServicePulitzers, {newsroom: "The New York Times"});
 =&gt; {year: 1918, newsroom: "The New York Times",
@@ -528,7 +549,7 @@ var odds = _.reject([1, 2, 3, 4, 5, 6], function(num){ return num % 2 == 0; });
 </pre>
 
       <p id="every">
-        <b class="header">every</b><code>_.every(list, iterator, [context])</code>
+        <b class="header">every</b><code>_.every(list, [iterator], [context])</code>
         <span class="alias">Alias: <b>all</b></span>
         <br />
         Returns <i>true</i> if all of the values in the <b>list</b> pass the <b>iterator</b>
@@ -584,7 +605,7 @@ _.invoke([[5, 1, 7], [3, 2, 1]], 'sort');
         <b>map</b>: extracting a list of property values.
       </p>
       <pre>
-var stooges = [{name : 'moe', age : 40}, {name : 'larry', age : 50}, {name : 'curly', age : 60}];
+var stooges = [{name: 'moe', age: 40}, {name: 'larry', age: 50}, {name: 'curly', age: 60}];
 _.pluck(stooges, 'name');
 =&gt; ["moe", "larry", "curly"]
 </pre>
@@ -592,22 +613,22 @@ _.pluck(stooges, 'name');
       <p id="max">
         <b class="header">max</b><code>_.max(list, [iterator], [context])</code>
         <br />
-        Returns the maximum value in <b>list</b>. If <b>iterator</b> is passed,
-        it will be used on each value to generate the criterion by which the
-        value is ranked.
+        Returns the maximum value in <b>list</b>. If an <b>iterator</b>
+        function is provided, it will be used on each value to generate the
+        criterion by which the value is ranked.
       </p>
       <pre>
-var stooges = [{name : 'moe', age : 40}, {name : 'larry', age : 50}, {name : 'curly', age : 60}];
+var stooges = [{name: 'moe', age: 40}, {name: 'larry', age: 50}, {name: 'curly', age: 60}];
 _.max(stooges, function(stooge){ return stooge.age; });
-=&gt; {name : 'curly', age : 60};
+=&gt; {name: 'curly', age: 60};
 </pre>
 
       <p id="min">
         <b class="header">min</b><code>_.min(list, [iterator], [context])</code>
         <br />
-        Returns the minimum value in <b>list</b>. If <b>iterator</b> is passed,
-        it will be used on each value to generate the criterion by which the
-        value is ranked.
+        Returns the minimum value in <b>list</b>. If an <b>iterator</b>
+        function is provided, it will be used on each value to generate the
+        criterion by which the value is ranked.
       </p>
       <pre>
 var numbers = [10, 5, 100, 2, 1000];
@@ -618,9 +639,10 @@ _.min(numbers);
       <p id="sortBy">
         <b class="header">sortBy</b><code>_.sortBy(list, iterator, [context])</code>
         <br />
-        Returns a sorted copy of <b>list</b>, ranked in ascending order by the
-        results of running each value through <b>iterator</b>. Iterator may
-        also be the string name of the property to sort by (eg. <tt>length</tt>).
+        Returns a (stably) sorted copy of <b>list</b>, ranked in ascending
+        order by the results of running each value through <b>iterator</b>.
+        Iterator may also be the string name of the property to sort by (eg.
+        <tt>length</tt>).
       </p>
       <pre>
 _.sortBy([1, 2, 3, 4, 5, 6], function(num){ return Math.sin(num); });
@@ -643,6 +665,25 @@ _.groupBy(['one', 'two', 'three'], 'length');
 =&gt; {3: ["one", "two"], 5: ["three"]}
 </pre>
 
+      <p id="indexBy">
+        <b class="header">indexBy</b><code>_.indexBy(list, iterator, [context])</code>
+        <br />
+        Given a <b>list</b>, and an <b>iterator</b> function that returns a 
+        key for each element in the list (or a property name), 
+        returns an object with an index of each item. 
+        Just like <a href="#groupBy">groupBy</a>, but for when you know your 
+        keys are unique.
+      </p>
+      <pre>
+var stooges = [{name: 'moe', age: 40}, {name: 'larry', age: 50}, {name: 'curly', age: 60}];
+_.indexBy(stooges, 'age');
+=&gt; {
+  "40": {name: 'moe', age: 40},
+  "50": {name: 'larry', age: 50},
+  "60": {name: 'curly', age: 60}
+}
+</pre>
+
       <p id="countBy">
         <b class="header">countBy</b><code>_.countBy(list, iterator, [context])</code>
         <br />
@@ -653,7 +694,7 @@ _.groupBy(['one', 'two', 'three'], 'length');
       </p>
       <pre>
 _.countBy([1, 2, 3, 4, 5], function(num) {
-  return num % 2 == 0 ? 'even' : 'odd';
+  return num % 2 == 0 ? 'even': 'odd';
 });
 =&gt; {odd: 3, even: 2}
 </pre>
@@ -669,11 +710,26 @@ _.shuffle([1, 2, 3, 4, 5, 6]);
 =&gt; [4, 1, 6, 3, 5, 2]
 </pre>
 
+      <p id="sample">
+        <b class="header">sample</b><code>_.sample(list, [n])</code>
+        <br />
+        Produce a random sample from the <b>list</b>. Pass a number to
+        return <b>n</b> random elements from the list. Otherwise a single random
+        item will be returned.
+      </p>
+      <pre>
+_.sample([1, 2, 3, 4, 5, 6]);
+=&gt; 4
+
+_.sample([1, 2, 3, 4, 5, 6], 3);
+=&gt; [1, 6, 2]
+</pre>
+
       <p id="toArray">
         <b class="header">toArray</b><code>_.toArray(list)</code>
         <br />
-        Converts the <b>list</b> (anything that can be iterated over), into a
-        real Array. Useful for transmuting the <b>arguments</b> object.
+        Creates a real Array from the <b>list</b> (anything that can be
+        iterated over).  Useful for transmuting the <b>arguments</b> object.
       </p>
       <pre>
 (function(){ return _.toArray(arguments).slice(1); })(1, 2, 3, 4);
@@ -686,7 +742,7 @@ _.shuffle([1, 2, 3, 4, 5, 6]);
         Return the number of values in the <b>list</b>.
       </p>
       <pre>
-_.size({one : 1, two : 2, three : 3});
+_.size({one: 1, two: 2, three: 3});
 =&gt; 3
 </pre>
 
@@ -837,12 +893,15 @@ _.uniq([1, 2, 1, 3, 1, 4]);
         Merges together the values of each of the <b>arrays</b> with the
         values at the corresponding position. Useful when you have separate
         data sources that are coordinated through matching array indexes.
-        If you're working with a matrix of nested arrays, <b>zip.apply</b>
+        If you're working with a matrix of nested arrays, <tt>_.zip.apply</tt>
         can transpose the matrix in a similar fashion.
       </p>
       <pre>
 _.zip(['moe', 'larry', 'curly'], [30, 40, 50], [true, false, false]);
 =&gt; [["moe", 30, true], ["larry", 40, false], ["curly", 50, false]]
+
+_.zip.apply(_, arrayOfRowsOfData);
+=&gt; arrayOfColumnsOfData
 </pre>
 
       <p id="object">
@@ -850,6 +909,7 @@ _.zip(['moe', 'larry', 'curly'], [30, 40, 50], [true, false, false]);
         <br />
         Converts arrays into objects. Pass either a single list of
         <tt>[key, value]</tt> pairs, or a list of keys, and a list of values.
+        If duplicate keys exist, the last value wins.
       </p>
       <pre>
 _.object(['moe', 'larry', 'curly'], [30, 40, 50]);
@@ -893,12 +953,17 @@ _.lastIndexOf([1, 2, 3, 1, 2, 3], 2);
         <br />
         Uses a binary search to determine the index at which the <b>value</b>
         <i>should</i> be inserted into the <b>list</b> in order to maintain the <b>list</b>'s
-        sorted order. If an <b>iterator</b> is passed, it will be used to compute
+        sorted order. If an <b>iterator</b> function is provided, it will be used to compute
         the sort ranking of each value, including the <b>value</b> you pass.
+        Iterator may also be the string name of the property to sort by (eg. <tt>length</tt>).
       </p>
       <pre>
 _.sortedIndex([10, 20, 30, 40, 50], 35);
 =&gt; 3
+
+var stooges = [{name: 'moe', age: 40}, {name: 'curly', age: 60}];
+_.sortedIndex(stooges, {name: 'larry', age: 50}, 'age');
+=&gt; 1
 </pre>
 
       <p id="range">
@@ -908,7 +973,9 @@ _.sortedIndex([10, 20, 30, 40, 50], 35);
         <tt>each</tt> and <tt>map</tt> loops. <b>start</b>, if omitted, defaults
         to <i>0</i>; <b>step</b> defaults to <i>1</i>. Returns a list of integers
         from <b>start</b> to <b>stop</b>, incremented (or decremented) by <b>step</b>,
-        exclusive.
+        exclusive. Note that ranges that <b>stop</b> before they <b>start</b> 
+        are considered to be zero-length instead of negative — if you'd like a 
+        negative range, use a negative <b>step</b>.
       </p>
       <pre>
 _.range(10);
@@ -935,30 +1002,29 @@ _.range(0);
       </p>
       <pre>
 var func = function(greeting){ return greeting + ': ' + this.name };
-func = _.bind(func, {name : 'moe'}, 'hi');
+func = _.bind(func, {name: 'moe'}, 'hi');
 func();
 =&gt; 'hi: moe'
 </pre>
 
       <p id="bindAll">
-        <b class="header">bindAll</b><code>_.bindAll(object, [*methodNames])</code>
+        <b class="header">bindAll</b><code>_.bindAll(object, *methodNames)</code>
         <br />
         Binds a number of methods on the <b>object</b>, specified by
         <b>methodNames</b>, to be run in the context of that object whenever they
         are invoked. Very handy for binding functions that are going to be used
         as event handlers, which would otherwise be invoked with a fairly useless
-        <i>this</i>. If no <b>methodNames</b> are provided, all of the object's
-        function properties will be bound to it.
+        <i>this</i>. <b>methodNames</b> are required.
       </p>
       <pre>
 var buttonView = {
-  label   : 'underscore',
-  onClick : function(){ alert('clicked: ' + this.label); },
-  onHover : function(){ console.log('hovering: ' + this.label); }
+  label  : 'underscore',
+  onClick: function(){ alert('clicked: ' + this.label); },
+  onHover: function(){ console.log('hovering: ' + this.label); }
 };
-_.bindAll(buttonView);
+_.bindAll(buttonView, 'onClick', 'onHover');
+// When the button is clicked, this.label will have the correct value.
 jQuery('#underscore_button').bind('click', buttonView.onClick);
-=&gt; When the button is clicked, this.label will have the correct value...
 </pre>
 
       <p id="partial">
@@ -987,7 +1053,7 @@ add5(10);
       </p>
       <pre>
 var fibonacci = _.memoize(function(n) {
-  return n &lt; 2 ? n : fibonacci(n - 1) + fibonacci(n - 2);
+  return n &lt; 2 ? n: fibonacci(n - 1) + fibonacci(n - 2);
 });
 </pre>
 
@@ -1019,7 +1085,7 @@ _.defer(function(){ alert('deferred'); });
 </pre>
 
       <p id="throttle">
-        <b class="header">throttle</b><code>_.throttle(function, wait)</code>
+        <b class="header">throttle</b><code>_.throttle(function, wait, [options])</code>
         <br />
         Creates and returns a new, throttled version of the passed function,
         that, when invoked repeatedly, will only actually call the original function
@@ -1027,6 +1093,14 @@ _.defer(function(){ alert('deferred'); });
         milliseconds. Useful for rate-limiting events that occur faster than you
         can keep up with.
       </p>
+      <p>
+        By default, <b>throttle</b> will execute the function as soon as you call it
+        for the first time, and, if you call it again any number of times
+        during the <b>wait</b> period, as soon as that period is over.
+        If you'd like to disable the leading-edge
+        call, pass <tt>{leading: false}</tt>, and if you'd like to disable the
+        execution on the trailing-edge, pass <br /> <tt>{trailing: false}</tt>.
+      </p>
       <pre>
 var throttled = _.throttle(updatePosition, 100);
 $(window).scroll(throttled);
@@ -1035,7 +1109,7 @@ $(window).scroll(throttled);
       <p id="debounce">
         <b class="header">debounce</b><code>_.debounce(function, wait, [immediate])</code>
         <br />
-        Creates and returns a new debounced version of the passed function that
+        Creates and returns a new debounced version of the passed function which
         will postpone its execution until after
         <b>wait</b> milliseconds have elapsed since the last time it
         was invoked. Useful for implementing behavior that should only happen
@@ -1115,10 +1189,10 @@ hello();
       </p>
       <pre>
 var greet    = function(name){ return "hi: " + name; };
-var exclaim  = function(statement){ return statement + "!"; };
-var welcome = _.compose(exclaim, greet);
+var exclaim  = function(statement){ return statement.toUpperCase() + "!"; };
+var welcome = _.compose(greet, exclaim);
 welcome('moe');
-=&gt; 'hi: moe!'
+=&gt; 'hi: MOE!'
 </pre>
 
       <h2 id="objects">Object Functions</h2>
@@ -1129,7 +1203,7 @@ welcome('moe');
         Retrieve all the names of the <b>object</b>'s properties.
       </p>
       <pre>
-_.keys({one : 1, two : 2, three : 3});
+_.keys({one: 1, two: 2, three: 3});
 =&gt; ["one", "two", "three"]
 </pre>
 
@@ -1139,7 +1213,7 @@ _.keys({one : 1, two : 2, three : 3});
         Return all of the values of the <b>object</b>'s properties.
       </p>
       <pre>
-_.values({one : 1, two : 2, three : 3});
+_.values({one: 1, two: 2, three: 3});
 =&gt; [1, 2, 3]
 </pre>
 
@@ -1186,8 +1260,8 @@ _.functions(_);
         name in previous arguments.
       </p>
       <pre>
-_.extend({name : 'moe'}, {age : 50});
-=&gt; {name : 'moe', age : 50}
+_.extend({name: 'moe'}, {age: 50});
+=&gt; {name: 'moe', age: 50}
 </pre>
 
       <p id="pick">
@@ -1197,8 +1271,8 @@ _.extend({name : 'moe'}, {age : 50});
         the whitelisted <b>keys</b> (or array of valid keys).
       </p>
       <pre>
-_.pick({name : 'moe', age: 50, userid : 'moe1'}, 'name', 'age');
-=&gt; {name : 'moe', age : 50}
+_.pick({name: 'moe', age: 50, userid: 'moe1'}, 'name', 'age');
+=&gt; {name: 'moe', age: 50}
 </pre>
 
       <p id="omit">
@@ -1208,21 +1282,21 @@ _.pick({name : 'moe', age: 50, userid : 'moe1'}, 'name', 'age');
         <b>keys</b> (or array of keys).
       </p>
       <pre>
-_.omit({name : 'moe', age : 50, userid : 'moe1'}, 'userid');
-=&gt; {name : 'moe', age : 50}
+_.omit({name: 'moe', age: 50, userid: 'moe1'}, 'userid');
+=&gt; {name: 'moe', age: 50}
 </pre>
 
       <p id="defaults">
         <b class="header">defaults</b><code>_.defaults(object, *defaults)</code>
         <br />
-        Fill in null and undefined properties in <b>object</b> with values from the
+        Fill in <tt>undefined</tt> properties in <b>object</b> with values from the
         <b>defaults</b> objects, and return the <b>object</b>. As soon as the
         property is filled, further defaults will have no effect.
       </p>
       <pre>
-var iceCream = {flavor : "chocolate"};
-_.defaults(iceCream, {flavor : "vanilla", sprinkles : "lots"});
-=&gt; {flavor : "chocolate", sprinkles : "lots"}
+var iceCream = {flavor: "chocolate"};
+_.defaults(iceCream, {flavor: "vanilla", sprinkles: "lots"});
+=&gt; {flavor: "chocolate", sprinkles: "lots"}
 </pre>
 
       <p id="clone">
@@ -1232,8 +1306,8 @@ _.defaults(iceCream, {flavor : "vanilla", sprinkles : "lots"});
         or arrays will be copied by reference, not duplicated.
       </p>
       <pre>
-_.clone({name : 'moe'});
-=&gt; {name : 'moe'};
+_.clone({name: 'moe'});
+=&gt; {name: 'moe'};
 </pre>
 
       <p id="tap">
@@ -1272,8 +1346,8 @@ _.has({a: 1, b: 2, c: 3}, "b");
         if they should be considered equal.
       </p>
       <pre>
-var moe   = {name : 'moe', luckyNumbers : [13, 27, 34]};
-var clone = {name : 'moe', luckyNumbers : [13, 27, 34]};
+var moe   = {name: 'moe', luckyNumbers: [13, 27, 34]};
+var clone = {name: 'moe', luckyNumbers: [13, 27, 34]};
 moe == clone;
 =&gt; false
 _.isEqual(moe, clone);
@@ -1283,7 +1357,8 @@ _.isEqual(moe, clone);
       <p id="isEmpty">
         <b class="header">isEmpty</b><code>_.isEmpty(object)</code>
         <br />
-        Returns <i>true</i> if <b>object</b> contains no values.
+        Returns <i>true</i> if <b>object</b> contains no values
+        (no enumerable own-properties).
       </p>
       <pre>
 _.isEmpty([1, 2, 3]);
@@ -1417,7 +1492,7 @@ _.isRegExp(/moe/);
         <br />
         Returns <i>true</i> if <b>object</b> is <i>NaN</i>.<br /> Note: this is not
         the same as the native <b>isNaN</b> function, which will also return
-        true if the variable is <i>undefined</i>.
+        true for many other not-number values, such as <tt>undefined</tt>.
       </p>
       <pre>
 _.isNaN(NaN);
@@ -1470,7 +1545,7 @@ var underscore = _.noConflict();</pre>
         a default iterator.
       </p>
       <pre>
-var moe = {name : 'moe'};
+var moe = {name: 'moe'};
 moe === _.identity(moe);
 =&gt; true</pre>
 
@@ -1478,7 +1553,8 @@ moe === _.identity(moe);
         <b class="header">times</b><code>_.times(n, iterator, [context])</code>
         <br />
         Invokes the given iterator function <b>n</b> times. Each invocation of
-        <b>iterator</b> is called with an <tt>index</tt> argument.
+        <b>iterator</b> is called with an <tt>index</tt> argument. Produces an
+        array of the returned values.
         <br />
         <i>Note: this example uses the <a href="#chaining">chaining syntax</a></i>.
       </p>
@@ -1505,7 +1581,7 @@ _.random(0, 100);
       </p>
       <pre>
 _.mixin({
-  capitalize : function(string) {
+  capitalize: function(string) {
     return string.charAt(0).toUpperCase() + string.substring(1).toLowerCase();
   }
 });
@@ -1548,7 +1624,8 @@ _.unescape('Curly, Larry &amp;amp; Moe');
       <p id="result">
         <b class="header">result</b><code>_.result(object, property)</code>
         <br />
-        If the value of the named property is a function then invoke it; otherwise, return it.
+        If the value of the named <b>property</b> is a function then invoke it
+        with the <b>object</b> as context; otherwise, return it.
       </p>
       <pre>
 var object = {cheese: 'crumpets', stuff: function(){ return 'nonsense'; }};
@@ -1575,15 +1652,15 @@ _.result(object, 'stuff');
 
       <pre>
 var compiled = _.template("hello: &lt;%= name %&gt;");
-compiled({name : 'moe'});
+compiled({name: 'moe'});
 =&gt; "hello: moe"
 
 var list = "&lt;% _.each(people, function(name) { %&gt; &lt;li&gt;&lt;%= name %&gt;&lt;/li&gt; &lt;% }); %&gt;";
-_.template(list, {people : ['moe', 'curly', 'larry']});
+_.template(list, {people: ['moe', 'curly', 'larry']});
 =&gt; "&lt;li&gt;moe&lt;/li&gt;&lt;li&gt;curly&lt;/li&gt;&lt;li&gt;larry&lt;/li&gt;"
 
 var template = _.template("&lt;b&gt;&lt;%- value %&gt;&lt;/b&gt;");
-template({value : '&lt;script&gt;'});
+template({value: '&lt;script&gt;'});
 =&gt; "&lt;b&gt;&amp;lt;script&amp;gt;&lt;/b&gt;"</pre>
 
       <p>
@@ -1594,7 +1671,7 @@ template({value : '&lt;script&gt;'});
       <pre>
 var compiled = _.template("&lt;% print('Hello ' + epithet); %&gt;");
 compiled({epithet: "stooge"});
-=&gt; "Hello stooge."</pre>
+=&gt; "Hello stooge"</pre>
 
       <p>
         If ERB-style delimiters aren't your cup of tea, you can change Underscore's
@@ -1611,11 +1688,11 @@ compiled({epithet: "stooge"});
 
       <pre>
 _.templateSettings = {
-  interpolate : /\{\{(.+?)\}\}/g
+  interpolate: /\{\{(.+?)\}\}/g
 };
 
 var template = _.template("Hello {{ name }}!");
-template({name : "Mustache"});
+template({name: "Mustache"});
 =&gt; "Hello Mustache!"</pre>
 
       <p>
@@ -1664,10 +1741,10 @@ _([1, 2, 3]).map(function(n){ return n * 2; });</pre>
 
 <pre>
 var lyrics = [
-  {line : 1, words : "I'm a lumberjack and I'm okay"},
-  {line : 2, words : "I sleep all night and I work all day"},
-  {line : 3, words : "He's a lumberjack and he's okay"},
-  {line : 4, words : "He sleeps all night and he works all day"}
+  {line: 1, words: "I'm a lumberjack and I'm okay"},
+  {line: 2, words: "I sleep all night and I work all day"},
+  {line: 3, words: "He's a lumberjack and he's okay"},
+  {line: 4, words: "He sleeps all night and he works all day"}
 ];
 
 _.chain(lyrics)
@@ -1679,7 +1756,7 @@ _.chain(lyrics)
   }, {})
   .value();
 
-=&gt; {lumberjack : 2, all : 4, night : 2 ... }</pre>
+=&gt; {lumberjack: 2, all: 4, night: 2 ... }</pre>
 
       <p>
         In addition, the
@@ -1696,7 +1773,7 @@ _.chain(lyrics)
         to return wrapped objects until <tt>value</tt> is used.
       </p>
       <pre>
-var stooges = [{name : 'curly', age : 25}, {name : 'moe', age : 21}, {name : 'larry', age : 23}];
+var stooges = [{name: 'curly', age: 25}, {name: 'moe', age: 21}, {name: 'larry', age: 23}];
 var youngest = _.chain(stooges)
   .sortBy(function(stooge){ return stooge.age; })
   .map(function(stooge){ return stooge.name + ' is ' + stooge.age; })
@@ -1797,7 +1874,68 @@ _([1, 2, 3]).value();
       <h2 id="changelog">Change Log</h2>
 
       <p>
-        <b class="header">1.4.4</b> &mdash; <small><i>Jan. 30, 2013</i></small> &mdash; <a href="https://github.com/documentcloud/underscore/compare/1.4.3...1.4.4">Diff</a><br />
+        <b class="header">1.5.2</b> &mdash; <small><i>Sept. 7, 2013</i></small> &mdash; <a href="https://github.com/jashkenas/underscore/compare/1.5.1...1.5.2">Diff</a><br />
+        <ul>
+          <li>
+            Added an <tt>indexBy</tt> function, which fits in alongside its 
+            cousins, <tt>countBy</tt> and <tt>groupBy</tt>.
+          </li>
+          <li>
+            Added a <tt>sample</tt> function, for sampling random elements from
+            arrays.
+          </li>
+          <li>
+            Some optimizations relating to functions that can be implemented
+            in terms of <tt>_.keys</tt> (which includes, significantly, 
+            <tt>each</tt> on objects). Also for <tt>debounce</tt> in a tight loop.
+          </li>
+        </ul>
+      </p>
+
+      <p>
+        <b class="header">1.5.1</b> &mdash; <small><i>Jul. 8, 2013</i></small> &mdash; <a href="https://github.com/jashkenas/underscore/compare/1.5.0...1.5.1">Diff</a><br />
+        <ul>
+          <li>
+            Removed <tt>unzip</tt>, as it's simply the application of <tt>zip</tt>
+            to an array of arguments. Use <tt>_.zip.apply(_, list)</tt> to
+            transpose instead.
+          </li>
+        </ul>
+      </p>
+
+      <p>
+        <b class="header">1.5.0</b> &mdash; <small><i>Jul. 6, 2013</i></small> &mdash; <a href="https://github.com/jashkenas/underscore/compare/1.4.4...1.5.0">Diff</a><br />
+        <ul>
+          <li>
+            Added a new <tt>unzip</tt> function, as the inverse of <tt>_.zip</tt>.
+          </li>
+          <li>
+            The <tt>throttle</tt> function now takes an <tt>options</tt> argument,
+            allowing you to disable execution of the throttled function on either
+            the <b>leading</b> or <b>trailing</b> edge.
+          </li>
+          <li>
+            A source map is now supplied for easier debugging of the minified
+            production build of Underscore.
+          </li>
+          <li>
+            The <tt>defaults</tt> function now only overrides <tt>undefined</tt>
+            values, not <tt>null</tt> ones.
+          </li>
+          <li>
+            Removed the ability to call <tt>_.bindAll</tt> with no method name
+            arguments. It's pretty much always wiser to white-list the names of
+            the methods you'd like to bind.
+          </li>
+          <li>
+            Removed the ability to call <tt>_.after</tt> with an invocation count
+            of zero. The minimum number of calls is (naturally) now <tt>1</tt>.
+          </li>
+        </ul>
+      </p>
+
+      <p>
+        <b class="header">1.4.4</b> &mdash; <small><i>Jan. 30, 2013</i></small> &mdash; <a href="https://github.com/jashkenas/underscore/compare/1.4.3...1.4.4">Diff</a><br />
         <ul>
           <li>
             Added <tt>_.findWhere</tt>, for finding the first element in a list
@@ -1823,7 +1961,7 @@ _([1, 2, 3]).value();
       </p>
 
       <p>
-        <b class="header">1.4.3</b> &mdash; <small><i>Dec. 4, 2012</i></small> &mdash; <a href="https://github.com/documentcloud/underscore/compare/1.4.2...1.4.3">Diff</a><br />
+        <b class="header">1.4.3</b> &mdash; <small><i>Dec. 4, 2012</i></small> &mdash; <a href="https://github.com/jashkenas/underscore/compare/1.4.2...1.4.3">Diff</a><br />
         <ul>
           <li>
             Improved Underscore compatibility with Adobe's JS engine that can be
@@ -1848,7 +1986,7 @@ _([1, 2, 3]).value();
       </p>
 
       <p>
-        <b class="header">1.4.2</b> &mdash; <small><i>Oct. 1, 2012</i></small> &mdash; <a href="https://github.com/documentcloud/underscore/compare/1.4.1...1.4.2">Diff</a><br />
+        <b class="header">1.4.2</b> &mdash; <small><i>Oct. 1, 2012</i></small> &mdash; <a href="https://github.com/jashkenas/underscore/compare/1.4.1...1.4.2">Diff</a><br />
         <ul>
           <li>
             For backwards compatibility, returned to pre-1.4.0 behavior when
@@ -1859,7 +1997,7 @@ _([1, 2, 3]).value();
       </p>
 
       <p>
-        <b class="header">1.4.1</b> &mdash; <small><i>Oct. 1, 2012</i></small> &mdash; <a href="https://github.com/documentcloud/underscore/compare/1.4.0...1.4.1">Diff</a><br />
+        <b class="header">1.4.1</b> &mdash; <small><i>Oct. 1, 2012</i></small> &mdash; <a href="https://github.com/jashkenas/underscore/compare/1.4.0...1.4.1">Diff</a><br />
         <ul>
           <li>
             Fixed a 1.4.0 regression in the <tt>lastIndexOf</tt> function.
@@ -1868,7 +2006,7 @@ _([1, 2, 3]).value();
       </p>
 
       <p>
-        <b class="header">1.4.0</b> &mdash; <small><i>Sept. 27, 2012</i></small>  &mdash; <a href="https://github.com/documentcloud/underscore/compare/1.3.3...1.4.0">Diff</a><br />
+        <b class="header">1.4.0</b> &mdash; <small><i>Sept. 27, 2012</i></small>  &mdash; <a href="https://github.com/jashkenas/underscore/compare/1.3.3...1.4.0">Diff</a><br />
         <ul>
           <li>
             Added a <tt>pairs</tt> function, for turning a JavaScript object
@@ -1925,7 +2063,7 @@ _([1, 2, 3]).value();
           </li>
           <li>
             A number of edge-cases fixes and tweaks, which you can spot in the
-            <a href="https://github.com/documentcloud/underscore/compare/1.3.3...1.4.0">diff</a>.
+            <a href="https://github.com/jashkenas/underscore/compare/1.3.3...1.4.0">diff</a>.
             Depending on how you're using Underscore, <b>1.4.0</b> may be more
             backwards-incompatible than usual &mdash; please test when you upgrade.
           </li>
diff --git a/profiles/commons/libraries/underscore/package.json b/profiles/commons/libraries/underscore/package.json
index e49148e..baf11b2 100644
--- a/profiles/commons/libraries/underscore/package.json
+++ b/profiles/commons/libraries/underscore/package.json
@@ -4,13 +4,20 @@
   "homepage"      : "http://underscorejs.org",
   "keywords"      : ["util", "functional", "server", "client", "browser"],
   "author"        : "Jeremy Ashkenas <jeremy@documentcloud.org>",
-  "repository"    : {"type": "git", "url": "git://github.com/documentcloud/underscore.git"},
+  "repository"    : {"type": "git", "url": "git://github.com/jashkenas/underscore.git"},
   "main"          : "underscore.js",
-  "version"       : "1.4.4",
+  "version"       : "1.5.2",
   "devDependencies": {
-    "phantomjs": "0.2.2"
+    "phantomjs": "1.9.0-1"
   },
   "scripts": {
     "test": "phantomjs test/vendor/runner.js test/index.html?noglobals=true"
-  }
+  },
+  "licenses": [
+    {
+      "type": "MIT",
+      "url": "https://raw.github.com/jashkenas/underscore/master/LICENSE"
+    }
+  ],
+  "files"         : ["underscore.js", "underscore-min.js", "LICENSE"]
 }
diff --git a/profiles/commons/libraries/underscore/test/arrays.js b/profiles/commons/libraries/underscore/test/arrays.js
index 9b7bb0d..f9ed132 100644
--- a/profiles/commons/libraries/underscore/test/arrays.js
+++ b/profiles/commons/libraries/underscore/test/arrays.js
@@ -65,6 +65,8 @@ $(document).ready(function() {
     deepEqual(_.flatten(list, true), [1,2,3,[[[4]]]], 'can shallowly flatten nested arrays');
     var result = (function(){ return _.flatten(arguments); })(1, [2], [3, [[[4]]]]);
     deepEqual(result, [1,2,3,4], 'works on an arguments object');
+    list = [[1], [2], [3], [[4]]];
+    deepEqual(_.flatten(list, true), [1, 2, 3, [4]], 'can shallowly flatten arrays containing only other arrays');
   });
 
   test("without", function() {
@@ -73,7 +75,7 @@ $(document).ready(function() {
     var result = (function(){ return _.without(arguments, 0, 1); })(1, 2, 1, 0, 3, 1, 4);
     equal(result.join(', '), '2, 3, 4', 'works on an arguments object');
 
-    var list = [{one : 1}, {two : 2}];
+    list = [{one : 1}, {two : 2}];
     ok(_.without(list, {one : 1}).length == 2, 'uses real object identity for comparisons.');
     ok(_.without(list, list[0]).length == 1, 'ditto.');
   });
@@ -82,17 +84,17 @@ $(document).ready(function() {
     var list = [1, 2, 1, 3, 1, 4];
     equal(_.uniq(list).join(', '), '1, 2, 3, 4', 'can find the unique values of an unsorted array');
 
-    var list = [1, 1, 1, 2, 2, 3];
+    list = [1, 1, 1, 2, 2, 3];
     equal(_.uniq(list, true).join(', '), '1, 2, 3', 'can find the unique values of a sorted array faster');
 
-    var list = [{name:'moe'}, {name:'curly'}, {name:'larry'}, {name:'curly'}];
+    list = [{name:'moe'}, {name:'curly'}, {name:'larry'}, {name:'curly'}];
     var iterator = function(value) { return value.name; };
     equal(_.map(_.uniq(list, false, iterator), iterator).join(', '), 'moe, curly, larry', 'can find the unique values of an array using a custom iterator');
 
     equal(_.map(_.uniq(list, iterator), iterator).join(', '), 'moe, curly, larry', 'can find the unique values of an array using a custom iterator without specifying whether array is sorted');
 
-    var iterator = function(value) { return value +1; };
-    var list = [1, 2, 2, 3, 4, 4];
+    iterator = function(value) { return value +1; };
+    list = [1, 2, 2, 3, 4, 4];
     equal(_.uniq(list, true, iterator).join(', '), '1, 2, 3, 4', 'iterator works with sorted array');
 
     var result = (function(){ return _.uniq(arguments); })(1, 2, 1, 3, 1, 4);
@@ -105,21 +107,31 @@ $(document).ready(function() {
     equal(_(stooges).intersection(leaders).join(''), 'moe', 'can perform an OO-style intersection');
     var result = (function(){ return _.intersection(arguments, leaders); })('moe', 'curly', 'larry');
     equal(result.join(''), 'moe', 'works on an arguments object');
+    var theSixStooges = ['moe', 'moe', 'curly', 'curly', 'larry', 'larry'];
+    equal(_.intersection(theSixStooges, leaders).join(''), 'moe', 'returns a duplicate-free array');
   });
 
   test("union", function() {
     var result = _.union([1, 2, 3], [2, 30, 1], [1, 40]);
     equal(result.join(' '), '1 2 3 30 40', 'takes the union of a list of arrays');
 
-    var result = _.union([1, 2, 3], [2, 30, 1], [1, 40, [1]]);
+    result = _.union([1, 2, 3], [2, 30, 1], [1, 40, [1]]);
     equal(result.join(' '), '1 2 3 30 40 1', 'takes the union of a list of nested arrays');
+
+    var args = null;
+    (function(){ args = arguments; })(1, 2, 3);
+    result = _.union(args, [2, 30, 1], [1, 40]);
+    equal(result.join(' '), '1 2 3 30 40', 'takes the union of a list of arrays');
+
+    result = _.union(null, [1, 2, 3]);
+    deepEqual(result, [null, 1, 2, 3]);
   });
 
   test("difference", function() {
     var result = _.difference([1, 2, 3], [2, 30, 40]);
     equal(result.join(' '), '1 3', 'takes the difference of two arrays');
 
-    var result = _.difference([1, 2, 3, 4], [2, 30, 40], [1, 11, 111]);
+    result = _.difference([1, 2, 3, 4], [2, 30, 40], [1, 11, 111]);
     equal(result.join(' '), '3 4', 'takes the difference of three arrays');
   });
 
@@ -127,6 +139,17 @@ $(document).ready(function() {
     var names = ['moe', 'larry', 'curly'], ages = [30, 40, 50], leaders = [true];
     var stooges = _.zip(names, ages, leaders);
     equal(String(stooges), 'moe,30,true,larry,40,,curly,50,', 'zipped together arrays of different lengths');
+
+    stooges = _.zip(['moe',30, 'stooge 1'],['larry',40, 'stooge 2'],['curly',50, 'stooge 3']);
+    deepEqual(stooges, [['moe','larry','curly'],[30,40,50], ['stooge 1', 'stooge 2', 'stooge 3']], 'zipped pairs');
+
+    // In the case of difference lengths of the tuples undefineds
+    // should be used as placeholder
+    stooges = _.zip(['moe',30],['larry',40],['curly',50, 'extra data']);
+    deepEqual(stooges, [['moe','larry','curly'],[30,40,50], [undefined, undefined, 'extra data']], 'zipped pairs with empties');
+
+    var empty = _.zip([]);
+    deepEqual(empty, [], 'unzipped empty');
   });
 
   test('object', function() {
@@ -152,7 +175,8 @@ $(document).ready(function() {
     equal(result, 1, 'works on an arguments object');
     equal(_.indexOf(null, 2), -1, 'handles nulls properly');
 
-    var numbers = [10, 20, 30, 40, 50], num = 35;
+    var num = 35;
+    numbers = [10, 20, 30, 40, 50];
     var index = _.indexOf(numbers, num, true);
     equal(index, -1, '35 is not in the list');
 
@@ -179,7 +203,7 @@ $(document).ready(function() {
     equal(_.lastIndexOf(numbers, 0), 8, 'lastIndexOf the other element');
     var result = (function(){ return _.lastIndexOf(arguments, 1); })(1, 0, 1, 0, 0, 1, 0, 0, 0);
     equal(result, 5, 'works on an arguments object');
-    equal(_.indexOf(null, 2), -1, 'handles nulls properly');
+    equal(_.lastIndexOf(null, 2), -1, 'handles nulls properly');
 
     numbers = [1, 2, 3, 1, 2, 3, 1, 2, 3];
     var index = _.lastIndexOf(numbers, 2, 2);
diff --git a/profiles/commons/libraries/underscore/test/chaining.js b/profiles/commons/libraries/underscore/test/chaining.js
index 16cf7bf..6eeef0f 100644
--- a/profiles/commons/libraries/underscore/test/chaining.js
+++ b/profiles/commons/libraries/underscore/test/chaining.js
@@ -17,15 +17,15 @@ $(document).ready(function() {
         hash[l]++;
         return hash;
     }, {}).value();
-    ok(counts['a'] == 16 && counts['e'] == 10, 'counted all the letters in the song');
+    ok(counts.a == 16 && counts.e == 10, 'counted all the letters in the song');
   });
 
   test("select/reject/sortBy", function() {
     var numbers = [1,2,3,4,5,6,7,8,9,10];
     numbers = _(numbers).chain().select(function(n) {
-      return n % 2 == 0;
+      return n % 2 === 0;
     }).reject(function(n) {
-      return n % 4 == 0;
+      return n % 4 === 0;
     }).sortBy(function(n) {
       return -n;
     }).value();
@@ -35,9 +35,9 @@ $(document).ready(function() {
   test("select/reject/sortBy in functional style", function() {
     var numbers = [1,2,3,4,5,6,7,8,9,10];
     numbers = _.chain(numbers).select(function(n) {
-      return n % 2 == 0;
+      return n % 2 === 0;
     }).reject(function(n) {
-      return n % 4 == 0;
+      return n % 4 === 0;
     }).sortBy(function(n) {
       return -n;
     }).value();
@@ -56,4 +56,10 @@ $(document).ready(function() {
     equal(numbers.join(', '), "34, 10, 8, 6, 4, 2, 10, 10", 'can chain together array functions.');
   });
 
+  test("chaining works in small stages", function() {
+    var o = _([1, 2, 3, 4]).chain();
+    deepEqual(o.filter(function(i) { return i < 3; }).value(), [1, 2]);
+    deepEqual(o.filter(function(i) { return i > 2; }).value(), [3, 4]);
+  });
+
 });
diff --git a/profiles/commons/libraries/underscore/test/collections.js b/profiles/commons/libraries/underscore/test/collections.js
index 68a5c17..82176ad 100644
--- a/profiles/commons/libraries/underscore/test/collections.js
+++ b/profiles/commons/libraries/underscore/test/collections.js
@@ -76,13 +76,16 @@ $(document).ready(function() {
     var sum = _.reduce([1, 2, 3], function(sum, num){ return sum + num; });
     equal(sum, 6, 'default initial value');
 
+    var prod = _.reduce([1, 2, 3, 4], function(prod, num){ return prod * num; });
+    equal(prod, 24, 'can reduce via multiplication');
+
     var ifnull;
     try {
       _.reduce(null, function(){});
     } catch (ex) {
       ifnull = ex;
     }
-    ok(ifnull instanceof TypeError, 'handles a null (without inital value) properly');
+    ok(ifnull instanceof TypeError, 'handles a null (without initial value) properly');
 
     ok(_.reduce(null, function(){}, 138) === 138, 'handles a null (with initial value) properly');
     equal(_.reduce([], function(){}, undefined), undefined, 'undefined can be passed as a special case');
@@ -105,7 +108,7 @@ $(document).ready(function() {
     } catch (ex) {
       ifnull = ex;
     }
-    ok(ifnull instanceof TypeError, 'handles a null (without inital value) properly');
+    ok(ifnull instanceof TypeError, 'handles a null (without initial value) properly');
 
     var sum = _.reduceRight({a: 1, b: 2, c: 3}, function(sum, num){ return sum + num; });
     equal(sum, 6, 'default initial value on object');
@@ -258,6 +261,11 @@ $(document).ready(function() {
     result = _.where(list, {b: 2});
     equal(result.length, 2);
     equal(result[0].a, 1);
+
+    result = _.where(list, {a: 1}, true);
+    equal(result.b, 2, "Only get the first object matched.")
+    result = _.where(list, {a: 1}, false);
+    equal(result.length, 3);
   });
 
   test('findWhere', function() {
@@ -266,6 +274,12 @@ $(document).ready(function() {
     deepEqual(result, {a: 1, b: 2});
     result = _.findWhere(list, {b: 4});
     deepEqual(result, {a: 1, b: 4});
+
+    result = _.findWhere(list, {c:1})
+    ok(_.isUndefined(result), "undefined when not found");
+
+    result = _.findWhere([], {c:1});
+    ok(_.isUndefined(result), "undefined when searching empty list");
   });
 
   test('max', function() {
@@ -361,6 +375,32 @@ $(document).ready(function() {
     var grouped = _.groupBy(array);
     equal(grouped['1'].length, 2);
     equal(grouped['3'].length, 1);
+
+    var matrix = [
+      [1,2],
+      [1,3],
+      [2,3]
+    ];
+    deepEqual(_.groupBy(matrix, 0), {1: [[1,2], [1,3]], 2: [[2,3]]})
+    deepEqual(_.groupBy(matrix, 1), {2: [[1,2]], 3: [[1,3], [2,3]]})
+  });
+
+  test('indexBy', function() {
+    var parity = _.indexBy([1, 2, 3, 4, 5], function(num){ return num % 2 == 0; });
+    equal(parity['true'], 4);
+    equal(parity['false'], 5);
+
+    var list = ["one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten"];
+    var grouped = _.indexBy(list, 'length');
+    equal(grouped['3'], 'ten');
+    equal(grouped['4'], 'nine');
+    equal(grouped['5'], 'eight');
+
+    var array = [1, 2, 1, 2, 3];
+    var grouped = _.indexBy(array);
+    equal(grouped['1'], 1);
+    equal(grouped['2'], 2);
+    equal(grouped['3'], 3);
   });
 
   test('countBy', function() {
@@ -417,6 +457,19 @@ $(document).ready(function() {
     equal(shuffled.join(','), numbers.join(','), 'contains the same members before and after shuffle');
   });
 
+  test('sample', function() {
+    var numbers = _.range(10);
+    var all_sampled = _.sample(numbers, 10).sort();
+    equal(all_sampled.join(','), numbers.join(','), 'contains the same members before and after sample');
+    all_sampled = _.sample(numbers, 20).sort();
+    equal(all_sampled.join(','), numbers.join(','), 'also works when sampling more objects than are present');
+    ok(_.contains(numbers, _.sample(numbers)), 'sampling a single element returns something from the array');
+    strictEqual(_.sample([]), undefined, 'sampling empty array with no number returns undefined');
+    notStrictEqual(_.sample([], 5), [], 'sampling empty array with a number returns an empty array');
+    notStrictEqual(_.sample([1, 2, 3], 0), [], 'sampling an array with 0 picks returns an empty array');
+    deepEqual(_.sample([1, 2], -1), [], 'sampling a negative number of picks returns an empty array');
+  });
+
   test('toArray', function() {
     ok(!_.isArray(arguments), 'arguments object is not an array');
     ok(_.isArray(_.toArray(arguments)), 'arguments object converted into array');
@@ -438,6 +491,7 @@ $(document).ready(function() {
   test('size', function() {
     equal(_.size({one : 1, two : 2, three : 3}), 3, 'can compute the size of an object');
     equal(_.size([1, 2, 3]), 3, 'can compute the size of an array');
+    equal(_.size($('<div>').add('<span>').add('<span>')), 3, 'can compute the size of jQuery objects');
 
     var func = function() {
       return _.size(arguments);
@@ -445,7 +499,8 @@ $(document).ready(function() {
 
     equal(func(1, 2, 3, 4), 4, 'can test the size of the arguments object');
 
-    equal(_.size('hello'), 5, 'can compute the size of a string');
+    equal(_.size('hello'), 5, 'can compute the size of a string literal');
+    equal(_.size(new String('hello')), 5, 'can compute the size of string object');
 
     equal(_.size(null), 0, 'handles nulls');
   });
diff --git a/profiles/commons/libraries/underscore/test/functions.js b/profiles/commons/libraries/underscore/test/functions.js
index efa9934..7a773f3 100644
--- a/profiles/commons/libraries/underscore/test/functions.js
+++ b/profiles/commons/libraries/underscore/test/functions.js
@@ -34,7 +34,10 @@ $(document).ready(function() {
     // To test this with a modern browser, set underscore's nativeBind to undefined
     var F = function () { return this; };
     var Boundf = _.bind(F, {hello: "moe curly"});
+    var newBoundf = new Boundf();
+    equal(newBoundf.hello, undefined, "function should not be bound to the context, to comply with ECMAScript 5");
     equal(Boundf().hello, "moe curly", "When called without the new operator, it's OK to be bound to the context");
+    ok(newBoundf instanceof F, "a bound instance is an instance of the original function");
   });
 
   test("partial", function() {
@@ -63,18 +66,21 @@ $(document).ready(function() {
       getName : function() { return 'name: ' + this.name; },
       sayHi   : function() { return 'hi: ' + this.name; }
     };
-    _.bindAll(moe);
+
+    raises(function() { _.bindAll(moe); }, Error, 'throws an error for bindAll with no functions named');
+
+    _.bindAll(moe, 'sayHi');
     curly.sayHi = moe.sayHi;
-    equal(curly.sayHi(), 'hi: moe', 'calling bindAll with no arguments binds all functions to the object');
+    equal(curly.sayHi(), 'hi: moe');
   });
 
   test("memoize", function() {
     var fib = function(n) {
       return n < 2 ? n : fib(n - 1) + fib(n - 2);
     };
-    var fastFib = _.memoize(fib);
     equal(fib(10), 55, 'a memoized version of fibonacci produces identical results');
-    equal(fastFib(10), 55, 'a memoized version of fibonacci produces identical results');
+    fib = _.memoize(fib); // Redefine `fib` for memoization
+    equal(fib(10), 55, 'a memoized version of fibonacci produces identical results');
 
     var o = function(str) {
       return str;
@@ -136,17 +142,31 @@ $(document).ready(function() {
     _.delay(function(){ equal(counter, 2, "incr was called twice"); start(); }, 64);
   });
 
+  asyncTest("more throttling", 3, function() {
+    var counter = 0;
+    var incr = function(){ counter++; };
+    var throttledIncr = _.throttle(incr, 30);
+    throttledIncr(); throttledIncr();
+    ok(counter == 1);
+    _.delay(function(){
+      ok(counter == 2);
+      throttledIncr();
+      ok(counter == 3);
+      start();
+    }, 85);
+  });
+
   asyncTest("throttle repeatedly with results", 6, function() {
     var counter = 0;
     var incr = function(){ return ++counter; };
-    var throttledIncr = _.throttle(incr, 64);
+    var throttledIncr = _.throttle(incr, 100);
     var results = [];
     var saveResult = function() { results.push(throttledIncr()); };
     saveResult(); saveResult();
-    _.delay(saveResult, 32);
-    _.delay(saveResult, 80);
-    _.delay(saveResult, 96);
-    _.delay(saveResult, 144);
+    _.delay(saveResult, 50);
+    _.delay(saveResult, 150);
+    _.delay(saveResult, 160);
+    _.delay(saveResult, 230);
     _.delay(function() {
       equal(results[0], 1, "incr was called once");
       equal(results[1], 1, "incr was throttled");
@@ -155,7 +175,7 @@ $(document).ready(function() {
       equal(results[4], 2, "incr was throttled");
       equal(results[5], 3, "incr was called trailing");
       start();
-    }, 192);
+    }, 300);
   });
 
   asyncTest("throttle triggers trailing call when invoked repeatedly", 2, function() {
@@ -177,6 +197,77 @@ $(document).ready(function() {
     }, 96);
   });
 
+  asyncTest("throttle does not trigger leading call when leading is set to false", 2, function() {
+    var counter = 0;
+    var incr = function(){ counter++; };
+    var throttledIncr = _.throttle(incr, 60, {leading: false});
+
+    throttledIncr(); throttledIncr();
+    ok(counter === 0);
+
+    _.delay(function() {
+      ok(counter == 1);
+      start();
+    }, 96);
+  });
+
+  asyncTest("more throttle does not trigger leading call when leading is set to false", 3, function() {
+    var counter = 0;
+    var incr = function(){ counter++; };
+    var throttledIncr = _.throttle(incr, 100, {leading: false});
+
+    throttledIncr();
+    _.delay(throttledIncr, 50);
+    _.delay(throttledIncr, 60);
+    _.delay(throttledIncr, 200);
+    ok(counter === 0);
+
+    _.delay(function() {
+      ok(counter == 1);
+    }, 250);
+
+    _.delay(function() {
+      ok(counter == 2);
+      start();
+    }, 350);
+  });
+
+  asyncTest("one more throttle with leading: false test", 2, function() {
+    var counter = 0;
+    var incr = function(){ counter++; };
+    var throttledIncr = _.throttle(incr, 100, {leading: false});
+
+    var time = new Date;
+    while (new Date - time < 350) throttledIncr();
+    ok(counter <= 3);
+
+    _.delay(function() {
+      ok(counter <= 4);
+      start();
+    }, 200);
+  });
+
+  asyncTest("throttle does not trigger trailing call when trailing is set to false", 4, function() {
+    var counter = 0;
+    var incr = function(){ counter++; };
+    var throttledIncr = _.throttle(incr, 60, {trailing: false});
+
+    throttledIncr(); throttledIncr(); throttledIncr();
+    ok(counter === 1);
+
+    _.delay(function() {
+      ok(counter == 1);
+
+      throttledIncr(); throttledIncr();
+      ok(counter == 2);
+
+      _.delay(function() {
+        ok(counter == 2);
+        start();
+      }, 96);
+    }, 96);
+  });
+
   asyncTest("debounce", 1, function() {
     var counter = 0;
     var incr = function(){ counter++; };
@@ -221,10 +312,18 @@ $(document).ready(function() {
     equal(num, 1);
   });
 
+  test("Recursive onced function.", 1, function() {
+    var f = _.once(function(){
+      ok(true);
+      f();
+    });
+    f();
+  });
+
   test("wrap", function() {
     var greet = function(name){ return "hi: " + name; };
     var backwards = _.wrap(greet, function(func, name){ return func(name) + ' ' + name.split('').reverse().join(''); });
-    equal(backwards('moe'), 'hi: moe eom', 'wrapped the saluation function');
+    equal(backwards('moe'), 'hi: moe eom', 'wrapped the salutation function');
 
     var inner = function(){ return "Hello "; };
     var obj   = {name : "Moe"};
@@ -259,7 +358,8 @@ $(document).ready(function() {
 
     equal(testAfter(5, 5), 1, "after(N) should fire after being called N times");
     equal(testAfter(5, 4), 0, "after(N) should not fire unless called N times");
-    equal(testAfter(0, 0), 1, "after(0) should fire immediately");
+    equal(testAfter(0, 0), 0, "after(0) should not fire immediately");
+    equal(testAfter(0, 1), 1, "after(0) should fire when first invoked");
   });
 
 });
diff --git a/profiles/commons/libraries/underscore/test/objects.js b/profiles/commons/libraries/underscore/test/objects.js
index 73bdf6b..492171e 100644
--- a/profiles/commons/libraries/underscore/test/objects.js
+++ b/profiles/commons/libraries/underscore/test/objects.js
@@ -46,13 +46,13 @@ $(document).ready(function() {
     var result;
     equal(_.extend({}, {a:'b'}).a, 'b', 'can extend an object with the attributes of another');
     equal(_.extend({a:'x'}, {a:'b'}).a, 'b', 'properties in source override destination');
-    equal(_.extend({x:'x'}, {a:'b'}).x, 'x', 'properties not in source dont get overriden');
+    equal(_.extend({x:'x'}, {a:'b'}).x, 'x', "properties not in source don't get overriden");
     result = _.extend({x:'x'}, {a:'a'}, {b:'b'});
     ok(_.isEqual(result, {x:'x', a:'a', b:'b'}), 'can extend from multiple source objects');
     result = _.extend({x:'x'}, {a:'a', x:2}, {a:'b'});
     ok(_.isEqual(result, {x:2, a:'b'}), 'extending from multiple source objects last property trumps');
     result = _.extend({}, {a: void 0, b: null});
-    equal(_.keys(result).join(''), 'ab', 'extend does not copy undefined values');
+    equal(_.keys(result).join(''), 'ab', 'extend copies undefined values');
 
     try {
       result = {};
@@ -92,12 +92,13 @@ $(document).ready(function() {
 
   test("defaults", function() {
     var result;
-    var options = {zero: 0, one: 1, empty: "", nan: NaN, string: "string"};
+    var options = {zero: 0, one: 1, empty: "", nan: NaN, nothing: null};
 
-    _.defaults(options, {zero: 1, one: 10, twenty: 20});
+    _.defaults(options, {zero: 1, one: 10, twenty: 20, nothing: 'str'});
     equal(options.zero, 0, 'value exists');
     equal(options.one, 1, 'value exists');
     equal(options.twenty, 20, 'default applied');
+    equal(options.nothing, null, "null isn't overridden");
 
     _.defaults(options, {empty: "full"}, {nan: "nan"}, {word: "word"}, {word: "dog"});
     equal(options.empty, "", 'value exists');
@@ -431,15 +432,19 @@ $(document).ready(function() {
   });
 
   test("isArray", function() {
+    ok(!_.isArray(undefined), 'undefined vars are not arrays');
     ok(!_.isArray(arguments), 'the arguments object is not an array');
     ok(_.isArray([1, 2, 3]), 'but arrays are');
     ok(_.isArray(iArray), 'even from another frame');
   });
 
   test("isString", function() {
+    var obj = new String("I am a string object");
     ok(!_.isString(document.body), 'the document body is not a string');
     ok(_.isString([1, 2, 3].join(', ')), 'but strings are');
     ok(_.isString(iString), 'even from another frame');
+    ok(_.isString("I am a string literal"), 'string literals are');
+    ok(_.isString(obj), 'so are String objects');
   });
 
   test("isNumber", function() {
@@ -468,10 +473,12 @@ $(document).ready(function() {
   });
 
   test("isFunction", function() {
+    ok(!_.isFunction(undefined), 'undefined vars are not functions');
     ok(!_.isFunction([1, 2, 3]), 'arrays are not functions');
     ok(!_.isFunction('moe'), 'strings are not functions');
     ok(_.isFunction(_.isFunction), 'but functions are');
     ok(_.isFunction(iFunction), 'even from another frame');
+    ok(_.isFunction(function(){}), 'even anonymous ones');
   });
 
   test("isDate", function() {
diff --git a/profiles/commons/libraries/underscore/test/speed.js b/profiles/commons/libraries/underscore/test/speed.js
index 05e3f2a..90ede52 100644
--- a/profiles/commons/libraries/underscore/test/speed.js
+++ b/profiles/commons/libraries/underscore/test/speed.js
@@ -2,7 +2,9 @@
 
   var numbers = [];
   for (var i=0; i<1000; i++) numbers.push(i);
-  var objects = _.map(numbers, function(n){ return {num : n}; });
+  var objArray = _.map(numbers, function(n){ return {num : n}; });
+  var bigObj = {};
+  _.times(1000, function(n){ bigObj['key' + n] = n; });
   var randomized = _.sortBy(numbers, function(){ return Math.random(); });
   var deep = _.map(_.range(100), function() { return _.range(1000); });
 
@@ -25,15 +27,15 @@
   });
 
   JSLitmus.test('_.map()', function() {
-    return _.map(objects, function(obj){ return obj.num; });
+    return _.map(objArray, function(obj){ return obj.num; });
   });
 
   JSLitmus.test('jQuery.map()', function() {
-    return jQuery.map(objects, function(obj){ return obj.num; });
+    return jQuery.map(objArray, function(obj){ return obj.num; });
   });
 
   JSLitmus.test('_.pluck()', function() {
-    return _.pluck(objects, 'num');
+    return _.pluck(objArray, 'num');
   });
 
   JSLitmus.test('_.uniq()', function() {
@@ -53,11 +55,11 @@
   });
 
   JSLitmus.test('_.keys()', function() {
-    return _.keys(objects);
+    return _.keys(bigObj);
   });
 
   JSLitmus.test('_.values()', function() {
-    return _.values(objects);
+    return _.values(bigObj);
   });
 
   JSLitmus.test('_.intersection()', function() {
@@ -72,4 +74,7 @@
     return _.flatten(deep);
   });
 
+  JSLitmus.test('_.flatten() (shallow)', function() {
+    return _.flatten(deep, true);
+  });
 })();
diff --git a/profiles/commons/libraries/underscore/test/utility.js b/profiles/commons/libraries/underscore/test/utility.js
index 0bca8c8..52c5495 100644
--- a/profiles/commons/libraries/underscore/test/utility.js
+++ b/profiles/commons/libraries/underscore/test/utility.js
@@ -55,6 +55,10 @@ $(document).ready(function() {
     ok(_.isEqual(vals, [0,1,2]), "works as a wrapper");
     // collects return values
     ok(_.isEqual([0, 1, 2], _.times(3, function(i) { return i; })), "collects return values");
+
+    deepEqual(_.times(0, _.identity), []);
+    deepEqual(_.times(-1, _.identity), []);
+    deepEqual(_.times(parseFloat('-Infinity'), _.identity), []);
   });
 
   test("mixin", function() {
@@ -69,6 +73,7 @@ $(document).ready(function() {
 
   test("_.escape", function() {
     equal(_.escape("Curly & Moe"), "Curly &amp; Moe");
+    equal(_.escape('<a href="http://moe.com">Curly & Moe\'s</a>'), '&lt;a href=&quot;http://moe.com&quot;&gt;Curly &amp; Moe&#x27;s&lt;/a&gt;');
     equal(_.escape("Curly &amp; Moe"), "Curly &amp;amp; Moe");
     equal(_.escape(null), '');
   });
@@ -76,6 +81,7 @@ $(document).ready(function() {
   test("_.unescape", function() {
     var string = "Curly & Moe";
     equal(_.unescape("Curly &amp; Moe"), string);
+    equal(_.unescape('&lt;a href=&quot;http://moe.com&quot;&gt;Curly &amp; Moe&#x27;s&lt;/a&gt;'), '<a href="http://moe.com">Curly & Moe\'s</a>');
     equal(_.unescape("Curly &amp;amp; Moe"), "Curly &amp; Moe");
     equal(_.unescape(null), '');
     equal(_.unescape(_.escape(string)), string);
@@ -207,7 +213,7 @@ $(document).ready(function() {
     strictEqual(_.result(obj, 'x'), 'x');
     strictEqual(_.result(obj, 'y'), 'x');
     strictEqual(_.result(obj, 'z'), undefined);
-    strictEqual(_.result(null, 'x'), null);
+    strictEqual(_.result(null, 'x'), undefined);
   });
 
   test('_.templateSettings.variable', function() {
diff --git a/profiles/commons/libraries/underscore/test/vendor/qunit.css b/profiles/commons/libraries/underscore/test/vendor/qunit.css
index 55970e0..7ba3f9a 100644
--- a/profiles/commons/libraries/underscore/test/vendor/qunit.css
+++ b/profiles/commons/libraries/underscore/test/vendor/qunit.css
@@ -1,5 +1,5 @@
 /**
- * QUnit v1.10.0 - A JavaScript Unit Testing Framework
+ * QUnit v1.12.0 - A JavaScript Unit Testing Framework
  *
  * http://qunitjs.com
  *
@@ -20,7 +20,7 @@
 
 /** Resets */
 
-#qunit-tests, #qunit-tests ol, #qunit-header, #qunit-banner, #qunit-userAgent, #qunit-testresult, #qunit-modulefilter {
+#qunit-tests, #qunit-header, #qunit-banner, #qunit-userAgent, #qunit-testresult, #qunit-modulefilter {
 	margin: 0;
 	padding: 0;
 }
@@ -111,7 +111,12 @@
 	color: #000;
 }
 
-#qunit-tests ol {
+#qunit-tests li .runtime {
+	float: right;
+	font-size: smaller;
+}
+
+.qunit-assert-list {
 	margin-top: 0.5em;
 	padding: 0.5em;
 
@@ -122,6 +127,10 @@
 	-webkit-border-radius: 5px;
 }
 
+.qunit-collapsed {
+	display: none;
+}
+
 #qunit-tests table {
 	border-collapse: collapse;
 	margin-top: .2em;
diff --git a/profiles/commons/libraries/underscore/test/vendor/qunit.js b/profiles/commons/libraries/underscore/test/vendor/qunit.js
index d4f17b5..84c7390 100644
--- a/profiles/commons/libraries/underscore/test/vendor/qunit.js
+++ b/profiles/commons/libraries/underscore/test/vendor/qunit.js
@@ -1,16 +1,17 @@
 /**
- * QUnit v1.10.0 - A JavaScript Unit Testing Framework
+ * QUnit v1.12.0 - A JavaScript Unit Testing Framework
  *
  * http://qunitjs.com
  *
- * Copyright 2012 jQuery Foundation and other contributors
+ * Copyright 2013 jQuery Foundation and other contributors
  * Released under the MIT license.
- * http://jquery.org/license
+ * https://jquery.org/license/
  */
 
 (function( window ) {
 
 var QUnit,
+	assert,
 	config,
 	onErrorFnPrev,
 	testId = 0,
@@ -19,19 +20,69 @@ var QUnit,
 	hasOwn = Object.prototype.hasOwnProperty,
 	// Keep a local reference to Date (GH-283)
 	Date = window.Date,
+	setTimeout = window.setTimeout,
 	defined = {
-	setTimeout: typeof window.setTimeout !== "undefined",
-	sessionStorage: (function() {
-		var x = "qunit-test-string";
-		try {
-			sessionStorage.setItem( x, x );
-			sessionStorage.removeItem( x );
-			return true;
-		} catch( e ) {
-			return false;
+		setTimeout: typeof window.setTimeout !== "undefined",
+		sessionStorage: (function() {
+			var x = "qunit-test-string";
+			try {
+				sessionStorage.setItem( x, x );
+				sessionStorage.removeItem( x );
+				return true;
+			} catch( e ) {
+				return false;
+			}
+		}())
+	},
+	/**
+	 * Provides a normalized error string, correcting an issue
+	 * with IE 7 (and prior) where Error.prototype.toString is
+	 * not properly implemented
+	 *
+	 * Based on http://es5.github.com/#x15.11.4.4
+	 *
+	 * @param {String|Error} error
+	 * @return {String} error message
+	 */
+	errorString = function( error ) {
+		var name, message,
+			errorString = error.toString();
+		if ( errorString.substring( 0, 7 ) === "[object" ) {
+			name = error.name ? error.name.toString() : "Error";
+			message = error.message ? error.message.toString() : "";
+			if ( name && message ) {
+				return name + ": " + message;
+			} else if ( name ) {
+				return name;
+			} else if ( message ) {
+				return message;
+			} else {
+				return "Error";
+			}
+		} else {
+			return errorString;
 		}
-	}())
-};
+	},
+	/**
+	 * Makes a clone of an object using only Array or Object as base,
+	 * and copies over the own enumerable properties.
+	 *
+	 * @param {Object} obj
+	 * @return {Object} New object with only the own properties (recursively).
+	 */
+	objectValues = function( obj ) {
+		// Grunt 0.3.x uses an older version of jshint that still has jshint/jshint#392.
+		/*jshint newcap: false */
+		var key, val,
+			vals = QUnit.is( "array", obj ) ? [] : {};
+		for ( key in obj ) {
+			if ( hasOwn.call( obj, key ) ) {
+				val = obj[key];
+				vals[key] = val === Object(val) ? objectValues(val) : val;
+			}
+		}
+		return vals;
+	};
 
 function Test( settings ) {
 	extend( this, settings );
@@ -44,11 +95,11 @@ Test.count = 0;
 Test.prototype = {
 	init: function() {
 		var a, b, li,
-        tests = id( "qunit-tests" );
+			tests = id( "qunit-tests" );
 
 		if ( tests ) {
 			b = document.createElement( "strong" );
-			b.innerHTML = this.name;
+			b.innerHTML = this.nameHtml;
 
 			// `a` initialized at top of scope
 			a = document.createElement( "a" );
@@ -65,8 +116,16 @@ Test.prototype = {
 		}
 	},
 	setup: function() {
-		if ( this.module !== config.previousModule ) {
-			if ( config.previousModule ) {
+		if (
+			// Emit moduleStart when we're switching from one module to another
+			this.module !== config.previousModule ||
+				// They could be equal (both undefined) but if the previousModule property doesn't
+				// yet exist it means this is the first test in a suite that isn't wrapped in a
+				// module, in which case we'll just emit a moduleStart event for 'undefined'.
+				// Without this, reporters can get testStart before moduleStart  which is a problem.
+				!hasOwn.call( config, "previousModule" )
+		) {
+			if ( hasOwn.call( config, "previousModule" ) ) {
 				runLoggingCallbacks( "moduleDone", QUnit, {
 					name: config.previousModule,
 					failed: config.moduleStats.bad,
@@ -79,10 +138,6 @@ Test.prototype = {
 			runLoggingCallbacks( "moduleStart", QUnit, {
 				name: this.module
 			});
-		} else if ( config.autorun ) {
-			runLoggingCallbacks( "moduleStart", QUnit, {
-				name: this.module
-			});
 		}
 
 		config.current = this;
@@ -92,26 +147,35 @@ Test.prototype = {
 			teardown: function() {}
 		}, this.moduleTestEnvironment );
 
+		this.started = +new Date();
 		runLoggingCallbacks( "testStart", QUnit, {
 			name: this.testName,
 			module: this.module
 		});
 
-		// allow utility functions to access the current test environment
-		// TODO why??
+		/*jshint camelcase:false */
+
+
+		/**
+		 * Expose the current test environment.
+		 *
+		 * @deprecated since 1.12.0: Use QUnit.config.current.testEnvironment instead.
+		 */
 		QUnit.current_testEnvironment = this.testEnvironment;
 
+		/*jshint camelcase:true */
+
 		if ( !config.pollution ) {
 			saveGlobal();
 		}
 		if ( config.notrycatch ) {
-			this.testEnvironment.setup.call( this.testEnvironment );
+			this.testEnvironment.setup.call( this.testEnvironment, QUnit.assert );
 			return;
 		}
 		try {
-			this.testEnvironment.setup.call( this.testEnvironment );
+			this.testEnvironment.setup.call( this.testEnvironment, QUnit.assert );
 		} catch( e ) {
-			QUnit.pushFailure( "Setup failed on " + this.testName + ": " + e.message, extractStacktrace( e, 1 ) );
+			QUnit.pushFailure( "Setup failed on " + this.testName + ": " + ( e.message || e ), extractStacktrace( e, 1 ) );
 		}
 	},
 	run: function() {
@@ -120,22 +184,28 @@ Test.prototype = {
 		var running = id( "qunit-testresult" );
 
 		if ( running ) {
-			running.innerHTML = "Running: <br/>" + this.name;
+			running.innerHTML = "Running: <br/>" + this.nameHtml;
 		}
 
 		if ( this.async ) {
 			QUnit.stop();
 		}
 
+		this.callbackStarted = +new Date();
+
 		if ( config.notrycatch ) {
 			this.callback.call( this.testEnvironment, QUnit.assert );
+			this.callbackRuntime = +new Date() - this.callbackStarted;
 			return;
 		}
 
 		try {
 			this.callback.call( this.testEnvironment, QUnit.assert );
+			this.callbackRuntime = +new Date() - this.callbackStarted;
 		} catch( e ) {
-			QUnit.pushFailure( "Died on test #" + (this.assertions.length + 1) + " " + this.stack + ": " + e.message, extractStacktrace( e, 0 ) );
+			this.callbackRuntime = +new Date() - this.callbackStarted;
+
+			QUnit.pushFailure( "Died on test #" + (this.assertions.length + 1) + " " + this.stack + ": " + ( e.message || e ), extractStacktrace( e, 0 ) );
 			// else next test will carry the responsibility
 			saveGlobal();
 
@@ -148,38 +218,43 @@ Test.prototype = {
 	teardown: function() {
 		config.current = this;
 		if ( config.notrycatch ) {
-			this.testEnvironment.teardown.call( this.testEnvironment );
+			if ( typeof this.callbackRuntime === "undefined" ) {
+				this.callbackRuntime = +new Date() - this.callbackStarted;
+			}
+			this.testEnvironment.teardown.call( this.testEnvironment, QUnit.assert );
 			return;
 		} else {
 			try {
-				this.testEnvironment.teardown.call( this.testEnvironment );
+				this.testEnvironment.teardown.call( this.testEnvironment, QUnit.assert );
 			} catch( e ) {
-				QUnit.pushFailure( "Teardown failed on " + this.testName + ": " + e.message, extractStacktrace( e, 1 ) );
+				QUnit.pushFailure( "Teardown failed on " + this.testName + ": " + ( e.message || e ), extractStacktrace( e, 1 ) );
 			}
 		}
 		checkPollution();
 	},
 	finish: function() {
 		config.current = this;
-		if ( config.requireExpects && this.expected == null ) {
+		if ( config.requireExpects && this.expected === null ) {
 			QUnit.pushFailure( "Expected number of assertions to be defined, but expect() was not called.", this.stack );
-		} else if ( this.expected != null && this.expected != this.assertions.length ) {
+		} else if ( this.expected !== null && this.expected !== this.assertions.length ) {
 			QUnit.pushFailure( "Expected " + this.expected + " assertions, but " + this.assertions.length + " were run", this.stack );
-		} else if ( this.expected == null && !this.assertions.length ) {
+		} else if ( this.expected === null && !this.assertions.length ) {
 			QUnit.pushFailure( "Expected at least one assertion, but none were run - call expect(0) to accept zero assertions.", this.stack );
 		}
 
-		var assertion, a, b, i, li, ol,
+		var i, assertion, a, b, time, li, ol,
 			test = this,
 			good = 0,
 			bad = 0,
 			tests = id( "qunit-tests" );
 
+		this.runtime = +new Date() - this.started;
 		config.stats.all += this.assertions.length;
 		config.moduleStats.all += this.assertions.length;
 
 		if ( tests ) {
 			ol = document.createElement( "ol" );
+			ol.className = "qunit-assert-list";
 
 			for ( i = 0; i < this.assertions.length; i++ ) {
 				assertion = this.assertions[i];
@@ -208,22 +283,22 @@ Test.prototype = {
 			}
 
 			if ( bad === 0 ) {
-				ol.style.display = "none";
+				addClass( ol, "qunit-collapsed" );
 			}
 
 			// `b` initialized at top of scope
 			b = document.createElement( "strong" );
-			b.innerHTML = this.name + " <b class='counts'>(<b class='failed'>" + bad + "</b>, <b class='passed'>" + good + "</b>, " + this.assertions.length + ")</b>";
+			b.innerHTML = this.nameHtml + " <b class='counts'>(<b class='failed'>" + bad + "</b>, <b class='passed'>" + good + "</b>, " + this.assertions.length + ")</b>";
 
 			addEvent(b, "click", function() {
-				var next = b.nextSibling.nextSibling,
-					display = next.style.display;
-				next.style.display = display === "none" ? "block" : "none";
+				var next = b.parentNode.lastChild,
+					collapsed = hasClass( next, "qunit-collapsed" );
+				( collapsed ? removeClass : addClass )( next, "qunit-collapsed" );
 			});
 
 			addEvent(b, "dblclick", function( e ) {
 				var target = e && e.target ? e.target : window.event.srcElement;
-				if ( target.nodeName.toLowerCase() == "span" || target.nodeName.toLowerCase() == "b" ) {
+				if ( target.nodeName.toLowerCase() === "span" || target.nodeName.toLowerCase() === "b" ) {
 					target = target.parentNode;
 				}
 				if ( window.location && target.nodeName.toLowerCase() === "strong" ) {
@@ -231,13 +306,19 @@ Test.prototype = {
 				}
 			});
 
+			// `time` initialized at top of scope
+			time = document.createElement( "span" );
+			time.className = "runtime";
+			time.innerHTML = this.runtime + " ms";
+
 			// `li` initialized at top of scope
 			li = id( this.id );
 			li.className = bad ? "fail" : "pass";
 			li.removeChild( li.firstChild );
 			a = li.firstChild;
 			li.appendChild( b );
-			li.appendChild ( a );
+			li.appendChild( a );
+			li.appendChild( time );
 			li.appendChild( ol );
 
 		} else {
@@ -255,7 +336,8 @@ Test.prototype = {
 			module: this.module,
 			failed: bad,
 			passed: this.assertions.length - bad,
-			total: this.assertions.length
+			total: this.assertions.length,
+			duration: this.runtime
 		});
 
 		QUnit.reset();
@@ -321,7 +403,7 @@ QUnit = {
 
 	test: function( testName, expected, callback, async ) {
 		var test,
-			name = "<span class='test-name'>" + escapeInnerText( testName ) + "</span>";
+			nameHtml = "<span class='test-name'>" + escapeText( testName ) + "</span>";
 
 		if ( arguments.length === 2 ) {
 			callback = expected;
@@ -329,11 +411,11 @@ QUnit = {
 		}
 
 		if ( config.currentModule ) {
-			name = "<span class='module-name'>" + config.currentModule + "</span>: " + name;
+			nameHtml = "<span class='module-name'>" + escapeText( config.currentModule ) + "</span>: " + nameHtml;
 		}
 
 		test = new Test({
-			name: name,
+			nameHtml: nameHtml,
 			testName: testName,
 			expected: expected,
 			async: async,
@@ -350,7 +432,7 @@ QUnit = {
 		test.queue();
 	},
 
-	// Specify the number of expected assertions to gurantee that failed test (no assertions are run at all) don't slip through.
+	// Specify the number of expected assertions to guarantee that failed test (no assertions are run at all) don't slip through.
 	expect: function( asserts ) {
 		if (arguments.length === 1) {
 			config.current.expected = asserts;
@@ -360,6 +442,18 @@ QUnit = {
 	},
 
 	start: function( count ) {
+		// QUnit hasn't been initialized yet.
+		// Note: RequireJS (et al) may delay onLoad
+		if ( config.semaphore === undefined ) {
+			QUnit.begin(function() {
+				// This is triggered at the top of QUnit.load, push start() to the event loop, to allow QUnit.load to finish first
+				setTimeout(function() {
+					QUnit.start( count );
+				});
+			});
+			return;
+		}
+
 		config.semaphore -= count || 1;
 		// don't start until equal number of stop-calls
 		if ( config.semaphore > 0 ) {
@@ -368,10 +462,12 @@ QUnit = {
 		// ignore if start is called more often then stop
 		if ( config.semaphore < 0 ) {
 			config.semaphore = 0;
+			QUnit.pushFailure( "Called start() while already started (QUnit.config.semaphore was 0 already)", null, sourceFromStacktrace(2) );
+			return;
 		}
 		// A slight delay, to avoid any current callbacks
 		if ( defined.setTimeout ) {
-			window.setTimeout(function() {
+			setTimeout(function() {
 				if ( config.semaphore > 0 ) {
 					return;
 				}
@@ -394,7 +490,7 @@ QUnit = {
 
 		if ( config.testTimeout && defined.setTimeout ) {
 			clearTimeout( config.timeout );
-			config.timeout = window.setTimeout(function() {
+			config.timeout = setTimeout(function() {
 				QUnit.ok( false, "Test timed out" );
 				config.semaphore = 1;
 				QUnit.start();
@@ -403,11 +499,14 @@ QUnit = {
 	}
 };
 
-// Asssert helpers
-// All of these must call either QUnit.push() or manually do:
+// `assert` initialized at top of scope
+// Assert helpers
+// All of these must either call QUnit.push() or manually do:
 // - runLoggingCallbacks( "log", .. );
 // - config.current.assertions.push({ .. });
-QUnit.assert = {
+// We attach it to the QUnit object *after* we expose the public API,
+// otherwise `assert` will become a global variable in browsers (#341).
+assert = {
 	/**
 	 * Asserts rough true-ish result.
 	 * @name ok
@@ -419,6 +518,7 @@ QUnit.assert = {
 			throw new Error( "ok() assertion outside test context, was " + sourceFromStacktrace(2) );
 		}
 		result = !!result;
+		msg = msg || (result ? "okay" : "failed" );
 
 		var source,
 			details = {
@@ -428,14 +528,13 @@ QUnit.assert = {
 				message: msg
 			};
 
-		msg = escapeInnerText( msg || (result ? "okay" : "failed" ) );
-		msg = "<span class='test-message'>" + msg + "</span>";
+		msg = "<span class='test-message'>" + escapeText( msg ) + "</span>";
 
 		if ( !result ) {
 			source = sourceFromStacktrace( 2 );
 			if ( source ) {
 				details.source = source;
-				msg += "<table><tr class='test-source'><th>Source: </th><td><pre>" + escapeInnerText( source ) + "</pre></td></tr></table>";
+				msg += "<table><tr class='test-source'><th>Source: </th><td><pre>" + escapeText( source ) + "</pre></td></tr></table>";
 			}
 		}
 		runLoggingCallbacks( "log", QUnit, details );
@@ -453,6 +552,7 @@ QUnit.assert = {
 	 * @example equal( format( "Received {0} bytes.", 2), "Received 2 bytes.", "format() replaces {0} with next argument" );
 	 */
 	equal: function( actual, expected, message ) {
+		/*jshint eqeqeq:false */
 		QUnit.push( expected == actual, actual, expected, message );
 	},
 
@@ -461,10 +561,31 @@ QUnit.assert = {
 	 * @function
 	 */
 	notEqual: function( actual, expected, message ) {
+		/*jshint eqeqeq:false */
 		QUnit.push( expected != actual, actual, expected, message );
 	},
 
 	/**
+	 * @name propEqual
+	 * @function
+	 */
+	propEqual: function( actual, expected, message ) {
+		actual = objectValues(actual);
+		expected = objectValues(expected);
+		QUnit.push( QUnit.equiv(actual, expected), actual, expected, message );
+	},
+
+	/**
+	 * @name notPropEqual
+	 * @function
+	 */
+	notPropEqual: function( actual, expected, message ) {
+		actual = objectValues(actual);
+		expected = objectValues(expected);
+		QUnit.push( !QUnit.equiv(actual, expected), actual, expected, message );
+	},
+
+	/**
 	 * @name deepEqual
 	 * @function
 	 */
@@ -496,8 +617,9 @@ QUnit.assert = {
 		QUnit.push( expected !== actual, actual, expected, message );
 	},
 
-	throws: function( block, expected, message ) {
+	"throws": function( block, expected, message ) {
 		var actual,
+			expectedOutput = expected,
 			ok = false;
 
 		// 'expected' is optional
@@ -518,35 +640,38 @@ QUnit.assert = {
 			// we don't want to validate thrown error
 			if ( !expected ) {
 				ok = true;
+				expectedOutput = null;
 			// expected is a regexp
 			} else if ( QUnit.objectType( expected ) === "regexp" ) {
-				ok = expected.test( actual );
+				ok = expected.test( errorString( actual ) );
 			// expected is a constructor
 			} else if ( actual instanceof expected ) {
 				ok = true;
 			// expected is a validation function which returns true is validation passed
 			} else if ( expected.call( {}, actual ) === true ) {
+				expectedOutput = null;
 				ok = true;
 			}
 
-			QUnit.push( ok, actual, null, message );
+			QUnit.push( ok, actual, expectedOutput, message );
 		} else {
-			QUnit.pushFailure( message, null, 'No exception was thrown.' );
+			QUnit.pushFailure( message, null, "No exception was thrown." );
 		}
 	}
 };
 
 /**
- * @deprecate since 1.8.0
- * Kept assertion helpers in root for backwards compatibility
+ * @deprecated since 1.8.0
+ * Kept assertion helpers in root for backwards compatibility.
  */
-extend( QUnit, QUnit.assert );
+extend( QUnit, assert );
 
 /**
  * @deprecated since 1.9.0
- * Kept global "raises()" for backwards compatibility
+ * Kept root "raises()" for backwards compatibility.
+ * (Note that we don't introduce assert.raises).
  */
-QUnit.raises = QUnit.assert.throws;
+QUnit.raises = assert[ "throws" ];
 
 /**
  * @deprecated since 1.0.0, replaced with error pushes since 1.3.0
@@ -622,6 +747,15 @@ config = {
 	moduleDone: []
 };
 
+// Export global variables, unless an 'exports' object exists,
+// in that case we assume we're in CommonJS (dealt with on the bottom of the script)
+if ( typeof exports === "undefined" ) {
+	extend( window, QUnit.constructor.prototype );
+
+	// Expose QUnit object
+	window.QUnit = QUnit;
+}
+
 // Initialize more QUnit.config and QUnit.urlParams
 (function() {
 	var i,
@@ -655,18 +789,11 @@ config = {
 	QUnit.isLocal = location.protocol === "file:";
 }());
 
-// Export global variables, unless an 'exports' object exists,
-// in that case we assume we're in CommonJS (dealt with on the bottom of the script)
-if ( typeof exports === "undefined" ) {
-	extend( window, QUnit );
-
-	// Expose QUnit object
-	window.QUnit = QUnit;
-}
-
 // Extend QUnit object,
 // these after set here because they should not be exposed as global functions
 extend( QUnit, {
+	assert: assert,
+
 	config: config,
 
 	// Initialize the configuration options
@@ -681,7 +808,7 @@ extend( QUnit, {
 			autorun: false,
 			filter: "",
 			queue: [],
-			semaphore: 0
+			semaphore: 1
 		});
 
 		var tests, banner, result,
@@ -689,7 +816,7 @@ extend( QUnit, {
 
 		if ( qunit ) {
 			qunit.innerHTML =
-				"<h1 id='qunit-header'>" + escapeInnerText( document.title ) + "</h1>" +
+				"<h1 id='qunit-header'>" + escapeText( document.title ) + "</h1>" +
 				"<h2 id='qunit-banner'></h2>" +
 				"<div id='qunit-testrunner-toolbar'></div>" +
 				"<h2 id='qunit-userAgent'></h2>" +
@@ -722,6 +849,11 @@ extend( QUnit, {
 	},
 
 	// Resets the test setup. Useful for tests that modify the DOM.
+	/*
+	DEPRECATED: Use multiple tests instead of resetting inside a test.
+	Use testStart or testDone for custom cleanup.
+	This method will throw an error in 2.0, and will be removed in 2.1
+	*/
 	reset: function() {
 		var fixture = id( "qunit-fixture" );
 		if ( fixture ) {
@@ -745,7 +877,7 @@ extend( QUnit, {
 
 	// Safe object type checking
 	is: function( type, obj ) {
-		return QUnit.objectType( obj ) == type;
+		return QUnit.objectType( obj ) === type;
 	},
 
 	objectType: function( obj ) {
@@ -757,7 +889,8 @@ extend( QUnit, {
 				return "null";
 		}
 
-		var type = toString.call( obj ).match(/^\[object\s(.*)\]$/)[1] || "";
+		var match = toString.call( obj ).match(/^\[object\s(.*)\]$/),
+			type = match && match[1] || "";
 
 		switch ( type ) {
 			case "Number":
@@ -794,16 +927,16 @@ extend( QUnit, {
 				expected: expected
 			};
 
-		message = escapeInnerText( message ) || ( result ? "okay" : "failed" );
+		message = escapeText( message ) || ( result ? "okay" : "failed" );
 		message = "<span class='test-message'>" + message + "</span>";
 		output = message;
 
 		if ( !result ) {
-			expected = escapeInnerText( QUnit.jsDump.parse(expected) );
-			actual = escapeInnerText( QUnit.jsDump.parse(actual) );
+			expected = escapeText( QUnit.jsDump.parse(expected) );
+			actual = escapeText( QUnit.jsDump.parse(actual) );
 			output += "<table><tr class='test-expected'><th>Expected: </th><td><pre>" + expected + "</pre></td></tr>";
 
-			if ( actual != expected ) {
+			if ( actual !== expected ) {
 				output += "<tr class='test-actual'><th>Result: </th><td><pre>" + actual + "</pre></td></tr>";
 				output += "<tr class='test-diff'><th>Diff: </th><td><pre>" + QUnit.diff( expected, actual ) + "</pre></td></tr>";
 			}
@@ -812,7 +945,7 @@ extend( QUnit, {
 
 			if ( source ) {
 				details.source = source;
-				output += "<tr class='test-source'><th>Source: </th><td><pre>" + escapeInnerText( source ) + "</pre></td></tr>";
+				output += "<tr class='test-source'><th>Source: </th><td><pre>" + escapeText( source ) + "</pre></td></tr>";
 			}
 
 			output += "</table>";
@@ -839,19 +972,19 @@ extend( QUnit, {
 				message: message
 			};
 
-		message = escapeInnerText( message ) || "error";
+		message = escapeText( message ) || "error";
 		message = "<span class='test-message'>" + message + "</span>";
 		output = message;
 
 		output += "<table>";
 
 		if ( actual ) {
-			output += "<tr class='test-actual'><th>Result: </th><td><pre>" + escapeInnerText( actual ) + "</pre></td></tr>";
+			output += "<tr class='test-actual'><th>Result: </th><td><pre>" + escapeText( actual ) + "</pre></td></tr>";
 		}
 
 		if ( source ) {
 			details.source = source;
-			output += "<tr class='test-source'><th>Source: </th><td><pre>" + escapeInnerText( source ) + "</pre></td></tr>";
+			output += "<tr class='test-source'><th>Source: </th><td><pre>" + escapeText( source ) + "</pre></td></tr>";
 		}
 
 		output += "</table>";
@@ -870,18 +1003,21 @@ extend( QUnit, {
 			querystring = "?";
 
 		for ( key in params ) {
-			if ( !hasOwn.call( params, key ) ) {
-				continue;
+			if ( hasOwn.call( params, key ) ) {
+				querystring += encodeURIComponent( key ) + "=" +
+					encodeURIComponent( params[ key ] ) + "&";
 			}
-			querystring += encodeURIComponent( key ) + "=" +
-				encodeURIComponent( params[ key ] ) + "&";
 		}
-		return window.location.pathname + querystring.slice( 0, -1 );
+		return window.location.protocol + "//" + window.location.host +
+			window.location.pathname + querystring.slice( 0, -1 );
 	},
 
 	extend: extend,
 	id: id,
-	addEvent: addEvent
+	addEvent: addEvent,
+	addClass: addClass,
+	hasClass: hasClass,
+	removeClass: removeClass
 	// load, equiv, jsDump, diff: Attached later
 });
 
@@ -907,7 +1043,7 @@ extend( QUnit.constructor.prototype, {
 	// testStart: { name }
 	testStart: registerLoggingCallback( "testStart" ),
 
-	// testDone: { name, failed, passed, total }
+	// testDone: { name, failed, passed, total, duration }
 	testDone: registerLoggingCallback( "testDone" ),
 
 	// moduleStart: { name }
@@ -925,9 +1061,11 @@ QUnit.load = function() {
 	runLoggingCallbacks( "begin", QUnit, {} );
 
 	// Initialize the config, saving the execution queue
-	var banner, filter, i, label, len, main, ol, toolbar, userAgent, val, urlConfigCheckboxes, moduleFilter,
-	    numModules = 0,
-	    moduleFilterHtml = "",
+	var banner, filter, i, label, len, main, ol, toolbar, userAgent, val,
+		urlConfigCheckboxesContainer, urlConfigCheckboxes, moduleFilter,
+		numModules = 0,
+		moduleNames = [],
+		moduleFilterHtml = "",
 		urlConfigHtml = "",
 		oldconfig = extend( {}, config );
 
@@ -948,16 +1086,32 @@ QUnit.load = function() {
 			};
 		}
 		config[ val.id ] = QUnit.urlParams[ val.id ];
-		urlConfigHtml += "<input id='qunit-urlconfig-" + val.id + "' name='" + val.id + "' type='checkbox'" + ( config[ val.id ] ? " checked='checked'" : "" ) + " title='" + val.tooltip + "'><label for='qunit-urlconfig-" + val.id + "' title='" + val.tooltip + "'>" + val.label + "</label>";
+		urlConfigHtml += "<input id='qunit-urlconfig-" + escapeText( val.id ) +
+			"' name='" + escapeText( val.id ) +
+			"' type='checkbox'" + ( config[ val.id ] ? " checked='checked'" : "" ) +
+			" title='" + escapeText( val.tooltip ) +
+			"'><label for='qunit-urlconfig-" + escapeText( val.id ) +
+			"' title='" + escapeText( val.tooltip ) + "'>" + val.label + "</label>";
 	}
-
-	moduleFilterHtml += "<label for='qunit-modulefilter'>Module: </label><select id='qunit-modulefilter' name='modulefilter'><option value='' " + ( config.module === undefined  ? "selected" : "" ) + ">< All Modules ></option>";
 	for ( i in config.modules ) {
 		if ( config.modules.hasOwnProperty( i ) ) {
-			numModules += 1;
-			moduleFilterHtml += "<option value='" + encodeURIComponent(i) + "' " + ( config.module === i ? "selected" : "" ) + ">" + i + "</option>";
+			moduleNames.push(i);
 		}
 	}
+	numModules = moduleNames.length;
+	moduleNames.sort( function( a, b ) {
+		return a.localeCompare( b );
+	});
+	moduleFilterHtml += "<label for='qunit-modulefilter'>Module: </label><select id='qunit-modulefilter' name='modulefilter'><option value='' " +
+		( config.module === undefined  ? "selected='selected'" : "" ) +
+		">< All Modules ></option>";
+
+
+	for ( i = 0; i < numModules; i++) {
+			moduleFilterHtml += "<option value='" + escapeText( encodeURIComponent(moduleNames[i]) ) + "' " +
+				( config.module === moduleNames[i] ? "selected='selected'" : "" ) +
+				">" + escapeText(moduleNames[i]) + "</option>";
+	}
 	moduleFilterHtml += "</select>";
 
 	// `userAgent` initialized at top of scope
@@ -1010,28 +1164,39 @@ QUnit.load = function() {
 		// `label` initialized at top of scope
 		label = document.createElement( "label" );
 		label.setAttribute( "for", "qunit-filter-pass" );
-		label.setAttribute( "title", "Only show tests and assertons that fail. Stored in sessionStorage." );
+		label.setAttribute( "title", "Only show tests and assertions that fail. Stored in sessionStorage." );
 		label.innerHTML = "Hide passed tests";
 		toolbar.appendChild( label );
 
-		urlConfigCheckboxes = document.createElement( 'span' );
-		urlConfigCheckboxes.innerHTML = urlConfigHtml;
-		addEvent( urlConfigCheckboxes, "change", function( event ) {
-			var params = {};
-			params[ event.target.name ] = event.target.checked ? true : undefined;
+		urlConfigCheckboxesContainer = document.createElement("span");
+		urlConfigCheckboxesContainer.innerHTML = urlConfigHtml;
+		urlConfigCheckboxes = urlConfigCheckboxesContainer.getElementsByTagName("input");
+		// For oldIE support:
+		// * Add handlers to the individual elements instead of the container
+		// * Use "click" instead of "change"
+		// * Fallback from event.target to event.srcElement
+		addEvents( urlConfigCheckboxes, "click", function( event ) {
+			var params = {},
+				target = event.target || event.srcElement;
+			params[ target.name ] = target.checked ? true : undefined;
 			window.location = QUnit.url( params );
 		});
-		toolbar.appendChild( urlConfigCheckboxes );
+		toolbar.appendChild( urlConfigCheckboxesContainer );
 
 		if (numModules > 1) {
-			moduleFilter = document.createElement( 'span' );
-			moduleFilter.setAttribute( 'id', 'qunit-modulefilter-container' );
+			moduleFilter = document.createElement( "span" );
+			moduleFilter.setAttribute( "id", "qunit-modulefilter-container" );
 			moduleFilter.innerHTML = moduleFilterHtml;
-			addEvent( moduleFilter, "change", function() {
+			addEvent( moduleFilter.lastChild, "change", function() {
 				var selectBox = moduleFilter.getElementsByTagName("select")[0],
-				    selectedModule = decodeURIComponent(selectBox.options[selectBox.selectedIndex].value);
+					selectedModule = decodeURIComponent(selectBox.options[selectBox.selectedIndex].value);
 
-				window.location = QUnit.url( { module: ( selectedModule === "" ) ? undefined : selectedModule } );
+				window.location = QUnit.url({
+					module: ( selectedModule === "" ) ? undefined : selectedModule,
+					// Remove any existing filters
+					filter: undefined,
+					testNumber: undefined
+				});
 			});
 			toolbar.appendChild(moduleFilter);
 		}
@@ -1055,7 +1220,7 @@ addEvent( window, "load", QUnit.load );
 onErrorFnPrev = window.onerror;
 
 // Cover uncaught exceptions
-// Returning true will surpress the default browser handler,
+// Returning true will suppress the default browser handler,
 // returning false will let it run.
 window.onerror = function ( error, filePath, linerNr ) {
 	var ret = false;
@@ -1064,7 +1229,7 @@ window.onerror = function ( error, filePath, linerNr ) {
 	}
 
 	// Treat return value as window.onerror itself does,
-	// Only do our handling if not surpressed.
+	// Only do our handling if not suppressed.
 	if ( ret !== true ) {
 		if ( QUnit.config.current ) {
 			if ( QUnit.config.current.ignoreGlobalErrors ) {
@@ -1094,6 +1259,7 @@ function done() {
 			total: config.moduleStats.all
 		});
 	}
+	delete config.previousModule;
 
 	var i, key,
 		banner = id( "qunit-banner" ),
@@ -1106,7 +1272,7 @@ function done() {
 			" milliseconds.<br/>",
 			"<span class='passed'>",
 			passed,
-			"</span> tests of <span class='total'>",
+			"</span> assertions of <span class='total'>",
 			config.stats.all,
 			"</span> passed, <span class='failed'>",
 			config.stats.bad,
@@ -1199,7 +1365,7 @@ function validTest( test ) {
 function extractStacktrace( e, offset ) {
 	offset = offset === undefined ? 3 : offset;
 
-	var stack, include, i, regex;
+	var stack, include, i;
 
 	if ( e.stacktrace ) {
 		// Opera
@@ -1213,7 +1379,7 @@ function extractStacktrace( e, offset ) {
 		if ( fileName ) {
 			include = [];
 			for ( i = offset; i < stack.length; i++ ) {
-				if ( stack[ i ].indexOf( fileName ) != -1 ) {
+				if ( stack[ i ].indexOf( fileName ) !== -1 ) {
 					break;
 				}
 				include.push( stack[ i ] );
@@ -1242,17 +1408,27 @@ function sourceFromStacktrace( offset ) {
 	}
 }
 
-function escapeInnerText( s ) {
+/**
+ * Escape text for attribute or text content.
+ */
+function escapeText( s ) {
 	if ( !s ) {
 		return "";
 	}
 	s = s + "";
-	return s.replace( /[\&<>]/g, function( s ) {
+	// Both single quotes and double quotes (for attributes)
+	return s.replace( /['"<>&]/g, function( s ) {
 		switch( s ) {
-			case "&": return "&amp;";
-			case "<": return "&lt;";
-			case ">": return "&gt;";
-			default: return s;
+			case "'":
+				return "&#039;";
+			case "\"":
+				return "&quot;";
+			case "<":
+				return "&lt;";
+			case ">":
+				return "&gt;";
+			case "&":
+				return "&amp;";
 		}
 	});
 }
@@ -1276,7 +1452,7 @@ function process( last ) {
 		if ( !defined.setTimeout || config.updateRate <= 0 || ( ( new Date().getTime() - start ) < config.updateRate ) ) {
 			config.queue.shift()();
 		} else {
-			window.setTimeout( next, 13 );
+			setTimeout( next, 13 );
 			break;
 		}
 	}
@@ -1291,16 +1467,18 @@ function saveGlobal() {
 
 	if ( config.noglobals ) {
 		for ( var key in window ) {
-			// in Opera sometimes DOM element ids show up here, ignore them
-			if ( !hasOwn.call( window, key ) || /^qunit-test-output/.test( key ) ) {
-				continue;
+			if ( hasOwn.call( window, key ) ) {
+				// in Opera sometimes DOM element ids show up here, ignore them
+				if ( /^qunit-test-output/.test( key ) ) {
+					continue;
+				}
+				config.pollution.push( key );
 			}
-			config.pollution.push( key );
 		}
 	}
 }
 
-function checkPollution( name ) {
+function checkPollution() {
 	var newGlobals,
 		deletedGlobals,
 		old = config.pollution;
@@ -1337,28 +1515,68 @@ function diff( a, b ) {
 
 function extend( a, b ) {
 	for ( var prop in b ) {
-		if ( b[ prop ] === undefined ) {
-			delete a[ prop ];
-
-		// Avoid "Member not found" error in IE8 caused by setting window.constructor
-		} else if ( prop !== "constructor" || a !== window ) {
-			a[ prop ] = b[ prop ];
+		if ( hasOwn.call( b, prop ) ) {
+			// Avoid "Member not found" error in IE8 caused by messing with window.constructor
+			if ( !( prop === "constructor" && a === window ) ) {
+				if ( b[ prop ] === undefined ) {
+					delete a[ prop ];
+				} else {
+					a[ prop ] = b[ prop ];
+				}
+			}
 		}
 	}
 
 	return a;
 }
 
+/**
+ * @param {HTMLElement} elem
+ * @param {string} type
+ * @param {Function} fn
+ */
 function addEvent( elem, type, fn ) {
+	// Standards-based browsers
 	if ( elem.addEventListener ) {
 		elem.addEventListener( type, fn, false );
-	} else if ( elem.attachEvent ) {
-		elem.attachEvent( "on" + type, fn );
+	// IE
 	} else {
-		fn();
+		elem.attachEvent( "on" + type, fn );
 	}
 }
 
+/**
+ * @param {Array|NodeList} elems
+ * @param {string} type
+ * @param {Function} fn
+ */
+function addEvents( elems, type, fn ) {
+	var i = elems.length;
+	while ( i-- ) {
+		addEvent( elems[i], type, fn );
+	}
+}
+
+function hasClass( elem, name ) {
+	return (" " + elem.className + " ").indexOf(" " + name + " ") > -1;
+}
+
+function addClass( elem, name ) {
+	if ( !hasClass( elem, name ) ) {
+		elem.className += (elem.className ? " " : "") + name;
+	}
+}
+
+function removeClass( elem, name ) {
+	var set = " " + elem.className + " ";
+	// Class name may appear multiple times
+	while ( set.indexOf(" " + name + " ") > -1 ) {
+		set = set.replace(" " + name + " " , " ");
+	}
+	// If possible, trim it for prettiness, but not necessarily
+	elem.className = typeof set.trim === "function" ? set.trim() : set.replace(/^\s+|\s+$/g, "");
+}
+
 function id( name ) {
 	return !!( typeof document !== "undefined" && document && document.getElementById ) &&
 		document.getElementById( name );
@@ -1372,7 +1590,6 @@ function registerLoggingCallback( key ) {
 
 // Supports deprecated method of completely overwriting logging callbacks
 function runLoggingCallbacks( key, scope, args ) {
-	//debugger;
 	var i, callbacks;
 	if ( QUnit.hasOwnProperty( key ) ) {
 		QUnit[ key ].call(scope, args );
@@ -1406,16 +1623,19 @@ QUnit.equiv = (function() {
 		callers = [],
 		// stack to avoiding loops from circular referencing
 		parents = [],
+		parentsB = [],
 
 		getProto = Object.getPrototypeOf || function ( obj ) {
+			/*jshint camelcase:false */
 			return obj.__proto__;
 		},
 		callbacks = (function () {
 
 			// for string, boolean, number and null
 			function useStrictEquality( b, a ) {
+				/*jshint eqeqeq:false */
 				if ( b instanceof a.constructor || a instanceof b.constructor ) {
-					// to catch short annotaion VS 'new' annotation of a
+					// to catch short annotation VS 'new' annotation of a
 					// declaration
 					// e.g. var i = 1;
 					// var j = new Number(1);
@@ -1444,7 +1664,7 @@ QUnit.equiv = (function() {
 					return QUnit.objectType( b ) === "regexp" &&
 						// the regex itself
 						a.source === b.source &&
-						// and its modifers
+						// and its modifiers
 						a.global === b.global &&
 						// (gmi) ...
 						a.ignoreCase === b.ignoreCase &&
@@ -1461,7 +1681,7 @@ QUnit.equiv = (function() {
 				},
 
 				"array": function( b, a ) {
-					var i, j, len, loop;
+					var i, j, len, loop, aCircular, bCircular;
 
 					// b could be an object literal here
 					if ( QUnit.objectType( b ) !== "array" ) {
@@ -1476,24 +1696,36 @@ QUnit.equiv = (function() {
 
 					// track reference to avoid circular references
 					parents.push( a );
+					parentsB.push( b );
 					for ( i = 0; i < len; i++ ) {
 						loop = false;
 						for ( j = 0; j < parents.length; j++ ) {
-							if ( parents[j] === a[i] ) {
-								loop = true;// dont rewalk array
+							aCircular = parents[j] === a[i];
+							bCircular = parentsB[j] === b[i];
+							if ( aCircular || bCircular ) {
+								if ( a[i] === b[i] || aCircular && bCircular ) {
+									loop = true;
+								} else {
+									parents.pop();
+									parentsB.pop();
+									return false;
+								}
 							}
 						}
 						if ( !loop && !innerEquiv(a[i], b[i]) ) {
 							parents.pop();
+							parentsB.pop();
 							return false;
 						}
 					}
 					parents.pop();
+					parentsB.pop();
 					return true;
 				},
 
 				"object": function( b, a ) {
-					var i, j, loop,
+					/*jshint forin:false */
+					var i, j, loop, aCircular, bCircular,
 						// Default to true
 						eq = true,
 						aProperties = [],
@@ -1512,28 +1744,36 @@ QUnit.equiv = (function() {
 
 					// stack constructor before traversing properties
 					callers.push( a.constructor );
+
 					// track reference to avoid circular references
 					parents.push( a );
+					parentsB.push( b );
 
-					for ( i in a ) { // be strict: don't ensures hasOwnProperty
-									// and go deep
+					// be strict: don't ensure hasOwnProperty and go deep
+					for ( i in a ) {
 						loop = false;
 						for ( j = 0; j < parents.length; j++ ) {
-							if ( parents[j] === a[i] ) {
-								// don't go down the same path twice
-								loop = true;
+							aCircular = parents[j] === a[i];
+							bCircular = parentsB[j] === b[i];
+							if ( aCircular || bCircular ) {
+								if ( a[i] === b[i] || aCircular && bCircular ) {
+									loop = true;
+								} else {
+									eq = false;
+									break;
+								}
 							}
 						}
-						aProperties.push(i); // collect a's properties
-
-						if (!loop && !innerEquiv( a[i], b[i] ) ) {
+						aProperties.push(i);
+						if ( !loop && !innerEquiv(a[i], b[i]) ) {
 							eq = false;
 							break;
 						}
 					}
 
-					callers.pop(); // unstack, we are done
 					parents.pop();
+					parentsB.pop();
+					callers.pop(); // unstack, we are done
 
 					for ( i in b ) {
 						bProperties.push( i ); // collect b's properties
@@ -1563,7 +1803,7 @@ QUnit.equiv = (function() {
 			}
 
 			// apply transition with (1..n) arguments
-		}( args[0], args[1] ) && arguments.callee.apply( this, args.splice(1, args.length - 1 )) );
+		}( args[0], args[1] ) && innerEquiv.apply( this, args.splice(1, args.length - 1 )) );
 	};
 
 	return innerEquiv;
@@ -1581,7 +1821,7 @@ QUnit.equiv = (function() {
  */
 QUnit.jsDump = (function() {
 	function quote( str ) {
-		return '"' + str.toString().replace( /"/g, '\\"' ) + '"';
+		return "\"" + str.toString().replace( /"/g, "\\\"" ) + "\"";
 	}
 	function literal( o ) {
 		return o + "";
@@ -1610,7 +1850,8 @@ QUnit.jsDump = (function() {
 
 	var reName = /^function (\w+)/,
 		jsDump = {
-			parse: function( obj, type, stack ) { //type is used mostly internally, you can fix a (custom)type in advance
+			// type is used mostly internally, you can fix a (custom)type in advance
+			parse: function( obj, type, stack ) {
 				stack = stack || [ ];
 				var inStack, res,
 					parser = this.parsers[ type || this.typeOf(obj) ];
@@ -1618,18 +1859,16 @@ QUnit.jsDump = (function() {
 				type = typeof parser;
 				inStack = inArray( obj, stack );
 
-				if ( inStack != -1 ) {
+				if ( inStack !== -1 ) {
 					return "recursion(" + (inStack - stack.length) + ")";
 				}
-				//else
-				if ( type == "function" )  {
+				if ( type === "function" )  {
 					stack.push( obj );
 					res = parser.call( this, obj, stack );
 					stack.pop();
 					return res;
 				}
-				// else
-				return ( type == "string" ) ? parser : this.parsers.error;
+				return ( type === "string" ) ? parser : this.parsers.error;
 			},
 			typeOf: function( obj ) {
 				var type;
@@ -1656,6 +1895,8 @@ QUnit.jsDump = (function() {
 					( typeof obj.length === "number" && typeof obj.item !== "undefined" && ( obj.length ? obj.item(0) === obj[0] : ( obj.item( 0 ) === null && typeof obj[0] === "undefined" ) ) )
 				) {
 					type = "array";
+				} else if ( obj.constructor === Error.prototype.constructor ) {
+					type = "error";
 				} else {
 					type = typeof obj;
 				}
@@ -1664,7 +1905,8 @@ QUnit.jsDump = (function() {
 			separator: function() {
 				return this.multiline ?	this.HTML ? "<br />" : "\n" : this.HTML ? "&nbsp;" : " ";
 			},
-			indent: function( extra ) {// extra can be a number, shortcut for increasing-calling-decreasing
+			// extra can be a number, shortcut for increasing-calling-decreasing
+			indent: function( extra ) {
 				if ( !this.multiline ) {
 					return "";
 				}
@@ -1672,13 +1914,13 @@ QUnit.jsDump = (function() {
 				if ( this.HTML ) {
 					chr = chr.replace( /\t/g, "   " ).replace( / /g, "&nbsp;" );
 				}
-				return new Array( this._depth_ + (extra||0) ).join(chr);
+				return new Array( this.depth + ( extra || 0 ) ).join(chr);
 			},
 			up: function( a ) {
-				this._depth_ += a || 1;
+				this.depth += a || 1;
 			},
 			down: function( a ) {
-				this._depth_ -= a || 1;
+				this.depth -= a || 1;
 			},
 			setParser: function( name, parser ) {
 				this.parsers[name] = parser;
@@ -1688,18 +1930,21 @@ QUnit.jsDump = (function() {
 			literal: literal,
 			join: join,
 			//
-			_depth_: 1,
+			depth: 1,
 			// This is the list of parsers, to modify them, use jsDump.setParser
 			parsers: {
 				window: "[Window]",
 				document: "[Document]",
-				error: "[ERROR]", //when no parser is found, shouldn"t happen
+				error: function(error) {
+					return "Error(\"" + error.message + "\")";
+				},
 				unknown: "[Unknown]",
 				"null": "null",
 				"undefined": "undefined",
 				"function": function( fn ) {
 					var ret = "function",
-						name = "name" in fn ? fn.name : (reName.exec(fn) || [])[1];//functions never have name in IE
+						// functions never have name in IE
+						name = "name" in fn ? fn.name : (reName.exec(fn) || [])[1];
 
 					if ( name ) {
 						ret += " " + name;
@@ -1713,15 +1958,12 @@ QUnit.jsDump = (function() {
 				nodelist: array,
 				"arguments": array,
 				object: function( map, stack ) {
+					/*jshint forin:false */
 					var ret = [ ], keys, key, val, i;
 					QUnit.jsDump.up();
-					if ( Object.keys ) {
-						keys = Object.keys( map );
-					} else {
-						keys = [];
-						for ( key in map ) {
-							keys.push( key );
-						}
+					keys = [];
+					for ( key in map ) {
+						keys.push( key );
 					}
 					keys.sort();
 					for ( i = 0; i < keys.length; i++ ) {
@@ -1733,21 +1975,34 @@ QUnit.jsDump = (function() {
 					return join( "{", ret, "}" );
 				},
 				node: function( node ) {
-					var a, val,
+					var len, i, val,
 						open = QUnit.jsDump.HTML ? "&lt;" : "<",
 						close = QUnit.jsDump.HTML ? "&gt;" : ">",
 						tag = node.nodeName.toLowerCase(),
-						ret = open + tag;
-
-					for ( a in QUnit.jsDump.DOMAttrs ) {
-						val = node[ QUnit.jsDump.DOMAttrs[a] ];
-						if ( val ) {
-							ret += " " + a + "=" + QUnit.jsDump.parse( val, "attribute" );
+						ret = open + tag,
+						attrs = node.attributes;
+
+					if ( attrs ) {
+						for ( i = 0, len = attrs.length; i < len; i++ ) {
+							val = attrs[i].nodeValue;
+							// IE6 includes all attributes in .attributes, even ones not explicitly set.
+							// Those have values like undefined, null, 0, false, "" or "inherit".
+							if ( val && val !== "inherit" ) {
+								ret += " " + attrs[i].nodeName + "=" + QUnit.jsDump.parse( val, "attribute" );
+							}
 						}
 					}
-					return ret + close + open + "/" + tag + close;
+					ret += close;
+
+					// Show content of TextNode or CDATASection
+					if ( node.nodeType === 3 || node.nodeType === 4 ) {
+						ret += node.nodeValue;
+					}
+
+					return ret + open + "/" + tag + close;
 				},
-				functionArgs: function( fn ) {//function calls it internally, it's the arguments part of the function
+				// function calls it internally, it's the arguments part of the function
+				functionArgs: function( fn ) {
 					var args,
 						l = fn.length;
 
@@ -1757,54 +2012,34 @@ QUnit.jsDump = (function() {
 
 					args = new Array(l);
 					while ( l-- ) {
-						args[l] = String.fromCharCode(97+l);//97 is 'a'
+						// 97 is 'a'
+						args[l] = String.fromCharCode(97+l);
 					}
 					return " " + args.join( ", " ) + " ";
 				},
-				key: quote, //object calls it internally, the key part of an item in a map
-				functionCode: "[code]", //function calls it internally, it's the content of the function
-				attribute: quote, //node calls it internally, it's an html attribute value
+				// object calls it internally, the key part of an item in a map
+				key: quote,
+				// function calls it internally, it's the content of the function
+				functionCode: "[code]",
+				// node calls it internally, it's an html attribute value
+				attribute: quote,
 				string: quote,
 				date: quote,
-				regexp: literal, //regex
+				regexp: literal,
 				number: literal,
 				"boolean": literal
 			},
-			DOMAttrs: {
-				//attributes to dump from nodes, name=>realName
-				id: "id",
-				name: "name",
-				"class": "className"
-			},
-			HTML: false,//if true, entities are escaped ( <, >, \t, space and \n )
-			indentChar: "  ",//indentation unit
-			multiline: true //if true, items in a collection, are separated by a \n, else just a space.
+			// if true, entities are escaped ( <, >, \t, space and \n )
+			HTML: false,
+			// indentation unit
+			indentChar: "  ",
+			// if true, items in a collection, are separated by a \n, else just a space.
+			multiline: true
 		};
 
 	return jsDump;
 }());
 
-// from Sizzle.js
-function getText( elems ) {
-	var i, elem,
-		ret = "";
-
-	for ( i = 0; elems[i]; i++ ) {
-		elem = elems[i];
-
-		// Get the text from text nodes and CDATA nodes
-		if ( elem.nodeType === 3 || elem.nodeType === 4 ) {
-			ret += elem.nodeValue;
-
-		// Traverse everything else, except comment nodes
-		} else if ( elem.nodeType !== 8 ) {
-			ret += getText( elem.childNodes );
-		}
-	}
-
-	return ret;
-}
-
 // from jquery.js
 function inArray( elem, array ) {
 	if ( array.indexOf ) {
@@ -1835,13 +2070,14 @@ function inArray( elem, array ) {
  * QUnit.diff( "the quick brown fox jumped over", "the quick fox jumps over" ) == "the  quick <del>brown </del> fox <del>jumped </del><ins>jumps </ins> over"
  */
 QUnit.diff = (function() {
+	/*jshint eqeqeq:false, eqnull:true */
 	function diff( o, n ) {
 		var i,
 			ns = {},
 			os = {};
 
 		for ( i = 0; i < n.length; i++ ) {
-			if ( ns[ n[i] ] == null ) {
+			if ( !hasOwn.call( ns, n[i] ) ) {
 				ns[ n[i] ] = {
 					rows: [],
 					o: null
@@ -1851,7 +2087,7 @@ QUnit.diff = (function() {
 		}
 
 		for ( i = 0; i < o.length; i++ ) {
-			if ( os[ o[i] ] == null ) {
+			if ( !hasOwn.call( os, o[i] ) ) {
 				os[ o[i] ] = {
 					rows: [],
 					n: null
@@ -1861,18 +2097,17 @@ QUnit.diff = (function() {
 		}
 
 		for ( i in ns ) {
-			if ( !hasOwn.call( ns, i ) ) {
-				continue;
-			}
-			if ( ns[i].rows.length == 1 && typeof os[i] != "undefined" && os[i].rows.length == 1 ) {
-				n[ ns[i].rows[0] ] = {
-					text: n[ ns[i].rows[0] ],
-					row: os[i].rows[0]
-				};
-				o[ os[i].rows[0] ] = {
-					text: o[ os[i].rows[0] ],
-					row: ns[i].rows[0]
-				};
+			if ( hasOwn.call( ns, i ) ) {
+				if ( ns[i].rows.length === 1 && hasOwn.call( os, i ) && os[i].rows.length === 1 ) {
+					n[ ns[i].rows[0] ] = {
+						text: n[ ns[i].rows[0] ],
+						row: os[i].rows[0]
+					};
+					o[ os[i].rows[0] ] = {
+						text: o[ os[i].rows[0] ],
+						row: ns[i].rows[0]
+					};
+				}
 			}
 		}
 
@@ -1968,9 +2203,9 @@ QUnit.diff = (function() {
 	};
 }());
 
-// for CommonJS enviroments, export everything
+// for CommonJS environments, export everything
 if ( typeof exports !== "undefined" ) {
-	extend(exports, QUnit);
+	extend( exports, QUnit.constructor.prototype );
 }
 
 // get at whatever the global object is, like window in browsers
diff --git a/profiles/commons/libraries/underscore/test/vendor/runner.js b/profiles/commons/libraries/underscore/test/vendor/runner.js
index 3fa676b..4b1d38b 100644
--- a/profiles/commons/libraries/underscore/test/vendor/runner.js
+++ b/profiles/commons/libraries/underscore/test/vendor/runner.js
@@ -1,98 +1,127 @@
 /*
- * Qt+WebKit powered headless test runner using Phantomjs
+ * QtWebKit-powered headless test runner using PhantomJS
  *
- * Phantomjs installation: http://code.google.com/p/phantomjs/wiki/BuildInstructions
+ * PhantomJS binaries: http://phantomjs.org/download.html
+ * Requires PhantomJS 1.6+ (1.7+ recommended)
  *
  * Run with:
- *  phantomjs runner.js [url-of-your-qunit-testsuite]
+ *   phantomjs runner.js [url-of-your-qunit-testsuite]
  *
- * E.g.
- *      phantomjs runner.js http://localhost/qunit/test
+ * e.g.
+ *   phantomjs runner.js http://localhost/qunit/test/index.html
  */
 
 /*jshint latedef:false */
-/*global phantom:true require:true console:true */
-var url = phantom.args[0],
-	page = require('webpage').create();
-
-// Route "console.log()" calls from within the Page context to the main Phantom context (i.e. current "this")
-page.onConsoleMessage = function(msg) {
-	console.log(msg);
-};
-
-page.onInitialized = function() {
-	page.evaluate(addLogging);
-};
-page.open(url, function(status){
-	if (status !== "success") {
-		console.log("Unable to access network: " + status);
+/*global phantom:false, require:false, console:false, window:false, QUnit:false */
+
+(function() {
+	'use strict';
+
+	var args = require('system').args;
+
+	// arg[0]: scriptName, args[1...]: arguments
+	if (args.length !== 2) {
+		console.error('Usage:\n  phantomjs runner.js [url-of-your-qunit-testsuite]');
 		phantom.exit(1);
-	} else {
-		// page.evaluate(addLogging);
-		var interval = setInterval(function() {
-			if (finished()) {
-				clearInterval(interval);
-				onfinishedTests();
-			}
-		}, 500);
 	}
-});
 
-function finished() {
-	return page.evaluate(function(){
-		return !!window.qunitDone;
-	});
-}
+	var url = args[1],
+		page = require('webpage').create();
 
-function onfinishedTests() {
-	var output = page.evaluate(function() {
-			return JSON.stringify(window.qunitDone);
-	});
-	phantom.exit(JSON.parse(output).failed > 0 ? 1 : 0);
-}
+	// Route `console.log()` calls from within the Page context to the main Phantom context (i.e. current `this`)
+	page.onConsoleMessage = function(msg) {
+		console.log(msg);
+	};
 
-function addLogging() {
-	window.document.addEventListener( "DOMContentLoaded", function() {
-		var current_test_assertions = [];
+	page.onInitialized = function() {
+		page.evaluate(addLogging);
+	};
 
-		QUnit.testDone(function(result) {
-			var i,
-				name = result.module + ': ' + result.name;
+	page.onCallback = function(message) {
+		var result,
+			failed;
 
-			if (result.failed) {
-				console.log('Assertion Failed: ' + name);
+		if (message) {
+			if (message.name === 'QUnit.done') {
+				result = message.data;
+				failed = !result || result.failed;
 
-				for (i = 0; i < current_test_assertions.length; i++) {
-					console.log('    ' + current_test_assertions[i]);
-				}
+				phantom.exit(failed ? 1 : 0);
+			}
+		}
+	};
+
+	page.open(url, function(status) {
+		if (status !== 'success') {
+			console.error('Unable to access network: ' + status);
+			phantom.exit(1);
+		} else {
+			// Cannot do this verification with the 'DOMContentLoaded' handler because it
+			// will be too late to attach it if a page does not have any script tags.
+			var qunitMissing = page.evaluate(function() { return (typeof QUnit === 'undefined' || !QUnit); });
+			if (qunitMissing) {
+				console.error('The `QUnit` object is not present on this page.');
+				phantom.exit(1);
 			}
 
-			current_test_assertions = [];
-		});
+			// Do nothing... the callback mechanism will handle everything!
+		}
+	});
 
-		QUnit.log(function(details) {
-			var response;
+	function addLogging() {
+		window.document.addEventListener('DOMContentLoaded', function() {
+			var current_test_assertions = [];
 
-			if (details.result) {
-				return;
-			}
+			QUnit.log(function(details) {
+				var response;
 
-			response = details.message || '';
+				// Ignore passing assertions
+				if (details.result) {
+					return;
+				}
 
-			if (typeof details.expected !== 'undefined') {
-				if (response) {
-					response += ', ';
+				response = details.message || '';
+
+				if (typeof details.expected !== 'undefined') {
+					if (response) {
+						response += ', ';
+					}
+
+					response += 'expected: ' + details.expected + ', but was: ' + details.actual;
+					if (details.source) {
+						response += "\n" + details.source;
+					}
 				}
 
-				response += 'expected: ' + details.expected + ', but was: ' + details.actual;
-			}
+				current_test_assertions.push('Failed assertion: ' + response);
+			});
+
+			QUnit.testDone(function(result) {
+				var i,
+					len,
+					name = result.module + ': ' + result.name;
+
+				if (result.failed) {
+					console.log('Test failed: ' + name);
 
-			current_test_assertions.push('Failed assertion: ' + response);
-		});
+					for (i = 0, len = current_test_assertions.length; i < len; i++) {
+						console.log('    ' + current_test_assertions[i]);
+					}
+				}
+
+				current_test_assertions.length = 0;
+			});
+
+			QUnit.done(function(result) {
+				console.log('Took ' + result.runtime +  'ms to run ' + result.total + ' tests. ' + result.passed + ' passed, ' + result.failed + ' failed.');
 
-		QUnit.done(function(result){
-			console.log('Took ' + result.runtime +  'ms to run ' + result.total + ' tests. ' + result.passed + ' passed, ' + result.failed + ' failed.');
-			window.qunitDone = result;
-		});
-	}, false );
-}
+				if (typeof window.callPhantom === 'function') {
+					window.callPhantom({
+						'name': 'QUnit.done',
+						'data': result
+					});
+				}
+			});
+		}, false);
+	}
+})();
diff --git a/profiles/commons/libraries/underscore/underscore-min.js b/profiles/commons/libraries/underscore/underscore-min.js
index c1d9d3a..d22f881 100644
--- a/profiles/commons/libraries/underscore/underscore-min.js
+++ b/profiles/commons/libraries/underscore/underscore-min.js
@@ -1 +1,6 @@
-(function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,d=e.filter,g=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,_=Object.keys,j=i.bind,w=function(n){return n instanceof w?n:this instanceof w?(this._wrapped=n,void 0):new w(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=w),exports._=w):n._=w,w.VERSION="1.4.4";var A=w.each=w.forEach=function(n,t,e){if(null!=n)if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a in n)if(w.has(n,a)&&t.call(e,n[a],a,n)===r)return};w.map=w.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e[e.length]=t.call(r,n,u,i)}),e)};var O="Reduce of empty array with no initial value";w.reduce=w.foldl=w.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=w.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(O);return r},w.reduceRight=w.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=w.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=w.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(O);return r},w.find=w.detect=function(n,t,r){var e;return E(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},w.filter=w.select=function(n,t,r){var e=[];return null==n?e:d&&n.filter===d?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&(e[e.length]=n)}),e)},w.reject=function(n,t,r){return w.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},w.every=w.all=function(n,t,e){t||(t=w.identity);var u=!0;return null==n?u:g&&n.every===g?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var E=w.some=w.any=function(n,t,e){t||(t=w.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};w.contains=w.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:E(n,function(n){return n===t})},w.invoke=function(n,t){var r=o.call(arguments,2),e=w.isFunction(t);return w.map(n,function(n){return(e?t:n[t]).apply(n,r)})},w.pluck=function(n,t){return w.map(n,function(n){return n[t]})},w.where=function(n,t,r){return w.isEmpty(t)?r?null:[]:w[r?"find":"filter"](n,function(n){for(var r in t)if(t[r]!==n[r])return!1;return!0})},w.findWhere=function(n,t){return w.where(n,t,!0)},w.max=function(n,t,r){if(!t&&w.isArray(n)&&n[0]===+n[0]&&65535>n.length)return Math.max.apply(Math,n);if(!t&&w.isEmpty(n))return-1/0;var e={computed:-1/0,value:-1/0};return A(n,function(n,u,i){var a=t?t.call(r,n,u,i):n;a>=e.computed&&(e={value:n,computed:a})}),e.value},w.min=function(n,t,r){if(!t&&w.isArray(n)&&n[0]===+n[0]&&65535>n.length)return Math.min.apply(Math,n);if(!t&&w.isEmpty(n))return 1/0;var e={computed:1/0,value:1/0};return A(n,function(n,u,i){var a=t?t.call(r,n,u,i):n;e.computed>a&&(e={value:n,computed:a})}),e.value},w.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=w.random(r++),e[r-1]=e[t],e[t]=n}),e};var k=function(n){return w.isFunction(n)?n:function(t){return t[n]}};w.sortBy=function(n,t,r){var e=k(t);return w.pluck(w.map(n,function(n,t,u){return{value:n,index:t,criteria:e.call(r,n,t,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index<t.index?-1:1}),"value")};var F=function(n,t,r,e){var u={},i=k(t||w.identity);return A(n,function(t,a){var o=i.call(r,t,a,n);e(u,o,t)}),u};w.groupBy=function(n,t,r){return F(n,t,r,function(n,t,r){(w.has(n,t)?n[t]:n[t]=[]).push(r)})},w.countBy=function(n,t,r){return F(n,t,r,function(n,t){w.has(n,t)||(n[t]=0),n[t]++})},w.sortedIndex=function(n,t,r,e){r=null==r?w.identity:k(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;u>r.call(e,n[o])?i=o+1:a=o}return i},w.toArray=function(n){return n?w.isArray(n)?o.call(n):n.length===+n.length?w.map(n,w.identity):w.values(n):[]},w.size=function(n){return null==n?0:n.length===+n.length?n.length:w.keys(n).length},w.first=w.head=w.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:o.call(n,0,t)},w.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},w.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},w.rest=w.tail=w.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},w.compact=function(n){return w.filter(n,w.identity)};var R=function(n,t,r){return A(n,function(n){w.isArray(n)?t?a.apply(r,n):R(n,t,r):r.push(n)}),r};w.flatten=function(n,t){return R(n,t,[])},w.without=function(n){return w.difference(n,o.call(arguments,1))},w.uniq=w.unique=function(n,t,r,e){w.isFunction(t)&&(e=r,r=t,t=!1);var u=r?w.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:w.contains(a,r))||(a.push(r),i.push(n[e]))}),i},w.union=function(){return w.uniq(c.apply(e,arguments))},w.intersection=function(n){var t=o.call(arguments,1);return w.filter(w.uniq(n),function(n){return w.every(t,function(t){return w.indexOf(t,n)>=0})})},w.difference=function(n){var t=c.apply(e,o.call(arguments,1));return w.filter(n,function(n){return!w.contains(t,n)})},w.zip=function(){for(var n=o.call(arguments),t=w.max(w.pluck(n,"length")),r=Array(t),e=0;t>e;e++)r[e]=w.pluck(n,""+e);return r},w.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},w.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=w.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},w.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},w.range=function(n,t,r){1>=arguments.length&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=Array(e);e>u;)i[u++]=n,n+=r;return i},w.bind=function(n,t){if(n.bind===j&&j)return j.apply(n,o.call(arguments,1));var r=o.call(arguments,2);return function(){return n.apply(t,r.concat(o.call(arguments)))}},w.partial=function(n){var t=o.call(arguments,1);return function(){return n.apply(this,t.concat(o.call(arguments)))}},w.bindAll=function(n){var t=o.call(arguments,1);return 0===t.length&&(t=w.functions(n)),A(t,function(t){n[t]=w.bind(n[t],n)}),n},w.memoize=function(n,t){var r={};return t||(t=w.identity),function(){var e=t.apply(this,arguments);return w.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},w.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},w.defer=function(n){return w.delay.apply(w,[n,1].concat(o.call(arguments,1)))},w.throttle=function(n,t){var r,e,u,i,a=0,o=function(){a=new Date,u=null,i=n.apply(r,e)};return function(){var c=new Date,l=t-(c-a);return r=this,e=arguments,0>=l?(clearTimeout(u),u=null,a=c,i=n.apply(r,e)):u||(u=setTimeout(o,l)),i}},w.debounce=function(n,t,r){var e,u;return function(){var i=this,a=arguments,o=function(){e=null,r||(u=n.apply(i,a))},c=r&&!e;return clearTimeout(e),e=setTimeout(o,t),c&&(u=n.apply(i,a)),u}},w.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},w.wrap=function(n,t){return function(){var r=[n];return a.apply(r,arguments),t.apply(this,r)}},w.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},w.after=function(n,t){return 0>=n?t():function(){return 1>--n?t.apply(this,arguments):void 0}},w.keys=_||function(n){if(n!==Object(n))throw new TypeError("Invalid object");var t=[];for(var r in n)w.has(n,r)&&(t[t.length]=r);return t},w.values=function(n){var t=[];for(var r in n)w.has(n,r)&&t.push(n[r]);return t},w.pairs=function(n){var t=[];for(var r in n)w.has(n,r)&&t.push([r,n[r]]);return t},w.invert=function(n){var t={};for(var r in n)w.has(n,r)&&(t[n[r]]=r);return t},w.functions=w.methods=function(n){var t=[];for(var r in n)w.isFunction(n[r])&&t.push(r);return t.sort()},w.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},w.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},w.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)w.contains(r,u)||(t[u]=n[u]);return t},w.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)null==n[r]&&(n[r]=t[r])}),n},w.clone=function(n){return w.isObject(n)?w.isArray(n)?n.slice():w.extend({},n):n},w.tap=function(n,t){return t(n),n};var I=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof w&&(n=n._wrapped),t instanceof w&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==t+"";case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;r.push(n),e.push(t);var a=0,o=!0;if("[object Array]"==u){if(a=n.length,o=a==t.length)for(;a--&&(o=I(n[a],t[a],r,e)););}else{var c=n.constructor,f=t.constructor;if(c!==f&&!(w.isFunction(c)&&c instanceof c&&w.isFunction(f)&&f instanceof f))return!1;for(var s in n)if(w.has(n,s)&&(a++,!(o=w.has(t,s)&&I(n[s],t[s],r,e))))break;if(o){for(s in t)if(w.has(t,s)&&!a--)break;o=!a}}return r.pop(),e.pop(),o};w.isEqual=function(n,t){return I(n,t,[],[])},w.isEmpty=function(n){if(null==n)return!0;if(w.isArray(n)||w.isString(n))return 0===n.length;for(var t in n)if(w.has(n,t))return!1;return!0},w.isElement=function(n){return!(!n||1!==n.nodeType)},w.isArray=x||function(n){return"[object Array]"==l.call(n)},w.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){w["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),w.isArguments(arguments)||(w.isArguments=function(n){return!(!n||!w.has(n,"callee"))}),"function"!=typeof/./&&(w.isFunction=function(n){return"function"==typeof n}),w.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},w.isNaN=function(n){return w.isNumber(n)&&n!=+n},w.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},w.isNull=function(n){return null===n},w.isUndefined=function(n){return n===void 0},w.has=function(n,t){return f.call(n,t)},w.noConflict=function(){return n._=t,this},w.identity=function(n){return n},w.times=function(n,t,r){for(var e=Array(n),u=0;n>u;u++)e[u]=t.call(r,u);return e},w.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))};var M={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};M.unescape=w.invert(M.escape);var S={escape:RegExp("["+w.keys(M.escape).join("")+"]","g"),unescape:RegExp("("+w.keys(M.unescape).join("|")+")","g")};w.each(["escape","unescape"],function(n){w[n]=function(t){return null==t?"":(""+t).replace(S[n],function(t){return M[n][t]})}}),w.result=function(n,t){if(null==n)return null;var r=n[t];return w.isFunction(r)?r.call(n):r},w.mixin=function(n){A(w.functions(n),function(t){var r=w[t]=n[t];w.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),D.call(this,r.apply(w,n))}})};var N=0;w.uniqueId=function(n){var t=++N+"";return n?n+t:t},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var T=/(.)^/,q={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},B=/\\|'|\r|\n|\t|\u2028|\u2029/g;w.template=function(n,t,r){var e;r=w.defaults({},r,w.templateSettings);var u=RegExp([(r.escape||T).source,(r.interpolate||T).source,(r.evaluate||T).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(B,function(n){return"\\"+q[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,w);var c=function(n){return e.call(this,n,w)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},w.chain=function(n){return w(n).chain()};var D=function(n){return this._chain?w(n).chain():n};w.mixin(w),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];w.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],D.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];w.prototype[n]=function(){return D.call(this,t.apply(this._wrapped,arguments))}}),w.extend(w.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this);
\ No newline at end of file
+//     Underscore.js 1.5.2
+//     http://underscorejs.org
+//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
+//     Underscore may be freely distributed under the MIT license.
+(function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,g=e.filter,d=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,w=Object.keys,_=i.bind,j=function(n){return n instanceof j?n:this instanceof j?(this._wrapped=n,void 0):new j(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=j),exports._=j):n._=j,j.VERSION="1.5.2";var A=j.each=j.forEach=function(n,t,e){if(null!=n)if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a=j.keys(n),u=0,i=a.length;i>u;u++)if(t.call(e,n[a[u]],a[u],n)===r)return};j.map=j.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e.push(t.call(r,n,u,i))}),e)};var E="Reduce of empty array with no initial value";j.reduce=j.foldl=j.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=j.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(E);return r},j.reduceRight=j.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=j.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=j.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(E);return r},j.find=j.detect=function(n,t,r){var e;return O(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},j.filter=j.select=function(n,t,r){var e=[];return null==n?e:g&&n.filter===g?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&e.push(n)}),e)},j.reject=function(n,t,r){return j.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},j.every=j.all=function(n,t,e){t||(t=j.identity);var u=!0;return null==n?u:d&&n.every===d?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var O=j.some=j.any=function(n,t,e){t||(t=j.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};j.contains=j.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:O(n,function(n){return n===t})},j.invoke=function(n,t){var r=o.call(arguments,2),e=j.isFunction(t);return j.map(n,function(n){return(e?t:n[t]).apply(n,r)})},j.pluck=function(n,t){return j.map(n,function(n){return n[t]})},j.where=function(n,t,r){return j.isEmpty(t)?r?void 0:[]:j[r?"find":"filter"](n,function(n){for(var r in t)if(t[r]!==n[r])return!1;return!0})},j.findWhere=function(n,t){return j.where(n,t,!0)},j.max=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);if(!t&&j.isEmpty(n))return-1/0;var e={computed:-1/0,value:-1/0};return A(n,function(n,u,i){var a=t?t.call(r,n,u,i):n;a>e.computed&&(e={value:n,computed:a})}),e.value},j.min=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);if(!t&&j.isEmpty(n))return 1/0;var e={computed:1/0,value:1/0};return A(n,function(n,u,i){var a=t?t.call(r,n,u,i):n;a<e.computed&&(e={value:n,computed:a})}),e.value},j.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=j.random(r++),e[r-1]=e[t],e[t]=n}),e},j.sample=function(n,t,r){return arguments.length<2||r?n[j.random(n.length-1)]:j.shuffle(n).slice(0,Math.max(0,t))};var k=function(n){return j.isFunction(n)?n:function(t){return t[n]}};j.sortBy=function(n,t,r){var e=k(t);return j.pluck(j.map(n,function(n,t,u){return{value:n,index:t,criteria:e.call(r,n,t,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var F=function(n){return function(t,r,e){var u={},i=null==r?j.identity:k(r);return A(t,function(r,a){var o=i.call(e,r,a,t);n(u,o,r)}),u}};j.groupBy=F(function(n,t,r){(j.has(n,t)?n[t]:n[t]=[]).push(r)}),j.indexBy=F(function(n,t,r){n[t]=r}),j.countBy=F(function(n,t){j.has(n,t)?n[t]++:n[t]=1}),j.sortedIndex=function(n,t,r,e){r=null==r?j.identity:k(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;r.call(e,n[o])<u?i=o+1:a=o}return i},j.toArray=function(n){return n?j.isArray(n)?o.call(n):n.length===+n.length?j.map(n,j.identity):j.values(n):[]},j.size=function(n){return null==n?0:n.length===+n.length?n.length:j.keys(n).length},j.first=j.head=j.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:o.call(n,0,t)},j.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},j.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},j.rest=j.tail=j.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},j.compact=function(n){return j.filter(n,j.identity)};var M=function(n,t,r){return t&&j.every(n,j.isArray)?c.apply(r,n):(A(n,function(n){j.isArray(n)||j.isArguments(n)?t?a.apply(r,n):M(n,t,r):r.push(n)}),r)};j.flatten=function(n,t){return M(n,t,[])},j.without=function(n){return j.difference(n,o.call(arguments,1))},j.uniq=j.unique=function(n,t,r,e){j.isFunction(t)&&(e=r,r=t,t=!1);var u=r?j.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:j.contains(a,r))||(a.push(r),i.push(n[e]))}),i},j.union=function(){return j.uniq(j.flatten(arguments,!0))},j.intersection=function(n){var t=o.call(arguments,1);return j.filter(j.uniq(n),function(n){return j.every(t,function(t){return j.indexOf(t,n)>=0})})},j.difference=function(n){var t=c.apply(e,o.call(arguments,1));return j.filter(n,function(n){return!j.contains(t,n)})},j.zip=function(){for(var n=j.max(j.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=j.pluck(arguments,""+r);return t},j.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},j.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=j.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},j.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},j.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=new Array(e);e>u;)i[u++]=n,n+=r;return i};var R=function(){};j.bind=function(n,t){var r,e;if(_&&n.bind===_)return _.apply(n,o.call(arguments,1));if(!j.isFunction(n))throw new TypeError;return r=o.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(o.call(arguments)));R.prototype=n.prototype;var u=new R;R.prototype=null;var i=n.apply(u,r.concat(o.call(arguments)));return Object(i)===i?i:u}},j.partial=function(n){var t=o.call(arguments,1);return function(){return n.apply(this,t.concat(o.call(arguments)))}},j.bindAll=function(n){var t=o.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=j.bind(n[t],n)}),n},j.memoize=function(n,t){var r={};return t||(t=j.identity),function(){var e=t.apply(this,arguments);return j.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},j.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},j.defer=function(n){return j.delay.apply(j,[n,1].concat(o.call(arguments,1)))},j.throttle=function(n,t,r){var e,u,i,a=null,o=0;r||(r={});var c=function(){o=r.leading===!1?0:new Date,a=null,i=n.apply(e,u)};return function(){var l=new Date;o||r.leading!==!1||(o=l);var f=t-(l-o);return e=this,u=arguments,0>=f?(clearTimeout(a),a=null,o=l,i=n.apply(e,u)):a||r.trailing===!1||(a=setTimeout(c,f)),i}},j.debounce=function(n,t,r){var e,u,i,a,o;return function(){i=this,u=arguments,a=new Date;var c=function(){var l=new Date-a;t>l?e=setTimeout(c,t-l):(e=null,r||(o=n.apply(i,u)))},l=r&&!e;return e||(e=setTimeout(c,t)),l&&(o=n.apply(i,u)),o}},j.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},j.wrap=function(n,t){return function(){var r=[n];return a.apply(r,arguments),t.apply(this,r)}},j.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},j.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},j.keys=w||function(n){if(n!==Object(n))throw new TypeError("Invalid object");var t=[];for(var r in n)j.has(n,r)&&t.push(r);return t},j.values=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},j.pairs=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},j.invert=function(n){for(var t={},r=j.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},j.functions=j.methods=function(n){var t=[];for(var r in n)j.isFunction(n[r])&&t.push(r);return t.sort()},j.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},j.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},j.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)j.contains(r,u)||(t[u]=n[u]);return t},j.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]===void 0&&(n[r]=t[r])}),n},j.clone=function(n){return j.isObject(n)?j.isArray(n)?n.slice():j.extend({},n):n},j.tap=function(n,t){return t(n),n};var S=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof j&&(n=n._wrapped),t instanceof j&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;var a=n.constructor,o=t.constructor;if(a!==o&&!(j.isFunction(a)&&a instanceof a&&j.isFunction(o)&&o instanceof o))return!1;r.push(n),e.push(t);var c=0,f=!0;if("[object Array]"==u){if(c=n.length,f=c==t.length)for(;c--&&(f=S(n[c],t[c],r,e)););}else{for(var s in n)if(j.has(n,s)&&(c++,!(f=j.has(t,s)&&S(n[s],t[s],r,e))))break;if(f){for(s in t)if(j.has(t,s)&&!c--)break;f=!c}}return r.pop(),e.pop(),f};j.isEqual=function(n,t){return S(n,t,[],[])},j.isEmpty=function(n){if(null==n)return!0;if(j.isArray(n)||j.isString(n))return 0===n.length;for(var t in n)if(j.has(n,t))return!1;return!0},j.isElement=function(n){return!(!n||1!==n.nodeType)},j.isArray=x||function(n){return"[object Array]"==l.call(n)},j.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){j["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),j.isArguments(arguments)||(j.isArguments=function(n){return!(!n||!j.has(n,"callee"))}),"function"!=typeof/./&&(j.isFunction=function(n){return"function"==typeof n}),j.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},j.isNaN=function(n){return j.isNumber(n)&&n!=+n},j.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},j.isNull=function(n){return null===n},j.isUndefined=function(n){return n===void 0},j.has=function(n,t){return f.call(n,t)},j.noConflict=function(){return n._=t,this},j.identity=function(n){return n},j.times=function(n,t,r){for(var e=Array(Math.max(0,n)),u=0;n>u;u++)e[u]=t.call(r,u);return e},j.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))};var I={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};I.unescape=j.invert(I.escape);var T={escape:new RegExp("["+j.keys(I.escape).join("")+"]","g"),unescape:new RegExp("("+j.keys(I.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(n){j[n]=function(t){return null==t?"":(""+t).replace(T[n],function(t){return I[n][t]})}}),j.result=function(n,t){if(null==n)return void 0;var r=n[t];return j.isFunction(r)?r.call(n):r},j.mixin=function(n){A(j.functions(n),function(t){var r=j[t]=n[t];j.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),z.call(this,r.apply(j,n))}})};var N=0;j.uniqueId=function(n){var t=++N+"";return n?n+t:t},j.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var q=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;j.template=function(n,t,r){var e;r=j.defaults({},r,j.templateSettings);var u=new RegExp([(r.escape||q).source,(r.interpolate||q).source,(r.evaluate||q).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(D,function(n){return"\\"+B[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=new Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,j);var c=function(n){return e.call(this,n,j)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},j.chain=function(n){return j(n).chain()};var z=function(n){return this._chain?j(n).chain():n};j.mixin(j),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];j.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],z.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];j.prototype[n]=function(){return z.call(this,t.apply(this._wrapped,arguments))}}),j.extend(j.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this);
+//# sourceMappingURL=underscore-min.map
\ No newline at end of file
diff --git a/profiles/commons/libraries/underscore/underscore-min.map b/profiles/commons/libraries/underscore/underscore-min.map
new file mode 100644
index 0000000..4fbe0ba
--- /dev/null
+++ b/profiles/commons/libraries/underscore/underscore-min.map
@@ -0,0 +1 @@
+{"version":3,"file":"underscore-min.js","sources":["underscore.js"],"names":["root","this","previousUnderscore","_","breaker","ArrayProto","Array","prototype","ObjProto","Object","FuncProto","Function","push","slice","concat","toString","hasOwnProperty","nativeForEach","forEach","nativeMap","map","nativeReduce","reduce","nativeReduceRight","reduceRight","nativeFilter","filter","nativeEvery","every","nativeSome","some","nativeIndexOf","indexOf","nativeLastIndexOf","lastIndexOf","nativeIsArray","isArray","nativeKeys","keys","nativeBind","bind","obj","_wrapped","exports","module","VERSION","each","iterator","context","length","i","call","collect","results","value","index","list","reduceError","foldl","inject","memo","initial","arguments","TypeError","foldr","find","detect","result","any","select","reject","all","identity","contains","include","target","invoke","method","args","isFunc","isFunction","apply","pluck","key","where","attrs","first","isEmpty","findWhere","max","Math","Infinity","computed","min","shuffle","rand","shuffled","random","sample","n","guard","lookupIterator","sortBy","criteria","sort","left","right","a","b","group","behavior","groupBy","has","indexBy","countBy","sortedIndex","array","low","high","mid","toArray","values","size","head","take","last","rest","tail","drop","compact","flatten","input","shallow","output","isArguments","without","difference","uniq","unique","isSorted","seen","union","intersection","item","other","zip","object","from","hasIndex","range","start","stop","step","ceil","idx","ctor","func","bound","self","partial","bindAll","funcs","Error","f","memoize","hasher","delay","wait","setTimeout","defer","throttle","options","timeout","previous","later","leading","Date","now","remaining","clearTimeout","trailing","debounce","immediate","timestamp","callNow","once","ran","wrap","wrapper","compose","after","times","pairs","invert","functions","methods","names","extend","source","prop","pick","copy","omit","defaults","clone","isObject","tap","interceptor","eq","aStack","bStack","className","String","global","multiline","ignoreCase","aCtor","constructor","bCtor","pop","isEqual","isString","isElement","nodeType","name","isFinite","isNaN","parseFloat","isNumber","isBoolean","isNull","isUndefined","noConflict","accum","floor","entityMap","escape","&","<",">","\"","'","unescape","entityRegexes","RegExp","join","string","replace","match","property","mixin","idCounter","uniqueId","prefix","id","templateSettings","evaluate","interpolate","noMatch","escapes","\\","\r","\n","\t"," "," ","escaper","template","text","data","settings","render","matcher","offset","variable","e","chain","_chain"],"mappings":";;;;CAKA,WAME,GAAIA,GAAOC,KAGPC,EAAqBF,EAAKG,EAG1BC,KAGAC,EAAaC,MAAMC,UAAWC,EAAWC,OAAOF,UAAWG,EAAYC,SAASJ,UAIlFK,EAAmBP,EAAWO,KAC9BC,EAAmBR,EAAWQ,MAC9BC,EAAmBT,EAAWS,OAC9BC,EAAmBP,EAASO,SAC5BC,EAAmBR,EAASQ,eAK5BC,EAAqBZ,EAAWa,QAChCC,EAAqBd,EAAWe,IAChCC,EAAqBhB,EAAWiB,OAChCC,EAAqBlB,EAAWmB,YAChCC,EAAqBpB,EAAWqB,OAChCC,EAAqBtB,EAAWuB,MAChCC,EAAqBxB,EAAWyB,KAChCC,EAAqB1B,EAAW2B,QAChCC,EAAqB5B,EAAW6B,YAChCC,EAAqB7B,MAAM8B,QAC3BC,EAAqB5B,OAAO6B,KAC5BC,EAAqB7B,EAAU8B,KAG7BrC,EAAI,SAASsC,GACf,MAAIA,aAAetC,GAAUsC,EACvBxC,eAAgBE,IACtBF,KAAKyC,SAAWD,EAAhBxC,QADiC,GAAIE,GAAEsC,GAQlB,oBAAZE,UACa,mBAAXC,SAA0BA,OAAOD,UAC1CA,QAAUC,OAAOD,QAAUxC,GAE7BwC,QAAQxC,EAAIA,GAEZH,EAAKG,EAAIA,EAIXA,EAAE0C,QAAU,OAQZ,IAAIC,GAAO3C,EAAE2C,KAAO3C,EAAEe,QAAU,SAASuB,EAAKM,EAAUC,GACtD,GAAW,MAAPP,EACJ,GAAIxB,GAAiBwB,EAAIvB,UAAYD,EACnCwB,EAAIvB,QAAQ6B,EAAUC,OACjB,IAAIP,EAAIQ,UAAYR,EAAIQ,QAC7B,IAAK,GAAIC,GAAI,EAAGD,EAASR,EAAIQ,OAAYA,EAAJC,EAAYA,IAC/C,GAAIH,EAASI,KAAKH,EAASP,EAAIS,GAAIA,EAAGT,KAASrC,EAAS,WAI1D,KAAK,GADDkC,GAAOnC,EAAEmC,KAAKG,GACTS,EAAI,EAAGD,EAASX,EAAKW,OAAYA,EAAJC,EAAYA,IAChD,GAAIH,EAASI,KAAKH,EAASP,EAAIH,EAAKY,IAAKZ,EAAKY,GAAIT,KAASrC,EAAS,OAO1ED,GAAEiB,IAAMjB,EAAEiD,QAAU,SAASX,EAAKM,EAAUC,GAC1C,GAAIK,KACJ,OAAW,OAAPZ,EAAoBY,EACpBlC,GAAasB,EAAIrB,MAAQD,EAAkBsB,EAAIrB,IAAI2B,EAAUC,IACjEF,EAAKL,EAAK,SAASa,EAAOC,EAAOC,GAC/BH,EAAQzC,KAAKmC,EAASI,KAAKH,EAASM,EAAOC,EAAOC,MAE7CH,GAGT,IAAII,GAAc,6CAIlBtD,GAAEmB,OAASnB,EAAEuD,MAAQvD,EAAEwD,OAAS,SAASlB,EAAKM,EAAUa,EAAMZ,GAC5D,GAAIa,GAAUC,UAAUb,OAAS,CAEjC,IADW,MAAPR,IAAaA,MACbpB,GAAgBoB,EAAInB,SAAWD,EAEjC,MADI2B,KAASD,EAAW5C,EAAEqC,KAAKO,EAAUC,IAClCa,EAAUpB,EAAInB,OAAOyB,EAAUa,GAAQnB,EAAInB,OAAOyB,EAU3D,IARAD,EAAKL,EAAK,SAASa,EAAOC,EAAOC,GAC1BK,EAIHD,EAAOb,EAASI,KAAKH,EAASY,EAAMN,EAAOC,EAAOC,IAHlDI,EAAON,EACPO,GAAU,MAKTA,EAAS,KAAM,IAAIE,WAAUN,EAClC,OAAOG,IAKTzD,EAAEqB,YAAcrB,EAAE6D,MAAQ,SAASvB,EAAKM,EAAUa,EAAMZ,GACtD,GAAIa,GAAUC,UAAUb,OAAS,CAEjC,IADW,MAAPR,IAAaA,MACblB,GAAqBkB,EAAIjB,cAAgBD,EAE3C,MADIyB,KAASD,EAAW5C,EAAEqC,KAAKO,EAAUC,IAClCa,EAAUpB,EAAIjB,YAAYuB,EAAUa,GAAQnB,EAAIjB,YAAYuB,EAErE,IAAIE,GAASR,EAAIQ,MACjB,IAAIA,KAAYA,EAAQ,CACtB,GAAIX,GAAOnC,EAAEmC,KAAKG,EAClBQ,GAASX,EAAKW,OAWhB,GATAH,EAAKL,EAAK,SAASa,EAAOC,EAAOC,GAC/BD,EAAQjB,EAAOA,IAAOW,KAAYA,EAC7BY,EAIHD,EAAOb,EAASI,KAAKH,EAASY,EAAMnB,EAAIc,GAAQA,EAAOC,IAHvDI,EAAOnB,EAAIc,GACXM,GAAU,MAKTA,EAAS,KAAM,IAAIE,WAAUN,EAClC,OAAOG,IAITzD,EAAE8D,KAAO9D,EAAE+D,OAAS,SAASzB,EAAKM,EAAUC,GAC1C,GAAImB,EAOJ,OANAC,GAAI3B,EAAK,SAASa,EAAOC,EAAOC,GAC9B,MAAIT,GAASI,KAAKH,EAASM,EAAOC,EAAOC,IACvCW,EAASb,GACF,GAFT,SAKKa,GAMThE,EAAEuB,OAASvB,EAAEkE,OAAS,SAAS5B,EAAKM,EAAUC,GAC5C,GAAIK,KACJ,OAAW,OAAPZ,EAAoBY,EACpB5B,GAAgBgB,EAAIf,SAAWD,EAAqBgB,EAAIf,OAAOqB,EAAUC,IAC7EF,EAAKL,EAAK,SAASa,EAAOC,EAAOC,GAC3BT,EAASI,KAAKH,EAASM,EAAOC,EAAOC,IAAOH,EAAQzC,KAAK0C,KAExDD,IAITlD,EAAEmE,OAAS,SAAS7B,EAAKM,EAAUC,GACjC,MAAO7C,GAAEuB,OAAOe,EAAK,SAASa,EAAOC,EAAOC,GAC1C,OAAQT,EAASI,KAAKH,EAASM,EAAOC,EAAOC,IAC5CR,IAML7C,EAAEyB,MAAQzB,EAAEoE,IAAM,SAAS9B,EAAKM,EAAUC,GACxCD,IAAaA,EAAW5C,EAAEqE,SAC1B,IAAIL,IAAS,CACb,OAAW,OAAP1B,EAAoB0B,EACpBxC,GAAec,EAAIb,QAAUD,EAAoBc,EAAIb,MAAMmB,EAAUC,IACzEF,EAAKL,EAAK,SAASa,EAAOC,EAAOC,GAC/B,OAAMW,EAASA,GAAUpB,EAASI,KAAKH,EAASM,EAAOC,EAAOC,IAA9D,OAA6EpD,MAEtE+D,GAMX,IAAIC,GAAMjE,EAAE2B,KAAO3B,EAAEiE,IAAM,SAAS3B,EAAKM,EAAUC,GACjDD,IAAaA,EAAW5C,EAAEqE,SAC1B,IAAIL,IAAS,CACb,OAAW,OAAP1B,EAAoB0B,EACpBtC,GAAcY,EAAIX,OAASD,EAAmBY,EAAIX,KAAKiB,EAAUC,IACrEF,EAAKL,EAAK,SAASa,EAAOC,EAAOC,GAC/B,MAAIW,KAAWA,EAASpB,EAASI,KAAKH,EAASM,EAAOC,EAAOC,IAAepD,EAA5E,WAEO+D,GAKXhE,GAAEsE,SAAWtE,EAAEuE,QAAU,SAASjC,EAAKkC,GACrC,MAAW,OAAPlC,GAAoB,EACpBV,GAAiBU,EAAIT,UAAYD,EAAsBU,EAAIT,QAAQ2C,KAAY,EAC5EP,EAAI3B,EAAK,SAASa,GACvB,MAAOA,KAAUqB,KAKrBxE,EAAEyE,OAAS,SAASnC,EAAKoC,GACvB,GAAIC,GAAOjE,EAAMsC,KAAKW,UAAW,GAC7BiB,EAAS5E,EAAE6E,WAAWH,EAC1B,OAAO1E,GAAEiB,IAAIqB,EAAK,SAASa,GACzB,OAAQyB,EAASF,EAASvB,EAAMuB,IAASI,MAAM3B,EAAOwB,MAK1D3E,EAAE+E,MAAQ,SAASzC,EAAK0C,GACtB,MAAOhF,GAAEiB,IAAIqB,EAAK,SAASa,GAAQ,MAAOA,GAAM6B,MAKlDhF,EAAEiF,MAAQ,SAAS3C,EAAK4C,EAAOC,GAC7B,MAAInF,GAAEoF,QAAQF,GAAeC,MAAa,MACnCnF,EAAEmF,EAAQ,OAAS,UAAU7C,EAAK,SAASa,GAChD,IAAK,GAAI6B,KAAOE,GACd,GAAIA,EAAMF,KAAS7B,EAAM6B,GAAM,OAAO,CAExC,QAAO,KAMXhF,EAAEqF,UAAY,SAAS/C,EAAK4C,GAC1B,MAAOlF,GAAEiF,MAAM3C,EAAK4C,GAAO,IAM7BlF,EAAEsF,IAAM,SAAShD,EAAKM,EAAUC,GAC9B,IAAKD,GAAY5C,EAAEiC,QAAQK,IAAQA,EAAI,MAAQA,EAAI,IAAMA,EAAIQ,OAAS,MACpE,MAAOyC,MAAKD,IAAIR,MAAMS,KAAMjD,EAE9B,KAAKM,GAAY5C,EAAEoF,QAAQ9C,GAAM,OAAQkD,GACzC,IAAIxB,IAAUyB,UAAYD,IAAUrC,OAAQqC,IAK5C,OAJA7C,GAAKL,EAAK,SAASa,EAAOC,EAAOC,GAC/B,GAAIoC,GAAW7C,EAAWA,EAASI,KAAKH,EAASM,EAAOC,EAAOC,GAAQF,CACvEsC,GAAWzB,EAAOyB,WAAazB,GAAUb,MAAQA,EAAOsC,SAAWA,MAE9DzB,EAAOb,OAIhBnD,EAAE0F,IAAM,SAASpD,EAAKM,EAAUC,GAC9B,IAAKD,GAAY5C,EAAEiC,QAAQK,IAAQA,EAAI,MAAQA,EAAI,IAAMA,EAAIQ,OAAS,MACpE,MAAOyC,MAAKG,IAAIZ,MAAMS,KAAMjD,EAE9B,KAAKM,GAAY5C,EAAEoF,QAAQ9C,GAAM,MAAOkD,IACxC,IAAIxB,IAAUyB,SAAWD,IAAUrC,MAAOqC,IAK1C,OAJA7C,GAAKL,EAAK,SAASa,EAAOC,EAAOC,GAC/B,GAAIoC,GAAW7C,EAAWA,EAASI,KAAKH,EAASM,EAAOC,EAAOC,GAAQF,CACvEsC,GAAWzB,EAAOyB,WAAazB,GAAUb,MAAQA,EAAOsC,SAAWA,MAE9DzB,EAAOb,OAKhBnD,EAAE2F,QAAU,SAASrD,GACnB,GAAIsD,GACAxC,EAAQ,EACRyC,IAMJ,OALAlD,GAAKL,EAAK,SAASa,GACjByC,EAAO5F,EAAE8F,OAAO1C,KAChByC,EAASzC,EAAQ,GAAKyC,EAASD,GAC/BC,EAASD,GAAQzC,IAEZ0C,GAMT7F,EAAE+F,OAAS,SAASzD,EAAK0D,EAAGC,GAC1B,MAAItC,WAAUb,OAAS,GAAKmD,EACnB3D,EAAItC,EAAE8F,OAAOxD,EAAIQ,OAAS,IAE5B9C,EAAE2F,QAAQrD,GAAK5B,MAAM,EAAG6E,KAAKD,IAAI,EAAGU,IAI7C,IAAIE,GAAiB,SAAS/C,GAC5B,MAAOnD,GAAE6E,WAAW1B,GAASA,EAAQ,SAASb,GAAM,MAAOA,GAAIa,IAIjEnD,GAAEmG,OAAS,SAAS7D,EAAKa,EAAON,GAC9B,GAAID,GAAWsD,EAAe/C,EAC9B,OAAOnD,GAAE+E,MAAM/E,EAAEiB,IAAIqB,EAAK,SAASa,EAAOC,EAAOC,GAC/C,OACEF,MAAOA,EACPC,MAAOA,EACPgD,SAAUxD,EAASI,KAAKH,EAASM,EAAOC,EAAOC,MAEhDgD,KAAK,SAASC,EAAMC,GACrB,GAAIC,GAAIF,EAAKF,SACTK,EAAIF,EAAMH,QACd,IAAII,IAAMC,EAAG,CACX,GAAID,EAAIC,GAAKD,QAAW,GAAG,MAAO,EAClC,IAAQC,EAAJD,GAASC,QAAW,GAAG,OAAQ,EAErC,MAAOH,GAAKlD,MAAQmD,EAAMnD,QACxB,SAIN,IAAIsD,GAAQ,SAASC,GACnB,MAAO,UAASrE,EAAKa,EAAON,GAC1B,GAAImB,MACApB,EAAoB,MAATO,EAAgBnD,EAAEqE,SAAW6B,EAAe/C,EAK3D,OAJAR,GAAKL,EAAK,SAASa,EAAOC,GACxB,GAAI4B,GAAMpC,EAASI,KAAKH,EAASM,EAAOC,EAAOd,EAC/CqE,GAAS3C,EAAQgB,EAAK7B,KAEjBa,GAMXhE,GAAE4G,QAAUF,EAAM,SAAS1C,EAAQgB,EAAK7B,IACrCnD,EAAE6G,IAAI7C,EAAQgB,GAAOhB,EAAOgB,GAAQhB,EAAOgB,OAAYvE,KAAK0C,KAK/DnD,EAAE8G,QAAUJ,EAAM,SAAS1C,EAAQgB,EAAK7B,GACtCa,EAAOgB,GAAO7B,IAMhBnD,EAAE+G,QAAUL,EAAM,SAAS1C,EAAQgB,GACjChF,EAAE6G,IAAI7C,EAAQgB,GAAOhB,EAAOgB,KAAShB,EAAOgB,GAAO,IAKrDhF,EAAEgH,YAAc,SAASC,EAAO3E,EAAKM,EAAUC,GAC7CD,EAAuB,MAAZA,EAAmB5C,EAAEqE,SAAW6B,EAAetD,EAG1D,KAFA,GAAIO,GAAQP,EAASI,KAAKH,EAASP,GAC/B4E,EAAM,EAAGC,EAAOF,EAAMnE,OACbqE,EAAND,GAAY,CACjB,GAAIE,GAAOF,EAAMC,IAAU,CAC3BvE,GAASI,KAAKH,EAASoE,EAAMG,IAAQjE,EAAQ+D,EAAME,EAAM,EAAID,EAAOC,EAEtE,MAAOF,IAITlH,EAAEqH,QAAU,SAAS/E,GACnB,MAAKA,GACDtC,EAAEiC,QAAQK,GAAa5B,EAAMsC,KAAKV,GAClCA,EAAIQ,UAAYR,EAAIQ,OAAe9C,EAAEiB,IAAIqB,EAAKtC,EAAEqE,UAC7CrE,EAAEsH,OAAOhF,OAIlBtC,EAAEuH,KAAO,SAASjF,GAChB,MAAW,OAAPA,EAAoB,EAChBA,EAAIQ,UAAYR,EAAIQ,OAAUR,EAAIQ,OAAS9C,EAAEmC,KAAKG,GAAKQ,QASjE9C,EAAEmF,MAAQnF,EAAEwH,KAAOxH,EAAEyH,KAAO,SAASR,EAAOjB,EAAGC,GAC7C,MAAa,OAATgB,MAA2B,GAClB,MAALjB,GAAcC,EAAQgB,EAAM,GAAKvG,EAAMsC,KAAKiE,EAAO,EAAGjB,IAOhEhG,EAAE0D,QAAU,SAASuD,EAAOjB,EAAGC,GAC7B,MAAOvF,GAAMsC,KAAKiE,EAAO,EAAGA,EAAMnE,QAAgB,MAALkD,GAAcC,EAAQ,EAAID,KAKzEhG,EAAE0H,KAAO,SAAST,EAAOjB,EAAGC,GAC1B,MAAa,OAATgB,MAA2B,GACrB,MAALjB,GAAcC,EACVgB,EAAMA,EAAMnE,OAAS,GAErBpC,EAAMsC,KAAKiE,EAAO1B,KAAKD,IAAI2B,EAAMnE,OAASkD,EAAG,KAQxDhG,EAAE2H,KAAO3H,EAAE4H,KAAO5H,EAAE6H,KAAO,SAASZ,EAAOjB,EAAGC,GAC5C,MAAOvF,GAAMsC,KAAKiE,EAAa,MAALjB,GAAcC,EAAQ,EAAID,IAItDhG,EAAE8H,QAAU,SAASb,GACnB,MAAOjH,GAAEuB,OAAO0F,EAAOjH,EAAEqE,UAI3B,IAAI0D,GAAU,SAASC,EAAOC,EAASC,GACrC,MAAID,IAAWjI,EAAEyB,MAAMuG,EAAOhI,EAAEiC,SACvBtB,EAAOmE,MAAMoD,EAAQF,IAE9BrF,EAAKqF,EAAO,SAAS7E,GACfnD,EAAEiC,QAAQkB,IAAUnD,EAAEmI,YAAYhF,GACpC8E,EAAUxH,EAAKqE,MAAMoD,EAAQ/E,GAAS4E,EAAQ5E,EAAO8E,EAASC,GAE9DA,EAAOzH,KAAK0C,KAGT+E,GAITlI,GAAE+H,QAAU,SAASd,EAAOgB,GAC1B,MAAOF,GAAQd,EAAOgB,OAIxBjI,EAAEoI,QAAU,SAASnB,GACnB,MAAOjH,GAAEqI,WAAWpB,EAAOvG,EAAMsC,KAAKW,UAAW,KAMnD3D,EAAEsI,KAAOtI,EAAEuI,OAAS,SAAStB,EAAOuB,EAAU5F,EAAUC,GAClD7C,EAAE6E,WAAW2D,KACf3F,EAAUD,EACVA,EAAW4F,EACXA,GAAW,EAEb,IAAI9E,GAAUd,EAAW5C,EAAEiB,IAAIgG,EAAOrE,EAAUC,GAAWoE,EACvD/D,KACAuF,IAOJ,OANA9F,GAAKe,EAAS,SAASP,EAAOC,IACxBoF,EAAapF,GAASqF,EAAKA,EAAK3F,OAAS,KAAOK,EAAUnD,EAAEsE,SAASmE,EAAMtF,MAC7EsF,EAAKhI,KAAK0C,GACVD,EAAQzC,KAAKwG,EAAM7D,OAGhBF,GAKTlD,EAAE0I,MAAQ,WACR,MAAO1I,GAAEsI,KAAKtI,EAAE+H,QAAQpE,WAAW,KAKrC3D,EAAE2I,aAAe,SAAS1B,GACxB,GAAIU,GAAOjH,EAAMsC,KAAKW,UAAW,EACjC,OAAO3D,GAAEuB,OAAOvB,EAAEsI,KAAKrB,GAAQ,SAAS2B,GACtC,MAAO5I,GAAEyB,MAAMkG,EAAM,SAASkB,GAC5B,MAAO7I,GAAE6B,QAAQgH,EAAOD,IAAS,OAOvC5I,EAAEqI,WAAa,SAASpB,GACtB,GAAIU,GAAOhH,EAAOmE,MAAM5E,EAAYQ,EAAMsC,KAAKW,UAAW,GAC1D,OAAO3D,GAAEuB,OAAO0F,EAAO,SAAS9D,GAAQ,OAAQnD,EAAEsE,SAASqD,EAAMxE,MAKnEnD,EAAE8I,IAAM,WAGN,IAAK,GAFDhG,GAAS9C,EAAEsF,IAAItF,EAAE+E,MAAMpB,UAAW,UAAUhD,OAAO,IACnDuC,EAAU,GAAI/C,OAAM2C,GACfC,EAAI,EAAOD,EAAJC,EAAYA,IAC1BG,EAAQH,GAAK/C,EAAE+E,MAAMpB,UAAW,GAAKZ,EAEvC,OAAOG,IAMTlD,EAAE+I,OAAS,SAAS1F,EAAMiE,GACxB,GAAY,MAARjE,EAAc,QAElB,KAAK,GADDW,MACKjB,EAAI,EAAGD,EAASO,EAAKP,OAAYA,EAAJC,EAAYA,IAC5CuE,EACFtD,EAAOX,EAAKN,IAAMuE,EAAOvE,GAEzBiB,EAAOX,EAAKN,GAAG,IAAMM,EAAKN,GAAG,EAGjC,OAAOiB,IASThE,EAAE6B,QAAU,SAASoF,EAAO2B,EAAMJ,GAChC,GAAa,MAATvB,EAAe,OAAQ,CAC3B,IAAIlE,GAAI,EAAGD,EAASmE,EAAMnE,MAC1B,IAAI0F,EAAU,CACZ,GAAuB,gBAAZA,GAIT,MADAzF,GAAI/C,EAAEgH,YAAYC,EAAO2B,GAClB3B,EAAMlE,KAAO6F,EAAO7F,GAAK,CAHhCA,GAAgB,EAAXyF,EAAejD,KAAKD,IAAI,EAAGxC,EAAS0F,GAAYA,EAMzD,GAAI5G,GAAiBqF,EAAMpF,UAAYD,EAAe,MAAOqF,GAAMpF,QAAQ+G,EAAMJ,EACjF,MAAW1F,EAAJC,EAAYA,IAAK,GAAIkE,EAAMlE,KAAO6F,EAAM,MAAO7F,EACtD,QAAQ,GAIV/C,EAAE+B,YAAc,SAASkF,EAAO2B,EAAMI,GACpC,GAAa,MAAT/B,EAAe,OAAQ,CAC3B,IAAIgC,GAAmB,MAARD,CACf,IAAIlH,GAAqBmF,EAAMlF,cAAgBD,EAC7C,MAAOmH,GAAWhC,EAAMlF,YAAY6G,EAAMI,GAAQ/B,EAAMlF,YAAY6G,EAGtE,KADA,GAAI7F,GAAKkG,EAAWD,EAAO/B,EAAMnE,OAC1BC,KAAK,GAAIkE,EAAMlE,KAAO6F,EAAM,MAAO7F,EAC1C,QAAQ,GAMV/C,EAAEkJ,MAAQ,SAASC,EAAOC,EAAMC,GAC1B1F,UAAUb,QAAU,IACtBsG,EAAOD,GAAS,EAChBA,EAAQ,GAEVE,EAAO1F,UAAU,IAAM,CAMvB,KAJA,GAAIb,GAASyC,KAAKD,IAAIC,KAAK+D,MAAMF,EAAOD,GAASE,GAAO,GACpDE,EAAM,EACNL,EAAQ,GAAI/I,OAAM2C,GAEVA,EAANyG,GACJL,EAAMK,KAASJ,EACfA,GAASE,CAGX,OAAOH,GAOT,IAAIM,GAAO,YAKXxJ,GAAEqC,KAAO,SAASoH,EAAM5G,GACtB,GAAI8B,GAAM+E,CACV,IAAItH,GAAcqH,EAAKpH,OAASD,EAAY,MAAOA,GAAW0C,MAAM2E,EAAM/I,EAAMsC,KAAKW,UAAW,GAChG,KAAK3D,EAAE6E,WAAW4E,GAAO,KAAM,IAAI7F,UAEnC,OADAe,GAAOjE,EAAMsC,KAAKW,UAAW,GACtB+F,EAAQ,WACb,KAAM5J,eAAgB4J,IAAQ,MAAOD,GAAK3E,MAAMjC,EAAS8B,EAAKhE,OAAOD,EAAMsC,KAAKW,YAChF6F,GAAKpJ,UAAYqJ,EAAKrJ,SACtB,IAAIuJ,GAAO,GAAIH,EACfA,GAAKpJ,UAAY,IACjB,IAAI4D,GAASyF,EAAK3E,MAAM6E,EAAMhF,EAAKhE,OAAOD,EAAMsC,KAAKW,YACrD,OAAIrD,QAAO0D,KAAYA,EAAeA,EAC/B2F,IAMX3J,EAAE4J,QAAU,SAASH,GACnB,GAAI9E,GAAOjE,EAAMsC,KAAKW,UAAW,EACjC,OAAO,YACL,MAAO8F,GAAK3E,MAAMhF,KAAM6E,EAAKhE,OAAOD,EAAMsC,KAAKW,eAMnD3D,EAAE6J,QAAU,SAASvH,GACnB,GAAIwH,GAAQpJ,EAAMsC,KAAKW,UAAW,EAClC,IAAqB,IAAjBmG,EAAMhH,OAAc,KAAM,IAAIiH,OAAM,wCAExC,OADApH,GAAKmH,EAAO,SAASE,GAAK1H,EAAI0H,GAAKhK,EAAEqC,KAAKC,EAAI0H,GAAI1H,KAC3CA,GAITtC,EAAEiK,QAAU,SAASR,EAAMS,GACzB,GAAIzG,KAEJ,OADAyG,KAAWA,EAASlK,EAAEqE,UACf,WACL,GAAIW,GAAMkF,EAAOpF,MAAMhF,KAAM6D,UAC7B,OAAO3D,GAAE6G,IAAIpD,EAAMuB,GAAOvB,EAAKuB,GAAQvB,EAAKuB,GAAOyE,EAAK3E,MAAMhF,KAAM6D,aAMxE3D,EAAEmK,MAAQ,SAASV,EAAMW,GACvB,GAAIzF,GAAOjE,EAAMsC,KAAKW,UAAW,EACjC,OAAO0G,YAAW,WAAY,MAAOZ,GAAK3E,MAAM,KAAMH,IAAUyF,IAKlEpK,EAAEsK,MAAQ,SAASb,GACjB,MAAOzJ,GAAEmK,MAAMrF,MAAM9E,GAAIyJ,EAAM,GAAG9I,OAAOD,EAAMsC,KAAKW,UAAW,MAQjE3D,EAAEuK,SAAW,SAASd,EAAMW,EAAMI,GAChC,GAAI3H,GAAS8B,EAAMX,EACfyG,EAAU,KACVC,EAAW,CACfF,KAAYA,KACZ,IAAIG,GAAQ,WACVD,EAAWF,EAAQI,WAAY,EAAQ,EAAI,GAAIC,MAC/CJ,EAAU,KACVzG,EAASyF,EAAK3E,MAAMjC,EAAS8B,GAE/B,OAAO,YACL,GAAImG,GAAM,GAAID,KACTH,IAAYF,EAAQI,WAAY,IAAOF,EAAWI,EACvD,IAAIC,GAAYX,GAAQU,EAAMJ,EAW9B,OAVA7H,GAAU/C,KACV6E,EAAOhB,UACU,GAAboH,GACFC,aAAaP,GACbA,EAAU,KACVC,EAAWI,EACX9G,EAASyF,EAAK3E,MAAMjC,EAAS8B,IACnB8F,GAAWD,EAAQS,YAAa,IAC1CR,EAAUJ,WAAWM,EAAOI,IAEvB/G,IAQXhE,EAAEkL,SAAW,SAASzB,EAAMW,EAAMe,GAChC,GAAIV,GAAS9F,EAAM9B,EAASuI,EAAWpH,CACvC,OAAO,YACLnB,EAAU/C,KACV6E,EAAOhB,UACPyH,EAAY,GAAIP,KAChB,IAAIF,GAAQ,WACV,GAAIjD,GAAO,GAAKmD,MAAUO,CACfhB,GAAP1C,EACF+C,EAAUJ,WAAWM,EAAOP,EAAO1C,IAEnC+C,EAAU,KACLU,IAAWnH,EAASyF,EAAK3E,MAAMjC,EAAS8B,MAG7C0G,EAAUF,IAAcV,CAK5B,OAJKA,KACHA,EAAUJ,WAAWM,EAAOP,IAE1BiB,IAASrH,EAASyF,EAAK3E,MAAMjC,EAAS8B,IACnCX,IAMXhE,EAAEsL,KAAO,SAAS7B,GAChB,GAAiBhG,GAAb8H,GAAM,CACV,OAAO,YACL,MAAIA,GAAY9H,GAChB8H,GAAM,EACN9H,EAAOgG,EAAK3E,MAAMhF,KAAM6D,WACxB8F,EAAO,KACAhG,KAOXzD,EAAEwL,KAAO,SAAS/B,EAAMgC,GACtB,MAAO,YACL,GAAI9G,IAAQ8E,EAEZ,OADAhJ,GAAKqE,MAAMH,EAAMhB,WACV8H,EAAQ3G,MAAMhF,KAAM6E,KAM/B3E,EAAE0L,QAAU,WACV,GAAI5B,GAAQnG,SACZ,OAAO,YAEL,IAAK,GADDgB,GAAOhB,UACFZ,EAAI+G,EAAMhH,OAAS,EAAGC,GAAK,EAAGA,IACrC4B,GAAQmF,EAAM/G,GAAG+B,MAAMhF,KAAM6E,GAE/B,OAAOA,GAAK,KAKhB3E,EAAE2L,MAAQ,SAASC,EAAOnC,GACxB,MAAO,YACL,QAAMmC,EAAQ,EACLnC,EAAK3E,MAAMhF,KAAM6D,WAD1B,SAWJ3D,EAAEmC,KAAOD,GAAc,SAASI,GAC9B,GAAIA,IAAQhC,OAAOgC,GAAM,KAAM,IAAIsB,WAAU,iBAC7C,IAAIzB,KACJ,KAAK,GAAI6C,KAAO1C,GAAStC,EAAE6G,IAAIvE,EAAK0C,IAAM7C,EAAK1B,KAAKuE,EACpD,OAAO7C,IAITnC,EAAEsH,OAAS,SAAShF,GAIlB,IAAK,GAHDH,GAAOnC,EAAEmC,KAAKG,GACdQ,EAASX,EAAKW,OACdwE,EAAS,GAAInH,OAAM2C,GACdC,EAAI,EAAOD,EAAJC,EAAYA,IAC1BuE,EAAOvE,GAAKT,EAAIH,EAAKY,GAEvB,OAAOuE,IAITtH,EAAE6L,MAAQ,SAASvJ,GAIjB,IAAK,GAHDH,GAAOnC,EAAEmC,KAAKG,GACdQ,EAASX,EAAKW,OACd+I,EAAQ,GAAI1L,OAAM2C,GACbC,EAAI,EAAOD,EAAJC,EAAYA,IAC1B8I,EAAM9I,IAAMZ,EAAKY,GAAIT,EAAIH,EAAKY,IAEhC,OAAO8I,IAIT7L,EAAE8L,OAAS,SAASxJ,GAGlB,IAAK,GAFD0B,MACA7B,EAAOnC,EAAEmC,KAAKG,GACTS,EAAI,EAAGD,EAASX,EAAKW,OAAYA,EAAJC,EAAYA,IAChDiB,EAAO1B,EAAIH,EAAKY,KAAOZ,EAAKY,EAE9B,OAAOiB,IAKThE,EAAE+L,UAAY/L,EAAEgM,QAAU,SAAS1J,GACjC,GAAI2J,KACJ,KAAK,GAAIjH,KAAO1C,GACVtC,EAAE6E,WAAWvC,EAAI0C,KAAOiH,EAAMxL,KAAKuE,EAEzC,OAAOiH,GAAM5F,QAIfrG,EAAEkM,OAAS,SAAS5J,GAQlB,MAPAK,GAAKjC,EAAMsC,KAAKW,UAAW,GAAI,SAASwI,GACtC,GAAIA,EACF,IAAK,GAAIC,KAAQD,GACf7J,EAAI8J,GAAQD,EAAOC,KAIlB9J,GAITtC,EAAEqM,KAAO,SAAS/J,GAChB,GAAIgK,MACAnK,EAAOxB,EAAOmE,MAAM5E,EAAYQ,EAAMsC,KAAKW,UAAW,GAI1D,OAHAhB,GAAKR,EAAM,SAAS6C,GACdA,IAAO1C,KAAKgK,EAAKtH,GAAO1C,EAAI0C,MAE3BsH,GAITtM,EAAEuM,KAAO,SAASjK,GAChB,GAAIgK,MACAnK,EAAOxB,EAAOmE,MAAM5E,EAAYQ,EAAMsC,KAAKW,UAAW,GAC1D,KAAK,GAAIqB,KAAO1C,GACTtC,EAAEsE,SAASnC,EAAM6C,KAAMsH,EAAKtH,GAAO1C,EAAI0C,GAE9C,OAAOsH,IAITtM,EAAEwM,SAAW,SAASlK,GAQpB,MAPAK,GAAKjC,EAAMsC,KAAKW,UAAW,GAAI,SAASwI,GACtC,GAAIA,EACF,IAAK,GAAIC,KAAQD,GACX7J,EAAI8J,SAAe,KAAG9J,EAAI8J,GAAQD,EAAOC,MAI5C9J,GAITtC,EAAEyM,MAAQ,SAASnK,GACjB,MAAKtC,GAAE0M,SAASpK,GACTtC,EAAEiC,QAAQK,GAAOA,EAAI5B,QAAUV,EAAEkM,UAAW5J,GADtBA,GAO/BtC,EAAE2M,IAAM,SAASrK,EAAKsK,GAEpB,MADAA,GAAYtK,GACLA,EAIT,IAAIuK,GAAK,SAASrG,EAAGC,EAAGqG,EAAQC,GAG9B,GAAIvG,IAAMC,EAAG,MAAa,KAAND,GAAW,EAAIA,GAAK,EAAIC,CAE5C,IAAS,MAALD,GAAkB,MAALC,EAAW,MAAOD,KAAMC,CAErCD,aAAaxG,KAAGwG,EAAIA,EAAEjE,UACtBkE,YAAazG,KAAGyG,EAAIA,EAAElE,SAE1B,IAAIyK,GAAYpM,EAASoC,KAAKwD,EAC9B,IAAIwG,GAAapM,EAASoC,KAAKyD,GAAI,OAAO,CAC1C,QAAQuG,GAEN,IAAK,kBAGH,MAAOxG,IAAKyG,OAAOxG,EACrB,KAAK,kBAGH,MAAOD,KAAMA,EAAIC,IAAMA,EAAU,GAALD,EAAS,EAAIA,GAAK,EAAIC,EAAID,IAAMC,CAC9D,KAAK,gBACL,IAAK,mBAIH,OAAQD,IAAMC,CAEhB,KAAK,kBACH,MAAOD,GAAE2F,QAAU1F,EAAE0F,QACd3F,EAAE0G,QAAUzG,EAAEyG,QACd1G,EAAE2G,WAAa1G,EAAE0G,WACjB3G,EAAE4G,YAAc3G,EAAE2G,WAE7B,GAAgB,gBAAL5G,IAA6B,gBAALC,GAAe,OAAO,CAIzD,KADA,GAAI3D,GAASgK,EAAOhK,OACbA,KAGL,GAAIgK,EAAOhK,IAAW0D,EAAG,MAAOuG,GAAOjK,IAAW2D,CAIpD,IAAI4G,GAAQ7G,EAAE8G,YAAaC,EAAQ9G,EAAE6G,WACrC,IAAID,IAAUE,KAAWvN,EAAE6E,WAAWwI,IAAWA,YAAiBA,IACzCrN,EAAE6E,WAAW0I,IAAWA,YAAiBA,IAChE,OAAO,CAGTT,GAAOrM,KAAK+F,GACZuG,EAAOtM,KAAKgG,EACZ,IAAIc,GAAO,EAAGvD,GAAS,CAEvB,IAAiB,kBAAbgJ,GAIF,GAFAzF,EAAOf,EAAE1D,OACTkB,EAASuD,GAAQd,EAAE3D,OAGjB,KAAOyE,MACCvD,EAAS6I,EAAGrG,EAAEe,GAAOd,EAAEc,GAAOuF,EAAQC,WAG3C,CAEL,IAAK,GAAI/H,KAAOwB,GACd,GAAIxG,EAAE6G,IAAIL,EAAGxB,KAEXuC,MAEMvD,EAAShE,EAAE6G,IAAIJ,EAAGzB,IAAQ6H,EAAGrG,EAAExB,GAAMyB,EAAEzB,GAAM8H,EAAQC,KAAU,KAIzE,IAAI/I,EAAQ,CACV,IAAKgB,IAAOyB,GACV,GAAIzG,EAAE6G,IAAIJ,EAAGzB,KAAUuC,IAAS,KAElCvD,IAAUuD,GAMd,MAFAuF,GAAOU,MACPT,EAAOS,MACAxJ,EAIThE,GAAEyN,QAAU,SAASjH,EAAGC,GACtB,MAAOoG,GAAGrG,EAAGC,UAKfzG,EAAEoF,QAAU,SAAS9C,GACnB,GAAW,MAAPA,EAAa,OAAO,CACxB,IAAItC,EAAEiC,QAAQK,IAAQtC,EAAE0N,SAASpL,GAAM,MAAsB,KAAfA,EAAIQ,MAClD,KAAK,GAAIkC,KAAO1C,GAAK,GAAItC,EAAE6G,IAAIvE,EAAK0C,GAAM,OAAO,CACjD,QAAO,GAIThF,EAAE2N,UAAY,SAASrL,GACrB,SAAUA,GAAwB,IAAjBA,EAAIsL,WAKvB5N,EAAEiC,QAAUD,GAAiB,SAASM,GACpC,MAA6B,kBAAtB1B,EAASoC,KAAKV,IAIvBtC,EAAE0M,SAAW,SAASpK,GACpB,MAAOA,KAAQhC,OAAOgC,IAIxBK,GAAM,YAAa,WAAY,SAAU,SAAU,OAAQ,UAAW,SAASkL,GAC7E7N,EAAE,KAAO6N,GAAQ,SAASvL,GACxB,MAAO1B,GAASoC,KAAKV,IAAQ,WAAauL,EAAO,OAMhD7N,EAAEmI,YAAYxE,aACjB3D,EAAEmI,YAAc,SAAS7F,GACvB,SAAUA,IAAOtC,EAAE6G,IAAIvE,EAAK,aAKX,kBAAV,MACTtC,EAAE6E,WAAa,SAASvC,GACtB,MAAsB,kBAARA,KAKlBtC,EAAE8N,SAAW,SAASxL,GACpB,MAAOwL,UAASxL,KAASyL,MAAMC,WAAW1L,KAI5CtC,EAAE+N,MAAQ,SAASzL,GACjB,MAAOtC,GAAEiO,SAAS3L,IAAQA,IAAQA,GAIpCtC,EAAEkO,UAAY,SAAS5L,GACrB,MAAOA,MAAQ,GAAQA,KAAQ,GAA+B,oBAAtB1B,EAASoC,KAAKV,IAIxDtC,EAAEmO,OAAS,SAAS7L,GAClB,MAAe,QAARA,GAITtC,EAAEoO,YAAc,SAAS9L,GACvB,MAAOA,SAAa,IAKtBtC,EAAE6G,IAAM,SAASvE,EAAK0C,GACpB,MAAOnE,GAAemC,KAAKV,EAAK0C,IAQlChF,EAAEqO,WAAa,WAEb,MADAxO,GAAKG,EAAID,EACFD,MAITE,EAAEqE,SAAW,SAASlB,GACpB,MAAOA,IAITnD,EAAE4L,MAAQ,SAAS5F,EAAGpD,EAAUC,GAE9B,IAAK,GADDyL,GAAQnO,MAAMoF,KAAKD,IAAI,EAAGU,IACrBjD,EAAI,EAAOiD,EAAJjD,EAAOA,IAAKuL,EAAMvL,GAAKH,EAASI,KAAKH,EAASE,EAC9D,OAAOuL,IAITtO,EAAE8F,OAAS,SAASJ,EAAKJ,GAKvB,MAJW,OAAPA,IACFA,EAAMI,EACNA,EAAM,GAEDA,EAAMH,KAAKgJ,MAAMhJ,KAAKO,UAAYR,EAAMI,EAAM,IAIvD,IAAI8I,IACFC,QACEC,IAAK,QACLC,IAAK,OACLC,IAAK,OACLC,IAAK,SACLC,IAAK,UAGTN,GAAUO,SAAW/O,EAAE8L,OAAO0C,EAAUC,OAGxC,IAAIO,IACFP,OAAU,GAAIQ,QAAO,IAAMjP,EAAEmC,KAAKqM,EAAUC,QAAQS,KAAK,IAAM,IAAK,KACpEH,SAAU,GAAIE,QAAO,IAAMjP,EAAEmC,KAAKqM,EAAUO,UAAUG,KAAK,KAAO,IAAK,KAIzElP,GAAE2C,MAAM,SAAU,YAAa,SAAS+B,GACtC1E,EAAE0E,GAAU,SAASyK,GACnB,MAAc,OAAVA,EAAuB,IACnB,GAAKA,GAAQC,QAAQJ,EAActK,GAAS,SAAS2K,GAC3D,MAAOb,GAAU9J,GAAQ2K,QAO/BrP,EAAEgE,OAAS,SAAS+E,EAAQuG,GAC1B,GAAc,MAAVvG,EAAgB,WAAY,EAChC,IAAI5F,GAAQ4F,EAAOuG,EACnB,OAAOtP,GAAE6E,WAAW1B,GAASA,EAAMH,KAAK+F,GAAU5F,GAIpDnD,EAAEuP,MAAQ,SAASjN,GACjBK,EAAK3C,EAAE+L,UAAUzJ,GAAM,SAASuL,GAC9B,GAAIpE,GAAOzJ,EAAE6N,GAAQvL,EAAIuL,EACzB7N,GAAEI,UAAUyN,GAAQ,WAClB,GAAIlJ,IAAQ7E,KAAKyC,SAEjB,OADA9B,GAAKqE,MAAMH,EAAMhB,WACVK,EAAOhB,KAAKlD,KAAM2J,EAAK3E,MAAM9E,EAAG2E,OAO7C,IAAI6K,GAAY,CAChBxP,GAAEyP,SAAW,SAASC,GACpB,GAAIC,KAAOH,EAAY,EACvB,OAAOE,GAASA,EAASC,EAAKA,GAKhC3P,EAAE4P,kBACAC,SAAc,kBACdC,YAAc,mBACdrB,OAAc,mBAMhB,IAAIsB,GAAU,OAIVC,GACFlB,IAAU,IACVmB,KAAU,KACVC,KAAU,IACVC,KAAU,IACVC,IAAU,IACVC,SAAU,QACVC,SAAU,SAGRC,EAAU,8BAKdvQ,GAAEwQ,SAAW,SAASC,EAAMC,EAAMC,GAChC,GAAIC,EACJD,GAAW3Q,EAAEwM,YAAamE,EAAU3Q,EAAE4P,iBAGtC,IAAIiB,GAAU,GAAI5B,UACf0B,EAASlC,QAAUsB,GAAS5D,QAC5BwE,EAASb,aAAeC,GAAS5D,QACjCwE,EAASd,UAAYE,GAAS5D,QAC/B+C,KAAK,KAAO,KAAM,KAGhB9L,EAAQ,EACR+I,EAAS,QACbsE,GAAKrB,QAAQyB,EAAS,SAASxB,EAAOZ,EAAQqB,EAAaD,EAAUiB,GAcnE,MAbA3E,IAAUsE,EAAK/P,MAAM0C,EAAO0N,GACzB1B,QAAQmB,EAAS,SAASlB,GAAS,MAAO,KAAOW,EAAQX,KAExDZ,IACFtC,GAAU,cAAgBsC,EAAS,kCAEjCqB,IACF3D,GAAU,cAAgB2D,EAAc,wBAEtCD,IACF1D,GAAU,OAAS0D,EAAW,YAEhCzM,EAAQ0N,EAASzB,EAAMvM,OAChBuM,IAETlD,GAAU,OAGLwE,EAASI,WAAU5E,EAAS,mBAAqBA,EAAS,OAE/DA,EAAS,2CACP,oDACAA,EAAS,eAEX,KACEyE,EAAS,GAAIpQ,UAASmQ,EAASI,UAAY,MAAO,IAAK5E,GACvD,MAAO6E,GAEP,KADAA,GAAE7E,OAASA,EACL6E,EAGR,GAAIN,EAAM,MAAOE,GAAOF,EAAM1Q,EAC9B,IAAIwQ,GAAW,SAASE,GACtB,MAAOE,GAAO5N,KAAKlD,KAAM4Q,EAAM1Q,GAMjC,OAFAwQ,GAASrE,OAAS,aAAewE,EAASI,UAAY,OAAS,OAAS5E,EAAS,IAE1EqE,GAITxQ,EAAEiR,MAAQ,SAAS3O,GACjB,MAAOtC,GAAEsC,GAAK2O,QAUhB,IAAIjN,GAAS,SAAS1B,GACpB,MAAOxC,MAAKoR,OAASlR,EAAEsC,GAAK2O,QAAU3O,EAIxCtC,GAAEuP,MAAMvP,GAGR2C,GAAM,MAAO,OAAQ,UAAW,QAAS,OAAQ,SAAU,WAAY,SAASkL,GAC9E,GAAInJ,GAASxE,EAAW2N,EACxB7N,GAAEI,UAAUyN,GAAQ,WAClB,GAAIvL,GAAMxC,KAAKyC,QAGf,OAFAmC,GAAOI,MAAMxC,EAAKqB,WACL,SAARkK,GAA2B,UAARA,GAAoC,IAAfvL,EAAIQ,cAAqBR,GAAI,GACnE0B,EAAOhB,KAAKlD,KAAMwC,MAK7BK,GAAM,SAAU,OAAQ,SAAU,SAASkL,GACzC,GAAInJ,GAASxE,EAAW2N,EACxB7N,GAAEI,UAAUyN,GAAQ,WAClB,MAAO7J,GAAOhB,KAAKlD,KAAM4E,EAAOI,MAAMhF,KAAKyC,SAAUoB,eAIzD3D,EAAEkM,OAAOlM,EAAEI,WAGT6Q,MAAO,WAEL,MADAnR,MAAKoR,QAAS,EACPpR,MAITqD,MAAO,WACL,MAAOrD,MAAKyC,cAKfS,KAAKlD"}
\ No newline at end of file
diff --git a/profiles/commons/libraries/underscore/underscore.js b/profiles/commons/libraries/underscore/underscore.js
index a12f0d9..b50115d 100644
--- a/profiles/commons/libraries/underscore/underscore.js
+++ b/profiles/commons/libraries/underscore/underscore.js
@@ -1,6 +1,6 @@
-//     Underscore.js 1.4.4
+//     Underscore.js 1.5.2
 //     http://underscorejs.org
-//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud Inc.
+//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 //     Underscore may be freely distributed under the MIT license.
 
 (function() {
@@ -8,7 +8,7 @@
   // Baseline setup
   // --------------
 
-  // Establish the root object, `window` in the browser, or `global` on the server.
+  // Establish the root object, `window` in the browser, or `exports` on the server.
   var root = this;
 
   // Save the previous value of the `_` variable.
@@ -21,11 +21,12 @@
   var ArrayProto = Array.prototype, ObjProto = Object.prototype, FuncProto = Function.prototype;
 
   // Create quick reference variables for speed access to core prototypes.
-  var push             = ArrayProto.push,
-      slice            = ArrayProto.slice,
-      concat           = ArrayProto.concat,
-      toString         = ObjProto.toString,
-      hasOwnProperty   = ObjProto.hasOwnProperty;
+  var
+    push             = ArrayProto.push,
+    slice            = ArrayProto.slice,
+    concat           = ArrayProto.concat,
+    toString         = ObjProto.toString,
+    hasOwnProperty   = ObjProto.hasOwnProperty;
 
   // All **ECMAScript 5** native function implementations that we hope to use
   // are declared here.
@@ -64,7 +65,7 @@
   }
 
   // Current version.
-  _.VERSION = '1.4.4';
+  _.VERSION = '1.5.2';
 
   // Collection Functions
   // --------------------
@@ -77,14 +78,13 @@
     if (nativeForEach && obj.forEach === nativeForEach) {
       obj.forEach(iterator, context);
     } else if (obj.length === +obj.length) {
-      for (var i = 0, l = obj.length; i < l; i++) {
+      for (var i = 0, length = obj.length; i < length; i++) {
         if (iterator.call(context, obj[i], i, obj) === breaker) return;
       }
     } else {
-      for (var key in obj) {
-        if (_.has(obj, key)) {
-          if (iterator.call(context, obj[key], key, obj) === breaker) return;
-        }
+      var keys = _.keys(obj);
+      for (var i = 0, length = keys.length; i < length; i++) {
+        if (iterator.call(context, obj[keys[i]], keys[i], obj) === breaker) return;
       }
     }
   };
@@ -96,7 +96,7 @@
     if (obj == null) return results;
     if (nativeMap && obj.map === nativeMap) return obj.map(iterator, context);
     each(obj, function(value, index, list) {
-      results[results.length] = iterator.call(context, value, index, list);
+      results.push(iterator.call(context, value, index, list));
     });
     return results;
   };
@@ -171,7 +171,7 @@
     if (obj == null) return results;
     if (nativeFilter && obj.filter === nativeFilter) return obj.filter(iterator, context);
     each(obj, function(value, index, list) {
-      if (iterator.call(context, value, index, list)) results[results.length] = value;
+      if (iterator.call(context, value, index, list)) results.push(value);
     });
     return results;
   };
@@ -238,7 +238,7 @@
   // Convenience version of a common use case of `filter`: selecting only objects
   // containing specific `key:value` pairs.
   _.where = function(obj, attrs, first) {
-    if (_.isEmpty(attrs)) return first ? null : [];
+    if (_.isEmpty(attrs)) return first ? void 0 : [];
     return _[first ? 'find' : 'filter'](obj, function(value) {
       for (var key in attrs) {
         if (attrs[key] !== value[key]) return false;
@@ -255,7 +255,7 @@
 
   // Return the maximum element or (element-based computation).
   // Can't optimize arrays of integers longer than 65,535 elements.
-  // See: https://bugs.webkit.org/show_bug.cgi?id=80797
+  // See [WebKit Bug 80797](https://bugs.webkit.org/show_bug.cgi?id=80797)
   _.max = function(obj, iterator, context) {
     if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {
       return Math.max.apply(Math, obj);
@@ -264,7 +264,7 @@
     var result = {computed : -Infinity, value: -Infinity};
     each(obj, function(value, index, list) {
       var computed = iterator ? iterator.call(context, value, index, list) : value;
-      computed >= result.computed && (result = {value : value, computed : computed});
+      computed > result.computed && (result = {value : value, computed : computed});
     });
     return result.value;
   };
@@ -283,7 +283,8 @@
     return result.value;
   };
 
-  // Shuffle an array.
+  // Shuffle an array, using the modern version of the 
+  // [Fisher-Yates shuffle](http://en.wikipedia.org/wiki/Fisher–Yates_shuffle).
   _.shuffle = function(obj) {
     var rand;
     var index = 0;
@@ -296,6 +297,16 @@
     return shuffled;
   };
 
+  // Sample **n** random values from an array.
+  // If **n** is not specified, returns a single random element from the array.
+  // The internal `guard` argument allows it to work with `map`.
+  _.sample = function(obj, n, guard) {
+    if (arguments.length < 2 || guard) {
+      return obj[_.random(obj.length - 1)];
+    }
+    return _.shuffle(obj).slice(0, Math.max(0, n));
+  };
+
   // An internal function to generate lookup iterators.
   var lookupIterator = function(value) {
     return _.isFunction(value) ? value : function(obj){ return obj[value]; };
@@ -306,9 +317,9 @@
     var iterator = lookupIterator(value);
     return _.pluck(_.map(obj, function(value, index, list) {
       return {
-        value : value,
-        index : index,
-        criteria : iterator.call(context, value, index, list)
+        value: value,
+        index: index,
+        criteria: iterator.call(context, value, index, list)
       };
     }).sort(function(left, right) {
       var a = left.criteria;
@@ -317,38 +328,41 @@
         if (a > b || a === void 0) return 1;
         if (a < b || b === void 0) return -1;
       }
-      return left.index < right.index ? -1 : 1;
+      return left.index - right.index;
     }), 'value');
   };
 
   // An internal function used for aggregate "group by" operations.
-  var group = function(obj, value, context, behavior) {
-    var result = {};
-    var iterator = lookupIterator(value || _.identity);
-    each(obj, function(value, index) {
-      var key = iterator.call(context, value, index, obj);
-      behavior(result, key, value);
-    });
-    return result;
+  var group = function(behavior) {
+    return function(obj, value, context) {
+      var result = {};
+      var iterator = value == null ? _.identity : lookupIterator(value);
+      each(obj, function(value, index) {
+        var key = iterator.call(context, value, index, obj);
+        behavior(result, key, value);
+      });
+      return result;
+    };
   };
 
   // Groups the object's values by a criterion. Pass either a string attribute
   // to group by, or a function that returns the criterion.
-  _.groupBy = function(obj, value, context) {
-    return group(obj, value, context, function(result, key, value) {
-      (_.has(result, key) ? result[key] : (result[key] = [])).push(value);
-    });
-  };
+  _.groupBy = group(function(result, key, value) {
+    (_.has(result, key) ? result[key] : (result[key] = [])).push(value);
+  });
+
+  // Indexes the object's values by a criterion, similar to `groupBy`, but for
+  // when you know that your index values will be unique.
+  _.indexBy = group(function(result, key, value) {
+    result[key] = value;
+  });
 
   // Counts instances of an object that group by a certain criterion. Pass
   // either a string attribute to count by, or a function that returns the
   // criterion.
-  _.countBy = function(obj, value, context) {
-    return group(obj, value, context, function(result, key) {
-      if (!_.has(result, key)) result[key] = 0;
-      result[key]++;
-    });
-  };
+  _.countBy = group(function(result, key) {
+    _.has(result, key) ? result[key]++ : result[key] = 1;
+  });
 
   // Use a comparator function to figure out the smallest index at which
   // an object should be inserted so as to maintain order. Uses binary search.
@@ -363,7 +377,7 @@
     return low;
   };
 
-  // Safely convert anything iterable into a real, live array.
+  // Safely create a real, live array from anything iterable.
   _.toArray = function(obj) {
     if (!obj) return [];
     if (_.isArray(obj)) return slice.call(obj);
@@ -385,7 +399,7 @@
   // allows it to work with `_.map`.
   _.first = _.head = _.take = function(array, n, guard) {
     if (array == null) return void 0;
-    return (n != null) && !guard ? slice.call(array, 0, n) : array[0];
+    return (n == null) || guard ? array[0] : slice.call(array, 0, n);
   };
 
   // Returns everything but the last entry of the array. Especially useful on
@@ -400,10 +414,10 @@
   // values in the array. The **guard** check allows it to work with `_.map`.
   _.last = function(array, n, guard) {
     if (array == null) return void 0;
-    if ((n != null) && !guard) {
-      return slice.call(array, Math.max(array.length - n, 0));
-    } else {
+    if ((n == null) || guard) {
       return array[array.length - 1];
+    } else {
+      return slice.call(array, Math.max(array.length - n, 0));
     }
   };
 
@@ -422,8 +436,11 @@
 
   // Internal implementation of a recursive `flatten` function.
   var flatten = function(input, shallow, output) {
+    if (shallow && _.every(input, _.isArray)) {
+      return concat.apply(output, input);
+    }
     each(input, function(value) {
-      if (_.isArray(value)) {
+      if (_.isArray(value) || _.isArguments(value)) {
         shallow ? push.apply(output, value) : flatten(value, shallow, output);
       } else {
         output.push(value);
@@ -432,7 +449,7 @@
     return output;
   };
 
-  // Return a completely flattened version of an array.
+  // Flatten out an array, either recursively (by default), or just one level.
   _.flatten = function(array, shallow) {
     return flatten(array, shallow, []);
   };
@@ -466,7 +483,7 @@
   // Produce an array that contains the union: each distinct element from all of
   // the passed-in arrays.
   _.union = function() {
-    return _.uniq(concat.apply(ArrayProto, arguments));
+    return _.uniq(_.flatten(arguments, true));
   };
 
   // Produce an array that contains every item shared between all the
@@ -490,11 +507,10 @@
   // Zip together multiple lists into a single array -- elements that share
   // an index go together.
   _.zip = function() {
-    var args = slice.call(arguments);
-    var length = _.max(_.pluck(args, 'length'));
+    var length = _.max(_.pluck(arguments, "length").concat(0));
     var results = new Array(length);
     for (var i = 0; i < length; i++) {
-      results[i] = _.pluck(args, "" + i);
+      results[i] = _.pluck(arguments, '' + i);
     }
     return results;
   };
@@ -505,7 +521,7 @@
   _.object = function(list, values) {
     if (list == null) return {};
     var result = {};
-    for (var i = 0, l = list.length; i < l; i++) {
+    for (var i = 0, length = list.length; i < length; i++) {
       if (values) {
         result[list[i]] = values[i];
       } else {
@@ -523,17 +539,17 @@
   // for **isSorted** to use binary search.
   _.indexOf = function(array, item, isSorted) {
     if (array == null) return -1;
-    var i = 0, l = array.length;
+    var i = 0, length = array.length;
     if (isSorted) {
       if (typeof isSorted == 'number') {
-        i = (isSorted < 0 ? Math.max(0, l + isSorted) : isSorted);
+        i = (isSorted < 0 ? Math.max(0, length + isSorted) : isSorted);
       } else {
         i = _.sortedIndex(array, item);
         return array[i] === item ? i : -1;
       }
     }
     if (nativeIndexOf && array.indexOf === nativeIndexOf) return array.indexOf(item, isSorted);
-    for (; i < l; i++) if (array[i] === item) return i;
+    for (; i < length; i++) if (array[i] === item) return i;
     return -1;
   };
 
@@ -559,11 +575,11 @@
     }
     step = arguments[2] || 1;
 
-    var len = Math.max(Math.ceil((stop - start) / step), 0);
+    var length = Math.max(Math.ceil((stop - start) / step), 0);
     var idx = 0;
-    var range = new Array(len);
+    var range = new Array(length);
 
-    while(idx < len) {
+    while(idx < length) {
       range[idx++] = start;
       start += step;
     }
@@ -574,14 +590,25 @@
   // Function (ahem) Functions
   // ------------------
 
+  // Reusable constructor function for prototype setting.
+  var ctor = function(){};
+
   // Create a function bound to a given object (assigning `this`, and arguments,
   // optionally). Delegates to **ECMAScript 5**'s native `Function.bind` if
   // available.
   _.bind = function(func, context) {
-    if (func.bind === nativeBind && nativeBind) return nativeBind.apply(func, slice.call(arguments, 1));
-    var args = slice.call(arguments, 2);
-    return function() {
-      return func.apply(context, args.concat(slice.call(arguments)));
+    var args, bound;
+    if (nativeBind && func.bind === nativeBind) return nativeBind.apply(func, slice.call(arguments, 1));
+    if (!_.isFunction(func)) throw new TypeError;
+    args = slice.call(arguments, 2);
+    return bound = function() {
+      if (!(this instanceof bound)) return func.apply(context, args.concat(slice.call(arguments)));
+      ctor.prototype = func.prototype;
+      var self = new ctor;
+      ctor.prototype = null;
+      var result = func.apply(self, args.concat(slice.call(arguments)));
+      if (Object(result) === result) return result;
+      return self;
     };
   };
 
@@ -598,7 +625,7 @@
   // all callbacks defined on an object belong to it.
   _.bindAll = function(obj) {
     var funcs = slice.call(arguments, 1);
-    if (funcs.length === 0) funcs = _.functions(obj);
+    if (funcs.length === 0) throw new Error("bindAll must be passed function names");
     each(funcs, function(f) { obj[f] = _.bind(obj[f], obj); });
     return obj;
   };
@@ -627,17 +654,23 @@
   };
 
   // Returns a function, that, when invoked, will only be triggered at most once
-  // during a given window of time.
-  _.throttle = function(func, wait) {
-    var context, args, timeout, result;
+  // during a given window of time. Normally, the throttled function will run
+  // as much as it can, without ever going more than once per `wait` duration;
+  // but if you'd like to disable the execution on the leading edge, pass
+  // `{leading: false}`. To disable execution on the trailing edge, ditto.
+  _.throttle = function(func, wait, options) {
+    var context, args, result;
+    var timeout = null;
     var previous = 0;
+    options || (options = {});
     var later = function() {
-      previous = new Date;
+      previous = options.leading === false ? 0 : new Date;
       timeout = null;
       result = func.apply(context, args);
     };
     return function() {
       var now = new Date;
+      if (!previous && options.leading === false) previous = now;
       var remaining = wait - (now - previous);
       context = this;
       args = arguments;
@@ -646,7 +679,7 @@
         timeout = null;
         previous = now;
         result = func.apply(context, args);
-      } else if (!timeout) {
+      } else if (!timeout && options.trailing !== false) {
         timeout = setTimeout(later, remaining);
       }
       return result;
@@ -658,16 +691,24 @@
   // N milliseconds. If `immediate` is passed, trigger the function on the
   // leading edge, instead of the trailing.
   _.debounce = function(func, wait, immediate) {
-    var timeout, result;
+    var timeout, args, context, timestamp, result;
     return function() {
-      var context = this, args = arguments;
+      context = this;
+      args = arguments;
+      timestamp = new Date();
       var later = function() {
-        timeout = null;
-        if (!immediate) result = func.apply(context, args);
+        var last = (new Date()) - timestamp;
+        if (last < wait) {
+          timeout = setTimeout(later, wait - last);
+        } else {
+          timeout = null;
+          if (!immediate) result = func.apply(context, args);
+        }
       };
       var callNow = immediate && !timeout;
-      clearTimeout(timeout);
-      timeout = setTimeout(later, wait);
+      if (!timeout) {
+        timeout = setTimeout(later, wait);
+      }
       if (callNow) result = func.apply(context, args);
       return result;
     };
@@ -712,7 +753,6 @@
 
   // Returns a function that will only be executed after being called N times.
   _.after = function(times, func) {
-    if (times <= 0) return func();
     return function() {
       if (--times < 1) {
         return func.apply(this, arguments);
@@ -728,28 +768,39 @@
   _.keys = nativeKeys || function(obj) {
     if (obj !== Object(obj)) throw new TypeError('Invalid object');
     var keys = [];
-    for (var key in obj) if (_.has(obj, key)) keys[keys.length] = key;
+    for (var key in obj) if (_.has(obj, key)) keys.push(key);
     return keys;
   };
 
   // Retrieve the values of an object's properties.
   _.values = function(obj) {
-    var values = [];
-    for (var key in obj) if (_.has(obj, key)) values.push(obj[key]);
+    var keys = _.keys(obj);
+    var length = keys.length;
+    var values = new Array(length);
+    for (var i = 0; i < length; i++) {
+      values[i] = obj[keys[i]];
+    }
     return values;
   };
 
   // Convert an object into a list of `[key, value]` pairs.
   _.pairs = function(obj) {
-    var pairs = [];
-    for (var key in obj) if (_.has(obj, key)) pairs.push([key, obj[key]]);
+    var keys = _.keys(obj);
+    var length = keys.length;
+    var pairs = new Array(length);
+    for (var i = 0; i < length; i++) {
+      pairs[i] = [keys[i], obj[keys[i]]];
+    }
     return pairs;
   };
 
   // Invert the keys and values of an object. The values must be serializable.
   _.invert = function(obj) {
     var result = {};
-    for (var key in obj) if (_.has(obj, key)) result[obj[key]] = key;
+    var keys = _.keys(obj);
+    for (var i = 0, length = keys.length; i < length; i++) {
+      result[obj[keys[i]]] = keys[i];
+    }
     return result;
   };
 
@@ -800,7 +851,7 @@
     each(slice.call(arguments, 1), function(source) {
       if (source) {
         for (var prop in source) {
-          if (obj[prop] == null) obj[prop] = source[prop];
+          if (obj[prop] === void 0) obj[prop] = source[prop];
         }
       }
     });
@@ -824,7 +875,7 @@
   // Internal recursive comparison function for `isEqual`.
   var eq = function(a, b, aStack, bStack) {
     // Identical objects are equal. `0 === -0`, but they aren't identical.
-    // See the Harmony `egal` proposal: http://wiki.ecmascript.org/doku.php?id=harmony:egal.
+    // See the [Harmony `egal` proposal](http://wiki.ecmascript.org/doku.php?id=harmony:egal).
     if (a === b) return a !== 0 || 1 / a == 1 / b;
     // A strict comparison is necessary because `null == undefined`.
     if (a == null || b == null) return a === b;
@@ -866,6 +917,13 @@
       // unique nested structures.
       if (aStack[length] == a) return bStack[length] == b;
     }
+    // Objects with different constructors are not equivalent, but `Object`s
+    // from different frames are.
+    var aCtor = a.constructor, bCtor = b.constructor;
+    if (aCtor !== bCtor && !(_.isFunction(aCtor) && (aCtor instanceof aCtor) &&
+                             _.isFunction(bCtor) && (bCtor instanceof bCtor))) {
+      return false;
+    }
     // Add the first object to the stack of traversed objects.
     aStack.push(a);
     bStack.push(b);
@@ -882,13 +940,6 @@
         }
       }
     } else {
-      // Objects with different constructors are not equivalent, but `Object`s
-      // from different frames are.
-      var aCtor = a.constructor, bCtor = b.constructor;
-      if (aCtor !== bCtor && !(_.isFunction(aCtor) && (aCtor instanceof aCtor) &&
-                               _.isFunction(bCtor) && (bCtor instanceof bCtor))) {
-        return false;
-      }
       // Deep compare objects.
       for (var key in a) {
         if (_.has(a, key)) {
@@ -1012,7 +1063,7 @@
 
   // Run a function **n** times.
   _.times = function(n, iterator, context) {
-    var accum = Array(n);
+    var accum = Array(Math.max(0, n));
     for (var i = 0; i < n; i++) accum[i] = iterator.call(context, i);
     return accum;
   };
@@ -1033,8 +1084,7 @@
       '<': '&lt;',
       '>': '&gt;',
       '"': '&quot;',
-      "'": '&#x27;',
-      '/': '&#x2F;'
+      "'": '&#x27;'
     }
   };
   entityMap.unescape = _.invert(entityMap.escape);
@@ -1055,17 +1105,17 @@
     };
   });
 
-  // If the value of the named property is a function then invoke it;
-  // otherwise, return it.
+  // If the value of the named `property` is a function then invoke it with the
+  // `object` as context; otherwise, return it.
   _.result = function(object, property) {
-    if (object == null) return null;
+    if (object == null) return void 0;
     var value = object[property];
     return _.isFunction(value) ? value.call(object) : value;
   };
 
   // Add your own custom functions to the Underscore object.
   _.mixin = function(obj) {
-    each(_.functions(obj), function(name){
+    each(_.functions(obj), function(name) {
       var func = _[name] = obj[name];
       _.prototype[name] = function() {
         var args = [this._wrapped];
diff --git a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_page/commons_activity_page.info b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_page/commons_activity_page.info
index d4fd453..6594550 100644
--- a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_page/commons_activity_page.info
+++ b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_page/commons_activity_page.info
@@ -10,9 +10,9 @@ features[ctools][] = page_manager:pages_default:1
 features[features_api][] = api:2
 features[page_manager_pages][] = commons_activity_streams_activity
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.info b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.info
index 46f12cb..460732f 100644
--- a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.info
+++ b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams.info
@@ -38,9 +38,9 @@ features_exclude[field_base][field_target_nodes] = field_target_nodes
 features_exclude[field_base][field_target_comments] = field_target_comments
 features_exclude[views_view][commons_bw_all] = commons_bw_all
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
index 71cfcd0..ee79f62 100644
--- a/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
+++ b/profiles/commons/modules/commons/commons_activity_streams/commons_activity_streams_groups/commons_activity_streams_groups.info
@@ -10,9 +10,9 @@ features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[views_view][] = activity_group
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_body/commons_body.info b/profiles/commons/modules/commons/commons_body/commons_body.info
index 37cbd4f..6661d65 100644
--- a/profiles/commons/modules/commons/commons_body/commons_body.info
+++ b/profiles/commons/modules/commons/commons_body/commons_body.info
@@ -8,9 +8,9 @@ dependencies[] = text
 features[features_api][] = api:2
 features[field_base][] = body
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_bw/commons_bw.info b/profiles/commons/modules/commons/commons_bw/commons_bw.info
index 3b1ae22..6d83a9c 100644
--- a/profiles/commons/modules/commons/commons_bw/commons_bw.info
+++ b/profiles/commons/modules/commons/commons_bw/commons_bw.info
@@ -11,9 +11,9 @@ features[field_base][] = title_field
 files[] = includes/views/handlers/commons_bw_handler_node_partial_form.inc
 ; Views handlers
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_content_moderation/commons_content_moderation.info b/profiles/commons/modules/commons/commons_content_moderation/commons_content_moderation.info
index 2e62261..62be52e 100644
--- a/profiles/commons/modules/commons/commons_content_moderation/commons_content_moderation.info
+++ b/profiles/commons/modules/commons/commons_content_moderation/commons_content_moderation.info
@@ -18,9 +18,9 @@ features[views_view][] = commons_content_moderation_reported_comments
 features[views_view][] = commons_content_moderation_reported_nodes
 features_exclude[dependencies][features] = features
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_documents/commons_documents.info b/profiles/commons/modules/commons/commons_documents/commons_documents.info
index 1ea8146..0b39655 100644
--- a/profiles/commons/modules/commons/commons_documents/commons_documents.info
+++ b/profiles/commons/modules/commons/commons_documents/commons_documents.info
@@ -45,9 +45,9 @@ features[variable][] = node_preview_document
 features[variable][] = node_submitted_document
 features[views_view][] = commons_bw_documents
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_events/commons_events.info b/profiles/commons/modules/commons/commons_events/commons_events.info
index 64feca6..9b0ae21 100644
--- a/profiles/commons/modules/commons/commons_events/commons_events.info
+++ b/profiles/commons/modules/commons/commons_events/commons_events.info
@@ -100,9 +100,9 @@ files[] = commons_events.strongarm.inc
 files[] = includes/commons_events.forms.inc
 files[] = includes/commons_events.theme.inc
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_events/modules/commons_events_pages/commons_events_pages.info b/profiles/commons/modules/commons/commons_events/modules/commons_events_pages/commons_events_pages.info
index 730c2ef..215375f 100644
--- a/profiles/commons/modules/commons/commons_events/modules/commons_events_pages/commons_events_pages.info
+++ b/profiles/commons/modules/commons/commons_events/modules/commons_events_pages/commons_events_pages.info
@@ -13,9 +13,9 @@ features[variable][] = panelizer_defaults_node_event
 files[] = commons_events_pages.features.inc
 files[] = commons_events_pages.strongarm.inc
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_events/modules/commons_events_solr/commons_events_solr.info b/profiles/commons/modules/commons/commons_events/modules/commons_events_solr/commons_events_solr.info
index 3f2bd8d..8d0d734 100644
--- a/profiles/commons/modules/commons/commons_events/modules/commons_events_solr/commons_events_solr.info
+++ b/profiles/commons/modules/commons/commons_events/modules/commons_events_solr/commons_events_solr.info
@@ -20,9 +20,9 @@ features[page_manager_existing_pages][] = solr_events_search
 features[page_manager_handlers][] = pm_existing_pages_solr_events_search_panel_context
 features[variable][] = pm_existing_pages_disabled_solr_events_search
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_featured/commons_featured.info b/profiles/commons/modules/commons/commons_featured/commons_featured.info
index 70cf846..dc14c1d 100644
--- a/profiles/commons/modules/commons/commons_featured/commons_featured.info
+++ b/profiles/commons/modules/commons/commons_featured/commons_featured.info
@@ -8,9 +8,9 @@ features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[views_view][] = commons_featured
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow.info b/profiles/commons/modules/commons/commons_follow/commons_follow.info
index c0c2e82..e94d0ed 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow.info
@@ -23,9 +23,9 @@ files[] = includes/views/handlers/commons_follow_plugin_argument_default_message
 files[] = includes/views/handlers/commons_follow_user_follow_filter.inc
 files[] = includes/views/handlers/commons_follow_user_follow_filter_message.inc
 files[] = includes/views/handlers/commons_follow_handler_field_ops.inc
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_group/commons_follow_group.info b/profiles/commons/modules/commons/commons_follow/commons_follow_group/commons_follow_group.info
index c6ef005..aef3166 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_group/commons_follow_group.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_group/commons_follow_group.info
@@ -12,9 +12,9 @@ features[flag][] = commons_follow_group
 features[flag][] = email_group
 features[variable][] = message_subscribe_og
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.info b/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.info
index 07d8d1f..ef4f5f3 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_node/commons_follow_node.info
@@ -12,9 +12,9 @@ features[flag][] = email_node
 features[views_view][] = commons_follow_node
 features_exclude[dependencies][views] = views
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.info b/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.info
index e30707d..33a6fb4 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_term/commons_follow_term.info
@@ -12,9 +12,9 @@ features[flag][] = email_term
 features[views_view][] = commons_follow_taxonomy_term
 features_exclude[dependencies][ctools] = ctools
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.info b/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.info
index bbb4407..d21c400 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_ui/commons_follow_ui.info
@@ -6,9 +6,9 @@ dependencies[] = commons_follow
 dependencies[] = message_subscribe_ui
 dependencies[] = quicktabs
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.info b/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.info
index db8d078..78de376 100644
--- a/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.info
+++ b/profiles/commons/modules/commons/commons_follow/commons_follow_user/commons_follow_user.info
@@ -20,9 +20,9 @@ features[views_view][] = commons_follow_user
 features[views_view][] = commons_follow_user_followers
 features[views_view][] = commons_follow_user_following
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_groups/commons_groups.info b/profiles/commons/modules/commons/commons_groups/commons_groups.info
index e146b30..560929b 100644
--- a/profiles/commons/modules/commons/commons_groups/commons_groups.info
+++ b/profiles/commons/modules/commons/commons_groups/commons_groups.info
@@ -73,9 +73,9 @@ features[views_view][] = commons_groups_user_groups
 features_exclude[field][node-group-group_group] = node-group-group_group
 features_exclude[field][node-group-group_access] = node-group-group_access
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_groups/modules/commons_groups_directory/commons_groups_directory.info b/profiles/commons/modules/commons/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
index d0da4dc..87d295e 100644
--- a/profiles/commons/modules/commons/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
+++ b/profiles/commons/modules/commons/commons_groups/modules/commons_groups_directory/commons_groups_directory.info
@@ -12,9 +12,9 @@ features[ctools][] = views:views_default:3.0
 features[features_api][] = api:2
 features[page_manager_pages][] = groups_directory
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_groups/modules/commons_groups_pages/commons_groups_pages.info b/profiles/commons/modules/commons/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
index 15240d2..b391853 100644
--- a/profiles/commons/modules/commons/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
+++ b/profiles/commons/modules/commons/commons_groups/modules/commons_groups_pages/commons_groups_pages.info
@@ -16,9 +16,9 @@ features[panelizer_defaults][] = node:group:default
 features[panelizer_defaults][] = node:group:default:teaser
 features[variable][] = panelizer_defaults_node_group
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_images/commons_images.default_breakpoint_group.inc b/profiles/commons/modules/commons/commons_images/commons_images.default_breakpoint_group.inc
new file mode 100644
index 0000000..a5492eb
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_images/commons_images.default_breakpoint_group.inc
@@ -0,0 +1,90 @@
+<?php
+/**
+ * @file
+ * commons_images.default_breakpoint_group.inc
+ */
+
+/**
+ * Implements hook_default_breakpoint_group().
+ */
+function commons_images_default_breakpoint_group() {
+  $export = array();
+
+  // Breakpoints.
+  $breakpoints = array();
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons small portrait';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons small landscape';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons medium portrait';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons medium landscape';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons large';
+
+  // Breakpoint group.
+  $breakpoint_group = new stdClass();
+  $breakpoint_group->disabled = FALSE; /* Edit this to true to make a default breakpoint_group disabled initially */
+  $breakpoint_group->api_version = 1;
+  $breakpoint_group->machine_name = 'commons_default';
+  $breakpoint_group->name = 'Commons default';
+  $breakpoint_group->breakpoints = $breakpoints;
+  $breakpoint_group->type = 'module';
+  $breakpoint_group->overridden = 0;
+  $export['commons_default'] = $breakpoint_group;
+
+  // Breakpoints.
+  $breakpoints = array();
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons small portrait';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons small landscape';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons medium portrait';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons medium landscape';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons large';
+
+  // Breakpoint group.
+  $breakpoint_group = new stdClass();
+  $breakpoint_group->disabled = FALSE; /* Edit this to true to make a default breakpoint_group disabled initially */
+  $breakpoint_group->api_version = 1;
+  $breakpoint_group->machine_name = 'commons_full';
+  $breakpoint_group->name = 'Commons full';
+  $breakpoint_group->breakpoints = $breakpoints;
+  $breakpoint_group->type = 'module';
+  $breakpoint_group->overridden = 0;
+  $export['commons_full'] = $breakpoint_group;
+
+  // Breakpoints.
+  $breakpoints = array();
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons small portrait';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons small landscape';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons medium portrait';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons medium landscape';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons large';
+
+  // Breakpoint group.
+  $breakpoint_group = new stdClass();
+  $breakpoint_group->disabled = FALSE; /* Edit this to true to make a default breakpoint_group disabled initially */
+  $breakpoint_group->api_version = 1;
+  $breakpoint_group->machine_name = 'commons_origins';
+  $breakpoint_group->name = 'Commons Origins';
+  $breakpoint_group->breakpoints = $breakpoints;
+  $breakpoint_group->type = 'theme';
+  $breakpoint_group->overridden = 0;
+  $export['commons_origins'] = $breakpoint_group;
+
+  // Breakpoints.
+  $breakpoints = array();
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons small portrait';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons small landscape';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons medium portrait';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons medium landscape';
+  $breakpoints[] = 'breakpoints.theme.commons_origins.commons large';
+
+  // Breakpoint group.
+  $breakpoint_group = new stdClass();
+  $breakpoint_group->disabled = FALSE; /* Edit this to true to make a default breakpoint_group disabled initially */
+  $breakpoint_group->api_version = 1;
+  $breakpoint_group->machine_name = 'commons_teaser';
+  $breakpoint_group->name = 'Commons teaser';
+  $breakpoint_group->breakpoints = $breakpoints;
+  $breakpoint_group->type = 'module';
+  $breakpoint_group->overridden = 0;
+  $export['commons_teaser'] = $breakpoint_group;
+
+  return $export;
+}
diff --git a/profiles/commons/modules/commons/commons_images/commons_images.default_breakpoints.inc b/profiles/commons/modules/commons/commons_images/commons_images.default_breakpoints.inc
new file mode 100644
index 0000000..fbda730
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_images/commons_images.default_breakpoints.inc
@@ -0,0 +1,89 @@
+<?php
+/**
+ * @file
+ * commons_images.default_breakpoints.inc
+ */
+
+/**
+ * Implements hook_default_breakpoints().
+ */
+function commons_images_default_breakpoints() {
+  $export = array();
+
+  $breakpoint = new stdClass();
+  $breakpoint->disabled = FALSE; /* Edit this to true to make a default breakpoint disabled initially */
+  $breakpoint->api_version = 1;
+  $breakpoint->machine_name = 'breakpoints.theme.commons_origins.commons large';
+  $breakpoint->name = 'Commons large';
+  $breakpoint->breakpoint = 'only screen and (min-width:935px)';
+  $breakpoint->source = 'commons_origins';
+  $breakpoint->source_type = 'theme';
+  $breakpoint->status = 1;
+  $breakpoint->weight = 4;
+  $breakpoint->multipliers = array(
+    '1x' => '1x',
+  );
+  $export['breakpoints.theme.commons_origins.commons large'] = $breakpoint;
+
+  $breakpoint = new stdClass();
+  $breakpoint->disabled = FALSE; /* Edit this to true to make a default breakpoint disabled initially */
+  $breakpoint->api_version = 1;
+  $breakpoint->machine_name = 'breakpoints.theme.commons_origins.commons medium landscape';
+  $breakpoint->name = 'Commons medium landscape';
+  $breakpoint->breakpoint = 'only screen and (min-width:769px) and (max-width:934px';
+  $breakpoint->source = 'commons_origins';
+  $breakpoint->source_type = 'theme';
+  $breakpoint->status = 1;
+  $breakpoint->weight = 3;
+  $breakpoint->multipliers = array(
+    '1x' => '1x',
+  );
+  $export['breakpoints.theme.commons_origins.commons medium landscape'] = $breakpoint;
+
+  $breakpoint = new stdClass();
+  $breakpoint->disabled = FALSE; /* Edit this to true to make a default breakpoint disabled initially */
+  $breakpoint->api_version = 1;
+  $breakpoint->machine_name = 'breakpoints.theme.commons_origins.commons medium portrait';
+  $breakpoint->name = 'Commons medium portrait';
+  $breakpoint->breakpoint = 'only screen and (min-width:481px) and (max-width:768px)';
+  $breakpoint->source = 'commons_origins';
+  $breakpoint->source_type = 'theme';
+  $breakpoint->status = 1;
+  $breakpoint->weight = 2;
+  $breakpoint->multipliers = array(
+    '1x' => '1x',
+  );
+  $export['breakpoints.theme.commons_origins.commons medium portrait'] = $breakpoint;
+
+  $breakpoint = new stdClass();
+  $breakpoint->disabled = FALSE; /* Edit this to true to make a default breakpoint disabled initially */
+  $breakpoint->api_version = 1;
+  $breakpoint->machine_name = 'breakpoints.theme.commons_origins.commons small landscape';
+  $breakpoint->name = 'Commons small landscape';
+  $breakpoint->breakpoint = 'only screen and (min-width:321px) and (max-width:480px)';
+  $breakpoint->source = 'commons_origins';
+  $breakpoint->source_type = 'theme';
+  $breakpoint->status = 1;
+  $breakpoint->weight = 1;
+  $breakpoint->multipliers = array(
+    '1x' => '1x',
+  );
+  $export['breakpoints.theme.commons_origins.commons small landscape'] = $breakpoint;
+
+  $breakpoint = new stdClass();
+  $breakpoint->disabled = FALSE; /* Edit this to true to make a default breakpoint disabled initially */
+  $breakpoint->api_version = 1;
+  $breakpoint->machine_name = 'breakpoints.theme.commons_origins.commons small portrait';
+  $breakpoint->name = 'Commons small portrait';
+  $breakpoint->breakpoint = 'only screen and (max-width:320px)';
+  $breakpoint->source = 'commons_origins';
+  $breakpoint->source_type = 'theme';
+  $breakpoint->status = 1;
+  $breakpoint->weight = 0;
+  $breakpoint->multipliers = array(
+    '1x' => '1x',
+  );
+  $export['breakpoints.theme.commons_origins.commons small portrait'] = $breakpoint;
+
+  return $export;
+}
diff --git a/profiles/commons/modules/commons/commons_images/commons_images.default_picture_mapping.inc b/profiles/commons/modules/commons/commons_images/commons_images.default_picture_mapping.inc
new file mode 100644
index 0000000..e91e30f
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_images/commons_images.default_picture_mapping.inc
@@ -0,0 +1,101 @@
+<?php
+/**
+ * @file
+ * commons_images.default_picture_mapping.inc
+ */
+
+/**
+ * Implements hook_default_picture_mapping().
+ */
+function commons_images_default_picture_mapping() {
+  $export = array();
+
+  $picture_mapping = new stdClass();
+  $picture_mapping->disabled = FALSE; /* Edit this to true to make a default picture_mapping disabled initially */
+  $picture_mapping->api_version = 1;
+  $picture_mapping->machine_name = 'commons_default';
+  $picture_mapping->breakpoint_group = 'commons_default';
+  $picture_mapping->mapping = array(
+    'breakpoints.theme.commons_origins.commons small portrait' => array(
+      '1x' => 'commons-default-small',
+      '1.5x' => 'commons-default-small-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons small landscape' => array(
+      '1x' => 'commons-default-small',
+      '1.5x' => 'commons-default-small-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons medium portrait' => array(
+      '1x' => 'commons-default-medium',
+      '1.5x' => 'commons-default-medium-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons medium landscape' => array(
+      '1x' => 'commons-default-medium',
+      '1.5x' => 'commons-default-medium-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons large' => array(
+      '1x' => 'commons-default-large',
+      '1.5x' => 'commons-default-large-1_5x',
+    ),
+  );
+  $export['commons_default'] = $picture_mapping;
+
+  $picture_mapping = new stdClass();
+  $picture_mapping->disabled = FALSE; /* Edit this to true to make a default picture_mapping disabled initially */
+  $picture_mapping->api_version = 1;
+  $picture_mapping->machine_name = 'commons_full';
+  $picture_mapping->breakpoint_group = 'commons_full';
+  $picture_mapping->mapping = array(
+    'breakpoints.theme.commons_origins.commons small portrait' => array(
+      '1x' => 'commons-full-small',
+      '1.5x' => 'commons-full-small-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons small landscape' => array(
+      '1x' => 'commons-full-small',
+      '1.5x' => 'commons-full-small-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons medium portrait' => array(
+      '1x' => 'commons-full-medium',
+      '1.5x' => 'commons-full-medium-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons medium landscape' => array(
+      '1x' => 'commons-full-medium',
+      '1.5x' => 'commons-full-medium-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons large' => array(
+      '1x' => 'commons-full-large',
+      '1.5x' => 'commons-full-large-1_5x',
+    ),
+  );
+  $export['commons_full'] = $picture_mapping;
+
+  $picture_mapping = new stdClass();
+  $picture_mapping->disabled = FALSE; /* Edit this to true to make a default picture_mapping disabled initially */
+  $picture_mapping->api_version = 1;
+  $picture_mapping->machine_name = 'commons_teaser';
+  $picture_mapping->breakpoint_group = 'commons_teaser';
+  $picture_mapping->mapping = array(
+    'breakpoints.theme.commons_origins.commons small portrait' => array(
+      '1x' => 'commons-teaser-small',
+      '1.5x' => 'commons-teaser-small-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons small landscape' => array(
+      '1x' => 'commons-teaser-small',
+      '1.5x' => 'commons-teaser-small-1_5x',
+    ),
+    'breakpoints.theme.commons_origins.commons medium portrait' => array(
+      '1x' => 'commons-teaser-medium',
+      '1.5x' => 'commons-teaser-medium-1_5',
+    ),
+    'breakpoints.theme.commons_origins.commons medium landscape' => array(
+      '1x' => 'commons-teaser-medium',
+      '1.5x' => 'commons-teaser-medium-1_5',
+    ),
+    'breakpoints.theme.commons_origins.commons large' => array(
+      '1x' => 'commons-teaser-large',
+      '1.5x' => 'commons-teaser-large-1_5x',
+    ),
+  );
+  $export['commons_teaser'] = $picture_mapping;
+
+  return $export;
+}
diff --git a/profiles/commons/modules/commons/commons_images/commons_images.features.inc b/profiles/commons/modules/commons/commons_images/commons_images.features.inc
new file mode 100644
index 0000000..48d70d2
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_images/commons_images.features.inc
@@ -0,0 +1,455 @@
+<?php
+/**
+ * @file
+ * commons_images.features.inc
+ */
+
+/**
+ * Implements hook_ctools_plugin_api().
+ */
+function commons_images_ctools_plugin_api($module = NULL, $api = NULL) {
+  if ($module == "breakpoints" && $api == "default_breakpoint_group") {
+    return array("version" => "1");
+  }
+  if ($module == "breakpoints" && $api == "default_breakpoints") {
+    return array("version" => "1");
+  }
+  if ($module == "picture" && $api == "default_picture_mapping") {
+    return array("version" => "1");
+  }
+}
+
+/**
+ * Implements hook_image_default_styles().
+ */
+function commons_images_image_default_styles() {
+  $styles = array();
+
+  // Exported image style: commons-default-large.
+  $styles['commons-default-large'] = array(
+    'name' => 'commons-default-large',
+    'label' => 'Commons default large',
+    'effects' => array(
+      18 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 536,
+          'height' => 600,
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-default-large-1_5x.
+  $styles['commons-default-large-1_5x'] = array(
+    'name' => 'commons-default-large-1_5x',
+    'label' => 'Commons default large 1.5x',
+    'effects' => array(
+      19 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 804,
+          'height' => 900,
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-default-medium.
+  $styles['commons-default-medium'] = array(
+    'name' => 'commons-default-medium',
+    'label' => 'Commons default medium',
+    'effects' => array(
+      18 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 536,
+          'height' => 600,
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-default-medium-1_5x.
+  $styles['commons-default-medium-1_5x'] = array(
+    'name' => 'commons-default-medium-1_5x',
+    'label' => 'Commons default medium 1.5x',
+    'effects' => array(
+      19 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 804,
+          'height' => 900,
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-default-small.
+  $styles['commons-default-small'] = array(
+    'name' => 'commons-default-small',
+    'label' => 'Commons default small',
+    'effects' => array(
+      20 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 456,
+          'height' => 500,
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-default-small-1_5x.
+  $styles['commons-default-small-1_5x'] = array(
+    'name' => 'commons-default-small-1_5x',
+    'label' => 'Commons default small 1.5x',
+    'effects' => array(
+      21 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 684,
+          'height' => 750,
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-full-large.
+  $styles['commons-full-large'] = array(
+    'name' => 'commons-full-large',
+    'label' => 'Commons full large',
+    'effects' => array(
+      22 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 916,
+          'height' => '',
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-full-large-1_5x.
+  $styles['commons-full-large-1_5x'] = array(
+    'name' => 'commons-full-large-1_5x',
+    'label' => 'Commons full large 1.5x',
+    'effects' => array(
+      23 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 1374,
+          'height' => '',
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-full-medium.
+  $styles['commons-full-medium'] = array(
+    'name' => 'commons-full-medium',
+    'label' => 'Commons full medium',
+    'effects' => array(
+      24 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 768,
+          'height' => '',
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-full-medium-1_5.
+  $styles['commons-full-medium-1_5'] = array(
+    'name' => 'commons-full-medium-1_5',
+    'label' => 'Commons full medium 1.5',
+    'effects' => array(
+      25 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 1152,
+          'height' => '',
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-full-small.
+  $styles['commons-full-small'] = array(
+    'name' => 'commons-full-small',
+    'label' => 'Commons full small',
+    'effects' => array(
+      20 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 456,
+          'height' => 500,
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-full-small-1_5x.
+  $styles['commons-full-small-1_5x'] = array(
+    'name' => 'commons-full-small-1_5x',
+    'label' => 'Commons full small 1.5x',
+    'effects' => array(
+      21 => array(
+        'label' => 'Scale',
+        'help' => 'Scaling will maintain the aspect-ratio of the original image. If only a single dimension is specified, the other dimension will be calculated.',
+        'effect callback' => 'image_scale_effect',
+        'dimensions callback' => 'image_scale_dimensions',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'image',
+        'name' => 'image_scale',
+        'data' => array(
+          'width' => 684,
+          'height' => 750,
+          'upscale' => 0,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-teaser-large.
+  $styles['commons-teaser-large'] = array(
+    'name' => 'commons-teaser-large',
+    'label' => 'Commons teaser large',
+    'effects' => array(
+      16 => array(
+        'label' => 'Scale and Smart Crop',
+        'help' => 'Similar to "Scale And Crop", but preserves the portion of the image with the most entropy.',
+        'effect callback' => 'smartcrop_scale_effect',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'smartcrop',
+        'name' => 'smartcrop_scale_and_crop',
+        'data' => array(
+          'width' => 124,
+          'height' => 124,
+          'upscale' => 1,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-teaser-large-1_5x.
+  $styles['commons-teaser-large-1_5x'] = array(
+    'name' => 'commons-teaser-large-1_5x',
+    'label' => 'Commons teaser large 1.5x',
+    'effects' => array(
+      17 => array(
+        'label' => 'Scale and Smart Crop',
+        'help' => 'Similar to "Scale And Crop", but preserves the portion of the image with the most entropy.',
+        'effect callback' => 'smartcrop_scale_effect',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'smartcrop',
+        'name' => 'smartcrop_scale_and_crop',
+        'data' => array(
+          'width' => 186,
+          'height' => 186,
+          'upscale' => 1,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-teaser-medium.
+  $styles['commons-teaser-medium'] = array(
+    'name' => 'commons-teaser-medium',
+    'label' => 'Commons teaser medium',
+    'effects' => array(
+      14 => array(
+        'label' => 'Scale and Smart Crop',
+        'help' => 'Similar to "Scale And Crop", but preserves the portion of the image with the most entropy.',
+        'effect callback' => 'smartcrop_scale_effect',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'smartcrop',
+        'name' => 'smartcrop_scale_and_crop',
+        'data' => array(
+          'width' => 72,
+          'height' => 72,
+          'upscale' => 1,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-teaser-medium-1_5x.
+  $styles['commons-teaser-medium-1_5x'] = array(
+    'name' => 'commons-teaser-medium-1_5x',
+    'label' => 'Commons teaser medium 1.5x',
+    'effects' => array(
+      15 => array(
+        'label' => 'Scale and Smart Crop',
+        'help' => 'Similar to "Scale And Crop", but preserves the portion of the image with the most entropy.',
+        'effect callback' => 'smartcrop_scale_effect',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'smartcrop',
+        'name' => 'smartcrop_scale_and_crop',
+        'data' => array(
+          'width' => 108,
+          'height' => 108,
+          'upscale' => 1,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-teaser-small.
+  $styles['commons-teaser-small'] = array(
+    'name' => 'commons-teaser-small',
+    'label' => 'Commons teaser small',
+    'effects' => array(
+      12 => array(
+        'label' => 'Scale and Smart Crop',
+        'help' => 'Similar to "Scale And Crop", but preserves the portion of the image with the most entropy.',
+        'effect callback' => 'smartcrop_scale_effect',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'smartcrop',
+        'name' => 'smartcrop_scale_and_crop',
+        'data' => array(
+          'width' => 54,
+          'height' => 54,
+          'upscale' => 1,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  // Exported image style: commons-teaser-small-1_5x.
+  $styles['commons-teaser-small-1_5x'] = array(
+    'name' => 'commons-teaser-small-1_5x',
+    'label' => 'Commons teaser small 1.5x',
+    'effects' => array(
+      13 => array(
+        'label' => 'Scale and Smart Crop',
+        'help' => 'Similar to "Scale And Crop", but preserves the portion of the image with the most entropy.',
+        'effect callback' => 'smartcrop_scale_effect',
+        'form callback' => 'image_scale_form',
+        'summary theme' => 'image_scale_summary',
+        'module' => 'smartcrop',
+        'name' => 'smartcrop_scale_and_crop',
+        'data' => array(
+          'width' => 81,
+          'height' => 81,
+          'upscale' => 1,
+        ),
+        'weight' => 1,
+      ),
+    ),
+  );
+
+  return $styles;
+}
diff --git a/profiles/commons/modules/commons/commons_images/commons_images.info b/profiles/commons/modules/commons/commons_images/commons_images.info
new file mode 100644
index 0000000..c465d81
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_images/commons_images.info
@@ -0,0 +1,52 @@
+name = Commons Images
+description = Image styles used in the Commons distribution
+core = 7.x
+package = Commons - Building blocks
+project = commons_images
+dependencies[] = breakpoints
+dependencies[] = ctools
+dependencies[] = file_entity
+dependencies[] = image
+dependencies[] = picture
+dependencies[] = smartcrop
+features[breakpoint_group][] = commons_default
+features[breakpoint_group][] = commons_full
+features[breakpoint_group][] = commons_origins
+features[breakpoint_group][] = commons_teaser
+features[breakpoints][] = breakpoints.theme.commons_origins.commons large
+features[breakpoints][] = breakpoints.theme.commons_origins.commons medium landscape
+features[breakpoints][] = breakpoints.theme.commons_origins.commons medium portrait
+features[breakpoints][] = breakpoints.theme.commons_origins.commons small landscape
+features[breakpoints][] = breakpoints.theme.commons_origins.commons small portrait
+features[ctools][] = breakpoints:default_breakpoint_group:1
+features[ctools][] = breakpoints:default_breakpoints:1
+features[ctools][] = picture:default_picture_mapping:1
+features[features_api][] = api:2
+features[image][] = commons-default-large
+features[image][] = commons-default-large-1_5x
+features[image][] = commons-default-medium
+features[image][] = commons-default-medium-1_5x
+features[image][] = commons-default-small
+features[image][] = commons-default-small-1_5x
+features[image][] = commons-full-large
+features[image][] = commons-full-large-1_5x
+features[image][] = commons-full-medium
+features[image][] = commons-full-medium-1_5
+features[image][] = commons-full-small
+features[image][] = commons-full-small-1_5x
+features[image][] = commons-teaser-large
+features[image][] = commons-teaser-large-1_5x
+features[image][] = commons-teaser-medium
+features[image][] = commons-teaser-medium-1_5x
+features[image][] = commons-teaser-small
+features[image][] = commons-teaser-small-1_5x
+features[picture_mapping][] = commons_default
+features[picture_mapping][] = commons_full
+features[picture_mapping][] = commons_teaser
+
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
+core = "7.x"
+project = "commons"
+datestamp = "1389902308"
+
diff --git a/profiles/commons/modules/commons/commons_images/commons_images.module b/profiles/commons/modules/commons/commons_images/commons_images.module
new file mode 100644
index 0000000..f3ec52e
--- /dev/null
+++ b/profiles/commons/modules/commons/commons_images/commons_images.module
@@ -0,0 +1,76 @@
+<?php
+/**
+ * @file
+ * Code for the Commons Images feature.
+ */
+
+include_once 'commons_images.features.inc';
+
+/**
+ * Implements hook_file_default_displays_alter().
+ */
+function commons_images_file_default_displays_alter(&$file_displays) {
+  // Copy all default image formatters to full image formatters.
+  foreach ($file_displays as $file_display) {
+    if (strpos($file_display->name, 'image__default__') !== false) {
+      $display = clone $file_display;
+      $name = str_replace('image__default__', 'image__full__', $display->name);
+      $display->name = $name;
+      $file_displays[$name] = $display;
+    }
+  }
+
+  // Default images should be displayed using the 'default' picture group.
+  if (isset($file_displays['image__default__file_field_image'])) {
+    $file_displays['image__default__file_field_image']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__default__file_field_picture';
+  $file_display->weight = 1;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'picture_group' => 'commons_default',
+    'fallback_image_style' => 'commons-default-small',
+    'image_link' => 'content',
+    'colorbox' => 'commons_default',
+  );
+  $file_displays['image__default__file_field_picture'] = $file_display;
+
+  // Full images should be displayed using the 'full' picture group.
+  if (isset($file_displays['image__full__file_field_image'])) {
+    $file_displays['image__full__file_field_image']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__full__file_field_picture';
+  $file_display->weight = 1;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'picture_group' => 'commons_full',
+    'fallback_image_style' => 'commons-full-small',
+    'image_link' => '',
+    'colorbox' => 'commons_full',
+  );
+  $file_displays['image__full__file_field_picture'] = $file_display;
+
+  // Teaser images should be displayed using the 'teaser' picture group.
+  if (isset($file_displays['image__teaser__file_field_image'])) {
+    $file_displays['image__teaser__file_field_image']->status = FALSE;
+  }
+
+  $file_display = new stdClass();
+  $file_display->api_version = 1;
+  $file_display->name = 'image__teaser__file_field_picture';
+  $file_display->weight = -1;
+  $file_display->status = TRUE;
+  $file_display->settings = array(
+    'picture_group' => 'commons_teaser',
+    'fallback_image_style' => 'commons-teaser-small',
+    'image_link' => '',
+    'colorbox' => 'commons_teaser',
+  );
+  $file_displays['image__teaser__file_field_picture'] = $file_display;
+}
diff --git a/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.info b/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.info
index 369a5cd..a0ebcbf 100644
--- a/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.info
+++ b/profiles/commons/modules/commons/commons_kissmetrics/commons_kissmetrics.info
@@ -30,9 +30,9 @@ features[rules_config][] = rules_commons_kissmetrics_user_registers
 features[rules_config][] = rules_commons_kissmetrics_user_replies_to_private_message_thread
 features[rules_config][] = rules_commons_kissmetrics_user_starts_new_private_message_thread
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_like/commons_like.info b/profiles/commons/modules/commons/commons_like/commons_like.info
index 3779175..c049727 100644
--- a/profiles/commons/modules/commons/commons_like/commons_like.info
+++ b/profiles/commons/modules/commons/commons_like/commons_like.info
@@ -13,9 +13,9 @@ features[features_api][] = api:2
 features[field_instance][] = message-commons_like_user_likes_node-field_target_nodes
 features[message_type][] = commons_like_user_likes_node
 features[variable][] = rate_widgets
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_location/commons_location.info b/profiles/commons/modules/commons/commons_location/commons_location.info
index d58590a..ff3f815 100644
--- a/profiles/commons/modules/commons/commons_location/commons_location.info
+++ b/profiles/commons/modules/commons/commons_location/commons_location.info
@@ -8,9 +8,9 @@ dependencies[] = field_sql_storage
 features[features_api][] = api:2
 features[field_base][] = field_address
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.features.field_instance.inc b/profiles/commons/modules/commons/commons_media/commons_media.features.field_instance.inc
index b8afdfa..8167728 100644
--- a/profiles/commons/modules/commons/commons_media/commons_media.features.field_instance.inc
+++ b/profiles/commons/modules/commons/commons_media/commons_media.features.field_instance.inc
@@ -33,7 +33,7 @@ function commons_media_field_definition(&$field_instances, $entity_type, $bundle
         'label' => 'hidden',
         'module' => 'file_entity',
         'settings' => array(
-          'file_view_mode' => 'full',
+          'file_view_mode' => 'default',
         ),
         'type' => 'file_rendered',
         'weight' => 0,
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.info b/profiles/commons/modules/commons/commons_media/commons_media.info
index d9f31cc..bc3737f 100644
--- a/profiles/commons/modules/commons/commons_media/commons_media.info
+++ b/profiles/commons/modules/commons/commons_media/commons_media.info
@@ -17,9 +17,9 @@ features[user_permission][] = add media from remote sources
 features[user_permission][] = create files
 features[variable][] = media__dialog_theme
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_media/commons_media.module b/profiles/commons/modules/commons/commons_media/commons_media.module
index 0a6d434..c732863 100644
--- a/profiles/commons/modules/commons/commons_media/commons_media.module
+++ b/profiles/commons/modules/commons/commons_media/commons_media.module
@@ -24,6 +24,22 @@ function commons_media_system_info_alter(&$info, $file, $type) {
 }
 
 /**
+ * Implements hook_element_info_alter().
+ */
+function commons_media_element_info_alter(&$type) {
+  $type['media']['#process'][] = 'commons_media_rename_media_buttons';
+}
+
+/**
+ * Extra #process callback which renames the media element buttons.
+ */
+function commons_media_rename_media_buttons($element, $edit, &$form_state) {
+  $element['select']['#title'] = t('Attach media');
+
+  return $element;
+}
+
+/**
  * Implements hook_file_view_alter().
  */
 function commons_media_file_view_alter(&$build) {
diff --git a/profiles/commons/modules/commons/commons_misc/commons_misc.info b/profiles/commons/modules/commons/commons_misc/commons_misc.info
index c5fc69c..33a0f52 100644
--- a/profiles/commons/modules/commons/commons_misc/commons_misc.info
+++ b/profiles/commons/modules/commons/commons_misc/commons_misc.info
@@ -25,9 +25,9 @@ features[variable][] = theme_commons_origins_settings
 features[variable][] = user_register
 features_exclude[dependencies][page_manager] = page_manager
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_notices/commons_notices.info b/profiles/commons/modules/commons/commons_notices/commons_notices.info
index 4c5c5e0..51899fd 100644
--- a/profiles/commons/modules/commons/commons_notices/commons_notices.info
+++ b/profiles/commons/modules/commons/commons_notices/commons_notices.info
@@ -28,9 +28,9 @@ features[variable][] = node_preview_notice
 features[variable][] = node_submitted_notice
 features[views_view][] = commons_notices_latest_notices
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_notify/commons_notify.info b/profiles/commons/modules/commons/commons_notify/commons_notify.info
index b85c1b3..5e57e4c 100644
--- a/profiles/commons/modules/commons/commons_notify/commons_notify.info
+++ b/profiles/commons/modules/commons/commons_notify/commons_notify.info
@@ -49,9 +49,9 @@ features_exclude[field_base][message_text] = message_text
 features_exclude[field_base][field_target_nodes] = field_target_nodes
 features_exclude[field_base][field_target_comments] = field_target_comments
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_pages/commons_pages.info b/profiles/commons/modules/commons/commons_pages/commons_pages.info
index 1a7fd7e..ccfd40d 100644
--- a/profiles/commons/modules/commons/commons_pages/commons_pages.info
+++ b/profiles/commons/modules/commons/commons_pages/commons_pages.info
@@ -26,9 +26,9 @@ features[variable][] = node_preview_page
 features[variable][] = node_submitted_page
 features[variable][] = pathauto_node_page_pattern
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_polls/commons_polls.info b/profiles/commons/modules/commons/commons_polls/commons_polls.info
index a6caee8..95b9dcb 100644
--- a/profiles/commons/modules/commons/commons_polls/commons_polls.info
+++ b/profiles/commons/modules/commons/commons_polls/commons_polls.info
@@ -45,9 +45,9 @@ features[variable][] = node_preview_poll
 features[variable][] = node_submitted_poll
 features[views_view][] = commons_bw_polls
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_polls/commons_polls.module b/profiles/commons/modules/commons/commons_polls/commons_polls.module
index 98b89fd..3a87629 100644
--- a/profiles/commons/modules/commons/commons_polls/commons_polls.module
+++ b/profiles/commons/modules/commons/commons_polls/commons_polls.module
@@ -90,7 +90,7 @@ function commons_polls_form_commons_bw_partial_node_form_alter(&$form, &$form_st
 
   // Prepare the form for collapsing.
   $form['body']['#attributes']['class'][] = 'trigger-field';
-  foreach (array('field_image', 'og_group_ref', 'choice_wrapper', 'actions') as $field) {
+  foreach (array('field_media', 'field_image', 'og_group_ref', 'choice_wrapper', 'actions') as $field) {
     if (isset($form[$field])) {
       $form[$field]['#attributes']['class'][] = 'hideable-field';
     }
diff --git a/profiles/commons/modules/commons/commons_posts/commons_posts.info b/profiles/commons/modules/commons/commons_posts/commons_posts.info
index 5fe926b..3a2d42d 100644
--- a/profiles/commons/modules/commons/commons_posts/commons_posts.info
+++ b/profiles/commons/modules/commons/commons_posts/commons_posts.info
@@ -51,9 +51,9 @@ features[variable][] = node_preview_post
 features[variable][] = node_submitted_post
 features[views_view][] = commons_bw_posts
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_posts/commons_posts.module b/profiles/commons/modules/commons/commons_posts/commons_posts.module
index ab59e3f..a14d1eb 100644
--- a/profiles/commons/modules/commons/commons_posts/commons_posts.module
+++ b/profiles/commons/modules/commons/commons_posts/commons_posts.module
@@ -57,7 +57,7 @@ function commons_posts_form_commons_bw_partial_node_form_alter(&$form, &$form_st
 
   // Set fields as hideable so the forms can be compacted.
   $form['body']['#attributes']['class'][] = 'trigger-field';
-  foreach (array('field_image', 'og_group_ref', 'choice_wrapper', 'actions') as $field) {
+  foreach (array('field_media', 'field_image', 'og_group_ref', 'choice_wrapper', 'actions') as $field) {
     if (isset($form[$field])) {
       $form[$field]['#attributes']['class'][] = 'hideable-field';
     }
diff --git a/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.info b/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.info
index 273a227..7e5e034 100644
--- a/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.info
+++ b/profiles/commons/modules/commons/commons_profile_base/commons_profile_base.info
@@ -18,9 +18,9 @@ features[variable][] = user_picture_file_size
 features[variable][] = user_picture_style
 features[variable][] = user_pictures
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_profile_social/commons_profile_social.info b/profiles/commons/modules/commons/commons_profile_social/commons_profile_social.info
index ea14e00..c727def 100644
--- a/profiles/commons/modules/commons/commons_profile_social/commons_profile_social.info
+++ b/profiles/commons/modules/commons/commons_profile_social/commons_profile_social.info
@@ -12,9 +12,9 @@ features[field_base][] = field_twitter_url
 features[field_instance][] = user-user-field_facebook_url
 features[field_instance][] = user-user-field_linkedin_url
 features[field_instance][] = user-user-field_twitter_url
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_q_a/commons_q_a.info b/profiles/commons/modules/commons/commons_q_a/commons_q_a.info
index 3a6632d..05a18f7 100644
--- a/profiles/commons/modules/commons/commons_q_a/commons_q_a.info
+++ b/profiles/commons/modules/commons/commons_q_a/commons_q_a.info
@@ -94,9 +94,9 @@ features_exclude[field_instance][og_group_ref] = og_group_ref
 features_exclude[field_instance][node-answer-og_group_ref] = node-answer-og_group_ref
 features_exclude[field_instance][node-question-og_group_ref] = node-question-og_group_ref
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_q_a/commons_q_a.module b/profiles/commons/modules/commons/commons_q_a/commons_q_a.module
index f27edbe..f7270a6 100644
--- a/profiles/commons/modules/commons/commons_q_a/commons_q_a.module
+++ b/profiles/commons/modules/commons/commons_q_a/commons_q_a.module
@@ -75,7 +75,7 @@ function commons_q_a_form_commons_bw_partial_node_form_alter(&$form, &$form_stat
 
   // Set fields as hideable so the forms can be compacted.
   $form['body']['#attributes']['class'][] = 'trigger-field';
-  foreach (array('field_image', 'og_group_ref', 'choice_wrapper', 'actions') as $field) {
+  foreach (array('field_media', 'field_image', 'og_group_ref', 'choice_wrapper', 'actions') as $field) {
     if (isset($form[$field])) {
       $form[$field]['#attributes']['class'][] = 'hideable-field';
     }
diff --git a/profiles/commons/modules/commons/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info b/profiles/commons/modules/commons/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
index cf04e10..8ba2d5f 100644
--- a/profiles/commons/modules/commons/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
+++ b/profiles/commons/modules/commons/commons_q_a/modules/commons_q_a_pages/commons_q_a_pages.info
@@ -12,9 +12,9 @@ features[panelizer_defaults][] = node:question:default
 features[variable][] = panelizer_defaults_node_answer
 features[variable][] = panelizer_defaults_node_question
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.info b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.info
index 41b39d5..99804e6 100644
--- a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.info
+++ b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity.info
@@ -17,9 +17,9 @@ features[radioactivity_decay_profile][] = commons_ra_node
 features[variable][] = commons_radioactivity_entity_types
 features[views_view][] = commons_radioactivity_admin
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity_groups/commons_radioactivity_groups.info b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity_groups/commons_radioactivity_groups.info
index 43c866d..0421ab7 100644
--- a/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity_groups/commons_radioactivity_groups.info
+++ b/profiles/commons/modules/commons/commons_radioactivity/commons_radioactivity_groups/commons_radioactivity_groups.info
@@ -11,9 +11,9 @@ features[features_api][] = api:2
 features[views_view][] = commons_radioactivity_groups_active_in_group
 features[views_view][] = commons_radioactivity_groups_most_active
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_search/commons_search.info b/profiles/commons/modules/commons/commons_search/commons_search.info
index 63e9a74..075879c 100644
--- a/profiles/commons/modules/commons/commons_search/commons_search.info
+++ b/profiles/commons/modules/commons/commons_search/commons_search.info
@@ -61,9 +61,9 @@ features[variable][] = custom_search_type_selector_all
 features[variable][] = custom_search_type_selector_label
 features[variable][] = custom_search_type_selector_label_visibility
 features[views_view][] = group_search
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_search/modules/commons_search_core/commons_search_core.info b/profiles/commons/modules/commons/commons_search/modules/commons_search_core/commons_search_core.info
index 906d9c5..2cbacbd 100644
--- a/profiles/commons/modules/commons/commons_search/modules/commons_search_core/commons_search_core.info
+++ b/profiles/commons/modules/commons/commons_search/modules/commons_search_core/commons_search_core.info
@@ -30,9 +30,9 @@ features[variable][] = search_active_modules
 features[variable][] = search_default_module
 features_exclude[dependencies][ctools] = ctools
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/commons_search_solr.info b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/commons_search_solr.info
index 378b048..5c4e925 100644
--- a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/commons_search_solr.info
+++ b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr/commons_search_solr.info
@@ -28,9 +28,9 @@ features[variable][] = pm_existing_pages_disabled_solr_search
 features[variable][] = search_active_modules
 features[variable][] = search_default_module
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr_user/commons_search_solr_user.info b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr_user/commons_search_solr_user.info
index be7cdd2..ee01f8b 100644
--- a/profiles/commons/modules/commons/commons_search/modules/commons_search_solr_user/commons_search_solr_user.info
+++ b/profiles/commons/modules/commons/commons_search/modules/commons_search_solr_user/commons_search_solr_user.info
@@ -12,9 +12,9 @@ features[apachesolr_search_page][] = user_search
 features[ctools][] = apachesolr_search:apachesolr_search_defaults:3
 features[features_api][] = api:1
 features[menu_links][] = main-menu:people
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_site_homepage/commons_site_homepage.info b/profiles/commons/modules/commons/commons_site_homepage/commons_site_homepage.info
index 554befa..0883967 100644
--- a/profiles/commons/modules/commons/commons_site_homepage/commons_site_homepage.info
+++ b/profiles/commons/modules/commons/commons_site_homepage/commons_site_homepage.info
@@ -20,9 +20,9 @@ features[variable][] = site_frontpage
 features[views_view][] = commons_homepage_content
 features_exclude[dependencies][views_content] = views_content
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_social_sharing/commons_social_sharing.info b/profiles/commons/modules/commons/commons_social_sharing/commons_social_sharing.info
index 23184fa..56f267a 100644
--- a/profiles/commons/modules/commons/commons_social_sharing/commons_social_sharing.info
+++ b/profiles/commons/modules/commons/commons_social_sharing/commons_social_sharing.info
@@ -17,9 +17,9 @@ features[variable][] = sharethis_teaser_option
 features[variable][] = sharethis_weight
 features[variable][] = sharethis_widget_option
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_topics/commons_topics.info b/profiles/commons/modules/commons/commons_topics/commons_topics.info
index f1877df..8525951 100644
--- a/profiles/commons/modules/commons/commons_topics/commons_topics.info
+++ b/profiles/commons/modules/commons/commons_topics/commons_topics.info
@@ -7,9 +7,9 @@ features[features_api][] = api:2
 features[field_base][] = field_topics
 features[taxonomy][] = topics
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.info b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.info
index 7da203e..21694cf 100644
--- a/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.info
+++ b/profiles/commons/modules/commons/commons_trusted_contacts/commons_trusted_contacts.info
@@ -53,9 +53,9 @@ features_exclude[field][message-trusted_contact_request_approved-field_approving
 features_exclude[field][message-trusted_contact_request_pending-field_requesting_user] = message-trusted_contact_request_pending-field_requesting_user
 files[] = views/handlers/commons_groups_handler_send_message.inc
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_user_profile_pages/commons_user_profile_pages.info b/profiles/commons/modules/commons/commons_user_profile_pages/commons_user_profile_pages.info
index 05c4aa4..53feb18 100644
--- a/profiles/commons/modules/commons/commons_user_profile_pages/commons_user_profile_pages.info
+++ b/profiles/commons/modules/commons/commons_user_profile_pages/commons_user_profile_pages.info
@@ -12,9 +12,9 @@ features[ctools][] = page_manager:pages_default:1
 features[features_api][] = api:2
 features[page_manager_handlers][] = user_view_panel_context
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_utility_links/commons_utility_links.info b/profiles/commons/modules/commons/commons_utility_links/commons_utility_links.info
index 6b87969..1180654 100644
--- a/profiles/commons/modules/commons/commons_utility_links/commons_utility_links.info
+++ b/profiles/commons/modules/commons/commons_utility_links/commons_utility_links.info
@@ -1,9 +1,9 @@
 core = 7.x
 name = Commons Utility links block
 package = "Commons - Building blocks"
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_wikis/commons_wikis.info b/profiles/commons/modules/commons/commons_wikis/commons_wikis.info
index 3b3fc30..11ec040 100644
--- a/profiles/commons/modules/commons/commons_wikis/commons_wikis.info
+++ b/profiles/commons/modules/commons/commons_wikis/commons_wikis.info
@@ -62,9 +62,9 @@ features[views_view][] = commons_bw_wikis
 features[views_view][] = commons_wikis_contributor_list
 features_exclude[dependencies][commons_trusted_contacts] = commons_trusted_contacts
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_wikis/commons_wikis.module b/profiles/commons/modules/commons/commons_wikis/commons_wikis.module
index 9c571a8..20cf44b 100644
--- a/profiles/commons/modules/commons/commons_wikis/commons_wikis.module
+++ b/profiles/commons/modules/commons/commons_wikis/commons_wikis.module
@@ -163,7 +163,6 @@ function commons_wikis_commons_entity_integration() {
     'node' => array(
       'wiki' => array(
         'auto_title_instance' => FALSE,
-        'media' => TRUE,
       ),
     ),
   );
diff --git a/profiles/commons/modules/commons/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info b/profiles/commons/modules/commons/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
index b2309a7..d8c7a52 100644
--- a/profiles/commons/modules/commons/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
+++ b/profiles/commons/modules/commons/commons_wikis/modules/commons_wikis_pages/commons_wikis_pages.info
@@ -12,9 +12,9 @@ features[features_api][] = api:2
 features[panelizer_defaults][] = node:wiki:default
 features[variable][] = panelizer_defaults_node_wiki
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/commons/commons_wysiwyg/commons_wysiwyg.info b/profiles/commons/modules/commons/commons_wysiwyg/commons_wysiwyg.info
index 10b7bc2..1273f83 100644
--- a/profiles/commons/modules/commons/commons_wysiwyg/commons_wysiwyg.info
+++ b/profiles/commons/modules/commons/commons_wysiwyg/commons_wysiwyg.info
@@ -12,9 +12,9 @@ features[filter][] = filtered_html
 features[filter][] = full_html
 features[user_permission][] = use text format filtered_html
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/modules/contrib/admin_icons/admin_icons.info b/profiles/commons/modules/contrib/admin_icons/admin_icons.info
index 1eb8ba9..b894a8e 100644
--- a/profiles/commons/modules/contrib/admin_icons/admin_icons.info
+++ b/profiles/commons/modules/contrib/admin_icons/admin_icons.info
@@ -4,8 +4,8 @@ core = 7.x
 
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = ""
 project = "admin_icons"
-datestamp = "1389381849"
+datestamp = "1389902333"
 
diff --git a/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info b/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
index acdb772..2cb3a4e 100644
--- a/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
+++ b/profiles/commons/modules/contrib/apachesolr_og/apachesolr_og.info
@@ -7,9 +7,9 @@ dependencies[] = apachesolr
 dependencies[] = og
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0+2-dev"
 core = "7.x"
 project = "apachesolr_og"
-datestamp = "1389381844"
+datestamp = "1389902332"
 
diff --git a/profiles/commons/modules/contrib/apachesolr_user/apachesolr_user.info b/profiles/commons/modules/contrib/apachesolr_user/apachesolr_user.info
index e8095b1..4022f4a 100644
--- a/profiles/commons/modules/contrib/apachesolr_user/apachesolr_user.info
+++ b/profiles/commons/modules/contrib/apachesolr_user/apachesolr_user.info
@@ -6,8 +6,8 @@ package = Search Toolkit
 core = 7.x
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = ""
 project = "apachesolr_user"
-datestamp = "1389381842"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/breakpoints/breakpoints.info b/profiles/commons/modules/contrib/breakpoints/breakpoints.info
index 1a3a694..d74ef60 100644
--- a/profiles/commons/modules/contrib/breakpoints/breakpoints.info
+++ b/profiles/commons/modules/contrib/breakpoints/breakpoints.info
@@ -5,9 +5,10 @@ dependencies[] = ctools
 files[] = breakpoints.module
 files[] = breakpoints.test
 configure = admin/config/media/breakpoints
-; Information added by drupal.org packaging script on 2013-06-15
-version = "7.x-1.1"
+
+; Information added by drush on 2014-01-16
+version = "7.x-1.1+1-dev"
 core = "7.x"
 project = "breakpoints"
-datestamp = "1371310550"
+datestamp = "1389902343"
 
diff --git a/profiles/commons/modules/contrib/breakpoints/breakpoints.module b/profiles/commons/modules/contrib/breakpoints/breakpoints.module
index 226b0b9..2164183 100644
--- a/profiles/commons/modules/contrib/breakpoints/breakpoints.module
+++ b/profiles/commons/modules/contrib/breakpoints/breakpoints.module
@@ -856,3 +856,18 @@ function breakpoints_form_system_theme_settings_alter_submit(&$form, &$form_stat
     breakpoints_themes_enabled(array($theme));
   }
 }
+
+/**
+ * Implements hook_features_export().
+ */
+function breakpoint_group_features_export($data, &$export, $module_name = '') {
+  features_include();
+  $pipe = ctools_component_features_export('breakpoint_group', $data, $export, $module_name);
+  foreach ($data as $group_name) {
+    $group = breakpoints_breakpoint_group_load($group_name);
+    foreach ($group->breakpoints as $breakpoint_name) {
+      $pipe['breakpoints'][] = $breakpoint_name;
+    }
+  }
+  return $pipe;
+}
diff --git a/profiles/commons/modules/contrib/breakpoints/tests/breakpoints_theme_test.info b/profiles/commons/modules/contrib/breakpoints/tests/breakpoints_theme_test.info
index dc0c0eb..c665941 100644
--- a/profiles/commons/modules/contrib/breakpoints/tests/breakpoints_theme_test.info
+++ b/profiles/commons/modules/contrib/breakpoints/tests/breakpoints_theme_test.info
@@ -4,9 +4,10 @@ package = Other
 core = 7.x
 hidden = TRUE
 
-; Information added by drupal.org packaging script on 2013-06-15
-version = "7.x-1.1"
+
+; Information added by drush on 2014-01-16
+version = "7.x-1.1+1-dev"
 core = "7.x"
 project = "breakpoints"
-datestamp = "1371310550"
+datestamp = "1389902343"
 
diff --git a/profiles/commons/modules/contrib/breakpoints/tests/themes/breakpoints_test_theme/breakpoints_test_theme.info b/profiles/commons/modules/contrib/breakpoints/tests/themes/breakpoints_test_theme/breakpoints_test_theme.info
index eede6b8..ae0af73 100644
--- a/profiles/commons/modules/contrib/breakpoints/tests/themes/breakpoints_test_theme/breakpoints_test_theme.info
+++ b/profiles/commons/modules/contrib/breakpoints/tests/themes/breakpoints_test_theme/breakpoints_test_theme.info
@@ -9,9 +9,10 @@ breakpoints[narrow] = (min-width: 560px)
 breakpoints[wide] = (min-width: 851px)
 breakpoints[tv] = only screen and (min-width: 3456px)
 
-; Information added by drupal.org packaging script on 2013-06-15
-version = "7.x-1.1"
+
+; Information added by drush on 2014-01-16
+version = "7.x-1.1+1-dev"
 core = "7.x"
 project = "breakpoints"
-datestamp = "1371310550"
+datestamp = "1389902343"
 
diff --git a/profiles/commons/modules/contrib/ckeditor/PATCHES.txt b/profiles/commons/modules/contrib/ckeditor/PATCHES.txt
index d05b8d7..81182d8 100644
--- a/profiles/commons/modules/contrib/ckeditor/PATCHES.txt
+++ b/profiles/commons/modules/contrib/ckeditor/PATCHES.txt
@@ -1,4 +1,5 @@
 The following patches have been applied to this project:
+- https://drupal.org/files/issues/attach-ckeditor-css-1370894-4.patch
 - https://drupal.org/files/issues/ckeditor-accomodate-latest-media-changes-0.patch
 - https://drupal.org/files/issues/ckeditor-remove-external-plugin-declarations-1-alt.patch
 
diff --git a/profiles/commons/modules/contrib/ckeditor/ckeditor.info b/profiles/commons/modules/contrib/ckeditor/ckeditor.info
index 51ef494..bc81b74 100644
--- a/profiles/commons/modules/contrib/ckeditor/ckeditor.info
+++ b/profiles/commons/modules/contrib/ckeditor/ckeditor.info
@@ -5,9 +5,9 @@ package     = User interface
 configure   = admin/config/content/ckeditor
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.13+11-dev"
 core = "7.x"
 project = "ckeditor"
-datestamp = "1389381859"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ckeditor/ckeditor.module b/profiles/commons/modules/contrib/ckeditor/ckeditor.module
index 45d4a17..285557d 100644
--- a/profiles/commons/modules/contrib/ckeditor/ckeditor.module
+++ b/profiles/commons/modules/contrib/ckeditor/ckeditor.module
@@ -269,6 +269,9 @@ function ckeditor_form_user_profile_form_alter(&$form, &$form_state) {
  */
 function ckeditor_element_info_alter(&$types) {
   $types['text_format']['#pre_render'][] = 'ckeditor_pre_render_text_format';
+
+  // Attach the positioning CSS.
+  $types['text_format']['#attached']['css'][] = drupal_get_path('module', 'ckeditor') . '/css/ckeditor.css';
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/ckeditor/css/ckeditor-rtl.css b/profiles/commons/modules/contrib/ckeditor/css/ckeditor-rtl.css
new file mode 100644
index 0000000..5053d2e
--- /dev/null
+++ b/profiles/commons/modules/contrib/ckeditor/css/ckeditor-rtl.css
@@ -0,0 +1,34 @@
+/* Indent & Justify classes */
+
+.rteindent1 {
+  margin-right: 40px;
+  margin-left: 0;
+}
+.rteindent2 {
+  margin-right: 80px;
+  margin-left: 0;
+}
+.rteindent3 {
+  margin-right: 120px;
+  margin-left: 0;
+}
+.rteindent4 {
+  margin-right: 160px;
+  margin-left: 0;
+}
+.rteindent1[dir=ltr] {
+  margin-left: 40px;
+  margin-right: 0;
+}
+.rteindent2[dir=ltr] {
+  margin-left: 80px;
+  margin-right: 0;
+}
+.rteindent3[dir=ltr] {
+  margin-left: 120px;
+  margin-right: 0;
+}
+.rteindent4[dir=ltr] {
+  margin-left: 160px;
+  margin-right: 0;
+}
diff --git a/profiles/commons/modules/contrib/ckeditor/css/ckeditor.admin.css b/profiles/commons/modules/contrib/ckeditor/css/ckeditor.admin.css
new file mode 100644
index 0000000..267481b
--- /dev/null
+++ b/profiles/commons/modules/contrib/ckeditor/css/ckeditor.admin.css
@@ -0,0 +1,118 @@
+/* Toolbar Drag & Drop */
+
+form#ckeditor-admin-profile-form textarea#edit-toolbar {
+    display: none;
+}
+form#ckeditor-admin-profile-form #edit-toolbar + .grippie {
+    display: none;
+}
+div.sortableList {
+    cursor: n-resize;
+}
+div.widthMarker {
+    height: 20px;
+    border-top: 1px dashed #CCC;
+    margin: 10px 0px 0px 1px;
+    padding-left: 1px;
+    text-align: center;
+}
+div.sortableList.group {
+    margin: 20px 0px 0px 0px;
+}
+div.sortableList div.sortableListDiv {
+    height: 30px;
+    margin-bottom: 3px;
+    width: 900px;
+}
+div.sortableList div.sortableListDiv span.sortableListSpan {
+    background-color: #F0F0EE;
+    height: 30px;
+    border-right: 1px dashed #CCC;
+    display: block;
+}
+div.sortableList div.sortableListDiv span.sortableListSpan ul {
+    width: 900px;
+    white-space: nowrap;
+    border: 1px solid #CCC;
+    list-style: none;
+    margin:0px;
+    padding: 0px 0px 0px 1px;
+    height: 30px;
+}
+div.sortableList div.sortableListDiv span.sortableListSpan ul li {
+    list-style: none;
+    cursor: move;
+    height: 18px;
+    min-width: 18px;
+    padding: 2px;
+}
+div.sortableList div.sortableListDiv span.sortableListSpan ul li.group {
+    min-width: 5px;
+    padding-left: 2px;
+}
+div.sortableList div.sortableListDiv span.sortableListSpan ul li img {
+    border: 0;
+    padding: 0;
+    margin: 0
+}
+li.sortableItem {
+    position: relative;
+    float: left;
+    margin: 3px 1px 1px 0px;
+    border: 1px solid #CCC;
+    background-color: #F0F0EE;
+    z-index: 99;
+}
+
+#security-filters .filter-text-formats {
+    float: left;
+    clear: both;
+    width: 15%;
+    font-size: 11px;
+    font-weight: bold;
+    padding: 10px 0px;
+}
+
+#security-filters .filter-text-formats .filter-text-format-status {
+    float: left;
+    padding-right: 20px;
+}
+
+#security-filters .filter-text-formats .enabled {
+    background: url(images/tick.png) no-repeat right center;
+}
+
+#security-filters .filter-text-formats .disabled {
+    background: url(images/delete.png) no-repeat right center;
+}
+
+#security-filters .filter-info {
+    float: left;
+    width: 85%;
+}
+
+#security-filters .fieldset-legend {
+    background: none;
+    padding-left: 10px;
+}
+
+#security-filters .fieldset-legend a {
+    font-weight: normal;
+    font-size: 10px;
+    padding-left: 5px;
+}
+
+#security-filters .filter-wrapper {
+    clear: both;
+    float: left;
+    border-bottom: 1px solid #CCCCCC;
+    width: 100%;
+}
+
+/* Fix for fieldset for-edit-apperance in Firefox*/
+fieldset#edit-appearance div#groupLayout, div#allButtons  {
+  border: 0;
+  padding: 0 0 0 0;
+  margin: 1em 0;
+  overflow: auto;
+}
diff --git a/profiles/commons/modules/contrib/ckeditor/css/ckeditor.css b/profiles/commons/modules/contrib/ckeditor/css/ckeditor.css
new file mode 100644
index 0000000..225ea05
--- /dev/null
+++ b/profiles/commons/modules/contrib/ckeditor/css/ckeditor.css
@@ -0,0 +1,32 @@
+/* Indent & Justify classes */
+
+.rteindent1 {
+    margin-left: 40px;
+}
+.rteindent2 {
+    margin-left: 80px;
+}
+.rteindent3 {
+    margin-left: 120px;
+}
+.rteindent4 {
+    margin-left: 160px;
+}
+.rteleft {
+    text-align: left;
+}
+.rteright {
+    text-align: right;
+}
+.rtecenter {
+    text-align: center;
+}
+.rtejustify {
+    text-align: justify;
+}
+.ibimage_left {
+    float: left;
+}
+.ibimage_right {
+    float: right;
+}
diff --git a/profiles/commons/modules/contrib/ckeditor/css/ckeditor.editor.css b/profiles/commons/modules/contrib/ckeditor/css/ckeditor.editor.css
new file mode 100644
index 0000000..cb03e9f
--- /dev/null
+++ b/profiles/commons/modules/contrib/ckeditor/css/ckeditor.editor.css
@@ -0,0 +1,16 @@
+/* CKEditor padding in IE */
+
+table.cke_editor fieldset {
+    padding: 0 !important;
+}
+/* hack with ie and garland editing area size fix - [#733512] */
+.cke_editor{
+    display: table !important;
+}
+.cke_editor,#ie#bug {
+    display: inline-table !important;
+}
+/* Fix table border for Drupal's Seven theme - [#1020612] */
+.cke_dialog tr td:last-child {
+    border-right: 0;
+}
diff --git a/profiles/commons/modules/contrib/ckeditor/includes/ckeditor.admin.inc b/profiles/commons/modules/contrib/ckeditor/includes/ckeditor.admin.inc
index b4d0450..7d33872 100644
--- a/profiles/commons/modules/contrib/ckeditor/includes/ckeditor.admin.inc
+++ b/profiles/commons/modules/contrib/ckeditor/includes/ckeditor.admin.inc
@@ -581,6 +581,13 @@ function ckeditor_admin_profile_form($form, $form_state, $profile = NULL) {
 
   $lang_options = ckeditor_load_lang_options();
 
+  // Attach the administration CSS.
+  $form['#attached'] = array(
+    'css' => array(
+      drupal_get_path('module', 'ckeditor') . '/css/ckeditor.admin.css',
+    ),
+  );
+
   $form['basic'] = array(
     '#type' => 'fieldset',
     '#title' => t('Basic setup'),
diff --git a/profiles/commons/modules/contrib/ckeditor/includes/ckeditor.lib.inc b/profiles/commons/modules/contrib/ckeditor/includes/ckeditor.lib.inc
index d0948eb..b61000a 100644
--- a/profiles/commons/modules/contrib/ckeditor/includes/ckeditor.lib.inc
+++ b/profiles/commons/modules/contrib/ckeditor/includes/ckeditor.lib.inc
@@ -1191,6 +1191,9 @@ function ckeditor_load_by_field($field, $format, $show_toggle = TRUE, $add_field
     return $field;
   }
 
+  // Attach the editor css.
+  $field['#attached']['css'][] = drupal_get_path('module', 'ckeditor') . '/css/ckeditor.editor.css';
+
   if ($settings) {
     $textarea_id = $field['#id'];
     $class[] = 'ckeditor-mod';
diff --git a/profiles/commons/modules/contrib/ctools/bulk_export/bulk_export.info b/profiles/commons/modules/contrib/ctools/bulk_export/bulk_export.info
index 34b82dc..c12e24d 100644
--- a/profiles/commons/modules/contrib/ctools/bulk_export/bulk_export.info
+++ b/profiles/commons/modules/contrib/ctools/bulk_export/bulk_export.info
@@ -5,9 +5,9 @@ dependencies[] = ctools
 package = Chaos tool suite
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools.info b/profiles/commons/modules/contrib/ctools/ctools.info
index ea189f5..0db724d 100644
--- a/profiles/commons/modules/contrib/ctools/ctools.info
+++ b/profiles/commons/modules/contrib/ctools/ctools.info
@@ -7,9 +7,9 @@ files[] = includes/math-expr.inc
 files[] = includes/stylizer.inc
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools_access_ruleset/ctools_access_ruleset.info b/profiles/commons/modules/contrib/ctools/ctools_access_ruleset/ctools_access_ruleset.info
index 9997eb6..55f8296 100644
--- a/profiles/commons/modules/contrib/ctools/ctools_access_ruleset/ctools_access_ruleset.info
+++ b/profiles/commons/modules/contrib/ctools/ctools_access_ruleset/ctools_access_ruleset.info
@@ -5,9 +5,9 @@ package = Chaos tool suite
 dependencies[] = ctools
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools_ajax_sample/ctools_ajax_sample.info b/profiles/commons/modules/contrib/ctools/ctools_ajax_sample/ctools_ajax_sample.info
index ab9be69..1816e2a 100644
--- a/profiles/commons/modules/contrib/ctools/ctools_ajax_sample/ctools_ajax_sample.info
+++ b/profiles/commons/modules/contrib/ctools/ctools_ajax_sample/ctools_ajax_sample.info
@@ -5,9 +5,9 @@ dependencies[] = ctools
 core = 7.x
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools_custom_content/ctools_custom_content.info b/profiles/commons/modules/contrib/ctools/ctools_custom_content/ctools_custom_content.info
index c95cfc4..f68eb80 100644
--- a/profiles/commons/modules/contrib/ctools/ctools_custom_content/ctools_custom_content.info
+++ b/profiles/commons/modules/contrib/ctools/ctools_custom_content/ctools_custom_content.info
@@ -5,9 +5,9 @@ package = Chaos tool suite
 dependencies[] = ctools
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/ctools_plugin_example/ctools_plugin_example.info b/profiles/commons/modules/contrib/ctools/ctools_plugin_example/ctools_plugin_example.info
index 517baa8..29feb5c 100644
--- a/profiles/commons/modules/contrib/ctools/ctools_plugin_example/ctools_plugin_example.info
+++ b/profiles/commons/modules/contrib/ctools/ctools_plugin_example/ctools_plugin_example.info
@@ -8,9 +8,9 @@ dependencies[] = advanced_help
 core = 7.x
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/page_manager/page_manager.info b/profiles/commons/modules/contrib/ctools/page_manager/page_manager.info
index e615c1e..ddf21a4 100644
--- a/profiles/commons/modules/contrib/ctools/page_manager/page_manager.info
+++ b/profiles/commons/modules/contrib/ctools/page_manager/page_manager.info
@@ -5,9 +5,9 @@ dependencies[] = ctools
 package = Chaos tool suite
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/stylizer/stylizer.info b/profiles/commons/modules/contrib/ctools/stylizer/stylizer.info
index 2ea4749..b042d34 100644
--- a/profiles/commons/modules/contrib/ctools/stylizer/stylizer.info
+++ b/profiles/commons/modules/contrib/ctools/stylizer/stylizer.info
@@ -6,9 +6,9 @@ dependencies[] = ctools
 dependencies[] = color
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/tests/ctools_export_test/ctools_export_test.info b/profiles/commons/modules/contrib/ctools/tests/ctools_export_test/ctools_export_test.info
index 53c373c..81598ba 100644
--- a/profiles/commons/modules/contrib/ctools/tests/ctools_export_test/ctools_export_test.info
+++ b/profiles/commons/modules/contrib/ctools/tests/ctools_export_test/ctools_export_test.info
@@ -8,9 +8,9 @@ hidden = TRUE
 files[] = ctools_export.test
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/tests/ctools_plugin_test.info b/profiles/commons/modules/contrib/ctools/tests/ctools_plugin_test.info
index d2c86eb..885ab1e 100644
--- a/profiles/commons/modules/contrib/ctools/tests/ctools_plugin_test.info
+++ b/profiles/commons/modules/contrib/ctools/tests/ctools_plugin_test.info
@@ -12,9 +12,9 @@ files[] = math_expression_stack.test
 hidden = TRUE
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/ctools/views_content/views_content.info b/profiles/commons/modules/contrib/ctools/views_content/views_content.info
index 7734771..4942ed0 100644
--- a/profiles/commons/modules/contrib/ctools/views_content/views_content.info
+++ b/profiles/commons/modules/contrib/ctools/views_content/views_content.info
@@ -10,9 +10,9 @@ files[] = plugins/views/views_content_plugin_display_panel_pane.inc
 files[] = plugins/views/views_content_plugin_style_ctools_context.inc
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.3+4-dev"
 core = "7.x"
 project = "ctools"
-datestamp = "1389381834"
+datestamp = "1389902331"
 
diff --git a/profiles/commons/modules/contrib/custom_search/custom_search.info b/profiles/commons/modules/contrib/custom_search/custom_search.info
index 02b8af7..996de61 100644
--- a/profiles/commons/modules/contrib/custom_search/custom_search.info
+++ b/profiles/commons/modules/contrib/custom_search/custom_search.info
@@ -7,9 +7,9 @@ dependencies[] = search
 
 configure = admin/config/search/custom_search
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.12+1-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1389381843"
+datestamp = "1389902339"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
index d4f2816..577ccaf 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_blocks/custom_search_blocks.info
@@ -8,9 +8,9 @@ dependencies[] = custom_search
 
 configure = admin/config/search/custom_search/blocks
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.12+1-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1389381843"
+datestamp = "1389902339"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
index 49b7718..1e9335d 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_i18n/custom_search_i18n.info
@@ -6,9 +6,9 @@ package = Search
 dependencies[] = custom_search
 dependencies[] = i18n_string
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.12+1-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1389381843"
+datestamp = "1389902339"
 
diff --git a/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info b/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
index b15a490..be3de90 100644
--- a/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
+++ b/profiles/commons/modules/contrib/custom_search/modules/custom_search_taxonomy/custom_search_taxonomy.info
@@ -8,9 +8,9 @@ dependencies[] = taxonomy
 
 configure = admin/config/search/custom_search/taxonomy
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.12+1-dev"
 core = "7.x"
 project = "custom_search"
-datestamp = "1389381843"
+datestamp = "1389902339"
 
diff --git a/profiles/commons/modules/contrib/i18nviews/i18nviews.info b/profiles/commons/modules/contrib/i18nviews/i18nviews.info
index c68dfef..35df1fe 100644
--- a/profiles/commons/modules/contrib/i18nviews/i18nviews.info
+++ b/profiles/commons/modules/contrib/i18nviews/i18nviews.info
@@ -27,8 +27,8 @@ files[] = includes/i18nviews_handler_filter_term_node_tid_depth.inc
 files[] = includes/i18nviews_plugin_argument_validate_i18n_taxonomy_term.inc
 files[] = includes/i18nviews_plugin_localization_i18nstrings.inc
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = ""
 project = "i18nviews"
-datestamp = "1389381830"
+datestamp = "1389902327"
 
diff --git a/profiles/commons/modules/contrib/media/media.info b/profiles/commons/modules/contrib/media/media.info
index 4d8e752..c70820d 100644
--- a/profiles/commons/modules/contrib/media/media.info
+++ b/profiles/commons/modules/contrib/media/media.info
@@ -25,9 +25,9 @@ configure = admin/config/media/browser
 version = 7.x-2.x-dev
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.0-alpha3+37-dev"
 core = "7.x"
 project = "media"
-datestamp = "1389381830"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.info b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.info
index 8c503db..50d3fdf 100644
--- a/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.info
+++ b/profiles/commons/modules/contrib/media/modules/media_bulk_upload/media_bulk_upload.info
@@ -10,9 +10,9 @@ dependencies[] = plupload
 files[] = includes/MediaBrowserBulkUpload.inc
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.0-alpha3+37-dev"
 core = "7.x"
 project = "media"
-datestamp = "1389381830"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.info b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.info
index 1b55dff..ef87528 100644
--- a/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.info
+++ b/profiles/commons/modules/contrib/media/modules/media_internet/media_internet.info
@@ -12,9 +12,9 @@ files[] = includes/MediaInternetNoHandlerException.inc
 files[] = includes/MediaInternetValidationException.inc
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.0-alpha3+37-dev"
 core = "7.x"
 project = "media"
-datestamp = "1389381830"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.info b/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.info
index 3dceb8e..2229d93 100644
--- a/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.info
+++ b/profiles/commons/modules/contrib/media/modules/media_migrate_file_types/media_migrate_file_types.info
@@ -9,9 +9,9 @@ dependencies[] = media
 configure = admin/structure/file-types/upgrade
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.0-alpha3+37-dev"
 core = "7.x"
 project = "media"
-datestamp = "1389381830"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.info b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.info
index 5deffe6..bc40f50 100644
--- a/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.info
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg/media_wysiwyg.info
@@ -16,9 +16,9 @@ files[] = tests/media_wysiwyg.macro.test
 configure = admin/config/media/browser
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.0-alpha3+37-dev"
 core = "7.x"
 project = "media"
-datestamp = "1389381830"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.info b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.info
index 29085ec..b66afe6 100644
--- a/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.info
+++ b/profiles/commons/modules/contrib/media/modules/media_wysiwyg_view_mode/media_wysiwyg_view_mode.info
@@ -10,9 +10,9 @@ configure = admin/config/media/wysiwyg-view-mode
 files[] = media_wysiwyg_view_mode.test
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.0-alpha3+37-dev"
 core = "7.x"
 project = "media"
-datestamp = "1389381830"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.info b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.info
index cc38351..74bfd01 100644
--- a/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.info
+++ b/profiles/commons/modules/contrib/media/modules/mediafield/mediafield.info
@@ -5,9 +5,9 @@ core = 7.x
 dependencies[] = media
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.0-alpha3+37-dev"
 core = "7.x"
 project = "media"
-datestamp = "1389381830"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/navbar/README.md b/profiles/commons/modules/contrib/navbar/README.md
index ce577ec..be5d0c7 100644
--- a/profiles/commons/modules/contrib/navbar/README.md
+++ b/profiles/commons/modules/contrib/navbar/README.md
@@ -3,24 +3,25 @@
 The Navbar module is incompatible with Drupal 7 core's Toolbar module. Toolbar
 module should be disabled before the Navbar module is enabled.
 
-# Special installation instructions
 
-## Modernizr
+# Special installation instructions
 
-You will need a build of Modernzr in your libraries directory for this module. Follow the steps below to create this build.
+The Navbar module depends on several third party JavaScript libraries, which you must download manually. After following these instructions, go to the Status Report page to confirm that all of Navbar's requirements are met.
 
-(from Devin Carlson in [#2119945](https://drupal.org/comment/8015709#comment-8015709))
+## Modernizr
 
-1. Grab a [preconfigured version of Modernizr](http://modernizr.com/download/#-inputtypes-svg-touch-cssclasses-addtest-teststyles-prefixes-elem_details)
-1. Rename the resulting file to modernizer.js
-1. Place the file in sites/all/libraries/modernizr (or a site specific folder as required), so the modernizr file can be found at sites/all/libraries/modernizr/modernizr.js
+1. Download [preconfigured version of Modernizr](http://modernizr.com/download/#-inputtypes-svg-touch-cssclasses-addtest-teststyles-prefixes-elem_details) and name the file `modernizr.js`.
+2. Place the file in the `sites/all/libraries/modernizr` directory.
+3. Optionally, also download the minified version, place it in the same directory and name it `modernizr-min.js`. The Navbar module will automatically use the minified version if it's available, because it is more efficient.
 
 ## Backbone
 
-1. Download backbone.js from [GitHub](https://github.com/jashkenas/backbone).
-1. Place the file in sites/all/libraries/backbone (or a site specific folder as required).
+1. Download `backbone.js` from [GitHub](https://github.com/jashkenas/backbone).
+2. Place the file in the `sites/all/libraries/backbone/` directory.
+3. Optionally, also download the minified ("production") version, place it in the same directory and name it `backbone-min.js`. The Navbar module will automatically use the minified version if it's available, because it is more efficient.
 
 ## Underscore
 
-1. Download underscore.js from [GitHub](https://github.com/jashkenas/underscore).
-1. lace the file in sites/all/libraries/underscore (or a site specific folder as required).
+1. Download `underscore.js` from [GitHub](https://github.com/jashkenas/underscore).
+2. Place the file in the `sites/all/libraries/underscore/` directory.
+3. Optionally, also download the minified ("production") version, place it in the same directory and name it `underscore-min.js`. The Navbar module will automatically use the minified version if it's available, because it is more efficient.
diff --git a/profiles/commons/modules/contrib/navbar/navbar.info b/profiles/commons/modules/contrib/navbar/navbar.info
index 3c6d11d..30a0643 100644
--- a/profiles/commons/modules/contrib/navbar/navbar.info
+++ b/profiles/commons/modules/contrib/navbar/navbar.info
@@ -4,9 +4,9 @@ core = 7.x
 
 dependencies[] = libraries (>=2.0)
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.x-1.2"
+; Information added by Drupal.org packaging script on 2014-01-13
+version = "7.x-1.3"
 core = "7.x"
 project = "navbar"
-datestamp = "1388783307"
+datestamp = "1389648211"
 
diff --git a/profiles/commons/modules/contrib/navbar/navbar.install b/profiles/commons/modules/contrib/navbar/navbar.install
index b1978ef..2dd7828 100644
--- a/profiles/commons/modules/contrib/navbar/navbar.install
+++ b/profiles/commons/modules/contrib/navbar/navbar.install
@@ -11,20 +11,29 @@ function navbar_requirements($phase) {
   $requirements = array();
 
   if ($phase == 'runtime') {
-    $libraries = array('modernizr', 'underscore', 'backbone');
-    foreach ($libraries as $lib) {
+    $libraries = array(
+      'modernizr' => 'Modernizr',
+      'underscore' => 'Underscore',
+      'backbone' => 'Backbone',
+    );
+    foreach ($libraries as $lib => $label) {
       $requirements['navbar_' . $lib] = array(
-        'title' => t('Navbar: @library', array('@library' => $lib)),
-        'value' => t('The @library library is not present', array('@library' => $lib)),
+        'title' => t('Navbar: @library library', array('@library' => $label)),
+        'value' => t('The @library library is not present', array('@library' => $label)),
         'severity' => REQUIREMENT_ERROR,
       );
       if (function_exists('libraries_detect')) {
         if (($library = libraries_detect($lib)) && !empty($library['installed'])) {
-          $requirements['navbar_' . $lib]['value'] = $library['version'];
+          $requirements['navbar_' . $lib]['value'] = t('@version (@variant)', array(
+            '@version' => $library['version'],
+            // @todo This is problematic, because there is no way to enforce a
+            //   certain variant.
+            '@variant' => _navbar_libraries_get_preferred_variant_name($library),
+          ));
           $requirements['navbar_' . $lib]['severity'] = REQUIREMENT_OK;
         }
         elseif (!empty($library['error'])) {
-          $requirements['navbar_' . $lib]['value'] = $library['error message'];
+          $requirements['navbar_' . $lib]['description'] = $library['error message'];
         }
       }
     }
diff --git a/profiles/commons/modules/contrib/navbar/navbar.module b/profiles/commons/modules/contrib/navbar/navbar.module
index 0e9b828..62dd5a0 100644
--- a/profiles/commons/modules/contrib/navbar/navbar.module
+++ b/profiles/commons/modules/contrib/navbar/navbar.module
@@ -848,29 +848,21 @@ function navbar_library() {
   );
 
   // Ensure that each 3rd party library dependency has a default variant.
-  $variants = variable_get('navbar_libraries_variants', array());
-  $default_variant = 'minified';
-  foreach (array('modernizr', 'underscore', 'backbone') as $lib) {
-    $variants[$lib] = (!empty($variants[$lib])) ? $variants[$lib] : $default_variant;
-  }
   // Convert Libraries module data structures to library data structures.
   // Modernizr
-  $libraries['modernizr'] = navbar_convert_libraries_to_library(libraries_detect('modernizr'), array(
-    'variant' => $variants['modernizr'],
+  $libraries['modernizr'] = _navbar_convert_libraries_to_library(libraries_detect('modernizr'), array(
     'group' => JS_LIBRARY,
     'weight' => -100,
   ));
 
   // Underscore
-  $libraries['underscore'] = navbar_convert_libraries_to_library(libraries_detect('underscore'), array(
-    'variant' => $variants['underscore'],
+  $libraries['underscore'] = _navbar_convert_libraries_to_library(libraries_detect('underscore'), array(
     'group' => JS_LIBRARY,
     'weight' => -20,
   ));
 
   // Backbone
-  $libraries['backbone'] = navbar_convert_libraries_to_library(libraries_detect('backbone'), array(
-    'variant' => $variants['backbone'],
+  $libraries['backbone'] = _navbar_convert_libraries_to_library(libraries_detect('backbone'), array(
     'group' => JS_LIBRARY,
     'weight' => -19,
   ));
@@ -923,20 +915,30 @@ function navbar_js_alter(&$javascript) {
 function navbar_libraries_info() {
   $libraries = array();
 
+  $common = array(
+    'version callback' => '_navbar_libraries_get_version',
+    'variant order' => array('minified', 'source'),
+  );
+
   $libraries['modernizr'] = array(
-    'name' => 'Modernizr (custom build, see download URL)',
+    'name' => 'Modernizr',
     'vendor url' => 'https://github.com/Modernizr/Modernizr',
     'download url' => 'http://modernizr.com/download/#-inputtypes-svg-touch-cssclasses-addtest-teststyles-prefixes-elem_details',
-    'files' => array(
-      'js' => array(
-        'modernizr.min.js',
-      ),
-    ),
     'version arguments' => array(
-      'file' => 'modernizr.js',
-      'pattern' => '/Modernizr\s*[Vv]?([\d\.]+)/',
+      'variants' => array(
+        'source' => array(
+          'file' => 'modernizr.js',
+          // @todo Document an actual example version string.
+          'pattern' => '#Modernizr\s+[Vv]?([0-9\.]+)#',
+        ),
+        'minified' => array(
+          'file' => 'modernizr-min.js',
+          'pattern' => '#Modernizr\s+[Vv]?([0-9\.]+)#',
+        ),
+      ),
     ),
     'versions' => array(
+      // Means ">=2.6.2": matches 2.6.2, 2.7.1, etc.
       '2.6.2' => array(
         'variants' => array(
           'source' => array(
@@ -945,35 +947,51 @@ function navbar_libraries_info() {
                 'modernizr.js',
               ),
             ),
+            // Without a variant callback, the variant is assumed to be
+            // installed.
+            'variant callback' => '_navbar_libraries_variant_exists',
+            'variant arguments' => array('modernizr.js')
           ),
           'minified' => array(
             'files' => array(
               'js' => array(
-                'modernizr.min.js',
+                'modernizr-min.js',
               ),
             ),
+            // Without a variant callback, the variant is assumed to be
+            // installed.
+            'variant callback' => '_navbar_libraries_variant_exists',
+            'variant arguments' => array('modernizr-min.js')
           ),
         ),
       ),
     ),
   );
+  $libraries['modernizr'] += $common;
 
   $libraries['underscore'] = array(
     'name' => 'Underscore',
     'vendor url' => 'http://documentcloud.github.io/backbone/',
     'download url' => 'https://github.com/jashkenas/underscore/archive/1.5.2.zip',
-    // Declare a default set of files.
-    'files' => array(
-      'js' => array(
-        'underscore-min.js',
-      ),
-    ),
     'version arguments' => array(
-      'file' => 'underscore.js',
-      'pattern' => '/Underscore.js\s*([\d\.]+)/',
+      'variants' => array(
+        'source' => array(
+          'file' => 'underscore.js',
+          // @todo Document an actual example version string.
+          'pattern' => '#VERSION *\W *[\'\"]{1}(.*?)[\'\"]{1}#',
+          // In the unminified Underscore.js 1.5.2, the version is defined on
+          // line 68.
+          'lines' => 100,
+        ),
+        'minified' => array(
+          'file' => 'underscore-min.js',
+          'pattern' => '#Underscore.js\s([\d\.]+)#',
+        ),
+      ),
     ),
     'versions' => array(
-      '1.4.4' => array(
+      // Means ">=1.5.0": matches 1.5.0, 1.5.2, etc.
+      '1.5.0' => array(
         'variants' => array(
           'source' => array(
             'files' => array(
@@ -981,6 +999,10 @@ function navbar_libraries_info() {
                 'underscore.js',
               ),
             ),
+            // Without a variant callback, the variant is assumed to be
+            // installed.
+            'variant callback' => '_navbar_libraries_variant_exists',
+            'variant arguments' => array('underscore.js'),
           ),
           'minified' => array(
             'files' => array(
@@ -988,26 +1010,39 @@ function navbar_libraries_info() {
                 'underscore-min.js',
               ),
             ),
+            // Without a variant callback, the variant is assumed to be
+            // installed.
+            'variant callback' => '_navbar_libraries_variant_exists',
+            'variant arguments' => array('underscore-min.js'),
           ),
         ),
       ),
     ),
   );
+  $libraries['underscore'] += $common;
 
   $libraries['backbone'] = array(
     'name' => 'Backbone',
     'vendor url' => 'http://documentcloud.github.io/backbone/',
     'download url' => 'https://github.com/jashkenas/backbone/archive/1.1.0.zip',
-    'files' => array(
-      'js' => array(
-        'backbone-min.js',
-      ),
-    ),
     'version arguments' => array(
-      'file' => 'backbone.js',
-      'pattern' => '/Backbone.js\s*([\d\.]+)/',
+      'variants' => array(
+        'source' => array(
+          'file' => 'backbone.js',
+          // @todo Document an actual example version string.
+          'pattern' => '#VERSION *\W *[\'\"]{1}(.*?)[\'\"]{1}#',
+          // In the unminified Backbone.js 1.1.0, the version is defined on line
+          // 38.
+          'lines' => 50,
+        ),
+        'minified' => array(
+          'file' => 'backbone-min.js',
+          'pattern' => '#Backbone.js\s([\d\.]+)#',
+        ),
+      ),
     ),
     'versions' => array(
+      // Means ">=1.0.0": matches 1.0.0, 1.1.0, etc.
       '1.0.0' => array(
         'variants' => array(
           'source' => array(
@@ -1016,6 +1051,11 @@ function navbar_libraries_info() {
                 'backbone.js',
               ),
             ),
+            // Without a variant callback, the variant is assumed to be
+            // installed.
+            'variant callback' => '_navbar_libraries_variant_exists',
+            'variant arguments' => array('backbone.js'),
+            'dependencies' => array('underscore (>=1.5.0)'),
           ),
           'minified' => array(
             'files' => array(
@@ -1023,17 +1063,101 @@ function navbar_libraries_info() {
                 'backbone-min.js',
               ),
             ),
+            // Without a variant callback, the variant is assumed to be
+            // installed.
+            'variant callback' => '_navbar_libraries_variant_exists',
+            'variant arguments' => array('backbone-min.js'),
+            'dependencies' => array('underscore (>=1.5.0)'),
           ),
         ),
       ),
     ),
-    'dependencies' => array('underscore (>=1.4.4)'),
   );
+  $libraries['backbone'] += $common;
 
   return $libraries;
 }
 
 /**
+ * Determines the version of a navbar library.
+ *
+ * This is used in case different variants of the library are shipped separately
+ * and, thus, different variants can contain different versions.
+ *
+ * @param array $library
+ *   An associative array containing all information about the library. The
+ *   library is assumed to have the following non-standard keys:
+ *   - variant order: An array of variant names, ordered from the most preferred
+ *     variant to the least preferred.
+ * @param array $options
+ *   An associative array with the following keys:
+ *   - variants: An array of options for libraries_get_version() keyed by
+ *     variant name.
+ *
+ */
+function _navbar_libraries_get_version(&$library, $options = array()) {
+  $versions = array();
+  foreach ($library['variant order'] as $variant_name) {
+    $variant = $library['version arguments']['variants'][$variant_name];
+    // Use the libraries get version function to determine the version string.
+    $versions[$variant_name] = libraries_get_version($library, $variant);
+  }
+
+  // If no versions could be found for any of the variant, there is no version
+  // to return. If different versions have been found, there is no way to
+  // determine the correct one. We cannot use the information on the preferred
+  // variants because we cannot guarantee that a less preferred variant will not
+  // be loaded. Null values are fine. Either that variant file doesn't exist
+  // or id doesn't contain version information. As long as the there is no
+  // conflicting version information, the check should pass.
+  $versions = array_filter($versions, '_navbar_libraries_filter_null_values');
+  $version = array_unique($versions);
+  $vcount = count($version);
+  if ($vcount == 1) {
+    // A version number exists, so suppress any errors that any individual
+    // variant might have raised.
+    unset($library['error']);
+    unset($library['error message']);
+    return array_shift($version);
+  }
+  elseif ($vcount > 1) {
+    $output = array();
+    foreach ($versions as $name => $v) {
+      $output[] = t('@name (@v)', array(
+        '@name' => $name,
+        '@v' => $v,
+      ));
+    }
+
+    $library['error'] = 'inconsistent versions';
+    $library['error message'] = t('The library\'s variants returned inconsistent versions: @variant_info', array(
+      '@variant_info' => implode(', ', $output),
+    ));
+  }
+  // If the version count is zero, then let the error from libraries_get_version
+  // propagate through.
+}
+
+/**
+ * Determines if an item is empty or not.
+ *
+ * @param string $item
+ *   A version number string.
+ * @return boolean
+ *   Whether the $item's value is empty or not.
+ */
+function _navbar_libraries_filter_null_values($item) {
+  return !empty($item);
+}
+
+/**
+ * Libraries API variant callback.
+ */
+function _navbar_libraries_variant_exists($library, $variant_name, $required_file) {
+  return file_exists($library['library path'] . '/' . $required_file);;
+}
+
+/**
  * Implements hook_cache_flush().
  */
 function navbar_cache_flush() {
@@ -1060,28 +1184,26 @@ function _navbar_get_subtree_hash() {
 /**
  * Converts a libraries module array to a hook_library array.
  *
- * What is this necessary? I don't see any way from the Libraries module API
- * to get an array that corresponds to what hook_library expects.
+ * @todo Libraries API should automatically register all libraries in
+ *   hook_library(). See https://drupal.org/node/1386368
  *
  * @return Array
  *  Returns a standard Drupal library definition structure.
  */
-function navbar_convert_libraries_to_library($library, $options = array()) {
+function _navbar_convert_libraries_to_library($library, $options = array()) {
   // If the library wasn't installed, don't bother converting it.
   if (!$library['installed']) {
     return array();
   }
 
   $converted = array();
+  $files = array();
 
-  // The variant will be something like 'minified' or 'source'.
-  $variant = $options['variant'];
-  unset($options['variant']);
+  // Get the library files from one of the installed variants.
+  if ($name = _navbar_libraries_get_preferred_variant_name($library)) {
+    $files = $library['variants'][$name]['files'];
+  }
 
-  // If variants are defined, prefer the them.
-  $files = (!empty($library['variants'][$variant]['files'])) ? $library['variants'][$variant]['files'] : array();
-  // If no variants are defined, check for default files.
-  $files = (empty($files) && !empty($library['files'])) ? $library['files'] : $files;
   // Define the library if files exist for it.
   if (!empty($files)) {
     // This is the basic structure expected by hook_library().
@@ -1101,6 +1223,27 @@ function navbar_convert_libraries_to_library($library, $options = array()) {
 }
 
 /**
+ * Returns the variant that should be loaded based on order preference.
+ *
+ * @param array $library
+ *   A libraries module library definition array.
+ * @return string
+ *   The name of the variant that should be loaded.
+ */
+function _navbar_libraries_get_preferred_variant_name($library) {
+  if (!empty($library['variant order'])) {
+    foreach ($library['variant order'] as $name) {
+      if ($variant = $library['variants'][$name]) {
+        if ($variant['installed']) {
+          return $name;
+        }
+      }
+    }
+  }
+  return NULL;
+}
+
+/**
  * Implementation of hook_suppress()
  *
  * Allows other modules to suppress display of Navbar
diff --git a/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info b/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
index 18d6373..1d13c32 100644
--- a/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
+++ b/profiles/commons/modules/contrib/oauthconnector/modules/oauth2/oauth2_common.info
@@ -7,9 +7,9 @@ files[] = lib/DrupalOAuth2Client.inc
 
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-beta2+0-dev"
 core = "7.x"
 project = "oauthconnector"
-datestamp = "1389381824"
+datestamp = "1389902321"
 
diff --git a/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info b/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
index 5a3b1f7..cd52e5a 100644
--- a/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
+++ b/profiles/commons/modules/contrib/oauthconnector/oauthconnector.info
@@ -10,9 +10,9 @@ dependencies[] = http_client_oauth
 dependencies[] = ctools
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-beta2+0-dev"
 core = "7.x"
 project = "oauthconnector"
-datestamp = "1389381824"
+datestamp = "1389902321"
 
diff --git a/profiles/commons/modules/contrib/oembed/PATCHES.txt b/profiles/commons/modules/contrib/oembed/PATCHES.txt
index 5dec3c8..b5b8fc7 100644
--- a/profiles/commons/modules/contrib/oembed/PATCHES.txt
+++ b/profiles/commons/modules/contrib/oembed/PATCHES.txt
@@ -1,4 +1,5 @@
 The following patches have been applied to this project:
+- https://drupal.org/files/oembed-2021015-1.patch
 - https://drupal.org/files/issues/list-enabled-plugins-2159335-1.patch
 - https://drupal.org/files/issues/remove-wysiwyg-special-casing-2159303-2.patch
 - https://drupal.org/files/issues/provide-default-display-configuration-2128389-3.patch
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.info b/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.info
index 71eee3c..576fdad 100644
--- a/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.info
+++ b/profiles/commons/modules/contrib/oembed/deprecated/media_oembed/media_oembed.info
@@ -8,9 +8,9 @@ dependencies[] = oembedcore
 hidden = TRUE
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-rc2+6-dev"
 core = "7.x"
 project = "oembed"
-datestamp = "1389381829"
+datestamp = "1389902329"
 
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.info b/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.info
index ed6dc49..6d5746b 100644
--- a/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.info
+++ b/profiles/commons/modules/contrib/oembed/deprecated/oembedcore.info
@@ -12,9 +12,9 @@ files[] = MediaInternetOEmbedHandler.inc
 hidden = TRUE
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-rc2+6-dev"
 core = "7.x"
 project = "oembed"
-datestamp = "1389381829"
+datestamp = "1389902329"
 
diff --git a/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.info b/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.info
index 0082de3..ef07b0e 100644
--- a/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.info
+++ b/profiles/commons/modules/contrib/oembed/deprecated/oembedfield.info
@@ -6,9 +6,9 @@ hidden = TRUE
 dependencies[] = oembedcore
 dependencies[] = link
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-rc2+6-dev"
 core = "7.x"
 project = "oembed"
-datestamp = "1389381829"
+datestamp = "1389902329"
 
diff --git a/profiles/commons/modules/contrib/oembed/oembed.info b/profiles/commons/modules/contrib/oembed/oembed.info
index de4b6ea..95c27b1 100644
--- a/profiles/commons/modules/contrib/oembed/oembed.info
+++ b/profiles/commons/modules/contrib/oembed/oembed.info
@@ -11,9 +11,9 @@ files[] = OEmbedStreamWrapper.inc
 files[] = MediaInternetOEmbedHandler.inc
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-rc2+6-dev"
 core = "7.x"
 project = "oembed"
-datestamp = "1389381829"
+datestamp = "1389902329"
 
diff --git a/profiles/commons/modules/contrib/oembed/oembed.module b/profiles/commons/modules/contrib/oembed/oembed.module
index 0b7569f..a6a9398 100644
--- a/profiles/commons/modules/contrib/oembed/oembed.module
+++ b/profiles/commons/modules/contrib/oembed/oembed.module
@@ -126,10 +126,12 @@ function oembed_menu_alter(&$items) {
 
   // Create a new menu item where all oembed export UIs will be local tasks by
   // copying the export UI's menu item that will become the default local task.
-  $items['admin/config/media/oembed/provider'] += $items['admin/config/media/oembed/provider/default'];
-  $items['admin/config/media/oembed/provider']['type'] = MENU_LOCAL_TASK;
+  if (!empty($items['admin/config/media/oembed/provider/default'])) {
+    $items['admin/config/media/oembed/provider'] += $items['admin/config/media/oembed/provider/default'];
+    $items['admin/config/media/oembed/provider']['type'] = MENU_LOCAL_TASK;
 
-  $items['admin/config/media/oembed/provider/default']['type'] = MENU_DEFAULT_LOCAL_TASK;
+    $items['admin/config/media/oembed/provider/default']['type'] = MENU_DEFAULT_LOCAL_TASK;
+  }
 }
 
 /**
diff --git a/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.info b/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.info
index 036d8bb..0bd2720 100644
--- a/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.info
+++ b/profiles/commons/modules/contrib/oembed/oembedembedly/oembedembedly.info
@@ -5,9 +5,9 @@ core = 7.x
 dependencies[] = oembed
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-rc2+6-dev"
 core = "7.x"
 project = "oembed"
-datestamp = "1389381829"
+datestamp = "1389902329"
 
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.info b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.info
index 4f474f8..cf80011 100644
--- a/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.info
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider/oembedprovider.info
@@ -8,9 +8,9 @@ files[] = oembedprovider.module
 files[] = oembedprovider.test
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-rc2+6-dev"
 core = "7.x"
 project = "oembed"
-datestamp = "1389381829"
+datestamp = "1389902329"
 
diff --git a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.info b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.info
index 1a451eb..0ef490b 100644
--- a/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.info
+++ b/profiles/commons/modules/contrib/oembed/oembedprovider_embed/oembedprovider_embed.info
@@ -8,9 +8,9 @@ dependencies[] = oembed
 hidden = TRUE
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-1.0-rc2+6-dev"
 core = "7.x"
 project = "oembed"
-datestamp = "1389381829"
+datestamp = "1389902329"
 
diff --git a/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.info b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.info
index 5f34973..cc12e92 100644
--- a/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.info
+++ b/profiles/commons/modules/contrib/panels/i18n_panels/i18n_panels.info
@@ -8,9 +8,9 @@ package = Multilingual - Internationalization
 core = 7.x
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1389381820"
+datestamp = "1389902319"
 
diff --git a/profiles/commons/modules/contrib/panels/panels.info b/profiles/commons/modules/contrib/panels/panels.info
index 439562b..5930879 100644
--- a/profiles/commons/modules/contrib/panels/panels.info
+++ b/profiles/commons/modules/contrib/panels/panels.info
@@ -11,9 +11,9 @@ files[] = includes/plugins.inc
 files[] = plugins/views/panels_views_plugin_row_fields.inc
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1389381820"
+datestamp = "1389902319"
 
diff --git a/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.info b/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.info
index 51a3624..2cc8b34 100644
--- a/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.info
+++ b/profiles/commons/modules/contrib/panels/panels_ipe/panels_ipe.info
@@ -7,9 +7,9 @@ configure = admin/structure/panels
 files[] = panels_ipe.module
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1389381820"
+datestamp = "1389902319"
 
diff --git a/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.info b/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.info
index 6b92590..dbc6ffc 100644
--- a/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.info
+++ b/profiles/commons/modules/contrib/panels/panels_mini/panels_mini.info
@@ -5,9 +5,9 @@ dependencies[] = panels
 core = 7.x
 files[] = plugins/export_ui/panels_mini_ui.class.php
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1389381820"
+datestamp = "1389902319"
 
diff --git a/profiles/commons/modules/contrib/panels/panels_node/panels_node.info b/profiles/commons/modules/contrib/panels/panels_node/panels_node.info
index af5bb1d..b22cd23 100644
--- a/profiles/commons/modules/contrib/panels/panels_node/panels_node.info
+++ b/profiles/commons/modules/contrib/panels/panels_node/panels_node.info
@@ -7,9 +7,9 @@ core = 7.x
 files[] = panels_node.module
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-3.x-i18n-dev"
 core = "7.x"
 project = "panels"
-datestamp = "1389381820"
+datestamp = "1389902319"
 
diff --git a/profiles/commons/modules/contrib/picture/PATCHES.txt b/profiles/commons/modules/contrib/picture/PATCHES.txt
new file mode 100644
index 0000000..8aaf8df
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/PATCHES.txt
@@ -0,0 +1,8 @@
+The following patches have been applied to this project:
+- https://drupal.org/files/issues/add-ctools-dependency-2173043-1.patch
+- https://drupal.org/files/issues/translate-filter-tips-2139459-1.patch
+- https://drupal.org/files/issues/move-uninstall-hook-implementation-2173015-1.patch
+- https://drupal.org/files/issues/remove-file-formatter-hook-implementation-2172831-1.patch
+- https://drupal.org/files/issues/remove-ctools-hook-implementation-2172831-1.patch
+
+This file was automatically generated by Drush Make (http://drupal.org/project/drush).
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/picture/README.txt b/profiles/commons/modules/contrib/picture/README.txt
new file mode 100644
index 0000000..012d901
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/README.txt
@@ -0,0 +1,14 @@
+-- SUMMARY --
+
+Picture element
+
+Hide image
+----------
+
+If you use the '- empty image -' option, you have to add the following
+to your theme css to completely hide the image, otherwise it will
+still take some space.
+
+img[width="1"][height="1"] {
+  display: none;
+}
diff --git a/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.info b/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.info
new file mode 100644
index 0000000..af66d3a
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.info
@@ -0,0 +1,16 @@
+name = FlexSlider Picture
+description = Integrates the Picture module with the FlexSlider module for a truly responsive slider.
+package = Picture
+core = 7.x
+
+dependencies[] = picture
+dependencies[] = flexslider (2.x)
+dependencies[] = flexslider_fields (2.x)
+
+
+; Information added by drush on 2014-01-16
+version = "7.x-1.2+6-dev"
+core = "7.x"
+project = "picture"
+datestamp = "1389902323"
+
diff --git a/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.install b/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.install
new file mode 100644
index 0000000..d2ef39f
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.install
@@ -0,0 +1,83 @@
+<?php
+
+/**
+ * @file
+ * Install, update and schema hooks for the FlexSlider Picture module.
+ */
+function flexslider_picture_schema() {
+  $schema = array();
+  $schema['flexslider_picture_optionset'] = array(
+    'description' => 'Saves which flexslider optionsets use picture mappings and which use image styles.',
+    'export' => array(
+      'key' => 'flexslider_optionset',
+      'identifier' => 'flexslider_picture_optionset',
+      'api' => array(
+        'owner' => 'flexslider_picture',
+        'api' => 'flexslider_picture_optionset',
+        'minimum_version' => 1,
+        'current_version' => 1,
+      ),
+    ),
+    'fields' => array(
+      'id' => array(
+        'type' => 'serial',
+        'not null' => TRUE,
+        'description' => 'The internal identifier.',
+        'no export' => TRUE, // Do not export database-only keys.
+      ),
+      'flexslider_optionset' => array(
+        'description' => 'The machine-readable option set name.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+      ),
+      'imagestyle_type' => array(
+        'description' => 'One of image_style or picture_mapping.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+      ),
+      'mapping' => array(
+        'description' => 'The picture mapping for this optionset.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => FALSE,
+      ),
+    ),
+    'primary key' => array('id'),
+    'indexes' => array(
+      'imagestyle_type' => array('imagestyle_type'),
+    ),
+  );
+  return $schema;
+}
+
+/**
+ * Implements hook_schema_alter().
+ */
+function flexslider_picture_schema_alter(&$schema) {
+  $schema['flexslider_optionset']['join']['flexslider_picture'] = array(
+    'table' => 'flexslider_picture_optionset',
+    'left_key' => 'name',
+    'right_key' => 'flexslider_optionset',
+    'callback' => 'flexslider_picture_join_callback',
+    'load' => array(
+      'imagestyle_type',
+      'mapping',
+    ),
+    'fields' => array(
+      'imagestyle_type' => array(
+        'description' => 'One of image_style or picture_mapping.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+      ),
+      'mapping' => array(
+        'description' => 'The picture mapping for this optionset.',
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => FALSE,
+      ),
+    ),
+  );
+}
diff --git a/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.module b/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.module
new file mode 100644
index 0000000..d0b1447
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/flexslider_picture/flexslider_picture.module
@@ -0,0 +1,185 @@
+<?php
+
+/**
+ * @file
+ * Picture formatter with flexslider support.
+ */
+
+/**
+ * Implements hook_theme_registry_alter().
+ */
+function flexslider_picture_theme_registry_alter(&$registry) {
+  $registry['flexslider_list']['file'] = 'flexslider_picture.theme.inc';
+  $registry['flexslider_list']['theme_path'] = drupal_get_path('module', 'flexslider_picture') . '/theme';
+  $registry['flexslider_list']['function'] = 'theme_flexslider_picture_list';
+  $default_processor = array_search('template_process_flexslider_list', $registry['flexslider_list']['process functions']);
+  $registry['flexslider_list']['process functions'][(int) $default_processor] = 'template_process_flexslider_picture_list';
+  $registry['flexslider_list']['includes'][] = $registry['flexslider_list']['theme_path'] . '/' . $registry['flexslider_list']['file'];
+}
+
+/**
+ * Implements hook_field_formatter_info().
+ *
+ * Redefine the formatter from flexslider so that our formatter function will
+ * be used.
+ */
+function flexslider_picture_field_formatter_info() {
+  return array(
+    'flexslider' => array(
+      'label' => t('flexslider'),
+      'field types' => array('image', 'media'),
+      'settings' => array(
+        'optionset' => 'default',
+        'flexslider_reference_img_src' => NULL,
+      ),
+    ),
+  );
+}
+
+/**
+ * Implements hook_field_formatter_settings_form().
+ *
+ * Provides display settings form within the manage display page of
+ * an image field with formatter flexslider.
+ */
+function flexslider_picture_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
+  return flexslider_fields_field_formatter_settings_form($field, $instance, $view_mode, $form, $form_state);
+}
+
+/**
+ * Implements hook_field_formatter_settings_summary().
+ *
+ * Displays the summary of the set options of a flexslider formatted image field
+ */
+function flexslider_picture_field_formatter_settings_summary($field, $instance, $view_mode) {
+  return flexslider_fields_field_formatter_settings_summary($field, $instance, $view_mode);
+}
+
+/**
+ * Implements hook_field_formatter_view().
+ *
+ * Prepares a renderable array of images and adds the neccessary JS and CSS
+ */
+function flexslider_picture_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
+  $element = flexslider_fields_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display);
+  $optionsets = array();
+  foreach (element_children($element) as $child) {
+    if (!isset($optionsets[$element[$child]['#settings']['optionset']])) {
+      $optionsets[$element[$child]['#settings']['optionset']] = flexslider_optionset_load($element[$child]['#settings']['optionset']);
+    }
+    $optionset = $optionsets[$element[$child]['#settings']['optionset']];
+    if ($optionset && isset($optionset->imagestyle_type) && !empty($optionset->imagestyle_type) && $optionset->imagestyle_type == 'picture_mapping') {
+      $element[$child]['#attached'] = array(
+        'library' => array(
+          array('picture', 'matchmedia'),
+          array('picture', 'picturefill'),
+          array('picture', 'picture.ajax'),
+        ),
+      );
+    }
+  }
+  return $element;
+}
+
+/**
+ * Implements hook_form_FORM_ID_alter().
+ */
+function flexslider_picture_form_ctools_export_ui_edit_item_form_alter(&$form, &$form_state) {
+  if ($form_state['plugin']['schema'] == 'flexslider_optionset') {
+    $form['image_style']['imagestyle_type'] = array(
+      '#type' => 'radios',
+      '#title' => t('Image type'),
+      '#description' => t(
+          'Choosing picture mapping will give you a truly responsive slider.
+          Flexslider is responsive because it will resize the images for smaller screens, but it will still load the large image.
+          With picture mappings, a smaller image will be loaded for smaller screens (and thus less data transfer).'),
+      '#options' => array(
+        'image_style' => t('Image Style'),
+        'picture_mapping' => t('Picture Mapping'),
+      ),
+      '#weight' => -2,
+      '#default_value' => (isset($form_state['item']->imagestyle_type) && !empty($form_state['item']->imagestyle_type)) ? $form_state['item']->imagestyle_type : 'image_style',
+    );
+
+    $form['image_style']['normal']['#description'] .= ' ' . t('If you selected Picture Mapping above, this image style will be used as a fallback.');
+
+    $options = picture_get_mapping_options();
+    $form['image_style']['mapping'] = array(
+      '#title' => t('Normal picuture mapping'),
+      '#states' => array(
+        'visible' => array(
+          ':input[name="image_style[imagestyle_type]"]' => array('value' => 'picture_mapping'),
+        )
+      ),
+      '#weight' => -1,
+    );
+    if (!empty($options)) {
+      $form['image_style']['mapping'] += array(
+        '#type' => 'select',
+        '#description' => t('Picture mapping for the main stage images.'),
+        '#options' => $options,
+        '#default_value' => (!empty($form_state['item']->mapping)) ? $form_state['item']->mapping : '',
+      );
+    }
+    else {
+      $form['image_style']['mapping'] += array(
+        '#type' => 'item',
+        '#markup' => t('There\'re no picture mappings defined, you\'ll have to !create them first.', array('!create' => l(t('create'), 'admin/config/media/picture'))),
+      );
+    }
+
+    // Colorbox support.
+    $form['image_style']['colorboxEnabled'] = array(
+      '#title' => t('Enable colorbox'),
+      '#type' => 'checkbox',
+      '#default_value' => (!empty($form_state['item']->options['colorboxEnabled'])) ? $form_state['item']->options['colorboxEnabled'] : '',
+    );
+    $form['image_style']['colorboxImageStyle'] = array(
+      '#title' => t('Colorbox group'),
+      '#type' => 'select',
+      '#default_value' => (!empty($form_state['item']->options['colorboxImageStyle'])) ? $form_state['item']->options['colorboxImageStyle'] : '',
+      '#required' => FALSE,
+      '#options' => $options,
+      '#states' => array(
+        'visible' => array(
+          ':input[name$="image_style[colorboxEnabled]"]' => array('checked' => TRUE),
+        ),
+      ),
+    );
+
+    $form['#submit'][] = '_flexslider_picture_ctools_export_ui_edit_item_form_submit';
+  }
+}
+
+/**
+ * Submit callback.
+ */
+function _flexslider_picture_ctools_export_ui_edit_item_form_submit($form, &$form_state) {
+  $fields = array_intersect_key($form_state['values']['image_style'], drupal_map_assoc(array('imagestyle_type', 'mapping')));
+  $fields['flexslider_optionset'] = $form_state['values']['name'];
+  $q = db_merge('flexslider_picture_optionset')
+      ->key(array('flexslider_optionset' => $form_state['values']['name']))
+      ->fields($fields);
+  $q->execute();
+
+  // Add the colorbox options into the generic options field.
+  // @todo Should we move it into our own table or how likely is it that
+  // flexslider itself will add colorbox support and thus add "similar" options?
+  $optionset = &$form_state['optionset'];
+  $optionset->options['colorboxEnabled'] = !empty($form_state['values']['image_style']['colorboxEnabled']);
+  $optionset->options['colorboxImageStyle'] = !empty($form_state['values']['image_style']['colorboxImageStyle']) ? $form_state['values']['image_style']['colorboxImageStyle'] : '';
+}
+
+/**
+ * Join callback.
+ * @see flexslider_picture_schema_alter()
+ */
+function flexslider_picture_join_callback(&$query, $schema, $join_schema) {
+  $tables = &$query->getTables();
+  foreach ($tables as &$table) {
+    if ($table['table'] == 'flexslider_picture_optionset') {
+      $table['join type'] = 'LEFT OUTER';
+      break;
+    }
+  }
+}
diff --git a/profiles/commons/modules/contrib/picture/flexslider_picture/theme/flexslider_picture.theme.inc b/profiles/commons/modules/contrib/picture/flexslider_picture/theme/flexslider_picture.theme.inc
new file mode 100644
index 0000000..34bfdc4
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/flexslider_picture/theme/flexslider_picture.theme.inc
@@ -0,0 +1,113 @@
+<?php
+
+/**
+ * @file
+ * Picture formatter with flexslider support.
+ */
+
+
+/**
+ * Process the items and prepare the item slides to be rendered.
+ *
+ * @param $vars
+ */
+function template_process_flexslider_picture_list(&$vars) {
+  // Call default preprocessor first.
+  template_process_flexslider_list($vars);
+
+  $optionset = &$vars['settings']['optionset'];
+
+  // Check if this is a picture optionset.
+  $vars['picture_formatter_enabled'] = (isset($optionset->imagestyle_type) && !empty($optionset->imagestyle_type) && $optionset->imagestyle_type == 'picture_mapping');
+
+  if ($vars['picture_formatter_enabled']) {
+    $items = &$vars['items'];
+
+    // Get the breakpoints based on the mapping.
+    $fallback_image_style = '';
+    $mappings = picture_mapping_load($optionset->mapping);
+    $breakpoint_styles = picture_get_mapping_breakpoints($mappings, $fallback_image_style);
+
+    // If colorbox is enabled build additional configuration.
+    if (!empty($optionset->options['colorboxEnabled'])) {
+      // Add additional necessary scripts and styles.
+      drupal_add_js(drupal_get_path('module', 'picture') . '/picture_colorbox.js');
+      drupal_add_css(drupal_get_path('module', 'picture') . '/picture_colorbox.css');
+      if (!variable_get('colorbox_inline', 0)) {
+        drupal_add_js(drupal_get_path('module', 'colorbox') . '/js/colorbox_inline.js');
+      }
+
+      $colorbox_fallback_image_style = '';
+      $mappings = picture_mapping_load($optionset->options['colorboxImageStyle']);
+      $colorbox_breakpoints = picture_get_mapping_breakpoints($mappings, $colorbox_fallback_image_style);
+      // Grouping ID for the colorbox gallery. Use more_entropy to ensure the
+      // php function works on every environment (cygwin).
+      $colorbox_group_id = uniqid('flexgroup', TRUE);
+    }
+
+    // Prepare the item slides to be passed to render().
+    foreach ($items as $i => &$item) {
+      // If the slide hasn't been set, build the slide using the image
+      // attributes given (assumes we're using a multi-image field)
+      // @todo need to allow for different types of field and collection fields.
+      if (!isset($item['slide'])) {
+        $item['slide'] = array(
+          '#theme' => 'picture',
+          '#style_name' => $optionset->imagestyle_normal,
+          '#uri' => $item['uri'],
+          '#height' => $item['height'],
+          '#width' => $item['width'],
+          '#alt' => $item['alt'],
+          '#title' => $item['title'],
+          '#breakpoints' => $breakpoint_styles,
+        );
+
+        // If colorbox is enabled change the theming function and add settings.
+        if (!empty($optionset->options['colorboxEnabled'])) {
+          $item['slide'] = array(
+            '#theme' => 'picture_formatter_colorbox',
+            '#item' => $item,
+            '#image_style' => $optionset->imagestyle_normal,
+            '#path' => $item['uri'],
+            '#colorbox_image_style' => $colorbox_fallback_image_style,
+            '#colorbox' => $colorbox_breakpoints,
+            '#colorbox_group_id' => $colorbox_group_id,
+          ) + $item['slide'];
+        }
+      }
+      if (!isset($item['thumb'])) {
+        $item['thumb'] = image_style_url($optionset->imagestyle_thumbnail, $item['uri']);
+      }
+    }
+  }
+}
+
+/**
+ * Theme callback.
+ */
+function theme_flexslider_picture_list(&$vars) {
+  if (!empty($vars['picture_formatter_enabled'])) {
+    // Reference configuration variables.
+    $attributes = &$vars['settings']['attributes'];
+    $type = &$vars['settings']['type'];
+    $output = '';
+
+    // Build the list.
+    if (!empty($vars['items'])) {
+      $output .= "<$type" . drupal_attributes($attributes) . '>';
+      foreach ($vars['items'] as $i => $item) {
+        $item = render($item['slide']);
+        $output .= theme('flexslider_list_item', array(
+          'item' => $item,
+          'thumb' => $item['thumb'],
+          'optionset' => $vars['settings']['optionset'],
+        ));
+      }
+      $output .= "</$type>";
+    }
+
+    return $output;
+  }
+  // If this isn't a picture optionset use the default theming.
+  return theme_flexslider_list($vars);
+}
diff --git a/profiles/commons/modules/contrib/picture/picture.admin.inc b/profiles/commons/modules/contrib/picture/picture.admin.inc
new file mode 100644
index 0000000..ecaa0c4
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture.admin.inc
@@ -0,0 +1,340 @@
+<?php
+
+/**
+ * @file
+ * Picture - map breakpoints and image styles
+ */
+
+/**
+ * Admin form.
+ */
+function picture_admin_breakpoints($form, &$form_state, $breakpoint_group_name = '') {
+  // Show a list of all groups if no group name is given.
+  if ($breakpoint_group_name == '' || $breakpoint_group_name == 'global') {
+    return picture_admin_breakpoints_overview_page();
+  }
+  $machine_name = $breakpoint_group_name;
+  $form = array();
+
+  $mappings = picture_mapping_load($breakpoint_group_name);
+  $mappings = $mappings ? $mappings : new stdClass();
+
+  $form['picture_mapping'] = array(
+    '#type' => 'container',
+    '#tree' => TRUE,
+  );
+  $form['picture_mapping']['machine_name'] = array(
+    '#type' => 'value',
+    '#value' => isset($mappings->machine_name) ? $mappings->machine_name : $machine_name,
+  );
+  $form['picture_mapping']['breakpoint_group'] = array(
+    '#type' => 'value',
+    '#value' => isset($mappings->breakpoint_group) ? $mappings->breakpoint_group : $breakpoint_group_name,
+  );
+  if (isset($mappings->id)) {
+    $form['picture_mapping']['id'] = array(
+      '#type' => 'value',
+      '#value' => $mappings->id,
+    );
+  }
+
+  $breakpoints = array();
+  $breakpoint_group = breakpoints_breakpoint_group_load($breakpoint_group_name);
+  $weight = 0;
+  foreach ($breakpoint_group->breakpoints as $breakpoint_name) {
+    $breakpoint = breakpoints_breakpoint_load_by_fullkey($breakpoint_name);
+    if ($breakpoint && $breakpoint->status) {
+      $breakpoint->global_weight = $breakpoint->weight;
+      $breakpoint->weight = $weight++;
+      $breakpoints[$breakpoint_name] = $breakpoint;
+    }
+  }
+
+  $image_styles = image_style_options(TRUE);
+  $image_styles[PICTURE_EMPTY_IMAGE] = t('- empty image -');
+  foreach ($breakpoints as $breakpoint_name => $breakpoint) {
+    $label = '1x ' . $breakpoint->name . ' [' . $breakpoint->breakpoint . ']';
+    $form['picture_mapping']['mapping'][$breakpoint_name]['1x'] = array(
+      '#title' => check_plain($label),
+      '#type' => 'select',
+      '#options' => $image_styles,
+      '#default_value' => isset($mappings->mapping[$breakpoint_name]['1x']) ? $mappings->mapping[$breakpoint_name]['1x'] : '',
+    );
+    if (isset($breakpoint->multipliers) && !empty($breakpoint->multipliers)) {
+      foreach ($breakpoint->multipliers as $multiplier => $status) {
+        if ($status) {
+          $label = $multiplier . ' ' . $breakpoint->name . ' [' . $breakpoint->breakpoint . ']';
+          $form['picture_mapping']['mapping'][$breakpoint_name][$multiplier] = array(
+            '#title' => check_plain($label),
+            '#type' => 'select',
+            '#options' => $image_styles,
+            '#default_value' => isset($mappings->mapping[$breakpoint_name][$multiplier]) ? $mappings->mapping[$breakpoint_name][$multiplier] : '',
+          );
+        }
+      }
+    }
+  }
+
+  // Buttons
+  $form['buttons'] = array(
+    '#type' => 'container',
+  );
+
+  // Submit button
+  $form['buttons']['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Save'),
+  );
+
+  return $form;
+}
+
+/**
+ * Admin form overview page.
+ */
+function picture_admin_breakpoints_overview_page() {
+  $links = array();
+  $breakpoint_groups = breakpoints_breakpoint_group_load_all();
+  foreach ($breakpoint_groups as $breakpoint_group) {
+    $links[] = l($breakpoint_group->name, 'admin/config/media/picture/groups/' . $breakpoint_group->machine_name);
+  }
+  if (!empty($links)) {
+    return array(
+      '#type' => 'container',
+      '#theme' => 'item_list',
+      '#items' => $links,
+    );
+  }
+  else {
+    $item['info'] = array(
+      '#type' => 'markup',
+      '#title' => t('No breakpoint groups found.'),
+      '#markup' => t('There\'re no breakpoint groups defined, you\'ll have to !create them first.', array('!create' => l(t('create'), 'admin/config/media/breakpoints/groups/add'))),
+    );
+    return $item;
+  }
+}
+
+/**
+ * Admin form submit.
+ */
+function picture_admin_breakpoints_submit($form, &$form_state) {
+  $mapping = (object)$form_state['values']['picture_mapping'];
+  $saved = picture_mapping_save($mapping);
+  $group = breakpoints_breakpoint_group_load($mapping->breakpoint_group);
+  if ($saved !== FALSE) {
+    drupal_set_message(t('Picture mappings for @group were saved.', array('@group' => $group->name)));
+  }
+  else {
+    drupal_set_message(t('Something went wrong while trying to save picture mappings for @group', array('@group' => $group->name)), 'error');
+  }
+}
+
+/**
+ * Export mappings.
+ */
+function picture_admin_export_form($form, &$form_state, $mappings_name) {
+  // Create the export code textarea.
+  ctools_include('export');
+  $mapping = picture_mapping_load($mappings_name);
+  if (!$mapping) {
+    $mapping = new stdClass();
+  }
+  $export = ctools_export_object('picture_mapping', $mapping);
+  $form['mapping_export'] = array(
+    '#type' => 'textarea',
+    '#title' => t('Mapping code'),
+    '#rows' => count(explode("\n", $export)),
+    '#default_value' => $export,
+    '#weight' => -1,
+    '#description' => t('<strong>Warning!</strong> Only import these mappings if the breakpoint group below has been imported on that site already, or if they were manually created there.'),
+  );
+
+  // Also export the group it belongs to.
+  module_load_include('inc', 'breakpoints', 'breakpoints.admin');
+  $form += drupal_get_form('breakpoints_admin_breakpoint_group_export_form', $mapping->breakpoint_group);
+  $form['export']['#description'] = t('If you want to import this mapping on an other site,
+    you\'ll need to import the breakpoint group with its breakpoints as well,
+    if it doesn\'t already exist on that site.');
+  return $form;
+}
+
+/**
+ * Import mappings.
+ */
+function picture_admin_import_form($form, &$form_state) {
+  $form['import'] = array(
+    '#type' => 'textarea',
+    '#rows' => 10,
+  );
+  $form['submit'] = array(
+    '#type' => 'submit',
+    '#value' => t('Import')
+  );
+  return $form;
+}
+
+
+/**
+ * Validate a mapping import.
+ */
+function picture_admin_import_form_validate($form, &$form_state) {
+  ctools_include('export');
+  $code = $form_state['values']['import'];
+  $mapping = ctools_export_crud_import('picture_mapping', $code);
+  if (!picture_mapping_validate($mapping)) {
+    form_set_error('import', t('Not a valid mapping object'));
+    return;
+  }
+  if (picture_mapping_load($mapping->machine_name)) {
+    form_set_error('import', t('A mapping with machine name %name already exists', array('%name' => $mapping->machine_name)));
+    return;
+  }
+  form_set_value($form['import'], $mapping, $form_state);
+}
+
+/**
+ * Import mapping.
+ */
+function picture_admin_import_form_submit($form, &$form_state) {
+  $mapping = $form_state['values']['import'];
+  if (picture_mapping_save($mapping)) {
+    drupal_set_message(t('Mapping %mapping saved.', array('%mapping' => $mapping->machine_name)));
+    $form_state['redirect'] = 'admin/config/media/picture/';
+  }
+  else {
+    drupal_set_message(t('Something went wrong, we could not save the mapping'), 'error');
+  }
+}
+
+/**
+ * Picture settings.
+ */
+function picture_admin_settings($form, &$form_state) {
+  $form['picture_implementation'] = array(
+    '#type' => 'select',
+    '#title' => t('Choose the javascript library to use'),
+    '#options' => array(
+      PICTURE_IMPLEMENTATION_PICTUREFILL => 'picturefill',
+      PICTURE_IMPLEMENTATION_WEBLINC => 'weblinc',
+    ),
+    '#default_value' => variable_get('picture_implementation', PICTURE_IMPLEMENTATION_DEFAULT),
+  );
+
+  return system_settings_form($form);
+}
+
+/**
+ * Chooses which picture groups are available in the CKEditor image dialog.
+ */
+function picture_ckeditor_settings() {
+  $form = array();
+  $picture_groups = picture_get_mapping_options();
+  $ckeditor_groups = array();
+
+  // Check if picture group mappings have been configured before proceeding.
+  if ($picture_groups) {
+    // Create a settings form.
+    $form['description'] = array(
+      '#type' => 'item',
+      '#title' => t('Choose which picture groups will be available in the CKEditor image dialog.'),
+      '#description' => 'See picture_wysiwyg.css for an example of how to style these images in your theme using the selectors suggested below.',
+    );
+
+    // Retrieve pre-existing settings.
+    $ckeditor_groups = variable_get('picture_ckeditor_groups', array());
+
+    // Loop through each picture group and place a checkbox and weight.
+    foreach ($picture_groups as $machine_name => $display_name) {
+      $form[$machine_name] = array(
+        '#type' => 'fieldset',
+        '#title' => t('@name picture group', array('@name' => $display_name)),
+      );
+      $form[$machine_name]['enabled'] = array(
+        '#type' => 'checkbox',
+        '#default_value' => isset($ckeditor_groups[$machine_name]) ? $ckeditor_groups[$machine_name]['enabled'] : 0,
+        '#title' => t('Include @name picture group in the CKEditor image dialog', array('@name' => $display_name)),
+      );
+      $form[$machine_name]['css'] = array(
+        '#type' => 'item',
+        '#markup' => 'Consider using the selector <code>span[data-picture-group="' . $machine_name . '"]</code> in your theme CSS.',
+      );
+      $form[$machine_name]['weight'] = array(
+        '#type' => 'select',
+        '#title' => t('Weight'),
+        '#options' => drupal_map_assoc(array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)),
+        '#default_value' => isset($ckeditor_groups[$machine_name]) ? $ckeditor_groups[$machine_name]['weight'] : 1,
+        '#description' => t('Control the sort order of picture groups in the CKEditor "size" drop-down. Higher weights sink to the bottom of the list.'),
+      );
+      $form[$machine_name]['fallback'] = array(
+        '#type' => 'select',
+        '#title' => t('Fallback image style'),
+        '#options' => drupal_map_assoc(array_keys(image_styles())),
+        '#default_value' => isset($ckeditor_groups[$machine_name]) ? $ckeditor_groups[$machine_name]['fallback'] : NULL,
+      );
+    }
+    $form['#tree'] = TRUE;
+    $form['ckeditor_label'] = array(
+      '#type' => 'textfield',
+      '#title' => t('Label in the CKEditor image dialog'),
+      '#description' => t('This sets the label for the drop-down select box containing these picture groups in the CKEditor image dialog'),
+      '#default_value' => variable_get('picture_ckeditor_label', 'Image size (required)'),
+    );
+
+    $form['submit'] = array(
+      '#type' => 'submit',
+      '#value' => 'Save',
+    );
+  }
+  return $form;
+}
+
+/**
+ * Validate handler for the picture_ckeditor_settings form.
+ * It checks that a fallback image style is selected for every
+ * picture group that has been enabled for the CKEditor image dialog.
+ */
+function picture_ckeditor_settings_validate($form, &$form_state) {
+  $picture_groups = picture_mapping_load();
+  $ckeditor_groups = array();
+  foreach ($picture_groups as $picture_group) {
+    $machine_name = $picture_group->machine_name;
+    if ($form_state['values'][$machine_name]['enabled'] == 1) {
+      if (empty($form_state['values'][$machine_name]['fallback'])) {
+        form_set_error($machine_name . '][fallback', t('Please choose a fallback image style for this picture group'));
+      }
+    }
+  }
+}
+
+/**
+ * Submit handler for the picture_ckeditor_settings form. Places chosen picture
+ * groups into the variables table.
+ */
+function picture_ckeditor_settings_submit($form, &$form_state) {
+  $picture_groups = picture_mapping_load();
+  $ckeditor_groups = array();
+
+  // Loop each picture group and record the settings.
+  foreach ($picture_groups as $picture_group) {
+    $machine_name = $picture_group->machine_name;
+    $ckeditor_groups[$machine_name]['enabled'] = $form_state['values'][$machine_name]['enabled'];
+    $ckeditor_groups[$machine_name]['weight'] = $form_state['values'][$machine_name]['weight'];
+    $ckeditor_groups[$machine_name]['fallback'] = $form_state['values'][$machine_name]['fallback'];
+  }
+
+  uasort($ckeditor_groups, 'picture_compare_weights');
+  variable_set('picture_ckeditor_groups', $ckeditor_groups);
+  variable_set('picture_ckeditor_label', $form_state['values']['ckeditor_label']);
+  drupal_set_message(t('Your settings have been saved'));
+}
+
+/**
+  * Helper function to sort picture groups for the CKEditor image dialog
+  */
+function picture_compare_weights($a, $b) {
+  if ($a['weight'] == $b['weight']) {
+    return 0;
+  }
+  return ($a['weight'] < $b['weight']) ? -1 : 1;
+}
diff --git a/profiles/commons/modules/contrib/picture/picture.info b/profiles/commons/modules/contrib/picture/picture.info
new file mode 100644
index 0000000..64e6765
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture.info
@@ -0,0 +1,17 @@
+name = Picture
+description = Picture element
+core = 7.x
+dependencies[] = ctools
+dependencies[] = image
+dependencies[] = breakpoints
+configure = admin/config/media/picture
+package = Picture
+stylesheets[all][] = picture_wysiwyg.css
+
+
+; Information added by drush on 2014-01-16
+version = "7.x-1.2+6-dev"
+core = "7.x"
+project = "picture"
+datestamp = "1389902323"
+
diff --git a/profiles/commons/modules/contrib/picture/picture.install b/profiles/commons/modules/contrib/picture/picture.install
new file mode 100644
index 0000000..e72698a
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture.install
@@ -0,0 +1,66 @@
+<?php
+/**
+ * @file
+ * Install/schema hooks for the picture module.
+ */
+/**
+ * Implements hook_schema().
+ */
+function picture_schema() {
+  $schema = array();
+  $schema['picture_mapping'] = array(
+    'description' => 'Responsible images and styles mappings to breakpoints',
+    'fields' => array(
+      'id' => array(
+        'type' => 'serial',
+        'not null' => TRUE,
+        'description' => 'The internal identifier for this mapping',
+        'no export' => TRUE, // do not export database only keys.
+      ),
+      'machine_name' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'description' => 'The machine name of the mapping',
+      ),
+      'breakpoint_group' => array(
+        'type' => 'varchar',
+        'length' => 255,
+        'not null' => TRUE,
+        'description' => 'The group this mapping belongs to',
+      ),
+      'mapping' => array(
+        'type' => 'blob',
+        'not null' => TRUE,
+        'description' => 'The mappings linked to the breakpoints group',
+        'serialize' => TRUE,
+      ),
+    ),
+    'primary key' => array('id'),
+    // CTools exportable object definition
+    'export' => array(
+      'key' => 'machine_name',
+      'key name' => 'machine_name',
+      'primary key' => 'id',
+      'identifier' => 'picture_mapping',
+      'admin_title' => 'label',
+      'default hook' => 'default_picture_mapping',
+      'api' => array(
+        'owner' => 'picture',
+        'api' => 'default_picture_mapping',
+        'minimum_version' => 1,
+        'current_version' => 1,
+      ),
+    ),
+  );
+
+  return $schema;
+}
+
+/**
+ * Implements hook_uninstall().
+ */
+function picture_uninstall() {
+  variable_del('picture_ckeditor_groups');
+  variable_del('picture_ckeditor_label');
+}
diff --git a/profiles/commons/modules/contrib/picture/picture.js b/profiles/commons/modules/contrib/picture/picture.js
new file mode 100644
index 0000000..c6a4247
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture.js
@@ -0,0 +1,34 @@
+if (typeof Drupal !== 'undefined' && typeof jQuery !== 'undefined') {
+  // only load if Drupal and jQuery are defined.
+  (function ($) {
+    Drupal.behaviors.picture = {
+      attach: function (context) {
+        // Ensure we always pass a raw DOM element to picture fill, otherwise it
+        // will fallback to the document scope and maybe handle to much.
+        window.picturefill($(context)[0]);
+        // If this is an opened colorbox ensure the content dimensions are set
+        // properly. colorbox.js of the colorbox modules sets #cboxLoadedContent
+        // as context.
+        if (context == '#cboxLoadedContent') {
+          // Try to resize right away.
+          $.colorbox.resize();
+          // Make sure the colorbox resizes always when the image is changed.
+          $('img', context).once('colorbox-lazy-load', function(){
+            $(this).load(function(){
+              // Ensure there's no max-width / max-height otherwise we won't get
+              // the proper values. We could use naturalWeight / naturalHeight
+              // but that's not supported by <IE9 and Opera.
+              this.style.maxHeight = $(window).height() + 'px';
+              this.style.maxWidth = $(window).width() + 'px';
+              $.colorbox.resize({innerHeight: this.height, innerWidth: this.width});
+              // Remove overwrite of this values again to ensure we respect the
+              // stylesheet.
+              this.style.maxHeight = null;
+              this.style.maxWidth = null;
+            });
+          });
+        }
+      }
+    };
+  })(jQuery);
+}
diff --git a/profiles/commons/modules/contrib/picture/picture.module b/profiles/commons/modules/contrib/picture/picture.module
new file mode 100644
index 0000000..b3bbe05
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture.module
@@ -0,0 +1,1208 @@
+<?php
+
+/**
+ * @file
+ * Picture formatter.
+ */
+
+define('PICTURE_CLASS', 'picture');
+define('PICTURE_SEPARATOR', '__');
+define('PICTURE_EMPTY_IMAGE', '_empty image_');
+
+define('PICTURE_IMPLEMENTATION_PICTUREFILL', 'picturefill');
+define('PICTURE_IMPLEMENTATION_WEBLINC', 'weblinc');
+define('PICTURE_IMPLEMENTATION_DEFAULT', 'picturefill');
+
+/**
+ * Implements hook_permission().
+ */
+function picture_permission() {
+  return array(
+    'administer pictures' => array(
+      'title' => t('Administer Pictures'),
+      'description' => t('Administer Pictures'),
+    ),
+  );
+}
+
+/**
+ * Implements hook_menu().
+ */
+function picture_menu() {
+  $items = array();
+
+  $items['admin/config/media/picture'] = array(
+    'title' => 'Picture',
+    'description' => 'Manage Pictures',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('picture_admin_breakpoints'),
+    'access arguments' => array('administer pictures'),
+    'file' => 'picture.admin.inc',
+  );
+
+  $items['admin/config/media/picture/groups'] = array(
+    'title' => 'Groups',
+    'type' => MENU_DEFAULT_LOCAL_TASK,
+    'weight' => 10,
+  );
+
+  $items['admin/config/media/picture/settings'] = array(
+    'title' => 'Settings',
+    'type' => MENU_LOCAL_TASK,
+    'weight' => 20,
+    'description' => 'Pictures settings',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('picture_admin_settings'),
+    'access arguments' => array('administer pictures'),
+    'file' => 'picture.admin.inc',
+  );
+
+  $items['admin/config/media/picture/groups/global'] = array(
+    'title' => 'Map breakpoints and image styles',
+    'type' => MENU_DEFAULT_LOCAL_TASK,
+    'weight' => -1,
+  );
+
+  $items['admin/config/media/picture/groups/import'] = array(
+    'title' => 'Import mappings',
+    'page arguments' => array('picture_admin_import_form'),
+    'type' => MENU_LOCAL_TASK,
+    'access arguments' => array('administer pictures'),
+    'file' => 'picture.admin.inc',
+    'weight' => 999,
+  );
+
+  $breakpoint_groups = breakpoints_breakpoint_group_load_all();
+  foreach ($breakpoint_groups as $breakpoint_group_name => $breakpoint_group) {
+    if (!empty($breakpoint_group->machine_name)) {
+      $items['admin/config/media/picture/groups/' . $breakpoint_group->machine_name] = array(
+        'title' => $breakpoint_group->name,
+        'page arguments' => array('picture_admin_breakpoints', $breakpoint_group->machine_name),
+        'type' => MENU_LOCAL_TASK,
+        'access arguments' => array('administer pictures'),
+        'file' => 'picture.admin.inc',
+        'weight' => 15,
+      );
+      $items['admin/config/media/picture/groups/' . $breakpoint_group->machine_name . '/export'] = array(
+        'title' => 'Export ' . check_plain($breakpoint_group->name) . ' mappings',
+        'page callback' => 'drupal_get_form',
+        'page arguments' => array('picture_admin_export_form', $breakpoint_group->machine_name),
+        'type' => MENU_LOCAL_ACTION,
+        'access arguments' => array('administer pictures', $breakpoint_group->machine_name),
+        'access callback' => 'picture_mappings_export_access',
+        'file' => 'picture.admin.inc',
+        'weight' => 15,
+      );
+    }
+  }
+
+  $items['admin/config/media/picture/ckeditor'] = array(
+    'title' => 'CKEditor',
+    'type' => MENU_LOCAL_TASK,
+    'description' => 'Choose picture groups to present in the CKEditor image dialog',
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('picture_ckeditor_settings'),
+    'access arguments' => array('administer pictures'),
+    'file' => 'picture.admin.inc',
+    'weight' => 0,
+  );
+
+  return $items;
+}
+
+/**
+ * Access callback.
+ */
+function picture_mappings_export_access($perm, $mapping_name) {
+  return picture_mapping_load($mapping_name) && user_access($perm);
+}
+
+/**
+ * Load mappings.
+ */
+function picture_mapping_load($name = NULL) {
+  ctools_include('export');
+  if ($name) {
+    $mappings = ctools_export_load_object('picture_mapping', 'names', array($name));
+    $mapping = isset($mappings[$name]) ? $mappings[$name] : FALSE;
+    return $mapping;
+  }
+  return ctools_export_load_object('picture_mapping');
+}
+
+/**
+ * Load all mappings.
+ */
+function picture_mapping_load_all() {
+  ctools_include('export');
+  return ctools_export_load_object('picture_mapping');
+}
+
+/**
+ * Save mappings.
+ */
+function picture_mapping_save(&$mapping) {
+  ctools_include('export');
+  $update = isset($mapping->id) ? array('id') : array();
+  return drupal_write_record('picture_mapping', $mapping, $update);
+}
+
+/**
+ * Implements hook_library().
+ */
+function picture_library() {
+  switch (variable_get('picture_implementation', PICTURE_IMPLEMENTATION_DEFAULT)) {
+    case PICTURE_IMPLEMENTATION_PICTUREFILL:
+      $libraries['matchmedia'] = array(
+        'title' => t('Matchmedia'),
+        'website' => 'https://github.com/attiks/picturefill-proposal',
+        'version' => '0.1',
+        'js' => array(
+          drupal_get_path('module', 'picture') . '/picturefill/matchmedia.js' => array(
+            'type' => 'file',
+            'weight' => -10,
+            'group' => JS_DEFAULT,
+            'scope' => 'footer',
+            'need_jquery' => FALSE,
+          ),
+        ),
+      );
+      $libraries['picturefill'] = array(
+        'title' => t('Picturefill'),
+        'website' => 'https://github.com/attiks/picturefill-proposal',
+        'version' => '0.1',
+        'js' => array(
+          drupal_get_path('module', 'picture') . '/picturefill/picturefill.js' => array(
+            'type' => 'file',
+            'weight' => -10,
+            'group' => JS_DEFAULT,
+            'scope' => 'footer',
+            'need_jquery' => FALSE,
+          ),
+        ),
+      );
+      $libraries['picture.ajax'] = array(
+        'title' => t('Ajax support for picture'),
+        'version' => VERSION,
+        'js' => array(
+          drupal_get_path('module', 'picture') . '/picture.js' => array(
+            'type' => 'file',
+            'weight' => -10,
+            'group' => JS_DEFAULT,
+            'scope' => 'footer',
+            'need_jquery' => FALSE,
+          ),
+        ),
+      );
+      break;
+    case PICTURE_IMPLEMENTATION_WEBLINC:
+      $libraries['matchmedia'] = array(
+        'title' => t('Matchmedia'),
+        'website' => 'https://github.com/weblinc/media-match',
+        'version' => '0.1',
+        'js' => array(
+          drupal_get_path('module', 'picture') . '/weblinc/media.js' => array(
+            'type' => 'file',
+            'weight' => -10,
+            'group' => JS_DEFAULT,
+            'scope' => 'footer',
+            'need_jquery' => FALSE,
+          ),
+          drupal_get_path('module', 'picture') . '/weblinc/media.extension.js' => array(
+            'type' => 'file',
+            'weight' => -10,
+            'group' => JS_DEFAULT,
+            'scope' => 'footer',
+            'need_jquery' => FALSE,
+          ),
+        ),
+        'css' => array(
+          drupal_get_path('module', 'picture') . '/weblinc/media.css' => array('type' => 'file'),
+        ),
+      );
+      $libraries['picturefill'] = array(
+        'title' => t('Picturefill'),
+        'website' => 'https://github.com/weblinc/picture',
+        'version' => '0.1',
+        'js' => array(
+          drupal_get_path('module', 'picture') . '/weblinc/picture.js' => array(
+            'type' => 'file',
+            'weight' => -10,
+            'group' => JS_DEFAULT,
+            'scope' => 'footer',
+            'need_jquery' => FALSE,
+          ),
+        ),
+      );
+      $libraries['picture.ajax'] = array(
+        'title' => t('Ajax support for picture'),
+        'version' => VERSION,
+        'js' => array(
+          drupal_get_path('module', 'picture') . '/picture.weblinc.js' => array(
+            'type' => 'file',
+            'weight' => -10,
+            'group' => JS_DEFAULT,
+            'scope' => 'footer',
+            'need_jquery' => FALSE,
+          ),
+        ),
+        'css' => array(
+          drupal_get_path('module', 'picture') . '/picture.weblinc.css' => array('type' => 'file'),
+        ),
+      );
+      break;
+  }
+
+  return $libraries;
+}
+
+/**
+ * Empty picture object.
+ */
+function picture_empty_object() {
+  return (object)picture_empty_array();
+}
+
+/**
+ * Empty picture array.
+ */
+function picture_empty_array() {
+  return array(
+    'machine_name' => '',
+    'breakpoint_group' => '',
+    'mapping' => array(),
+  );
+}
+
+/**
+ * Validate mappings.
+ */
+function picture_mapping_validate($mapping) {
+  if (!is_object($mapping)) {
+    return FALSE;
+  }
+  foreach (array('machine_name', 'breakpoint_group', 'mapping') as $property) {
+    if (!property_exists($mapping, $property)) {
+      return FALSE;
+    }
+  }
+  return TRUE;
+}
+
+/**
+ * Implements hook_theme().
+ */
+function picture_theme() {
+  return array(
+    'picture' => array(
+      'variables' => array(
+        'style_name' => NULL,
+        'path' => NULL,
+        'uri' => NULL,
+        'width' => NULL,
+        'height' => NULL,
+        'alt' => '',
+        'title' => NULL,
+        'attributes' => array(),
+        'breakpoints' => array(),
+      ),
+    ),
+    'picture_formatter' => array(
+      'variables' => array(
+        'item' => NULL,
+        'path' => NULL,
+        'image_style' => NULL,
+        'attributes' => array(),
+        'breakpoints' => array(),
+      ),
+    ),
+    'picture_formatter_colorbox' => array(
+      'variables' => array(
+        'item' => NULL,
+        'path' => NULL,
+        'image_style' => NULL,
+        'breakpoints' => array(),
+        'colorbox' => array(),
+        'colorbox_image_style' => NULL,
+        'colorbox_group_id' => NULL,
+      ),
+    ),
+    'picture_source' => array(
+      'variables' => array(
+        'src' => NULL,
+        'dimension' => NULL,
+        'media' => NULL,
+      ),
+    ),
+  );
+}
+
+/**
+ * Implements hook_field_formatter_info().
+ */
+function picture_field_formatter_info() {
+  $formatters = array(
+    'picture' => array(
+      'label' => t('Picture'),
+      'field types' => array('image'),
+      'settings' => array('picture_group' => '', 'fallback_image_style' => '', 'image_link' => '', 'colorbox' => ''),
+    ),
+  );
+
+  return $formatters;
+}
+
+/**
+ * Implements hook_field_formatter_settings_form().
+ */
+function picture_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
+  $display = $instance['display'][$view_mode];
+  $settings = $display['settings'];
+
+  $element['picture_group'] = array(
+    '#title' => t('Picture group'),
+    '#type' => 'select',
+    '#default_value' => $settings['picture_group'],
+    '#required' => TRUE,
+    '#options' => picture_get_mapping_options(),
+  );
+
+  $image_styles = image_style_options(FALSE);
+  $element['fallback_image_style'] = array(
+    '#title' => t('Fallback image style'),
+    '#type' => 'select',
+    '#default_value' => $settings['fallback_image_style'],
+    '#empty_option' => t('Automatic'),
+    '#options' => $image_styles,
+  );
+
+  $link_types = picture_link_types($instance);
+
+  $element['image_link'] = array(
+    '#title' => t('Link image to'),
+    '#type' => 'select',
+    '#default_value' => $settings['image_link'],
+    '#empty_option' => t('Nothing'),
+    '#options' => $link_types,
+  );
+
+  $element['colorbox'] = array(
+    '#title' => t('Colorbox group'),
+    '#type' => 'select',
+    '#default_value' => $settings['colorbox'],
+    '#required' => FALSE,
+    '#options' => picture_get_mapping_options(),
+    '#states' => array(
+      'visible' => array(
+        ':input[name$="[settings_edit_form][settings][image_link]"]' => array('value' => 'colorbox'),
+      ),
+    ),
+  );
+
+  return $element;
+}
+
+/**
+ * Returns a list of picture mappings for use in a select list.
+ */
+function picture_get_mapping_options() {
+  $picture_mapping_options = array();
+  $picture_mappings = picture_mapping_load_all();
+  if ($picture_mappings && !empty($picture_mappings)) {
+    foreach ($picture_mappings as $machine_name => $picture_mapping) {
+      $breakpoint_group = breakpoints_breakpoint_group_load($picture_mapping->breakpoint_group);
+      if ($breakpoint_group) {
+        $picture_mapping_options[$machine_name] = $breakpoint_group->name;
+      }
+    }
+  }
+  return $picture_mapping_options;
+}
+
+/**
+ * Implements hook_field_formatter_settings_summary().
+ */
+function picture_field_formatter_settings_summary($field, $instance, $view_mode) {
+  $display = $instance['display'][$view_mode];
+  $settings = $display['settings'];
+
+  $summary = array();
+
+  if (isset($settings['picture_group'])) {
+    $picture_mapping = picture_mapping_load($settings['picture_group']);
+    $breakpoint_group = breakpoints_breakpoint_group_load($picture_mapping->breakpoint_group);
+    if ($breakpoint_group) {
+      $summary[] = t('Picture group: @picture_group', array('@picture_group' => $breakpoint_group->name));
+    }
+    else {
+      $summary[] = t("Picture group doesn't exists");
+    }
+  }
+  else {
+    $summary[] = t("You have to select a mapping first.");
+  }
+
+  $image_styles = image_style_options(FALSE);
+  unset($image_styles['']);
+  if (isset($image_styles[$settings['fallback_image_style']])) {
+    $summary[] = t('Fallback Image style: @style', array('@style' => $image_styles[$settings['fallback_image_style']]));
+  }
+  else {
+    $summary[] = t('Automatic fallback');
+  }
+
+  $link_types = picture_link_types($instance);
+
+  // Display this setting only if image is linked.
+  if (isset($link_types[$settings['image_link']])) {
+    $summary[] = filter_xss_admin($link_types[$settings['image_link']]);
+  }
+
+  return implode('<br />', $summary);
+}
+
+/**
+ * Implements hook_field_formatter_view().
+ */
+function picture_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
+  $element = array();
+
+  // Check if the formatter involves a link.
+  $image_link = $display['settings']['image_link'];
+  if ($image_link == 'content') {
+    $uri = entity_uri($entity_type, $entity);
+  }
+  elseif ($image_link == 'file') {
+    $link_file = TRUE;
+  }
+  elseif ($image_link) {
+    if (isset($entity->$image_link)) {
+      // Support for field translations.
+      $language = field_language($entity_type, $entity, $field['field_name']);
+      $link_field = $entity->$image_link;
+
+      if (isset($link_field[$language])) {
+        $link_values = $link_field[$language];
+      }
+    }
+  }
+
+  $fallback_image_style = '';
+  $mappings = picture_mapping_load($display['settings']['picture_group']);
+  $breakpoint_styles = picture_get_mapping_breakpoints($mappings, $fallback_image_style);
+
+  if (isset($display['settings']['fallback_image_style']) && !empty($display['settings']['fallback_image_style'])) {
+    $fallback_image_style = $display['settings']['fallback_image_style'];
+  }
+
+  // Assume regular display.
+  $formatter = 'picture_formatter';
+  $colorbox_breakpoints = array();
+  $colorbox_fallback_image_style = '';
+
+  // Check for colorbox link.
+  if (module_exists('colorbox') && $display['settings']['image_link'] == 'colorbox') {
+    $formatter = 'picture_formatter_colorbox';
+    $mappings = picture_mapping_load($display['settings']['colorbox']);
+    $colorbox_breakpoints = picture_get_mapping_breakpoints($mappings, $colorbox_fallback_image_style);
+  }
+
+  foreach ($items as $delta => $item) {
+    if (isset($link_file)) {
+      $uri = array(
+        'path' => file_create_url($item['uri']),
+        'options' => array(),
+      );
+    }
+    // Handle multiple link with image values.
+    if (isset($link_values)) {
+      if (isset($link_values[$delta]['url'])) {
+        $uri = array(
+          'path' => $link_values[$delta]['url'],
+          'options' => array('attributes' => $link_values[$delta]['attributes']),
+        );
+        // Handle query fragment if there is any.
+        if (!empty($link_values[$delta]['query'])) {
+          $uri['options']['query'] = $link_values[$delta]['query'];
+        }
+      }
+      // If there are more image values than link values unset the link.
+      else {
+        unset($uri);
+      }
+    }
+    $element[$delta] = array(
+      '#theme' => $formatter,
+      '#attached' => array('library' => array(
+        array('picture', 'matchmedia'),
+        array('picture', 'picturefill'),
+        array('picture', 'picture.ajax'),
+      )),
+      '#item' => $item,
+      '#image_style' => $fallback_image_style,
+      '#breakpoints' => $breakpoint_styles,
+      '#path' => isset($uri) ? $uri : '',
+      '#colorbox' => $colorbox_breakpoints,
+      '#colorbox_image_style' => $colorbox_fallback_image_style,
+    );
+
+    // Add css and js for colorbox.
+    if ($formatter == 'picture_formatter_colorbox') {
+      $element[$delta]['#attached']['css'][drupal_get_path('module', 'picture') . '/picture_colorbox.css'] = array('type' => 'file');
+      $element[$delta]['#attached']['js'][drupal_get_path('module', 'picture') . '/picture_colorbox.js'] = array('type' => 'file');
+      if (!variable_get('colorbox_inline', 0)) {
+        $element[$delta]['#attached']['js'][drupal_get_path('module', 'colorbox') . '/js/colorbox_inline.js'] = array('type' => 'file');
+      }
+    }
+  }
+
+  return $element;
+}
+
+/**
+ * Theme picture.
+ */
+function theme_picture_formatter($variables) {
+  if (!isset($variables['breakpoints']) || empty($variables['breakpoints'])) {
+    return theme('image_formatter', $variables);
+  }
+
+  $item = $variables['item'];
+
+  // Do not output an empty 'title' attribute.
+  if (isset($item['title']) && drupal_strlen($item['title']) == 0) {
+    unset($item['title']);
+  }
+
+  $item['style_name'] = $variables['image_style'];
+  $item['breakpoints'] = $variables['breakpoints'];
+  $item['attributes'] = $variables['attributes'];
+
+  if (!isset($item['path']) && isset($variables['uri'])) {
+    $item['path'] = $variables['uri'];
+  }
+  $output = theme('picture', $item);
+
+  if (isset($variables['path']['path'])) {
+    $path = $variables['path']['path'];
+    $options = isset($variables['path']['options']) ? $variables['path']['options'] : array();
+    $options['html'] = TRUE;
+    $output = l($output, $path, $options);
+  }
+  return $output;
+}
+
+/**
+ * Theme function to add support for colorbox.
+ */
+function theme_picture_formatter_colorbox($variables) {
+  if (!isset($variables['breakpoints']) || empty($variables['breakpoints'])) {
+    return theme('image_formatter', $variables);
+  }
+
+  $item = $variables['item'];
+
+  // Do not output an empty 'title' attribute.
+  if (isset($item['title']) && drupal_strlen($item['title']) == 0) {
+    unset($item['title']);
+  }
+
+  $item['style_name'] = $variables['image_style'];
+  $item['breakpoints'] = $variables['breakpoints'];
+
+  if (!isset($item['path']) && isset($variables['uri'])) {
+    $item['path'] = $variables['uri'];
+  }
+  $output = theme('picture', $item);
+
+  if (isset($variables['colorbox'])) {
+    $item['breakpoints'] = $variables['colorbox'];
+    $item['style_name'] = $variables['colorbox_image_style'];
+    $id = 'picture-colorbox-' . user_password();
+    $colorbox = '<div style="display: none;"><div id="' . $id . '" class="picture-colorbox-container">' . theme('picture', $item) . '</div></div>';
+
+    $options = array(
+      'attributes' => array('class' => array('colorbox-inline')),
+      'query' => array('maxWidth' => '80%', 'maxHeight' => '80%', 'inline' => 'true'),
+      'fragment' => $id,
+      'html' => TRUE,
+    );
+
+    if (!empty($variables['colorbox_group_id'])) {
+      $options['attributes']['rel'] = $variables['colorbox_group_id'];
+    }
+
+    // Do not load picture automatically.
+    $colorbox = str_replace('span data-picture=""', 'span data-picture-lazy="lazy"', $colorbox);
+    $output = l($output, current_path(), $options) . $colorbox;
+  }
+  return $output;
+}
+
+/**
+ * Returns HTML for a picture.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - uri: Either the path of the image file (relative to base_path()) or a
+ *     full URL.
+ *   - width: The width of the image (if known).
+ *   - height: The height of the image (if known).
+ *   - alt: The alternative text for text-based browsers.
+ *   - breakpoints: An array containing breakpoints.
+ *   - attributes: An array containing attributes.
+ *
+ * @ingroup themeable
+ */
+function theme_picture($variables) {
+  // Make sure that width and height are proper values
+  // If they exists we'll output them
+  // @see http://www.w3.org/community/respimg/2012/06/18/florians-compromise/
+  if (isset($variables['width']) && empty($variables['width'])) {
+    unset($variables['width']);
+    unset($variables['height']);
+  }
+  elseif (isset($variables['height']) && empty($variables['height'])) {
+    unset($variables['width']);
+    unset($variables['height']);
+  }
+
+  $sources = array();
+  $output = array();
+
+  // Fallback image, output as source with media query.
+  $sources[] = array(
+    'src' => _picture_image_style_url($variables['style_name'], $variables['uri']),
+    'dimensions' => picture_get_image_dimensions($variables),
+  );
+
+  // All breakpoints and multipliers.
+  foreach ($variables['breakpoints'] as $breakpoint_name => $multipliers) {
+    $breakpoint = breakpoints_breakpoint_load_by_fullkey($breakpoint_name);
+    if ($breakpoint) {
+      $new_sources = array();
+      switch (variable_get('picture_implementation', PICTURE_IMPLEMENTATION_DEFAULT)) {
+        case PICTURE_IMPLEMENTATION_PICTUREFILL:
+          foreach ($multipliers as $multiplier => $image_style) {
+            $new_source = $variables;
+            $new_source['style_name'] = $image_style;
+            $new_source['#media_query'] = picture_get_multiplier_media_query($multiplier, $breakpoint->breakpoint);
+            $new_sources[] = $new_source;
+          }
+          foreach ($new_sources as $new_source) {
+            $sources[] = array(
+              'src' => _picture_image_style_url($new_source['style_name'], $new_source['uri']),
+              'dimensions' => picture_get_image_dimensions($new_source),
+              'media' => $new_source['#media_query'],
+            );
+          }
+          break;
+        case PICTURE_IMPLEMENTATION_WEBLINC:
+          foreach ($multipliers as $multiplier => $image_style) {
+            $new_source = $variables;
+            $new_source['style_name'] = $image_style;
+            $new_source['#media_query'] = $breakpoint->breakpoint;
+            $new_source['#multiplier'] = $multiplier;
+            $new_sources[] = $new_source;
+          }
+
+          // Only one image, use src.
+          if (count($new_sources) == 1) {
+            foreach ($new_sources as $new_source) {
+              $sources[] = array(
+                'src' => _picture_image_style_url($new_source['style_name'], $new_source['uri']),
+                'dimensions' => picture_get_image_dimensions($new_source),
+                'media' => $new_source['#media_query'],
+              );
+            }
+          }
+          else {
+            // Mutliple images, use srcset.
+            $srcset = array();
+            foreach ($new_sources as $new_source) {
+              $srcset[] = _picture_image_style_url($new_source['style_name'], $new_source['uri']) . ' ' . $new_source['#multiplier'];
+            }
+            $sources[] = array(
+              'srcset' => implode(', ', $srcset),
+              'dimensions' => picture_get_image_dimensions($new_sources[0]),
+              'media' => $new_source['#media_query'],
+            );
+          }
+          break;
+      }
+    }
+  }
+
+  if (!empty($sources)) {
+    $attributes = array();
+    foreach (array('alt', 'title') as $key) {
+      $field = sprintf('field_file_image_%s_text', $key);
+      if (isset($variables[$key]) && !empty($variables[$key])) {
+        $attributes['data-' . $key] = $variables[$key];
+      }
+      elseif (isset($variables[$field]) && is_array($variables[$field]) && isset($variables[$field]['und'][0]['safe_value'])) {
+        $attributes['data-' . $key] = $variables[$field]['und'][0]['safe_value'];
+      }
+    }
+
+    // Add attributes that are already prefixed by 'data-'
+    foreach (array('data-picture-group', 'data-picture-align') as $key) {
+      if (isset($variables[$key]) && !empty($variables[$key])) {
+        $attributes[$key] = $variables[$key];
+      }
+    }
+
+     // Add additional attributes passed in through the render array.
+    if (isset($variables['attributes']) && !empty($variables['attributes'])) {
+      $attributes = array_merge($attributes, $variables['attributes']);
+    }
+    $output[] = '<span data-picture=""' . drupal_attributes($attributes) . '>';
+
+    // Add source tags to the output.
+    foreach ($sources as $source) {
+      $output[] = theme('picture_source', $source);
+    }
+
+    // Output the fallback image.
+    if (empty($variables['path']) && isset($variables['uri'])) {
+      $variables['path'] = $variables['uri'];
+    }
+
+    $output[] = '<noscript>' . theme('image_style', $variables) . '</noscript>';
+    $output[] = '</span>';
+    return implode("\n", $output);
+  }
+}
+
+/**
+ * Generates the media query for multipliers of an image
+ *
+ * @param $multiplier
+ *   A string containing the multiplier for which the media query is for.
+ *
+ * @param $breakpoint
+ *   A string containing the breakpoint media query.
+ *
+ * @return sting
+ *   The sting containing the media query for the multiplier.
+ */
+function picture_get_multiplier_media_query($multiplier, $breakpoint) {
+  $media_query = $breakpoint;
+  if ($multiplier != '1x') {
+    $multiplier_formatted = str_replace('x', '', $multiplier);
+    $media_query = $breakpoint . ' and (min-device-pixel-ratio: ' . $multiplier_formatted . '), ';
+    $media_query .= $breakpoint . ' and (-o-min-device-pixel-ratio: ' . $multiplier_formatted . '), ';
+    $media_query .= $breakpoint . ' and (-webkit-min-device-pixel-ratio: ' . $multiplier_formatted . '), ';
+    $media_query .= $breakpoint . ' and (min-resolution: ' . $multiplier_formatted . 'dppx)';
+  }
+  return $media_query;
+}
+
+/**
+ * Returns HTML for a source tag.
+ *
+ * @param type $variables
+ *   An associative array containing:
+ *   - media: The media query to use.
+ *   - src: Either the path of the image file (relative to base_path()) or a
+ *     full URL.
+ *   - dimensions: The width and height of the image (if known).
+ *
+ * @ingroup themeable
+ */
+function theme_picture_source($variables) {
+  $output = array();
+  // Convert width, height to data-width, data-height.
+  foreach (array('width', 'height') as $key) {
+    if (isset($variables['dimensions'][$key])) {
+      $variables['dimensions']['data-' . $key] = $variables['dimensions'][$key];
+    }
+    unset($variables['dimensions'][$key]);
+  }
+
+  if (isset($variables['media']) && !empty($variables['media'])) {
+    if (isset($variables['srcset']) && !empty($variables['srcset'])) {
+      $output[] = '<span data-media="' . $variables['media'] . '" data-srcset="' . $variables['srcset'] . '" ' . drupal_attributes($variables['dimensions']) . '></span>';
+    }
+    else {
+      $output[] = '<span data-media="' . $variables['media'] . '" data-src="' . $variables['src'] . '" ' . drupal_attributes($variables['dimensions']) . '></span>';
+    }
+  }
+  else {
+    $output[] = '<span data-src="' . $variables['src'] . '" ' . drupal_attributes($variables['dimensions']) . '></span>';
+  }
+  return implode("\n", $output);
+}
+
+/**
+ * Determines the dimensions of an image.
+ *
+ * @param $variables
+ *   An associative array containing:
+ *   - style_name: The name of the style to be used to alter the original image.
+ *   - width: The width of the source image (if known).
+ *   - height: The height of the source image (if known).
+ *
+ * @return array
+ *   Dimensions to be modified - an array with components width and height, in
+ *   pixels.
+ */
+function picture_get_image_dimensions($variables) {
+  // Determine the dimensions of the styled image.
+  $dimensions = array(
+    'width' => $variables['width'],
+    'height' => $variables['height'],
+  );
+
+  if ($variables['style_name'] == PICTURE_EMPTY_IMAGE) {
+    $dimensions = array(
+      'width' => 1,
+      'height' => 1,
+    );
+  }
+  else {
+    image_style_transform_dimensions($variables['style_name'], $dimensions);
+  }
+
+  return $dimensions;
+}
+
+/**
+ * Implements hook_filter_info().
+ */
+function picture_filter_info() {
+  $filters = array();
+  $filters['picture'] = array(
+    'title' => t('Make images responsive with the picture module'),
+    'description' => t('Replace img tags with markup that contains media width breakpoints. The appropriate image file size will be chosen.'),
+    'process callback' => '_picture_filter_process',
+    'tips callback' => '_picture_filter_tips',
+    );
+
+  return $filters;
+}
+
+/**
+ * Process callback for inline image filter.
+ */
+function _picture_filter_process($text, $filter) {
+
+  // Find all img tags with a data-picture-group attribute.
+  preg_match_all('/<img.*?data-picture-group=".*?>/i', $text, $images);
+
+  if (!empty($images[0])) {
+    foreach ($images[0] as $image) {
+      // Create the render array expected by theme_picture_formatter.
+      $image_render_array = _picture_filter_prepare_image($image);
+      if (!$image_render_array) {
+        return $text;
+      }
+
+      // Get the responsive markup for this image.
+      $new_markup = theme('picture_formatter', $image_render_array);
+
+      // Replace the original img tag with the responsive markup.
+      $text = str_replace($image, $new_markup, $text);
+    }
+  }
+  return $text;
+}
+
+/**
+ * Prepares a Render Array for theme_picture_formatter().
+ * It is similar to picture_field_formatter_view()
+ * with modifications for inline images.
+ *
+ * @param $image
+ *   An img tag
+ * @see picture_field_formatter_view()
+ */
+function _picture_filter_prepare_image($image) {
+  // Make sure the closing tag is right.
+  $image = str_replace('/>', '>', $image);
+  $image = str_replace('>', ' />', $image);
+
+  // Parse the tag as xml.
+  $xml = simplexml_load_string('<image>' . html_entity_decode($image, ENT_QUOTES, "utf-8") . '</image>');
+  if (isset($xml->img[0]) && is_object($xml->img[0])) {
+    $attributes = array();
+    foreach ($xml->img[0]->attributes() as $a => $b) {
+      $attributes[$a] = (string) $b;
+    }
+  }
+
+  $fallback_image_style = '';
+  $mappings = picture_mapping_load($attributes['data-picture-group']);
+  $breakpoint_styles = picture_get_mapping_breakpoints($mappings, $fallback_image_style);
+
+  // Make sure we have a src attribute.
+  if (!isset($attributes['src'])) {
+    return FALSE;
+  }
+  $src = $attributes['src'];
+
+  // Make sure we have map src to uri.
+  $uri = picture_image_uri($src);
+  if (!$uri) {
+    return FALSE;
+  }
+
+  $image_info = image_get_info($uri);
+  if (!$image_info) {
+    // It's not an image.
+    return FALSE;
+  }
+  $picture_groups = variable_get('picture_ckeditor_groups', array());
+  $image_render_array = array(
+    '#theme' => 'picture_formatter',
+    '#item' => array(
+      'style_name' => $picture_groups[$attributes['data-picture-group']]['fallback'],
+      'uri' => $uri,
+      'width' => $image_info['width'],
+      'height' => $image_info['height'],
+      'data-picture-group' => $attributes['data-picture-group'],
+      'data-picture-align' => isset($attributes['data-picture-align']) ? $attributes['data-picture-align'] : '',
+      'alt' => isset($attributes['alt']) ? $attributes['alt'] : '',
+      'title' => isset($attributes['title']) ? $attributes['title'] : '',
+      'filemime' => $image_info['mime_type'],
+    ),
+    '#image_style' => $picture_groups[$attributes['data-picture-group']]['fallback'],
+    '#breakpoints' => $breakpoint_styles,
+    '#path' => '',
+  );
+
+  return $image_render_array;
+
+}
+
+/**
+ * Implements callback_filter_tips().
+ */
+function _picture_filter_tips($filter, $format, $long = FALSE) {
+  return t('Images with a data-picture-group attribute will be responsive, with a file size appropriate for the browser width.');
+}
+
+/**
+ * Implements hook_page_build().
+ *
+ * Add the image processing javascript to every page. This allows these scripts
+ * to get included in aggregation, which is probably good since there will be
+ * pictures needing this javascript on most pages. The library does not get
+ * added twice, even if it's attached to multiple fields that are also being
+ * displayed with responsive images. Maybe this should check that the
+ * page is not an admin theme page?
+ */
+function picture_page_build(&$page) {
+  drupal_add_library('picture', 'matchmedia', TRUE);
+  drupal_add_library('picture', 'picturefill', TRUE);
+  drupal_add_library('picture', 'picture.ajax', TRUE);
+
+  // Integrate with the WYSIWYG module, and the CKEditor module.
+  $picture_groups = picture_get_mapping_options();
+  $ckeditor_groups = variable_get('picture_ckeditor_groups', array());
+  $groups = array();
+  // CKEditor library expects an array of options formatted as
+  // ['Display name', 'machine_name'].
+  foreach ($picture_groups as $key => $value) {
+    if (array_key_exists($key, $ckeditor_groups)) {
+      if ($ckeditor_groups[$key]['enabled'] == 1) {
+        $groups[] = array($value, $key);
+      }
+    }
+  }
+  if (!empty($groups)) {
+    $groups[] = array('Not Set', 'not_set');
+    drupal_add_js(array(
+      'picture' => array(
+        'groups' => $groups,
+        'label' => variable_get('picture_ckeditor_label', 'Image size (required)'),
+        ),
+      ), 'setting');
+  }
+}
+
+/**
+ * Helper function to figure out the uri of an image given the
+ * image src.
+ *
+ * @param
+ *   Image src starting with http://, https://, or root relative /.
+ *   It must point to a local file.
+ */
+function picture_image_uri($src) {
+  global $base_path;
+
+  $uri = '';
+  // Prepare the src by removing http:// or https://.
+  $src = parse_url($src, PHP_URL_PATH);
+  // Remove leading or trailing slashes.
+  $src = trim($src, '/');
+
+  // List all visible stream wrappers. Make sure they're also local since the
+  // getDirectoryPath method exists only for classes that extend
+  // DrupalLocalStreamWrapper.
+  $local_visible_stream_wrappers = array_intersect_key(file_get_stream_wrappers(STREAM_WRAPPERS_LOCAL), file_get_stream_wrappers(STREAM_WRAPPERS_VISIBLE));
+  $needles = array();
+  $matches = array();
+  foreach ($local_visible_stream_wrappers as $scheme => $data) {
+    $class = file_stream_wrapper_get_class($scheme);
+    $stream_wrapper = new $class();
+    // Trim leading or trailing slashes since the Directory could be root
+    // relative.
+    $needles[$scheme] = trim($base_path . $stream_wrapper->getDirectoryPath(), '/');
+
+    // Check whether the file stream directory is at the beginning of
+    // the image src. Use === since strpos could return false.
+    if (!empty($needles[$scheme]) && strpos($src, $needles[$scheme]) === 0) {
+      $matches[$scheme] = $needles[$scheme];
+    }
+  }
+
+  // If one file scheme directory is a subdirectory of another file
+  // scheme directory, choose the longer one. This issue is possible with
+  // the following scenario:
+  // public file dir: /sites/default/files/
+  // private file dir: /sites/default/files/private/
+  // image src: /sites/default/files/private/the-image.jpg
+  // In this example, the intended scheme would be 'private'.
+
+  if (empty($matches)) {
+    // Can't figure out the Drupal uri.
+    return FALSE;
+  }
+  // Find the length of each matching directory path.
+  $lengths = array_map('strlen', $matches);
+
+  // Determine the key of the longest one.
+  $the_scheme = array_search(max($lengths), $lengths);
+
+  // Construct the Drupal uri.
+  $uri = $the_scheme . '://' . str_replace($matches[$the_scheme], '', $src);
+  $uri = file_stream_wrapper_uri_normalize($uri);
+
+  return $uri;
+}
+
+/**
+ * Implements hook_wysiwyg_plugin() to modify the CKEditor image dialog for use
+ * with the picture module.
+ */
+function picture_wysiwyg_plugin($editor, $version) {
+  if ($editor == 'ckeditor') {
+    return array('picture_ckeditor' => array(
+      'path' => drupal_get_path('module', 'picture') .'/plugins/',
+      'load' => TRUE,
+      'extensions' => array('picture_ckeditor' => t('Responsive images with the Picture Module')),
+      'url' => 'http://drupal.org/projects/picture',
+    ));
+  }
+}
+
+/**
+ * Implements hook_ckeditor_plugin() to modify the CKEditor image dialog for use
+ * with the picture module.
+ */
+function picture_ckeditor_plugin() {
+  return array(
+    'picture_ckeditor' => array(
+      // Name of the plugin used to write it.
+      'name' => 'picture_ckeditor',
+      // Description of the plugin - it would be displayed in the plugins management section of profile settings.
+      'desc' => t('Support responsive images with the Picture module.'),
+      // The full path to the CKEditor plugins directory, with the trailing slash.
+      'buttons' => FALSE,
+      'path' => drupal_get_path('module', 'picture') . '/plugins/',
+      'default' => 't',
+    )
+  );
+}
+
+/**
+ * Wrapper around image_style_url() so we can return an empty image.
+ */
+function _picture_image_style_url($style_name, $path) {
+  if ($style_name == PICTURE_EMPTY_IMAGE) {
+    return 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
+  }
+  return image_style_url($style_name, $path);
+}
+
+/**
+ * Implements hook_wysiwyg_editor_settings_alter().
+ */
+function picture_wysiwyg_editor_settings_alter(&$settings, $context) {
+  if ($context['profile']->editor == 'ckeditor') {
+    if (!isset($settings['extraAllowedContent'])) {
+      $settings['extraAllowedContent'] = array(
+        'img[src,title,alt,style,width,height,class,hspace,vspace,view_mode,format,fid,data-picture-group,data-picture-align]',
+      );
+    }
+    else {
+      // @todo: try finding the img entry and add data- attributes if needed.
+    }
+  }
+}
+
+/**
+ * Returns a list with the image styles of a mapping configuration.
+ *
+ * @param object $mappings
+ *   The mapping configuration.
+ * @param string $fallback_image_style
+ *   Reference to access the evaluated fallback image style.
+ *
+ * @return array
+ *   List with the image styles of a mapping configuration.
+ *   The array has following structure:
+ *   array(
+ *     breakpoint_name => array(
+ *       multiplier => image_style
+ *     )
+ *   )
+ */
+function picture_get_mapping_breakpoints($mappings, &$fallback_image_style = NULL) {
+  $breakpoint_styles = array();
+  if (is_object($mappings)) {
+    foreach ($mappings->mapping as $breakpoint_name => $multipliers) {
+      if (!empty($multipliers)) {
+        foreach ($multipliers as $multiplier => $image_style) {
+          if (!empty($image_style)) {
+            if (empty($fallback_image_style)) {
+              $fallback_image_style = $image_style;
+            }
+            if (!isset($breakpoint_styles[$breakpoint_name])) {
+              $breakpoint_styles[$breakpoint_name] = array();
+            }
+            $breakpoint_styles[$breakpoint_name][$multiplier] = $image_style;
+          }
+        }
+      }
+    }
+  }
+  return $breakpoint_styles;
+}
+
+/**
+ * Helper function to compute the list of possible link types.
+ */
+function picture_link_types($instance) {
+  $link_types = array(
+    'content' => t('Content'),
+    'file' => t('File'),
+  );
+
+  if (module_exists('colorbox')) {
+    $link_types['colorbox'] = t('Colorbox');
+  }
+
+  // If the link module is installed, also allow any link fields to be used.
+  foreach (field_info_fields() as $field_key => $field_info) {
+    if ($field_info['type'] == 'link_field') {
+      $field_instance = field_info_instance($instance['entity_type'], $field_info['field_name'], $instance['bundle']);
+      if ($field_instance) {
+        $link_types[$field_key] = "$field_instance[label] ($field_info[field_name])";
+      }
+    }
+  }
+  return $link_types;
+}
diff --git a/profiles/commons/modules/contrib/picture/picture.weblinc.css b/profiles/commons/modules/contrib/picture/picture.weblinc.css
new file mode 100644
index 0000000..252ad7e
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture.weblinc.css
@@ -0,0 +1,3 @@
+span img.unmatch {
+  display: none !important;
+}
diff --git a/profiles/commons/modules/contrib/picture/picture.weblinc.js b/profiles/commons/modules/contrib/picture/picture.weblinc.js
new file mode 100644
index 0000000..6d25f27
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture.weblinc.js
@@ -0,0 +1,11 @@
+if (typeof Drupal !== 'undefined' && typeof jQuery !== 'undefined') {
+  // only load if Drupal and jQuery are defined.
+  (function ($) {
+    Drupal.behaviors.picture = {
+      attach: function (context) {
+        Picture.parse();
+        Picture.watch();
+      }
+    };
+  })(jQuery);
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/picture/picture_colorbox.css b/profiles/commons/modules/contrib/picture/picture_colorbox.css
new file mode 100644
index 0000000..4b32292
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture_colorbox.css
@@ -0,0 +1,10 @@
+.picture-colorbox-container {
+  max-width: 100%;
+  max-height: 100%;
+  overflow: hidden;
+  height: 100%;
+}
+.picture-colorbox-container img {
+  max-width: 100%;
+  max-height: 100%;
+}
diff --git a/profiles/commons/modules/contrib/picture/picture_colorbox.js b/profiles/commons/modules/contrib/picture/picture_colorbox.js
new file mode 100644
index 0000000..f67251f
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture_colorbox.js
@@ -0,0 +1,26 @@
+/*
+ * Lazy load picture element.
+ */
+ 
+(function(win) {
+  'use strict';
+
+  function _lazyload_pictures() {
+    var pics    = win.document.getElementsByTagName('span'),
+        picl    = pics.length,
+        pic     = null;
+
+    while (picl-- && (pic = pics[picl])) {
+      if (pic.getAttribute('data-picture-lazy') === 'lazy') {
+        pic.setAttribute('data-picture', '');
+        pic.removeAttribute('data-picture-lazy');
+      }
+    }
+  }
+
+  if (win.addEventListener) {
+      win.addEventListener('load', _lazyload_pictures);
+  } else {
+      win.attachEvent('onload', _lazyload_pictures);
+  }  
+})(window);
diff --git a/profiles/commons/modules/contrib/picture/picture_wysiwyg.css b/profiles/commons/modules/contrib/picture/picture_wysiwyg.css
new file mode 100644
index 0000000..5b2086b
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picture_wysiwyg.css
@@ -0,0 +1,36 @@
+/* This CSS file needs to be included either in the theme used for
+* editing content in order to be included in the WYSIWYG edit iframe,
+* or specifically included in the WYSIWYG config page's
+* "Define CSS" textfield.
+*/
+span[data-picture-align="left"], img[data-picture-align="left"]  {
+  float: left;
+}
+span[data-picture-align="right"], img[data-picture-align="right"]  {
+  float: right;
+}
+span[data-picture-align="center"], img[data-picture-align="center"]  {
+  display: block;
+  margin-left: auto;
+  margin-right: auto;
+}
+/* Remove ugly boarders that bunch up in the image dialog table. */
+.cke_dialog_body tr td:last-child {
+  border-right: 0px;
+}
+/* The following is an example of what you could put in your theme
+ * to control the size of images. It is formatted as
+ * span[data-picture-group="[The machine name of your picture group]"
+span[data-picture-group="wide"] {
+  width: 100%;
+}
+span[data-picture-group="normal"] {
+  width: 50%;
+}
+span[data-picture-group="narrow"] {
+  width: 33%;
+}
+span[data-picture-group] img {
+  width: 100%;
+  height: auto;
+}*/
diff --git a/profiles/commons/modules/contrib/picture/picturefill/matchmedia.js b/profiles/commons/modules/contrib/picture/picturefill/matchmedia.js
new file mode 100644
index 0000000..a26723a
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picturefill/matchmedia.js
@@ -0,0 +1,134 @@
+/**
+ * Polyfill the behavior of window.matchMedia.
+ *
+ * @see http://dev.w3.org/csswg/cssom-view/#widl-Window-matchMedia-MediaQueryList-DOMString-query
+ *
+ * Test whether a CSS media type or media query applies. Register listeners
+ * to MediaQueryList objects.
+ *
+ * Adapted from https://github.com/paulirish/matchMedia.js with the addition
+ * of addListener and removeListener. The polyfill referenced above uses
+ * polling to trigger registered listeners on matchMedia tests.
+ * This polyfill triggers tests on window resize and orientationchange.
+ */
+
+window.matchMedia = window.matchMedia || (function (doc, window, Drupal) {
+
+  "use strict";
+
+  var docElem = doc.documentElement;
+  var refNode = docElem.firstElementChild || docElem.firstChild;
+  // fakeBody required for <FF4 when executed in <head>.
+  var fakeBody = doc.createElement("body");
+  var div = doc.createElement("div");
+
+  div.id = "mq-test-1";
+  div.style.cssText = "position:absolute;top:-100em";
+  fakeBody.style.background = "none";
+  fakeBody.appendChild(div);
+
+  /**
+   * A replacement for the native MediaQueryList object.
+   *
+   * @param {String} q
+   *   A media query e.g. "screen" or "screen and (min-width: 28em)".
+   */
+  function MediaQueryList (q) {
+    this.media = q;
+    this.matches = false;
+    this.check.call(this);
+  }
+
+  /**
+   * Polyfill the addListener and removeListener methods.
+   */
+  MediaQueryList.prototype = {
+    listeners: [],
+
+    /**
+     * Perform the media query application check.
+     */
+    check: function () {
+      var isApplied;
+      div.innerHTML = "&shy;<style media=\"" + this.media + "\"> #mq-test-1 {width: 42px;}</style>";
+      docElem.insertBefore(fakeBody, refNode);
+      isApplied = div.offsetWidth === 42;
+      docElem.removeChild(fakeBody);
+      this.matches = isApplied;
+    },
+
+    /**
+     * Polyfill the addListener method of the MediaQueryList object.
+     *
+     * @param {Function} callback
+     *   The callback to be invoked when the media query is applicable.
+     *
+     * @return {Object MediaQueryList}
+     *   A MediaQueryList object that indicates whether the registered media
+     *   query applies. The matches property is true when the media query
+     *   applies and false when not. The original media query is referenced in
+     *   the media property.
+     */
+    addListener: function (callback) {
+      var handler = (function (mql, debounced) {
+        return function () {
+          // Only execute the callback if the state has changed.
+          var oldstate = mql.matches;
+          mql.check();
+          if (oldstate !== mql.matches) {
+            debounced.call(mql, mql);
+          }
+        };
+      }(this, Drupal.debounce(callback, 250)));
+      this.listeners.push({
+        'callback': callback,
+        'handler': handler
+      });
+
+      // Associate the handler to the resize and orientationchange events.
+      if ('addEventListener' in window) {
+        window.addEventListener('resize', handler);
+        window.addEventListener('orientationchange', handler);
+      }
+      else if ('attachEvent' in window) {
+        window.attachEvent('onresize', handler);
+        window.attachEvent('onorientationchange', handler);
+      }
+    },
+
+    /**
+     * Polyfill the removeListener method of the MediaQueryList object.
+     *
+     * @param {Function} callback
+     *   The callback to be removed from the set of listeners.
+     */
+    removeListener: function (callback) {
+      for (var i = 0, listeners = this.listeners; i < listeners.length; i++) {
+        if (listeners[i].callback === callback) {
+          // Disassociate the handler to the resize and orientationchange events.
+          if ('removeEventListener' in window) {
+            window.removeEventListener('resize', listeners[i].handler);
+            window.removeEventListener('orientationchange', listeners[i].handler);
+          }
+          else if ('detachEvent' in window) {
+            window.detachEvent('onresize', listeners[i].handler);
+            window.detachEvent('onorientationchange', listeners[i].handler);
+          }
+          listeners.splice(i, 1);
+        }
+      }
+    }
+  };
+
+  /**
+   * Return a MediaQueryList.
+   *
+   * @param {String} q
+   *   A media query e.g. "screen" or "screen and (min-width: 28em)". The media
+   *   query is checked for applicability before the object is returned.
+   */
+  return function (q) {
+    // Build a new MediaQueryList object with the result of the check.
+    return new MediaQueryList(q);
+  };
+}(document, window, Drupal));
diff --git a/profiles/commons/modules/contrib/picture/picturefill/picturefill.js b/profiles/commons/modules/contrib/picture/picturefill/picturefill.js
new file mode 100644
index 0000000..ebcdd82
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/picturefill/picturefill.js
@@ -0,0 +1,82 @@
+/*jshint loopfunc: true, browser: true, curly: true, eqeqeq: true, expr: true, forin: true, latedef: true, newcap: true, noarg: true, trailing: true, undef: true, unused: true */
+/*! Picturefill - Author: Scott Jehl, 2012 | License: MIT/GPLv2 */
+(function(w, parent){
+
+  // Enable strict mode.
+  "use strict";
+
+  w.picturefill = function(parent) {
+    // Copy attributes from the source to the destination.
+    function _copyAttributes(src, tar) {
+      if (src.getAttribute('data-width') && src.getAttribute('data-height')) {
+        tar.width = src.getAttribute('data-width');
+        tar.height = src.getAttribute('data-height');
+      }
+      else {
+        tar.removeAttribute('width');
+        tar.removeAttribute('height');
+      }
+    }
+
+    // Get all picture tags.
+    if (!parent || !parent.getElementsByTagName) {
+      parent = w.document;
+    }
+    var ps = parent.getElementsByTagName('span');
+
+    // Loop the pictures.
+    for (var i = 0, il = ps.length; i < il; i++ ) {
+      if (ps[i].getAttribute('data-picture') !== null) {
+        var sources = ps[i].getElementsByTagName('span');
+        var picImg = null;
+        var matches = [];
+
+        // See which sources match.
+        for (var j = 0, jl = sources.length; j < jl; j++ ) {
+          var media = sources[j].getAttribute('data-media');
+
+          // If there's no media specified or the media query matches, add it.
+          if (!media || (w.matchMedia && w.matchMedia(media).matches)) {
+            matches.push(sources[j]);
+          }
+        }
+
+        if (matches.length) {
+          // Grab the most appropriate (last) match.
+          var match = matches.pop();
+
+          // Find any existing img element in the picture element.
+          picImg = ps[i].getElementsByTagName('img')[0];
+
+          // Add a new img element if one doesn't exists.
+          if (!picImg) {
+            picImg = w.document.createElement('img');
+            picImg.alt = ps[i].getAttribute('data-alt') || '';
+            picImg.title = ps[i].getAttribute('data-title') || '';
+            ps[i].appendChild(picImg);
+          }
+
+          // Set the source if it's different.
+          if (picImg.getAttribute('src') !== match.getAttribute('data-src')) {
+            picImg.src = match.getAttribute('data-src');
+            _copyAttributes(match, picImg);
+          }
+        }
+      }
+    }
+  };
+
+  // Run on resize and domready (w.load as a fallback)
+  if (w.addEventListener) {
+    w.addEventListener('resize', w.picturefill, false);
+    w.addEventListener('DOMContentLoaded', function() {
+      w.picturefill();
+      // Run once only.
+      w.removeEventListener('load', w.picturefill, false);
+    }, false);
+    w.addEventListener('load', w.picturefill, false);
+  }
+  else if (w.attachEvent) {
+    w.attachEvent('onload', w.picturefill);
+  }
+})(this);
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/picture/plugins/plugin.js b/profiles/commons/modules/contrib/picture/plugins/plugin.js
new file mode 100644
index 0000000..2113320
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/plugins/plugin.js
@@ -0,0 +1,179 @@
+/**
+ * @file Plugin to support responsive images with the Picture module and 
+ * the CKEditor module.
+ */
+( function(){
+  CKEDITOR.plugins.add('picture_ckeditor',
+  {
+      init : function(editor)
+      {
+                
+          // This disables the browser resize handles since the width will now be set
+          // in the image dialog. This also prevents CKEditor from automatically adding
+          // pesky inline width and height styles, although these inline styles are
+          // still added when an image is dragged and dropped.
+          // Resize handles are also removed from tables as an unintended consequence.
+        CKEDITOR.config.disableObjectResizing = true; 
+
+
+        // When opening a dialog, a 'definition' is created for it. For
+        // each editor instance the 'dialogDefinition' event is then
+        // fired. We can use this event to make customizations to the
+        // definition of existing dialogs.
+        CKEDITOR.on('dialogDefinition', function(event) {
+          // Take the dialog name.
+          if ((event.editor != editor)) return;
+          var dialogName = event.data.name;
+          // The definition holds the structured data that is used to eventually
+          // build the dialog and we can use it to customize just about anything.
+          // In Drupal terms, it's sort of like CKEditor's version of a Forms API and
+          // what we're doing here is a bit like a hook_form_alter.
+          var dialogDefinition = event.data.definition;
+
+
+          // Resources for the following:
+          // Download: https://github.com/ckeditor/ckeditor-dev
+          // See /plugins/image/dialogs/image.js
+          // and refer to http://docs.ckeditor.com/#!/api/CKEDITOR.dialog.definition
+          // Visit: file:///[path_to_ckeditor-dev]/plugins/devtools/samples/devtools.html
+          // for an excellent way to find machine names for dialog elements.
+          if (dialogName == 'image') {
+            dialogDefinition.removeContents('Link');
+            var infoTab = dialogDefinition.getContents('info');
+            var altText = infoTab.get('txtAlt');
+            var IMAGE = 1,
+                LINK = 2,
+                PREVIEW = 4,
+                CLEANUP = 8;
+            // UpdatePreview is copied from ckeditor image plugin.
+            var updatePreview = function(dialog) {
+              // Don't load before onShow.
+              if (!dialog.originalElement || !dialog.preview) {
+                return 1;
+              }
+
+              // Read attributes and update imagePreview.
+              dialog.commitContent(PREVIEW, dialog.preview);
+              return 0;
+            };
+            // Add the select list for choosing the image width.
+            infoTab.add({
+              type: 'select',
+              id: 'imageSize',
+              label: Drupal.settings.picture.label,
+              items: Drupal.settings.picture.groups,
+              'default': 'not_set',
+              onChange: function() {
+                var dialog = this.getDialog();
+                var element = dialog.originalElement;
+                element.setAttribute('data-picture-group', this.getValue());
+                updatePreview(this.getDialog());
+              },
+              setup: function(type, element) {
+                if (type == IMAGE) {
+                  var value = element.getAttribute('data-picture-group');
+                  this.setValue(value);
+                }
+              },
+              // Create a custom data-picture-group attribute.
+              commit: function(type, element) {
+                if (type == IMAGE) {
+                  if (this.getValue() || this.isChanged()) {
+                    element.setAttribute('data-picture-group', this.getValue());
+                  }
+                } else if (type == PREVIEW) {
+                  element.setAttribute('data-picture-group', this.getValue());
+                } else if (type == CLEANUP) {
+                  element.setAttribute('data-picture-group', '');
+                }
+              },
+              validate: function() {
+                if (this.getValue() == 'not_set') {
+                  var message = 'Please make a selection from ' + Drupal.settings.picture.label;
+                  alert(message);
+                  return false;
+                } else {
+                  return true;
+                }
+              }
+            },
+              // Position before preview.
+              'htmlPreview'
+            );
+
+            // Put a title attribute field on the main 'info' tab.
+            infoTab.add( {
+              type: 'text',
+              id: 'txtTitle',
+              label: 'The title attribute is used as a tooltip when the mouse hovers over the image.',
+              onChange: function() {
+                updatePreview(this.getDialog());
+              },
+              setup: function(type, element) {
+                if (type == IMAGE)
+                  this.setValue(element.getAttribute('title'));
+              },
+              commit: function(type, element) {
+                if (type == IMAGE) {
+                  if (this.getValue() || this.isChanged())
+                    element.setAttribute('title', this.getValue());
+                } else if (type == PREVIEW) {
+                  element.setAttribute('title', this.getValue());
+                } else if (type == CLEANUP) {
+                  element.removeAttribute('title');
+                }
+              }
+            },
+              // Position before the imageSize select box.
+              'htmlPreview'
+            );
+
+            // Add a select widget to choose image alignment.
+            infoTab.add({
+              type: 'select',
+              id: 'imageAlign',
+              label: 'Image Alignment',
+              items: [ [ 'Not Set', '' ], [ 'Left', 'left'],
+                       [ 'Right', 'right' ], [ 'Center', 'center'] ],
+              'default': '',
+              onChange: function() {
+                updatePreview(this.getDialog());
+              },
+              setup: function(type, element) {
+                if (type == IMAGE) {
+                  var value = element.getAttribute('data-picture-align');
+                  this.setValue(value);
+                }
+              },
+              // Creates a custom data-picture-align attribute since working with classes
+              // is more difficult. If we used classes, then we'd have to search for
+              // exisiting alignment classes and remove them before adding a new one.
+              // With the custom attribute we can always just overwrite it's value.
+              commit: function(type, element) {
+                if (type == IMAGE) {
+                  if (this.getValue() || this.isChanged()) {
+                    element.setAttribute('data-picture-align', this.getValue());
+                  }
+                } else if (type == PREVIEW) {
+                  element.setAttribute('data-picture-align', this.getValue());
+                } else if (type == CLEANUP) {
+                  element.setAttribute('data-picture-align', '');
+                }
+              }
+
+            },
+              // Position before imageSize.
+              'imageSize'
+            );
+
+            // Improve the alt field label. Copied from Drupal's image field.
+            altText.label = 'The alt attribute may be used by search engines, and screen readers.';
+
+            // Remove a bunch of extraneous fields. These properties will be set in
+            // the theme or module CSS.
+            infoTab.remove('basic');
+          }
+        });
+      }
+  });
+})();
diff --git a/profiles/commons/modules/contrib/picture/weblinc/media.css b/profiles/commons/modules/contrib/picture/weblinc/media.css
new file mode 100644
index 0000000..4a5a0ad
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/weblinc/media.css
@@ -0,0 +1,21 @@
+/* Used with Media - Testing css media queries in Javascript. Authors & copyright (c) 2012: WebLinc, David Knight, Zac Owen. */
+/* NOTE: This file is used to determine media query support and get media type. Include this with your base style sheet or link to this external file. */
+/*
+    z-index : Access Media _typeList array as index.
+    width   : Used to retrieve dpi for non-IE broswers. IE supports screen.DPIX.
+    height  : Used to test media query support. IE <9 handle media type but not query expression.
+*/
+head                { position: relative; z-index: 0; width: 1in; height: 0px; }
+@media screen       { head { z-index: 1; } }
+@media print        { head { z-index: 2; } }
+@media speech       { head { z-index: 3; } }
+@media projection   { head { z-index: 4; } }
+@media handheld     { head { z-index: 5; } }
+@media tv           { head { z-index: 6; } }
+@media braille      { head { z-index: 7; } }
+@media embossed     { head { z-index: 8; } }
+@media tty          { head { z-index: 9; } }
+/*
+    Test media query support.
+*/
+@media screen and (height) { head { height: 1px; } }
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/picture/weblinc/media.extension.js b/profiles/commons/modules/contrib/picture/weblinc/media.extension.js
new file mode 100644
index 0000000..a6e3a18
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/weblinc/media.extension.js
@@ -0,0 +1,7 @@
+/* Extension to Media - Adds new media features. Authors & copyright (c) 2012: WebLinc, David Knight. */
+
+// Added device-pixel-ratio even though it's covered by resolution #dppx
+window.Media.features["device-pixel-ratio"]  = window.Media.resolution;
+
+// Modernizr.touch
+window.Media.features["touch-enabled"]  = Number(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch || 0);
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/picture/weblinc/media.js b/profiles/commons/modules/contrib/picture/weblinc/media.js
new file mode 100644
index 0000000..ee8fcb5
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/weblinc/media.js
@@ -0,0 +1,256 @@
+/* Media - Testing css media queries in Javascript. Authors & copyright (c) 2012: WebLinc, David Knight, Zac Owen. */
+
+// Media
+(function(win) {
+    'use strict';
+
+    // Internal globals
+    var _doc            = win.document,
+        _mediaInfo      = _doc.getElementsByTagName('head')[0],
+        _mediaInfoStyle = (win.getComputedStyle && win.getComputedStyle(_mediaInfo, null)) || _mediaInfo.currentStyle,
+        _deviceWidth    = screen.width,
+        _deviceHeight   = screen.height,
+        _color          = screen.colorDepth,
+        _viewport       = _doc.documentElement,
+        _typeList       = 'screen, print, speech, projection, handheld, tv, braille, embossed, tty',
+        _mediaExpr      = /\(\s*(not)?\s*(min|max)?-?([^:\s]+)\s*:\s*([^\s]+)\s*\)/,
+        _typeExpr       = /(not)?\s*(\w*)/,
+        _mqlID          = 0,
+        _timer          = 0;
+
+    // Helper methods
+
+    /*
+        MediaQueryList
+        A list of parsed media queries, ex. screen and (max-width: 400px), screen and (max-width: 800px)
+    */
+    function MediaQueryList(media) {
+        var id = _mqlID,
+            mql = {
+                matches         : Media.parseMatch(media, false),
+                media           : media,
+                addListener     : function addListener(listener) {
+                    Media.queries[id].listeners || (Media.queries[id].listeners = []);
+                    listener && Media.queries[id].listeners.push(listener);
+                },
+                removeListener  : function removeListener(listener) {
+                    var query = Media.queries[id];
+
+                    if (!query) {
+                        return;
+                    }
+
+                    for (var i = 0, il = query.listeners.length; i < il; i++) {
+                        if (query.listeners[i] === listener) {
+                            query.listeners.splice(i, 1);
+                        }
+                    }
+                }
+            };
+
+        _mqlID++;
+
+        Media.queries.push({
+            mql: mql,
+            listeners: null
+        });
+
+        return mql;
+    };
+
+    win.Media = {
+        // Properties
+        supported   : false,
+        type        : 'all',
+        queries     : [],
+        features    : {
+            "width"                 : 0, // Update on resize
+            "height"                : 0, // Update on resize
+            "aspect-ratio"          : 0, // Update on resize
+            "color"                 : _color,
+            "color-index"           : Math.pow(2, _color),
+            "device-aspect-ratio"   : (_deviceWidth / _deviceHeight).toFixed(2),
+            "device-width"          : _deviceWidth,
+            "device-height"         : _deviceHeight,
+            "orientation"           : "landscape", // Update on resize/orientation change
+            "resolution"            : 96
+        },
+
+        // Methods
+
+        /*
+            getAbsValue
+         */
+        getAbsValue: function(data) {
+            var match;
+
+            // Convert length unit to pixels
+            if ((match = data.match(/([\d\.]+)(px|em|rem|%|in|cm|mm|ex|pt|pc)/))) {
+                if (match[2] == 'em') {
+                    // Assumed base font size is 16px
+                    return 16 * match[1];
+                }
+
+                if (match[2] == 'pt') {
+                    return (this.features.resolution / 72) * match[1];
+                }
+
+                return match[1] * 1;
+            }
+
+            // Convert aspect ratio to decimals
+            if ((match = data.match(/(\d+)[\/:](\d+)/))) {
+                return (match[1] / match[2]).toFixed(2);
+            }
+
+            // Convert resolution unit to pixels
+            if ((match = data.match(/([\d]+)(dpi|dppx|dpcm)/))) {
+                if (match[2] == 'dpcm') {
+                    return match[1] * 0.3937;
+                }
+
+                if (match[2] == 'dppx') {
+                    return match[1] * 96;
+                }
+
+                return match[1] * 1;
+            }
+
+            return data;
+        },
+
+        /*
+            parseMatch
+         */
+        parseMatch: function(media, matched) {
+            var mql         = typeof media === 'string' ? media.split(', ') : media,
+                mq          = mql.pop(),
+                negate      = mq.indexOf('not ') !== -1,
+                mt          = 'all',
+                exprList    = mq.split(' and '),
+                exprl       = exprList.length - 1,
+                match       = !negate;
+
+            do {
+                var expr        = null,
+                    exprMatch   = true,
+                    type        = null,
+                    typeMatch   = true;
+
+                // Test for 'not screen' and (max-width: 400px).
+                // Evaluate each expr, then call parseMatch() if there are more media queries or return value of negate.
+                if (exprList[exprl].indexOf('(') === -1 || (expr = exprList[exprl].match(_mediaExpr))) {
+
+                    if (expr) {
+                        var feature     = this.features[expr[3]],
+                            absValue    = this.getAbsValue(expr[4]);
+
+                        if (expr[2] === 'min') {
+                            exprMatch = feature >= absValue;
+                        } else if (expr[2] === 'max') {
+                            exprMatch = feature <= absValue;
+                        } else if (expr[4] !== 'undefined') {
+                            exprMatch = feature === absValue;
+                        } else {
+                            exprMatch = feature;
+                        }
+                    } else {
+                        type        = exprList[exprl].match(_typeExpr) || ['', 'all'];
+                        mt          = type[2];
+                        typeMatch   = mt === this.type || mt === 'all';
+
+                        matched && negate && mt !== 'all' && (mt = _typeList.split(mt).join(', ').replace(/(,\s){2}/, ''));
+                    }
+
+                    if (
+                        //(expr && ((negate && exprMatch) || (!negate && !exprMatch))) || 
+                        //(!expr && ((negate && typeMatch) || (!negate && !typeMatch)))
+                        ((expr && !exprMatch) || (!expr && !typeMatch))
+                    ) {
+                        return (mql.length ? this.parseMatch(mql, matched) : negate);
+                    }
+                }
+            } while(exprl--);
+
+            return (matched && match && {matches: match, type: mt, media: mq}) || match;
+        },
+
+        /*
+            match
+         */
+        match: MediaQueryList,
+
+        /*
+            watch
+         */
+        watch: function(evt) {
+            clearTimeout(_timer);
+
+            _timer = setTimeout(function() {
+                var id = _mqlID;
+
+                Media.setMutableFeatures();
+
+                do {
+                    var query = Media.queries[id],
+                        match = false;
+
+                    if (typeof query === 'undefined') { continue; }
+
+                    match = Media.parseMatch(query.mql.media);
+
+                    if ((match && !query.mql.matches) || (!match && query.mql.matches)) {
+                        query.mql.matches = match;
+
+                        if (query.listeners) {
+                            for (var i = 0, il = query.listeners.length; i < il; i++) {
+                                if (query.listeners[i]) {
+                                    query.listeners[i].call(win, query.mql, evt);
+                                }
+                            }
+                        }
+                    }
+                } while(id--);
+            }, 10);
+        },
+
+        /*
+            Sets properties of Media that change on resize and/or orientation.
+        */
+        setMutableFeatures: function() {
+            var w = win.innerWidth || _viewport.clientWidth,
+                h = win.innerHeight || _viewport.clientHeight;
+
+            this.features.width            = w;
+            this.features.height           = h;
+            this.features['aspect-ratio']  = (w / h).toFixed(2);
+            this.features.orientation      = (h >= w ? 'portrait' : 'landscape');
+        },
+
+        listen: function(listener) {
+            if (win.addEventListener) {
+                win.addEventListener('resize', listener);
+                win.addEventListener('orientationchange', listener);
+            } else if (win.attachEvent) {
+                win.attachEvent('onresize', listener);
+                win.attachEvent('onorientationchange', listener);
+            }
+        },
+
+        init: function() {
+            var x           = win.devicePixelRatio;
+
+            this.supported  = parseFloat(_mediaInfoStyle.height) === 1;
+            this.type       = _typeList.split(', ')[parseFloat(_mediaInfoStyle.zIndex) - 1] || 'all'; 
+
+            this.features.resolution = (x && x * 96) || screen.deviceXDPI || parseFloat(_mediaInfoStyle.width);
+
+            this.setMutableFeatures();
+            this.listen(this.watch);
+        }
+    };
+
+    win.Media.init();
+
+    window.matchMedia || (window.matchMedia = Media.match);
+})(window);
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/picture/weblinc/picture.js b/profiles/commons/modules/contrib/picture/weblinc/picture.js
new file mode 100644
index 0000000..75e3f7f
--- /dev/null
+++ b/profiles/commons/modules/contrib/picture/weblinc/picture.js
@@ -0,0 +1,195 @@
+/* Picture - Picture element polyfill for responsive images. Authors & copyright (c) 2012: WebLinc, David Knight. */
+/* NOTE: Depends on Media object. See https://github.com/weblinc/media-match */
+
+// Picture
+(function(win) {
+    'use strict';
+
+    var _doc        = win.document,
+        _picl       = 0,
+        _ratioExpr  = /\s+[\d\.]+x\s*,?/g,
+        _srcExpr    = /[^\s]+/g,
+        _res        = win.Media.features.resolution,
+        _timer      = 0;
+
+    /*
+        parseSrcSet
+    */
+    function parseSrcSet(src, precise) {
+        var ratios  = src.match(_ratioExpr) || [],
+            ratiol  = ratios.length,
+            srcList = src.replace(_ratioExpr, ' ').match(_srcExpr);
+
+        while (ratiol--) {
+            var dppx = parseFloat(ratios[ratiol]) * 96;
+
+            if (_res === dppx || (precise === false && Math.floor(_res / 96) === Math.floor(dppx / 96))) {
+                return srcList[ratiol];
+            }
+        }
+
+        if (typeof precise === 'undefined') {
+            return parseSrcSet(src, false);
+        }
+
+        return null;
+    }
+
+    win.Picture = {
+        // Properties
+        pictures: [],
+
+        // Methods
+
+        /*
+            parse
+        */
+        parse: function() {
+            win.Picture.pictures = [];
+
+            var pics    = _doc.getElementsByTagName('span'),
+                picl    = pics.length,
+                pic     = null;
+
+            while (picl-- && (pic = pics[picl])) {
+                if (pic.getAttribute('data-picture') === null) {
+                    continue;
+                }
+
+                var srcs        = pic.getElementsByTagName('span'),
+                    srcl        = srcs.length,
+                    src         = null,
+                    mql         = '',
+                    srcList     = {},
+                    mediaAttr   = '',
+                    srcAttr     = '',
+                    srcDef      = '',
+                    width       = '',
+                    height      = '';
+
+                while (srcl-- && (src = srcs[srcl])) {
+                    mediaAttr   = src.getAttribute('data-media');
+                    srcAttr     = src.getAttribute('data-src') || parseSrcSet(src.getAttribute('data-srcset') || '');
+
+                    width       = src.getAttribute('data-width') || '';
+                    height      = src.getAttribute('data-height') || '';
+
+                    if (mediaAttr && srcAttr) {
+                        srcList[mediaAttr] = {
+                            uri: srcAttr,
+                            width: width,
+                            height: height
+                        };
+                        mql += (mql.length ? ', ' : '') + mediaAttr;
+                    } else if (srcAttr) {
+                        srcDef = {
+                            uri: srcAttr,
+                            width: width,
+                            height: height
+                        };
+                    }
+                }
+
+                Picture.pictures.push({
+                    element     : pic,
+                    media       : mql,
+                    src         : srcList,
+                    srcDefault  : srcDef,
+                    matches     : false
+                });
+
+                _picl++;
+            }
+        },
+
+        /*
+            watch
+        */
+        watch: function(evt) {
+            clearTimeout(_timer);
+
+            _timer = setTimeout(function() {
+                var id = _picl;
+
+                do {
+                    var pic     = win.Picture.pictures[id],
+                        imgs    = [],
+                        img     = null,
+                        hasImg  = false,
+                        src     = '',
+                        width   = '',
+                        height  = '',
+                        prev    = null,
+                        match   = false;
+
+                    if (typeof pic === 'undefined') { continue; }
+
+                    match = win.Media.parseMatch(pic.media, true);
+
+                    if (match && !(pic.matches === match.media) || !match && pic.srcDefault.uri) {
+                        pic.matches = (match && match.media) || match;
+
+                        imgs = pic.element.getElementsByTagName('img');
+
+                        if (match.media && pic.src[match.media].uri) {
+                            src     = (match.media && pic.src[match.media].uri);
+                            width   = pic.src[match.media].width;
+                            height  = pic.src[match.media].height;
+                        } else {
+                            src     = pic.srcDefault.uri;
+                            width   = pic.srcDefault.width;
+                            height  = pic.srcDefault.height;
+                        }
+
+                        if (src) {
+                            for (var i = 0, il = imgs.length; i < il; i++) {
+                                img = imgs[i];
+                                if (img.getAttribute('src') === src) {
+                                    img.className = 'match';
+                                    hasImg = true;
+                                } else if (img.className !== 'unmatch') {
+                                    img.className = 'unmatch';
+                                }
+                            }
+
+                            if (!hasImg) {
+                                img             = document.createElement('img');
+                                img.alt         = pic.element.getAttribute('data-title') || 'picture';
+                                if (width) {
+                                    img.width = width;
+                                }
+                                if (height) {
+                                    img.height = height;
+                                }
+                                img.className   = 'match';
+
+                                pic.element.appendChild(img);
+
+                                img.src = src;
+                            }
+                        }
+                    } else if (!match) {
+                        pic.matches = false;
+                    }
+
+                } while(id--);
+            }, 10);
+        },
+
+        /*
+            init
+        */
+        init: function() {
+            win.Picture.parse();
+            win.Picture.watch();
+
+            win.Media.listen(win.Picture.watch);
+        }
+    };
+
+    if (win.addEventListener) {
+        win.addEventListener('load', win.Picture.init);
+    } else {
+        win.attachEvent('onload', win.Picture.init);
+    }
+})(window);
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info b/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
index 30a0791..0751b24 100644
--- a/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
+++ b/profiles/commons/modules/contrib/radioactivity/features/radioactivitydefaults/radioactivitydefaults.info
@@ -12,9 +12,9 @@ features[radioactivity_decay_profile][] = default_now
 features[radioactivity_decay_profile][] = default_weekly
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.8+1-dev"
 core = "7.x"
 project = "radioactivity"
-datestamp = "1389381826"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/radioactivity/radioactivity.info b/profiles/commons/modules/contrib/radioactivity/radioactivity.info
index 23f83f9..9237912 100644
--- a/profiles/commons/modules/contrib/radioactivity/radioactivity.info
+++ b/profiles/commons/modules/contrib/radioactivity/radioactivity.info
@@ -13,9 +13,9 @@ files[] = includes/RadioactivityMemcachedIncidentStorage.inc
 files[] = includes/RadioactivityIncident.inc
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.8+1-dev"
 core = "7.x"
 project = "radioactivity"
-datestamp = "1389381826"
+datestamp = "1389902326"
 
diff --git a/profiles/commons/modules/contrib/smartcrop/LICENSE.txt b/profiles/commons/modules/contrib/smartcrop/LICENSE.txt
new file mode 100644
index 0000000..2c095c8
--- /dev/null
+++ b/profiles/commons/modules/contrib/smartcrop/LICENSE.txt
@@ -0,0 +1,274 @@
+GNU GENERAL PUBLIC LICENSE
+
+              Version 2, June 1991
+
+Copyright (C) 1989, 1991 Free Software Foundation, Inc. 675 Mass Ave,
+Cambridge, MA 02139, USA. Everyone is permitted to copy and distribute
+verbatim copies of this license document, but changing it is not allowed.
+
+                  Preamble
+
+The licenses for most software are designed to take away your freedom to
+share and change it. By contrast, the GNU General Public License is
+intended to guarantee your freedom to share and change free software--to
+make sure the software is free for all its users. This General Public License
+applies to most of the Free Software Foundation's software and to any other
+program whose authors commit to using it. (Some other Free Software
+Foundation software is covered by the GNU Library General Public License
+instead.) You can apply it to your programs, too.
+
+When we speak of free software, we are referring to freedom, not price. Our
+General Public Licenses are designed to make sure that you have the
+freedom to distribute copies of free software (and charge for this service if
+you wish), that you receive source code or can get it if you want it, that you
+can change the software or use pieces of it in new free programs; and that
+you know you can do these things.
+
+To protect your rights, we need to make restrictions that forbid anyone to
+deny you these rights or to ask you to surrender the rights. These restrictions
+translate to certain responsibilities for you if you distribute copies of the
+software, or if you modify it.
+
+For example, if you distribute copies of such a program, whether gratis or for
+a fee, you must give the recipients all the rights that you have. You must make
+sure that they, too, receive or can get the source code. And you must show
+them these terms so they know their rights.
+
+We protect your rights with two steps: (1) copyright the software, and (2)
+offer you this license which gives you legal permission to copy, distribute
+and/or modify the software.
+
+Also, for each author's protection and ours, we want to make certain that
+everyone understands that there is no warranty for this free software. If the
+software is modified by someone else and passed on, we want its recipients
+to know that what they have is not the original, so that any problems
+introduced by others will not reflect on the original authors' reputations.
+
+Finally, any free program is threatened constantly by software patents. We
+wish to avoid the danger that redistributors of a free program will individually
+obtain patent licenses, in effect making the program proprietary. To prevent
+this, we have made it clear that any patent must be licensed for everyone's
+free use or not licensed at all.
+
+The precise terms and conditions for copying, distribution and modification
+follow.
+
+           GNU GENERAL PUBLIC LICENSE
+ TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND
+               MODIFICATION
+
+0. This License applies to any program or other work which contains a notice
+placed by the copyright holder saying it may be distributed under the terms
+of this General Public License. The "Program", below, refers to any such
+program or work, and a "work based on the Program" means either the
+Program or any derivative work under copyright law: that is to say, a work
+containing the Program or a portion of it, either verbatim or with
+modifications and/or translated into another language. (Hereinafter, translation
+is included without limitation in the term "modification".) Each licensee is
+addressed as "you".
+
+Activities other than copying, distribution and modification are not covered
+by this License; they are outside its scope. The act of running the Program is
+not restricted, and the output from the Program is covered only if its contents
+constitute a work based on the Program (independent of having been made
+by running the Program). Whether that is true depends on what the Program
+does.
+
+1. You may copy and distribute verbatim copies of the Program's source
+code as you receive it, in any medium, provided that you conspicuously and
+appropriately publish on each copy an appropriate copyright notice and
+disclaimer of warranty; keep intact all the notices that refer to this License
+and to the absence of any warranty; and give any other recipients of the
+Program a copy of this License along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and you
+may at your option offer warranty protection in exchange for a fee.
+
+2. You may modify your copy or copies of the Program or any portion of it,
+thus forming a work based on the Program, and copy and distribute such
+modifications or work under the terms of Section 1 above, provided that you
+also meet all of these conditions:
+
+a) You must cause the modified files to carry prominent notices stating that
+you changed the files and the date of any change.
+
+b) You must cause any work that you distribute or publish, that in whole or in
+part contains or is derived from the Program or any part thereof, to be
+licensed as a whole at no charge to all third parties under the terms of this
+License.
+
+c) If the modified program normally reads commands interactively when run,
+you must cause it, when started running for such interactive use in the most
+ordinary way, to print or display an announcement including an appropriate
+copyright notice and a notice that there is no warranty (or else, saying that
+you provide a warranty) and that users may redistribute the program under
+these conditions, and telling the user how to view a copy of this License.
+(Exception: if the Program itself is interactive but does not normally print such
+an announcement, your work based on the Program is not required to print
+an announcement.)
+
+These requirements apply to the modified work as a whole. If identifiable
+sections of that work are not derived from the Program, and can be
+reasonably considered independent and separate works in themselves, then
+this License, and its terms, do not apply to those sections when you distribute
+them as separate works. But when you distribute the same sections as part
+of a whole which is a work based on the Program, the distribution of the
+whole must be on the terms of this License, whose permissions for other
+licensees extend to the entire whole, and thus to each and every part
+regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest your rights to
+work written entirely by you; rather, the intent is to exercise the right to
+control the distribution of derivative or collective works based on the
+Program.
+
+In addition, mere aggregation of another work not based on the Program
+with the Program (or with a work based on the Program) on a volume of a
+storage or distribution medium does not bring the other work under the scope
+of this License.
+
+3. You may copy and distribute the Program (or a work based on it, under
+Section 2) in object code or executable form under the terms of Sections 1
+and 2 above provided that you also do one of the following:
+
+a) Accompany it with the complete corresponding machine-readable source
+code, which must be distributed under the terms of Sections 1 and 2 above
+on a medium customarily used for software interchange; or,
+
+b) Accompany it with a written offer, valid for at least three years, to give
+any third party, for a charge no more than your cost of physically performing
+source distribution, a complete machine-readable copy of the corresponding
+source code, to be distributed under the terms of Sections 1 and 2 above on
+a medium customarily used for software interchange; or,
+
+c) Accompany it with the information you received as to the offer to distribute
+corresponding source code. (This alternative is allowed only for
+noncommercial distribution and only if you received the program in object
+code or executable form with such an offer, in accord with Subsection b
+above.)
+
+The source code for a work means the preferred form of the work for
+making modifications to it. For an executable work, complete source code
+means all the source code for all modules it contains, plus any associated
+interface definition files, plus the scripts used to control compilation and
+installation of the executable. However, as a special exception, the source
+code distributed need not include anything that is normally distributed (in
+either source or binary form) with the major components (compiler, kernel,
+and so on) of the operating system on which the executable runs, unless that
+component itself accompanies the executable.
+
+If distribution of executable or object code is made by offering access to
+copy from a designated place, then offering equivalent access to copy the
+source code from the same place counts as distribution of the source code,
+even though third parties are not compelled to copy the source along with the
+object code.
+
+4. You may not copy, modify, sublicense, or distribute the Program except as
+expressly provided under this License. Any attempt otherwise to copy,
+modify, sublicense or distribute the Program is void, and will automatically
+terminate your rights under this License. However, parties who have received
+copies, or rights, from you under this License will not have their licenses
+terminated so long as such parties remain in full compliance.
+
+5. You are not required to accept this License, since you have not signed it.
+However, nothing else grants you permission to modify or distribute the
+Program or its derivative works. These actions are prohibited by law if you
+do not accept this License. Therefore, by modifying or distributing the
+Program (or any work based on the Program), you indicate your acceptance
+of this License to do so, and all its terms and conditions for copying,
+distributing or modifying the Program or works based on it.
+
+6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the original
+licensor to copy, distribute or modify the Program subject to these terms and
+conditions. You may not impose any further restrictions on the recipients'
+exercise of the rights granted herein. You are not responsible for enforcing
+compliance by third parties to this License.
+
+7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues), conditions
+are imposed on you (whether by court order, agreement or otherwise) that
+contradict the conditions of this License, they do not excuse you from the
+conditions of this License. If you cannot distribute so as to satisfy
+simultaneously your obligations under this License and any other pertinent
+obligations, then as a consequence you may not distribute the Program at all.
+For example, if a patent license would not permit royalty-free redistribution
+of the Program by all those who receive copies directly or indirectly through
+you, then the only way you could satisfy both it and this License would be to
+refrain entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under any
+particular circumstance, the balance of the section is intended to apply and
+the section as a whole is intended to apply in other circumstances.
+
+It is not the purpose of this section to induce you to infringe any patents or
+other property right claims or to contest validity of any such claims; this
+section has the sole purpose of protecting the integrity of the free software
+distribution system, which is implemented by public license practices. Many
+people have made generous contributions to the wide range of software
+distributed through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing to
+distribute software through any other system and a licensee cannot impose
+that choice.
+
+This section is intended to make thoroughly clear what is believed to be a
+consequence of the rest of this License.
+
+8. If the distribution and/or use of the Program is restricted in certain
+countries either by patents or by copyrighted interfaces, the original copyright
+holder who places the Program under this License may add an explicit
+geographical distribution limitation excluding those countries, so that
+distribution is permitted only in or among countries not thus excluded. In such
+case, this License incorporates the limitation as if written in the body of this
+License.
+
+9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time. Such new versions will be
+similar in spirit to the present version, but may differ in detail to address new
+problems or concerns.
+
+Each version is given a distinguishing version number. If the Program specifies
+a version number of this License which applies to it and "any later version",
+you have the option of following the terms and conditions either of that
+version or of any later version published by the Free Software Foundation. If
+the Program does not specify a version number of this License, you may
+choose any version ever published by the Free Software Foundation.
+
+10. If you wish to incorporate parts of the Program into other free programs
+whose distribution conditions are different, write to the author to ask for
+permission. For software which is copyrighted by the Free Software
+Foundation, write to the Free Software Foundation; we sometimes make
+exceptions for this. Our decision will be guided by the two goals of
+preserving the free status of all derivatives of our free software and of
+promoting the sharing and reuse of software generally.
+
+               NO WARRANTY
+
+11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE,
+THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT
+PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE
+STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR
+OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT
+WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED,
+INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND
+PERFORMANCE OF THE PROGRAM IS WITH YOU. SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL
+NECESSARY SERVICING, REPAIR OR CORRECTION.
+
+12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR
+AGREED TO IN WRITING WILL ANY COPYRIGHT HOLDER, OR
+ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE
+LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL,
+SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES
+ARISING OUT OF THE USE OR INABILITY TO USE THE
+PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF DATA
+OR DATA BEING RENDERED INACCURATE OR LOSSES
+SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE
+PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS), EVEN
+IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF
+THE POSSIBILITY OF SUCH DAMAGES.
+
+          END OF TERMS AND CONDITIONS
diff --git a/profiles/commons/modules/contrib/smartcrop/image.gd.inc b/profiles/commons/modules/contrib/smartcrop/image.gd.inc
new file mode 100644
index 0000000..ec15a48
--- /dev/null
+++ b/profiles/commons/modules/contrib/smartcrop/image.gd.inc
@@ -0,0 +1,163 @@
+<?php
+// $Id: image.gd.inc,v 1.1.2.4 2010/12/07 19:35:18 grendzy Exp $
+
+/**
+ * @file
+ * libgd implementation of smartcrop action.
+ *
+ * Cropping algorithm is derived from http://code.google.com/p/sorl-thumbnail/
+ * by Mikko Hellsing, Chris Beaven.
+ * Adapted to ImageCache and GD by Dylan Tack (grendzy).
+ */
+
+/**
+ * Scale and crop an image to the specified size using GD.
+ *
+ * @param $image_data An image object.
+ * @param $requested_x The requested image width.
+ * @param $requested_y The requested image height.
+ * @param $upscale TRUE if upscaling is allowed.
+ * @return TRUE if successful.
+ */
+function image_gd_smartcrop_scale(stdClass $image_data, $requested_x, $requested_y, $upscale) {
+  $ratio = max($requested_x / $image_data->info['width'], $requested_y / $image_data->info['height']);
+  if ($ratio <= 1 || $upscale) {
+    if (!image_gd_resize($image_data, round($ratio * $image_data->info['width']), round($ratio * $image_data->info['height']))) {
+      return FALSE;
+    }
+  }
+  return image_gd_smartcrop_crop($image_data, $requested_x, $requested_y);
+}
+
+/**
+ * Crop an image, removing the lowest entropy areas.
+ *
+ * @param array $image_data
+ * @param int $requested_x
+ * @param int $requested_y
+ * @return booleon TRUE if successful
+ */
+function image_gd_smartcrop_crop(stdClass $image_data, $requested_x, $requested_y) {
+  $image = $image_data->resource;
+  $dx = imagesx($image) - min(imagesx($image), $requested_x);
+  $dy = imagesy($image) - min(imagesy($image), $requested_y);
+  $left = $top = 0;
+  $left_entropy = $right_entropy = $top_entropy = $bottom_entropy = 0;
+  $right = imagesx($image);
+  $bottom = imagesy($image);
+
+  // Slice from left and right edges until the correct width is reached.
+  while ($dx) {
+    $slice = min($dx, 10);
+
+    // Calculate the entropy of the new slice.
+    if (!$left_entropy) {
+      $left_entropy = _smartcrop_gd_entropy_slice($image_data, $left, $top, $slice, imagesy($image));
+    }
+    if (!$right_entropy) {
+      $right_entropy = _smartcrop_gd_entropy_slice($image_data, $right - $slice, $top, $slice, imagesy($image));
+    }
+
+    // Remove the lowest entropy slice.
+    if ($left_entropy >= $right_entropy) {
+      $right -= $slice;
+      $right_entropy = 0;
+    }
+    else {
+      $left += $slice;
+      $left_entropy = 0;
+    }
+    $dx -= $slice;
+  }
+
+  // Slice from the top and bottom edges until the correct width is reached.
+  while ($dy) {
+    $slice = min($dy, 10);
+
+    // Calculate the entropy of the new slice.
+    if (!$top_entropy) {
+      $top_entropy = _smartcrop_gd_entropy_slice($image_data, $left, $top, $requested_x, $slice);
+    }
+    if (!$bottom_entropy) {
+      $bottom_entropy = _smartcrop_gd_entropy_slice($image_data, $left, $bottom - $slice, $requested_x, $slice);
+    }
+
+    // Remove the lowest entropy slice.
+    if ($top_entropy >= $bottom_entropy) {
+      $bottom -= $slice;
+      $bottom_entropy = 0;
+    }
+    else {
+      $top += $slice;
+      $top_entropy = 0;
+    }
+    $dy -= $slice;
+  }
+
+  // Finally, crop the image using the coordinates found above.
+  $cropped_image = image_gd_create_tmp($image_data, $right - $left, $bottom - $top);
+  imagecopy($cropped_image, $image, 0, 0, $left, $top, $right - $left, $bottom - $top);
+  imagedestroy($image_data->resource);
+  $image_data->resource = $cropped_image;
+  $image_data->info['width'] = $requested_x;
+  $image_data->info['height'] = $requested_y;
+  return TRUE;
+}
+
+/**
+ * Compute the entropy of an image slice.
+ *
+ * @param $image_data An image object
+ * @param $x Starting X coordinate.
+ * @param $y Starting Y coordinate.
+ * @param $width The width of the slice.
+ * @param $height The height of the slice.
+ * @return
+ */
+function _smartcrop_gd_entropy_slice($image_data, $x, $y, $width, $height) {
+  $slice = image_gd_create_tmp($image_data, $width, $height);
+  imagecopy($slice, $image_data->resource, 0, 0, $x, $y, $width, $height);
+  $entropy = _smartcrop_gd_entropy($slice);
+  imagedestroy($slice);
+  return $entropy;
+}
+
+/**
+ * Compute the entropy of an image, defined as -sum(p.*log2(p)).
+ * @param resource $img GD image resource.
+ * @return float The entropy of the image.
+ */
+function _smartcrop_gd_entropy($img) {
+  $histogram = _smartcrop_gd_histogram($img);
+  $histogram_size = array_sum($histogram);
+  $entropy = 0;
+  foreach ($histogram as $p) {
+    if ($p == 0) {
+      continue;
+    }
+    $p = $p / $histogram_size;
+    $entropy += $p * log($p, 2);
+  }
+  return $entropy * -1;
+}
+
+/**
+ * Compute a histogram of an image.
+ * @param resource $img GD image resource.
+ * @return array histogram as an array.
+ */
+function _smartcrop_gd_histogram($img) {
+  $histogram = array_fill(0, 768, 0);
+  for ($i = 0; $i < imagesx($img); $i++) {
+    for ($j = 0; $j < imagesy($img); $j++) {
+      $rgb = imagecolorat($img, $i, $j);
+      $r = ($rgb >> 16) & 0xFF;
+      $g = ($rgb >> 8) & 0xFF;
+      $b = $rgb & 0xFF;
+      $histogram[$r]++;
+      $histogram[$g + 256]++;
+      $histogram[$b + 512]++;
+    }
+  }
+  return $histogram;
+}
diff --git a/profiles/commons/modules/contrib/smartcrop/smartcrop.effects.inc b/profiles/commons/modules/contrib/smartcrop/smartcrop.effects.inc
new file mode 100644
index 0000000..baa65f3
--- /dev/null
+++ b/profiles/commons/modules/contrib/smartcrop/smartcrop.effects.inc
@@ -0,0 +1,86 @@
+<?php
+// $Id: smartcrop.effects.inc,v 1.1.2.3 2010/09/16 17:33:16 grendzy Exp $
+
+/**
+ * @file
+ * Functions needed to execute image effects provided by the SmartCrop module.
+ */
+
+/**
+ * Implements hook_image_effect_info().
+ */
+function smartcrop_image_effect_info() {
+  $effects = array(
+    'smartcrop_scale_and_crop' => array(
+      'label' => t('Scale and Smart Crop'),
+      'help' => t('Similar to "Scale And Crop", but preserves the portion of the image with the most entropy.'),
+      'effect callback' => 'smartcrop_scale_effect',
+      'form callback' => 'image_scale_form',
+      'summary theme' => 'image_scale_summary',
+    ),
+    'smartcrop_crop' => array(
+      'label' => t('Smart Crop'),
+      'help' => t('Similar to "Crop", but preserves the portion of the image with the most entropy.'),
+      'effect callback' => 'smartcrop_crop_effect',
+      'form callback' => 'image_resize_form',
+      'summary theme' => 'image_resize_summary',
+    ),
+  );
+  return $effects;
+}
+
+/**
+ * Image effect callback; Scale and Smart Crop an image resource.
+ *
+ * @param $image
+ *   An image object returned by image_load().
+ * @param $data
+ *   An array of attributes to use when performing the scale effect with the
+ *   following items:
+ *   - "width": An integer representing the desired width in pixels.
+ *   - "height": An integer representing the desired height in pixels.
+ *   - "upscale": A Boolean indicating that the image should be upscalled if
+ *     the dimensions are larger than the original image.
+ *
+ * @return
+ *   TRUE on success. FALSE on failure to scale image.
+ */
+function smartcrop_scale_effect(&$image, $data) {
+
+  // Set sane default values.
+  $data += array(
+    'upscale' => FALSE,
+  );
+
+  // Set impossibly large values if the width and height aren't set.
+  $data['width'] = empty($data['width']) ? PHP_INT_MAX : $data['width'];
+  $data['height'] = empty($data['height']) ? PHP_INT_MAX : $data['height'];
+
+  if (!image_toolkit_invoke('smartcrop_scale', $image, $data)) {
+    watchdog('image', 'Image scale failed using the %toolkit toolkit on %path (%mimetype, %dimensions)', array('%toolkit' => $image->toolkit, '%path' => $image->source, '%mimetype' => $image->info['mime_type'], '%dimensions' => $image->info['height'] . 'x' . $image->info['height']), WATCHDOG_ERROR);
+    return FALSE;
+  }
+  return TRUE;
+}
+
+/**
+ * Image effect callback; Smart Crop an image resource.
+ *
+ * @param $image
+ *   An image object returned by image_load().
+ * @param $data
+ *   An array of attributes to use when performing the resize effect with the
+ *   following items:
+ *   - "width": An integer representing the desired width in pixels.
+ *   - "height": An integer representing the desired height in pixels.
+ *
+ * @return
+ *   TRUE on success. FALSE on failure to resize image.
+ */
+function smartcrop_crop_effect(&$image, $data) {
+  if (!image_toolkit_invoke('smartcrop_crop', $image, $data)) {
+    watchdog('image', 'Smart crop failed using the %toolkit toolkit on %path (%mimetype, %dimensions)', array('%toolkit' => $image->toolkit, '%path' => $image->source, '%mimetype' => $image->info['mime_type'], '%dimensions' => $image->info['height'] . 'x' . $image->info['height']), WATCHDOG_ERROR);
+    return FALSE;
+  }
+  return TRUE;
+}
diff --git a/profiles/commons/modules/contrib/smartcrop/smartcrop.info b/profiles/commons/modules/contrib/smartcrop/smartcrop.info
new file mode 100644
index 0000000..dd1c3c7
--- /dev/null
+++ b/profiles/commons/modules/contrib/smartcrop/smartcrop.info
@@ -0,0 +1,19 @@
+; // $Id: smartcrop.info,v 1.1.2.1.2.4 2010/09/16 16:30:06 grendzy Exp $
+name = SmartCrop
+description = Crops low-entropy parts of the image.
+core = 7.x
+dependencies[] = image
+package = Image
+
+files[] = imageapi_gd.inc
+files[] = smartcrop.install
+files[] = smartcrop.module
+files[] = smartcrop.effects.inc
+files[] = tests/smartcrop.test
+
+; Information added by drupal.org packaging script on 2010-12-07
+version = "7.x-1.0-beta2"
+core = "7.x"
+project = "smartcrop"
+datestamp = "1291750843"
+
diff --git a/profiles/commons/modules/contrib/smartcrop/smartcrop.install b/profiles/commons/modules/contrib/smartcrop/smartcrop.install
new file mode 100644
index 0000000..6ec9bb3
--- /dev/null
+++ b/profiles/commons/modules/contrib/smartcrop/smartcrop.install
@@ -0,0 +1,23 @@
+<?php
+// $Id: smartcrop.install,v 1.1.2.1.2.2 2010/09/16 17:49:25 grendzy Exp $
+
+/**
+ * @file
+ * Install file for smartcrop module
+ */
+
+/**
+ * Implements hook_enable().
+ */
+function smartcrop_enable() {
+  cache_clear_all('image_styles', 'cache');
+  cache_clear_all('image_effects:', 'cache', TRUE);
+}
+
+/**
+ * Implements hook_disable().
+ */
+function smartcrop_disable() {
+  cache_clear_all('image_styles', 'cache');
+  cache_clear_all('image_effects:', 'cache', TRUE);
+}
diff --git a/profiles/commons/modules/contrib/smartcrop/smartcrop.module b/profiles/commons/modules/contrib/smartcrop/smartcrop.module
new file mode 100644
index 0000000..5ff91f3
--- /dev/null
+++ b/profiles/commons/modules/contrib/smartcrop/smartcrop.module
@@ -0,0 +1,5 @@
+<?php
+// $Id: smartcrop.module,v 1.1.2.5.2.5 2010/09/16 17:39:01 grendzy Exp $
+
+require_once('image.gd.inc');
+require_once('smartcrop.effects.inc');
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/bottom.png b/profiles/commons/modules/contrib/smartcrop/tests/bottom.png
new file mode 100644
index 0000000..5a0d8ce
Binary files /dev/null and b/profiles/commons/modules/contrib/smartcrop/tests/bottom.png differ
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/center.png b/profiles/commons/modules/contrib/smartcrop/tests/center.png
new file mode 100644
index 0000000..28671db
Binary files /dev/null and b/profiles/commons/modules/contrib/smartcrop/tests/center.png differ
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/center_10X.png b/profiles/commons/modules/contrib/smartcrop/tests/center_10X.png
new file mode 100644
index 0000000..d291a74
Binary files /dev/null and b/profiles/commons/modules/contrib/smartcrop/tests/center_10X.png differ
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/center_2X.png b/profiles/commons/modules/contrib/smartcrop/tests/center_2X.png
new file mode 100644
index 0000000..44a25d6
Binary files /dev/null and b/profiles/commons/modules/contrib/smartcrop/tests/center_2X.png differ
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/left.png b/profiles/commons/modules/contrib/smartcrop/tests/left.png
new file mode 100644
index 0000000..c1c7330
Binary files /dev/null and b/profiles/commons/modules/contrib/smartcrop/tests/left.png differ
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/quarter.png b/profiles/commons/modules/contrib/smartcrop/tests/quarter.png
new file mode 100644
index 0000000..6ec42b0
Binary files /dev/null and b/profiles/commons/modules/contrib/smartcrop/tests/quarter.png differ
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/right.png b/profiles/commons/modules/contrib/smartcrop/tests/right.png
new file mode 100644
index 0000000..b2425b1
Binary files /dev/null and b/profiles/commons/modules/contrib/smartcrop/tests/right.png differ
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/smartcrop.test b/profiles/commons/modules/contrib/smartcrop/tests/smartcrop.test
new file mode 100644
index 0000000..341110a
--- /dev/null
+++ b/profiles/commons/modules/contrib/smartcrop/tests/smartcrop.test
@@ -0,0 +1,258 @@
+<?php
+// $Id: smartcrop.test,v 1.1.2.23.2.8 2010/09/17 04:32:35 grendzy Exp $
+
+/**
+ * @file
+ * Tests for the smartcrop module.
+ */
+
+class SmartcropTestCase extends ImageFieldTestCase {
+  protected $admin_user;
+
+  public static function getInfo() {
+    return array(
+      'name' => t('Smartcrop test'),
+      'description' => t('Test Smartcrop.'),
+      'group' => t('Image'),
+    );
+  }
+
+  function setUp() {
+    parent::setUp();
+    module_enable(array('smartcrop'));
+
+    // Create and login user
+    $this->admin_user = $this->drupalCreateUser(array('access content', 'access administration pages', 'administer site configuration', 'administer content types', 'administer nodes', 'create page content', 'edit any page content', 'delete any page content', 'administer image styles'));
+    $this->drupalLogin($this->admin_user);
+  }
+
+  /**
+   * Verify the entropy calculation with a known image.
+   */
+  function testEntropy() {
+    // Create a test image with 3 red, 3 green, and 3 blue pixels.
+    $image = imagecreatetruecolor(3, 3);
+    imagefilledrectangle($image, 0, 0, 2, 0, imagecolorallocate($image, 255, 0, 0));
+    imagefilledrectangle($image, 0, 1, 2, 1, imagecolorallocate($image, 0, 255, 0));
+    imagefilledrectangle($image, 0, 2, 2, 2, imagecolorallocate($image, 0, 0, 255));
+
+    // Calculate the expected values.
+    // There are 9 bins in the histogram, 3 colors * 3 channels.
+    $expected_entroy = (1/3 * log(1/9, 2) + 2/3 * log(2/9, 2)) * -1;
+    $image_entropy = _smartcrop_gd_entropy($image);
+
+    $this->assertTrue($image_entropy - $expected_entroy < .001, t('Entropy value is correct.'));
+  }
+
+  /**
+   * Test the ImageEqual assertions.
+   */
+  function testImageEqual() {
+    $image1 = $expected_image = imagecreatefrompng(dirname(__FILE__) . '/left.png');
+    $image2 = $expected_image = imagecreatefrompng(dirname(__FILE__) . '/right.png');
+    $this->assertImageNotEqual($image1, $image2);
+    $image2 = $expected_image = imagecreatefrompng(dirname(__FILE__) . '/left.png');
+    $this->assertImageEqual($image1, $image2);
+
+    // Clean up.
+    imagedestroy($image1);
+    imagedestroy($image2);
+  }
+
+  /**
+   * Test cropping of images with known properties.
+   */
+  function testScaleAndCrop() {
+    // Create a preset with entropy crop.
+    $this->drupalPost('admin/config/media/image-styles/add', array('name' => 'test'), t('Create new style'));
+    $this->drupalPost(NULL, array('new' => 'smartcrop_scale_and_crop'), t('Add'));
+    $edit = array(
+      'data[width]' => 10,
+      'data[height]' => 10,
+    );
+    $this->drupalPost(NULL, $edit, t('Add effect'));
+
+    // Create an image field that uses the new style.
+    $instance = $this->createImageField('smartcrop_image', 'page');
+    $instance['display']['default']['type'] = 'image';
+    $instance['display']['default']['settings']['image_style'] = 'test';
+    field_update_instance($instance);
+
+    // Test cropping with synthetic images.
+    $test_files = array('bottom.png', 'left.png', 'right.png', 'top.png');
+    $expected_image = imagecreatefrompng(dirname(__FILE__) . '/center.png');
+    foreach ($test_files as $file) {
+      // Upload a file
+      $edit = array(
+        'title' => $this->randomName(),
+        'files[smartcrop_image_und_0]' => realpath(dirname(__FILE__) . '/' . $file),
+      );
+      $this->drupalPost('node/add/page', $edit, t('Save'));
+      $node = $this->drupalGetNodeByTitle($edit['title']);
+      $image_uri = $node->smartcrop_image[LANGUAGE_NONE][0]['uri'];
+
+      $this->drupalGet(image_style_url('test', $image_uri));
+      $this->assertResponse(200, t('Retrieved cropped image.'));
+
+      $actual_image = imagecreatefrompng(image_style_url('test', $image_uri));
+      $this->assertImageEqual($actual_image, $expected_image, 1, t('@file was cropped correctly.', array('@file' => $file)));
+    }
+
+    // Test Upscaling.
+    $this->drupalGet('admin/config/media/image-styles/edit/test');
+    $this->clickLink('edit');
+    $edit = array(
+      'data[width]' => 100,
+      'data[height]' => 100,
+      'data[upscale]' => 1,
+    );
+    $this->drupalPost(NULL, $edit, t('Update effect'));
+
+    $file = 'center.png';
+    $edit = array(
+      'title' => $this->randomName(),
+      'files[smartcrop_image_und_0]' => realpath(dirname(__FILE__) . '/' . $file),
+    );
+    $this->drupalPost('node/add/page', $edit, t('Save'));
+    $node = $this->drupalGetNodeByTitle($edit['title']);
+    $image_uri = $node->smartcrop_image[LANGUAGE_NONE][0]['uri'];
+
+    $this->drupalGet(image_style_url('test', $image_uri));
+    $this->assertResponse(200, t('Retrieved cropped image.'));
+
+    $expected_image = imagecreatefrompng(dirname(__FILE__) . '/center_10X.png');
+    $actual_image = imagecreatefrompng(image_style_url('test', $image_uri));
+    $this->assertImageEqual($actual_image, $expected_image, 1, t('@file was upscaled correctly.', array('@file' => $file)));
+
+    // Clean up.
+    imagedestroy($expected_image);
+    imagedestroy($actual_image);
+  }
+
+  function testCrop() {
+    // Create a preset with entropy crop.
+    $this->drupalPost('admin/config/media/image-styles/add', array('name' => 'test2'), t('Create new style'));
+    $this->drupalPost(NULL, array('new' => 'smartcrop_crop'), t('Add'));
+
+    $edit = array(
+      'data[width]' => '10',
+      'data[height]' => '10',
+    );
+    $this->drupalPost(NULL, $edit, t('Add effect'));
+
+    // Create an image field that uses the new style.
+    $instance = $this->createImageField('smartcrop_image', 'page');
+    $instance['display']['default']['type'] = 'image';
+    $instance['display']['default']['settings']['image_style'] = 'test2';
+    field_update_instance($instance);
+
+    $file = 'quarter.png';
+    $edit = array(
+      'title' => $this->randomName(),
+      'files[smartcrop_image_und_0]' => realpath(dirname(__FILE__) . '/' . $file),
+    );
+
+    $this->drupalPost('node/add/page', $edit, t('Save'));
+    $node = $this->drupalGetNodeByTitle($edit['title']);
+    $image_uri = $node->smartcrop_image[LANGUAGE_NONE][0]['uri'];
+
+    $this->drupalGet(image_style_url('test2', $image_uri));
+    $this->assertResponse(200, t('Retrieved cropped image.'));
+
+    $expected_image = imagecreatefrompng(dirname(__FILE__) . '/center.png');
+    $actual_image = imagecreatefrompng(image_style_url('test2', $image_uri));
+    $this->assertImageEqual($actual_image, $expected_image, 1, t('@file was cropped correctly.', array('@file' => $file)));
+
+    // Clean up.
+    imagedestroy($expected_image);
+    imagedestroy($actual_image);
+  }
+
+  /**
+   * Assert that two images are the same, with some difference allowed to account for e.g. compression artifacts.
+   * @param $image1 A GD image resource.
+   * @param $image2 A GD image resource.
+   * @param $max_diff (optional) The maximum allowed difference, range from 0 to 255, defaults to 1.
+   * @param $message (optional) The message to display along with the assertion.
+   */
+  function assertImageEqual($image1, $image2, $max_diff = 1, $message = NULL) {
+    if (empty($message)) {
+      $message = t('Images are equal.');
+    }
+    $difference = $this->difference($image1, $image2);
+    $mean = $this->mean($difference);
+    $this->assertTrue($mean < $max_diff, $message);
+    imagedestroy($difference);
+  }
+
+  /**
+   * Assert that two images are not the same, with some difference allowed to account for e.g. compression artifacts.
+   * @param $image1 A GD image resource.
+   * @param $image2 A GD image resource.
+   * @param $min_diff (optional) The minimum allowed difference, range from 0 to 255, defaults to 1.
+   * @param $message (optional) The message to display along with the assertion.
+   */
+  function assertImageNotEqual($image1, $image2, $min_diff = 1, $message = NULL) {
+    if (empty($message)) {
+      $message = t('Images are not equal.');
+    }
+    $difference = $this->difference($image1, $image2);
+    $mean = $this->mean($difference);
+    $this->assertTrue($mean > $min_diff, $message);
+  }
+
+  /**
+   * Calculate the mean pixel intensity.
+   * @param $image GD image resource.
+   * @return The mean.
+   */
+  function mean($image) {
+    $mean = 0;
+    $size = imagesx($image) * imagesy($image) * 3;
+    for ($i = 0; $i < imagesx($image); $i++) {
+      for ($j = 0; $j < imagesy($image); $j++) {
+        $rgb = imagecolorat($image, $i, $j);
+        $r = ($rgb >> 16) & 0xFF;
+        $g = ($rgb >> 8) & 0xFF;
+        $b = $rgb & 0xFF;
+        $mean += $r / $size;
+        $mean += $g / $size;
+        $mean += $b / $size;
+      }
+    }
+    return $mean;
+  }
+
+  /**
+   * Calculate the difference of 2 images.
+   * @param $image1 A GD image resource.
+   * @param $image2 A GD image resource.
+   * @return A GD image resource, with the subtracted image.
+   */
+  function difference($image1, $image2) {
+    $this->assertEqual(imagesx($image1), imagesx($image2), t('Images have the same width.'));
+    $this->assertEqual(imagesy($image1), imagesy($image2), t('Images have the same height.'));
+    $difference = imagecreatetruecolor(imagesx($image1), imagesy($image1));
+    for ($i = 0; $i < imagesx($image1); $i++) {
+      for ($j = 0; $j < imagesy($image1); $j++) {
+        $rgb1 = imagecolorat($image1, $i, $j);
+        $r1 = ($rgb1 >> 16) & 0xFF;
+        $g1 = ($rgb1 >> 8) & 0xFF;
+        $b1 = $rgb1 & 0xFF;
+
+        $rgb2 = imagecolorat($image2, $i, $j);
+        $r2 = ($rgb2 >> 16) & 0xFF;
+        $g2 = ($rgb2 >> 8) & 0xFF;
+        $b2 = $rgb2 & 0xFF;
+
+        imagesetpixel($difference, $i, $j, imagecolorallocate(
+          $difference,
+          abs($r2 - $r1),
+          abs($g2 - $g1),
+          abs($b2 - $b1)
+        ));
+      }
+    }
+    return $difference;
+  }
+}
\ No newline at end of file
diff --git a/profiles/commons/modules/contrib/smartcrop/tests/top.png b/profiles/commons/modules/contrib/smartcrop/tests/top.png
new file mode 100644
index 0000000..2b95394
Binary files /dev/null and b/profiles/commons/modules/contrib/smartcrop/tests/top.png differ
diff --git a/profiles/commons/modules/contrib/strongarm/strongarm.info b/profiles/commons/modules/contrib/strongarm/strongarm.info
index a27acb9..854e302 100644
--- a/profiles/commons/modules/contrib/strongarm/strongarm.info
+++ b/profiles/commons/modules/contrib/strongarm/strongarm.info
@@ -8,9 +8,9 @@ files[] = strongarm.install
 files[] = strongarm.module
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-2.0+2-dev"
 core = "7.x"
 project = "strongarm"
-datestamp = "1389381816"
+datestamp = "1389902315"
 
diff --git a/profiles/commons/themes/commons/commons_origins/.gitignore b/profiles/commons/themes/commons/commons_origins/.gitignore
index 6173eab..8b86ab2 100644
--- a/profiles/commons/themes/commons/commons_origins/.gitignore
+++ b/profiles/commons/themes/commons/commons_origins/.gitignore
@@ -1,2 +1,3 @@
 /.sass-cache/
+.bundle
 .DS_Store
diff --git a/profiles/commons/themes/commons/commons_origins/Gemfile b/profiles/commons/themes/commons/commons_origins/Gemfile
new file mode 100644
index 0000000..996b525
--- /dev/null
+++ b/profiles/commons/themes/commons/commons_origins/Gemfile
@@ -0,0 +1,7 @@
+# A sample Gemfile
+source "https://rubygems.org"
+
+# gem "rails"
+gem 'sass'
+gem 'compass'
+gem 'oily_png'
diff --git a/profiles/commons/themes/commons/commons_origins/Gemfile.lock b/profiles/commons/themes/commons/commons_origins/Gemfile.lock
new file mode 100644
index 0000000..2f03b5a
--- /dev/null
+++ b/profiles/commons/themes/commons/commons_origins/Gemfile.lock
@@ -0,0 +1,20 @@
+GEM
+  remote: https://rubygems.org/
+  specs:
+    chunky_png (1.2.9)
+    compass (0.12.2)
+      chunky_png (~> 1.2)
+      fssm (>= 0.2.7)
+      sass (~> 3.1)
+    fssm (0.2.10)
+    oily_png (1.1.0)
+      chunky_png (~> 1.2.7)
+    sass (3.2.13)
+
+PLATFORMS
+  ruby
+
+DEPENDENCIES
+  compass
+  oily_png
+  sass
diff --git a/profiles/commons/themes/commons/commons_origins/commons_origins.info b/profiles/commons/themes/commons/commons_origins/commons_origins.info
index b367596..8870d9e 100644
--- a/profiles/commons/themes/commons/commons_origins/commons_origins.info
+++ b/profiles/commons/themes/commons/commons_origins/commons_origins.info
@@ -56,6 +56,15 @@
   ; unset_css[sites/all/modules/foobar_module/foobar_module.css] = 1
 
 
+;-----------// Breakpoints
+
+  breakpoints[Commons small portrait] = only screen and (max-width:320px)
+  breakpoints[Commons small landscape] = only screen and (min-width:321px) and (max-width:480px)
+  breakpoints[Commons medium portrait] = only screen and (min-width:481px) and (max-width:768px)
+  breakpoints[Commons medium landscape] = only screen and (min-width:769px) and (max-width:934px
+  breakpoints[Commons large] = only screen and (min-width:935px)
+
+
 ;----------// Scripts
 
   scripts[] = scripts/modernizr.js
@@ -420,9 +429,9 @@
 
   ;
 
-; Information added by Drupal.org packaging script on 2014-01-10
-version = "7.x-3.7"
+; Information added by Drupal.org packaging script on 2014-01-16
+version = "7.x-3.8"
 core = "7.x"
 project = "commons"
-datestamp = "1389381808"
+datestamp = "1389902308"
 
diff --git a/profiles/commons/themes/commons/commons_origins/css/commons-media.css b/profiles/commons/themes/commons/commons_origins/css/commons-media.css
new file mode 100644
index 0000000..5323fb5
--- /dev/null
+++ b/profiles/commons/themes/commons/commons_origins/css/commons-media.css
@@ -0,0 +1,84 @@
+/**
+ * @file
+ * Style overrides for the Commons Media feature.
+ */
+.field-name-field-media-form {
+  margin-bottom: 10px;
+}
+
+.field-name-field-media .field-add-more-submit, #quicktabs-container-commons_bw .quicktabs-tabpage .field-name-field-media .field-add-more-submit {
+  margin: 10px 0;
+}
+
+table[id^="field-media-values"],
+table[id^="field-media-values"] thead,
+table[id^="field-media-values"] tbody,
+table[id^="field-media-values"] tr,
+table[id^="field-media-values"] th,
+table[id^="field-media-values"] td {
+  background-color: transparent;
+  border: none;
+}
+table[id^="field-media-values"] th {
+  padding: 0;
+}
+table[id^="field-media-values"] th label {
+  margin: 0;
+}
+table[id^="field-media-values"] td.field-multiple-drag {
+  width: 20px;
+}
+table[id^="field-media-values"] a.tabledrag-handle .handle {
+  margin: 0;
+}
+table[id^="field-media-values"] .form-item {
+  padding-left: 6.875em;
+}
+table[id^="field-media-values"] .preview {
+  float: left;
+  font-size: 1em;
+  margin-left: -6.875em;
+  width: 6.25em;
+  min-height: 6.25em;
+  background: #858585;
+  cursor: pointer;
+}
+@media only screen and (max-width: 480px) {
+  table[id^="field-media-values"] .form-item {
+    padding-left: 0;
+  }
+  table[id^="field-media-values"] .preview {
+    display: block;
+    float: none;
+    margin: 10px auto;
+  }
+}
+table[id^="field-media-values"] .media-item {
+  padding: 0;
+  background-color: transparent;
+  border: none;
+}
+table[id^="field-media-values"] .media-item img {
+  display: block;
+  margin: 0;
+}
+table[id^="field-media-values"] .media-item .label-wrapper {
+  position: static;
+}
+table[id^="field-media-values"] .media-item .label-wrapper label {
+  margin: 0;
+}
+table[id^="field-media-values"] .media-widget .preview .media-item {
+  margin: 0;
+}
+table[id^="field-media-values"] .media-widget .preview .media-item .label-wrapper label {
+  color: white;
+}
+table[id^="field-media-values"] .media-widget .button {
+  display: block;
+}
+@media only screen and (min-width: 769px) {
+  table[id^="field-media-values"] .media-widget .button {
+    max-width: 50%;
+  }
+}
diff --git a/profiles/commons/themes/commons/commons_origins/sass/commons-media.scss b/profiles/commons/themes/commons/commons_origins/sass/commons-media.scss
new file mode 100644
index 0000000..3742746
--- /dev/null
+++ b/profiles/commons/themes/commons/commons_origins/sass/commons-media.scss
@@ -0,0 +1,114 @@
+/**
+ * @file
+ * Style overrides for the Commons Media feature.
+ */
+
+@import "base";
+
+.field-name-field-media-form {
+  margin-bottom: $gutter-width;
+}
+
+.field-name-field-media .field-add-more-submit {
+  &,
+  #quicktabs-container-commons_bw .quicktabs-tabpage & {
+    margin: $gutter-width 0;
+  }
+}
+
+table[id^="field-media-values"] {
+  &,
+  thead,
+  tbody,
+  tr,
+  th,
+  td {
+    background-color: transparent;
+    border: none;
+  }
+
+  th {
+    padding: 0;
+
+    label {
+      margin: 0;
+    }
+  }
+
+  td {
+    &.field-multiple-drag {
+      width: 20px;
+    }
+  }
+
+  a.tabledrag-handle .handle {
+    margin: 0;
+  }
+
+  .form-item {
+    padding-left: px-to-em(100px + $gutter-width);
+  }
+
+  .preview {
+    float: left;
+    font-size: 1em;
+    margin-left: -(px-to-em(100px + $gutter-width));
+    width: px-to-em(100px);
+    min-height: px-to-em(100px);
+    background: $light_gray;
+    cursor: pointer;
+  }
+
+  @include respond(only-small) {
+    .form-item {
+      padding-left: 0;
+    }
+
+    .preview {
+      display: block;
+      float: none;
+      margin: $gutter-width auto;
+    }
+  }
+
+  .media-item {
+    padding: 0;
+    background-color: transparent;
+    border: none;
+
+    img {
+      display: block;
+      margin: 0;
+    }
+
+    .label-wrapper {
+      position: static;
+
+      label {
+        margin: 0;
+      }
+    }
+  }
+
+  .media-widget {
+    .preview {
+      .media-item {
+        margin: 0;
+
+        .label-wrapper {
+          label {
+            color: $white;
+          }
+        }
+      }
+    }
+
+    .button {
+      display: block;
+
+      @include respond(large) {
+        max-width: 50%;
+      }
+    }
+  }
+}
diff --git a/profiles/commons/themes/commons/commons_origins/template.php b/profiles/commons/themes/commons/commons_origins/template.php
index 1f408a5..ce26a21 100755
--- a/profiles/commons/themes/commons/commons_origins/template.php
+++ b/profiles/commons/themes/commons/commons_origins/template.php
@@ -123,7 +123,6 @@ function commons_origins_preprocess_html(&$variables, $hook) {
   // Browser/platform sniff - adds body classes such as ipad, webkit, chrome
   // etc.
   $variables['classes_array'][] = css_browser_selector();
-
 }
 
 /**
@@ -263,6 +262,11 @@ function commons_origins_preprocess_page(&$variables, $hook) {
 
   $cf_pos = in_array('clearfix', $variables['branding_attributes_array']['class']);
   unset($variables['branding_attributes_array']['class'][$cf_pos]);
+
+  // Only load the media styles if Commons Media is enabled.
+  if (module_exists('commons_media')) {
+    drupal_add_css(drupal_get_path('theme', 'commons_origins') . '/css/commons-media.css', array('media' => 'screen', 'group' => CSS_THEME));
+  }
 }
 
 /**
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info b/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
index 2e6a0f2..8b9405e 100755
--- a/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_admin/adaptivetheme_admin.info
@@ -349,9 +349,9 @@
   settings[custom_css] = ''
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-3.1+68-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1389381864"
+datestamp = "1389902314"
 
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info b/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
index 0be7a36..826887d 100755
--- a/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_core/adaptivetheme.info
@@ -374,9 +374,9 @@
   settings[custom_css] = ''
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-3.1+68-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1389381864"
+datestamp = "1389902314"
 
diff --git a/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info b/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
index 1a6be57..dcdec84 100755
--- a/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
+++ b/profiles/commons/themes/contrib/adaptivetheme/at_subtheme/adaptivetheme_subtheme.info
@@ -454,9 +454,9 @@
   settings[custom_css] = ''
 
 
-; Information added by drush on 2014-01-10
+; Information added by drush on 2014-01-16
 version = "7.x-3.1+68-dev"
 core = "7.x"
 project = "adaptivetheme"
-datestamp = "1389381864"
+datestamp = "1389902314"
 
diff --git a/profiles/commons/themes/contrib/ember/ember.info b/profiles/commons/themes/contrib/ember/ember.info
index ec23e70..12c0292 100644
--- a/profiles/commons/themes/contrib/ember/ember.info
+++ b/profiles/commons/themes/contrib/ember/ember.info
@@ -24,9 +24,9 @@ regions[sidebar_first] = First sidebar
 regions_hidden[] = sidebar_first
 
 
-; Information added by drush on 2014-01-10
-version = "7.x-2.0-alpha1+45-dev"
+; Information added by drush on 2014-01-16
+version = "7.x-2.0-alpha1+46-dev"
 core = "7.x"
 project = "ember"
-datestamp = "1389381814"
+datestamp = "1389902313"
 
diff --git a/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/core/tools/_buttons.scss b/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/core/tools/_buttons.scss
index c877c07..be1bb97 100644
--- a/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/core/tools/_buttons.scss
+++ b/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/core/tools/_buttons.scss
@@ -10,7 +10,7 @@
 // These are the default skins and sizes. They can be overridden with alternate
 // values.
 $buttons: (default, $color-border) (active, shade($color-border, 20)) (primary, $color-link) (primary-active, $color-link-visited) (alternate, $color-link-alternate) (alternate-active, $color-link-alternate-visited) !default;
-$button-sizes: (default, ms(0), $rhythm-space ms(0)) (small, ms(-1), $rhythm-space ms(0)) (large, ms(1), $rhythm-space ms(0)) !default;
+$button-sizes: (default, ms(0), $rhythm-space ms(0)) (small, ms(0), $rhythm-space-short ms(0)) (large, ms(1), $rhythm-space ms(0)) !default;
 $button-contrast: 80 !default;
 
 // Bulk generate buttons styles with a list of settings.
@@ -23,7 +23,7 @@ $button-contrast: 80 !default;
     margin: ms(-5);
     max-width: 100%;
     overflow: visible;
-    line-height: 1.25em;
+    line-height: 1em;
     vertical-align: baseline;
     border: none;
     @include border-radius;
diff --git a/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/drupal/seven/system/_system.base.scss b/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/drupal/seven/system/_system.base.scss
index bb249d6..fb94065 100644
--- a/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/drupal/seven/system/_system.base.scss
+++ b/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/drupal/seven/system/_system.base.scss
@@ -80,7 +80,6 @@ html.js {
   .collapsed {
     height: $rhythm-space;
     margin-bottom: $rhythm-space * 2;
-    border-color: transparent;
 
     .fieldset-wrapper {
       display: none;
@@ -89,7 +88,6 @@ html.js {
 
   .collapsible {
     position: relative;
-    @include single-transition(border-color, .4s);
 
     .fieldset-legend {
       display: block;
@@ -131,8 +129,10 @@ body.drag {
 
 .draggable {
   td {
+    vertical-align: top;
+
     &:first-child {
-      padding-left: 0;
+      padding-left: ($rhythm-space-short + ms(1));
     }
   }
 }
@@ -143,9 +143,10 @@ body.drag {
   &,
   &:link,
   &:visited {
-    color: $color-border;
+    color: $color-link;
   }
 
+  .drag &,
   &:hover,
   &:active,
   &:focus {
@@ -153,32 +154,36 @@ body.drag {
   }
 
   .draggable & {
+    display: block;
+    float: left;
+    margin-top: $rhythm-space;
+    margin-left: -(($rhythm-space-short + ms(1)));
+    width: 0;
+    overflow: hidden;
     cursor: move;
     text-decoration: none;
+    @include opacity(0);
+    @include transition-property(width opacity);
+    @include transition-duration(.4s);
   }
 
-  .handle {
-    display: inline-block;
-    vertical-align: middle;
-
-    [dir="ltr"] & {
-      margin: {
-        right: $rhythm-space-short;
-        left: $rhythm-space;
-      }
-    }
-
-    [dir="rtl"] & {
-      margin: {
-        right: $rhythm-space;
-        left: $rhythm-space-short;
-      }
-    }
+  .draggable:hover &,
+  .draggable.drag & {
+    width: ms(1);
+    @include opacity(1);
+  }
 
+  .handle {
     &:before {
-      line-height: 1em;
+      display: block;
+      content: "\283f \2836";
+      @include word-break(break-all);
+      @include box-sizing(border-box);
+      padding: .25em 0;
+      white-space: normal;
+      line-height: .523em;
       font-size: ms(1);
-      content: "\2261";
+      width: 1em;
     }
   }
 }
diff --git a/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/drupal/seven/system/_system.theme.scss b/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/drupal/seven/system/_system.theme.scss
index df823ad..55147ab 100644
--- a/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/drupal/seven/system/_system.theme.scss
+++ b/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/drupal/seven/system/_system.theme.scss
@@ -158,41 +158,54 @@ td.active {
 fieldset {
   &.collapsible {
     .fieldset-legend {
-      &:after {
-        position: relative;
-        top: (($line-height - 1em) / 2);
+      margin: 0;
+      @include single-transition(margin, .2s);
+
+      &:before {
+        content: "";
         display: inline-block;
-        content: '\2303';
-        color: $color-link-alternate;
-        @include transition(top .2s, transform .2s);
+        @include box-sizing(border-box);
+        position: relative;
+        width: .6em;
+        height: .6em;
+        margin: .1em 0;
+        border: {
+          width: .1em;
+          style: solid;
+        }
+
+        [dir="ltr"] & {
+          float: left;
+          margin-left: -1.2em;
+          border-color: transparent $color-link-alternate $color-link-alternate transparent;
+        }
+
+        [dir="rtl"] & {
+          float: right;
+          margin-right: -1.2em;
+          border-color: transparent transparent $color-link-alternate $color-link-alternate;
+        }
       }
     }
   }
 
   &.collapsed {
-    .fieldset-legend {
-      &:after {
-        top: -(($line-height - 1em) / 2);
-        @include scaleY(-1);
-      }
+    [dir="ltr"] & {
+      border-left-width: 1px;
     }
-  }
 
-  html.js[dir="ltr"] & {
-    &.collapsible {
-      .fieldset-legend {
-        &:after {
-          margin-right: $rhythm-space-short;
-        }
-      }
+    [dir="rtl"] & {
+      border-right-width: 1px;
     }
-  }
 
-  html.js[dir="rtl"] & {
-    &.collapsible {
-      .fieldset-legend {
-        &:after {
-          margin-left: $rhythm-space-short;
+    .fieldset-legend {
+      &:before {
+        [dir="ltr"] & {
+          @include rotate(-45deg);
+        }
+
+        [dir="rtl"] & {
+          @include rotate(45deg);
         }
       }
     }
@@ -214,6 +227,10 @@ fieldset {
   }
 }
 
+.fieldset-title:hover {
+  text-decoration: none;
+}
+
 /**
  * TableDrag behavior.
  *
diff --git a/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/reset/_baseline.scss b/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/reset/_baseline.scss
index 250fbd9..6a9cb47 100644
--- a/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/reset/_baseline.scss
+++ b/profiles/commons/themes/contrib/ember/extensions/ux_styleguide/stylesheets/ux_styleguide/reset/_baseline.scss
@@ -230,16 +230,8 @@
     th,
     td {
       margin: 0;
-      padding: $rhythm-space;
+      padding: $rhythm-space-short $rhythm-space;
       border-bottom: $base-border-width solid $color-border;
-
-      *:first-child {
-        margin-top: 0;
-      }
-
-      *:last-child {
-        margin-bottom: 0;
-      }
     }
   }
 
@@ -265,47 +257,31 @@
       @include box-sizing(border-box);
       width: 100%;
       max-width: 100%;
+      min-height: ms(1);
       margin: ($rhythm-space * 2) 0 $rhythm-space;
       padding: 0;
-      border: 0 solid $color-border;
+      border: {
+        /* There needs to be some width or Webkit will freak. */
+        width: 1px 0;
+        style: solid;
+        color: transparent;
+      }
 
       [dir="ltr"] & {
-        padding-left: $rhythm-space;
-        border-left-width: $rhythm-space-short;
+        padding-left: $inset-space;
       }
 
       [dir="rtl"] & {
-        padding-right: $rhythm-space;
-        border-right-width: $rhythm-space-short;
-      }
-
-      > :first-child,
-      > legend + * {
-        margin-top: 0;
-      }
-
-      > :last-child {
-        margin-bottom: 0;
+        padding-right: $inset-space;
       }
     }
 
     legend {
-      display: block;
+      margin-bottom: $rhythm-space;
       font: {
         size: ms(1);
         weight: $font-light;
       }
-      line-height: normal;
-      margin: -$rhythm-space 0 0;
-      padding: 0 0 ($rhythm-space / ms(1) * 1em);
-
-      [dir="ltr"] & {
-        margin-left: -($rhythm-space + $rhythm-space-short) / ms(1) * 1em;
-      }
-
-      [dir="rtl"] & {
-        margin-right: -($rhythm-space + $rhythm-space-short) / ms(1) * 1em;
-      }
     }
 
     button,
@@ -345,7 +321,7 @@
       -webkit-appearance: none;
       @include box-sizing(border-box);
       margin: $rhythm-space-short 0;
-      padding: $rhythm-space;
+      padding: $rhythm-space-short $rhythm-space;
       max-width: 100%;
       border: $base-border-width solid $color-border;
       @include border-radius;
@@ -363,12 +339,10 @@
       }
 
       &.required {
-        color: $color-warning;
         border-color: $color-warning;
       }
 
       &.error {
-        color: $color-error;
         border-color: $color-error;
       }
 
diff --git a/profiles/commons/themes/contrib/ember/styles/style.css b/profiles/commons/themes/contrib/ember/styles/style.css
index 62a31a1..922fee5 100644
--- a/profiles/commons/themes/contrib/ember/styles/style.css
+++ b/profiles/commons/themes/contrib/ember/styles/style.css
@@ -297,17 +297,9 @@ th {
 th,
 td {
   margin: 0;
-  padding: 0.70711em;
+  padding: 0.35355em 0.70711em;
   border-bottom: 1px solid #cccccc;
 }
-th *:first-child,
-td *:first-child {
-  margin-top: 0;
-}
-th *:last-child,
-td *:last-child {
-  margin-bottom: 0;
-}
 
 /**
  * Default form styles
@@ -329,39 +321,25 @@ fieldset {
   box-sizing: border-box;
   width: 100%;
   max-width: 100%;
+  min-height: 1.5em;
   margin: 1.41421em 0 0.70711em;
   padding: 0;
-  border: 0 solid #cccccc;
+  /* There needs to be some width or Webkit will freak. */
+  border-width: 1px 0;
+  border-style: solid;
+  border-color: transparent;
 }
 [dir="ltr"] fieldset {
-  padding-left: 0.70711em;
-  border-left-width: 0.35355em;
+  padding-left: 2.25em;
 }
 [dir="rtl"] fieldset {
-  padding-right: 0.70711em;
-  border-right-width: 0.35355em;
-}
-fieldset > :first-child,
-fieldset > legend + * {
-  margin-top: 0;
-}
-fieldset > :last-child {
-  margin-bottom: 0;
+  padding-right: 2.25em;
 }
 
 legend {
-  display: block;
+  margin-bottom: 0.70711em;
   font-size: 1.5em;
   font-weight: 200;
-  line-height: normal;
-  margin: -0.70711em 0 0;
-  padding: 0 0 0.4714em;
-}
-[dir="ltr"] legend {
-  margin-left: -0.70711em;
-}
-[dir="rtl"] legend {
-  margin-right: -0.70711em;
 }
 
 button,
@@ -413,7 +391,7 @@ textarea {
   -moz-box-sizing: border-box;
   box-sizing: border-box;
   margin: 0.35355em 0;
-  padding: 0.70711em;
+  padding: 0.35355em 0.70711em;
   max-width: 100%;
   border: 1px solid #cccccc;
   -webkit-border-radius: 2px;
@@ -534,7 +512,6 @@ input[type="url"].required,
 input[type="week"].required,
 select.required,
 textarea.required {
-  color: #f79521;
   border-color: #f79521;
 }
 input[type="color"].error,
@@ -555,7 +532,6 @@ input[type="url"].error,
 input[type="week"].error,
 select.error,
 textarea.error {
-  color: #cb2026;
   border-color: #cb2026;
 }
 input[type="color"]:focus, input[type="color"]:active,
@@ -798,7 +774,7 @@ input[id^="edit-next"],
   margin: 0.2963em;
   max-width: 100%;
   overflow: visible;
-  line-height: 1.25em;
+  line-height: 1em;
   vertical-align: baseline;
   border: none;
   -webkit-border-radius: 2px;
@@ -882,8 +858,8 @@ input[id^="edit-next"],
 
 /* Dimensions for the small button type. */
 [class*="action-item-small"] {
-  padding: 0.70711em 1em;
-  font-size: 0.70711em;
+  padding: 0.35355em 1em;
+  font-size: 1em;
 }
 
 /* Dimensions for the large button type. */
@@ -1388,7 +1364,7 @@ input[type="button"][class*="action-item-large"],
 }
 
 body {
-  background: white url('../images/spark_bg_tile.png?1376700820');
+  background: white url('../images/spark_bg_tile.png?1388516670');
 }
 
 p,
@@ -1466,7 +1442,7 @@ td {
 /* FORM ELEMENTS */
 /* Make fake buttons inherit the given styles. */
 .form-select, .form-select:focus, .form-select:active {
-  background: white url('../images/select_sprite.svg?1388162849') no-repeat right center;
+  background: white url('../images/select_sprite.svg?1388516670') no-repeat right center;
 }
 [dir="ltr"] .form-select {
   padding-right: 3.51961em;
@@ -1539,7 +1515,7 @@ ul.admin-list {
   padding: 0;
 }
 ul.admin-list li {
-  background: url('../images/list-item.png?1376700820') no-repeat scroll 0 0 transparent;
+  background: url('../images/list-item.png?1388516670') no-repeat scroll 0 0 transparent;
   list-style-image: none;
   list-style-type: none;
   margin: 0 0 1em;
@@ -1580,14 +1556,14 @@ div.add-or-remove-shortcuts {
 div.add-or-remove-shortcuts a span.icon {
   display: block;
   width: 24px;
-  background: transparent url('../images/no_shortcut.svg?1388162849') no-repeat scroll 0 0;
+  background: transparent url('../images/no_shortcut.svg?1388516670') no-repeat scroll 0 0;
   height: 24px;
   float: right;
   margin-left: 8px;
 }
 
 div.add-shortcut a:focus span.icon, div.add-shortcut a:hover span.icon {
-  background: transparent url('../images/shortcut.svg?1388162849') no-repeat scroll 0 0;
+  background: transparent url('../images/shortcut.svg?1388516670') no-repeat scroll 0 0;
   -webkit-transition: all 1s;
   -moz-transition: all 1s;
   -o-transition: all 1s;
@@ -1595,10 +1571,10 @@ div.add-shortcut a:focus span.icon, div.add-shortcut a:hover span.icon {
 }
 
 div.remove-shortcut a span.icon {
-  background: transparent url('../images/no_shortcut.svg?1388162849') no-repeat scroll 0 0;
+  background: transparent url('../images/no_shortcut.svg?1388516670') no-repeat scroll 0 0;
 }
 div.remove-shortcut a:focus span.icon, div.remove-shortcut a:hover span.icon {
-  background: transparent url('../images/no_shortcut.svg?1388162849') no-repeat scroll 0 0;
+  background: transparent url('../images/no_shortcut.svg?1388516670') no-repeat scroll 0 0;
   -webkit-transition: all 1s;
   -moz-transition: all 1s;
   -o-transition: all 1s;
@@ -2047,14 +2023,14 @@ ol.task-list li {
   /* LTR */
 }
 ol.task-list li.active {
-  background: transparent url('../images/task-item.png?1376700820') no-repeat 3px 50%;
+  background: transparent url('../images/task-item.png?1388516670') no-repeat 3px 50%;
   /* LTR */
   color: #000;
   padding: 0.5em 1em 0.5em 20px;
   /* LTR */
 }
 ol.task-list li.done {
-  background: transparent url('../images/task-check.png?1376700820') no-repeat 0 50%;
+  background: transparent url('../images/task-check.png?1388516670') no-repeat 0 50%;
   color: green;
 }
 
@@ -2888,7 +2864,7 @@ div.dashboard-block {
 }
 
 dl.page-manager-wizards {
-  background: url('../images/list-item.png?1376700820') no-repeat scroll 0 0 transparent;
+  background: url('../images/list-item.png?1388516670') no-repeat scroll 0 0 transparent;
   margin: 0 0 1em;
   padding: 0 0 0 2.5em;
 }
@@ -3174,7 +3150,7 @@ fieldset.features-export-component, fieldset.features-export-component.collapsed
 
   /* vertical tabs */
   div.vertical-tabs {
-    background: url('../images/fc.png?1376700820') repeat-y scroll -97px 0 white;
+    background: url('../images/fc.png?1388516670') repeat-y scroll -97px 0 white;
     border: 1px solid #ddd;
   }
   div.vertical-tabs .vertical-tabs-list {
diff --git a/profiles/commons/themes/contrib/ember/styles/system.base.css b/profiles/commons/themes/contrib/ember/styles/system.base.css
index 81d319a..c1e1735 100644
--- a/profiles/commons/themes/contrib/ember/styles/system.base.css
+++ b/profiles/commons/themes/contrib/ember/styles/system.base.css
@@ -67,17 +67,12 @@ html.js[dir="rtl"] .throbbing {
 html.js .collapsed {
   height: 0.70711em;
   margin-bottom: 1.41421em;
-  border-color: transparent;
 }
 html.js .collapsed .fieldset-wrapper {
   display: none;
 }
 html.js .collapsible {
   position: relative;
-  -webkit-transition: border-color 0.4s;
-  -moz-transition: border-color 0.4s;
-  -o-transition: border-color 0.4s;
-  transition: border-color 0.4s;
 }
 html.js .collapsible .fieldset-legend {
   display: block;
@@ -114,39 +109,61 @@ body.drag {
   cursor: move;
 }
 
+.draggable td {
+  vertical-align: top;
+}
 .draggable td:first-child {
-  padding-left: 0;
+  padding-left: 1.85355em;
 }
 
 .tabledrag-handle {
   text-decoration: none;
 }
 .tabledrag-handle, .tabledrag-handle:link, .tabledrag-handle:visited {
-  color: #cccccc;
+  color: #2fa6e5;
 }
-.tabledrag-handle:hover, .tabledrag-handle:active, .tabledrag-handle:focus {
+.drag .tabledrag-handle, .tabledrag-handle:hover, .tabledrag-handle:active, .tabledrag-handle:focus {
   color: #f05724;
 }
 .draggable .tabledrag-handle {
+  display: block;
+  float: left;
+  margin-top: 0.70711em;
+  margin-left: -1.85355em;
+  width: 0;
+  overflow: hidden;
   cursor: move;
   text-decoration: none;
-}
-.tabledrag-handle .handle {
-  display: inline-block;
-  vertical-align: middle;
-}
-[dir="ltr"] .tabledrag-handle .handle {
-  margin-right: 0.35355em;
-  margin-left: 0.70711em;
-}
-[dir="rtl"] .tabledrag-handle .handle {
-  margin-right: 0.70711em;
-  margin-left: 0.35355em;
+  filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=0);
+  opacity: 0;
+  -webkit-transition-property: width, opacity;
+  -moz-transition-property: width, opacity;
+  -o-transition-property: width, opacity;
+  transition-property: width opacity;
+  -webkit-transition-duration: 0.4s;
+  -moz-transition-duration: 0.4s;
+  -o-transition-duration: 0.4s;
+  transition-duration: 0.4s;
+}
+.draggable:hover .tabledrag-handle, .draggable.drag .tabledrag-handle {
+  width: 1.5em;
+  filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=100);
+  opacity: 1;
 }
 .tabledrag-handle .handle:before {
-  line-height: 1em;
+  display: block;
+  content: "\283f \2836";
+  -ms-word-break: break-all;
+  word-break: break-all;
+  word-break: break-word;
+  -webkit-box-sizing: border-box;
+  -moz-box-sizing: border-box;
+  box-sizing: border-box;
+  padding: .25em 0;
+  white-space: normal;
+  line-height: .523em;
   font-size: 1.5em;
-  content: "\2261";
+  width: 1em;
 }
 
 .tabledrag-handle-hover .handle {
diff --git a/profiles/commons/themes/contrib/ember/styles/system.theme.css b/profiles/commons/themes/contrib/ember/styles/system.theme.css
index 5ff1881..7b30728 100644
--- a/profiles/commons/themes/contrib/ember/styles/system.theme.css
+++ b/profiles/commons/themes/contrib/ember/styles/system.theme.css
@@ -141,30 +141,55 @@ td.active {
  *
  * @see collapse.js
  */
-fieldset.collapsible .fieldset-legend:after {
-  position: relative;
-  top: 0.20711em;
-  display: inline-block;
-  content: '\2303';
-  color: #f05724;
-  -webkit-transition: top 0.2s, -webkit-transform 0.2s;
-  -moz-transition: top 0.2s, -moz-transform 0.2s;
-  -o-transition: top 0.2s, -o-transform 0.2s;
-  transition: top 0.2s, transform 0.2s;
-}
-fieldset.collapsed .fieldset-legend:after {
-  top: -0.20711em;
-  -webkit-transform: scaleY(-1);
-  -moz-transform: scaleY(-1);
-  -ms-transform: scaleY(-1);
-  -o-transform: scaleY(-1);
-  transform: scaleY(-1);
-}
-html.js[dir="ltr"] fieldset.collapsible .fieldset-legend:after {
-  margin-right: 0.35355em;
+fieldset.collapsible .fieldset-legend {
+  margin: 0;
+  -webkit-transition: margin 0.2s;
+  -moz-transition: margin 0.2s;
+  -o-transition: margin 0.2s;
+  transition: margin 0.2s;
 }
-html.js[dir="rtl"] fieldset.collapsible .fieldset-legend:after {
-  margin-left: 0.35355em;
+fieldset.collapsible .fieldset-legend:before {
+  content: "";
+  display: inline-block;
+  -webkit-box-sizing: border-box;
+  -moz-box-sizing: border-box;
+  box-sizing: border-box;
+  position: relative;
+  width: .6em;
+  height: .6em;
+  margin: .1em 0;
+  border-width: .1em;
+  border-style: solid;
+}
+[dir="ltr"] fieldset.collapsible .fieldset-legend:before {
+  float: left;
+  margin-left: -1.2em;
+  border-color: transparent #f05724 #f05724 transparent;
+}
+[dir="rtl"] fieldset.collapsible .fieldset-legend:before {
+  float: right;
+  margin-right: -1.2em;
+  border-color: transparent transparent #f05724 #f05724;
+}
+[dir="ltr"] fieldset.collapsed {
+  border-left-width: 1px;
+}
+[dir="rtl"] fieldset.collapsed {
+  border-right-width: 1px;
+}
+[dir="ltr"] fieldset.collapsed .fieldset-legend:before {
+  -webkit-transform: rotate(-45deg);
+  -moz-transform: rotate(-45deg);
+  -ms-transform: rotate(-45deg);
+  -o-transform: rotate(-45deg);
+  transform: rotate(-45deg);
+}
+[dir="rtl"] fieldset.collapsed .fieldset-legend:before {
+  -webkit-transform: rotate(45deg);
+  -moz-transform: rotate(45deg);
+  -ms-transform: rotate(45deg);
+  -o-transform: rotate(45deg);
+  transform: rotate(45deg);
 }
 
 .fieldset-legend .summary {
@@ -178,6 +203,10 @@ html.js[dir="rtl"] fieldset.collapsible .fieldset-legend:after {
   margin-right: 0.35355em;
 }
 
+.fieldset-title:hover {
+  text-decoration: none;
+}
+
 /**
  * TableDrag behavior.
  *
diff --git a/profiles/minimal/minimal.info b/profiles/minimal/minimal.info
index 5335c1a..3055140 100644
--- a/profiles/minimal/minimal.info
+++ b/profiles/minimal/minimal.info
@@ -5,8 +5,8 @@ core = 7.x
 dependencies[] = block
 dependencies[] = dblog
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/profiles/standard/standard.info b/profiles/standard/standard.info
index 1f80ebd..8db9e38 100644
--- a/profiles/standard/standard.info
+++ b/profiles/standard/standard.info
@@ -24,8 +24,8 @@ dependencies[] = field_ui
 dependencies[] = file
 dependencies[] = rdf
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info b/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
index 54afb8b..7c14427 100644
--- a/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
+++ b/profiles/testing/modules/drupal_system_listing_compatible_test/drupal_system_listing_compatible_test.info
@@ -6,8 +6,8 @@ core = 7.x
 hidden = TRUE
 files[] = drupal_system_listing_compatible_test.test
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info b/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
index 8a68546..e805fb4 100644
--- a/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
+++ b/profiles/testing/modules/drupal_system_listing_incompatible_test/drupal_system_listing_incompatible_test.info
@@ -8,8 +8,8 @@ version = VERSION
 core = 6.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/profiles/testing/testing.info b/profiles/testing/testing.info
index b274aee..dde47ca 100644
--- a/profiles/testing/testing.info
+++ b/profiles/testing/testing.info
@@ -4,8 +4,8 @@ version = VERSION
 core = 7.x
 hidden = TRUE
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/themes/bartik/bartik.info b/themes/bartik/bartik.info
index 70c521a..71bb1a5 100644
--- a/themes/bartik/bartik.info
+++ b/themes/bartik/bartik.info
@@ -34,8 +34,8 @@ regions[footer] = Footer
 settings[shortcut_module_link] = 0
 
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/themes/garland/garland.info b/themes/garland/garland.info
index 84d0985..6c914c7 100644
--- a/themes/garland/garland.info
+++ b/themes/garland/garland.info
@@ -7,8 +7,8 @@ stylesheets[all][] = style.css
 stylesheets[print][] = print.css
 settings[garland_width] = fluid
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/themes/seven/seven.info b/themes/seven/seven.info
index eb1cfe1..4a26149 100644
--- a/themes/seven/seven.info
+++ b/themes/seven/seven.info
@@ -13,8 +13,8 @@ regions[page_bottom] = Page bottom
 regions[sidebar_first] = First sidebar
 regions_hidden[] = sidebar_first
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
diff --git a/themes/stark/stark.info b/themes/stark/stark.info
index 58a1503..bcc97f5 100644
--- a/themes/stark/stark.info
+++ b/themes/stark/stark.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 7.x
 stylesheets[all][] = layout.css
 
-; Information added by Drupal.org packaging script on 2014-01-03
-version = "7.25"
+; Information added by Drupal.org packaging script on 2014-01-15
+version = "7.26"
 project = "drupal"
-datestamp = "1388709506"
+datestamp = "1389815930"
 
