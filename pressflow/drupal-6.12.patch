diff --git a/CHANGELOG.txt b/CHANGELOG.txt
index 9615555..99e4e54 100644
--- a/CHANGELOG.txt
+++ b/CHANGELOG.txt
@@ -1,4 +1,9 @@
-// $Id: CHANGELOG.txt,v 1.253.2.27 2009/04/30 00:13:30 goba Exp $
+// $Id: CHANGELOG.txt,v 1.253.2.29 2009/05/13 19:11:04 goba Exp $
+
+Drupal 6.12, 2009-05-13
+----------------------
+- Fixed security issues (Cross site scripting), see SA-CORE-2009-006.
+- Fixed a variety of small bugs.
 
 Drupal 6.11, 2009-04-29
 ----------------------
@@ -181,6 +186,11 @@ Drupal 6.0, 2008-02-13
 - Removed old system updates. Updates from Drupal versions prior to 5.x will
   require upgrading to 5.x before upgrading to 6.x.
 
+Drupal 5.18, 2009-05-13
+----------------------
+- Fixed security issues (Cross site scripting), see SA-CORE-2009-006.
+- Fixed a variety of small bugs.
+
 Drupal 5.17, 2009-04-29
 -----------------------
 - Fixed security issues (Cross site scripting and limited information disclosure) see SA-CORE-2009-005.
diff --git a/includes/common.inc b/includes/common.inc
index c4a19ad..d86009b 100644
--- a/includes/common.inc
+++ b/includes/common.inc
@@ -1,5 +1,5 @@
 <?php
-// $Id: common.inc,v 1.756.2.49 2009/04/30 00:13:30 goba Exp $
+// $Id: common.inc,v 1.756.2.52 2009/05/13 19:11:04 goba Exp $
 
 /**
  * @file
@@ -352,11 +352,6 @@ function drupal_not_found() {
 
   watchdog('page not found', check_plain($_GET['q']), NULL, WATCHDOG_WARNING);
 
-  // Keep old path for reference.
-  if (!isset($_REQUEST['destination'])) {
-    $_REQUEST['destination'] = $_GET['q'];
-  }
-
   $path = drupal_get_normal_path(variable_get('site_404', ''));
   if ($path && $path != $_GET['q']) {
     // Set the active item in case there are tabs to display, or other
@@ -379,12 +374,8 @@ function drupal_not_found() {
  */
 function drupal_access_denied() {
   drupal_set_header('HTTP/1.1 403 Forbidden');
-  watchdog('access denied', check_plain($_GET['q']), NULL, WATCHDOG_WARNING);
 
-  // Keep old path for reference.
-  if (!isset($_REQUEST['destination'])) {
-    $_REQUEST['destination'] = $_GET['q'];
-  }
+  watchdog('access denied', check_plain($_GET['q']), NULL, WATCHDOG_WARNING);
 
   $path = drupal_get_normal_path(variable_get('site_403', ''));
   if ($path && $path != $_GET['q']) {
diff --git a/includes/form.inc b/includes/form.inc
index c3056f0..62568cc 100644
--- a/includes/form.inc
+++ b/includes/form.inc
@@ -1,5 +1,5 @@
 <?php
-// $Id: form.inc,v 1.265.2.23 2009/04/27 14:41:11 goba Exp $
+// $Id: form.inc,v 1.265.2.24 2009/05/13 18:22:29 goba Exp $
 
 /**
  * @defgroup forms Form builder functions
@@ -624,12 +624,6 @@ function drupal_redirect_form($form, $redirect = NULL) {
   }
   if (!isset($goto) || ($goto !== FALSE)) {
     if (isset($goto)) {
-      // Remove any fake destination set by drupal_not_found() or
-      // drupal_access_denied() so that we can properly redirect from those
-      // pages.
-      if (isset($_REQUEST['destination']) && $_REQUEST['destination'] == $_GET['q']) {
-        unset($_REQUEST['destination']);
-      }
       if (is_array($goto)) {
         call_user_func_array('drupal_goto', $goto);
       }
diff --git a/includes/theme.inc b/includes/theme.inc
index 4b92e53..c836a8f 100644
--- a/includes/theme.inc
+++ b/includes/theme.inc
@@ -1,5 +1,5 @@
 <?php
-// $Id: theme.inc,v 1.415.2.21 2009/04/30 00:13:30 goba Exp $
+// $Id: theme.inc,v 1.415.2.22 2009/05/13 19:11:04 goba Exp $
 
 /**
  * @file
@@ -688,7 +688,7 @@ function theme() {
   // restore path_to_theme()
   $theme_path = $temp;
   // Add final markup to the full page.
-  if ($hook == 'page') {
+  if ($hook == 'page' || $hook == 'book_export_html') {
     $output = drupal_final_markup($output);
   }
   return $output;
diff --git a/modules/aggregator/aggregator.info b/modules/aggregator/aggregator.info
index ba7ec3b..155448e 100644
--- a/modules/aggregator/aggregator.info
+++ b/modules/aggregator/aggregator.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/block/block.info b/modules/block/block.info
index ffa9e7e..1aafd2a 100644
--- a/modules/block/block.info
+++ b/modules/block/block.info
@@ -5,8 +5,8 @@ package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/blog/blog.info b/modules/blog/blog.info
index 4867a67..7102ea2 100644
--- a/modules/blog/blog.info
+++ b/modules/blog/blog.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/blogapi/blogapi.info b/modules/blogapi/blogapi.info
index 8870507..8892c94 100644
--- a/modules/blogapi/blogapi.info
+++ b/modules/blogapi/blogapi.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/book/book-export-html.tpl.php b/modules/book/book-export-html.tpl.php
index 928d73f..0cb55c0 100644
--- a/modules/book/book-export-html.tpl.php
+++ b/modules/book/book-export-html.tpl.php
@@ -1,5 +1,5 @@
 <?php
-// $Id: book-export-html.tpl.php,v 1.1 2007/11/04 14:29:09 goba Exp $
+// $Id: book-export-html.tpl.php,v 1.1.2.1 2009/05/13 19:11:04 goba Exp $
 
 /**
  * @file book-export-html.tpl.php
@@ -20,8 +20,8 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml" lang="<?php print $language->language; ?>" xml:lang="<?php print $language->language; ?>">
   <head>
-    <title><?php print $title; ?></title>
     <?php print $head; ?>
+    <title><?php print $title; ?></title>
     <base href="<?php print $base_url; ?>" />
     <link type="text/css" rel="stylesheet" href="misc/print.css" />
     <?php if ($language_rtl): ?>
diff --git a/modules/book/book.info b/modules/book/book.info
index 0b7f18d..ac821e3 100644
--- a/modules/book/book.info
+++ b/modules/book/book.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/color/color.info b/modules/color/color.info
index d7a9c0f..5f649c4 100644
--- a/modules/color/color.info
+++ b/modules/color/color.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/comment/comment.info b/modules/comment/comment.info
index fe01989..67d5e8c 100644
--- a/modules/comment/comment.info
+++ b/modules/comment/comment.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/comment/comment.module b/modules/comment/comment.module
index ebd6be7..7e434fb 100644
--- a/modules/comment/comment.module
+++ b/modules/comment/comment.module
@@ -1,5 +1,5 @@
 <?php
-// $Id: comment.module,v 1.617.2.6 2009/04/05 12:04:52 dries Exp $
+// $Id: comment.module,v 1.617.2.7 2009/05/13 17:15:10 goba Exp $
 
 /**
  * @file
@@ -1541,7 +1541,9 @@ function comment_form_submit($form, &$form_state) {
   _comment_form_submit($form_state['values']);
   if ($cid = comment_save($form_state['values'])) {
     $node = node_load($form_state['values']['nid']);
-    $page = comment_new_page_count($node->comment_count, 1, $node);
+    // Add 1 to existing $node->comment count to include new comment being added.
+    $comment_count = $node->comment_count + 1;
+    $page = comment_new_page_count($comment_count, 1, $node);
     $form_state['redirect'] = array('node/'. $node->nid, $page, "comment-$cid");
     return;
   }
diff --git a/modules/contact/contact.info b/modules/contact/contact.info
index 7257692..707f985 100644
--- a/modules/contact/contact.info
+++ b/modules/contact/contact.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/dblog/dblog.info b/modules/dblog/dblog.info
index b59f108..e956fb3 100644
--- a/modules/dblog/dblog.info
+++ b/modules/dblog/dblog.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/filter/filter.info b/modules/filter/filter.info
index e8e4854..022add5 100644
--- a/modules/filter/filter.info
+++ b/modules/filter/filter.info
@@ -5,8 +5,8 @@ package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/forum/forum.info b/modules/forum/forum.info
index c36d76e..30113e5 100644
--- a/modules/forum/forum.info
+++ b/modules/forum/forum.info
@@ -7,8 +7,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/help/help.info b/modules/help/help.info
index 0163b54..a4714a5 100644
--- a/modules/help/help.info
+++ b/modules/help/help.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/locale/locale.info b/modules/locale/locale.info
index fa165d8..5932d3c 100644
--- a/modules/locale/locale.info
+++ b/modules/locale/locale.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/menu/menu.info b/modules/menu/menu.info
index 08446da..6746e8c 100644
--- a/modules/menu/menu.info
+++ b/modules/menu/menu.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/node/node.info b/modules/node/node.info
index 5b0e067..0aeeb8d 100644
--- a/modules/node/node.info
+++ b/modules/node/node.info
@@ -5,8 +5,8 @@ package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/openid/openid.info b/modules/openid/openid.info
index af8f0b1..572ca60 100644
--- a/modules/openid/openid.info
+++ b/modules/openid/openid.info
@@ -5,8 +5,8 @@ version = VERSION
 package = Core - optional
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/path/path.info b/modules/path/path.info
index 15c0381..4cc8d6f 100644
--- a/modules/path/path.info
+++ b/modules/path/path.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/php/php.info b/modules/php/php.info
index 9e11028..c92951e 100644
--- a/modules/php/php.info
+++ b/modules/php/php.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/ping/ping.info b/modules/ping/ping.info
index 4eca538..bda74d9 100644
--- a/modules/ping/ping.info
+++ b/modules/ping/ping.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/poll/poll.info b/modules/poll/poll.info
index 93eea87..58afc58 100644
--- a/modules/poll/poll.info
+++ b/modules/poll/poll.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/profile/profile.info b/modules/profile/profile.info
index ed17b35..e4fc88d 100644
--- a/modules/profile/profile.info
+++ b/modules/profile/profile.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/search/search.info b/modules/search/search.info
index 58cb8e4..036a2f7 100644
--- a/modules/search/search.info
+++ b/modules/search/search.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/statistics/statistics.info b/modules/statistics/statistics.info
index d07fab7..9296d5c 100644
--- a/modules/statistics/statistics.info
+++ b/modules/statistics/statistics.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/syslog/syslog.info b/modules/syslog/syslog.info
index 2a65eba..c41ac8e 100644
--- a/modules/syslog/syslog.info
+++ b/modules/syslog/syslog.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/system/system.info b/modules/system/system.info
index ae93b73..fbb25b7 100644
--- a/modules/system/system.info
+++ b/modules/system/system.info
@@ -5,8 +5,8 @@ package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/system/system.module b/modules/system/system.module
index ad3e517..4e8619f 100644
--- a/modules/system/system.module
+++ b/modules/system/system.module
@@ -1,5 +1,5 @@
 <?php
-// $Id: system.module,v 1.585.2.34 2009/04/30 00:13:31 goba Exp $
+// $Id: system.module,v 1.585.2.36 2009/05/13 19:11:04 goba Exp $
 
 /**
  * @file
@@ -9,7 +9,7 @@
 /**
  * The current system version.
  */
-define('VERSION', '6.11');
+define('VERSION', '6.12');
 
 /**
  * Core API compatibility.
diff --git a/modules/taxonomy/taxonomy.info b/modules/taxonomy/taxonomy.info
index 31f6eab..78db430 100644
--- a/modules/taxonomy/taxonomy.info
+++ b/modules/taxonomy/taxonomy.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/taxonomy/taxonomy.module b/modules/taxonomy/taxonomy.module
index 4e51f6b..f5b1fea 100644
--- a/modules/taxonomy/taxonomy.module
+++ b/modules/taxonomy/taxonomy.module
@@ -1,5 +1,5 @@
 <?php
-// $Id: taxonomy.module,v 1.414.2.8 2009/04/27 11:49:05 goba Exp $
+// $Id: taxonomy.module,v 1.414.2.11 2009/05/13 19:38:33 goba Exp $
 
 /**
  * @file
@@ -415,7 +415,7 @@ function taxonomy_del_term($tid) {
  */
 function taxonomy_form($vid, $value = 0, $help = NULL, $name = 'taxonomy') {
   $vocabulary = taxonomy_vocabulary_load($vid);
-  $help = ($help) ? $help : $vocabulary->help;
+  $help = ($help) ? $help : filter_xss_admin($vocabulary->help);
 
   if (!$vocabulary->multiple) {
     $blank = ($vocabulary->required) ? t('- Please choose -') : t('- None selected -');
@@ -514,7 +514,7 @@ function taxonomy_form_alter(&$form, $form_state, $form_id) {
           $typed_string = taxonomy_implode_tags($terms, $vocabulary->vid) . (array_key_exists('tags', $terms) ? $terms['tags'][$vocabulary->vid] : NULL);
         }
         if ($vocabulary->help) {
-          $help = $vocabulary->help;
+          $help = filter_xss_admin($vocabulary->help);
         }
         else {
           $help = t('A comma-separated list of terms describing this content. Example: funny, bungee jumping, "Company, Inc.".');
@@ -538,7 +538,7 @@ function taxonomy_form_alter(&$form, $form_state, $form_id) {
             $default_terms[$term->tid] = $term;
           }
         }
-        $form['taxonomy'][$vocabulary->vid] = taxonomy_form($vocabulary->vid, array_keys($default_terms), $vocabulary->help);
+        $form['taxonomy'][$vocabulary->vid] = taxonomy_form($vocabulary->vid, array_keys($default_terms), filter_xss_admin($vocabulary->help));
         $form['taxonomy'][$vocabulary->vid]['#weight'] = $vocabulary->weight;
         $form['taxonomy'][$vocabulary->vid]['#required'] = $vocabulary->required;
       }
@@ -838,19 +838,16 @@ function taxonomy_get_tree($vid, $parent = 0, $depth = -1, $max_depth = NULL) {
 
   $max_depth = (is_null($max_depth)) ? count($children[$vid]) : $max_depth;
   $tree = array();
-  if (!empty($children[$vid][$parent])) {
+  if ($max_depth > $depth && !empty($children[$vid][$parent])) {
     foreach ($children[$vid][$parent] as $child) {
-      if ($max_depth > $depth) {
-        $term = drupal_clone($terms[$vid][$child]);
-        $term->depth = $depth;
-        // The "parent" attribute is not useful, as it would show one parent only.
-        unset($term->parent);
-        $term->parents = $parents[$vid][$child];
-        $tree[] = $term;
-
-        if (!empty($children[$vid][$child])) {
-          $tree = array_merge($tree, taxonomy_get_tree($vid, $child, $depth, $max_depth));
-        }
+      $term = drupal_clone($terms[$vid][$child]);
+      $term->depth = $depth;
+      // The "parent" attribute is not useful, as it would show one parent only.
+      unset($term->parent);
+      $term->parents = $parents[$vid][$child];
+      $tree[] = $term;
+      if (!empty($children[$vid][$child])) {
+        $tree = array_merge($tree, taxonomy_get_tree($vid, $child, $depth, $max_depth));
       }
     }
   }
@@ -1018,6 +1015,35 @@ function taxonomy_get_term($tid) {
   return $terms[$tid];
 }
 
+/**
+ * Create a select form element for a given taxonomy vocabulary.
+ *
+ * NOTE: This function expects input that has already been sanitized and is
+ * safe for display. Callers must properly sanitize the $title and
+ * $description arguments to prevent XSS vulnerabilities.
+ *
+ * @param $title
+ *   The title of the vocabulary. This MUST be sanitized by the caller.
+ * @param $name
+ *   Ignored.
+ * @param $value
+ *   The currently selected terms from this vocabulary, if any.
+ * @param $vocabulary_id
+ *   The vocabulary ID to build the form element for.
+ * @param $description
+ *   Help text for the form element. This MUST be sanitized by the caller.
+ * @param $multiple
+ *   Boolean to control if the form should use a single or multiple select.
+ * @param $blank
+ *   Optional form choice to use when no value has been selected.
+ * @param $exclude
+ *   Optional array of term ids to exclude in the selector.
+ * @return
+ *   A FAPI form array to select terms from the given vocabulary.
+ *
+ * @see taxonomy_form()
+ * @see taxonomy_form_term()
+ */
 function _taxonomy_term_select($title, $name, $value, $vocabulary_id, $description, $multiple, $blank, $exclude = array()) {
   $tree = taxonomy_get_tree($vocabulary_id);
   $options = array();
diff --git a/modules/throttle/throttle.info b/modules/throttle/throttle.info
index 6b0afe9..563a3d4 100644
--- a/modules/throttle/throttle.info
+++ b/modules/throttle/throttle.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/tracker/tracker.info b/modules/tracker/tracker.info
index 2e6187d..39016fd 100644
--- a/modules/tracker/tracker.info
+++ b/modules/tracker/tracker.info
@@ -6,8 +6,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/translation/translation.info b/modules/translation/translation.info
index 1db3897..51e1961 100644
--- a/modules/translation/translation.info
+++ b/modules/translation/translation.info
@@ -6,8 +6,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/trigger/trigger.info b/modules/trigger/trigger.info
index 9474fbb..2e5b8b4 100644
--- a/modules/trigger/trigger.info
+++ b/modules/trigger/trigger.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/update/update.info b/modules/update/update.info
index f0db1b6..a48f447 100644
--- a/modules/update/update.info
+++ b/modules/update/update.info
@@ -5,8 +5,8 @@ version = VERSION
 package = Core - optional
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/update/update.module b/modules/update/update.module
index a1a23fb..f173d65 100644
--- a/modules/update/update.module
+++ b/modules/update/update.module
@@ -1,5 +1,5 @@
 <?php
-// $Id: update.module,v 1.17.2.3 2009/04/29 18:43:11 goba Exp $
+// $Id: update.module,v 1.17.2.4 2009/05/13 18:27:58 goba Exp $
 
 /**
  * @file
@@ -303,7 +303,7 @@ function update_cron() {
  * @see update_invalidate_cache()
  */
 function update_form_alter(&$form, $form_state, $form_id) {
-  if ($form_id == 'system_modules' || $form_id == 'system_themes' ) {
+  if ($form_id == 'system_modules' || $form_id == 'system_themes_form' ) {
     $form['#submit'][] = 'update_invalidate_cache';
   }
 }
diff --git a/modules/upload/upload.info b/modules/upload/upload.info
index abc85c8..492a512 100644
--- a/modules/upload/upload.info
+++ b/modules/upload/upload.info
@@ -5,8 +5,8 @@ package = Core - optional
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/modules/user/user.info b/modules/user/user.info
index 8bb3a8f..1a86346 100644
--- a/modules/user/user.info
+++ b/modules/user/user.info
@@ -5,8 +5,8 @@ package = Core - required
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/themes/bluemarine/bluemarine.info b/themes/bluemarine/bluemarine.info
index 98b7d47..08d04da 100644
--- a/themes/bluemarine/bluemarine.info
+++ b/themes/bluemarine/bluemarine.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 6.x
 engine = phptemplate
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/themes/chameleon/chameleon.info b/themes/chameleon/chameleon.info
index e2701fc..fc23602 100644
--- a/themes/chameleon/chameleon.info
+++ b/themes/chameleon/chameleon.info
@@ -12,8 +12,8 @@ stylesheets[all][] = common.css
 version = VERSION
 core = 6.x
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/themes/chameleon/marvin/marvin.info b/themes/chameleon/marvin/marvin.info
index ab8a9c0..6882131 100644
--- a/themes/chameleon/marvin/marvin.info
+++ b/themes/chameleon/marvin/marvin.info
@@ -7,8 +7,8 @@ version = VERSION
 core = 6.x
 base theme = chameleon
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/themes/garland/garland.info b/themes/garland/garland.info
index 5275271..57462a6 100644
--- a/themes/garland/garland.info
+++ b/themes/garland/garland.info
@@ -7,8 +7,8 @@ engine = phptemplate
 stylesheets[all][] = style.css
 stylesheets[print][] = print.css
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/themes/garland/minnelli/minnelli.info b/themes/garland/minnelli/minnelli.info
index bf497ec..7f9d98f 100644
--- a/themes/garland/minnelli/minnelli.info
+++ b/themes/garland/minnelli/minnelli.info
@@ -6,8 +6,8 @@ core = 6.x
 base theme = garland
 stylesheets[all][] = minnelli.css
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
diff --git a/themes/pushbutton/pushbutton.info b/themes/pushbutton/pushbutton.info
index fb2ebb9..4564b81 100644
--- a/themes/pushbutton/pushbutton.info
+++ b/themes/pushbutton/pushbutton.info
@@ -5,8 +5,8 @@ version = VERSION
 core = 6.x
 engine = phptemplate
 
-; Information added by drupal.org packaging script on 2009-04-30
-version = "6.11"
+; Information added by drupal.org packaging script on 2009-05-13
+version = "6.12"
 project = "drupal"
-datestamp = "1241050838"
+datestamp = "1242243950"
 
